<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>MOSN â€“ MOSN åšå®¢</title>
    <link>https://mosn.io/blog/</link>
    <description>Recent content in MOSN åšå®¢ on MOSN</description>
    <generator>Hugo -- gohugo.io</generator>
    
	  <atom:link href="https://mosn.io/blog/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Blog: MoE ç³»åˆ—[ä¸ƒ] - Envoy Go æ‰©å±•ä¹‹æ²™ç®±å®‰å…¨</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-7/</link>
      <pubDate>Sun, 07 May 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-7/</guid>
      <description>
        
        
        &lt;p&gt;å‰ä¸¤ç¯‡ä»‹ç»äº†å†…å­˜å®‰å…¨å’Œå¹¶å‘å®‰å…¨ï¼Œä»Šå¤©æ¥åˆ°äº†å®‰å…¨æ€§çš„æœ€åä¸€ç¯‡ï¼Œæ²™ç®±å®‰å…¨ï¼Œä¹Ÿæ˜¯ç›¸å¯¹æ¥è¯´ï¼Œæœ€ç®€å•çš„ä¸€ç¯‡ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ²™ç®±å®‰å…¨&#34;&gt;æ²™ç®±å®‰å…¨&lt;/h2&gt;
&lt;p&gt;æ‰€è°“çš„æ²™ç®±å®‰å…¨ï¼Œæ˜¯ä¸ºäº†ä¿æŠ¤ Envoyï¼Œè¿™ä¸ªå®¿ä¸»ç¨‹åºçš„å®‰å…¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰©å±•çš„ Go ä»£ç è¿è¡Œåœ¨ä¸€ä¸ªæ²™ç®±ç¯å¢ƒä¸­ï¼Œå³ä½¿ Go ä»£ç è·‘é£äº†ï¼Œä¹Ÿä¸ä¼šæŠŠ Envoy ææŒ‚ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“åˆ°ä¸€ä¸ªåœºæ™¯ï¼Œä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨ Golang æ¥æ‰©å±• Envoy çš„æ—¶å€™ï¼Œä¸ç”¨æ‹…å¿ƒè‡ªå·±çš„ Go ä»£ç å†™çš„ä¸å¥½ï¼Œè€ŒæŠŠæ•´ä¸ª Envoy è¿›ç¨‹ææŒ‚äº†ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆç›®å‰ Envoy Go æ‰©å±•çš„æ²™ç®±å®‰å…¨åšåˆ°äº†ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼Œç›®å‰åªåšåˆ°äº†æ¯”è¾ƒæµ…å±‚æ¬¡çš„æ²™ç®±å®‰å…¨ï¼Œä¸è¿‡ï¼Œä¹Ÿæ˜¯å®ç”¨æ€§æ¯”è¾ƒé«˜çš„ä¸€å±‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¥æ ¼æ¥è¯´ï¼ŒEnvoy Go æ‰©å±•åŠ è½½çš„æ˜¯å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼Œæ˜¯ç›´æ¥äº¤ç»™ cpu æ¥è¿è¡Œçš„ï¼Œå¹¶ä¸åƒ Wasm æˆ–è€… Lua ä¸€æ ·ç”±è™šæ‹Ÿæœºæ¥è§£é‡Šæ‰§è¡Œï¼Œæ‰€ä»¥ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œä¹Ÿæ²¡åŠæ³•åšåˆ°ç»å¯¹çš„æ²™ç®±å®‰å…¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å®ç°æœºåˆ¶&#34;&gt;å®ç°æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;ç›®å‰å®ç°çš„æ²™ç®±å®‰å…¨æœºåˆ¶ï¼Œä¾èµ–çš„æ˜¯ Go runtime çš„ &lt;code&gt;recover&lt;/code&gt; æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“æ¥è¯´ï¼ŒGo æ‰©å±•åº•å±‚æ¡†æ¶ä¼šè‡ªåŠ¨çš„ï¼Œæˆ–è€…ï¼ˆä»£ç é‡Œæ˜¾ç¤ºå¯åŠ¨çš„åç¨‹ï¼‰ä¾èµ–äººå·¥æ˜¾ç¤ºçš„ï¼Œé€šè¿‡ &lt;code&gt;defer&lt;/code&gt; æ³¨å…¥æˆ‘ä»¬çš„æ¢å¤æœºåˆ¶ï¼Œæ‰€ä»¥ï¼Œå½“ Go ä»£ç å‘ç”Ÿäº†å¥”æºƒçš„æ—¶å€™ï¼Œåˆ™ä¼šæ‰§è¡Œæˆ‘ä»¬æ³¨å…¥çš„æ¢å¤ç­–ç•¥ï¼Œæ­¤æ—¶çš„å¤„ç†ç­–ç•¥æ˜¯ï¼Œä½¿ç”¨ &lt;code&gt;500&lt;/code&gt; é”™è¯¯ç ç»“æŸå½“å‰è¯·æ±‚ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–è¯·æ±‚çš„æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªä¸å¤ªå®Œç¾çš„ç‚¹ï¼Œæœ‰ä¸€äº›å¼‚å¸¸æ˜¯ &lt;code&gt;recover&lt;/code&gt; ä¹Ÿä¸èƒ½æ¢å¤çš„ï¼Œæ¯”å¦‚è¿™å‡ ä¸ªï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Concurrent map writes
Out of memory
Stack memory exhaustion
Attempting to launch a nil function as a goroutine
All goroutines are asleep - deadlock
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¥½åœ¨è¿™å‡ ä¸ªå¼‚å¸¸ï¼Œéƒ½æ˜¯ä¸å¤ªå®¹æ˜“å‡ºç°çš„ï¼Œå”¯ä¸€ä¸€ä¸ªå€¼å¾—æ‹…å¿ƒçš„æ˜¯ &lt;code&gt;Concurrent map writes&lt;/code&gt;ï¼Œä¸ç†Ÿæ‚‰ Go çš„è¯ï¼Œè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“è¸©è¿™ä¸ªå‘çš„ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œåœ¨å†™ Go æ‰©å±•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å»ºè®®è¿˜æ˜¯å°å¿ƒä¸€äº›ï¼Œå†™å¾—ä¸å¥½çš„è¯ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¼šæŠŠ Envoy ææŒ‚çš„ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œè¿™ä¸ªä¹Ÿä¸æ˜¯ä¸€ä¸ªå¾ˆé«˜çš„è¦æ±‚ï¼Œæ¯•ç«Ÿè¿™æ˜¯ Gopher å†™ Go ä»£ç çš„å¾ˆå¸¸è§çš„åŸºæœ¬è¦æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;å¥½åœ¨å¤§å¤šå¸¸è§çš„å¼‚å¸¸ï¼Œéƒ½æ˜¯å¯ä»¥ &lt;code&gt;recover&lt;/code&gt; æ¢å¤çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç°åœ¨çš„æœºåˆ¶ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰å®ç”¨æ€§ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœªæ¥&#34;&gt;æœªæ¥&lt;/h2&gt;
&lt;p&gt;é‚£ä¹ˆï¼Œå¯¹äº &lt;code&gt;recover&lt;/code&gt; æ¢å¤ä¸äº†çš„ï¼Œä¹Ÿæ˜¯æœ‰è§£å†³çš„æ€è·¯ï¼š&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚ &lt;code&gt;recover&lt;/code&gt; æ¢å¤ä¸äº† &lt;code&gt;Concurrent map writes&lt;/code&gt;ï¼Œæ˜¯å› ä¸º runtime è®¤ä¸º &lt;code&gt;map&lt;/code&gt; å·²ç»è¢«å†™åäº†ï¼Œä¸å¯é€†äº†ã€‚&lt;/p&gt;
&lt;p&gt;é‚£å¦‚æœæˆ‘ä»¬æ”¾å¼ƒæ•´ä¸ª &lt;code&gt;runtime&lt;/code&gt;ï¼Œé‡æ–°åŠ è½½ so æ¥é‡å»º &lt;code&gt;runtime&lt;/code&gt; å‘¢ï¼Ÿé‚£å½±å“é¢ä¹Ÿä¼šå°å¾ˆå¤šï¼Œè‡³å°‘ Envoy è¿˜æ˜¯å®‰å…¨çš„ï¼Œä¸è¿‡å®ç°èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒçš„éº»çƒ¦ã€‚&lt;/p&gt;
&lt;p&gt;çœ¼ä¸‹æ¯”è¾ƒæµ…çš„å®‰å…¨æœºåˆ¶ï¼Œä¹Ÿè¶³å¤Ÿè§£å†³å¤§å¤šæ•°çš„é—®é¢˜äº†ï¼Œå—¯ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: mosnåŸºäºå»¶è¿Ÿè´Ÿè½½å‡è¡¡ç®—æ³• -- èµ°å¾—æ›´å¿«ï¼ŒæœŸå¾…èµ°å¾—æ›´ç¨³</title>
      <link>https://mosn.io/blog/posts/mosn-loadbalancer-peakewma/</link>
      <pubDate>Fri, 05 May 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-loadbalancer-peakewma/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»mosnåœ¨v1.5.0ä¸­æ–°å¼•å…¥çš„åŸºäºå»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆ&lt;a href=&#34;https://github.com/mosn/mosn/pull/2253&#34;&gt;#2253&lt;/a&gt;ï¼‰ã€‚é¦–å…ˆä¼šå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å»¶è¿Ÿå‡ºç°çš„åŸå› è¿›è¡Œå‰–æï¼Œä¹‹åä»‹ç»mosnéƒ½é€šè¿‡å“ªäº›æ–¹æ³•æ¥é™ä½å»¶è¿Ÿï¼Œæœ€åæ„å»ºæ¥ä¸ç”Ÿäº§ç¯å¢ƒæ€§èƒ½åˆ†å¸ƒç›¸è¿‘çš„æµ‹è¯•ç”¨ä¾‹æ¥å¯¹ç®—æ³•è¿›è¡ŒéªŒè¯ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å¼€å§‹èŠåŸºäºå»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ç®—æ³•ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸‹ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡&lt;/p&gt;
&lt;h3 id=&#34;ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡&#34;&gt;ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡&lt;/h3&gt;
&lt;p&gt;Wikipediaä¸­ &lt;a href=&#34;https://en.wikipedia.org/wiki/Load_balancing_(computing)&#34;&gt;&lt;strong&gt;Load Balancing (Computing)&lt;/strong&gt;&lt;/a&gt; è¯æ¡æ˜¯è¿™æ ·ä»‹ç»è´Ÿè½½å‡è¡¡çš„ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è´Ÿè½½å‡è¡¡æ˜¯å°†ä¸€ç»„ä»»åŠ¡åˆ†é…åˆ°ä¸€ç»„èµ„æºï¼ˆè®¡ç®—å•å…ƒï¼‰ä¸Šçš„è¿‡ç¨‹ï¼Œç›®çš„æ˜¯ä½¿å®ƒä»¬çš„æ•´ä½“å¤„ç†æ›´æœ‰æ•ˆç‡ã€‚è´Ÿè½½å‡è¡¡å¯ä»¥ä¼˜åŒ–å“åº”æ—¶é—´ï¼Œé¿å…è´Ÿè½½ä¸å‡åŒ€å¯¼è‡´ä¸€äº›è®¡ç®—èŠ‚ç‚¹è¿‡è½½è€Œå…¶ä»–è®¡ç®—èŠ‚ç‚¹å¤„äºç©ºé—²çŠ¶æ€&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è´Ÿè½½å‡è¡¡åœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å…³é”®çš„ç»„æˆéƒ¨åˆ†ã€‚è´Ÿè½½å‡è¡¡è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸¤ä¸ªé—®é¢˜ï¼šå¯ä¼¸ç¼©æ€§ï¼ˆscalabilityï¼‰å’ŒéŸ§æ€§ï¼ˆresilienceï¼‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¯ä¼¸ç¼©æ€§&lt;/strong&gt;ï¼šåº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨å¤šä¸ªç›¸åŒçš„å‰¯æœ¬ä¸­ã€‚å½“è®¡ç®—èµ„æºä¸è¶³æ—¶å¯ä»¥é€šè¿‡éƒ¨ç½²é¢å¤–çš„å‰¯æœ¬æ¥å¢åŠ è®¡ç®—èµ„æºï¼Œè€Œå½“è®¡ç®—èµ„æºå¤§é‡å†—ä½™æ—¶å¯ä»¥é€šè¿‡å‡å°‘å‰¯æœ¬æ¥èŠ‚çœæˆæœ¬ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡å¯ä»¥å°†è¯·æ±‚è´Ÿè½½åˆ†å¸ƒåˆ°ä¸åŒçš„å‰¯æœ¬ä¸­ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;éŸ§æ€§&lt;/strong&gt;ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•…éšœæ˜¯éƒ¨åˆ†çš„ã€‚åº”ç”¨ç¨‹åºé€šè¿‡å†—ä½™å‰¯æœ¬çš„æ–¹å¼ï¼Œä¿è¯åœ¨éƒ¨åˆ†ç»„ä»¶æ•…éšœæ—¶ä»èƒ½æ­£å¸¸åœ°æä¾›æœåŠ¡ã€‚è´Ÿè½½å‡è¡¡é€šè¿‡æ„ŸçŸ¥èŠ‚ç‚¹çš„æ•…éšœï¼Œè°ƒæ•´æµé‡çš„åˆ†é…ï¼Œå°†æµé‡æ›´å¤šçš„åˆ†é…åˆ°é‚£äº›èƒ½å¤Ÿæ­£å¸¸æä¾›æœåŠ¡çš„èŠ‚ç‚¹ä¸Šã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;èµ°å¾—æ›´å¿«&#34;&gt;èµ°å¾—æ›´å¿«&lt;/h2&gt;
&lt;p&gt;è´Ÿè½½å‡è¡¡ä½¿å¾—ç°ä»£è½¯ä»¶ç³»ç»Ÿå…·å¤‡äº†å¯æ‰©å±•æ€§å’ŒéŸ§æ€§ã€‚ä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿˜å­˜åœ¨ä¸å®¹å¿½è§†çš„é—®é¢˜ï¼š&lt;strong&gt;å»¶è¿Ÿ&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å»¶è¿Ÿæ¥è‡ªå“ªé‡Œ&#34;&gt;å»¶è¿Ÿæ¥è‡ªå“ªé‡Œ&lt;/h3&gt;
&lt;p&gt;ç°ä»£è½¯ä»¶ç³»ç»Ÿé€šå¸¸æ˜¯å¤šå±‚çº§ç»“æ„å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå³ä½¿æ˜¯åªæœåŠ¡å•ä¸ªç»ˆç«¯ç”¨æˆ·çš„è¯·æ±‚ï¼Œå®ƒèƒŒåä¹Ÿæœ‰å¯èƒ½ç»è¿‡äº†ä¸Šç™¾æ¬¡çš„æ•°æ®è®¿é—®ï¼Œè¿™ç§æƒ…å†µåœ¨å¾®æœåŠ¡æ¶æ„ä¸­æ›´æ˜¯å°¤ä¸ºæ™®éã€‚&lt;/p&gt;
&lt;figure&gt;&lt;img src=&#34;./microservice.jpg&#34; style=&#34;width:100%&#34; alt=&#34;Microservice Pattern&#34;/&gt;&lt;figcaption align = &#34;center&#34;&gt;å¾®æœåŠ¡æ¶æ„ï¼ˆå¼•ç”¨è‡ª&lt;a href=&#34;https://www.manning.com/books/microservices-patterns&#34;&gt;Microservices Pattern&lt;/a&gt;ï¼‰&lt;/figcaption&gt;&lt;/figure&gt;
&lt;p&gt;å•å°æ€§èƒ½ç¨³å®šçš„æœåŠ¡å™¨ä¸­å»¶è¿Ÿé€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªæ–¹é¢é€ æˆï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è®¡ç®—ä»»åŠ¡æœ¬èº«çš„å¤æ‚åº¦&lt;/li&gt;
&lt;li&gt;å†…å®¹çš„ä¼ è¾“è¿‡ç¨‹ä¸­çš„å»¶è¿Ÿ&lt;/li&gt;
&lt;li&gt;è¯·æ±‚æ’é˜Ÿç­‰å¾…çš„å»¶è¿Ÿ&lt;/li&gt;
&lt;li&gt;åå°ä»»åŠ¡æ´»åŠ¨æ‰€å¯¼çš„èµ„æºç«äº‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™äº›æœåŠ¡å™¨ä¹‹é—´çš„å»¶è¿Ÿå°†ä¼šå åŠ ï¼Œä»»ä½•æ˜¾è‘—çš„å»¶è¿Ÿå¢åŠ éƒ½ä¼šå½±å“ç»ˆç«¯ç”¨æˆ·çš„ä½“éªŒã€‚æ­¤å¤–ï¼Œä»»ä½•æ¥è‡ªå•ä¸ªèŠ‚ç‚¹çš„å»¶è¿Ÿå³°å€¼ä¹Ÿä¼šç›´æ¥å½±å“åˆ°ç»ˆç«¯ç”¨æˆ·ä½“éªŒã€‚æœ€åï¼Œè¶Šæ¥è¶Šå¤šåœ°ä½¿ç”¨å…¬æœ‰äº‘éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè¿›ä¸€æ­¥åŠ å‰§äº†å“åº”æ—¶é—´çš„ä¸å¯é¢„æµ‹æ€§ï¼Œå› ä¸ºåœ¨è¿™äº›ç¯å¢ƒä¸­å­˜åœ¨å…±äº«èµ„æºï¼ˆCPUã€å†…å­˜å’ŒIOï¼‰çš„äº‰ç”¨ï¼Œåº”ç”¨ç¨‹åºæœºå‡ ä¹ä¸å¯é¿å…åœ°é‡åˆ°æ€§èƒ½å½±å“ï¼Œå¹¶ä¸”è¿™ç§å½±å“æ˜¯éšæ—¶å‘ç”Ÿçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¦‚ä½•å‡å°‘å»¶è¿Ÿ&#34;&gt;å¦‚ä½•å‡å°‘å»¶è¿Ÿ&lt;/h3&gt;
&lt;p&gt;æœ‰ç ”ç©¶è¡¨æ˜ï¼Œåœ¨å¤§å‹äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå»¶è¿Ÿå¾€å¾€å…·æœ‰é•¿å°¾ç‰¹ç‚¹ï¼ŒP999æ¯”ä¸­ä½æ•°é«˜å‡ºå‡ ä¸ªæ•°é‡çº§ã€‚å¦‚æœåœ¨åº”ç”¨æ¶æ„çš„æ¯å±‚éƒ½èƒ½å¤Ÿå‡å°‘è¿™äº›å°¾éƒ¨å»¶è¿Ÿï¼Œé‚£ä¹ˆå¯¹ç»ˆç«¯ç”¨æˆ·æ•´ä½“çš„å°¾éƒ¨å»¶è¿Ÿå°†ä¼šæ˜¾è‘—é™ä½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./long-tail.png&#34; alt=&#34;Long Tail&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æœåŠ¡ç½‘æ ¼ä¸­ï¼Œæ‰€æœ‰æ¥æ”¶å’Œå‘é€çš„æµé‡éƒ½ä¼šç»è¿‡è¾¹è½¦ä»£ç†ï¼Œé€šè¿‡è¾¹è½¦ä»£ç†å¯ä»¥è½»æ¾åœ°æ§åˆ¶ç½‘æ ¼çš„æµé‡ï¼Œè€Œæ— éœ€å¯¹æœåŠ¡è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚å¦‚æœè¾¹è½¦ä»£ç†åœ¨å¯¹åº”ç”¨å±‚æµé‡è¿›è¡Œè½¬å‘æ—¶ï¼Œæ€»æ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡æ—¶é€‰æ‹©å“åº”æ—¶é—´è¾ƒçŸ­çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå°†ä¼šæ˜¾è‘—é™ä½å¯¹ç»ˆç«¯ç”¨æˆ·çš„å°¾éƒ¨å»¶è¿Ÿã€‚&lt;/p&gt;
&lt;p&gt;åŸºäºæ­¤ï¼Œæˆ‘ä»¬å‡†å¤‡å¼€å§‹ä¸ºmosnå¼•å…¥åŸºäºå»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¹¶è¿›è¡Œé€‚å½“è°ƒæ•´æ¥ä¿è¯èƒ½å¤Ÿåœ¨å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ä¸‹æ˜¾è‘—å‡å°‘å»¶è¿Ÿã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ€§èƒ½é—®é¢˜æ˜¯å±€éƒ¨çš„&#34;&gt;æ€§èƒ½é—®é¢˜æ˜¯å±€éƒ¨çš„&lt;/h3&gt;
&lt;p&gt;å‰é¢æåˆ°äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æ€§èƒ½å—åˆ°å¤šç§å› ç´ çš„å½±å“ï¼Œè¿™äº›å½±å“å› ç´ æ˜¯åŠ¨æ€çš„ï¼Œéš¾ä»¥å‡†ç¡®é¢„æµ‹æ¯ä¸ªèŠ‚ç‚¹çš„æ€§èƒ½ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ç²¾ç¡®åœ°é€‰æ‹©æœ€å¥½çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯ä»¥é¿å…è¾ƒå·®çš„èŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨äº‘ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨çš„æ€§èƒ½å¸¸å¸¸æ˜¯éš¾ä»¥é¢„æµ‹çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹å¤§é‡çš„æ•°æ®è¿›è¡Œåˆ†æï¼Œå‘ç°æœåŠ¡å™¨æ€§èƒ½çš„åˆ†å¸ƒå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ç¬¦åˆæ­£æ€åˆ†å¸ƒçš„ã€‚å› æ­¤ï¼Œå°½ç®¡æœ‰ä¸€éƒ¨åˆ†çš„æœåŠ¡å™¨åœ¨æ€§èƒ½æ–¹é¢è¡¨ç°æ¯”è¾ƒå·®ï¼Œå®ƒä»¬çš„æ•°é‡é€šå¸¸éƒ½æ˜¯å°‘æ•°çš„ï¼ˆ3sigmaï¼‰ï¼Œè€Œç»å¤§éƒ¨åˆ†æœåŠ¡å™¨èŠ‚ç‚¹çš„è¡¨ç°æ˜¯æ­£å¸¸çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./normal-distribution.png&#34; alt=&#34;Normal Distribution&#34;&gt;&lt;/p&gt;
&lt;p&gt;é™¤äº†æœåŠ¡å™¨ä¹‹é—´çš„å·®å¼‚ï¼Œè¿˜å­˜åœ¨ç”±åŸºç¡€è®¾æ–½å¯¼è‡´çš„åŠ¨æ€å»¶è¿Ÿï¼Œè¿™ç§å»¶è¿Ÿå¯èƒ½æ˜¯ç”±äºç½‘ç»œæ‹¥å¡ã€æ•…éšœæˆ–ä¸æ–­å¢é•¿çš„æµé‡æ‰€å¯¼è‡´ã€‚è¿™ç§å»¶è¿Ÿé€šå¸¸å…·æœ‰æŒç»­æ€§å’Œå±€éƒ¨æ€§ã€‚æŒç»­æ€§åˆ™è¡¨ç¤ºå»¶è¿Ÿä¼šé•¿æ—¶é—´å­˜åœ¨ï¼Œä¸ä¼šåœ¨çŸ­æ—¶é—´å†…æ¶ˆå¤±ï¼›è€Œå±€éƒ¨æ€§æŒ‡çš„æ˜¯å»¶è¿Ÿå¾€å¾€åªå‡ºç°åœ¨æŸäº›ç‰¹å®šæœåŠ¡å™¨ä¸Šï¼Œè€Œä¸ä¼šåœ¨å…¨å±€å‘ç”Ÿã€‚&lt;/p&gt;
&lt;h3 id=&#34;peakewma&#34;&gt;PeakEWMA&lt;/h3&gt;
&lt;p&gt;é¢å¯¹è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨PeakEWMAï¼ˆPeak Exponentially Weighted Moving Averageï¼‰è®¡ç®—å“åº”æ—¶é—´æŒ‡æ ‡ï¼Œå¹¶æ ¹æ®è¿™ä¸ªæŒ‡æ ‡æ¥å¯¹èŠ‚ç‚¹è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p&gt;
&lt;p&gt;EWMAæ˜¯ä¸€ç§åŠ¨æ€æƒé‡è°ƒæ•´ç®—æ³•ï¼Œå„æ•°å€¼çš„åŠ æƒå½±å“åŠ›éšæ—¶é—´è€ŒæŒ‡æ•°å¼è¡°é€€ï¼Œè¶Šè¿‘æœŸçš„æ•°æ®åŠ æƒå½±å“åŠ›è¶Šé‡ï¼Œä½†è¾ƒæ—§çš„æ•°æ®ä¹Ÿç»™äºˆä¸€å®šçš„åŠ æƒå€¼ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./decay.png&#34; alt=&#34;Decay&#34;&gt;&lt;/p&gt;
&lt;p&gt;å®ƒä»¥ç›¸å¯¹è¾ƒé«˜çš„æƒé‡è€ƒè™‘äº†æœ€è¿‘å“åº”æ—¶é—´çš„å½±å“ï¼Œå› æ­¤æ›´å…·æœ‰é’ˆå¯¹æ€§å’Œæ—¶æ•ˆæ€§ã€‚åŠ æƒçš„ç¨‹åº¦ä»¥å¸¸æ•° ğ›¼ å†³å®šï¼Œ ğ›¼ æ•°å€¼ä»‹äº 0 è‡³ 1ï¼Œå®ƒç”¨æ¥æ§åˆ¶æ•°æ®åŠ æƒå½±å“åŠ›è¡°é€€çš„é€Ÿç‡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./formula.png&#34; alt=&#34;Formula&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä½œä¸ºä¸€ç§ç»Ÿè®¡å­¦æŒ‡æ ‡ï¼ŒEWMAçš„è®¡ç®—è¿‡ç¨‹ä¸éœ€è¦å¤§é‡çš„é‡‡æ ·ç‚¹ä»¥åŠæ—¶é—´çª—å£çš„è®¾å®šï¼Œæœ‰æ•ˆåœ°é¿å…äº†è®¡ç®—èµ„æºçš„æµªè´¹ï¼Œæ›´é€‚åˆåœ¨mosnè¿™æ ·çš„è¾¹è½¦ä»£ç†ä¸­ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äºå“åº”æ—¶é—´æ˜¯å†å²æŒ‡æ ‡ï¼Œå½“æœåŠ¡å™¨å‡ºç°æ€§èƒ½é—®é¢˜å¯¼è‡´é•¿æ—¶é—´æœªè¿”å›æ—¶ï¼Œè´Ÿè½½å‡è¡¡ç®—æ³•ä¼šé”™è¯¯åœ°è®¤ä¸ºè¿™å°æœåŠ¡å™¨ä»æ˜¯æœ€ä¼˜çš„ï¼Œè€Œä¸æ–­åœ°å‘å…¶å‘é€è¯·æ±‚è€Œå¯¼è‡´é•¿å°¾å»¶è¿Ÿå¢é«˜ã€‚æˆ‘ä»¬ä½¿ç”¨æ´»è·ƒè¿æ¥æ•°ä½œä¸ºå®æ—¶å˜åŒ–çš„æŒ‡æ ‡å¯¹å“åº”æ—¶é—´è¿›è¡ŒåŠ æƒï¼Œè¡¨ç¤ºç­‰å¾…æ‰€æœ‰æ´»è·ƒçš„è¿æ¥éƒ½è¿”å›æ‰€éœ€è¦çš„æœ€å¤§æ—¶é—´ã€‚&lt;/p&gt;
&lt;h3 id=&#34;p2cpower-of-two-choice&#34;&gt;P2Cï¼ˆPower of Two Choiceï¼‰&lt;/h3&gt;
&lt;p&gt;åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼Œå¦‚æœä½¿ç”¨éå†æ‰€æœ‰æœåŠ¡å™¨é€‰æ‹©æœ€å¥½çš„æœåŠ¡å™¨çš„æ–¹æ³•ï¼Œè™½ç„¶å¯ä»¥æ‰¾åˆ°æœ€è½»è´Ÿè½½çš„æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ï¼Œä½†è¿™ç§æ–¹æ³•é€šå¸¸éœ€è¦å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œå› æ­¤æ— æ³•å¤„ç†å¤§è§„æ¨¡çš„è¯·æ±‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨P2Cï¼ˆPower of Two Choiceï¼‰æ¥é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒP2Cç®—æ³•å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…é€‰æ‹©ä¸¤ä¸ªæœåŠ¡å™¨è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶é€‰æ‹©å…¶ä¸­è´Ÿè½½æ›´è½»çš„æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚P2CåŸºäºæ¦‚ç‡åˆ†é…ï¼Œå³ä¸ç›´æ¥åŸºäºæƒé‡åˆ†é…ï¼Œè€Œæ˜¯æ ¹æ®æ¯ä¸ªæœåŠ¡å™¨ä¼˜äºå…¶ä»–æœåŠ¡å™¨çš„æ¦‚ç‡å€¼æ¥å†³å®šè¯·æ±‚çš„åˆ†é…ã€‚&lt;/p&gt;
&lt;p&gt;æ­¤å¤–ï¼Œåœ¨å¤šä¸ªè´Ÿè½½å‡è¡¡å™¨çš„æƒ…å†µä¸‹ï¼Œä¸åŒè´Ÿè½½å‡è¡¡å™¨å¯èƒ½ä¼šæœ‰ä¸åŒçš„èŠ‚ç‚¹è§†å›¾ï¼Œè¿™å¯èƒ½å¯¼è‡´æŸäº›è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©çš„æœ€ä¼˜èŠ‚ç‚¹æ€»æ˜¯æœ€å·®çš„èŠ‚ç‚¹ã€‚è¿™æ˜¯å› ä¸ºè´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹æ—¶åŸºäºè‡ªå·±çš„è§†å›¾ä¿¡æ¯ï¼Œè€ŒèŠ‚ç‚¹è§†å›¾éšç€æ—¶é—´çš„å˜åŒ–å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ä¸åŒçš„è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©çš„æœ€ä¼˜èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¸åŒã€‚P2Cç®—æ³•é€šè¿‡å¯¹éšæœºé€‰æ‹©çš„ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå¯ä»¥ä½¿èŠ‚ç‚¹é—´çš„è´Ÿè½½å‡è¡¡æ›´åŠ å‡åŒ€ï¼Œå³ä½¿èŠ‚ç‚¹è§†å›¾å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿèƒ½æä¾›ç¨³å®šçš„è´Ÿè½½å‡è¡¡æ•ˆæœã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;åœ¨mosnçš„v1.5.0ç‰ˆæœ¬ä¸­ï¼Œåªæœ‰èŠ‚ç‚¹æƒé‡ç›¸åŒæ—¶ä¼šä½¿ç”¨P2Cï¼Œå½“æƒé‡ä¸åŒæ—¶ä¼šä½¿ç”¨EDFè¿›è¡ŒåŠ æƒé€‰æ‹©ã€‚åç»­ä¼šæä¾›å¯é…ç½®çš„é€‰é¡¹ã€‚&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;æ¨¡æ‹Ÿæµé‡éªŒè¯&#34;&gt;æ¨¡æ‹Ÿæµé‡éªŒè¯&lt;/h3&gt;
&lt;p&gt;æˆ‘ä»¬æ„å»ºäº†ä¸ç”Ÿäº§ç¯å¢ƒæ€§èƒ½åˆ†å¸ƒç›¸è¿‘çš„æµ‹è¯•ç”¨ä¾‹æ¥å¯¹ç®—æ³•è¿›è¡ŒéªŒè¯ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨æ­£æ€åˆ†å¸ƒç”Ÿæˆäº†10å°æœåŠ¡å™¨çš„åŸºå‡†æ€§èƒ½ï¼Œå…¶ä¸­æ•°å­¦æœŸæœ›ä¸º50msï¼Œæ ‡å‡†å·®ä¸º10msã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿™äº›åŸºå‡†æ€§èƒ½ä½œä¸ºæ•°å­¦æœŸæœ›ï¼Œå¹¶ä»¥æ ‡å‡†å·®ä¸º5msçš„æ­£æ€åˆ†å¸ƒéšæœºç”Ÿæˆäº†è¯·æ±‚å»¶è¿Ÿï¼Œä»¥æ¨¡æ‹ŸçœŸå®ä¸–ç•Œçš„æƒ…å†µã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜åœ¨å…¶ä¸­ä¸€å°æœåŠ¡å™¨æ³¨å…¥äº†æ¦‚ç‡ä¸º0.1çš„æ•…éšœï¼Œæ•…éšœå‘ç”Ÿæ—¶ä¼šäº§ç”Ÿ1000msçš„å»¶è¿Ÿï¼Œä»¥æµ‹è¯•ç³»ç»Ÿçš„å®¹é”™æ€§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æ¨¡æ‹Ÿè¯·æ±‚å€¾æ–œæ—¶è¯·æ±‚æ’é˜Ÿç­‰å¾…çš„å»¶è¿Ÿï¼Œæˆ‘ä»¬é™åˆ¶äº†æ¯å°æœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘æ•°ä¸º8ï¼Œå½“åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°è¶…è¿‡äº†æœ€å¤§å¹¶å‘æ•°æ—¶ï¼Œå°†ä¼šæ’é˜Ÿç­‰å¾…ã€‚è¿™æ ·èƒ½å¤Ÿæ›´åŠ çœŸå®åœ°æ¨¡æ‹Ÿå‡ºç³»ç»Ÿçš„è¿è¡Œæƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Round Robinã€Least Requestå’ŒPeakEWMAä¸‰ç§ç®—æ³•ï¼Œåˆ†åˆ«ä»¥16å¹¶å‘åŒæ—¶å‘é€è¯·æ±‚ï¼Œå¾—åˆ°çš„P99å¦‚ä¸‹&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./p99.png&#34; alt=&#34;P99&#34;&gt;&lt;/p&gt;
&lt;p&gt;Round Robinç®—æ³•è™½ç„¶å¹³è¡¡ï¼Œä½†æ˜¯å§‹ç»ˆä¼šé€‰æ‹©åˆ°æ³¨å…¥äº†æ•…éšœçš„æœåŠ¡å™¨ï¼Œå¯¼è‡´P99å§‹ç»ˆåœ¨1000msä¸Šä¸‹æ³¢åŠ¨ï¼›Least Requestç®—æ³•è™½ç„¶é¿å¼€äº†æ•…éšœæœåŠ¡å™¨ï¼Œä½†æ˜¯å…¶P99å€¼ä¾ç„¶è¡¨ç°å‡ºè¾ƒå¤§çš„æ³¢åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸æ­¤ç›¸æ¯”ï¼ŒPeakEWMAç®—æ³•åœ¨ä¿æŒç¨³å®šçš„åŒæ—¶ï¼ŒP99å€¼å§‹ç»ˆä½äºRound Robinå’ŒLeast Requestç®—æ³•ã€‚è¿™æ°å½“åœ°ä½“ç°äº†mosnåœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢çš„æˆåŠŸï¼Œmosnç¡®å®åšåˆ°äº†èµ°å¾—æ›´å¿«ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœŸå¾…èµ°å¾—æ›´ç¨³&#34;&gt;æœŸå¾…èµ°å¾—æ›´ç¨³&lt;/h2&gt;
&lt;p&gt;è™½ç„¶mosnåœ¨æœåŠ¡ç½‘æ ¼ä¸­è§£å†³äº†è®©åº”ç”¨è·‘å¾—æ›´å¿«çš„é—®é¢˜ï¼Œä½†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•…éšœå´æ—¶åˆ»å­˜åœ¨ã€‚æˆ‘ä»¬æœŸæœ›é€šè¿‡mosnçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æœåŠ¡èµ°å¾—æ›´ç¨³ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¿«é€Ÿå¤±è´¥çš„æŒ‘æˆ˜&#34;&gt;å¿«é€Ÿå¤±è´¥çš„æŒ‘æˆ˜&lt;/h3&gt;
&lt;p&gt;æ ¹æ®ç»éªŒï¼Œæ•…éšœæ—¶çš„å“åº”æ—¶é—´å¾€å¾€è¿œè¿œå°äºæ­£å¸¸å€¼ï¼Œæ¯”å¦‚ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„è¿æ¥è¶…æ—¶ï¼Œè€Œæ²¡æœ‰å®é™…å¤„ç†è¯·æ±‚ã€‚æˆ‘ä»¬ç§°è¿™ç§é”™è¯¯æ—¶å“åº”æ—¶é—´è¿œè¿œå°äºæ­£å¸¸å€¼çš„æƒ…å†µä¸ºå¿«é€Ÿå¤±è´¥ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æœåŠ¡å™¨å‡ºç°å¿«é€Ÿå¤±è´¥æ—¶ï¼Œä»è´Ÿè½½å‡è¡¡çš„è§’åº¦çœ‹ï¼Œå°±ä¼šé”™è¯¯åœ°è®¤ä¸ºè¯¥æœåŠ¡å™¨æ˜¯æœ€ä¼˜çš„é€‰æ‹©ã€‚å°½ç®¡å¯ä»¥é€šè¿‡æ–­è·¯å™¨æ¥é¿å…å‘è¯¥æœåŠ¡å™¨å‘é€é•¿æœŸè¯·æ±‚ï¼Œä½†æ–­è·¯å™¨æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§å¿«é€Ÿå¤±è´¥ï¼Œé”™è¯¯çš„è§†å›¾ä¾ç„¶ä¼šä¼ æ’­ã€‚æ­¤å¤–ï¼Œæ–­è·¯å™¨çš„é˜ˆå€¼è®¾ç½®ä¹Ÿå­˜åœ¨æŒ‘æˆ˜ã€‚æ­¤å¤–ï¼Œæ–­è·¯å™¨éœ€è¦è¶³å¤Ÿçš„é”™è¯¯æ ·æœ¬æ‰èƒ½è§¦å‘ï¼Œè€Œæˆ‘ä»¬æœŸæœ›å°½å¯èƒ½é¿å…é”™è¯¯çš„å‘ç”Ÿã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åç»­ç‰ˆæœ¬ä¸­å°†ä¼šå¯¹è´Ÿè½½å‡è¡¡ç®—æ³•è¿›è¡Œè°ƒæ•´ï¼Œè®©è´Ÿè½½å‡è¡¡ç®—æ³•èƒ½å¤Ÿæ„ŸçŸ¥é”™è¯¯çš„å‘ç”Ÿï¼Œå¹¶åœ¨è§¦å‘æ–­è·¯å™¨å‰å°±é¿å…å°†è¯·æ±‚è½¬å‘åˆ°æ•…éšœçš„æœåŠ¡å™¨ä¸­ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ—[å…­] - Envoy Go æ‰©å±•ä¹‹å¹¶å‘å®‰å…¨</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-6/</link>
      <pubDate>Sun, 16 Apr 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-6/</guid>
      <description>
        
        
        &lt;p&gt;å‰ä¸€ç¯‡ä»‹ç»äº† Envoy Go æ‰©å±•çš„å†…å­˜å®‰å…¨ï¼Œç›¸å¯¹æ¥è¯´ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œä¸»è¦æ˜¯ Envoy C++ å’Œ Go GC éƒ½æœ‰è‡ªå·±ä¸€å¥—çš„å†…å­˜å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡èŠçš„å¹¶å‘å®‰å…¨ï¼Œåˆ™æ˜¯ä¸“æ³¨åœ¨å¹¶å‘åœºæ™¯ä¸‹çš„å†…å­˜å®‰å…¨ï¼Œç›¸å¯¹æ¥è¯´ä¼šå¤æ‚ä¸€äº›ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¹¶å‘çš„åŸå› &#34;&gt;å¹¶å‘çš„åŸå› &lt;/h2&gt;
&lt;p&gt;é¦–å…ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰å¹¶å‘å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æœ¬è´¨ä¸Šå› ä¸º Go æœ‰è‡ªå·±çš„æŠ¢å å¼çš„åç¨‹è°ƒåº¦ï¼Œè¿™æ˜¯ Go æ¯”è¾ƒé‡çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ä¸ Lua è¿™ç±»åµŒå…¥å¼è¯­è¨€åŒºåˆ«å¾ˆå¤§çš„ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;ç»†èŠ‚çš„è¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹è¿™ç¯‡ &lt;a href=&#34;https://uncledou.site/2022/go-cgo-c-to-go/&#34;&gt;cgo å®ç°æœºåˆ¶ - ä» c è°ƒç”¨ go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œç®€å•äº¤ä»£ä¸€ä¸‹çš„ï¼Œå› ä¸º c è°ƒç”¨ goï¼Œå…¥å£çš„ Go å‡½æ•°çš„è¿è¡Œç¯å¢ƒæ˜¯ï¼ŒGoroutine è¿è¡Œåœ¨ Envoy worker çº¿ç¨‹ä¸Šï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿäº†ç½‘ç»œè°ƒç”¨è¿™ç§å¯èƒ½å¯¼è‡´ Goroutine æŒ‚èµ·çš„ï¼Œåˆ™ä¼šå¯¼è‡´ Envoy worker çº¿ç¨‹è¢«æŒ‚èµ·ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œè§£å†³æ€è·¯å°±æ˜¯åƒ &lt;a href=&#34;https://uncledou.site/2023/moe-extend-envoy-using-golang-4/&#34;&gt;Go æ‰©å±•çš„å¼‚æ­¥æ¨¡å¼&lt;/a&gt; ä¸­çš„ç¤ºä¾‹ä¸€æ ·ï¼Œæ–°èµ·ä¸€ä¸ª Goroutineï¼Œå®ƒä¼šè¿è¡Œåœ¨æ™®é€šçš„ go çº¿ç¨‹ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆæ­¤æ—¶ï¼Œå¯¹äºåŒä¸€ä¸ªè¯·æ±‚ï¼Œåˆ™ä¼šåŒæ—¶æœ‰ Envoy worker çº¿ç¨‹å’Œ Go çº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹å¹¶å‘åœ¨å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªå°±æ˜¯å¹¶å‘çš„æ¥æºã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ç”¨æˆ·æ“å¿ƒè¿™äº›ç»†èŠ‚ï¼Œè€Œæ˜¯åœ¨åº•å±‚æä¾›å¹¶å‘å®‰å…¨çš„ APIï¼ŒæŠŠå¤æ‚åº¦ç•™åœ¨ Envoy Go æ‰©å±•çš„åº•å±‚å®ç°é‡Œã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¹¶å‘å®‰å…¨çš„å®ç°&#34;&gt;å¹¶å‘å®‰å…¨çš„å®ç°&lt;/h2&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é’ˆå¯¹ Goroutine è¿è¡Œåœ¨æ™®é€šçš„ Go çº¿ç¨‹ä¸Šï¼Œè¿™ä¸ªå¹¶å‘åœºæ™¯ï¼Œæ¥èŠä¸€èŠå¦‚ä½•å®ç°å¹¶å‘å®‰å…¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äº Goroutine è¿è¡Œåœ¨ Envoy çº¿ç¨‹ä¸Šï¼Œå› ä¸ºå¹¶ä¸å­˜åœ¨å¹¶å‘å†²çªï¼Œè¿™é‡Œä¸åšä»‹ç»ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å†™-header-æ“ä½œ&#34;&gt;å†™ header æ“ä½œ&lt;/h3&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆèŠä¸€ä¸ªç®€å•çš„ï¼Œæ¯”å¦‚åœ¨ Go é‡Œé¢é€šè¿‡ &lt;code&gt;header.Set&lt;/code&gt; å†™ä¸€ä¸ªè¯·æ±‚å¤´ã€‚&lt;/p&gt;
&lt;p&gt;æ ¸å¿ƒæ€è·¯æ˜¯ï¼Œæ˜¯é€šè¿‡ &lt;code&gt;dispatcher.post&lt;/code&gt;ï¼Œå°†å†™æ“ä½œå½“åšä¸€ä¸ªäº‹ä»¶æ´¾å‘ç»™ Envoy worker çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè¿™æ ·å°±é¿å…äº†å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;h3 id=&#34;è¯»-header-æ“ä½œ&#34;&gt;è¯» header æ“ä½œ&lt;/h3&gt;
&lt;p&gt;è¯» header åˆ™è¦å¤æ‚ä¸å°‘ï¼Œå› ä¸ºå†™ä¸éœ€è¦è¿”å›å€¼ï¼Œå¯ä»¥å¼‚æ­¥æ‰§è¡Œï¼Œè¯»å°±ä¸è¡Œäº†ï¼Œå¿…é¡»å¾—åˆ°è¿”å›å€¼ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºæ­¤ï¼Œæˆ‘ä»¬æ ¹æ® Envoy æµå¼çš„å¤„ç†å¥—è·¯ï¼Œè®¾è®¡äº†ä¸€ä¸ªç±»ä¼¼äºæ‰€æœ‰æƒçš„æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;Envoy çš„æµå¼å¤„ç†ï¼Œå¯ä»¥çœ‹è¿™ç¯‡ &lt;a href=&#34;https://uncledou.site/2022/envoy-filter-status/&#34;&gt;ææ‡‚ http filter çŠ¶æ€ç &lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå½“è¿›å…¥ &lt;code&gt;decodeHeaders&lt;/code&gt; çš„æ—¶å€™ï¼Œheader æ‰€æœ‰æƒå°±äº¤ç»™ Envoy Go çš„ c++ ä¾§äº†ï¼Œç„¶åï¼Œå½“é€šè¿‡ cgo è¿›å…¥ Go ä¹‹åï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºï¼Œæ ‡è®°æ‰€æœ‰æƒåœ¨ Go äº†ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡è¿™å¥—è®¾è®¡/çº¦å®šï¼Œå°±å¯ä»¥å®‰å…¨çš„è¯»å– header äº†ï¼Œæœ¬è´¨ä¸Šï¼Œè¿˜æ˜¯å±äºè§„é¿å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆä¸é€šè¿‡é”æ¥è§£å†³å‘¢ï¼Ÿå› ä¸º Envoy å¹¶æ²¡æœ‰å¯¹äº header çš„é”æœºåˆ¶ï¼Œc++ ä¾§å®Œå…¨ä¸ä¼šæœ‰å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;h3 id=&#34;è¯»å†™-data-æ“ä½œ&#34;&gt;è¯»å†™ data æ“ä½œ&lt;/h3&gt;
&lt;p&gt;æœ‰äº†è¿™å¥—æ‰€æœ‰æƒæœºåˆ¶ï¼Œdata æ“ä½œå°±è¦ç®€å•å¾ˆå¤šäº†ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸º header åªæœ‰ä¸€ä»½ï¼Œå¹¶å‘å†²çªåŸŸå¾ˆå¤§ï¼Œéœ€è¦è€ƒè™‘ Go ä»£ç ä¸ c++ ä¾§çš„å…¶ä»– filter çš„ç«äº‰ã€‚&lt;/p&gt;
&lt;p&gt;data åˆ™æ˜¯æµå¼å¤„ç†ï¼Œæˆ‘ä»¬åœ¨ c++ ä¾§è®¾è®¡äº†ä¸¤ä¸ª buffer å¯¹è±¡ï¼Œä¸€ä¸ªç”¨äºæ¥å— filter manager çš„æµå¼æ•°æ®ï¼Œä¸€ä¸ªç”¨äºç¼“å­˜äº¤ç»™ Go ä¾§çš„æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ ·çš„è¯ï¼Œäº¤ç»™ Go æ¥å¤„ç†çš„æ•°æ®ï¼ŒGo ä»£ç æ‹¥æœ‰å®Œæ•´çš„æ‰€æœ‰æƒï¼Œä¸éœ€è¦è€ƒè™‘ Go ä»£ç ä¸ C++ ä¾§å…¶ä»– filter çš„ç«äº‰ï¼Œå¯ä»¥å®‰å…¨çš„è¯»å†™ï¼Œä¹Ÿæ²¡æœ‰å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;h3 id=&#34;è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ&#34;&gt;è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ&lt;/h3&gt;
&lt;p&gt;å¦å¤–ä¸€ä¸ªå¾ˆå¤§çš„å¹¶å‘å†²çªï¼Œåˆ™å…³ä¹è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚ Envoy éšæ—¶éƒ½æœ‰å¯èƒ½æå‰é”€æ¯è¯·æ±‚ï¼Œæ­¤æ—¶ Goroutine è¿˜åœ¨ go thread ä¸Šç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”éšæ—¶å¯èƒ½è¯»å†™è¯·æ±‚æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å¤„ç†çš„æ€è·¯æ˜¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¹¶æ²¡æœ‰æœ‰æ•ˆçš„åŠæ³•ï¼Œèƒ½å¤Ÿç«‹å³ kill goroutineï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å…è®¸ goroutine å¯èƒ½åœ¨è¯·æ±‚è¢«é”€æ¯ä¹‹åç»§ç»­æ‰§è¡Œ&lt;/li&gt;
&lt;li&gt;ä½†æ˜¯ï¼Œgoroutine å¦‚æœè¯»å†™è¯·æ±‚æ•°æ®ï¼Œgoroutine ä¼šè¢«ç»ˆæ­¢ï¼Œpanic + recoverï¼ˆrecover ç»†èŠ‚æˆ‘ä»¬ä¸‹ä¸€ç¯‡ä¼šä»‹ç»ï¼‰ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;é‚£ä¹ˆï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œæ‰€æœ‰çš„ API éƒ½æ£€æŸ¥å½“å‰æ“ä½œçš„è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æ¯è¯·æ±‚æœ‰ä¸€ä¸ªå†…å­˜å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åªä¼šç”± Go æ¥é”€æ¯ï¼Œå¹¶ä¸ä¼šåœ¨è¯·æ±‚ç»“æŸæ—¶ï¼Œè¢« Envoy é”€æ¯ï¼Œä½†æ˜¯è¿™ä¸ªå†…å­˜å¯¹è±¡ä¸­ä¿å­˜äº†ä¸€ä¸ª weakPtrï¼Œå¯ä»¥è·å– C++ filter çš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼ŒGo å¯ä»¥å®‰å…¨çš„è·å– C++ ä¾§çš„ filterï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦è¿˜åœ¨ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨ &lt;code&gt;onDestroy&lt;/code&gt;ï¼Œä¹Ÿå°±æ˜¯ C++ filter è¢«é”€æ¯çš„ hook ç‚¹ï¼›ä»¥åŠ Go thread è¯»å†™è¯·æ±‚æ•°æ®ï¼Œè¿™ä¸¤ä¸ªä½ç½®éƒ½åŠ é”å¤„ç†ï¼Œä»¥è§£å†³è¿™ä¸¤ä¸ªä¹‹é—´çš„å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;æœ€å&#34;&gt;æœ€å&lt;/h2&gt;
&lt;p&gt;å¯¹äºå¹¶å‘å†²çªï¼Œå…¶å®æœ€ç®€å•çš„å°±æ˜¯ï¼Œé€šè¿‡åŠ é”æ¥ç«äº‰æ‰€æœ‰æƒï¼Œä½†æ˜¯ Envoy åœ¨è¿™å—çš„åº•å±‚è®¾è®¡å¹¶æ²¡æœ‰é”ï¼Œå› ä¸ºå®ƒæ ¹æœ¬ä¸éœ€è¦é”ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼ŒåŸºäº Envoy çš„å¤„ç†æ¨¡å‹ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€å¥—ç±»ä¼¼æ‰€æœ‰æƒçš„æœºåˆ¶ï¼Œæ¥é¿å…å¹¶å‘å†²çªã€‚&lt;/p&gt;
&lt;p&gt;æ‰€æœ‰æƒçš„æ¦‚å¿µä¹Ÿå—åˆ°äº† Rust çš„å¯å‘ï¼Œåªæ˜¯ä¸¤è€…å·¥ä½œçš„å±‚æ¬¡ä¸ä¸€æ ·ï¼ŒRust æ˜¯æ›´åº•å±‚çš„è¯­è¨€å±‚é¢ï¼Œå¯ä»¥ä½œç”¨äºè¯­è¨€å±‚é¢ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ™æ˜¯æ›´ä¸Šå±‚çš„æ¦‚å¿µï¼Œç‰¹å®šäº Envoy çš„å¤„ç†æ¨¡å‹ï¼Œä¹Ÿåªèƒ½ä½œç”¨äºè¿™ä¸€ä¸ªå°åœºæ™¯ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯æŸç§ç¨‹åº¦ä¸Šï¼Œè§£å†³çš„é—®é¢˜ï¼Œä»¥åŠå…¶ä¸­éƒ¨åˆ†æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ— [äº”] - Envoy Go æ‰©å±•ä¹‹å†…å­˜å®‰å…¨</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-5/</link>
      <pubDate>Sun, 09 Apr 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-5/</guid>
      <description>
        
        
        &lt;p&gt;å‰é¢å‡ ç¯‡ä»‹ç»äº† Envoy Go æ‰©å±•çš„åŸºæœ¬ç”¨æ³•ï¼Œæ¥ä¸‹æ¥å‡ ç¯‡å°†ä»‹ç»å®ç°æœºåˆ¶å’ŒåŸç†ã€‚&lt;/p&gt;
&lt;p&gt;Envoy æ˜¯ C++ å®ç°çš„ï¼Œé‚£ Envoy Go æ‰©å±•ï¼Œæœ¬è´¨ä¸Šå°±ç›¸å½“äºæŠŠ Go è¯­è¨€åµŒå…¥ C++é‡Œ äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Go åœˆé‡Œï¼Œå°† Go å½“åšåµŒå…¥å¼è¯­è¨€æ¥ç”¨çš„ï¼Œè²Œä¼¼å¹¶ä¸å¤ªå¤šè§ï¼Œè¿™é‡Œé¢ç»†èŠ‚è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚ æ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Envoy æœ‰ä¸€å¥—è‡ªå·±çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè€Œ Go åˆæ˜¯ä¸€é—¨è‡ªå¸¦ GC çš„è¯­è¨€&lt;/li&gt;
&lt;li&gt;Envoy æ˜¯åŸºäº libevent å°è£…çš„äº‹ä»¶é©±åŠ¨ï¼Œè€Œ Go åˆæ˜¯åŒ…å«äº†æŠ¢å å¼çš„åç¨‹è°ƒåº¦&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä¸ºäº†é™ä½ç”¨æˆ·å¼€å‘æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œæˆ‘ä»¬æä¾›äº†ä¸‰ç§çš„å®‰å…¨ä¿éšœã€‚æœ‰äº†è¿™ä¸‰å±‚ä¿éšœï¼Œç”¨æˆ·å†™ Go æ¥æ‰©å±• Envoy çš„æ—¶å€™ï¼Œå°±å¯ä»¥åƒå¹³å¸¸å†™ Go ä»£ç ä¸€æ ·ç®€å•ï¼Œè€Œä¸å¿…å…³å¿ƒè¿™äº›åº•å±‚ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä¸‰ç§å®‰å…¨&#34;&gt;ä¸‰ç§å®‰å…¨&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;å†…å­˜å®‰å…¨&lt;/p&gt;
&lt;p&gt;ç”¨æˆ·é€šè¿‡ API è·å–åˆ°çš„å†…å­˜å¯¹è±¡ï¼Œå¯ä»¥å½“åšæ™®é€šçš„ Go å¯¹è±¡æ¥ä½¿ç”¨&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚ï¼Œé€šè¿‡ headers.Get å¾—åˆ°çš„å­—ç¬¦ä¸²ï¼Œåœ¨è¯·æ±‚ç»“æŸä¹‹åè¿˜å¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸ç”¨æ‹…å¿ƒè¯·æ±‚å·²ç»åœ¨ Envoy ä¾§ç»“æŸäº†ï¼Œå¯¼è‡´è¿™ä¸ªå­—ç¬¦ä¸²è¢«æå‰é‡Šæ”¾äº†&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¹¶å‘å®‰å…¨&lt;/p&gt;
&lt;p&gt;å½“å¯ç”¨åç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„ Go ä»£ç å°†ä¼šè¿è¡Œåœ¨å¦å¤–çš„ Go çº¿ç¨‹ä¸Šï¼Œè€Œä¸æ˜¯åœ¨å½“å‰çš„ Envoy worker çº¿ç¨‹ä¸Šï¼Œæ­¤æ—¶å¯¹äºåŒä¸€ä¸ªè¯·æ±‚ï¼Œåˆ™å­˜åœ¨ Envoy worker çº¿ç¨‹å’Œ Go çº¿ç¨‹çš„å¹¶å‘&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œç”¨æˆ·å¹¶ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªç»†èŠ‚ï¼Œæˆ‘ä»¬æä¾›çš„ API éƒ½æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œç”¨æˆ·å¯ä»¥ä¸æ„ŸçŸ¥å¹¶å‘çš„å­˜åœ¨&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ²™ç®±å®‰å…¨&lt;/p&gt;
&lt;p&gt;è¿™ä¸€æ¡æ˜¯é’ˆå¯¹å®¿ä¸» Envoy çš„ä¿éšœï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æŸä¸€ä¸ª Go æ‰©å±•çš„å¼‚å¸¸ï¼ŒæŠŠæ•´ä¸ª Envoy è¿›ç¨‹æå¥”æºƒäº†ã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰æˆ‘ä»¬æä¾›çš„æ˜¯ï¼ŒGo runtime å¯ä»¥ recover çš„æœ‰é™æ²™ç®±å®‰å…¨ï¼Œè¿™é€šå¸¸ä¹Ÿè¶³å¤Ÿäº†ã€‚&lt;/p&gt;
&lt;p&gt;æ›´æ·±åº¦çš„ï¼Œruntime ä¹Ÿ recover ä¸äº†çš„ï¼Œæ¯”å¦‚ map å¹¶å‘è®¿é—®ï¼Œåˆ™åªèƒ½å°† Go so é‡è½½ï¼Œé‡å»ºæ•´ä¸ª Go runtime äº†ï¼Œè¿™ä¸ªåç»­ä¹Ÿå¯ä»¥åŠ ä¸Šã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å†…å­˜å®‰å…¨å®ç°æœºåˆ¶&#34;&gt;å†…å­˜å®‰å…¨å®ç°æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;è¦æä¾›å®‰å…¨çš„å†…å­˜æœºåˆ¶ï¼Œæœ€ç®€å•çš„åŠæ³•ï¼Œä¹Ÿæ˜¯ï¼ˆå‡ ä¹ï¼‰å”¯ä¸€çš„åŠæ³•ï¼Œå°±æ˜¯å¤åˆ¶ã€‚
ä½†æ˜¯ï¼Œä»€ä¹ˆæ—¶å€™å¤åˆ¶ï¼Œæ€ä¹ˆå¤åˆ¶ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›è®²ç©¶çš„ã€‚è¿™é‡Œæƒè¡¡çš„ç›®æ ‡æ˜¯é™ä½å¤åˆ¶çš„å¼€é”€ï¼Œæå‡æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œè®²çš„å†…å­˜å®‰å…¨ï¼Œè¿˜ä¸æ¶‰åŠå¹¶å‘æ—¶çš„å†…å­˜å®‰å…¨ï¼Œåªæ˜¯ Envoyï¼ˆC++ï¼‰å’Œ Go è¿™ä¸¤ä¸ªè¯­è¨€/è¿è¡Œæ—¶ä¹‹é—´çš„å·®å¼‚ã€‚&lt;/p&gt;
&lt;p&gt;PSï¼šä»¥å‰æ·· OpenResty çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å¤åˆ¶çš„ç©æ³•ï¼Œåªæ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«æ˜¯ï¼ŒLua string çš„ internal å½’ä¸€åŒ–åœ¨å¤§å†…å­˜åœºæ™¯ä¸‹ï¼Œä¼šæœ‰ç›¸å¯¹è¾ƒå¤§çš„å¼€é”€ï¼›Go string åˆ™æ²¡æœ‰è¿™ä¸€å±‚å¼€é”€ï¼Œåªæœ‰ memory copy + GC çš„å¼€é”€ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¤åˆ¶æ—¶æœº&#34;&gt;å¤åˆ¶æ—¶æœº&lt;/h3&gt;
&lt;p&gt;é¦–å…ˆæ˜¯å¤åˆ¶æ—¶æœºï¼Œæˆ‘ä»¬é€‰æ‹©äº†æŒ‰éœ€å¤åˆ¶ï¼Œæ¯”å¦‚ headerï¼Œbody data å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±å¤åˆ¶åˆ° Go é‡Œé¢ï¼Œåªåœ¨æœ‰å¯¹åº”çš„ API è°ƒç”¨æ—¶ï¼Œæ‰ä¼šçœŸçš„å» Envoy ä¾§è·å– &amp;amp; å¤åˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæ²¡æœ‰è¢«çœŸå®éœ€è¦ï¼Œåˆ™å¹¶ä¸ä¼šäº§ç”Ÿå¤åˆ¶ï¼Œè¿™ä¸ªä¼˜åŒ–å¯¹äº header è¿™ç§å¸¸ç”¨çš„ï¼Œæ•ˆæœå€’æ˜¯ä¸å¤ªæ˜æ˜¾ï¼Œå¯¹äº body è¿™ç§ç»å¸¸ä¸éœ€è¦è·å–å†…å®¹çš„ï¼Œæ•ˆæœåˆ™ä¼šæ¯”è¾ƒçš„æ˜æ˜¾ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¤åˆ¶æ–¹å¼&#34;&gt;å¤åˆ¶æ–¹å¼&lt;/h3&gt;
&lt;p&gt;å¦ä¸€ä¸ªåˆ™æ˜¯å¤åˆ¶æ–¹å¼ï¼Œæ¯”å¦‚ header è·å–ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯åœ¨ Go ä¾§é¢„å…ˆç”³è¯·å†…å­˜ï¼Œåœ¨ C++ ä¾§æ¥å®Œæˆèµ‹å€¼çš„æ–¹å¼ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦ä¸€æ¬¡å†…å­˜èµ‹å€¼å³å¯å®Œæˆã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨è¿›å…¥ Go çš„æ—¶å€™ï¼Œå·²ç»æŠŠ header çš„å¤§å°ä¼ ç»™äº† Goï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ Go ä¾§é¢„å…ˆåˆ†é…å¥½éœ€è¦çš„å†…å­˜ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡å‘¢ï¼Œè¿™ä¸ªç©æ³•ç¡®å®æœ‰ç‚¹ trickyï¼Œå¹¶ä¸æ˜¯ Go æ–‡æ¡£ä¸Šæ³¨æ˜æ¨èçš„ç”¨æ³•ï¼Œä½†æ˜¯å‘¢ï¼Œä¹Ÿç¡®å®æ˜¯æˆ‘ä»¬å‘ç°çš„æœ€ä¼˜çš„è§£æ³•äº†ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæŒ‰ç…§ Go å¸¸è§„çš„ç©æ³•ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€æ¬¡åŠ/ä¸¤æ¬¡å†…å­˜æ‹·è´ï¼Œæ‰èƒ½ä¿è¯å®‰å…¨ï¼Œè¿™é‡Œæœ‰ä¸ªåŠæ¬¡çš„å·®å¼‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸‹å›è¦è¯´çš„å¹¶å‘é€ æˆçš„ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–ï¼Œåœ¨ API å®ç°ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯æ¯æ¬¡è·å–ä¸€ä¸ª headerï¼Œè€Œæ˜¯ç›´æ¥ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰çš„ header å…¨å¤åˆ¶è¿‡æ¥äº†ï¼Œåœ¨ Go ä¾§ç¼“å­˜äº†ã€‚
è¿™æ˜¯å› ä¸ºå¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è·å–çš„ header æ•°é‡ä¼šæœ‰å¤šä¸ªï¼Œåœ¨æƒè¡¡äº† cgo çš„è°ƒç”¨å¼€é”€å’Œå†…å­˜æ‹·è´çš„å¼€é”€ä¹‹åï¼Œæˆ‘ä»¬è®¤ä¸ºä¸€æ¬¡æ€§å…¨æ‹·è´æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœ€å&#34;&gt;æœ€å&lt;/h2&gt;
&lt;p&gt;ç›¸å¯¹æ¥è¯´ï¼Œä¸è€ƒè™‘å¹¶å‘çš„å†…å­˜å®‰å…¨ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªæœ‰å¤åˆ¶æœ€å®‰å…¨ï¼Œéœ€è¦æƒè¡¡è€ƒè™‘çš„åˆ™æ›´å¤šæ˜¯ä¼˜åŒ–çš„äº‹æƒ…äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”è¾ƒå¤æ‚çš„è¿˜æ˜¯å¹¶å‘æ—¶çš„å®‰å…¨å¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸‹å›å†èŠã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ— [å››] - Go æ‰©å±•çš„å¼‚æ­¥æ¨¡å¼</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-4/</link>
      <pubDate>Sat, 18 Mar 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-4/</guid>
      <description>
        
        
        &lt;p&gt;ä¸Šä¸€ç¯‡æˆ‘ä»¬ä½“éªŒäº†ç”¨ Istio åšæ§åˆ¶é¢ï¼Œç»™ Go æ‰©å±•æ¨é€é…ç½®ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹ï¼Œåœ¨ Go æ‰©å±•çš„å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œå¯¹ goroutine ç­‰å…¨éƒ¨ Go ç‰¹æ€§çš„æ”¯æŒã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¼‚æ­¥æ¨¡å¼&#34;&gt;å¼‚æ­¥æ¨¡å¼&lt;/h2&gt;
&lt;p&gt;ä¹‹å‰ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ &lt;a href=&#34;https://uncledou.site/2023/moe-extend-envoy-using-golang-2/&#34;&gt;basic auth&lt;/a&gt;ï¼Œä½†æ˜¯ï¼Œé‚£ä¸ªå®ç°æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒGo æ‰©å±•ä¼šé˜»å¡ï¼Œç›´åˆ° basic auth éªŒè¯å®Œæˆï¼Œæ‰ä¼šè¿”å›ç»™ Envoyã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸º basic auth æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åœºæ™¯ï¼Œç”¨æˆ·åå¯†ç å·²ç»è§£æåœ¨ Go å†…å­˜ä¸­äº†ï¼Œæ•´ä¸ªè¿‡ç¨‹åªæ˜¯çº¯ CPU è®¡ç®—ï¼Œæ‰€ä»¥ï¼Œè¿™ç§åŒæ­¥çš„å®ç°æ–¹å¼æ˜¯æ²¡é—®é¢˜çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªæ›´å¤æ‚çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬è¦å°†ç”¨æˆ·åå¯†ç ï¼Œè°ƒç”¨è¿œç¨‹æ¥å£æŸ¥è¯¢ï¼Œæ¶‰åŠç½‘ç»œæ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒåŒæ­¥çš„å®ç°æ–¹å¼å°±ä¸å¤ªåˆé€‚äº†ã€‚å› ä¸ºï¼ŒåŒæ­¥æ¨¡å¼ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ç­‰å¾…è¿œç¨‹æ¥å£è¿”å›ï¼Œé‚£ä¹ˆï¼ŒGo æ‰©å±•å°±ä¼šé˜»å¡ï¼ŒEnvoy ä¹Ÿå°±æ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§å¼‚æ­¥æ¨¡å¼ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æˆ‘ä»¬åœ¨ Go æ‰©å±•ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ª goroutineï¼Œç„¶åç«‹å³è¿”å›ç»™ Envoyï¼Œå½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚ä¼šè¢«æŒ‚èµ·ï¼ŒEnvoy åˆ™å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;goroutine åœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œå½“ goroutine ä¸­çš„ä»»åŠ¡å®Œæˆä¹‹åï¼Œå†å›è°ƒé€šçŸ¥ Envoyï¼ŒæŒ‚èµ·çš„è¯·æ±‚å¯ä»¥ç»§ç»­å¤„ç†äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ³¨æ„ï¼šè™½ç„¶ goroutine æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œä½†æ˜¯ goroutine ä¸­çš„ä»£ç ï¼Œä¸åŒæ­¥æ¨¡å¼ä¸‹çš„ä»£ç ï¼Œå‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå¹¶ä¸éœ€è¦ç‰¹åˆ«çš„å¤„ç†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä¸ºä»€ä¹ˆéœ€è¦&#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦&lt;/h2&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆéœ€è¦æ”¯æŒ Goroutine ç­‰å…¨éƒ¨ Go çš„ç‰¹æ€§å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æœ‰ä¸¤æ–¹é¢çš„åŸå› ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æœ‰äº† full feature supported Goï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¾ˆéå¸¸å¼ºå¤§ï¼Œå¤æ‚çš„æ‰©å±•&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¯ä»¥éå¸¸æ–¹ä¾¿çš„é›†æˆç°æœ‰çš„ Go ä¸–ç•Œçš„ä»£ç ï¼Œäº«å— Go ç”Ÿæ€çš„çº¢åˆ©&lt;/p&gt;
&lt;p&gt;å¦‚æœä¸æ”¯æŒå…¨éƒ¨çš„ Go ç‰¹æ€§ï¼Œé‚£ä¹ˆåœ¨é›†æˆç°æœ‰ Go ä»£ç çš„æ—¶å€™ï¼Œä¼šæœ‰è¯¸å¤šé™åˆ¶ï¼Œå¯¼è‡´éœ€è¦é‡å†™å¤§é‡çš„ä»£ç ï¼Œè¿™æ ·ï¼Œå°±äº«å—ä¸åˆ° Go ç”Ÿæ€çš„çº¢åˆ©äº†ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å®ç°&#34;&gt;å®ç°&lt;/h2&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥ä½“éªŒï¼Œè¿™æ¬¡æˆ‘ä»¬å®ç° basic auth çš„è¿œç¨‹æ ¡éªŒç‰ˆæœ¬ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DecodeHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StatusType&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;go&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// verify ä¸­çš„ä»£ç ï¼Œå¯ä»¥ä¸éœ€è¦æ„ŸçŸ¥æ˜¯å¦å¼‚æ­¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åŒæ—¶ï¼Œverify ä¸­æ˜¯å¯ä»¥ä½¿ç”¨å…¨éƒ¨çš„ Go ç‰¹æ€§ï¼Œæ¯”å¦‚ï¼Œhttp.Post
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;msg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;verify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;callbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SendLocalReply&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;msg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;bad-request&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™é‡Œæ˜¯å”¯ä¸€çš„ API åŒºåˆ«ï¼Œå¼‚æ­¥å›è°ƒï¼Œé€šçŸ¥ Envoyï¼Œå¯ä»¥ç»§ç»­å¤„ç†å½“å‰è¯·æ±‚äº†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;callbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Continue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Continue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}()&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Running è¡¨ç¤º Go è¿˜åœ¨å¤„ç†ä¸­ï¼ŒEnvoy ä¼šæŒ‚èµ·å½“å‰è¯·æ±‚ï¼Œç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Running&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å†æ¥çœ‹ &lt;code&gt;verify&lt;/code&gt; çš„ä»£ç ï¼Œé‡ç‚¹æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨å…¨éƒ¨çš„ Go ç‰¹æ€§ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™é‡Œä½¿ç”¨äº† http.Post
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;checkRemote&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;body&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sprintf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;`{&amp;#34;username&amp;#34;: &amp;#34;%s&amp;#34;, &amp;#34;password&amp;#34;: &amp;#34;%s&amp;#34;}`&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;remoteAddr&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;:&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strconv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Itoa&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;port&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/check&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;http&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Post&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;remoteAddr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;application/json&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strings&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewReader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;body&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Printf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;check error: %v\n&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StatusCode&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™é‡Œæ“ä½œ header è¿™ä¸ª interfaceï¼Œä¸åŒæ­¥æ¨¡å¼å®Œå…¨ä¸€æ ·
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;auth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;authorization&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;no Authorization&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;parseBasicAuth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;auth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;invalid Authorization format&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Printf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;got username: %v, password: %v\n&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;checkRemote&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;invalid username or password&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡ï¼Œç”¨æ¥æ ¡éªŒç”¨æˆ·åå¯†ç ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œç”¨æˆ·åå¯†ç è¿˜æ˜¯ &lt;code&gt;foo:bar&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å®Œæ•´çš„ä»£ç ï¼Œè¯·ç§»æ­¥ &lt;a href=&#34;https://github.com/doujiang24/envoy-go-filter-example/tree/master/example-remote-basic-auth&#34;&gt;github&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h2&gt;
&lt;p&gt;è€è§„çŸ©ï¼Œå¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨ &lt;code&gt;curl&lt;/code&gt; æ¥æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ curl -s -I -HHost:httpbin.example.com &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_HOST&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_PORT&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;/status/200&amp;#34;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt; Unauthorized

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# valid foo:bar&lt;/span&gt;
$ curl -s -I -HHost:httpbin.example.com &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_HOST&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_PORT&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;/status/200&amp;#34;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Authorization: basic Zm9vOmJhcg==&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200&lt;/span&gt; OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¾æ—§ç¬¦åˆé¢„æœŸã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;åœ¨åŒæ­¥æ¨¡å¼ä¸‹ï¼ŒGo ä»£ç ä¸­å¸¸è§„çš„å¼‚æ­¥éé˜»å¡ï¼Œä¹Ÿä¼šå˜æˆé˜»å¡æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸º Go å’Œ Envoy æ˜¯ä¸¤å¥—äº‹ä»¶å¾ªç¯ä½“ç³»ã€‚&lt;/p&gt;
&lt;p&gt;è€Œé€šè¿‡å¼‚æ­¥æ¨¡å¼ï¼ŒGo å¯ä»¥åœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ Envoy çš„äº‹ä»¶å¾ªç¯ï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥ç”¨ä¸Šå…¨éƒ¨çš„ Go ç‰¹æ€§äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äº Envoy Go æš´éœ²çš„æ˜¯åº•å±‚çš„ APIï¼Œæ‰€ä»¥å®ç° Go æ‰©å±•çš„æ—¶å€™ï¼Œéœ€è¦å…³å¿ƒåŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œè¿™å¯¹äºæ™®é€šçš„æ‰©å±•å¼€å‘è€Œè¨€ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå‹å¥½çš„è®¾è®¡ï¼Œåªæ‰€æœ‰è¿™ä¹ˆè®¾è®¡ï¼Œæ›´å¤šæ˜¯ä¸ºäº†æè‡´æ€§èƒ½çš„è€ƒé‡ã€‚&lt;/p&gt;
&lt;p&gt;å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œå…¶å®å¹¶ä¸éœ€è¦åˆ°è¿™ä¹ˆæè‡´ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šåœ¨æ›´ä¸Šå±‚æä¾›ä¸€ç§ï¼Œé»˜è®¤å¼‚æ­¥çš„æ¨¡å¼ï¼Œè¿™æ ·ï¼ŒGo æ‰©å±•çš„å¼€å‘è€…ï¼Œå°±ä¸éœ€è¦å…³å¿ƒåŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ¬¢è¿æ„Ÿå…´è¶£çš„æŒç»­å…³æ³¨~&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ— [ä¸‰] - ä½¿ç”¨ Istio åŠ¨æ€æ›´æ–° Go æ‰©å±•é…ç½®</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-3/</link>
      <pubDate>Thu, 16 Mar 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-3/</guid>
      <description>
        
        
        &lt;p&gt;&lt;a href=&#34;https://mosn.io/blog/posts/moe-extend-envoy-using-golang-2/&#34;&gt;ä¸Šä¸€ç¯‡&lt;/a&gt; æˆ‘ä»¬ç”¨ Go æ‰©å±•å®ç°äº† basic authï¼Œä½“éªŒäº† Go æ‰©å±•ä» Envoy æ¥å—é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;åªæ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œæ˜¯æƒ³å¤ç”¨ Envoy åŸæœ‰çš„ xDS é…ç½®æ¨é€é€šé“ï¼Œè¿™ä¸ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä½“éªŒä¸€ç•ªï¼Œäº‘åŸç”Ÿçš„é…ç½®å˜æ›´ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å‰æå‡†å¤‡&#34;&gt;å‰æå‡†å¤‡&lt;/h2&gt;
&lt;p&gt;è¿™æ¬¡æˆ‘ä»¬éœ€è¦ä¸€å¥— k8s ç¯å¢ƒï¼Œå¦‚æœä½ æ‰‹å¤´æ²¡æœ‰ï¼Œæ¨èä½¿ç”¨ kind å®‰è£…ä¸€å¥—ã€‚å…·ä½“å®‰è£…æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å®‰è£…-istio&#34;&gt;å®‰è£… Istio&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬ç›´æ¥å®‰è£…æœ€æ–°ç‰ˆçš„ Istioï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½æœ€æ–°ç‰ˆçš„ istioctl
$ export ISTIO_VERSION=1.18.0-alpha.0
$ curl -L https://istio.io/downloadIstio | sh -

# å°† istioctl åŠ å…¥ PATH
$ cd istio-$ISTIO_VERSION/
$ export PATH=$PATH:$(pwd)/bin

# å®‰è£…ï¼ŒåŒ…æ‹¬ istiod å’Œ ingressgateway
$ istioctl install
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ˜¯çš„ï¼Œç”±äº Go æ‰©å±•å·²ç»è´¡çŒ®ç»™äº†ä¸Šæ¸¸å®˜æ–¹ï¼ŒIstiodï¼ˆpilotï¼‰å’Œ ingressgateway éƒ½å·²ç»é»˜è®¤å¼€å¯äº† Go æ‰©å±•ï¼Œå¹¶ä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚&lt;/p&gt;
&lt;h2 id=&#34;istio-é…ç½®-ingress&#34;&gt;Istio é…ç½® Ingress&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆç”¨ Istio å®Œæˆæ ‡å‡†çš„ Ingress åœºæ™¯é…ç½®ï¼Œå…·ä½“å¯ä»¥çœ‹ &lt;a href=&#34;https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/&#34;&gt;istio çš„å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;é…ç½®å¥½äº†ä¹‹åï¼Œç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ curl -s -I -HHost:httpbin.example.com &amp;quot;http://$INGRESS_HOST:$INGRESS_PORT/status/200&amp;quot;
HTTP/1.1 200 OK
server: istio-envoy
date: Fri, 10 Mar 2023 15:49:37 GMT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;åŸºæœ¬çš„ Ingress å·²ç»è·‘èµ·æ¥äº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æŒ‚è½½-golang-so&#34;&gt;æŒ‚è½½ Golang so&lt;/h2&gt;
&lt;p&gt;ä¹‹å‰æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒGo æ‰©å±•æ˜¯å•ç‹¬ç¼–è¯‘ä¸º so æ–‡ä»¶çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ so æ–‡ä»¶ï¼ŒæŒ‚è½½åˆ° ingressgateway ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬æŠŠä¸Šæ¬¡ basic auth ç¼–è¯‘å‡ºæ¥çš„ libgolang.soï¼Œé€šè¿‡æœ¬åœ°æ–‡ä»¶æŒ‚è½½è¿›æ¥ã€‚ç®€å•ç‚¹æï¼Œç›´æ¥ edit deployment åŠ äº†è¿™äº›é…ç½®ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ç”³æ˜ä¸€ä¸ª hostPath çš„ volume&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;volumes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;golang-so-basic-auth&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;hostPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;/data/golang-so/example-basic-auth/libgolang.so&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;File&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# æŒ‚è½½è¿›æ¥&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;volumeMounts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;mountPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;/etc/golang/basic-auth.so&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;golang-so-basic-auth&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;readOnly&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;å¼€å¯-basic-auth-è®¤è¯&#34;&gt;å¼€å¯ Basic auth è®¤è¯&lt;/h2&gt;
&lt;p&gt;Istio æä¾›äº† EnvoyFilter CRDï¼Œæ‰€ä»¥ï¼Œç”¨ Istio æ¥é…ç½® Go æ‰©å±•ä¹Ÿæ¯”è¾ƒçš„æ–¹ä¾¿ï¼Œapply è¿™æ®µé…ç½®ï¼Œbasic auth å°±å¼€å¯äº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;networking.istio.io/v1alpha3&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyFilter&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;golang-filter&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;namespace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;istio-system&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;configPatches&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# The first patch adds the lua filter to the listener/http connection manager&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;- &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;applyTo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HTTP_FILTER&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;match&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GATEWAY&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;        &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;filterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;            &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;envoy.filters.network.http_connection_manager&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;            &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;subFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;              &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;envoy.filters.http.router&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;patch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;operation&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;INSERT_BEFORE&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# golang filter specification&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;       &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy.filters.http.golang&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;       &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;typed_config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;@type&amp;#34;: &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;type.googleapis.com/envoy.extensions.filters.http.golang.v3alpha.Config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;example&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;/etc/golang/basic-auth.so&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;plugin_name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;basic-auth&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;plugin_config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;            &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;@type&amp;#34;: &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;type.googleapis.com/xds.type.v3.TypedStruct&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;            &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type_url&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;typexx&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;            &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;              &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;foo&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;              &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bar&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è™½ç„¶æœ‰ç‚¹é•¿ï¼Œä½†æ˜¯ï¼Œä¹Ÿå¾ˆæ˜æ˜¾ï¼Œé…ç½®çš„ç”¨æˆ·åå¯†ç è¿˜æ˜¯ï¼š&lt;code&gt;foo:bar&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ curl -s -I -HHost:httpbin.example.com &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_HOST&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_PORT&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;/status/200&amp;#34;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt; Unauthorized

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# valid foo:bar&lt;/span&gt;
$ curl -s -I -HHost:httpbin.example.com &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_HOST&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_PORT&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;/status/200&amp;#34;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Authorization: basic Zm9vOmJhcg==&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200&lt;/span&gt; OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç¬¦åˆé¢„æœŸã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ”¹ä¸€ä¸‹ EnvoyFilter ä¸­çš„å¯†ç ï¼Œé‡æ–° applyï¼Œå†æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# foo:bar not match the new password&lt;/span&gt;
$ curl -s -I -HHost:httpbin.example.com &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_HOST&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$INGRESS_PORT&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;/status/200&amp;#34;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Authorization: basic Zm9vOmJhcg==&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt; Unauthorized
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ­¤æ—¶çš„ Envoy å¹¶ä¸éœ€è¦é‡å¯ï¼Œæ–°çš„é…ç½®å°±ç«‹å³ç”Ÿæ•ˆäº†ï¼Œäº‘åŸç”Ÿçš„ä½“éªŒå°±æ˜¯è¿™ä¹ˆæºœ~&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;å› ä¸º Go æ‰©å±•å¯ä»¥åˆ©ç”¨ Envoy åŸæœ‰çš„ xDS æ¥æ¥å—é…ç½®ï¼Œæ‰€ä»¥ï¼Œä» Istio æ¨é€é…ç½®ä¹Ÿå˜å¾—å¾ˆé¡ºåˆ©ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¿‡å‘¢ï¼ŒIstio æä¾›çš„ EnvoyFilter CRD åœ¨ä½¿ç”¨ä¸Šï¼Œå…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ &amp;amp; è‡ªç„¶ï¼Œåé¢æˆ‘ä»¬æ‰¾æœºä¼šè¯•è¯• EnvoyGatewayï¼Œçœ‹çœ‹ k8s Gateway API çš„ä½“éªŒå’‹æ ·ã€‚&lt;/p&gt;
&lt;p&gt;è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»ä½“éªŒäº†æ•´ä¸ª Envoy Go çš„å¼€å‘ &amp;amp; ä½¿ç”¨æµç¨‹ï¼Œåœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œäººå‡ Golang çš„èƒŒæ™¯ä¸‹ï¼Œç›¸ä¿¡å¯ä»¥å¾ˆå¥½çš„å®Œæˆç½‘å…³åœºæ™¯çš„å„ç§å®šåˆ¶éœ€æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ä»‹ç»ï¼Œå¦‚ä½•åœ¨ Go æ‰©å±•ä¸­ä½¿ç”¨å¼‚æ­¥åç¨‹ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„ Go è¯­è¨€ï¼Œè€Œä¸æ˜¯åƒ Go Wasm é‚£æ ·ï¼Œåªèƒ½ç”¨é˜‰å‰²ç‰ˆçš„ã€‚&lt;/p&gt;
&lt;p&gt;æ•¬è¯·æœŸå¾… ~&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ— [äºŒ] - Golang æ‰©å±•ä» Envoy æ¥æ”¶é…ç½®</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-2/</link>
      <pubDate>Thu, 09 Mar 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-2/</guid>
      <description>
        
        
        &lt;p&gt;&lt;a href=&#34;https://mosn.io/blog/posts/moe-extend-envoy-using-golang-1/&#34;&gt;ä¸Šä¸€ç¯‡&lt;/a&gt; æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä½“éªŒäº†ç”¨ Golang æ‰©å±• Envoy çš„æé€Ÿä¸Šæ‰‹ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡æˆ‘ä»¬å†é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¥ä½“éªŒ Golang æ‰©å±•çš„ä¸€ä¸ªå¼ºå¤§çš„ç‰¹æ€§ï¼šä» Envoy æ¥æ”¶é…ç½®ã€‚&lt;/p&gt;
&lt;h2 id=&#34;basic-auth&#34;&gt;Basic Auth&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬è¿˜æ˜¯ä»ä¸€ä¸ªå°ç¤ºä¾‹æ¥ä½“éªŒï¼Œè¿™æ¬¡æˆ‘ä»¬å®ç°æ ‡å‡†çš„ basic auth çš„è®¤è¯ï¼Œä¸ä¸Šä¸€æ¬¡ç¤ºä¾‹ä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡è®¤è¯çš„ç”¨æˆ·å¯†ç ä¿¡æ¯ï¼Œéœ€è¦ä» Envoy ä¼ ç»™ Goï¼Œä¸èƒ½åœ¨ Go ä»£ç ä¸­å†™æ­»äº†ã€‚&lt;/p&gt;
&lt;p&gt;å®Œæ•´çš„ä»£ç å¯ä»¥çœ‹ &lt;a href=&#34;https://github.com/doujiang24/envoy-go-filter-example/tree/master/example-basic-auth&#34;&gt;example-basic-auth&lt;/a&gt;ï¼Œä¸‹é¢æˆ‘ä»¬å±•å¼€ä»‹ç»ä¸€ç•ªã€‚&lt;/p&gt;
&lt;h2 id=&#34;è·å–é…ç½®&#34;&gt;è·å–é…ç½®&lt;/h2&gt;
&lt;p&gt;ä¸ºäº†æ›´åŠ çµæ´»ï¼Œåœ¨è®¾è®¡ä¸Šï¼ŒEnvoy ä¼ ç»™ Go çš„é…ç½®æ˜¯ Protobuf çš„ Any ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé…ç½®å†…å®¹å¯¹äº Envoy æ˜¯é€æ˜çš„ï¼Œæˆ‘ä»¬åœ¨ Go ä¾§æ³¨å†Œä¸€ä¸ªè§£æå™¨ï¼Œæ¥å®Œæˆè¿™ä¸ª Any é…ç½®çš„è§£æã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ³¨å†Œ parser
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;http&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RegisterHttpFilterConfigParser&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;parser&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;parser&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Parse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;any&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;anypb&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Any&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;configStruct&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;xds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TypedStruct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;any&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UnmarshalTo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;configStruct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87&#34;&gt;panic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configStruct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Value&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;conf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AsMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;username&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AsMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;password&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conf&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼ŒAny ä¸­çš„ç±»å‹æ˜¯ Envoy å®šä¹‰çš„ TypedStruct ç±»å‹ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ç°æˆçš„ Go pb åº“ã€‚&lt;/p&gt;
&lt;p&gt;å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ä¸ªé…ç½®è§£æï¼Œåªæœ‰åœ¨é¦–æ¬¡åŠ è½½çš„æ—¶å€™éœ€è¦æ‰§è¡Œï¼Œåç»­åœ¨ Go ä½¿ç”¨çš„æ˜¯è§£æåçš„é…ç½®ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è§£æåˆ°ä¸€ä¸ª Go map å¯ä»¥æ‹¥æœ‰æ›´å¥½çš„è¿è¡Œæ—¶æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ—¶ï¼Œç”±äº Envoy çš„é…ç½®ï¼Œä¹Ÿæ˜¯æœ‰å±‚çº§å…³ç³»çš„ï¼Œæ¯”å¦‚ http-filter, virtual host, router, virtual clusters è¿™å››çº§ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒè¿™å››ä¸ªå±‚çº§åŒæ—¶æœ‰é…ç½®ï¼Œåœ¨ Go ä¾§æ¥ç»„ç»‡ mergeã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œè¿™ä¸ªåªæœ‰åœ¨ Go ä¾§æœ‰å¤æ‚çš„ filter ç»„ç»‡é€»è¾‘çš„æ—¶å€™ç”¨å¾—ä¸Šï¼Œåé¢æˆ‘ä»¬åœ¨ MOSN çš„ä¸Šå±‚å°è£…çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°è¿™ç§ç”¨æ³•ï¼Œè¿™é‡Œæš‚æ—¶ä¸åšå±•å¼€ä»‹ç»ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è®¤è¯&#34;&gt;è®¤è¯&lt;/h3&gt;
&lt;p&gt;å…·ä½“çš„ Basic Auth è®¤è¯é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ Go æ ‡å‡† net/http åº“ä¸­çš„ BasicAuth å®ç°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;auth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;authorization&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;no Authorization&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;parseBasicAuth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;auth&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;invalid Authorization format&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;username&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;invalid username or password&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œé¢çš„ &lt;code&gt;parseBasicAuth&lt;/code&gt; å°±æ˜¯ä» net/http åº“ä¸­çš„å®ç°ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å‘¢ã€‚&lt;/p&gt;
&lt;h2 id=&#34;é…ç½®&#34;&gt;é…ç½®&lt;/h2&gt;
&lt;p&gt;ç®€å•èµ·è§ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨æœ¬åœ°æ–‡ä»¶çš„é…ç½®æ–¹å¼ã€‚å¦‚ä¸‹æ˜¯å…³é”®çš„é…ç½®ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;http_filters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;- &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy.filters.http.golang&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;typed_config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;@type&amp;#34;: &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;type.googleapis.com/envoy.extensions.filters.http.golang.v3alpha.Config&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;example&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;/etc/envoy/libgolang.so&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;plugin_name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;basic-auth&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;plugin_config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;        &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;@type&amp;#34;: &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;type.googleapis.com/xds.type.v3.TypedStruct&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;        &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;username&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;foo&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;          &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;bar&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œæˆ‘ä»¬é…ç½®äº†ç”¨æˆ·åå¯†ç ï¼š&lt;code&gt;foo:bar&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;é¢„å‘Šä¸€ä¸‹ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¼šä½“éªŒé€šè¿‡ Istio æ¥æ¨é€é…ç½®ï¼Œä½“ä¼šä¸€ç•ªåŠ¨æ€æ›´æ–°é…ç½®çš„å…¨æµç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h2&gt;
&lt;p&gt;ç¼–è¯‘ï¼Œè¿è¡Œï¼Œè·Ÿä¸Šç¯‡ä¸€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ Envoy å®˜æ–¹æä¾›çš„é•œåƒå³å¯ã€‚&lt;/p&gt;
&lt;p&gt;è·‘èµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ curl -s -I &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;http://localhost:10000/&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt; Unauthorized

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# invalid username:password&lt;/span&gt;
$ curl -s -I &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;http://localhost:10000/&amp;#39;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Authorization: basic invalid&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;401&lt;/span&gt; Unauthorized

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# valid foo:bar&lt;/span&gt;
$ curl -s -I &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;http://localhost:10000/&amp;#39;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Authorization: basic Zm9vOmJhcg==&amp;#39;&lt;/span&gt;
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200&lt;/span&gt; OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Œä¸€ä¸ªæ ‡å‡†çš„ basic-auth æ‰©å±•å°±å®Œæˆäº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;Envoy æ˜¯é¢å‘äº‘åŸç”Ÿçš„æ¶æ„è®¾è®¡ï¼Œæä¾›äº†é…ç½®åŠ¨æ€å˜æ›´çš„æœºåˆ¶ï¼ŒGo æ‰©å±•å¯ä»¥ä» Envoy æ¥å—é…ç½®ï¼Œä¹Ÿå°±æ„å‘³ç€ Go æ‰©å±•ä¹Ÿå¯ä»¥å¾ˆå¥½çš„åˆ©ç”¨è¿™å¥—æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;Go æ‰©å±•çš„å¼€å‘è€…ï¼Œä¸éœ€è¦å…³å¿ƒé…ç½®çš„åŠ¨æ€æ›´æ–°ï¼Œåªéœ€è¦è§£æé…ç½®å³å¯ï¼Œéå¸¸çš„æ–¹ä¾¿~&lt;/p&gt;
&lt;p&gt;ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¼šä»‹ç»ï¼Œé…åˆ Istio æ¥åŠ¨æ€æ›´æ–°ç”¨æˆ·åå¯†ç ï¼Œä½“éªŒä¸€ç•ªäº‘åŸç”Ÿçš„é…ç½®å˜æ›´ä½“éªŒã€‚&lt;/p&gt;
&lt;p&gt;åç»­è¿˜æœ‰æ›´å¤š Golang æ‰©å±•çš„ç‰¹æ€§ä»‹ç»ï¼ŒåŸç†è§£æï¼Œä»¥åŠï¼Œæ›´ä¸Šå±‚çš„ MOSN é›†æˆä½“éªŒï¼Œæ¬¢è¿æŒç»­å…³æ³¨ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MoE ç³»åˆ— - å¦‚ä½•ä½¿ç”¨ Golang æ‰©å±• Envoy [ä¸€]</title>
      <link>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-1/</link>
      <pubDate>Mon, 27 Feb 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/moe-extend-envoy-using-golang-1/</guid>
      <description>
        
        
        &lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;MoEï¼ŒMOSN on Envoy æ˜¯ MOSN å›¢é˜Ÿæå‡ºçš„æŠ€æœ¯æ¶æ„ï¼Œç»è¿‡è¿‘ä¸¤å¹´çš„å‘å±•ï¼Œåœ¨èš‚èšå†…éƒ¨å·²ç»å¾—åˆ°äº†å¾ˆå¥½çš„éªŒè¯ï¼›å¹¶ä¸”å»å¹´æˆ‘ä»¬ä¹Ÿå°†åº•å±‚çš„ Envoy Go ä¸ƒå±‚æ‰©å±•è´¡çŒ®äº† Envoy å®˜æ–¹ï¼ŒMOSN ä¹Ÿåˆæ­¥æ”¯æŒäº†ä½¿ç”¨ Envoy ä½œä¸ºç½‘ç»œåº•åº§çš„èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å‡†å¤‡å†™ä¸€ç³»åˆ—çš„æ–‡ç« ï¼Œé€ä¸€ä»‹ç»è¿™é‡Œé¢çš„æŠ€æœ¯ï¼Œæœ¬æ–‡æ˜¯å¼€ç¯‡ï¼Œé‡ç‚¹ä»‹ç» MoE ä¸­çš„åŸºç¡€æŠ€æœ¯ï¼ŒEnvoy Go æ‰©å±•ã€‚&lt;/p&gt;
&lt;h2 id=&#34;faq&#34;&gt;FAQ&lt;/h2&gt;
&lt;p&gt;å¼€å§‹å‰ï¼Œå…ˆå›ç­”å‡ ä¸ªåŸºæœ¬çš„é—®é¢˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;MoE ä¸ Envoy Go æ‰©å±•çš„åŒºåˆ«&lt;/p&gt;
&lt;p&gt;MoE æ˜¯æŠ€æœ¯æ¶æ„ï¼ŒEnvoy Go æ‰©å±•æ˜¯è¿æ¥ MOSN å’Œ Envoy çš„åŸºç¡€æŠ€æœ¯&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Envoy Go æ‰©å±•ï¼Œä¸ç”¨ Go æ¥ç¼–è¯‘ Wasm æœ‰ä»€ä¹ˆåŒºåˆ«&lt;/p&gt;
&lt;p&gt;Envoy Go æ”¯æŒ Go è¯­è¨€çš„æ‰€æœ‰ç‰¹æ€§ï¼ŒåŒ…æ‹¬ Goroutineï¼ŒGo Wasm åˆ™åªèƒ½ä½¿ç”¨å°‘é‡çš„ Go è¯­è¨€ç‰¹æ€§ï¼Œå°¤å…¶æ˜¯æ²¡æœ‰ Goroutine çš„æ”¯æŒ&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Go æ˜¯é™æ€é“¾æ¥åˆ° Envoy ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;ä¸æ˜¯çš„ï¼ŒGo æ‰©å±•ç¼–è¯‘æˆä¸º soï¼ŒEnvoy åŠ¨æ€åŠ è½½ soï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ Envoy&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Envoy Go æ”¯æŒæµå¼å¤„ç†ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ”¯æŒçš„ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äº Go æ‰©å±•æä¾›çš„æ˜¯åº•å±‚çš„ APIï¼Œéå¸¸çš„çµæ´»ï¼Œä½¿ç”¨ä¸Šç›¸å¯¹ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼›å¦‚æœåªæƒ³ç®€å•çš„ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ MOSN çš„ filterï¼Œåé¢æˆ‘ä»¬ä¹Ÿä¼šä»‹ç»ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;éœ€æ±‚&#34;&gt;éœ€æ±‚&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªå°éœ€æ±‚ï¼Œæ¥å®é™…ä½“ä¼šä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;å¯¹è¯·æ±‚éœ€è¦è¿›è¡ŒéªŒç­¾ï¼Œå¤§è‡´æ˜¯ä» URI ä¸Šçš„æŸäº›å‚æ•°ï¼Œä»¥åŠç§é’¥è®¡ç®—ä¸€ä¸ª &lt;code&gt;token&lt;/code&gt;ï¼Œç„¶åå’Œ header ä¸­çš„ &lt;code&gt;token&lt;/code&gt; è¿›è¡Œå¯¹æ¯”ï¼Œå¯¹ä¸ä¸Šå°±è¿”å› 403ã€‚&lt;/p&gt;
&lt;p&gt;å¾ˆç®€å•çš„éœ€æ±‚ï¼Œä»…ä»…ä½œä¸ºç¤ºä¾‹ï¼Œä¸»è¦æ˜¯ä½“éªŒä¸€ä¸‹è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä»£ç å®ç°&#34;&gt;ä»£ç å®ç°&lt;/h2&gt;
&lt;p&gt;å®Œæ•´çš„ä»£ç å¯ä»¥çœ‹ &lt;a href=&#34;https://github.com/doujiang24/envoy-go-filter-example/tree/master/example-1&#34;&gt;envoy-go-filter-example&lt;/a&gt; è¿™ä¸ªä»“åº“&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæ‘˜å½•æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªå‡½æ•°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;secretKey&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;secret&amp;#34;&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;token&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;token&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;missing token&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;:path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;hash&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;md5&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;secretKey&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EncodeToString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hash&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[:])&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;invalid token&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DecodeHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StatusType&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;msg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;callbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SendLocalReply&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;403&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;msg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;bad-request&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LocalReply&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Continue&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;DecodeHeaders&lt;/code&gt; æ˜¯æ‰©å±• &lt;code&gt;filter&lt;/code&gt; å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå¯¹è¯·æ±‚ &lt;code&gt;header&lt;/code&gt; è¿›è¡Œæ ¡éªŒã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;verfiy&lt;/code&gt; æ˜¯æ ¡éªŒå‡½æ•°ï¼Œè¿™é‡Œçš„ &lt;code&gt;RequestHeaderMap&lt;/code&gt; æ˜¯ Go æ‰©å±•æä¾›çš„ &lt;code&gt;interface&lt;/code&gt;ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¯»å†™ headerï¼Œå…¶ä»–éƒ½æ˜¯å¸¸è§çš„ Go ä»£ç å†™æ³•ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ç¼–è¯‘&#34;&gt;ç¼–è¯‘&lt;/h2&gt;
&lt;p&gt;ç¼–è¯‘å¾ˆç®€å•ï¼Œä¸å¸¸è§çš„ Go ç¼–è¯‘ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Golang å®˜æ–¹çš„ docker é•œåƒæ¥ç¼–è¯‘ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;docker run --rm -v &lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;pwd&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;:/go/src/go-filter -w /go/src/go-filter &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        -e &lt;span style=&#34;color:#000&#34;&gt;GOPROXY&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https://goproxy.cn &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        golang:1.19.8 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        go build -v -o libgolang.so -buildmode&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;c-shared .
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Go ç¼–è¯‘è¿˜æ˜¯å¾ˆå¿«çš„ï¼Œåªéœ€è¦å‡ ç§’é’Ÿï¼Œå½“å‰ç›®å½•ä¸‹ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ª libgolang.so çš„æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;åè§‚ Envoy çš„ç¼–è¯‘é€Ÿåº¦ï¼Œä¸€æ¬¡å…¨é‡ç¼–è¯‘ï¼ŒåŠ¨è¾„å‡ ååˆ†é’Ÿï¼Œä¸Šå°æ—¶çš„ï¼Œè¿™å¹¸ç¦æ„Ÿæå‡äº†ä¸æ­¢ä¸€ä¸ªæ¡£æ¬¡ã€‚&lt;/p&gt;
&lt;h2 id=&#34;è¿è¡Œ&#34;&gt;è¿è¡Œ&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Envoy å®˜æ–¹æä¾›çš„é•œåƒæ¥è¿è¡Œï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;docker run --rm -v &lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;pwd&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;/envoy.yaml:/etc/envoy/envoy.yaml &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        -v &lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;pwd&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;`&lt;/span&gt;/libgolang.so:/etc/envoy/libgolang.so &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        -p 10000:10000 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        envoyproxy/envoy:contrib-v1.26-latest &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;        envoy -c /etc/envoy/envoy.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åªéœ€è¦æŠŠä¸Šä¸€æ­¥ç¼–è¯‘çš„ &lt;code&gt;libgolang.so&lt;/code&gt; å’Œ &lt;code&gt;envoy.yaml&lt;/code&gt; æŒ‚è½½è¿›å»å°±å¯ä»¥äº†ã€‚&lt;/p&gt;
&lt;p&gt;å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ envoy.yaml é…ç½®ä¸­å¯ç”¨ Go æ‰©å±•ï¼Œå…·ä½“æ˜¯è¿™æ®µé…ç½®ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;http_filters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;  &lt;/span&gt;- &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy.filters.http.golang&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;typed_config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;@type&amp;#34;: &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;type.googleapis.com/envoy.extensions.filters.http.golang.v3alpha.Config&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;example&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;library_path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;/etc/envoy/libgolang.so&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;plugin_name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;example-1&lt;/span&gt;&lt;span style=&#34;color:#f8f8f8;text-decoration:underline&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è·‘èµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ curl &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;http://localhost:10000/&amp;#39;&lt;/span&gt;
missing token

$ curl -s &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;http://localhost:10000/&amp;#39;&lt;/span&gt; -H &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;token: c64319d06364528120a9f96af62ea83d&amp;#39;&lt;/span&gt; -I
HTTP/1.1 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200&lt;/span&gt; OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç¬¦åˆæœŸæœ›ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢&lt;/p&gt;
&lt;h2 id=&#34;åç»­&#34;&gt;åç»­&lt;/h2&gt;
&lt;p&gt;ä»€ä¹ˆï¼Ÿè¿™ä¸ªç¤ºä¾‹å¤ªç®€å•ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ˜¯çš„ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä½“éªŒä¸‹å¼€å‘æµç¨‹ï¼Œä¸‹ç¯‡æˆ‘ä»¬å†ä»‹ç»æ›´é«˜çº§çš„ç©æ³•ï¼š&lt;/p&gt;
&lt;p&gt;Go æ¥å—æ¥è‡ª Envoy ä¾§çš„é…ç½®ï¼Œå¼‚æ­¥ Goroutineï¼Œä»¥åŠä¸ Istio é…åˆçš„ç”¨æ³•ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: æ„å»º subset ä¼˜åŒ–</title>
      <link>https://mosn.io/blog/posts/mosn-optimize-build-subset/</link>
      <pubDate>Thu, 12 May 2022 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-optimize-build-subset/</guid>
      <description>
        
        
        &lt;h1 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h1&gt;
&lt;p&gt;â€‹        MOSN ä½¿ç”¨äº† subset ç®—æ³•ä½œä¸ºå…¶æ ‡ç­¾åŒ¹é…è·¯ç”±è´Ÿè½½å‡è¡¡çš„æ–¹å¼ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» Subset çš„åŸç†ï¼ŒåŒæ—¶åœ¨è¶…å¤§è§„æ¨¡é›†ç¾¤ä¸‹MOSNçš„ subset æ‰€é‡åˆ°çš„ä¸€äº›æ€§èƒ½ç“¶é¢ˆä¸ä¼˜åŒ–ç®—æ³•ã€‚&lt;/p&gt;
&lt;h1 id=&#34;subset-åŸºæœ¬åŸç†&#34;&gt;Subset åŸºæœ¬åŸç†&lt;/h1&gt;
&lt;p&gt;â€‹        åœ¨ä¸€ä¸ªé›†ç¾¤é‡Œï¼Œé€šå¸¸æœºå™¨ä¼šæœ‰ä¸åŒçš„æ ‡ç­¾ï¼Œå¦‚ä½•å°†ä¸€ä¸ªè¯·æ±‚è·¯ç”±åˆ°æŒ‡å®šæ ‡ç­¾çš„ä¸€ç»„æœºå™¨å‘¢ï¼ŸMOSN æŠŠä¸€ä¸ªæœåŠ¡ä¸‹çš„æœºå™¨æŒ‰ç…§æœºæ ‡ç­¾ç»„åˆè¿›è¡Œé¢„å…ˆåˆ†ç»„æˆå¤šä¸ªå­é›†ï¼Œåœ¨è¯·æ±‚çš„æ—¶å€™ï¼Œæ ¹æ®è¯·æ±‚ä¸­çš„metadataä¿¡æ¯å¯ä»¥å¿«é€ŸæŸ¥è¯¢åˆ°è¿™ä¸ªè¯·æ±‚åº”è¯¥åŒ¹é…åˆ°å“ªä¸ªå­é›†ã€‚&lt;/p&gt;
&lt;p&gt;å½“å‰æœ‰4ä¸ªèŠ‚ç‚¹&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:{&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:{&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:{&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h4&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:{&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ ‡ç­¾åŒ¹é…è§„åˆ™ä¼šæ ¹æ® &lt;code&gt;zone&lt;/code&gt; ã€&lt;code&gt;mosn_aig&lt;/code&gt; ã€&lt;code&gt;mosn_version&lt;/code&gt; è¿™ 3 ä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…è·¯ç”±ï¼Œæ ¹æ®è¿™3ä¸ªkeyæ’åºåè¿›è¡Œç»„åˆå¾—åˆ°ä»¥ä¸‹åŒ¹é…è·¯å¾„&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[zone]
[mosn_version]
[mosn_version, zone]
[mosn_aig]
[mosn_aig, zone]
[mosn_aig, mosn_version]
[mosn_aig, mosn_version, zone]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç›¸å¯¹åº”çš„åŒ¹é…æ ‘å¦‚ä¸‹&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512103935695.png&#34; alt=&#34;image-20220512103935695&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‡è®¾éœ€è¦è®¿é—® &lt;code&gt;{zone: zone1, mosn_aig: aig1}&lt;/code&gt; ,   é‚£ä¹ˆç»è¿‡æ’åºåæŸ¥æ‰¾é¡ºåºä¸º &lt;code&gt;mosn_aig:aig1 -&amp;gt; zone:zone1&lt;/code&gt; , æŸ¥æ‰¾åˆ° &lt;code&gt;[h1, h2]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ä»¥ä¸Šå°±æ˜¯subsetçš„åŸºæœ¬åŸç†&lt;/p&gt;
&lt;h1 id=&#34;subset-æ„å»º&#34;&gt;Subset æ„å»º&lt;/h1&gt;
&lt;p&gt;é‚£ä¹ˆå¦‚ä½•æ„å»ºä¸Šè¿°çš„åŒ¹é…æ ‘å‘¢ï¼Ÿé¦–å…ˆè¾“å…¥å‚æ•°æœ‰ä¸¤ä¸ª&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å¸¦æ ‡ç­¾çš„æœºå™¨åˆ—è¡¨hostsï¼Œæ¯”å¦‚ &lt;code&gt;[h1, h2, h3, h4]&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç”¨äºåŒ¹é…çš„subSetKeys,  æ¯”å¦‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[zone]
[mosn_version]
[mosn_version, zone]
[mosn_aig]
[mosn_aig, zone]
[mosn_aig, mosn_version]
[mosn_aig, mosn_version, zone]
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æˆ‘ä»¬é˜…è¯»æºç çœ‹ä¸€ä¸‹MOSNçš„subsetLoadbalanceræ˜¯å¦‚ä½•æ„å»ºè¿™æ£µæ ‘&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512105932838.png&#34; alt=&#34;image-20220512105932838&#34;&gt;&lt;/p&gt;
&lt;p&gt;MOSNéå†æ¯ä¸€ä¸ª Hostçš„labels å’Œ SubsetKey é€’å½’å»åˆ›å»ºä¸€æ£µæ ‘&lt;/p&gt;
&lt;p&gt;å¯¹äºæ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½ä¼šéå†ä¸€æ¬¡hostsåˆ—è¡¨è¿‡æ»¤å‡ºåŒ¹é…è¿™ä¸ªèŠ‚ç‚¹çš„kvsçš„subHostsï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå­ loadbalancer&lt;/p&gt;
&lt;h1 id=&#34;æ„å»º-profile&#34;&gt;æ„å»º profile&lt;/h1&gt;
&lt;p&gt;åœ¨ç”Ÿäº§çš„è¶…å¤§é›†ç¾¤ï¼Œæˆ‘ä»¬å‘ç°MOSNåœ¨æ¥æ”¶åˆ°æ³¨å†Œä¸­å¿ƒçš„æœºå™¨åˆ—è¡¨æ¨é€çš„æ—¶å€™ï¼Œå‡ºç°äº†è¾ƒé«˜çš„cpuæ¯›åˆºï¼ŒçŸ­æš‚çš„å†…å­˜å‡ºç°äº†ä¸Šæ¶¨ï¼Œgcé¢‘ç‡ä¹Ÿå¤§å¹…åº¦å¢åŠ ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡å¯¹ç”Ÿäº§çš„profileï¼Œæˆ‘ä»¬å‘ç° subsetLoadbalancer çš„ createSubsets åœ¨cpuå’Œallocçš„ç«ç„°å›¾ä¸­éƒ½å æ¯”è¾ƒé«˜ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬å¼€å§‹ç¼–å†™benchmarkä¼˜åŒ–è¿™ä¸€éƒ¨åˆ†çš„æ€§èƒ½&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çš„è¾“å…¥å‚æ•°ä¸ºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;subsetKeys&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;benchSubsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LBSubsetConfig&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LBSubsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;SubsetSelectors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[][]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;8000ä¸ª hosts&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯ä¸ª hosts éƒ½æœ‰4ä¸ªlabel, æ¯ä¸ªlabel 3 ç§value&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;BenchmarkSubsetLoadBalancer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;B&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;ps&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;createHostset&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;benchHostConfigs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;8000&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;subsetConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;benchSubsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Run&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;subsetLoadBalancer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;B&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;N&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;newSubsetLoadBalancer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoundRobin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ps&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newClusterStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;BenchmarkSubsetLoadBalancer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewLBSubsetInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;subsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;cpu&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512113149406.png&#34; alt=&#34;image-20220512113149406&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;alloc_space&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512113230938.png&#34; alt=&#34;image-20220512113230938&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä»ä¸Šé¢çš„ç«ç„°å›¾å¯ä»¥çœ‹åˆ°HostMatcheså’ŒsetFinalHost å è¾ƒå¤šçš„cpu_time å’Œ alloc_space&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;hostmatches-code.png&#34; alt=&#34;hostmatches-code&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;setFinalHost-code.png&#34; alt=&#34;setFinalHost-code&#34;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹&lt;code&gt;HostMatches&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512114421389.png&#34; alt=&#34;image-20220512114421389&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä»–çš„ä½œç”¨æ˜¯åˆ¤æ–­ä¸€ä¸ªhostæ˜¯ä¸æ˜¯å®Œå…¨åŒ¹é…ç»™å®šçš„é”®å€¼å¯¹ï¼Œç”¨äºåˆ¤æ–­è¿™ä¸ªhostæœ‰æ²¡æœ‰åŒ¹é…è¿™ä¸ªåŒ¹é…æ ‘èŠ‚ç‚¹&lt;/p&gt;
&lt;p&gt;å¼€é”€ä¸»è¦åœ¨äºæ‰§è¡Œæ¬¡æ•°è¿‡å¤šï¼š æ ‘èŠ‚ç‚¹æ•° * len(hosts) ã€‚ åœ¨é›†ç¾¤å˜å¤§æ—¶ï¼Œè¿™è¾¹çš„è¿è¡Œå¼€é”€ä¼šå¤§å¹…åº¦ä¸Šå‡ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹  &lt;code&gt;setFinalHost&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20220512114109280.png&#34; alt=&#34;image-20220512114109280&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä»–çš„ä¸»è¦é€»è¾‘æ˜¯æŒ‰IPè¿›è¡Œå»é‡ï¼ŒåŒæ—¶ä¼šé™„å¸¦copyã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæˆ‘ä»¬åœ¨subsetLoadbalancerçš„é¡¶å±‚è¿›è¡Œå»é‡ï¼Œé‚£ä¹ˆä»–çš„ä»»æ„subsetéƒ½ä¸éœ€è¦å†æ¬¡å»é‡çš„ï¼Œå› æ­¤è¿™è¾¹å¯ä»¥æ”¹æˆä¸å»é‡&lt;/p&gt;
&lt;h1 id=&#34;æ„å»ºä¼˜åŒ–&#34;&gt;æ„å»ºä¼˜åŒ–&lt;/h1&gt;
&lt;p&gt;HostMatchesçš„é‚£ä¹ˆå¤šæ¬¡åŒ¹é…ä¸­ï¼Œå®é™…ä¸Šæœ‰å¾ˆå¤šçš„é‡å¤æ“ä½œï¼Œå¯¹host labelä¸­æŸä¸ªkvåˆ¤æ–­equalsï¼Œåœ¨æ„å»ºè¿‡ç¨‹ä¸­é‡å¤äº†ç›¸å½“å¤šçš„æ¬¡æ•°ï¼Œä¼˜åŒ–çš„æ€è·¯å¯ä»¥åŸºäºé¿å…è¿™éƒ¨åˆ†é‡å¤çš„å¼€é”€ï¼Œé¢„å…ˆæ„å»ºå€’æ’ç´¢å¼•å‡ºå‘ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¾“å…¥å‚æ•°&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;subsetKeys&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}]&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;hosts&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;m1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig_none&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;hostname&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;h3&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;metadata&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
         &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;m1&amp;#34;&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;éå†ä¸€æ¬¡ hosts é’ˆå¯¹æ¯ä¸ªkvæˆ‘ä»¬ç”¨bitmapæ„å»ºå€’æ’ç´¢å¼•&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bitmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;110&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;zone2&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bitmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;001&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;physics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;m1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bitmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;101&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_aig&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;aig_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bitmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;111&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_version&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;version_none&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bitmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;111&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;æ ¹æ®subsetKeyså’Œå€’æ’ç´¢å¼•ä¸­çš„kvsï¼Œæ„å»ºå‡ºåŒ¹é…æ ‘ï¼Œå› ä¸ºç´¢å¼•ä¸­æ˜¯å»é‡çš„ä¸hostsæ•°ç›®æ— å…³ï¼Œè¿™ä¸ªæ“ä½œå¼€é”€å æ¯”å¾ˆä½&lt;/li&gt;
&lt;li&gt;å¯¹äºæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œåˆ©ç”¨å€’æ’ç´¢å¼•ä¸­çš„bitmapåšäº¤é›†å¿«é€Ÿå¾—åˆ°åŒ¹é…å…¨éƒ¨kvçš„hostsçš„ç´¢å¼•bitmap&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨Bitmapä¸­å­˜å‚¨çš„indexä»hostsä¸­å–å‡ºå¯¹åº”subHostsæ„å»ºå­loadbalancerï¼ŒåŒæ—¶æ­¤å¤„ä¸éœ€è¦ä½¿ç”¨setFinalHostsè¿›è¡Œå»é‡&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åŸºäºä¸Šè¿°æ€è·¯è¿‡ç¨‹å¼€å‘æ–°çš„subset preIndex æ„å»ºç®—æ³•ï¼Œä»£ç å‚è€ƒ &lt;a href=&#34;https://github.com/mosn/mosn/pull/2010&#34;&gt;https://github.com/mosn/mosn/pull/2010&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ·»åŠ benchmarkè¿›è¡Œæµ‹è¯•&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;BenchmarkSubsetLoadBalancer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;B&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;ps&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;createHostset&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;benchHostConfigs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;8000&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;subsetConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;benchSubsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Run&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;subsetLoadBalancer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;B&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;N&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;newSubsetLoadBalancer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoundRobin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ps&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newClusterStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;BenchmarkSubsetLoadBalancer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewLBSubsetInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;subsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Run&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;subsetLoadBalancerPreIndex&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;B&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;N&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;newSubsetLoadBalancerPreIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoundRobin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ps&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newClusterStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;BenchmarkSubsetLoadBalancer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewLBSubsetInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;subsetConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt; dzdx@B-QBDRMD6M-0201 î‚° ~/Documents/mosn-open/pkg/upstream/cluster î‚° î‚  perf/subsetlb Â±âœš î‚° go &lt;span style=&#34;color:#204a87&#34;&gt;test&lt;/span&gt; -bench&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;^BenchmarkSubsetLoadBalancer . -run&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;^$ -benchmem 
2022-04-14 18:55:42,662 &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;network&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt; register pool factory&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; register protocol: mock factory
goos: darwin
goarch: amd64
pkg: mosn.io/mosn/pkg/upstream/cluster
BenchmarkSubsetLoadBalancer/subsetLoadBalancer-12                      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;9&lt;/span&gt;         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;118816550&lt;/span&gt; ns/op        &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10105291&lt;/span&gt; B/op       &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;7217&lt;/span&gt; allocs/op
BenchmarkSubsetLoadBalancer/subsetLoadBalancerPreIndex-12            &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;246&lt;/span&gt;           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5452478&lt;/span&gt; ns/op         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2427298&lt;/span&gt; B/op      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;11463&lt;/span&gt; allocs/op
PASS
ok      mosn.io/mosn/pkg/upstream/cluster       4.993s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;163155137-c6b72ed7-6cf3-4043-b257-ec989d8f216b.png&#34; alt=&#34;163155137-c6b72ed7-6cf3-4043-b257-ec989d8f216b&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ç›¸å¯¹äºä¹‹å‰çš„æ„å»ºæ–¹å¼ï¼Œæ„å»ºé€Ÿåº¦å¿«äº†20å€ï¼Œalloc_space å‡å°äº†75%ï¼Œ allocæ¬¡æ•°å°‘é‡ä¸Šå‡ï¼Œå› ä¸ºéœ€è¦é¢å¤–æ„å»ºä¸€æ¬¡å€’æ’ç´¢å¼•ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢è§‚å¯Ÿä¸€ä¸‹gcï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;default:
gc 7 @0.247s 5%: 0.006+16+0.017 ms clock, 0.027+0/15/32+0.070 ms cpu, 48-&amp;gt;49-&amp;gt;34 MB, 50 MB goal, 4 P

preIndex:
gc 7 @0.229s 7%: 0.005+17+0.017 ms clock, 0.021+3.6/17/33+0.069 ms cpu, 44-&amp;gt;46-&amp;gt;33 MB, 45 MB goal, 4 P
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç›¸å¯¹ä¹‹å‰çš„æ„å»ºæ–¹å¼ï¼Œè¿è¡ŒæœŸé—´çš„å†…å­˜æ›´å°ï¼Œcpuå›æ”¶çš„å†…å­˜ä¹Ÿå˜å°‘ï¼Œgcå¹¶è¡Œæ‰«æçš„æ—¶é•¿å°å¹…ä¸Šæ¶¨ï¼ŒSTWæ—¶é—´å˜çŸ­ã€‚&lt;/p&gt;
&lt;p&gt;æµ‹è¯•ä¸€ä¸‹åœ¨ä¸åŒhostsæ•°ç›®ä¸‹çš„ä¼˜åŒ–ç¨‹åº¦ï¼Œå¯ä»¥çœ‹åˆ°åœ¨hostsæ•°ç›®è¾ƒå¤šï¼ˆ&amp;gt;100) ï¼Œ æ–°çš„æ„å»ºç®—æ³•éƒ½ä¼šå¤§å¹…åº¦ä¼˜äºæ—§çš„æ„å»ºç®—æ³•&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;hosts&lt;/th&gt;
&lt;th&gt;cpu (before)&lt;/th&gt;
&lt;th&gt;cpu (after)&lt;/th&gt;
&lt;th&gt;alloc (before)&lt;/th&gt;
&lt;th&gt;alloc (after)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;td&gt;0.23ms&lt;/td&gt;
&lt;td&gt;0.35ms&lt;/td&gt;
&lt;td&gt;65KB&lt;/td&gt;
&lt;td&gt;189KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;td&gt;0.93ms&lt;/td&gt;
&lt;td&gt;0.38ms&lt;/td&gt;
&lt;td&gt;154KB&lt;/td&gt;
&lt;td&gt;214KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;500&lt;/td&gt;
&lt;td&gt;8.1ms&lt;/td&gt;
&lt;td&gt;0.56ms&lt;/td&gt;
&lt;td&gt;632KB&lt;/td&gt;
&lt;td&gt;322KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2000&lt;/td&gt;
&lt;td&gt;27ms&lt;/td&gt;
&lt;td&gt;1.3ms&lt;/td&gt;
&lt;td&gt;2.4MB&lt;/td&gt;
&lt;td&gt;738KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8000&lt;/td&gt;
&lt;td&gt;102ms&lt;/td&gt;
&lt;td&gt;5.1ms&lt;/td&gt;
&lt;td&gt;10MB&lt;/td&gt;
&lt;td&gt;2.4MB&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h1&gt;
&lt;p&gt;é€šè¿‡é¢„å…ˆæ„å»º bitmap å€’æ’ç´¢å¼•åŠ é€Ÿsubsetæ„å»ºï¼Œcpuæœ‰è¶…è¿‡10å€çš„æå‡ï¼Œalloc_spaceä¹Ÿé™ä½äº†æ•°å€ï¼Œgcçš„æ‰«ææ—¶é•¿å°å¹…å¢åŠ ï¼ŒSTWæ—¶é•¿å°å¹…å‡å°‘&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: Holmes åŸç†æµ…æ</title>
      <link>https://mosn.io/blog/posts/mosn-holmes-design/</link>
      <pubDate>Sat, 19 Mar 2022 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-holmes-design/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;å¯¹äºç³»ç»Ÿçš„æ€§èƒ½å°–åˆºé—®é¢˜ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨Goå®˜æ–¹å†…ç½®çš„&lt;code&gt;pprof&lt;/code&gt;åŒ…è¿›è¡Œåˆ†æï¼Œä½†æ˜¯éš¾ç‚¹æ˜¯å¯¹äºä¸€é—ªè€Œè¿‡çš„â€œå°–åˆºâ€ï¼Œ
å¼€å‘äººå‘˜å¾ˆéš¾åŠæ—¶åœ°ä¿å­˜ç°åœºï¼šå½“ä½ æ”¶åˆ°å‘Šè­¦ä¿¡æ¯ï¼Œä»è¢«çªä¸­çˆ¬èµ·æ¥ï¼Œæ‰“å¼€ç”µè„‘ï¼Œé“¾æ¥VPNï¼Œç³»ç»Ÿè¯´ä¸å®šéƒ½å·²ç»é‡å¯ä¸‰å››è¶Ÿäº†ã€‚&lt;/p&gt;
&lt;p&gt;MOSNç¤¾åŒºçš„&lt;a href=&#34;https://github.com/mosn/holmes&#34;&gt;Holmes&lt;/a&gt;æ˜¯ä¸€ä¸ªåŸºäºgolangå®ç°çš„ï¼Œè½»é‡çº§æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œå½“åº”ç”¨çš„æ€§èƒ½æŒ‡æ ‡
å‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨æ—¶ï¼Œ&lt;code&gt;holmes&lt;/code&gt;ä¼šåœ¨ç¬¬ä¸€æ—¶é—´ä¿ç•™ç°åœºï¼Œè®©ä½ ç¬¬äºŒå¤©ä¸Šç­å¯ä»¥ä¸€è¾¹ä»å®¹åœ°å–ç€æ¸æèŒ¶ï¼Œä¸€è¾¹è¿½æŸ¥é—®é¢˜çš„æ ¹å› ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ &lt;code&gt;holmes&lt;/code&gt;å¯¹æ‚¨çš„åº”ç”¨è¿›è¡Œç›‘æ§ï¼Œå¹¶ç®€å•åˆ†æäº†&lt;code&gt;holmes&lt;/code&gt;çš„å®ç°åŸç†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;quick-start&#34;&gt;Quick Start&lt;/h2&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;holmes&lt;/code&gt;çš„æ–¹å¼ååˆ†ç®€å•ï¼Œåªéœ€è¦åœ¨æ‚¨çš„ç³»ç»Ÿåˆå§‹åŒ–é€»è¾‘å†…æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é…ç½®è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithCollectInterval&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;5s&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æŒ‡æ ‡é‡‡é›†æ—¶é—´é—´éš”
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithDumpPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/tmp&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;      &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// profileä¿å­˜è·¯å¾„
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    
        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithCPUDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;25&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;80&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é…ç½®CPUçš„æ€§èƒ½ç›‘æ§è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithMemDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;30&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;25&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;80&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é…ç½®Heap Memory æ€§èƒ½ç›‘æ§è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithGCHeapDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;40&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é…ç½®åŸºäºGCå‘¨æœŸçš„Heap Memory æ€§èƒ½ç›‘æ§è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithGoroutineDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;500&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;25&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20000&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;100&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1000&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é…ç½®Goroutineæ•°é‡çš„ç›‘æ§è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// enable all
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnableCPUDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;EnableGoroutineDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;EnableMemDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;EnableGCHeapDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç±»ä¼¼äº&lt;code&gt;holmes.WithGoroutineDump(min, diff, abs,max,2 * time.Minute)&lt;/code&gt;çš„&lt;code&gt;API&lt;/code&gt;å«ä¹‰ä¸º:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å½“goroutineæŒ‡æ ‡æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå°†ä¼šè§¦å‘dumpæ“ä½œã€‚
&lt;code&gt;current_goroutine_num&lt;/code&gt; &amp;gt; &lt;code&gt;10&lt;/code&gt; &amp;amp;&amp;amp; &lt;code&gt;current_goroutine_num&lt;/code&gt; &amp;lt; &lt;code&gt;100*1000&lt;/code&gt; &amp;amp;&amp;amp;
&lt;code&gt;current_goroutine_num&lt;/code&gt; &amp;gt; &lt;code&gt;125%&lt;/code&gt; * &lt;code&gt;previous_average_goroutine_num&lt;/code&gt; ||&lt;code&gt;current_goroutine_num&lt;/code&gt; &amp;gt; &lt;code&gt;2000&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å½“goroutineæ•°å¤§äº&lt;code&gt;max&lt;/code&gt;æ—¶ï¼Œ&lt;code&gt;holmes&lt;/code&gt;ä¼šè·³è¿‡æœ¬æ¬¡dumpæ“ä½œï¼Œå› ä¸ºå½“&lt;code&gt;goroutine&lt;/code&gt;æ•°è¿‡å¤§æ—¶ï¼Œ&lt;code&gt;goroutine dump&lt;/code&gt;æ“ä½œæˆæœ¬å¾ˆé«˜ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;2 * time.Minute&lt;/code&gt; æ˜¯ä¸¤æ¬¡dumpæ“ä½œä¹‹é—´æœ€å°æ—¶é—´é—´éš”ï¼Œé¿å…é¢‘ç¹profilingå¯¹æ€§èƒ½äº§ç”Ÿçš„å½±å“ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ›´å¤šä½¿ç”¨æ¡ˆä¾‹ç‚¹å‡»&lt;a href=&#34;https://github.com/mosn/holmes/tree/master/example&#34;&gt;è¿™é‡Œ&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;profile-types&#34;&gt;Profile Types&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;holmes&lt;/code&gt;æ”¯æŒä»¥ä¸‹äº”ç§Profileç±»å‹ï¼Œç”¨æˆ·å¯ä»¥æŒ‰éœ€é…ç½®ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mem: å†…å­˜åˆ†é…&lt;/li&gt;
&lt;li&gt;cpu: cpuä½¿ç”¨ç‡&lt;/li&gt;
&lt;li&gt;thread: çº¿ç¨‹æ•°&lt;/li&gt;
&lt;li&gt;goroutine: åç¨‹æ•°&lt;/li&gt;
&lt;li&gt;gcHeap: åŸºäºGCå‘¨æœŸç›‘æ§çš„å†…å­˜åˆ†é…&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æŒ‡æ ‡é‡‡é›†&#34;&gt;æŒ‡æ ‡é‡‡é›†&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;mem&lt;/code&gt;, &lt;code&gt;cpu&lt;/code&gt;, &lt;code&gt;thread&lt;/code&gt;, &lt;code&gt;goroutine&lt;/code&gt;è¿™å››ç§ç±»å‹æ˜¯æ ¹æ®ç”¨æˆ·é…ç½®çš„&lt;code&gt;CollectInterval&lt;/code&gt;,æ¯éš”ä¸€æ®µæ—¶é—´é‡‡é›†ä¸€æ¬¡åº”ç”¨å½“å‰çš„æ€§èƒ½æŒ‡æ ‡ï¼Œ
è€Œ&lt;code&gt;gcHeap&lt;/code&gt;æ—¶åŸºäº&lt;code&gt;GC&lt;/code&gt;å‘¨æœŸé‡‡é›†æ€§èƒ½æŒ‡æ ‡ã€‚æœ¬å°èŠ‚ä¼šåˆ†æä¸€ä¸‹ä¸¤ç§æŒ‡æ ‡ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ ¹æ®collectintervalå‘¨æœŸé‡‡é›†&#34;&gt;æ ¹æ®&lt;code&gt;CollectInterval&lt;/code&gt;å‘¨æœŸé‡‡é›†&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;holmes&lt;/code&gt;æ¯éš”ä¸€æ®µæ—¶é—´é‡‡é›†åº”ç”¨å„é¡¹æŒ‡æ ‡ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå›ºå®šå¤§å°çš„&lt;a href=&#34;https://github.com/mosn/holmes/blob/master/ring.go&#34;&gt;å¾ªç¯é“¾è¡¨&lt;/a&gt;æ¥å­˜å‚¨å®ƒä»¬ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./ring.png&#34; alt=&#34;ring&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ ¹æ®gcå‘¨æœŸé‡‡é›†&#34;&gt;æ ¹æ®&lt;code&gt;GC&lt;/code&gt;å‘¨æœŸé‡‡é›†&lt;/h3&gt;
&lt;p&gt;åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å®šæ—¶çš„&lt;code&gt;memory dump&lt;/code&gt;ä¿ç•™åˆ°ç°åœº, æ¯”å¦‚åº”ç”¨åœ¨ä¸€ä¸ª&lt;code&gt;CollectInterval&lt;/code&gt;å‘¨æœŸå†…åˆ†é…äº†å¤§é‡å†…å­˜ï¼Œ
åˆå¿«é€Ÿå›æ”¶äº†å®ƒä»¬ï¼Œæ­¤æ—¶&lt;code&gt;holmes&lt;/code&gt;åœ¨å‘¨æœŸå‰åçš„é‡‡é›†åˆ°å†…å­˜ä½¿ç”¨ç‡æ²¡æœ‰äº§ç”Ÿè¿‡å¤§æ³¢åŠ¨ï¼Œä¸å®é™…æƒ…å†µä¸ç¬¦ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œholmeså¼€å‘äº†åŸºäºGCå‘¨æœŸçš„
&lt;code&gt;Profile&lt;/code&gt;ç±»å‹ï¼Œå®ƒä¼šåœ¨å †å†…å­˜ä½¿ç”¨ç‡é£™é«˜çš„å‰åä¸¤ä¸ªGCå‘¨æœŸå†…å„&lt;code&gt;dump&lt;/code&gt;ä¸€æ¬¡&lt;code&gt;profile&lt;/code&gt;ï¼Œç„¶åå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨&lt;code&gt;pprof --base&lt;/code&gt;å‘½ä»¤å»å¯¹æ¯”
ä¸¤ä¸ªæ—¶åˆ»å †å†…å­˜ä¹‹é—´çš„å·®å¼‚ã€‚ &lt;a href=&#34;https://uncledou.site/2022/go-pprof-heap/&#34;&gt;å…·ä½“å®ç°ä»‹ç»&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æ ¹æ®&lt;code&gt;GC&lt;/code&gt;å‘¨æœŸé‡‡é›†åˆ°çš„æ•°æ®ä¹Ÿä¼šæ”¾åœ¨å¾ªç¯åˆ—è¡¨ä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&#34;è§„åˆ™åˆ¤æ–­&#34;&gt;è§„åˆ™åˆ¤æ–­&lt;/h2&gt;
&lt;p&gt;æœ¬å°èŠ‚ä»‹ç»&lt;code&gt;holmes&lt;/code&gt;æ˜¯å¦‚ä½•æ ¹æ®è§„åˆ™åˆ¤æ–­ç³»ç»Ÿå‡ºç°å¼‚å¸¸çš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;é˜ˆå€¼å«ä¹‰&#34;&gt;é˜ˆå€¼å«ä¹‰&lt;/h3&gt;
&lt;p&gt;æ¯ä¸ª&lt;code&gt;Profile&lt;/code&gt;éƒ½å¯ä»¥é…ç½®&lt;code&gt;min&lt;/code&gt;,&lt;code&gt;diff&lt;/code&gt;,&lt;code&gt;abs&lt;/code&gt;,&lt;code&gt;coolDown&lt;/code&gt;å››ä¸ªæŒ‡æ ‡ï¼Œå«ä¹‰å¦‚ä¸‹:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å½“å‰æŒ‡æ ‡å°äº&lt;code&gt;min&lt;/code&gt;æ—¶ï¼Œä¸è§†ä¸ºå¼‚å¸¸ã€‚&lt;/li&gt;
&lt;li&gt;å½“å‰æŒ‡æ ‡å¤§äº&lt;code&gt;(100+diff)&lt;/code&gt;*&lt;code&gt;100%&lt;/code&gt;*å†å²æŒ‡æ ‡ï¼Œè¯´æ˜ç³»ç»Ÿæ­¤æ—¶äº§ç”Ÿäº†æ³¢åŠ¨ï¼Œè§†ä¸ºå¼‚å¸¸ã€‚&lt;/li&gt;
&lt;li&gt;å½“å‰æŒ‡æ ‡å¤§äº&lt;code&gt;abs&lt;/code&gt;(ç»å¯¹å€¼)ï¼Œè§†ä¸ºå¼‚å¸¸ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;cpu&lt;/code&gt;å’Œ&lt;code&gt;goroutine&lt;/code&gt;è¿™ä¸¤ä¸ª&lt;code&gt;profile&lt;/code&gt;ç±»å‹æä¾›&lt;code&gt;max&lt;/code&gt;å‚æ•°é…ç½®ï¼ŒåŸºäºä»¥ä¸‹è€ƒè™‘ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cpu&lt;/code&gt; çš„&lt;code&gt;profiling&lt;/code&gt;æ“ä½œå¤§çº¦ä¼šæœ‰&lt;a href=&#34;https://medium.com/google-cloud/continuous-profiling-of-go-programs-96d4416af77b&#34;&gt;5%çš„æ€§èƒ½æŸè€—&lt;/a&gt;ï¼Œ
æ‰€ä»¥å½“åœ¨&lt;code&gt;cpu&lt;/code&gt;è¿‡é«˜æ—¶ï¼Œä¸åº”å½“è¿›è¡Œ&lt;code&gt;profiling&lt;/code&gt;æ“ä½œï¼Œå¦åˆ™ä¼šæ‹–å®ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;li&gt;å½“&lt;code&gt;goroutine&lt;/code&gt;æ•°è¿‡å¤§æ—¶ï¼Œ&lt;code&gt;goroutine dump&lt;/code&gt;æ“ä½œ&lt;a href=&#34;https://github.com/golang/go/issues/33250&#34;&gt;æˆæœ¬å¾ˆé«˜&lt;/a&gt;ï¼Œä¼šè¿›è¡ŒSTWæ“ä½œï¼Œä»è€Œæ‹–å®ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;warming-up&#34;&gt;Warming up&lt;/h3&gt;
&lt;p&gt;å½“&lt;code&gt;holmes&lt;/code&gt;å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®&lt;code&gt;CollectInterval&lt;/code&gt;å‘¨æœŸé‡‡é›†åæ¬¡å„é¡¹æŒ‡æ ‡ï¼Œåœ¨è¿™æœŸé—´å†…é‡‡é›†åˆ°çš„æŒ‡æ ‡åªä¼šå­˜å…¥å¾ªç¯é“¾è¡¨ä¸­ï¼Œä¸ä¼šè¿›è¡Œè§„åˆ™åˆ¤æ–­ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ‰©å±•åŠŸèƒ½&#34;&gt;æ‰©å±•åŠŸèƒ½&lt;/h2&gt;
&lt;p&gt;é™¤äº†åŸºæœ¬çš„ç›‘æ§ä¹‹å¤–ï¼Œ&lt;code&gt;holmes&lt;/code&gt;è¿˜æä¾›äº†ä¸€äº›æ‰©å±•åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;h3 id=&#34;äº‹ä»¶ä¸ŠæŠ¥&#34;&gt;äº‹ä»¶ä¸ŠæŠ¥&lt;/h3&gt;
&lt;p&gt;æ‚¨å¯ä»¥é€šè¿‡å®ç°&lt;code&gt;Reporter&lt;/code&gt; æ¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‘é€å‘Šè­¦ä¿¡æ¯ï¼Œå½“&lt;code&gt;holmes&lt;/code&gt;è§¦å‘&lt;code&gt;Dump&lt;/code&gt;æ“ä½œæ—¶ã€‚&lt;/li&gt;
&lt;li&gt;å°†&lt;code&gt;Profiles&lt;/code&gt;ä¸Šä¼ åˆ°å…¶ä»–åœ°æ–¹ï¼Œä»¥é˜²å®ä¾‹è¢«é”€æ¯ï¼Œä»è€Œå¯¼è‡´profileä¸¢å¤±ï¼Œæˆ–è¿›è¡Œåˆ†æã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ReporterImpl&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReporterImple&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Report&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pType&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reason&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;eventID&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// do something	
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReporterImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// a implement of holmes.ProfileReporter Interface.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    	&lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithProfileReporter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reporter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithDumpPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/tmp&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewFileLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/tmp/holmes.log&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mlog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;INFO&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)),&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithBinaryDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithMemoryLimit&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;100&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1024&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1024&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 100MB
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;holmes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithGCHeapDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;40&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;åŠ¨æ€é…ç½®&#34;&gt;åŠ¨æ€é…ç½®&lt;/h3&gt;
&lt;p&gt;æ‚¨å¯ä»¥é€šè¿‡&lt;code&gt;Set&lt;/code&gt;æ–¹æ³•åœ¨åº”ç”¨è¿è¡Œæ—¶æ›´æ–°holmesçš„é…ç½®ã€‚å®ƒçš„ä½¿ç”¨ååˆ†ç®€å•ï¼Œå’Œåˆå§‹åŒ–æ—¶çš„&lt;code&gt;New&lt;/code&gt;æ–¹æ³•ä¸€æ ·ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰äº›é…ç½®æ—¶ä¸æ”¯æŒåŠ¨æ€æ›´æ”¹çš„ï¼Œæ¯”å¦‚Coreæ•°ï¼Œå¦‚æœåœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´æ›´æ”¹è¿™ä¸ªå‚æ•°ï¼Œä¼šå¯¼è‡´CPUä½¿ç”¨ç‡äº§ç”Ÿå·¨å¤§
æ³¢åŠ¨ï¼Œä»è€Œè§¦å‘Dumpæ“ä½œã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;    &lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Set&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;WithCollectInterval&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;2s&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;WithGoroutineDump&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;50&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;90&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;é…ç½®ä¸­å¿ƒæ”¯æŒ&#34;&gt;é…ç½®ä¸­å¿ƒæ”¯æŒ&lt;/h3&gt;
&lt;p&gt;åˆ©ç”¨&lt;code&gt;Set&lt;/code&gt;æ–¹æ³•ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°å¯¹æ¥è‡ªå·±å…¬å¸çš„é…ç½®ä¸­å¿ƒï¼Œæ¯”å¦‚ï¼Œå°†&lt;code&gt;holmes&lt;/code&gt;ä½œä¸ºæ•°æ®é¢ï¼Œé…ç½®ä¸­å¿ƒä½œä¸ºæ§åˆ¶é¢ã€‚
å¹¶å¯¹æ¥å‘Šè­¦ç³»ç»Ÿ(é‚®ä»¶/çŸ­ä¿¡ç­‰)ï¼Œæ­å»ºä¸€å¥—ç®€å•çš„ç›‘æ§ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“æ¶æ„å¦‚ä¸‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./system.png&#34; alt=&#34;system&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ç®€å•åœ°ä»‹ç»äº†&lt;code&gt;Holmes&lt;/code&gt;çš„ä½¿ç”¨æ–¹æ³•ä¸åŸç†ã€‚å¸Œæœ›&lt;code&gt;holmes&lt;/code&gt;èƒ½åœ¨æ‚¨æé«˜åº”ç”¨çš„ç¨³å®šæ€§æ—¶å¸®åŠ©åˆ°ä½ ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/holmes&#34;&gt;Holmes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://xargin.com/autodumper-for-go/&#34;&gt;æ— äººå€¼å®ˆçš„è‡ªåŠ¨ dump(ä¸€)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://xargin.com/autodumper-for-go-ii/&#34;&gt;æ— äººå€¼å®ˆçš„è‡ªåŠ¨ dump(äºŒ)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://uncledou.site/2022/go-pprof-heap/&#34;&gt;go è¯­è¨€ pprof heap profile å®ç°æœºåˆ¶&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN åå‘é€šé“è¯¦è§£</title>
      <link>https://mosn.io/blog/posts/mosn-tunnel/</link>
      <pubDate>Thu, 17 Feb 2022 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-tunnel/</guid>
      <description>
        
        
        &lt;p&gt;MOSNï¼ˆModular Open Smart Networkï¼‰æ˜¯ä¸€æ¬¾ä¸»è¦ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„äº‘åŸç”Ÿç½‘ç»œä»£ç†å¹³å°ï¼Œç”±èš‚èšé›†å›¢å¼€æºå¹¶ç»è¿‡åŒ11å¤§ä¿ƒå‡ åä¸‡å®¹å™¨çš„ç”Ÿäº§çº§éªŒè¯ï¼Œå…·å¤‡é«˜æ€§èƒ½ã€æ˜“æ‰©å±•çš„ç‰¹ç‚¹ã€‚ MOSN å¯ä»¥å’Œ Istio é›†æˆæ„å»º Service Meshï¼Œä¹Ÿå¯ä»¥ä½œä¸ºç‹¬ç«‹çš„å››ã€ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼ŒAPI Gatewayã€äº‘åŸç”Ÿ Ingress ç­‰ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;mosnçš„åå‘é€šé“å®ç°&#34;&gt;MOSNçš„åå‘é€šé“å®ç°&lt;/h3&gt;
&lt;p&gt;åœ¨äº‘è¾¹ååŒçš„ç½‘ç»œåœºæ™¯ï¼Œé€šå¸¸éƒ½æ˜¯å•å‘ç½‘ç»œï¼Œäº‘ä¾§èŠ‚ç‚¹æ— æ³•ä¸»åŠ¨å‘èµ·è¿æ¥ä¸è¾¹ç¼˜èŠ‚ç‚¹é€šè®¯ã€‚è¿™ç§é™åˆ¶æå¤§ç¨‹åº¦ä¿è¯äº†è¾¹ç¼˜èŠ‚ç‚¹çš„å®‰å…¨ï¼Œä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå³åªå…è®¸è¾¹ç¼˜èŠ‚ç‚¹ä¸»åŠ¨å‘èµ·è®¿é—®äº‘ç«¯èŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;äº‘è¾¹éš§é“æ—¨åœ¨è§£å†³äº‘ç«¯æ— æ³•ä¸»åŠ¨è®¿é—®è¾¹ç¼˜èŠ‚ç‚¹çš„é—®é¢˜ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªåå‘é€šé“ï¼ˆåæ–‡ç»Ÿç§°ä¸ºåå‘é€šé“ï¼‰ã€‚é€šè¿‡åœ¨è¾¹ç¼˜ä¾§ä¸»åŠ¨å‘èµ·å»ºè¿çš„æ–¹å¼ä¸äº‘ç«¯èŠ‚ç‚¹ä¹‹é—´æ„å»ºä¸€æ¡ä¸“ç”¨çš„å…¨åŒå·¥è¿æ¥ï¼Œç”¨æ¥ä¼ è¾“äº‘ç«¯èŠ‚ç‚¹çš„è¯·æ±‚æ•°æ®å’Œå›ä¼ æœ€ç»ˆçš„å“åº”ç»“æœã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰ä¾‹å¦‚SuperEdgeã€Yurttunnelç­‰ä¸šç•ŒçŸ¥åäº‘è¾¹ååŒå¼€æºæ¡†æ¶ï¼Œå¯¹äºäº‘è¾¹é€šä¿¡çš„å®ç°æ–¹æ¡ˆéƒ½åŸºäºåå‘é€šé“ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡å°†ç€é‡ä»‹ç»MOSNä¹‹ä¸Šçš„åå‘é€šé“è¿ä½œæµç¨‹å’ŒåŸç†ã€‚&lt;/p&gt;
&lt;p&gt;æ€»ä½“æ¶æ„å¦‚ä¸‹æ‰€ç¤º(å›¾ä¸­ç®­å¤´è¡¨ç¤ºTCPå»ºè¿åå‘)ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosntunnel.jpg&#34; alt=&#34;mosn tunnel&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ•´ä¸ªè¿ä½œæµç¨‹ç®€å•æ¦‚æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¾¹ç¼˜ä¾§çš„mosnå®ä¾‹ï¼ˆåæ–‡ç»Ÿç§°ä¸ºtunnel agentï¼‰åœ¨å¯åŠ¨æ—¶tunnel agentç›¸å…³æœåŠ¡åç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡æŒ‡å®šçš„é™æ€é…ç½®æˆ–è€…åŠ¨æ€æœåŠ¡å‘ç°æ–¹å¼æ‹¿åˆ°éœ€è¦åå‘å»ºè¿çš„å…¬æœ‰äº‘ä¾§çš„mosn serveråœ°å€åˆ—è¡¨ï¼ˆåæ–‡ç»Ÿç§°tunnel serverï¼‰ï¼Œå¹¶ä¸”å»ºç«‹åå‘è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;äº‘ä¾§çš„Frontendä¸tunnel serverä¾§çš„è½¬å‘ç«¯å£è¿›è¡Œæ•°æ®äº¤äº’ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¼šè¢«æ‰˜ç®¡åˆ°ä¹‹å‰å»ºç«‹çš„åå‘è¿æ¥è¿›è¡Œå‘é€ã€‚&lt;/li&gt;
&lt;li&gt;è¾¹ç¼˜èŠ‚ç‚¹æ¥å—åˆ°è¯·æ±‚ä¹‹åï¼Œå†å°†è¯·æ±‚è½¬å‘ç»™å®é™…çš„åç«¯ç›®æ ‡èŠ‚ç‚¹ï¼Œå›åŒ…è¿‡ç¨‹åˆ™åŸè·¯è¿”å›ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;åå‘é€šé“å¯åŠ¨è¿‡ç¨‹&#34;&gt;åå‘é€šé“å¯åŠ¨è¿‡ç¨‹&lt;/h3&gt;
&lt;p&gt;MOSN Agenté€šè¿‡ExtendConfigç‰¹æ€§ï¼Œåœ¨MOSNå¯åŠ¨æ—¶åŠ è½½å’Œå®Œæˆåˆå§‹åŒ–Tunnel Agentçš„å·¥ä½œã€‚&lt;/p&gt;
&lt;p&gt;ExtendConfigä¸­å®šä¹‰AgentBootstrapConfigç»“æ„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;type AgentBootstrapConfig struct {
	Enable bool `json:&amp;quot;enable&amp;quot;`
	// The number of connections established between the agent and each server
	ConnectionNum int `json:&amp;quot;connection_num&amp;quot;`
	// The cluster of remote server
	Cluster string `json:&amp;quot;cluster&amp;quot;`
	// After the connection is established, the data transmission is processed by this listener
	HostingListener string `json:&amp;quot;hosting_listener&amp;quot;`
	// Static remote server list
	StaticServerList []string `json:&amp;quot;server_list&amp;quot;`

	// DynamicServerListConfig is used to specify dynamic server configuration
	DynamicServerListConfig struct {
		DynamicServerLister string `json:&amp;quot;dynamic_server_lister&amp;quot;`
	}

	// ConnectRetryTimes
	ConnectRetryTimes int `json:&amp;quot;connect_retry_times&amp;quot;`
	// ReconnectBaseDuration
	ReconnectBaseDurationMs int `json:&amp;quot;reconnect_base_duration_ms&amp;quot;`

	// ConnectTimeoutDurationMs specifies the timeout for establishing a connection and initializing the agent
	ConnectTimeoutDurationMs int    `json:&amp;quot;connect_timeout_duration_ms&amp;quot;`
	CredentialPolicy         string `json:&amp;quot;credential_policy&amp;quot;`
	// GracefulCloseMaxWaitDurationMs specifies the maximum waiting time to close conn gracefully
	GracefulCloseMaxWaitDurationMs int `json:&amp;quot;graceful_close_max_wait_duration_ms&amp;quot;`

	TLSContext *v2.TLSConfig `json:&amp;quot;tls_context&amp;quot;`
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ConnectionNumï¼štunnel agentå’Œæ¯ä¸ªtunnel serverå»ºç«‹çš„ç‰©ç†è¿æ¥æ•°é‡ã€‚&lt;/p&gt;
&lt;p&gt;HostingListenerï¼šæŒ‡å®šagentå»ºç«‹è¿æ¥ä¹‹åæ‰˜ç®¡çš„mosn listenerï¼Œå³tunnel serverå‘æ¥çš„è¯·æ±‚ä¼šç”±è¯¥listeneræ‰˜ç®¡å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;DynamicServerListConfigï¼šåŠ¨æ€tunnel serverçš„æœåŠ¡å‘ç°ç›¸å…³é…ç½®ï¼Œå¯é€šè¿‡è‡ªå®šä¹‰çš„æœåŠ¡å‘ç°ç»„ä»¶æä¾›åŠ¨æ€çš„åœ°å€æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;CredentialPolicyï¼š è‡ªå®šä¹‰çš„è¿æ¥çº§åˆ«çš„é‰´æƒç­–ç•¥é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;TLSContextï¼šMOSN TLSé…ç½®ï¼Œæä¾›TCPä¹‹ä¸Šé€šä¿¡çš„ä¿å¯†æ€§å’Œå¯é æ€§ã€‚&lt;/p&gt;
&lt;p&gt;é’ˆå¯¹æ¯ä¸ªè¿œç«¯çš„tunnel serverå®ä¾‹ï¼Œagentå¯¹åº”ä¸€ä¸ªAgentPeerå¯¹è±¡ï¼Œå¯åŠ¨æ—¶é™¤äº†ä¸»åŠ¨å»ºç«‹ConnectionNumä¸ªåå‘é€šä¿¡è¿æ¥ï¼Œè¿˜ä¼šé¢å¤–å»ºç«‹ä¸€æ¡æ—è·¯è¿æ¥ï¼Œè¿™æ¡æ—è·¯è¿æ¥ä¸»è¦æ˜¯ç”¨æ¥å‘é€ä¸€äº›ç®¡æ§å‚æ•°ï¼Œä¾‹å¦‚å¹³æ»‘å…³é—­è¿æ¥ã€è°ƒæ•´è¿æ¥æ¯”é‡ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func (a *AgentPeer) Start() {
	connList := make([]*AgentClientConnection, 0, a.conf.ConnectionNumPerAddress)
	for i := 0; i &amp;lt; a.conf.ConnectionNumPerAddress; i++ {
	  // åˆå§‹åŒ–å’Œå»ºç«‹åå‘è¿æ¥
		conn := NewAgentCoreConnection(*a.conf, a.listener)
		err := conn.initConnection()
		if err == nil {
			connList = append(connList, conn)
		}
	}
	a.connections = connList
	// å»ºç«‹ä¸€ä¸ªæ—è·¯æ§åˆ¶è¿æ¥
	a.initAside()
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;initConnection&lt;/code&gt;æ–¹æ³•è¿›è¡Œå…·ä½“çš„åˆå§‹åŒ–å®Œæ•´çš„åå‘è¿æ¥ï¼Œé‡‡å–æŒ‡æ•°é€€é¿çš„æ–¹å¼ä¿è¯åœ¨æœ€å¤§é‡è¯•æ¬¡æ•°ä¹‹å†…å»ºè¿æˆåŠŸã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func (a *connection) initConnection() error {
	var err error
	backoffConnectDuration := a.reconnectBaseDuration

	for i := 0; i &amp;lt; a.connectRetryTimes || a.connectRetryTimes == -1; i++ {
		if a.close.Load() {
			return fmt.Errorf(&amp;quot;connection closed, don&#39;t attempt to connect, address: %v&amp;quot;, a.address)
		}
		// 1. åˆå§‹åŒ–ç‰©ç†è¿æ¥å’Œä¼ è¾“åå‘è¿æ¥å…ƒæ•°æ®
		err = a.init()
		if err == nil {
			break
		}
		log.DefaultLogger.Errorf(&amp;quot;[agent] failed to connect remote server, try again after %v seconds, address: %v, err: %+v&amp;quot;, backoffConnectDuration, a.address, err)
		time.Sleep(backoffConnectDuration)
		backoffConnectDuration *= 2
	}
	if err != nil {
		return err
	}
	// 2. æ‰˜ç®¡listener
	utils.GoWithRecover(func() {
		ch := make(chan api.Connection, 1)
		a.listener.GetListenerCallbacks().OnAccept(a.rawc, a.listener.UseOriginalDst(), nil, ch, a.readBuffer.Bytes(), []api.ConnectionEventListener{a})
	}, nil)
	return nil
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¯¥æ–¹æ³•ä¸»è¦æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;a.init()&lt;/code&gt;æ–¹æ³•ä¼šè°ƒç”¨initAgentCoreConnection`æ–¹æ³•åˆå§‹åŒ–ç‰©ç†è¿æ¥å¹¶å®Œæˆå»ºè¿äº¤äº’è¿‡ç¨‹ã€‚tunnel serveré€šè¿‡agentä¼ è¾“çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè¿›è¡Œç®¡ç†åå‘è¿æ¥ã€‚å…·ä½“çš„äº¤äº’è¿‡ç¨‹å’Œåè®®åæ–‡ä¼šç»†è®²ã€‚&lt;/li&gt;
&lt;li&gt;å»ºè¿æˆåŠŸä¹‹åï¼Œtunnel agentæ‰˜ç®¡raw connç»™æŒ‡å®šçš„listenerã€‚ä¹‹åè¯¥raw connçš„ç”Ÿå‘½å‘¨æœŸç”±è¯¥listenerå…¨æƒç®¡ç†ï¼Œå¹¶ä¸”å®Œå…¨å¤ç”¨è¯¥listenerçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…¶å®šä¹‰äº†åˆå§‹åŒ–åå‘è¿æ¥çš„äº¤äº’æµç¨‹ï¼Œå…·ä½“ä»£ç ç»†èŠ‚å¯ä»¥çœ‹pkg/filter/network/tunnel/connection.go:250ï¼Œæœ¬æ–‡ä¸å±•å¼€æŠ€æœ¯ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;h3 id=&#34;äº¤äº’è¿‡ç¨‹&#34;&gt;äº¤äº’è¿‡ç¨‹&lt;/h3&gt;
&lt;p&gt;ç›®å‰MOSNçš„åå‘é€šé“åªæ”¯æŒäº†raw connçš„å®ç°ï¼Œå› æ­¤å®šä¹‰äº†ä¸€å¥—ç®€å•æ˜äº†çš„ç½‘ç»œé€šä¿¡åè®®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;protocol.jpg&#34; alt=&#34;protocol&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸»è¦åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åè®®é­”æ•°ï¼š2 byte&lt;/li&gt;
&lt;li&gt;åè®®ç‰ˆæœ¬ï¼š1 byte&lt;/li&gt;
&lt;li&gt;ä¸»ä½“ç»“æ„ç±»å‹ï¼š1 byteï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€å¹³æ»‘å…³é—­ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;ä¸»ä½“æ•°æ®é•¿åº¦ï¼š2 byte&lt;/li&gt;
&lt;li&gt;jsonåºåˆ—åŒ–çš„ä¸»ä½“æ•°æ®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MOSNåå‘é€šé“å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸäº¤äº’è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;tunnel.jpg&#34; alt=&#34;tunnel&#34;&gt;&lt;/p&gt;
&lt;p&gt;å»ºè¿è¿‡ç¨‹ä¸­ç”±tunnel agentä¸»åŠ¨å‘èµ·ï¼Œå¹¶ä¸”åœ¨TCPè¿æ¥å»ºç«‹æˆåŠŸï¼ˆTLSæ¡æ‰‹æˆåŠŸï¼‰ä¹‹åï¼Œå°†åå‘å»ºè¿çš„å…³é”®ä¿¡æ¯ConnectionInitInfoåºåˆ—åŒ–å¹¶ä¼ è¾“ç»™å¯¹ç«¯tunnel serverï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº†åå‘é€šé“çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// ConnectionInitInfo is the basic information of agent host,
// it is sent immediately after the physical connection is established
type ConnectionInitInfo struct {
	ClusterName      string                 `json:&amp;quot;cluster_name&amp;quot;`
	Weight           int64                  `json:&amp;quot;weight&amp;quot;`
	HostName         string                 `json:&amp;quot;host_name&amp;quot;`
	CredentialPolicy string                 `json:&amp;quot;credential_policy&amp;quot;`
	Credential       string                 `json:&amp;quot;credential&amp;quot;`
	Extra            map[string]interface{} `json:&amp;quot;extra&amp;quot;`
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;tunnel serveræ¥å—è¯¥å…ƒæ•°æ®ä¿¡æ¯ä¹‹åï¼Œä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¦‚æœæœ‰è®¾ç½®è‡ªå®šä¹‰é‰´æƒæ–¹å¼ï¼Œåˆ™è¿›è¡Œè¿æ¥é‰´æƒã€‚&lt;/li&gt;
&lt;li&gt;clusterManagerå°†è¯¥è¿æ¥åŠ å…¥åˆ°æŒ‡å®šçš„ClusterSnapshotå¹¶å›å†™å»ºè¿ç»“æœã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ­¤æ—¶å»ºè¿è¿‡ç¨‹æ‰ç®—å®Œæˆã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func (t *tunnelFilter) handleConnectionInit(info *ConnectionInitInfo) api.FilterStatus {
	// Auth the connection
	conn := t.readCallbacks.Connection()
	if info.CredentialPolicy != &amp;quot;&amp;quot; {
		// 1. è‡ªå®šä¹‰é‰´æƒæ“ä½œï¼Œç¯‡å¹…åŸå› çœç•¥
	}
	if !t.clusterManager.ClusterExist(info.ClusterName) {
		writeConnectResponse(ConnectClusterNotExist, conn)
		return api.Stop
	}
	// Set the flag that has been initialized, subsequent data processing skips this filter
	err := writeConnectResponse(ConnectSuccess, conn)
	if err != nil {
		return api.Stop
	}
	conn.AddConnectionEventListener(NewHostRemover(conn.RemoteAddr().String(), info.ClusterName))
	tunnelHostMutex.Lock()
	defer tunnelHostMutex.Unlock()
	snapshot := t.clusterManager.GetClusterSnapshot(context.Background(), info.ClusterName)
	// 2. hoståŠ å…¥åˆ°æŒ‡å®šçš„cluster
	_ = t.clusterManager.AppendClusterTypesHosts(info.ClusterName, []types.Host{NewHost(v2.Host{
		HostConfig: v2.HostConfig{
			Address:    conn.RemoteAddr().String(),
			Hostname:   info.HostName,
			Weight:     uint32(info.Weight),
			TLSDisable: false,
		}}, snapshot.ClusterInfo(), CreateAgentBackendConnection(conn))})
	t.connInitialized = true
	return api.Stop
}

&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç„¶åæ˜¯é€šä¿¡è¿‡ç¨‹ï¼Œä¸ºäº†ä¾¿äºç†è§£ï¼Œä»¥ä¸‹å›¾è¯·æ±‚å•å‘æµè½¬ç¤ºæ„å›¾ä¸¾ä¾‹ï¼Œ&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;tunnelroute.jpg&#34; alt=&#34;route&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ä¼ ç»Ÿçš„MOSN sidecaråº”ç”¨åœºæ™¯ä¸­ï¼ŒFrontendå‘é€çš„è¯·æ±‚é¦–å…ˆç»è¿‡Client-MOSNï¼Œç„¶åé€šè¿‡è·¯ç”±æ¨¡å—ï¼Œä¸»åŠ¨åˆ›å»ºè¿æ¥(è™šçº¿éƒ¨åˆ†)å¹¶æµè½¬åˆ°å¯¹ç«¯ï¼Œç»ç”±Server-MOSN biz-listenerå¤„ç†è½¬äº¤ç»™Backendã€‚&lt;/p&gt;
&lt;p&gt;è€Œåœ¨äº‘è¾¹åœºæ™¯çš„åå‘é€šé“å®ç°ä¸­ï¼ŒClient MOSN(tunnel server)åœ¨æ¥å—åˆ°å¯¹ç«¯tunnel agentå‘èµ·åˆ›å»ºåå‘é€šé“çš„è¯·æ±‚åï¼Œå³å°†è¯¥ç‰©ç†è¿æ¥åŠ å…¥è·¯ç”±åˆ°å¯¹ç«¯MOSNçš„cluster snapshotä¸­ã€‚ä»è€ŒFrontendçš„è¯·æ±‚æµé‡èƒ½ç”±è¯¥åå‘é€šé“æµè½¬åˆ°å¯¹ç«¯MOSNï¼Œè€Œå› ä¸ºtunnel agentä¾§æŠŠè¯¥è¿æ¥æ‰˜ç®¡ç»™äº†biz-listenerï¼Œåˆ™è¯»å†™å¤„ç†éƒ½ç”±biz-listenerè¿›è¡Œå¤„ç†ï¼Œbiz-listenerå°†å¤„ç†å®Œçš„è¯·æ±‚å†è½¬å‘ç»™çœŸæ­£çš„BackendæœåŠ¡ï¼Œ&lt;/p&gt;
&lt;p&gt;æ€»ç»“å’Œè§„åˆ’ï¼š&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»äº†MOSNåå‘é€šé“çš„å®ç°åŸç†å’Œè®¾è®¡æ€è·¯ï¼ŒMOSNä½œä¸ºé«˜æ€§èƒ½çš„äº‘åŸç”Ÿç½‘ç»œä»£ç†ï¼Œå¸Œæœ›åå‘é€šé“çš„èƒ½åŠ›èƒ½æ›´åŠ æœ‰æ•ˆåœ°æ”¯æŒå…¶ä½œä¸ºäº‘è¾¹ååŒåœºæ™¯ä¸­æ‰¿æ¥ä¸œè¥¿å‘æµé‡çš„èŒè´£ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œåç»­æˆ‘ä»¬ä¹Ÿä¼šç»§ç»­åšä¸€ç³»åˆ—çš„æ‹“å±•æ”¯æŒï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åå‘é€šé“æ”¯æŒgRPCå®ç°ï¼ŒgRPCä½œä¸ºäº‘åŸç”Ÿæ—¶ä»£æœ€é€šç”¨çš„æœåŠ¡é€šè®¯æ¡†æ¶ï¼Œæœ¬èº«å†…ç½®äº†å„ç§å¼ºå¤§çš„æ²»ç†èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;ç»“åˆæ›´å¤šäº‘åŸç”Ÿåœºæ™¯ï¼Œå†…ç½®æ›´åŠ é€šç”¨çš„tunnel serveråŠ¨æ€æœåŠ¡å‘ç°èƒ½åŠ›ç»„ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;æ›´å¤šçš„é…å¥—è‡ªåŠ¨åŒ–è¿ç»´å’Œéƒ¨ç½²å·¥å…·ã€‚&lt;/li&gt;
&lt;/ol&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: åˆ©ç”¨ SidecarSet å®ç° MOSN å®¹å™¨åŸåœ°çƒ­å‡çº§</title>
      <link>https://mosn.io/blog/posts/mosn-sidecarset-hotupgrade/</link>
      <pubDate>Fri, 10 Dec 2021 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-sidecarset-hotupgrade/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;MOSN ä½œä¸º Sidecar å®¹å™¨éƒ¨ç½²æ—¶ï¼Œå¯¹äº MOSN å®¹å™¨è‡ªèº«çš„å‡çº§ï¼Œå¯ä»¥é‡‡ç”¨çš„ä¸€ç§å½¢å¼æ˜¯å…ˆå°†ä¸šåŠ¡åˆ‡æµï¼Œå†å‡çº§ç‰ˆæœ¬ã€‚è¿™ç§å½¢å¼ç”¨æˆ·PODéœ€è¦é”€æ¯ã€é‡æ–°è°ƒåº¦ã€é‡å»ºï¼Œå¸¦æ¥è¾ƒå¤§å¼€é”€çš„åŒæ—¶ï¼Œä¹Ÿå¯èƒ½å½±å“ä¸šåŠ¡çš„ç¨³å®šæ€§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºæ­¤ MOSN æä¾›äº†å¯¹ä¸šåŠ¡æ— æ„Ÿçš„çƒ­å‡çº§æ–¹å¼ï¼Œå…·ä½“çš„åŸç†å¯ç§»æ­¥&lt;a href=&#34;https://mosn.io/docs/concept/smooth-upgrade/&#34;&gt;è¿™é‡ŒæŸ¥é˜…&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åˆ©ç”¨ &lt;a href=&#34;http://openkruise.io/&#34;&gt;OpenKruise&lt;/a&gt; å¯¹ Kubernetes çš„æ‰©å±• SidecarSetï¼Œæ¥å…·ä½“æ“ä½œ MOSN å®¹å™¨çš„åŸåœ°çƒ­å‡çº§ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ç¯å¢ƒå‡†å¤‡&#34;&gt;ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;
&lt;p&gt;åœ¨ k8s ä¸­å®‰è£… OpenKruise, å®‰è£…æ­¥éª¤è§ &lt;a href=&#34;http://openkruise.io/docs/installation&#34;&gt; OpenKruise å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;æµ‹è¯•æ­¥éª¤&#34;&gt;æµ‹è¯•æ­¥éª¤&lt;/h2&gt;
&lt;h3 id=&#34;æ‰“åŒ…-mosn-é•œåƒ&#34;&gt;æ‰“åŒ… MOSN é•œåƒ&lt;/h3&gt;
&lt;p&gt;æœ¬æ–‡åˆ©ç”¨å½“å‰ MOSN ç¤¾åŒºæä¾›çš„æ„å»ºé•œåƒçš„æ–¹å¼æ¥å‡†å¤‡æµ‹è¯•ç”¨çš„ MOSN é•œåƒï¼Œåœ¨æ„å»ºé•œåƒä¹‹å‰éœ€è¦åšå¦‚ä¸‹è°ƒæ•´ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¿®æ”¹&lt;code&gt;etc/supervisor/supervisord.conf&lt;/code&gt;, å› ä¸ºå½“å‰ supervisor é…ç½®ä½¿ç”¨&lt;code&gt;/dev/shm/&lt;/code&gt;ç›®å½•ï¼ŒåŒä¸€ POD å†…ä¸åŒå®¹å™¨ä¹‹é—´ä¼šå†²çªï¼Œä¼šå¯¼è‡´æ–°å®¹å™¨å¯åŠ¨å¤±è´¥&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;[unix_http_server]
-file=/dev/shm/supervisor.sock
+file=/var/run/supervisor_mosn.sock
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;ä¿®æ”¹ MOSN é…ç½®æ–‡ä»¶&lt;code&gt;configs/mosn_config.json&lt;/code&gt;, æ·»åŠ é…ç½®ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;{
    &amp;quot;uds_dir&amp;quot;: &amp;quot;/home/admin/mosn/logs&amp;quot;,
    &amp;quot;inherit_old_mosnconfig&amp;quot;: true,
    ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å…¶ä¸­&lt;code&gt;uds_dir&lt;/code&gt;ä¸º MOSN &lt;code&gt;reconfig.sock&lt;/code&gt;å­˜å‚¨ç›®å½•ï¼Œè¯¥ç›®å½•éœ€è¦æŒ‚è½½ä¸ºå…±äº«å·ï¼Œä½¿å¾—çƒ­å‡çº§è¿‡ç¨‹ä¸­ä¸¤ä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥ç›¸äº’è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä»pilotè·å–åŠ¨æ€ä¸‹å‘çš„é…ç½®ï¼Œåˆ™éœ€è¦æ·»åŠ &lt;code&gt;inherit_old_mosnconfig&lt;/code&gt;é…ç½®é¡¹ï¼Œæ–°çš„ MOSN è¿›ç¨‹å¯åŠ¨ä¹‹åç»§æ‰¿è€çš„ MOSN è¿›ç¨‹ç›‘å¬çš„fdï¼Œé¿å…ç«¯å£å†²çªå¯¼è‡´è¿›ç¨‹å¯åŠ¨å¤±è´¥ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ„å»ºé•œåƒï¼Œå¹¶ä¸Šä¼ è‡³å¯è®¿é—®çš„é•œåƒä»“åº“&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;make image
docker tag [imageid] [repo:tag]
docker push [repo:tag]
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;åˆ›å»ºsidecarsetèµ„æº&#34;&gt;åˆ›å»ºSidecarSetèµ„æº&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;æ³¨æ„
&lt;ul&gt;
&lt;li&gt;image ä¿®æ”¹ä¸ºè‡ªå·±ä½¿ç”¨ç‰ˆæœ¬&lt;/li&gt;
&lt;li&gt;volume æŒ‚è½½ç›®å½•å’Œé…ç½®æ–‡ä»¶ä¸­&lt;code&gt;uds_dir&lt;/code&gt;ç›®å½•ä¿æŒä¸€è‡´&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;$ kubectl apply -f sidecarset.yaml 
$ cat sidecarset.yaml
apiVersion: apps.kruise.io/v1alpha1
kind: SidecarSet
metadata:
  name: mosn
spec:
  containers:
  - image: tinyqian/mosn:v1
    imagePullPolicy: IfNotPresent
    name: mosn
    podInjectPolicy: BeforeAppContainer
    resources: {}
    shareVolumePolicy:
      type: enabled
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    upgradeStrategy:
      hotUpgradeEmptyImage: openkruise/hotupgrade-sample:empty
      upgradeType: HotUpgrade
    volumeMounts:
    - mountPath: /home/admin/mosn/logs
      name: mosn-log
    lifecycle:
      postStar:
        exec:
          command:
          - /bin/sh
          - -c
          - sleep 30

  injectionStrategy: {}
  namespace: default
  selector:
    matchLabels:
      mesh.apsara-edge.com/mosn-injected: &amp;quot;true&amp;quot;
  updateStrategy:
    maxUnavailable: 1
    partition: 0
    type: RollingUpdate
  volumes:
  - emptyDir: {}
    name: mosn-log
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éƒ¨ç½²æµ‹è¯•åº”ç”¨&#34;&gt;éƒ¨ç½²æµ‹è¯•åº”ç”¨&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    mesh.apsara-edge.com/mosn-injected: &amp;quot;true&amp;quot;
  name: test-app
spec:
  selector:
    matchLabels:
      mesh.apsara-edge.com/mosn-injected: &amp;quot;true&amp;quot;
  replicas: 1
  template:
    metadata:
      labels:
        mesh.apsara-edge.com/mosn-injected: &amp;quot;true&amp;quot;
    spec:
      containers:
        - name: test-app
          image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;éƒ¨ç½²åº”ç”¨ä¹‹åï¼ŒæŸ¥çœ‹ POD&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;$ kubectl get pods -n ppe-t-e3496bc319e941ed8ec8349b8c65b366-cn3691    -o wide
NAME                             READY   STATUS                     RESTARTS   AGE
test-app-5fd64d788c-g9wg9        3/3     Running                    0          2m56s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥çœ‹åˆ° POD ä¸€å…±åˆ›å»ºäº†ä¸‰ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªæ˜¯ä¸šåŠ¡å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯ MOSN å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯ emptyå®¹å™¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æµ‹è¯•å‡çº§é•œåƒç‰ˆæœ¬&#34;&gt;æµ‹è¯•å‡çº§é•œåƒç‰ˆæœ¬&lt;/h3&gt;
&lt;p&gt;éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥æµ‹è¯•å‡çº§ MOSN å®¹å™¨çš„é•œåƒç‰ˆæœ¬ï¼Œæ›´æ–°å‰é¢åˆ›å»ºçš„ sidecarset èµ„æºçš„ image ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;$ kubectl edit sidecarset mosn
application.core.oam.dev/mosn edited
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ° RESTARTS å­—æ®µå˜åŒ–ï¼ŒPODå†…å®¹å™¨æœ‰é‡å¯ï¼Œä½†æ˜¯PODæ²¡æœ‰é‡å»º&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bigquery&#34; data-lang=&#34;bigquery&#34;&gt;NAME                             READY   STATUS                     RESTARTS   AGE
test-app-5fd64d788c-g9wg9        3/3     Running                    2          10m
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å®é™…çš„å‡çº§è¿‡ç¨‹ä¸ºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;empty å®¹å™¨å‡çº§ä¸º MOSN v2 ç‰ˆæœ¬å®¹å™¨&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MOSN v2 ç‰ˆæœ¬å®¹å™¨å’Œv1ç‰ˆæœ¬å®¹å™¨ä¹‹é—´è¿›è¡Œè¿æ¥è¿ç§»&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MOSN v1 ç‰ˆæœ¬å®¹å™¨é€€å‡ºï¼Œå˜æ›´ä¸º empty å®¹å™¨&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;mosn-hotupgrade.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;æŸ¥çœ‹å‡çº§è¿‡ç¨‹ä¸­çš„è¿›ç¨‹å¯ä»¥å‘ç°ï¼Œåœ¨v1ç‰ˆæœ¬çš„å®¹å™¨æ²¡æœ‰é€€å‡ºä¹‹å‰ï¼Œæ–°è€å®¹å™¨ä¸­çš„è¿›ç¨‹æ˜¯å¹¶å­˜çš„&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn-hotupgrade-process.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;åŒæ—¶ï¼Œå‡çº§çš„è¿‡ç¨‹ä¸­ä½ å¯ä»¥ä¸æ–­åœ°å‘é€é€šè¿‡ MOSN ä»£ç†çš„æµ‹è¯•è¯·æ±‚ï¼Œå¯ä»¥éªŒè¯å‡çº§è¿‡ç¨‹ä¸­ MOSN ä¸€ç›´å¤„äºå¯ç”¨çŠ¶æ€ï¼Œå¯¹ä¸šåŠ¡æ˜¯æ— æŸçš„ã€‚&lt;/p&gt;
&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h1&gt;
&lt;p&gt;é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œå¯ä»¥å®ç°ç”¨æˆ· POD å’Œ sidecar å®¹å™¨çš„éƒ¨ç½²ï¼ŒåŒæ—¶å®ç° sidecar å®¹å™¨çš„åŸåœ°çƒ­å‡çº§ï¼Œåšåˆ° sidecar å®¹å™¨å‡çº§ä¸šåŠ¡æ— æ„Ÿã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ SidecarSet æ”¯æŒimageç‰ˆæœ¬å‡çº§ï¼Œä¿®æ”¹å…¶ä»–å­—æ®µå°†ä¼šå¯¼è‡´å®¹å™¨æ— æ³•å‡çº§ã€‚&lt;/p&gt;
&lt;h1 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h1&gt;
&lt;p&gt;&lt;a href=&#34;https://openkruise.io/zh/docs/user-manuals/sidecarset/&#34;&gt;OpenKruise SidecarSet ä»‹ç»&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;http://openkruise.io/zh/docs/installation&#34;&gt;OpenKruise å®‰è£…æŒ‡å—&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN è·¯ç”±æ¡†æ¶è¯¦è§£</title>
      <link>https://mosn.io/blog/posts/how-use-dynamic-metadata/</link>
      <pubDate>Tue, 07 Dec 2021 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/how-use-dynamic-metadata/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;MOSN ä½œä¸ºç½‘ç»œè¾¹ç¼˜ä»£ç†ç»„ä»¶ï¼Œè·¯ç”±åŠŸèƒ½æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œæœ¬æ–‡å°†ä»‹ç» MOSN è·¯ç”±å¦‚ä½•ä½¿ç”¨ï¼Œä»¥åŠ MOSN è·¯ç”±çš„ä¸€äº›é«˜çº§ä½¿ç”¨æŠ€å·§ï¼ŒMOSN å®˜ç½‘ä»‹ç»äº†è·¯ç”±åŠŸèƒ½çš„åŸºæœ¬ä½¿ç”¨é…ç½®:
&lt;a href=&#34;https://mosn.io/docs/configuration/server/router/&#34;&gt;ç‚¹å‡»é“¾æ¥&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;è·¯ç”±åŸºæœ¬è®¾è®¡&#34;&gt;è·¯ç”±åŸºæœ¬è®¾è®¡&lt;/h2&gt;
&lt;p&gt;åœ¨ MOSN çš„è·¯ç”±è®¾è®¡ä¸­ï¼Œcluster å’Œ route æ˜¯é«˜åº¦å…³è”çš„ï¼Œè¯´ç™½äº†ï¼Œroute çš„é…ç½®ï¼Œå°±æ˜¯ä¸ºäº†è¡¨è¾¾å¦‚ä½•å‡†ç¡®çš„æ‰¾åˆ°ä½ æƒ³æ‰¾åˆ°çš„ clusterï¼Œå¦å¤–ï¼Œä¸€ä¸ª cluster å¯ä»¥æœ‰å¤šä¸ª host æœºå™¨ï¼Œä¾‹å¦‚ä¸€ä¸ª cluster æœ‰ 100 å°æœºå™¨ï¼Œå…¶ä¸­æœ‰50å°æ˜¯ v1 ç‰ˆæœ¬ï¼Œ50å°æ˜¯ v2 ç‰ˆæœ¬ï¼Œå¦‚ä½•æ ¹æ®ä¸€äº›ç‰¹å®šçš„è§„åˆ™ï¼Œå‡†ç¡®åœ°æŠŠè¯·æ±‚è·¯ç”±åˆ° v1 ç‰ˆæœ¬æˆ–è€… v2 ç‰ˆæœ¬å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å†ä¾‹å¦‚ï¼Œæˆ‘æƒ³æ ¹æ® header é‡Œçš„æŸä¸ªå€¼ï¼Œå†å°†è¿™ä¸ªå€¼å’Œâ€œé…ç½®ä¸­å¿ƒâ€é‡Œçš„æŸä¸ªå€¼è¿›è¡Œè®¡ç®—ï¼Œæ‰èƒ½æ‰¾åˆ° clusterï¼Œé‚£ä¹ˆæˆ‘è¯¥å¦‚ä½•é…ç½®å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹æœ€ç®€å•çš„è·¯ç”±è®¾ç½®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211207141910.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯ä¸€ä¸ªç®€å•çš„ json é…ç½®ï¼Œå…¶ä¸­ï¼Œcluster manager å’Œ routers çš„é…ç½®ï¼Œæ˜¯è·¯ç”±çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ cluster manager ä¸­é…ç½®å¤šä¸ª clusterï¼Œæ¯ä¸ª cluster é…ç½®å¤šä¸ª hostã€‚&lt;/p&gt;
&lt;p&gt;ç„¶ååœ¨ routers é…ç½®ä¸­ï¼Œæ ¹æ®ä¸€äº›è§„åˆ™ï¼Œå‘Šè¯‰ MOSNï¼Œå¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ° cluster ä¸­ã€‚å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211207142022.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ­¤é…ç½®è¡¨ç¤ºï¼Œç°åœ¨æœ‰ä¸€ä¸ª rouer é…ç½®ï¼Œåä¸º server_routerï¼Œæœ‰ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¯é…ç½®å¤šä¸ªåŸŸåï¼Œè¿™é‡ŒåŒ¹é…æ‰€æœ‰åŸŸåï¼ŒåŒæ—¶ï¼Œè¿™ä¸ªåŸŸåæœ‰å¤šä¸ªè·¯ç”±é…ç½®ï¼Œè¿™é‡Œæš‚ä¸”é…ç½®äº†ä¸€ä¸ªè·¯ç”±é…ç½®ï¼šå‰ç¼€åŒ¹é…ï¼Œåªè¦æ˜¯ / å¼€å¤´çš„ï¼Œå°±è½¬å‘åˆ° serverCluster é‡Œçš„ host ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„ cluster manager é…ç½®é‡Œçš„ serverClusterã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ ·ï¼Œå°±å®ç°äº†ä¸€ä¸ªç®€å•çš„ mosn è·¯ç”±çš„é…ç½®ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åŠ¨æ€è·¯ç”±-cluster&#34;&gt;åŠ¨æ€è·¯ç”± cluster&lt;/h2&gt;
&lt;p&gt;å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„è·¯ç”±é€»è¾‘å¾ˆç®€å•ï¼Œä¾‹å¦‚æ ¹æ® header é‡Œçš„æŸä¸ªåå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„ clusterï¼Œä»£ç æˆ–è€…é…ç½®å°±æ˜¯è¿™ä¹ˆå†™çš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;router&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// header åŒ¹é…
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;RouterConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;Match&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterMatch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;Headers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMatcher&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™ä¸ª header åŒ¹é…, å°±è½¬å‘åˆ° app.Name cluster.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;X-service-id&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
                    &lt;span style=&#34;color:#000&#34;&gt;Value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// cluster åç§°åŒ¹é….
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;Route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouteAction&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;RouterActionConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterActionConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;ClusterName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;VirtualHosts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Routers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;VirtualHosts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Routers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢ä»£ç çš„æ„æ€æ˜¯å¦‚æœ header é‡Œæœ‰ &lt;code&gt;X-service-id&lt;/code&gt; è¿™ä¸ª kvï¼Œé‚£ä¹ˆå°±èƒ½æ‰¾åˆ°ä¸‹é¢ RouteAction å¯¹åº”çš„ Cluster äº†ã€‚&lt;/p&gt;
&lt;p&gt;é‚£å¦‚æœæ˜¯æ›´å¤æ‚çš„é€»è¾‘å‘¢ï¼Ÿæ¯”å¦‚åˆ©ç”¨è¯·æ±‚é‡Œçš„ header å’Œâ€œé…ç½®ä¸­å¿ƒâ€çš„æŸä¸ªå€¼è¿›è¡Œè®¡ç®—ï¼Œæ‰èƒ½æ‰¾åˆ° clusterï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ­¤æ—¶ï¼Œé€šè¿‡é…ç½®å·²ç»æ— æ³•è§£å†³è¿™ä¸ªéœ€æ±‚ï¼Œå› ä¸ºè¿™å…¶ä¸­æ¶‰åŠåˆ°äº†è®¡ç®—é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;MOSN é€šè¿‡åŠ¨æ€é…ç½®å¯ä»¥æ”¯æŒè¯¥éœ€æ±‚ã€‚å¦‚ä¸‹å›¾é…ç½®ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;11111122.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª &lt;code&gt;&amp;quot;cluster_variable&amp;quot;: &amp;quot;My-ClusterVariable&amp;quot;&lt;/code&gt; çš„ KV é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ StreamFilter ä¸­ï¼Œåˆ©ç”¨å˜é‡æœºåˆ¶ï¼Œè®¾ç½® key ä¸º â€œMy-ClusterVariableâ€ çš„ valueï¼Œè¿™ä¸ª value å°±æ˜¯è®¡ç®—å‡ºæ¥çš„ Cluster åç§°ã€‚&lt;/p&gt;
&lt;p&gt;ä»£ç å¦‚ä¸‹&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å…ˆæ³¨å†Œè¿™ä¸ª key åˆ°å˜é‡è¡¨ä¸­ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Register&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStringVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;My-ClusterVariable&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultStringSetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;


&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clusterMap&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MyFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterStatus&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ‰¾ Cluster
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ‰§è¡Œä¸€äº›è®¡ç®—
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¾ç½®åˆ°ä¸Šä¸‹æ–‡å˜é‡ä¸­ã€‚è¿™ä¸ª key å¿…é¡»å’Œé…ç½®æ–‡ä»¶ä¸­ä¿æŒä¸€è‡´ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;My-ClusterVariable&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterContinue&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åŸºäºå˜é‡æœºåˆ¶åŠ¨æ€çš„æ‰¾åˆ° Clusterï¼Œè¿™ç§æœºåˆ¶åœ¨é¢å¯¹å¤æ‚è·¯ç”±é€»è¾‘çš„åœºæ™¯æ—¶ï¼Œèƒ½å¤Ÿè§£å†³ä½ çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-subset&#34;&gt;MOSN subset&lt;/h2&gt;
&lt;p&gt;å¦‚ä¸Šé¢æ‰€è¿°ï¼Œæˆ‘ä»¬ç»å¸¸æœ‰åœ¨ä¸€ä¸ªé›†ç¾¤é‡Œï¼Œæœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå¦‚ä½•æ ¹æ®æŸäº›æ ‡ç­¾ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°æŒ‡å®šçš„ç‰ˆæœ¬å‘¢ï¼Ÿé€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ subset æ–¹æ¡ˆï¼Œå³ï¼Œå­é›†åˆï¼Œå¯åœ¨ä¸€ä¸ª cluster é‡Œé¢ï¼Œä¸ºæ¯ä¸ªåº”ç”¨æ‰“æ ‡ï¼ŒåŒæ—¶æˆ‘ä»¬çš„è·¯ç”±ä¹Ÿé…ç½®ç›¸å…³çš„é…ç½®ï¼ˆMOSN ç§°ä¸º metadataï¼‰ï¼Œå®ç°è¾ƒä¸ºå¤æ‚çš„è·¯ç”±ã€‚&lt;/p&gt;
&lt;p&gt;MOSN å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œç®€å•ä»‹ç»äº† metadata çš„ä½¿ç”¨ï¼š&lt;a href=&#34;https://mosn.io/docs/configuration/custom/#metadata&#34;&gt;metadata&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢è®©æˆ‘ä»¬æ›´è¯¦ç»†çš„ä»‹ç» subset çš„ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;888.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾ä¸­,å·¦è¾¹æ˜¯ cluster host é…ç½®,å³è¾¹æ˜¯ router é…ç½®.&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªè·¯ç”±é…ç½®çš„ match æ„æ€æ˜¯,å½“è¯·æ±‚è€…çš„ header é‡ŒæŒ‡å®šäº† name å’Œ value, ä¸”å…¶å€¼åŒ¹é…è¿™ä¸ªè·¯ç”±å€¼ service å’Œ service.green, é‚£ä¹ˆè¯¥è¯·æ±‚å°±è¢«è·¯ç”±åˆ°äº†è¿™ä¸ª &lt;code&gt;cluster_subset&lt;/code&gt; é›†ç¾¤ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶å, è¿™ä¸ªé›†ç¾¤å¯èƒ½æœ‰å¤šä¸ªæœºå™¨, é‚£ä¹ˆéœ€è¦è¿™ä¸ªæœºå™¨çš„å…ƒæ•°æ®å’Œè·¯ç”±é…ç½®çš„å…ƒæ•°æ®ç›¸åŒï¼Œ
å¿…é¡»éƒ½æ˜¯ &lt;code&gt;subset:green&lt;/code&gt;, æ‰èƒ½åŒ¹é…ä¸Šè¿™ä¸ª Hostï¼Œå¦åˆ™æç¤ºæ‰¾ä¸åˆ°ï¼ˆ&lt;code&gt;fall_back_policy ç­–ç•¥æ˜¯ 0 ä¸ºå‰æ&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ç”±æ­¤ï¼Œæˆ‘ä»¬è§£å†³äº†ä¸€ä¸ª cluster é‡Œé¢æœ‰å¤šä¸ªç‰ˆæœ¬çš„ host çš„è·¯ç”±é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å†è¿›ä¸€æ­¥ï¼Œä¸€ä¸ª cluster ä¼šæœ‰å¤šä¸ª hostï¼Œæ¯ä¸ª host å¯èƒ½æœ‰ä¸åŒçš„ subsetï¼Œè¿™å¯èƒ½å°±éœ€è¦å¾ˆå¤šçš„è·¯ç”±ï¼Œå¦‚æœéƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼å†™æ­»ï¼Œå°±æ¯”è¾ƒéº»çƒ¦ã€‚&lt;/p&gt;
&lt;p&gt;MOSN æ”¯æŒåŸºäº stream filter çš„æ–¹å¼ï¼Œè®¾ç½®åŠ¨æ€è·¯ç”±ã€‚å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211125103943.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;åŸºäº MOSN çš„å˜é‡æœºåˆ¶ï¼Œåœ¨è¯·æ±‚çº§åˆ«çš„ &lt;code&gt;VarRouterMeta&lt;/code&gt; ä¸­è®¾ç½® kv metadata ç»„åˆï¼Œæ•ˆæœå’Œä¸Šé¢é…ç½®æ–‡ä»¶çš„æ–¹å¼ç±»ä¼¼ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–, å¦‚æœè·¯ç”±é…ç½®ä¸­é…ç½® MetaData, è¯·æ±‚çº§åˆ«ä¹Ÿé…ç½®äº† MetaData, é‚£ä¹ˆ, MOSN ä¼šå°† 2 ä¸ªå…ƒæ•°æ®è¿›è¡Œåˆå¹¶, æ¥å’Œ Host è¿›è¡ŒåŒ¹é…. è¿™ä¸ªé€»è¾‘åœ¨ &lt;code&gt;pkg/proxy/downstream.go:1497&lt;/code&gt; ä»£ç ä¸­æœ‰ä½“ç°.&lt;/p&gt;
&lt;p&gt;æ¥ä¸ªç®€å•çš„ä¾‹å­ï¼š&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚åˆ†ç»„é‡ŒæŒ‡å®šæœºå™¨è°ƒç”¨ï¼›&lt;/p&gt;
&lt;p&gt;1 è¯·æ±‚æ—¶, å¯åœ¨ header é‡Œï¼ŒæŒ‡å®š ipï¼Œå¹¶åœ¨ &lt;code&gt;varRouterMeta&lt;/code&gt; é‡Œè®¾ç½®è¿™ä¸ª ipã€‚&lt;/p&gt;
&lt;p&gt;2 host é…ç½®ï¼Œå¯åœ¨ metadata é‡Œï¼Œé…ç½® ip kvï¼Œä¾‹å¦‚ ipï¼š192.168.2.3ï¼›
å¦‚ä¸‹å›¾:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211125104007.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·ï¼Œå°±èƒ½åŒ¹é…åˆ°æŒ‡å®šæœºå™¨äº†ã€‚&lt;/p&gt;
&lt;p&gt;ps: å…³äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å…¶å®ä¹Ÿå¯ä»¥ä½¿ç”¨ MOSN çš„ &lt;code&gt;ORIGINAL_DST&lt;/code&gt; æœºåˆ¶ï¼Œå°† cluster çš„ type
è®¾ç½®ä¸º &lt;code&gt;ORIGINAL_DST&lt;/code&gt;ï¼ˆMOSN è¿˜æ”¯æŒ DNS é›†ç¾¤ç±»å‹ï¼‰ï¼Œç„¶åé…ç½® &lt;code&gt;cluster.original_dst_lb_config.use_header = true&lt;/code&gt;ï¼Œ
è¿™æ ·ï¼Œæˆ‘ä»¬è¯·æ±‚çš„æ—¶å€™ï¼Œåœ¨ header é‡ŒåŠ å…¥ &lt;code&gt;host = {ç›®æ ‡åœ°å€}&lt;/code&gt;ï¼Œ
MOSN å°±ä¼šæ ¹æ®è¿™ä¸ªæŒ‡å®šçš„ host header è¿›è¡Œè½¬å‘ã€‚å½“ç„¶ï¼ŒMOSN ä¹Ÿå¯ä»¥è‡ªå®šä¹‰åå­—ï¼Œä¸ä¸€å®šè¦å« hostã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸ªå¤æ‚çš„ä¾‹å­ã€‚
å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼šå•ä¸ª host å­˜åœ¨äºå¤šä¸ªåˆ†ç»„ï¼Œè€Œè¯·æ±‚æ—¶ï¼Œåªèƒ½æŒ‡å®šä¸€ä¸ªåˆ†ç»„ã€‚å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211207142344.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ç°åœ¨æœ‰ 2 å°æœºå™¨ï¼Œå…± 3 ä¸ªåˆ†ç»„ï¼ŒAAAï¼ŒBBBï¼ŒCCCã€‚æ¯ä¸ªæœºå™¨éƒ½åŒ…å« AAA åˆ†ç»„ã€‚
ç°åœ¨æœ‰ 3 ä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ä¸åŒçš„åˆ†ç»„ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•é…ç½® å…ƒæ•°æ®å‘¢ï¼Ÿ
é¦–å…ˆï¼Œæœ¬è´¨ä¸Šï¼Œç»™æœºå™¨åŠ åˆ†ç»„ï¼Œå…¶å®å°±æ˜¯æ‰“æ ‡ã€‚æˆ‘ä»¬å°†å…ƒæ•°æ®æƒ³è±¡æˆ tag åˆ—è¡¨å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„ä»£ç ï¼Œå±•ç¤ºäº†ï¼šæˆ‘ä»¬å°†å¤šä¸ªåˆ†ç»„æ ‡ç­¾ï¼Œè½¬æ¢æˆ MOSN å¯ä»¥è®¤è¯†çš„å…ƒæ•°æ® kvï¼Œæ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªå›ºå®šçš„ value trueï¼ˆ&lt;code&gt;ä¸ºä»€ä¹ˆè®¾ç½®ä¸º true å‘¢ï¼Ÿvalue è‡ªèº«å…¶å®åœ¨ MOSN çš„ subsetLB ä¸­æ˜¯æœ‰å«ä¹‰çš„ï¼Œå³æœ€ç»ˆæ ¹æ®è¯·ä¸­æºå¸¦çš„ metadata çš„å€¼å»åŒ¹é… cluster ä¸­æ»¡è¶³æ¡ä»¶çš„ subset host entryã€‚ä½†ç”±äº metadata æ˜¯ä¸ª mapï¼Œ è€Œå› ä¸ºæˆ‘ä»¬è¿™ä¸ªä¾‹å­çš„ç‰¹æ®Šæ€§ï¼Œåªèƒ½ä½¿ç”¨ key è‡ªèº«åšåˆ†ç»„ï¼Œæ‰€æœ‰çš„ value éƒ½ä¿æŒä¸€æ ·ï¼Œæœ¬è´¨ä¸Šä»»ä½•å€¼éƒ½æ˜¯å¯ä»¥çš„&lt;/code&gt;ï¼‰ã€‚åŒæ—¶æ³¨æ„ï¼Œè¿™äº› keyï¼Œéƒ½è¦ä¿å­˜åˆ° &lt;code&gt;SubsetSelectors&lt;/code&gt; ä¸­ï¼Œå¦åˆ™ï¼ŒMOSN æ— æ³•è¯†åˆ«ã€‚
æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬åœ¨ filter é‡Œï¼Œä» header é‡Œé¢å–å‡ºåˆ†ç»„æ ‡ç­¾ï¼Œç„¶åè®¾ç½®è¿›â€œä¸Šä¸‹æ–‡å˜é‡â€ä¸­ã€‚ä¾‹å¦‚ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211125104038.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå®Œæˆæ›´åŠ å¤æ‚çš„åˆ†ç»„è·¯ç”±ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ MOSN æ˜¯å¦‚ä½•å¯»æ‰¾ subset çš„å‘¢ï¼Ÿä»£ç å¦‚ä¸‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211125103953.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å½“æ‰§è¡Œ choose host æ—¶ï¼Œ&lt;code&gt;subsetLoadBalancer.findSubset&lt;/code&gt; å‡½æ•°ä¼šæ ¹æ®å½“å‰è¯·æ±‚çš„å…ƒæ•°æ®ï¼Œä» &lt;code&gt;subSetLoadbalancer&lt;/code&gt; é‡Œæ‰¾å‡ºåŒ¹é…çš„ host Listã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬å…ˆè®²äº†åŸºäºç®€å•çš„é…ç½®ï¼Œæ¥å®ç°ç®€å•çš„ router å’Œ cluster çš„é…ç½®æ–‡ä»¶è·¯ç”±ã€‚å†è®²äº†å¯ä»¥åŸºäº stream filter çš„æ–¹å¼å®ç°åŠ¨æ€å¯»æ‰¾ clusterã€‚åŒæ—¶ MOSN æ”¯æŒ subsetï¼Œå¯ä»¥åŸºäº route é…ç½®æ–‡ä»¶æ¥è¿›è¡Œè·¯ç”±å’Œ cluster host è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœé€»è¾‘å¤æ‚ï¼Œä¹Ÿå¯ä»¥åŸºäº stream filter + varRouterMeta å˜é‡çš„æ–¹å¼æ¥ åŠ¨æ€å¯»æ‰¾ subsetã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ json é…ç½®å°±èƒ½è§£å†³æˆ‘ä»¬çš„è·¯ç”±é—®é¢˜ã€‚å¦‚æœå¤æ‚çš„è¯ï¼Œæˆ‘ä»¬å°±ç”¨  stream filter + varRouterMeta / stream filter + cluster_variable è¿™ä¸¤ç§åŠ¨æ€æœºåˆ¶è§£å†³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ä¸‹é¢å°è¯•ç”¨ä¸€å¼ å›¾æ¥ç»“æŸæœ¬æ–‡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;20211127183927.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://mosn.io/docs/configuration/server/router/&#34;&gt;Router é…ç½®&lt;/a&gt;
&lt;a href=&#34;https://www.bookstack.cn/read/SOFAMesh-zh/mosn-develop-SubsetLB.md&#34;&gt;MOSN SubsetLB å¼€å‘æ–‡æ¡£&lt;/a&gt;
&lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/subsets&#34;&gt;Load Balancer Subsets&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: WebAssembly åœ¨ MOSN ä¸­çš„å®è·µ - åŸºç¡€æ¡†æ¶ç¯‡</title>
      <link>https://mosn.io/blog/posts/mosn-wasm-framework/</link>
      <pubDate>Mon, 22 Mar 2021 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-wasm-framework/</guid>
      <description>
        
        
        &lt;p&gt;ä½œä¸ºé‡‘èçº§æœåŠ¡ç½‘æ ¼ä¸­çš„æµé‡ä»£ç†ç»„ä»¶ï¼ŒMOSN åœ¨æ‰¿è½½èš‚èšæ•°åä¸‡æœåŠ¡å®¹å™¨ä¹‹é—´æµé‡çš„åŒæ—¶ï¼Œä¹Ÿæ‰¿è½½ç€è¯¸å¤šä¾‹å¦‚é™æµã€é‰´æƒã€è·¯ç”±ç­‰ä¸­é—´ä»¶åŸºç¡€èƒ½åŠ›ã€‚è¿™äº›èƒ½åŠ›ä»¥ä¸åŒçš„æ‰©å±•å½¢å¼ä¸ MOSN è¿è¡ŒäºåŒä¸€è¿›ç¨‹å†…ã€‚ééš”ç¦»çš„è¿è¡Œæ–¹å¼åœ¨ä¿éšœæ€§èƒ½çš„åŒæ—¶ï¼Œå´ä¹Ÿç»™ MOSN å¸¦æ¥äº†ä¸å¯é¢„çŸ¥çš„å®‰å…¨é£é™©ã€‚&lt;/p&gt;
&lt;p&gt;é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨ WebAssembly(Wasm) æŠ€æœ¯ï¼Œç»™ MOSN å®ç°äº†ä¸€ä¸ªå®‰å…¨éš”ç¦»çš„æ²™ç®±ç¯å¢ƒï¼Œè®©æ‰©å±•ç¨‹åºèƒ½å¤Ÿè¿è¡Œåœ¨éš”ç¦»æ²™ç®±ä¹‹ä¸­ï¼Œå¹¶å¯¹å…¶èµ„æºã€èƒ½åŠ›è¿›è¡Œä¸¥æ ¼é™åˆ¶ï¼Œä½¿ç¨‹åºæ•…éšœæ­¢æ­¥äºæ²™ç®±ï¼Œä»è€Œå®ç°å®‰å…¨éš”ç¦»çš„ç›®æ ‡ã€‚æœ¬æ–‡å°†ç€é‡å™è¿° MOSN ä¸­çš„ Wasm æ‰©å±•æ¡†æ¶ï¼Œå¹¶ä»‹ç»æˆ‘ä»¬åœ¨ Proxy-Wasm è¿™ä¸€ä»£ç†æ‰©å±•è§„èŒƒä¸Šçš„å·¥ä½œã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ä½“è®¾è®¡&#34;&gt;æ€»ä½“è®¾è®¡&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;framework.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾ä¸º MOSN Wasm æ‰©å±•æ¡†æ¶çš„æ•´ä½“ç¤ºæ„å›¾ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œå¯¹äº MOSN çš„ä»»æ„æ‰©å±•ç‚¹(Codecã€NetworkFilterã€StreamFilter ç­‰)ï¼Œç”¨æˆ·å‡èƒ½å¤Ÿé€šè¿‡ Wasm æ‰©å±•æ¡†æ¶ï¼Œä»¥éš”ç¦»æ²™ç®±çš„å½¢å¼è¿è¡Œè‡ªå®šä¹‰çš„æ‰©å±•ä»£ç ã€‚è€Œ MOSN ä¸ Wasm æ‰©å±•ä»£ç ä¹‹é—´çš„äº¤äº’ï¼Œæ˜¯é€šè¿‡ Proxy-Wasm æ ‡å‡† ABI æ¥å®Œæˆçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;éš”ç¦»æ²™ç®±&#34;&gt;éš”ç¦»æ²™ç®±&lt;/h3&gt;
&lt;p&gt;å½“æˆ‘ä»¬åœ¨è®¨è®º Wasm æ—¶ï¼Œéƒ½æ˜ç™½ Wasm èƒ½å¤Ÿæä¾›ä¸€ä¸ªå®‰å…¨éš”ç¦»çš„æ²™ç®±ç¯å¢ƒï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½äº†è§£ Wasm å®ç°éš”ç¦»æ²™ç®±çš„æŠ€æœ¯åŸç†ã€‚è¿™æ—¶åˆè¦æ¬å‡ºè®¡ç®—æœºç§‘å­¦ä¸­çš„è‡³ç†åè¨€: â€œè®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³â€ã€‚Wasm å®é™…ä¸Šä¹Ÿæ˜¯é€šè¿‡å¼•ç”¨ä¸€ä¸ªâ€œä¸­é—´å±‚â€æ¥å®ç°çš„å®‰å…¨éš”ç¦»ã€‚ç®€å•æ¥è¯´ï¼ŒWasm é€šè¿‡ä¸€ä¸ªè¿è¡Œæ—¶(Runtime)æ¥è¿è¡Œ Wasm æ²™ç®±æ‰©å±•ï¼Œæ¯ä¸ª Wasm æ²™ç®±éƒ½æœ‰å…¶ç‹¬ç«‹çš„çº¿æ€§å†…å­˜ç©ºé—´å’Œä¸€ç»„å¯¼å…¥/å¯¼å‡ºæ¨¡å—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;wasm-memory.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸€æ–¹é¢ï¼Œæ¯ä¸ª Wasm æ²™ç®±éƒ½æœ‰å…¶ç‹¬ç«‹çš„çº¿æ€§å†…å­˜ç©ºé—´ï¼Œå…¶å†…å­˜æ¨¡å‹å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚Wasm ä»£ç åªèƒ½é€šè¿‡ç®€å•çš„ load/store ç­‰æŒ‡ä»¤è®¿é—®çº¿æ€§å†…å­˜ç©ºé—´çš„æœ‰é™éƒ¨åˆ†ï¼Œå¹¶é€šè¿‡ç¬¦å·(ä¸‹æ ‡)çš„æ–¹å¼æ¥é—´æ¥è®¿é—®å‡½æ•°ã€å…¨å±€å˜é‡ç­‰ï¼Œæœç»äº†ç±»ä¼¼ C è¯­è¨€ä¸­è®¿é—®ä»»æ„å†…å­˜åœ°å€çš„éªšæ“ä½œã€‚åŒæ—¶ï¼Œç”¨äºé—´æ¥è°ƒç”¨å‡½æ•°çš„ç¬¦å·è¡¨å¯¹äº Wasm ä»£ç è€Œè¨€æ˜¯åªè¯»çš„ï¼Œä»è€Œä¿è¯ Wasm ä»£ç çš„æ‰§è¡Œæ˜¯å—æ§çš„ã€‚æ­¤å¤–ï¼ŒWasm æ²™ç®±çš„æ•´ä¸ªçº¿æ€§å†…å­˜ç©ºé—´ç”±å®¿ä¸»æœº(Wasm Runtime)åˆ†é…åŠç®¡ç†ï¼Œé€šè¿‡ä¸¥æ ¼çš„å†…å­˜ç®¡ç†ä¿è¯æ²™ç®±çš„éš”ç¦»æ€§ã€‚&lt;/p&gt;
&lt;p&gt;å¦ä¸€æ–¹é¢ï¼ŒWasm ä¹Ÿè§„å®šäº†ä»£ç ä¸­ä»»ä½•å¯èƒ½äº§ç”Ÿå¤–éƒ¨å½±å“çš„æ“ä½œåªèƒ½é€šè¿‡å¯¼å…¥/å¯¼å‡ºæ¨¡å—æ¥å®ç°ã€‚ä»¥ C è¯­è¨€ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥è®¿é—®ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€æ–‡ä»¶ã€ç½‘ç»œç­‰èµ„æºã€‚è€Œåœ¨ Wasm çš„ä¸–ç•Œä¸­ï¼Œå¹¶ä¸å­˜åœ¨ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„æŒ‡ä»¤ï¼Œä»»ä½•å¯¹å¤–éƒ¨èµ„æºçš„è®¿é—®å¿…é¡»é€šè¿‡å¯¼å…¥æ¨¡å—æ¥é—´æ¥å®ç°ã€‚ä»¥æ–‡ä»¶è¯»å†™ä¸ºä¾‹ï¼Œåœ¨ Wasm ä¸­è¦æƒ³è¿›è¡Œæ–‡ä»¶è¯»å†™ï¼Œéœ€è¦å®¿ä¸»æœºæä¾›å®ç°æ–‡ä»¶è¯»å†™åŠŸèƒ½çš„å¯¼å…¥å‡½æ•°ï¼ŒWasm ä»£ç è°ƒç”¨è¯¥å¯¼å…¥å‡½æ•°ï¼Œç”±å®¿ä¸»æœºé—´æ¥è¿›è¡Œæ–‡ä»¶è¯»å†™ï¼Œå†å°†æ“ä½œç»“æœè¿”å›ç»™ Wasm æ‰©å±•ã€‚åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå®é™…çš„æ–‡ä»¶è¯»å†™æ“ä½œç”±å®¿ä¸»æœºå®Œæˆï¼Œå®¿ä¸»æœºå¯¹è¿™ä¸€è¿‡ç¨‹æœ‰ç»å¯¹çš„æ§åˆ¶æƒï¼ŒåŒ…æ‹¬ä½†ä¸é™äºåªå…è®¸è¯»å†™æŒ‡å®šæ–‡ä»¶ã€é™åˆ¶è¯»å†™å†…å®¹ã€å®Œå…¨ç¦æ­¢è¯»å†™ç­‰ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ‰©å±•æ¡†æ¶&#34;&gt;æ‰©å±•æ¡†æ¶&lt;/h3&gt;
&lt;p&gt;MOSN ä»¥ æ’ä»¶(Plugin) çš„å½¢å¼å¯¹ Wasm æ‰©å±•è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæ’ä»¶æ˜¯æŒ‡ä¸€ç»„ Wasm æ²™ç®±å®ä¾‹åŠå…¶ç›¸åº”é…ç½®çš„é›†åˆã€‚ç”¨æˆ·é€šè¿‡é…ç½®æ¥åŠ è½½ã€æ›´æ–°ä»¥åŠå¸è½½ Wasm æ’ä»¶ï¼Œå¹¶é€šè¿‡é…ç½®æ¥æè¿°æ²™ç®±å®ä¾‹çš„è¿è¡Œè§„æ ¼(ä½¿ç”¨çš„æ‰§è¡Œå¼•æ“ã€Wasm æ–‡ä»¶è·¯å¾„ã€å®ä¾‹æ•°é‡ç­‰)ã€‚ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ Wasm æ’ä»¶é…ç½®:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;plugin_name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;global_plugin_id&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;    &lt;span style=&#34;color:#a40000&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;1.&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;æ’ä»¶å&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;instance_num&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;                    &lt;span style=&#34;color:#a40000&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;2.&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;æ²™ç®±å®ä¾‹ä¸ªæ•°&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;vm_config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;engine&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;wasmer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;                 &lt;span style=&#34;color:#a40000&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;3.&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;ä½¿ç”¨çš„è™šæ‹Ÿæœº(Runtime)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/foo/bar.wasm&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;            &lt;span style=&#34;color:#a40000&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;4.&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;wasm&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;æ–‡ä»¶è·¯å¾„&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;url&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;http://xxx/bar.wasm&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å½“ MOSN åŠ è½½ä¸Šè¿°æ’ä»¶é…ç½®æ—¶ï¼Œä¼šæŒ‰ç…§ä»¥ä¸‹æµç¨‹ç”Ÿæˆæ’ä»¶å¯¹åº”çš„ Wasm æ²™ç®±å®ä¾‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;config.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨åç»­è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·é€šè¿‡ Wasm æ‰©å±•æ¡†æ¶è·å–æŒ‡å®šæ’ä»¶çš„æ²™ç®±å®ä¾‹ï¼Œ ç„¶åé€šè¿‡æ²™ç®±å®ä¾‹æš´éœ²çš„ API ä¸æ‰©å±•ç¨‹åºè¿›è¡Œäº¤äº’ã€‚æœ¬æ–‡çš„ä¸‹ä¸€å°èŠ‚å°†å¯¹æ­¤äº¤äº’è¿‡ç¨‹è¿›è¡Œè¯¦ç»†æè¿°ã€‚åœ¨ MOSN ä¸­ï¼ŒWasm æ‰©å±•æ¡†æ¶ä¸å…·ä½“ç”¨é€”æ— å…³ï¼Œåœ¨ MOSN å·²æœ‰çš„ä»»ä½•ä¸€å¤„æ‰©å±•ç‚¹ï¼Œå‡å¯ä»¥ç›´æ¥ä½¿ç”¨ Wasm æ¡†æ¶æ¥è·å–å®‰å…¨éš”ç¦»çš„æ’ä»¶æ‰§è¡Œèƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒWasm æ‰©å±•æ¡†æ¶ä¸»è¦åˆ†ä¸º Managerã€VM å’Œ ABI ä¸‰ä¸ªå­æ¨¡å—ã€‚å…¶ä¸­&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Manager æ¨¡å—è´Ÿè´£å¯¹ Wasm æ’ä»¶çš„é…ç½®è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œæä¾›æ’ä»¶çš„å¢åˆ æŸ¥æ”¹åŠŸèƒ½ï¼Œè´Ÿè´£å°†ç”¨æˆ·æä¾›çš„é…ç½®æ¸²æŸ“æˆæœ€ç»ˆçš„ Wasm æ²™ç®±å®ä¾‹&lt;/li&gt;
&lt;li&gt;VM æ¨¡å—æä¾›å¯¹ Wasm Runtime(è™šæ‹Ÿæœº) çš„ç»Ÿä¸€å°è£…ï¼Œè´Ÿè´£ .wasm æ–‡ä»¶çš„ç¼–è¯‘ã€æ‰§è¡Œï¼Œä»¥åŠ Wasm æ²™ç®±å®ä¾‹çš„èµ„æºç®¡ç†&lt;/li&gt;
&lt;li&gt;ABI æ¨¡å—åˆ™æä¾›å¯¹å¤–çš„ä½¿ç”¨æ¥å£ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ MOSN ä¸ Wasm æ‰©å±•ä»£ç ä¹‹é—´äº¤äº’çš„èƒ¶æ°´å±‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;wasm-framework.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä¸å†å¯¹æ¡†æ¶å†…çš„å…·ä½“å­æ¨¡å—è¿›è¡Œä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»å¼€æº &lt;a href=&#34;https://github.com/mosn/mosn/pull/1589&#34;&gt;PR&lt;/a&gt; çš„æ–‡æ¡£äº†è§£ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äºå½“å‰å¸‚é¢ä¸Šå‡ ä¹ä¸å­˜åœ¨ä½¿ç”¨ Go è¯­è¨€ç›´æ¥ç¼–å†™çš„ Wasm Runtimeï¼Œå› æ­¤ MOSN åªèƒ½é€šè¿‡ CGO è°ƒç”¨çš„æ–¹å¼æ¥é—´æ¥åœ°è°ƒç”¨ç”± C++/Rust ç¼–å†™çš„ Wasm æ‰§è¡Œå¼•æ“ã€‚æˆ‘ä»¬ä» SDK å®Œå–„ç¨‹åº¦ã€æ€§èƒ½ã€é¡¹ç›®æ´»è·ƒåº¦ç­‰è§’åº¦ç»¼åˆè€ƒè™‘ï¼Œç»è¿‡ä¸€ç³»åˆ—æ¨ªå‘å¯¹æ¯”ä¹‹åï¼Œé€‰æ‹©äº† Wasmer ä½œä¸º MOSN é»˜è®¤çš„æ‰§è¡Œå¼•æ“ã€‚&lt;/p&gt;
&lt;h3 id=&#34;proxy-wasm-abi-è§„èŒƒ&#34;&gt;Proxy-Wasm ABI è§„èŒƒ&lt;/h3&gt;
&lt;p&gt;æœ¬å°èŠ‚å°†ä»‹ç» MOSN å…·ä½“æ˜¯å¦‚ä½•è·Ÿ Wasm æ‰©å±•ç¨‹åºè¿›è¡Œäº¤äº’çš„ã€‚å…ˆè¯´ç»“è®º: MOSN è·Ÿ Wasm æ‰©å±•ä»£ç ä¹‹é—´çš„äº¤äº’é‡‡ç”¨çš„æ˜¯ç¤¾åŒºè§„èŒƒ: Proxy-Wasm&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/proxy-wasm/spec&#34;&gt;Proxy-Wasm&lt;/a&gt; æ˜¯å¼€æºç¤¾åŒºé’ˆå¯¹ã€Œç½‘ç»œä»£ç†åœºæ™¯ã€è®¾è®¡çš„ä¸€å¥— ABI è§„èŒƒï¼Œå±äºå½“å‰çš„äº‹å®è§„èŒƒã€‚å½“å‰æ”¯æŒè¯¥è§„èŒƒçš„ç½‘ç»œä»£ç†è½¯ä»¶åŒ…æ‹¬ Envoyã€MOSN å’Œ ATS(Apache Traffic Server)ï¼Œæ”¯æŒè¯¥è§„èŒƒçš„ Wasm æ‰©å±• SDK åŒ…æ‹¬ C++ã€Rust å’Œ Goã€‚é‡‡ç”¨è¯¥è§„èŒƒçš„å¥½å¤„åœ¨äºèƒ½è®© MOSN å¤ç”¨ç¤¾åŒºæ—¢æœ‰çš„ Wasm æ‰©å±• (åŒ…æ‹¬ Go å®ç°ä»¥åŠ C++/Rust å®ç°)ï¼Œä¹Ÿèƒ½è®©æœ¬ä¸º MOSN å¼€å‘çš„ Wasm æ‰©å±•è¿è¡Œåœ¨ Envoy ç­‰ç½‘ç»œä»£ç†äº§å“ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;Proxy-Wasm è§„èŒƒå®šä¹‰äº†å®¿ä¸»æœºä¸ Wasm æ‰©å±•ç¨‹åºä¹‹é—´çš„äº¤äº’ç»†èŠ‚ï¼ŒåŒ…æ‹¬ API åˆ—è¡¨ã€å‡½æ•°è°ƒç”¨è§„èŒƒä»¥åŠæ•°æ®ä¼ è¾“è§„èŒƒè¿™å‡ ä¸ªæ–¹é¢ã€‚å…¶ä¸­ï¼ŒAPI åˆ—è¡¨åŒ…å«äº† L4/L7ã€propertyã€metricsã€æ—¥å¿—ç­‰æ–¹é¢çš„æ‰©å±•ç‚¹ï¼Œæ¶µç›–äº†ç½‘ç»œä»£ç†åœºæ™¯ä¸‹æ‰€éœ€çš„å¤§éƒ¨åˆ†äº¤äº’ç‚¹ï¼Œä¸”å¯ä»¥åˆ’åˆ†ä¸ºå®¿ä¸»ä¾§æ‰©å±•å’Œ Wasm ä¾§æ‰©å±•ç‚¹ã€‚è¿™é‡Œç®€å•å±•ç¤ºè§„èŒƒä¸­çš„éƒ¨åˆ†å†…å®¹ï¼Œå®Œæ•´å†…å®¹è¯·å‚è€ƒ specã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Functions implemented in the Wasm module
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç”± Wasm ä¾§å®ç°çš„æ‰©å±•ç‚¹
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// L7:
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_on_http_request_headers&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;params&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;uint32_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context_id&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;num_headers&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;end_of_stream&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;returns&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_action_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next_action&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// L4:
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_on_downstream_data&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;params&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;uint32_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context_id&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data_size&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;end_of_stream&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;returns&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_action_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next_action&lt;/span&gt;


&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Functions implemented in the host environment
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç”±å®¿ä¸»ä¾§å®ç°çš„æ‰©å±•ç‚¹
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ—¥å¿—
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_log&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;params&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_log_level_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log_level&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;char&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;message_data&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;message_size&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;returns&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_result_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;call_result&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_get_map&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;params&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_map_type_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;map_type&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;char&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;return_map_data&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size_t&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;return_map_size&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;returns&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;i32&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy_result_t&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;call_result&lt;/span&gt;


&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// MapData Format
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Map æ•°æ®ä¼ è¾“è§„èŒƒ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mapsize&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;key1size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value1size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;key2size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value2size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;key1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;\&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;\&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è§„èŒƒçš„å®ç°éœ€è¦å®¿ä¸»ä¾§å’Œ Wasm ä¾§ä¸¤è¾¹é…åˆæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å¯¹äº Wasm ä¾§ï¼Œç¤¾åŒºå·²ç»æœ‰ C++ã€Rust å’Œ Go ä¸‰ç§è¯­è¨€å®ç°çš„ SDKï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº› SDK æ¥ç¼–å†™ä¸å®¿ä¸»æ— å…³çš„ Wasm æ‰©å±•ç¨‹åºã€‚è€Œå¯¹äºå®¿ä¸»ä¾§ï¼Œç¤¾åŒºåªæä¾›äº† C++ å’Œ Rust çš„å®¿ä¸»ä¾§å®ç°ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Go è¯­è¨€å¯¹ Proxy-Wasm è§„èŒƒçš„å®¿ä¸»ä¾§è¿›è¡Œäº†å®ç°ï¼Œå¹¶å°†å…¶è´¡çŒ®ç»™å¼€æºç¤¾åŒºï¼Œä½¿ä¹‹æˆä¸ºç¤¾åŒºæ¨èçš„ &lt;a href=&#34;https://github.com/mosn/proxy-wasm-go-host&#34;&gt;Go-Host&lt;/a&gt; å®ç°ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå®¿ä¸»ä¾§å®ç°å¹¶ä¸ä¾èµ–å…·ä½“çš„ç½‘ç»œä»£ç†ç¨‹åºï¼Œç†è®ºä¸Šä»»ä½•ç›´æ¥é€šè¿‡ Host ç¨‹åºä¸ Wasm æ‰©å±•è¿›è¡Œäº¤äº’ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ä»¥ HTTP åœºæ™¯ä¸ºä¾‹ï¼Œä»‹ç»åœ¨ MOSN ä¸­æ˜¯å¦‚ä½•é€šè¿‡ Proxy-Wasm è§„èŒƒæ¥ä¸ Wasm æ‰©å±•ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œå¤„ç† HTTP è¯·æ±‚çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;proxy-wasm.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MOSN æ”¶åˆ° HTTP è¯·æ±‚æ—¶ï¼Œå°†è¯·æ±‚è§£ç æˆ Headerã€Bodyã€Trailer ä¸‰å…ƒç»„ç»“æ„ï¼ŒæŒ‰ç…§é…ç½®ä¾æ¬¡æ‰§è¡Œ StreamFilters&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œåˆ° Wasm StreamFilter æ—¶ï¼ŒMOSN å°†è¯·æ±‚ä¸‰å…ƒç»„ä¼ é€’ç»™ Proxy-Wasm å®¿ä¸»ä¾§å®ç° proxy-wasm-go-host&lt;/li&gt;
&lt;li&gt;å®¿ä¸»ä¾§ go-host å°† MOSN è¯·æ±‚ä¸‰å…ƒç»„ç¼–ç æˆè§„èŒƒæŒ‡å®šçš„æ ¼å¼ï¼Œå¹¶è°ƒç”¨è§„èŒƒä¸­çš„ proxy_on_request_headers ç­‰æ¥å£ï¼Œå°†è¯·æ±‚ä¿¡æ¯ä¼ é€’è‡³ Wasm ä¾§&lt;/li&gt;
&lt;li&gt;Wasm ä¾§ SDK å°†è¯·æ±‚æ•°æ®ä»è§„èŒƒæ ¼å¼è½¬æ¢ä¸ºä¾¿äºç”¨æˆ·ä½¿ç”¨çš„æ ¼å¼ï¼Œéšåè°ƒç”¨ç”¨æˆ·ç¼–å†™çš„æ‰©å±•ä»£ç &lt;/li&gt;
&lt;li&gt;ç”¨æˆ·ä»£ç è¿”å›ï¼ŒWasm ä¾§å°†è¿”å›ç»“æœæŒ‰è§„èŒƒæ ¼å¼ä¼ é€’å› MOSN ä¾§&lt;/li&gt;
&lt;li&gt;MOSN ç»§ç»­æ‰§è¡Œåç»­ StreamFilter&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å·¥ç¨‹å®è·µ&#34;&gt;å·¥ç¨‹å®è·µ&lt;/h2&gt;
&lt;h3 id=&#34;quick-start&#34;&gt;Quick Start&lt;/h3&gt;
&lt;p&gt;æœ¬å°èŠ‚ä¸»è¦æ¼”ç¤ºå¦‚ä½•åœ¨ MOSN ä¸­è¿›è¡Œé…ç½®å¹¶è¿è¡Œ Wasm æ‰©å±•æ’ä»¶æµç¨‹ã€‚æ¼”ç¤ºæ‰€éœ€çš„æºæ–‡ä»¶å‚è€ƒ exampleã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬é€šè¿‡é…ç½®è®© Wasm æ‰©å±•æ’ä»¶æ¥å¤„ç† MOSN æ¥æ”¶çš„ HTTP è¯·æ±‚ï¼ŒMOSN çš„ç›‘å¬ç«¯å£ä¸º 2045ã€‚åœ¨ Wasm å¤„ç†è¯·æ±‚çš„æºç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Proxy-Wasm è§„èŒƒä¸­çš„ proxy_dispatch_http_call æ¥å£å‘å¤–éƒ¨ HTTP æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼ŒWasm æºç å†…æŒ‡å®šå¤–éƒ¨ HTTP æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£ä¸º 2046ã€‚æ¼”ç¤ºåœºæ™¯çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;example.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¯¥æ¼”ç¤ºæµç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°†æ‰©å±•ç¨‹åºç¼–è¯‘æˆ .wasm æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;å¯åŠ¨ MOSN å¹¶åŠ è½½ Wasm æ’ä»¶&lt;/li&gt;
&lt;li&gt;å¯åŠ¨å¤–éƒ¨ HTTP æœåŠ¡å™¨&lt;/li&gt;
&lt;li&gt;è¯·æ±‚éªŒè¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;1-ç¼–è¯‘-wasm-æ‰©å±•ç¨‹åº&#34;&gt;1. ç¼–è¯‘ Wasm æ‰©å±•ç¨‹åº&lt;/h4&gt;
&lt;p&gt;æˆ‘ä»¬åœ¨ç¤ºä¾‹å·¥ç¨‹ä¸­æä¾›äº† C å’Œ Go ä¸¤ç§è¯­è¨€å®ç°çš„ Wasm æ‰©å±•æºç ï¼Œå¯¹ Proxy-Wasm è§„èŒƒçš„é‡‡ç”¨ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨å¤šç§è¯­è¨€ (C++/Rust/Go) æ¥ç¼–å†™ Wasm æ‰©å±•ä»£ç ã€‚å‡ºäºç¼–è¯‘çš„ä¾¿åˆ©æ€§ï¼Œè¿™é‡Œä½¿ç”¨ Go æºç å®ç°è¿›è¡Œæ¼”ç¤ºã€‚
è¿›å…¥ example/wasm/httpCall ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;make
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šè¿°æ“ä½œä¼šå°†ç›®å½•ä¸‹çš„ filter-go.go æºç æ–‡ä»¶ç¼–è¯‘æˆ filter-go.wasm æ–‡ä»¶&lt;/p&gt;
&lt;h4 id=&#34;2-å¯åŠ¨-mosn&#34;&gt;2. å¯åŠ¨ MOSN&lt;/h4&gt;
&lt;p&gt;ç¤ºä¾‹å·¥ç¨‹æä¾›äº†ä¸€ä»½åŠ è½½ filter-go.wasm æ‰©å±•æ–‡ä»¶çš„é…ç½®ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å³å¯å¯åŠ¨:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;./mosn start -c config.json
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šè¿°å‘½ä»¤ä¸­ä½¿ç”¨çš„ MOSN å¯æ‰§è¡Œç¨‹åºå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç”±æºç æ„å»º:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# step 1: &lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# åˆ›å»ºæºç è·¯å¾„&lt;/span&gt;
mkdir -p &lt;span style=&#34;color:#000&#34;&gt;$GOPATH&lt;/span&gt;/src/mosn.io
&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;$GOPATH&lt;/span&gt;/src/mosn.io

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# step 2: &lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ä¸‹è½½ MOSN ä»£ç ä»“åº“&lt;/span&gt;
git clone https://github.com/mosn/mosn.git 

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# step 3: &lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ç¼–è¯‘ï¼Œä»¥ä¸‹å‘½ä»¤æœ€ç»ˆå°†äº§ç”Ÿ mosn å¯æ‰§è¡Œæ–‡ä»¶&lt;/span&gt;
sudo make build-local &lt;span style=&#34;color:#000&#34;&gt;tags&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;wasmer
mv build/bundles/v0.21.0/binary/mosn mosn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;3-å¯åŠ¨å¤–éƒ¨-http-æœåŠ¡å™¨&#34;&gt;3. å¯åŠ¨å¤–éƒ¨ HTTP æœåŠ¡å™¨&lt;/h4&gt;
&lt;p&gt;è¯¥ç¤ºä¾‹å·¥ç¨‹ä¸­ï¼ŒWasm æ‰©å±•æºç ä¼šé€šè¿‡ MOSN å‘å¤–éƒ¨ HTTP æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚çš„ URL ä¸º&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;http://127.0.0.1:2046/&#34;&gt;http://127.0.0.1:2046/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸ºæ­¤ï¼Œç¤ºä¾‹å·¥ç¨‹ä¹Ÿæä¾›äº†ä¸€æ®µ HTTP æœåŠ¡å™¨ä»£ç ï¼Œå½“å…¶æ”¶åˆ° HTTP è¯·æ±‚æ—¶ï¼Œå‡ä¼šè¿”å›å“åº”å¤´: from: external http serverï¼Œè¿”å›å“åº”ä½“: response body from external http server
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†å¯åŠ¨ä¸Šè¿° HTTP æœåŠ¡å™¨:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go run server.go
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;4-è¯·æ±‚éªŒè¯&#34;&gt;4. è¯·æ±‚éªŒè¯&lt;/h4&gt;
&lt;p&gt;ä¸Šè¿°æ“ä½œå‡†å¤‡å°±ç»ªåï¼Œä¾¿å¯é€šè¿‡ Curl æ¥è¿›è¡Œè¯·æ±‚éªŒè¯äº†&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;curl -v http://127.0.0.1:2045/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼ŒMOSN ç»ˆç«¯å°†èƒ½å¤Ÿè§‚å¯Ÿåˆ°ä»¥ä¸‹æ—¥å¿—:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; response header from http://127.0.0.1:2046/: From: external http server
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; response header from http://127.0.0.1:2046/: Date: Wed, &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;17&lt;/span&gt; Mar &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2021&lt;/span&gt; 12:12:38 GMT
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; response header from http://127.0.0.1:2046/: Content-Length: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;39&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; response header from http://127.0.0.1:2046/: Content-Type: text/plain&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;charset&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;utf-8
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;INFO&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; response body from http://127.0.0.1:2046/: response body from external http server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æ€§èƒ½æµ‹è¯•&#34;&gt;æ€§èƒ½æµ‹è¯•&lt;/h3&gt;
&lt;p&gt;æœ¬å°èŠ‚å¯¹ Wasm æ¡†æ¶çš„æ€§èƒ½è¿›è¡Œæµ‹è¯•&lt;/p&gt;
&lt;h4 id=&#34;æµ‹è¯•ç¯å¢ƒ&#34;&gt;æµ‹è¯•ç¯å¢ƒ:&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;OS: macOS Catalina 10.15.4&lt;/li&gt;
&lt;li&gt;CPU: Intel(R) Core(TM) i7-7660U CPU @ 2.50GHz 4Core&lt;/li&gt;
&lt;li&gt;MEM: 16 GB 2133 MHz LPDDR3&lt;/li&gt;
&lt;li&gt;Go Version: go1.14.13 darwin/amd64&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;æµ‹è¯•åœºæ™¯&#34;&gt;æµ‹è¯•åœºæ™¯:&lt;/h4&gt;
&lt;p&gt;æ‹“æ‰‘: client  &amp;ndash;http1.1&amp;ndash;&amp;gt;  MOSN
æ“ä½œ: MOSN æ”¶åˆ° H1 è¯·æ±‚åï¼Œå¾€è¯·æ±‚å¤´ä¸­æ·»åŠ ä¸€ä¸ª Header éšåè¿”å› 200&lt;/p&gt;
&lt;h4 id=&#34;æµ‹è¯•æ•°æ®&#34;&gt;æµ‹è¯•æ•°æ®:&lt;/h4&gt;
&lt;p&gt;ã€Œnativeã€è¡¨ç¤ºæ·»åŠ  Header çš„æ“ä½œä½¿ç”¨ MOSN åŸç”Ÿçš„ Stream Filter å®Œæˆï¼›&lt;/p&gt;
&lt;p&gt;ã€Œwasmã€è¡¨ç¤ºæ·»åŠ  Header çš„æ“ä½œä½¿ç”¨ Wasm æ‰©å±•å®Œæˆ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å›ºå®š QPS æ¨¡å¼ï¼Œå°† QPS å›ºå®šä¸º 2000 è¿›è¡Œå‹æµ‹&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;å‹æµ‹å‘½ä»¤: sofaload &amp;ndash;h1 -c 100 -t 4 &amp;ndash;qps=2000 -D 30 &lt;a href=&#34;http://127.0.0.1:2045/&#34;&gt;http://127.0.0.1:2045/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;qps&lt;/th&gt;
&lt;th&gt;avg&lt;/th&gt;
&lt;th&gt;P75&lt;/th&gt;
&lt;th&gt;P90&lt;/th&gt;
&lt;th&gt;P99&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;native&lt;/td&gt;
&lt;td&gt;2000&lt;/td&gt;
&lt;td&gt;698us&lt;/td&gt;
&lt;td&gt;856us&lt;/td&gt;
&lt;td&gt;1.09ms&lt;/td&gt;
&lt;td&gt;1.87ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;wasm&lt;/td&gt;
&lt;td&gt;2000&lt;/td&gt;
&lt;td&gt;763us&lt;/td&gt;
&lt;td&gt;940us&lt;/td&gt;
&lt;td&gt;1.21ms&lt;/td&gt;
&lt;td&gt;2.35ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;-9.3%&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;å‹æµ‹æ¨¡å¼ï¼Œä¸é™åˆ¶å‹æµ‹ QPSï¼Œå°†æµé‡æ‰“åˆ°æœ€å¤§&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;å‹æµ‹å‘½ä»¤: sofaload &amp;ndash;h1 -c 100 -t 4 -n 1000000 &lt;a href=&#34;http://127.0.0.1:2045/&#34;&gt;http://127.0.0.1:2045/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;qps&lt;/th&gt;
&lt;th&gt;avg&lt;/th&gt;
&lt;th&gt;P75&lt;/th&gt;
&lt;th&gt;P90&lt;/th&gt;
&lt;th&gt;P99&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;native&lt;/td&gt;
&lt;td&gt;36013&lt;/td&gt;
&lt;td&gt;2.78msÂ &lt;/td&gt;
&lt;td&gt;3.80ms&lt;/td&gt;
&lt;td&gt;5.44ms&lt;/td&gt;
&lt;td&gt;10.39ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;wasm&lt;/td&gt;
&lt;td&gt;26542&lt;/td&gt;
&lt;td&gt;3.77ms&lt;/td&gt;
&lt;td&gt;5.14ms&lt;/td&gt;
&lt;td&gt;7.42ms&lt;/td&gt;
&lt;td&gt;14.00ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;-26%&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;å¼‚å¸¸è°ƒè¯•&#34;&gt;å¼‚å¸¸è°ƒè¯•&lt;/h3&gt;
&lt;p&gt;å¯¹äºå®é™…çš„å·¥ç¨‹é¡¹ç›®è€Œè¨€ï¼Œå…‰èƒ½è¿è¡Œæ˜¯ä¸å¤Ÿçš„ï¼Œå¿…é¡»å…·å¤‡ä¸€å®šçš„é—®é¢˜æ’æŸ¥å’Œå®šä½èƒ½åŠ›ï¼Œæ‰èƒ½åœ¨é‡åˆ°ç¨‹åºæ•…éšœæ—¶ï¼Œè§£æå¼‚å¸¸æºç çš„è°ƒç”¨å †æ ˆï¼Œå¿«é€Ÿå®šä½ç¬¬ä¸€ç°åœºï¼Œä»è€Œæé«˜å¼€å‘åŠè°ƒè¯•çš„æ•ˆç‡ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äº Wasm æœ¬èº«çš„å®šä½æ˜¯ä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„å­—èŠ‚ç è§„èŒƒï¼Œä¸åŒè¯­è¨€çš„æºä»£ç  (C++/Go/JavaScript ç­‰) å‡èƒ½å¤Ÿç¼–è¯‘ä¸ºç»Ÿä¸€çš„ Wasm å­—èŠ‚ç ï¼Œå› æ­¤å¦‚ä½•å±è”½å…·ä½“ç¼–ç¨‹è¯­è¨€çš„ç»†èŠ‚æ¨¡å‹ï¼Œåˆ¶å®šè¯­è¨€æ— å…³çš„è°ƒè¯•ä¿¡æ¯è§„èŒƒï¼Œæ˜¯ç¤¾åŒºéœ€è¦è§£å†³çš„éš¾é¢˜ä¹‹ä¸€ã€‚
é’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼Œåœ¨å½“å‰çš„å·¥ç¨‹å®è·µä¸­ï¼ŒJavaScript è¯­è¨€é‡‡ç”¨çš„æ˜¯ Source Map æ ¼å¼ï¼Œè€Œ C++ã€Rust å’Œ Go è¯­è¨€é‡‡ç”¨çš„æ˜¯ Dwarf æ ¼å¼çš„è°ƒè¯•ä¿¡æ¯ã€‚å¯¹å…·ä½“è°ƒè¯•ä¿¡æ¯æ ¼å¼çš„ä»‹ç»å¹¶ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´ä¹‹å†…ï¼Œè¯»è€…å¯è‡ªè¡Œå‚è€ƒå¤–éƒ¨æ–‡ç« ã€‚è¿™é‡Œéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå¯¹äº Wasm è€Œè¨€ï¼Œè¿˜éœ€è¦å¯¹è°ƒè¯•ä¿¡æ¯çš„æ ¼å¼è¿›è¡Œä¸€å®šçš„æ‰©å±•ï¼Œæ‰èƒ½æ»¡è¶³å®é™…çš„åº”ç”¨éœ€è¦ã€‚ä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸åŒçš„æ˜¯ï¼Œ.wasm æ–‡ä»¶æ˜¯èƒ½å¤Ÿè¢«è½¬æ¢æˆ .wat æ ¼å¼ï¼Œå¹¶æ‰‹åŠ¨ç¼–è¾‘å†…å®¹çš„ï¼Œç¼–è¯‘å¥½çš„ .wasm æ–‡ä»¶ä»ç„¶æœ‰ä¿®æ”¹æ®µå†…å®¹çš„å¯èƒ½ã€‚ä¸ºäº†é€‚åº”è¿™ç§åœºæ™¯ï¼ŒWasm è°ƒè¯•è§„èŒƒå¯¹ Dwarf æ ¼å¼ä¸­çš„ä½ç½®ä¿¡æ¯ç¼–ç è¿›è¡Œäº†è°ƒæ•´ï¼ŒæŒ‡ä»¤çš„åç§»å€¼è¢«è®¾ç½®æˆåŸºäº Code æ®µçš„åç§»:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;With WebAssembly, the .debug_line section maps Code section-relative instruction offsets to source locations.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨è§£ææŒ‡ä»¤åç§»æ—¶ï¼Œéœ€è¦åç§»æ•°å€¼è¿›è¡Œè°ƒæ•´ï¼Œå‡å» Code æ®µçš„åç§»é‡ï¼Œæ‰èƒ½å¾—åˆ° Wasm æŒ‡ä»¤çš„å®é™…åç§»å€¼ï¼Œè¿›è€Œåˆ©ç”¨ .debug_line æ®µå®šä½åˆ°å‡†ç¡®çš„æºç è¡Œã€‚ä¸‹å›¾å±•ç¤ºäº†åˆ©ç”¨ MOSN è¾“å‡ºçš„é”™è¯¯æ—¥å¿—å®šä½ Wasm æ•…éšœæºç è¡Œçš„ç¤ºä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;debug.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;å¯¹äºèš‚èšè€Œè¨€ï¼Œå®‰å…¨å¯ä¿¡æ°¸è¿œæ˜¯æˆ‘ä»¬è¿½æ±‚çš„ç›®æ ‡ï¼Œè€Œé¢å¯¹è¶Šæ¥è¶Šå¤šçš„æ‰©å±•åœºæ™¯ï¼ŒMOSN éœ€è¦ä¸€ä¸ªå®‰å…¨å¯é çš„éš”ç¦»ç¯å¢ƒï¼Œä»¥é¿å…æ‰©å±•ä»£ç ç»™ MOSN è¿è¡Œé€ æˆçš„å®‰å…¨é£é™©ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬é‡‡ç”¨ WebAssembly æŠ€æœ¯ï¼Œä¸º MOSN å®ç°äº†ä¸€ä¸ªåŸºäº Wasm éš”ç¦»æ²™ç®±çš„æ’ä»¶æ‰©å±•æ¡†æ¶ã€‚MOSN é‡‡ç”¨ç½‘ç»œä»£ç†ç¤¾åŒºä¸­çš„ Proxy-Wasm è§„èŒƒï¼Œå®ç°äº†è¯­è¨€æ— å…³ã€å®¿ä¸»æ— å…³çš„ç½‘ç»œä»£ç†æ‰©å±•èƒ½åŠ›ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå‘å¼€æºç¤¾åŒºè´¡çŒ®äº† Proxy-Wasm-Go-Host å®ç°ï¼Œç§¯æèå…¥å¼€æºç¤¾åŒºã€‚&lt;/p&gt;
&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰ WebAssembly æŠ€æœ¯ä»å¤„äºå‘å±•é˜¶æ®µï¼ŒGo è¯­è¨€è‡ªèº«å¯¹ WebAssenbly ç”Ÿæ€çš„æ”¯æŒä»æœ‰å·¨å¤§çš„æå‡ç©ºé—´ã€‚æˆ‘ä»¬åœ¨å®è·µçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ€»æ˜¯é¢ä¸´ Go è¯­è¨€åœ¨ Wasm ç”Ÿæ€ä¸­ä¸å¤Ÿç»™åŠ›çš„æƒ…å†µã€‚ç”±äº Go å®˜æ–¹ç¼–è¯‘å™¨è¿˜ä¸æ”¯æŒå°† Go æºç ç¨‹åºç¼–è¯‘æˆ WASI ç³»ç»Ÿæ¥å£ (GOOS=wasi) çš„ .wasm æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å€ŸåŠ© TinyGo æ¥å®Œæˆ Go æ‰©å±•ç¨‹åºçš„ç¼–è¯‘ï¼Œè€Œè¿™ä¹Ÿå¯¼è‡´æˆ‘ä»¬éœ€è¦é¢å¯¹ TinyGo åœ¨è¯­è¨€ç‰¹æ€§æ”¯æŒç¨‹åº¦ã€æ€§èƒ½ã€ç¨³å®šæ€§ç­‰æ–¹é¢ä¸è¶³çš„ç—›ç‚¹ã€‚ä¸ä¹‹ç›¸æ¯”ï¼ŒC++/Rust å¯¹ Wasm ç”Ÿæ€çš„æ”¯æŒç¨‹åº¦å°±è¦å®Œå–„å¾—å¤šã€‚&lt;/p&gt;
&lt;p&gt;æ€»è€Œè¨€ä¹‹ï¼ŒWebAssembly æŠ€æœ¯çš„å‡ºç°ä»ç„¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å¯å‘å’Œå¸Œæœ›ï¼Œä¿ƒä½¿æˆ‘ä»¬è¿›ä¸€æ­¥æ€è€ƒå¦‚ä½•åœ¨äº‘åŸç”Ÿæ—¶ä»£æ›´å¥½åœ°è·µè¡Œå®‰å…¨å¯ä¿¡è¿™ä¸€ä¿¡æ¡ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: åœ¨ MOSN ä¸­ç©è½¬ dubbo-go</title>
      <link>https://mosn.io/blog/posts/mosn-dubbo-integrate/</link>
      <pubDate>Mon, 15 Jun 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-dubbo-integrate/</guid>
      <description>
        
        
        &lt;h2 id=&#34;service-mesh-ç®€ä»‹&#34;&gt;Service Mesh ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;Service Mesh æœ¬èº«çš„ç†å¿µå¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯å°†ç°ä»£å¾®æœåŠ¡åº”ç”¨çš„åŠŸèƒ½æ€§ä¸éåŠŸèƒ½æ€§éœ€æ±‚è¿›è¡Œåˆ†ç¦»ï¼Œå¹¶å°†éåŠŸèƒ½æ€§éœ€æ±‚ä¸‹æ²‰åˆ°åº”ç”¨çš„å¤–éƒ¨æ¨¡å—ï¼Œä»è€Œä½¿åº”ç”¨æ¨¡å—å¯ä»¥å°½é‡èšç„¦äºä¸šåŠ¡ï¼Œä¸ç”¨å…³å¿ƒè¯¸å¦‚ï¼šæœåŠ¡å‘ç°ã€é™æµã€ç†”æ–­ã€tracing è¿™ç±»éä¸šåŠ¡éœ€æ±‚ã€‚ä¸‹æ²‰ä¹‹åï¼Œç›¸å…³çš„ Service Mesh æ¨¡å—å¯ä»¥äº¤ç”±åŸºç¡€æ¶æ„å›¢é˜Ÿè¿›è¡Œç»´æŠ¤ï¼Œä½¿åŸºç¡€è®¾æ–½å’Œä¸šåŠ¡èƒ½å¤Ÿå®Œæˆè§£è€¦ã€‚&lt;/p&gt;
&lt;p&gt;Service Mesh è®¾è®¡ä¸€èˆ¬åˆ’åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼Œæ§åˆ¶é¢å’Œæ•°æ®é¢ã€‚å¯ä»¥é€šè¿‡ä¸‹å›¾æ¥ç†è§£ç›¸åº”çš„èŒè´£ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./service-mesh-arch.png&#34; alt=&#34;Service Mesh&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºåº”ç”¨æ¥è¯´ï¼Œæ‰€æœ‰æµé‡éƒ½ä¼šç»è¿‡ Service Mesh ä¸­çš„æ•°æ®é¢è¿›è¡Œè½¬å‘ã€‚è€Œèƒ½é¡ºåˆ©è½¬å‘çš„å‰æï¼šæ•°æ®é¢éœ€è¦çŸ¥é“è½¬å‘çš„ç›®æ ‡åœ°å€ï¼Œç›®æ ‡åœ°å€æœ¬èº«æ˜¯ç”±ä¸€äº›ä¸šåŠ¡é€»è¾‘æ¥å†³å®šçš„(ä¾‹å¦‚æœåŠ¡å‘ç°)ï¼Œæ‰€ä»¥è‡ªç„¶è€Œç„¶åœ°ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­æ§åˆ¶é¢éœ€è¦è´Ÿè´£ç®¡ç†æ•°æ®é¢èƒ½æ­£å¸¸è¿è¡Œæ‰€éœ€è¦çš„ä¸€äº›é…ç½®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éœ€è¦çŸ¥é“æŸæ¬¡è¯·æ±‚è½¬å‘å»å“ªé‡Œï¼šæœåŠ¡å‘ç°é…ç½®&lt;/li&gt;
&lt;li&gt;å¤–éƒ¨æµé‡è¿›å…¥éœ€è¦åˆ¤æ–­æ˜¯å¦å·²ç»è¾¾åˆ°æœåŠ¡æµé‡ä¸Šé™ï¼šé™æµé…ç½®&lt;/li&gt;
&lt;li&gt;ä¾èµ–æœåŠ¡è¿”å›é”™è¯¯æ—¶ï¼Œéœ€è¦èƒ½å¤Ÿæ‰§è¡Œç›¸åº”çš„ç†”æ–­é€»è¾‘ï¼šç†”æ–­é…ç½®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¼€æºç•Œç›®å‰æ¯”è¾ƒæœ‰åçš„ä¸»è¦æ˜¯ istioï¼Œenvoy å’Œ linkerd è¿™å‡ ä¸ªé¡¹ç›®ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹èš‚èšæ¨å‡ºçš„ Service Mesh æ•°æ®é¢é¡¹ç›®ï¼šMOSNã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-ç®€ä»‹&#34;&gt;MOSN ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;MOSN æ˜¯èš‚èšé›†å›¢å‡ºå“çš„ç”¨ Go è¯­è¨€å®ç°çš„ Service Mesh æ•°æ®é¢ï¼Œåœ¨èš‚èšå†…éƒ¨å·²å¤§è§„æ¨¡è½åœ°ï¼Œåœ¨å¼€æºè¿‡ç¨‹ä¸­æˆ‘ä»¬äº†è§£åˆ°å¤–éƒ¨ç”¨æˆ·æœ‰è¾ƒå¤šçš„ dubbo ç”¨æˆ·ï¼Œè¿™äº› dubbo ç”¨æˆ·ä¹Ÿå¸Œæœ›èƒ½å¤Ÿäº«å— Service Mesh ç¤¾åŒºçš„å‘å±•çº¢åˆ©ã€‚åŒæ—¶å¯ä»¥é’ˆå¯¹è‡ªå·±å…¬å¸çš„ç‰¹æ®Šä¸šåŠ¡åœºæ™¯ï¼Œå¯¹ Service Mesh çš„æ•°æ®é¢è¿›è¡Œä¸€å®šçš„æ‰©å±•ã€‚&lt;/p&gt;
&lt;p&gt;è°ˆåˆ°æ‰©å±•ï¼ŒMOSN ä½¿ç”¨ Go ç¼–å†™çš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†ã€‚ç›¸æ¯” C++ï¼ŒGo è¯­è¨€é€šè¿‡è‡ªå¸¦çš„å†…å­˜åˆ†é…å™¨ä¸ GC å®ç°äº†ä¸€å®šç¨‹åº¦çš„å†…å­˜å®‰å…¨ï¼Œè§£æ”¾äº†ç¨‹åºå‘˜çš„å¿ƒæ™ºã€‚ç›¸æ¯” C++ ç¼–å†™çš„ envoyï¼Œæ— è®ºæ˜¯ç¼–ç¨‹å’Œé—®é¢˜å®šä½éƒ½è¦è½»æ¾ä¸å°‘ã€‚&lt;/p&gt;
&lt;p&gt;MOSN åŒæ—¶æä¾›äº†å¼ºå¤§çš„ XProtocol &lt;a href=&#34;https://mosn.iodocs/concept/multi-protocol/&#34;&gt;åè®®æ‰©å±•æ¡†æ¶&lt;/a&gt;ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¼–å†™è‡ªå®šä¹‰åè®®è§£æã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ SOFA/Dubbo/HTTP/HTTP2ï¼Œé‚£ä¹ˆ MOSN å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†ç°æˆçš„å®ç°ã€‚å¼€ç®±å³ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æ»¡è¶³ç¤¾åŒºçš„éœ€æ±‚ï¼Œä»ä»Šå¹´ 4 æœˆå¼€å§‹ï¼ŒMOSN ç¤¾åŒºä¸ dubbo-go ç¤¾åŒºè¿›è¡Œäº†æ·±å…¥çš„äº¤æµä¸åˆä½œã€‚å¯èƒ½è¿˜æœ‰äº›åŒå­¦å¯¹ dubbo-go ä¸å¤ªäº†è§£ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;dubbo-go-ç®€ä»‹&#34;&gt;dubbo-go ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;Dubbo æ˜¯é˜¿é‡Œå·´å·´å‡ºå“ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ Java RPC æ¡†æ¶ï¼Œç›¸æ¯”å…¶å®ƒæ¡†æ¶ï¼Œæœ‰è¾ƒä¸ºå…¨é¢çš„æœåŠ¡æ²»ç†åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;dubbo-go æ˜¯ dubbo çš„ Go è¯­è¨€ç‰ˆæœ¬ï¼Œè¯¥é¡¹ç›®å·²è¿›å…¥ apache ä¸€å¹´æœ‰ä½™ï¼Œå¼€å‘ç¤¾åŒºå¾ˆæ´»è·ƒï¼Œç‰ˆæœ¬å‘å¸ƒèŠ‚å¥è¾ƒå¿«ã€‚åŠŸèƒ½ä¸Šä¹ŸåŸºæœ¬å’Œ dubbo çš„ Java ç‰ˆéƒ½å¯¹é½äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./dubbo-go-arch.png&#34; alt=&#34;dubbo go æ¶æ„&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºå–œæ¬¢ dubbo çš„ gopher æ¥è¯´ï¼Œdubbo-go æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½¿ç”¨å®ƒæ¥æ„å»ºæ•´ä¸ªå…¬å¸çš„æœåŠ¡æ¡†æ¶ï¼Œçœæ—¶çœå¿ƒã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn--dubbo-go-åŒå‰‘åˆç’§&#34;&gt;MOSN + dubbo-go åŒå‰‘åˆç’§&lt;/h2&gt;
&lt;p&gt;Service Mesh èƒ½å¤Ÿç»™å¾®æœåŠ¡çš„æ•´ä½“æ¶æ„å¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œç„¶è€Œä¸šç•Œæä¾›çš„å…¨å®¶æ¡¶æ–¹æ¡ˆä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°åœ¨ä¼ä¸šå†…è½åœ°ï¼Œæœ‰ä¸‹é¢ä¸€äº›åŸå› ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¦æ±‚æ•°æ®é¢å’Œæ§åˆ¶é¢ä¸€èµ·ä¸Šçº¿ï¼Œæ—©æœŸ istio å› ä¸ºè®¾è®¡é—®é¢˜ï¼Œæœ‰ä¼—å¤šæ¨¡å—ã€‚ä¼šå¤§å¹…å¢åŠ ä¼ä¸šçš„è¿ç»´è´Ÿæ‹…ã€‚&lt;/li&gt;
&lt;li&gt;ä¼ä¸šä¸Š mesh ä¸€å®šæ˜¯æ¸è¿›éƒ¨ç½²ï¼Œä¸å¯èƒ½ä¸€æ¬¡æ€§è®©æ‰€æœ‰æœåŠ¡å…¨éƒ¨ä¸Šã€‚è¿™æ ·å°±ä¼šæœ‰åœ¨ mesh ä¸­çš„åº”ç”¨å’Œé mesh ä¸­çš„åº”ç”¨éœ€è¦èƒ½å¤Ÿäº’é€šçš„éœ€æ±‚ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;èš‚èšçš„ Service Mesh è½åœ°è¿‡ç¨‹ç›¸å¯¹è¾ƒä¸ºæˆåŠŸï¼Œå€¼å¾—å‚è€ƒã€‚åœ¨å†…éƒ¨è½åœ°æ—¶ï¼Œé¦–å…ˆåªè½åœ°æ•°æ®é¢ï¼Œè¿™æ ·è¿ç»´è´Ÿæ‹…è¾ƒè½»ï¼ŒåŒæ—¶å‡ºé—®é¢˜æ—¶ä¹Ÿå®¹æ˜“æ’æŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;ä½†åªè½åœ°æ•°æ®é¢çš„è¯ï¼Œæœ‰äº›æ§åˆ¶é¢çš„åŠŸèƒ½æˆ‘ä»¬å°±æ²¡æœ‰äº†ï¼Œæ¯”å¦‚æœåŠ¡å‘ç°ã€è·¯ç”±é…ç½®è®¢é˜…ç­‰ç­‰ã€‚å› æ­¤åœ¨ MOSN ä¸­ï¼Œåˆé¢å¤–å¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œäº†æ”¯æŒ(ç›¸å½“äºç›®å‰çš„æ•°æ®é¢å•æ¨¡å—åŒæ—¶æ‰¿è½½äº†æ•°æ®é¢å’Œæ§åˆ¶é¢çš„éƒ¨åˆ†åŠŸèƒ½)ã€‚å½“æ•°æ®é¢ç¨³å®šè½åœ°ä¹‹åï¼Œå†è¿›è¡Œæ§åˆ¶é¢çš„è½åœ°ç›¸å¯¹æ¥è¯´è´Ÿæ‹…å°±å°å¾ˆå¤šäº†ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„æ˜¯èš‚èšå†…éƒ¨çš„æƒ…å†µï¼Œåœ¨ç¤¾åŒºå†…ï¼ŒMOSN å€ŸåŠ© dubbo-go çš„èƒ½åŠ›ï¼Œå·²ç»å®ç°äº†æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œç”¨æˆ·åº”ç”¨å¯åŠ¨ã€é€€å‡ºæ—¶éœ€è¦å’Œ MOSN è¿›è¡Œç®€å•çš„äº¤äº’ï¼Œä»¥å®ŒæˆæœåŠ¡çš„å‘å¸ƒå’Œè®¢é˜…åŠŸèƒ½ï¼Œä¸‹é¢æ˜¯å‘å¸ƒæµç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./mosn_dubbo2.png&#34; alt=&#34;pub_mosn&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œè®¿é—®æœ¬åœ°çš„ MOSN http æ¥å£ï¼Œå‘ŠçŸ¥éœ€è¦å°†æœ¬åœ°çš„æœåŠ¡å‘å¸ƒå‡ºå»ï¼ŒMOSN æ”¶åˆ°è¯·æ±‚åå¯¹å¤–å‘å¸ƒ MOSN çš„ ip å’Œç«¯å£åˆ°æ³¨å†Œä¸­å¿ƒã€‚è¿™æ ·ç›‘å¬æœ¬æœåŠ¡çš„ consumer ä¾¿å¯ä»¥ä»æ³¨å†Œä¸­å¿ƒæ”¶åˆ°æœåŠ¡å˜æ›´çš„é€šçŸ¥ï¼Œå¹¶å°†æœ¬å®ä¾‹åŠ å…¥åˆ°ç›¸åº”çš„ provider åˆ—è¡¨ã€‚å½“åº”ç”¨é€€å‡ºæ—¶ï¼Œéœ€è¦ä¸»åŠ¨è¿›è¡Œ unpubã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç§æƒ…å†µä¸‹çš„æ”¹é€ æˆæœ¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¯¹äºä¸šåŠ¡æ–¹æ¥è¯´ï¼Œåªéœ€è¦å‡çº§ sdkã€‚&lt;/li&gt;
&lt;li&gt;å¯¹äº sdk ç»´æŠ¤æ–¹ï¼Œåœ¨æ‰§è¡Œ sub/pub/unsub/unpub æ—¶ï¼Œéœ€è¦å¢åŠ ä¸€ä¸ªå¼€å…³åˆ¤æ–­ï¼Œå¼€å…³æ‰“å¼€æ—¶ï¼Œè¯´æ˜æœ¬å®ä¾‹å·²ä¸Š Service Meshã€‚è¯·æ±‚ç›¸åº”çš„æœ¬åœ° MOSN æ¥å£ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹äº mesh æä¾›æ–¹ï¼Œåªè¦åšå¥½é…ç½®å’Œéƒ¨ç½²å°±å¯ä»¥äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ¥å…¥ MOSN åï¼Œmesh åŒ–å’Œé mesh åŒ–çš„åº”ç”¨å¯ä»¥äº’é€šï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./mosn_dubbo.png&#34; alt=&#34;mosn_dubbo&#34;&gt;&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œå¼€å‘è¿‡ç¨‹ä¹Ÿå¹¶ä¸æ˜¯ä¸€å¸†é£é¡ºçš„ã€‚åœ¨æˆ‘ä»¬åˆšå¼€å§‹ä½¿ç”¨ dubbo-go æ—¶ï¼Œä¾¿é‡åˆ°äº† dubbo-go çš„ä¾èµ–ä¸ MOSN çš„ä¾èµ–æœ‰å†²çªçš„é—®é¢˜ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./dep_conflict.png&#34; alt=&#34;dep conflict&#34;&gt;&lt;/p&gt;
&lt;p&gt;Go è¯­è¨€çš„ go mod è¯­ä¹‰ä¼šâ€œè‡ªä½œèªæ˜â€åœ°è®¤ä¸º 0.y.z çš„å¤–éƒ¨ä¾èµ–éƒ½æ˜¯å½¼æ­¤å…¼å®¹çš„ï¼Œç„¶è€Œæˆ‘ä»¬ä» semver è§„èŒƒå¯ä»¥å­¦ä¹ åˆ°ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Major version zero (0.y.z) is for initial development. Anything MAY change at any time. The public API SHOULD NOT be considered stable.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;0.y.z åªæ˜¯ç”¨æ¥åšåˆå§‹çš„å¼€å‘ï¼Œæœ¬èº« API çš„å˜åŒ–å°±æ˜¯å¾ˆé¢‘ç¹çš„ï¼Œä¾èµ–ç®¡ç†å·¥å…·ä¸åº”è¯¥è‡ªåŠ¨å»å‡çº§è¿™äº›ä¾èµ–ã€‚ä½†æ˜¯ Go ç¤¾åŒºçš„äººæœ‰ä¸å°‘äººåšæŒ go mod çš„è¡Œä¸ºæ­£ç¡®ï¼Œå¹¶ä¸”ç¥­å‡º MVS ç®—æ³•ï¼Œè¡¨ç¤ºç¢°åˆ°é—®é¢˜çš„åªæ˜¯ä¸æ‡‚ Go çš„å“²å­¦ã€‚&lt;/p&gt;
&lt;p&gt;å½“å‰ Go çš„ä¾èµ–ç®¡ç†ä½¿å¾—ä¸¤ä¸ªå¤§é¡¹ç›®å‘ç”Ÿä¾èµ–å†²çªæ—¶ï¼Œæ¯”è¾ƒéš¾å¤„ç†ï¼Œæˆ‘ä»¬åªèƒ½æ ¹æ®å®é™…æƒ…å†µå» go.mod ä¸­å»å†™ä¸€äº› replace é€»è¾‘ï¼Œæ¥é”å®šå¤–éƒ¨ä¾èµ–åº“ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;p&gt;é™¤äº†ä¾èµ–é—®é¢˜ä»¥å¤–ï¼Œdubbo-go æœ€åˆçš„è®¾è®¡å¤§é‡ä½¿ç”¨äº† init å‡½æ•°ã€‚init å‡½æ•°ç”¨æ¥å®ç°ä¸€äº›åˆå§‹åŒ–å’Œä¾èµ–æ³¨å…¥ç¡®å®æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸­çš„æ¨¡å—ä¼šè¢«å…¶å®ƒå¤–éƒ¨é¡¹ç›®ä¾èµ–æ—¶ï¼Œinit åˆ™å¯èƒ½ç»™æˆ‘ä»¬é€ æˆéº»çƒ¦ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GlobalMap&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;a&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GlobalMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GlobalMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœæˆ‘ä»¬åœ¨æŸä¸ªåŒ…ä¸­åŒæ—¶ä¾èµ– a å’Œ bï¼Œé‚£ä¹ˆä¸‹é¢çš„ä¸¤ç§å†™æ³•ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;show&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;b&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;main&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GlobalMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;show&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;b&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;main&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GlobalMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸ºäº†é¿å…è¿™äº›éšå¼çš„ init è¡Œä¸ºï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯ fork äº† dubbo-go å¹¶è¿›è¡Œäº†å°‘é‡ä¿®æ”¹çš„ã€‚å½“ç„¶ï¼Œæ”¹åŠ¨å¹¶ä¸å¤šï¼Œæœªæ¥å¦‚æœ dubbo-go æœ‰æ›´å¥½çš„æ¨¡å—åŒ–æ–¹æ³•çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆè½»æ¾åœ°è¿ç§»å›ç›´æ¥ä¾èµ– dubbo-goã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ MOSN é›†æˆ dubbo-go çš„è¿‡ç¨‹ä¸­ï¼Œdubbo-go ç¤¾åŒºçš„è€å“¥ä»¬ç»™äºˆäº†æˆ‘ä»¬å¤§é‡çš„æ”¯æŒï¼Œ&lt;a href=&#34;https://github.com/zouyx&#34;&gt;è´¤å“¥ï¼ˆ@zouyxï¼‰&lt;/a&gt; å¸®åŠ©æˆ‘ä»¬åœ¨ dubbo-go ä¸­å®ç°äº†ä¹‹å‰ä¸æ”¯æŒçš„ unsub/unpub åŠŸèƒ½ï¼Œå¹¶å¸®åŠ©æˆ‘ä»¬è§£å†³äº†å¾ˆå¤šæŠ€æœ¯æ–¹é¢çš„é—®é¢˜ã€‚dubbo-go ç¤¾åŒºè´Ÿè´£äºº&lt;a href=&#34;https://github.com/alexstocks&#34;&gt;äºé›¨ï¼ˆ@alexstocksï¼‰&lt;/a&gt;ä¹Ÿåœ¨å¼€å‘è¿‡ç¨‹ä¸­æä¾›äº†å¤§é‡çš„ä¿¡æ¯å’ŒæŠ€æœ¯æ”¯æŒã€‚æœ‰è¿™ä¸¤ä½çš„æ”¯æŒï¼ŒMOSN å’Œ dubbo çš„é›†æˆæ‰é¡ºç•…æ— æ¯”ï¼Œå¦åˆ™çš„è¯è¦å¤šèµ°å¾ˆå¤šå¼¯è·¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å…¶å®ƒé€‰æ‹©&#34;&gt;å…¶å®ƒé€‰æ‹©&lt;/h2&gt;
&lt;p&gt;é™¤äº†æœ¬æ–‡æåˆ°çš„ MOSN + dubbo-go é›†æˆæ–¹å¼ï¼Œå¤šç‚¹çš„é™ˆé¹åŒå­¦ä¸ºæˆ‘ä»¬æä¾›äº†å¦ä¸€ç§æ€è·¯è¿›è¡Œé›†æˆï¼Œæœ¬æ–‡å°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæ–‡æœ«çš„èµ„æ–™ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä½œè€…ç®€ä»‹&#34;&gt;ä½œè€…ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;æ›¹æ˜¥æ™–ï¼Œå¼€æº MOSN committerï¼Œ@cch123ï¼Œèš‚èšé›†å›¢ç³»ç»Ÿéƒ¨æŠ€æœ¯ä¸“å®¶ï¼Œä¸»æ”» Service Mesh æ–¹å‘ã€‚ä¸ªäººæŠ€æœ¯ç½‘ç«™ xargin.comï¼Œå’Œä»–äººåˆè‘—ã€ŠGo è¯­è¨€é«˜çº§ç¼–ç¨‹ã€‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://jimmysong.io/blog/what-is-a-service-mesh/&#34;&gt;ä»€ä¹ˆæ˜¯Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://mosn.iodocs/concept/multi-protocol&#34;&gt;MOSN å¤šåè®®æœºåˆ¶è§£æ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/mhHnH6ZDPPs6Gr0a20WGOw&#34;&gt;å¤šç‚¹ç”Ÿæ´»åœ¨ Service Mesh ä¸Šçš„å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: è®°ä¸€æ¬¡åœ¨ MOSN å¯¹ Dubboã€dubbo-go-hessian2 çš„æ€§èƒ½ä¼˜åŒ–</title>
      <link>https://mosn.io/blog/posts/mosn-dubbo-go-hessian2/</link>
      <pubDate>Tue, 02 Jun 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-dubbo-go-hessian2/</guid>
      <description>
        
        
        &lt;p&gt;èš‚èšé›†å›¢å†…éƒ¨å¯¹ Service Mesh çš„ç¨³å®šæ€§å’Œæ€§èƒ½è¦æ±‚æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå†…éƒ¨ MOSN å¹¿æ³›ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚åœ¨äº‘ä¸Šå’Œå¼€æºç¤¾åŒºï¼ŒRPC é¢†åŸŸ Dubbo å’Œ Spring Cloud åŒæ ·å¹¿æ³›ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨ MOSN åŸºç¡€ä¸Šï¼Œæ”¯æŒäº† Dubbo å’Œ spring cloud æµé‡ä»£ç†ã€‚æˆ‘ä»¬å‘ç°åœ¨æ”¯æŒ Dubbo åè®®è¿‡ç¨‹ä¸­ï¼Œç»è¿‡ Mesh æµé‡ä»£ç†åï¼Œæ€§èƒ½æœ‰éå¸¸å¤§çš„æ€§èƒ½æŸè€—ï¼Œåœ¨å¤§å•†æˆ·è½åœ° Mesh ä¸­ä¹Ÿå¯¹æ€§èƒ½æœ‰è¾ƒé«˜è¦æ±‚ï¼Œå› æ­¤æœ¬æ–‡ä¼šé‡ç‚¹æè¿°åœ¨åŸºäº Go è¯­è¨€åº“ &lt;a href=&#34;https://github.com/apache/dubbo-go-hessian2&#34;&gt;dubbo-go-hessian2&lt;/a&gt; ã€Dubbo åè®®ä¸­å¯¹ &lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;MOSN&lt;/a&gt; æ‰€åšçš„æ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°&#34;&gt;æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°&lt;/h3&gt;
&lt;p&gt;æ ¹æ®å®é™…ä¸šåŠ¡éƒ¨ç½²åœºæ™¯ï¼Œå¹¶æ²¡æœ‰é€‰ç”¨é«˜æ€§èƒ½æœºå™¨ï¼Œä½¿ç”¨æ™®é€š linux æœºå™¨ï¼Œé…ç½®å’Œå‹æµ‹å‚æ•°å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Intel (R) Xeon (R) Platinum 8163 CPU @ 2.50GHz 4 æ ¸ 16G ã€‚&lt;/li&gt;
&lt;li&gt;pod é…ç½® &lt;code&gt;2cã€1g&lt;/code&gt;ï¼ŒJVM å‚æ•° &lt;code&gt;-server -Xms1024m -Xmx1024m&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;ç½‘ç»œå»¶è¿Ÿ 0.23 ms, 2 å° linux æœºå™¨ï¼Œåˆ†åˆ«éƒ¨ç½² server + mosn, å‹æµ‹ç¨‹åº &lt;a href=&#34;https://github.com/zonghaishang/rpc-performance&#34;&gt;rpc-perfomance&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç»è¿‡ 3 è½®æ€§èƒ½ä¼˜åŒ–åï¼Œä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ MOSN å°†ä¼šè·å¾—ä»¥ä¸‹æ€§èƒ½æ”¶ç›Šï¼ˆæ¡†æ¶éšæœº 512 å’Œ 1k å­—èŠ‚å‹æµ‹ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;512 å­—èŠ‚æ•°æ®ï¼šMOSN + Dubbo æœåŠ¡è°ƒç”¨ TPS æ•´ä½“æå‡ 55-82.8%ï¼ŒRT é™ä½ 45% å·¦å³ï¼Œå†…å­˜å ç”¨ 40Mï¼Œ&lt;/li&gt;
&lt;li&gt;1k æ•°æ®ï¼šMOSN + Dubbo æœåŠ¡è°ƒç”¨ TPS æ•´ä½“æå‡ 51.1-69.3%ï¼ŒRT é™ä½ 41% å·¦å³ï¼Œå†…å­˜å ç”¨ 41Mã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;æ€§èƒ½ä¼˜åŒ–å·¥å…·-pprof&#34;&gt;æ€§èƒ½ä¼˜åŒ–å·¥å…· pprof&lt;/h3&gt;
&lt;p&gt;ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ï¼Œåœ¨æ€§èƒ½ä¼˜åŒ–å‰é¦–å…ˆè¦æ‰¾åˆ°æ€§èƒ½å¡ç‚¹ï¼Œæ‰¾åˆ°æ€§èƒ½å¡ç‚¹åï¼Œå¦ä¸€ä¸ªéš¾ç‚¹å°±æ˜¯å¦‚ä½•ç”¨é«˜æ•ˆä»£ç ä¼˜åŒ–æ›¿ä»£ slow codeã€‚å› ä¸ºèš‚èšé›†å›¢ Service Mesh æ˜¯åŸºäº go è¯­è¨€å®ç°çš„ï¼Œæˆ‘ä»¬é¦–é€‰ go è‡ªå¸¦çš„ pprof æ€§èƒ½å·¥å…·ï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç»è¿™ä¸ªå·¥å…·å¦‚ä½•ä½¿ç”¨ã€‚å¦‚æœæˆ‘ä»¬ go åº“è‡ªå¸¦ http.Server æ—¶å¹¶ä¸”åœ¨ main å¤´éƒ¨å¯¼å…¥ &lt;code&gt;import _ &amp;quot;net/http/pprof&amp;quot;&lt;/code&gt;ï¼Œgo ä¼šå¸®æˆ‘ä»¬æŒ‚è½½å¯¹åº”çš„ handler , è¯¦ç»†å¯ä»¥å‚è€ƒ &lt;a href=&#34;https://pkg.go.dev/net/http/pprof?tab=doc&#34;&gt;godoc&lt;/a&gt; ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸º mosn é»˜è®¤ä¼šåœ¨ &lt;code&gt;34902&lt;/code&gt; ç«¯å£æš´éœ² http æœåŠ¡ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤è½»æ¾è·å– mosn çš„æ€§èƒ½è¯Šæ–­æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go tool pprof -seconds &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;60&lt;/span&gt; http://benchmark-server-ip:34902/debug/pprof/profile
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ä¼šç”Ÿæˆç±»ä¼¼ä»¥ä¸‹æ–‡ä»¶ï¼Œè¯¥å‘½ä»¤é‡‡æ ·cpu 60ç§’&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pprof.mosn.samples.cpu.001.pb.gz&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç„¶åç»§ç»­ç”¨ pprof æ‰“å¼€è¯Šæ–­æ–‡ä»¶ï¼Œæ–¹ä¾¿åœ¨æµè§ˆå™¨æŸ¥çœ‹ï¼Œåœ¨å›¾ 1-1 ç»™å‡ºå‹æµ‹å profiler ç«ç„°å›¾ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# http=:8000ä»£è¡¨pprofæ‰“å¼€8000ç«¯å£ç„¶åç”¨äºwebæµè§ˆå™¨åˆ†æ&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# mosndä»£è¡¨mosnçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨äºåˆ†æä»£ç ç¬¦å·&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# pprof.mosn.samples.cpu.001.pb.gzæ˜¯cpuè¯Šæ–­æ–‡ä»¶&lt;/span&gt;
go tool pprof -http&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;:8000 mosnd pprof.mosn.samples.cpu.001.pb.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;007S8ZIlgy1gfm13iq7twj315g0fajxp.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;å›¾ 1-1 MOSN æ€§èƒ½å‹æµ‹ç«ç„°å›¾&lt;/p&gt;
&lt;p&gt;åœ¨è·å¾—è¯Šæ–­æ•°æ®åï¼Œå¯ä»¥åˆ‡åˆ°æµè§ˆå™¨ Flame Graphï¼ˆç«ç„°å›¾ï¼Œgo 1.11 ä»¥ä¸Šç‰ˆæœ¬è‡ªå¸¦ï¼‰ï¼Œç«ç„°å›¾çš„ x è½´åæ ‡ä»£è¡¨ CPU æ¶ˆè€—æƒ…å†µï¼Œ y è½´ä»£ç æ–¹æ³•è°ƒç”¨å †æ ˆã€‚åœ¨ä¼˜åŒ–å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å€ŸåŠ© go å·¥å…· pprof å¯ä»¥è¯Šæ–­å‡ºå¤§è‡´çš„æ€§èƒ½å¡ç‚¹åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼ˆç›´æ¥å‹ server ç«¯ MOSNï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSN åœ¨æ¥æ”¶ Dubbo è¯·æ±‚ï¼ŒCPU å¡ç‚¹åœ¨ streamConnection.Dispatch&lt;/li&gt;
&lt;li&gt;MOSN åœ¨è½¬å‘ Dubbo è¯·æ±‚ï¼ŒCPU å¡ç‚¹åœ¨ downStream.Receive&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯ä»¥ç‚¹å‡»ç«ç„°å›¾ä»»æ„æ¨ªæ¡ï¼Œè¿›å»æŸ¥çœ‹é•¿æ–¹å—è€—æ—¶å’Œå †æ ˆæ˜ç»†ï¼ˆè¯·å‚è€ƒå›¾ 1-2 å’Œ 1-3 æ‰€ç¤ºï¼‰ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;007S8ZIlgy1gfm13gy31ij31hc0kfdms.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;å›¾ 1-2 Dispatch ç«ç„°å›¾æ˜ç»†&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;007S8ZIlgy1gfm13hwtidj31hc0gy474.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å›¾ 1-3 Receive ç«ç„°å›¾æ˜ç»†&lt;/p&gt;
&lt;h3 id=&#34;æ€§èƒ½ä¼˜åŒ–æ€è·¯&#34;&gt;æ€§èƒ½ä¼˜åŒ–æ€è·¯&lt;/h3&gt;
&lt;p&gt;æœ¬æ–‡é‡ç‚¹è®°å½•ä¼˜åŒ–äº†å“ªäº› case æ‰èƒ½æå‡ 50% ä»¥ä¸Šçš„ååé‡å’Œé™ä½ RTï¼Œå› æ­¤åé¢ç›´æ¥åˆ†æå½“å‰ä¼˜åŒ–äº†å“ªäº› caseã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬ä»¥ Dispatch ä¸ºä¾‹ï¼Œçœ‹ä¸‹å®ƒä¸ºç”šä¹ˆé‚£ä¹ˆåƒæ€§èƒ½ ã€‚åœ¨ terminal ä¸­é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä»£ç è¡Œè€—è´¹ CPU æ•°æ®ï¼ˆä»£ç æœ‰åˆ å‡ï¼‰ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go tool pprof mosnd pprof.mosn.samples.cpu.001.pb.gz
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;pprof&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; list Dispatch
Total: 1.75mins
     370ms     37.15s &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;flat, cum&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; 35.46% of Total
      10ms       10ms    123:func &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;conn *streamConnection&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; Dispatch&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;buffer types.IoBuffer&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
      40ms      630ms    125:   log.DefaultLogger.Tracef&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;stream connection dispatch data string = %v&amp;#34;&lt;/span&gt;, buffer.String&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;())&lt;/span&gt;
         .          .    126:
         .          .    127:   // get sub protocol codec
         .      250ms    128:   requestList :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.codec.SplitFrame&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;buffer.Bytes&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;())&lt;/span&gt;
      20ms       20ms    129:   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; _, request :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; range requestList &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
      10ms      160ms    134:       headers :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; make&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;map&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;string&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;string&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    135:       // support dynamic route
      50ms      920ms    136:       headers&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;strings.ToLower&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;protocol.MosnHeaderHostKey&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.connection.RemoteAddr&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt;.String&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt;
         .          .    149:
         .          .    150:       // get stream id
      10ms      440ms    151:       streamID :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.codec.GetStreamID&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    156:       // request route
         .       50ms    157:       requestRouteCodec, ok :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.codec.&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;xprotocol.RequestRouting&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    158:       &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; ok &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
         .     20.11s    159:           routeHeaders :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; requestRouteCodec.GetMetas&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    165:       &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
         .          .    166:
         .          .    167:       // tracing
      10ms       80ms    168:       tracingCodec, ok :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.codec.&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;xprotocol.Tracing&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    169:       var span types.Span
         .          .    170:       &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; ok &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
      10ms      1.91s    171:           serviceName :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; tracingCodec.GetServiceName&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .      2.17s    172:           methodName :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; tracingCodec.GetMethodName&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    176:
         .          .    177:           &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; trace.IsEnabled&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
         .       50ms    179:               tracer :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; trace.Tracer&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;protocol.Xprotocol&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    180:               &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; tracer !&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; nil &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
      20ms      1.66s    181:                   &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; tracer.Start&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;conn.context, headers, time.Now&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;())&lt;/span&gt;
         .          .    182:               &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
         .          .    183:           &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
         .          .    184:       &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
         .          .    185:
         .      110ms    186:       reqBuf :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; networkbuffer.NewIoBufferBytes&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    188:       // append sub protocol header
      10ms      950ms    189:       headers&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;types.HeaderXprotocolSubProtocol&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; string&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;conn.subProtocol&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
      10ms      4.96s    190:       conn.OnReceive&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;ctx, streamID, protocol.CommonHeader&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;headers&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;, reqBuf, span, isHearbeat&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
      30ms       60ms    191:       buffer.Drain&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;requestLen&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .    192:   &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
         .          .    193:&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€šè¿‡ä¸Šé¢ &lt;code&gt;list Dispatch&lt;/code&gt; å‘½ä»¤ï¼Œæ€§èƒ½å¡ç‚¹ä¸»è¦åˆ†å¸ƒåœ¨ &lt;code&gt;159&lt;/code&gt; ã€ &lt;code&gt;171&lt;/code&gt; ã€&lt;code&gt;172&lt;/code&gt; ã€ &lt;code&gt;181&lt;/code&gt; ã€å’Œ &lt;code&gt;190&lt;/code&gt; ç­‰è¡Œï¼Œä¸»è¦å¡ç‚¹åœ¨è§£ç  dubbo å‚æ•°ã€é‡å¤è§£å‚æ•°ã€tracerã€å‘åºåˆ—åŒ–å’Œ log ç­‰ã€‚&lt;/p&gt;
&lt;h4 id=&#34;1-ä¼˜åŒ–-dubbo-è§£ç -getmetas&#34;&gt;1. ä¼˜åŒ– dubbo è§£ç  GetMetas&lt;/h4&gt;
&lt;p&gt;æˆ‘ä»¬é€šè¿‡è§£ç  dubbo çš„ body å¯ä»¥è·å¾—ä»¥ä¸‹ä¿¡æ¯ï¼Œè°ƒç”¨çš„ç›®æ ‡æ¥å£ï¼ˆ interface ï¼‰å’Œè°ƒç”¨æ–¹æ³•çš„æœåŠ¡åˆ†ç»„ï¼ˆ group ï¼‰ç­‰ä¿¡æ¯ï¼Œä½†æ˜¯éœ€è¦è·³è¿‡æ‰€æœ‰ä¸šåŠ¡æ–¹æ³•å‚æ•°ï¼Œç›®å‰ä½¿ç”¨å¼€æºçš„ &lt;a href=&#34;https://github.com/apache/dubbo-go-hessian2&#34;&gt;dubbo-go-hessian2&lt;/a&gt; åº“ï¼Œè§£æ string å’Œ map æ€§èƒ½è¾ƒå·®ï¼Œæå‡ hessian åº“è§£ç æ€§èƒ½ï¼Œä¼šåœ¨æœ¬æ–‡åé¢è®²è§£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ mosn çš„ ingress ç«¯ï¼ˆ mosn ç›´æ¥è½¬å‘è¯·æ±‚ç»™æœ¬åœ° java server è¿›ç¨‹ï¼‰, æˆ‘ä»¬æ ¹æ®è¯·æ±‚çš„ path å’Œ version çª¥æ¢ç”¨æˆ·ä½¿ç”¨çš„ interface å’Œ group , æ„å»ºæ­£ç¡®çš„ dataID å¯ä»¥è¿›è¡Œæ— è„‘è½¬å‘ï¼Œæ— éœ€è§£ç  bodyï¼Œæ¦¨å–æ€§èƒ½æå‡ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡æ³¨å†Œæ—¶ï¼Œæ„å»ºæœåŠ¡å‘å¸ƒçš„ path ã€version å’Œ group åˆ° interface ã€group æ˜ å°„ã€‚åœ¨ mosn è½¬å‘ dubbo è¯·æ±‚æ—¶å¯ä»¥é€šè¿‡è¯»é”æŸ¥ cache + è·³è¿‡è§£ç  bodyï¼ŒåŠ é€Ÿ mosn æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤æˆ‘ä»¬æ„å»ºä»¥ä¸‹ cache å®ç°ï¼ˆæ•°ç»„ + é“¾è¡¨æ•°æ®ç»“æ„ï¼‰, å¯å‚è§ &lt;a href=&#34;https://github.com/mosn/mosn/pull/1174/commits/9020ee9995cd15a7a4321a375a9506cf94dc70a8#diff-f5ff30debd68b8318c8236a0b5ccde07R6&#34;&gt;ä¼˜åŒ–ä»£ç  diff&lt;/a&gt; ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// metadata.go
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// DubboPubMetadata dubbo pub cache metadata
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DubboPubMetadata&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Metadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// DubboSubMetadata dubbo sub cache metadata
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DubboSubMetadata&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Metadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Metadata cache service pub or sub metadata.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// speed up for decode or encode dubbo peformance.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// please do not use outside of the dubbo framwork.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Metadata&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;   &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RWMutex&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// protect data internal
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Find cached pub or sub metatada.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// caller should be check match is true
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Metadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Find&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matched&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we found nothing
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RLocker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for performance
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// m.mu.RLocker().Unlock() should be called.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we check head node first
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RLocker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// just only once, just return
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for dubbo framwork, that&amp;#39;s what we&amp;#39;re expected.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RLocker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;found&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Version&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;found&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;found&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RLocker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;found&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Register pub or sub metadata
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Metadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Register&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for performance
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// m.mu.Unlock() should be called.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we check head node first
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// update head
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;insert&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;Version&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Version&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// fist insert, just insert to head
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;insert&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// record last element
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;last&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;insert&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we check already exist first
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we found it
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Version&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Version&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// release lock and no nothing
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;count&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// append node to the end of the list
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;last&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;insert&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// update last element
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;head&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;last&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;insert&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mu&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€šè¿‡æœåŠ¡æ³¨å†Œæ—¶æ„å»ºå¥½çš„ cacheï¼Œå¯ä»¥åœ¨ MOSN çš„ stream åšè§£ç æ—¶å‘½ä¸­ cache , æ— éœ€è§£ç å‚æ•°è·å–æ¥å£å’Œ group ä¿¡æ¯ï¼Œå¯å‚è§&lt;a href=&#34;https://github.com/mosn/mosn/pull/1174/commits/9020ee9995cd15a7a4321a375a9506cf94dc70a8#diff-73d1153005841c788c91116915f460a5R188&#34;&gt;ä¼˜åŒ–ä»£ç  diff&lt;/a&gt; :&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// decoder.go
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for better performance.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If the ingress scenario is not using group,
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we can skip parsing attachment to improve performance
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;IngressDubbo&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matched&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DubboPubMetadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Find&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;version&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matched&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServiceNameHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GroupNameHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;EgressDubbo&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for better performance.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If the egress scenario is not using group,
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we can skip parsing attachment to improve performance
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matched&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DubboSubMetadata&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Find&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;version&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matched&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServiceNameHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GroupNameHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;node&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Group&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨ MOSN çš„ egress ç«¯ï¼ˆ mosn ç›´æ¥è½¬å‘è¯·æ±‚ç»™æœ¬åœ° java client è¿›ç¨‹ï¼‰, æˆ‘ä»¬é‡‡ç”¨ç±»ä¼¼çš„æ€è·¯ï¼Œæˆ‘ä»¬æ ¹æ®è¯·æ±‚çš„ path å’Œ version å»çª¥æ¢ç”¨æˆ·ä½¿ç”¨çš„ interface å’Œ group , æ„å»ºæ­£ç¡®çš„ dataID å¯ä»¥è¿›è¡Œæ— è„‘è½¬å‘ï¼Œæ— éœ€è§£ç  bodyï¼Œæ¦¨å–æ€§èƒ½æå‡ã€‚&lt;/p&gt;
&lt;h4 id=&#34;2-ä¼˜åŒ–-dubbo-è§£ç å‚æ•°&#34;&gt;2. ä¼˜åŒ– dubbo è§£ç å‚æ•°&lt;/h4&gt;
&lt;p&gt;åœ¨ dubbo è§£ç å‚æ•°å€¼çš„æ—¶å€™ ï¼ŒMOSN é‡‡ç”¨çš„æ˜¯ hessian çš„æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾ï¼Œéå¸¸è€—è´¹æ€§èƒ½ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹ä¼˜åŒ–å‰å benchmark å¯¹æ¯”ï¼Œæ€§èƒ½æå‡ 50 å€ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go &lt;span style=&#34;color:#204a87&#34;&gt;test&lt;/span&gt; -bench&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;BenchmarkCountArgCount -run&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;^$ -benchmem
BenchmarkCountArgCountByRegex-12    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;200000&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;6236&lt;/span&gt; ns/op  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1472&lt;/span&gt; B/op   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt; allocs/op
BenchmarkCountArgCountOptimized-12  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10000000&lt;/span&gt;    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;124&lt;/span&gt; ns/op   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; B/op  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; allocs/op
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥æ¶ˆé™¤æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‡‡ç”¨ç®€å•å­—ç¬¦ä¸²è§£æè¯†åˆ«å‚æ•°ç±»å‹ä¸ªæ•°ï¼Œ &lt;a href=&#34;https://github.com/zonghaishang/dubbo/blob/e0fd702825a274379fb609229bdb06ca0586122e/dubbo-common/src/main/java/org/apache/dubbo/common/utils/ReflectUtils.java#L370&#34;&gt;Dubbo ç¼–ç å‚æ•°ä¸ªæ•°å­—ç¬¦ä¸²å®ç°&lt;/a&gt; å¹¶ä¸å¤æ‚ï¼Œä¸»è¦ç»™å¯¹è±¡åŠ  L å‰ç¼€ã€æ•°ç»„åŠ  [ã€primitive ç±»å‹æœ‰å•å­—ç¬¦ä»£æ›¿ã€‚é‡‡ç”¨ go å¯ä»¥å®ç°åŒç­‰è§£æï¼Œå¯ä»¥å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/pull/1174/commits/9020ee9995cd15a7a4321a375a9506cf94dc70a8#diff-73d1153005841c788c91116915f460a5R245&#34;&gt;ä¼˜åŒ–ä»£ç  diff&lt;/a&gt; ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getArgumentCount&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;desc&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;len&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;desc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;len&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;args&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;desc&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;

        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// is array ?
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;[&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;continue&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// is object ?
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;;&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;continue&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;V&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// void
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;Z&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// boolean
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;B&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// byte
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;C&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// char
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;D&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// double
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;F&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// float
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;I&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// int
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;J&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// long
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;S&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// short
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;args&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// we found object
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;args&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
                &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// end of object ?
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;;&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;args&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;3-ä¼˜åŒ–-dubbo-hessian-go-è§£ç -string-æ€§èƒ½&#34;&gt;3. ä¼˜åŒ– dubbo hessian go è§£ç  string æ€§èƒ½&lt;/h4&gt;
&lt;p&gt;åœ¨å›¾ 1-2 ä¸­å¯ä»¥çœ‹åˆ° dubbo hessian go åœ¨è§£ç  string å æ¯” CPU é‡‡æ ·è¾ƒé«˜ï¼Œæˆ‘ä»¬åœ¨è§£ç  dubbo è¯·æ±‚æ—¶ï¼Œä¼šè§£æ dubbo æ¡†æ¶ç‰ˆæœ¬ã€è°ƒç”¨ path ã€æ¥å£ç‰ˆæœ¬å’Œæ–¹æ³•åï¼Œè¿™äº›éƒ½æ˜¯ string ç±»å‹ï¼Œdubbo hessian go è§£æ string ä¼šå½±å“ RPC æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬é¦–å…ˆè·‘ä¸€ä¸‹ benchmar k å‰åè§£ç  string æ€§èƒ½å¯¹æ¯”ï¼Œæ€§èƒ½æå‡ 56.11%ï¼Œ å¯¹åº”åˆ° RPC ä¸­æœ‰ 5% å·¦å³æå‡ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;BenchmarkDecodeStringOriginal-12     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1967202&lt;/span&gt;     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;613&lt;/span&gt; ns/op     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;272&lt;/span&gt; B/op     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;6&lt;/span&gt; allocs/op
BenchmarkDecodeStringOptimized-12     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4477216&lt;/span&gt;     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;269&lt;/span&gt; ns/op     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;224&lt;/span&gt; B/op     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; allocs/op
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç›´æ¥ä½¿ç”¨ UTF-8 byte è§£ç ï¼Œæ€§èƒ½æœ€é«˜ï¼Œä¹‹å‰å…ˆè§£ç  byte æˆ rune , å¯¹ rune è§£ç æˆ string ï¼ŒåŠå…¶è€—è´¹æ€§èƒ½ã€‚å¢åŠ æ‰¹é‡ string chunk copy ï¼Œé™ä½ read è°ƒç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨ unsafe è½¬æ¢ string ï¼ˆé¿å…ä¸€äº›æ ¡éªŒï¼‰ï¼Œå› ä¸ºä»£ç ä¼˜åŒ– diff è¾ƒå¤šï¼Œè¿™é‡Œç»™å‡º&lt;a href=&#34;https://github.com/apache/dubbo-go-hessian2/pull/188&#34;&gt;ä¼˜åŒ–ä»£ç  PR&lt;/a&gt; ã€‚&lt;/p&gt;
&lt;p&gt;go SDK ä»£ç  &lt;code&gt;runtime/string.go#slicerunetostring&lt;/code&gt;ï¼ˆ rune è½¬æ¢æˆ string ï¼‰ï¼Œ åŒæ ·æ˜¯æŠŠ rune è½¬æˆ byte æ•°ç»„ï¼Œè¿™é‡Œç»™äº†æˆ‘ä¼˜åŒ–æ€è·¯å¯å‘ã€‚&lt;/p&gt;
&lt;h4 id=&#34;4-ä¼˜åŒ–-hessian-åº“ç¼–è§£ç å¯¹è±¡&#34;&gt;4. ä¼˜åŒ– hessian åº“ç¼–è§£ç å¯¹è±¡&lt;/h4&gt;
&lt;p&gt;è™½ç„¶æ¶ˆé™¤äº† dubbo çš„ body è§£ç éƒ¨åˆ†ï¼Œä½†æ˜¯ MOSN åœ¨å¤„ç† dubbo è¯·æ±‚æ—¶ï¼Œå¿…é¡»è¦å€ŸåŠ© hessian å» decode è¯·æ±‚å¤´éƒ¨çš„æ¡†æ¶ç‰ˆæœ¬ã€è¯·æ±‚ path å’Œæ¥å£ç‰ˆæœ¬å€¼ã€‚ä½†æ˜¯æ¯æ¬¡åœ¨è§£ç çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºåºåˆ—åŒ–å¯¹è±¡ï¼Œå¼€é”€éå¸¸é«˜ï¼Œå› ä¸º hessian æ¯æ¬¡åœ¨åˆ›å»º reader çš„æ—¶å€™ä¼š allocate 4k æ•°æ®å¹¶ resetã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;      10ms       10ms     75:func unSerialize&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;serializeId int, data &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[]&lt;/span&gt;byte, parseCtl unserializeCtl&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; *dubboAttr &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
      10ms      140ms     82:   attr :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;dubboAttr&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{}&lt;/span&gt;
      80ms      2.56s     83:   decoder :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; hessian.NewDecoderWithSkip&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;data&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;:&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;])&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;ROUTINE&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;========================&lt;/span&gt; bufio.NewReaderSize in /usr/local/go/src/bufio/bufio.go
      50ms      2.44s &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;flat, cum&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;  2.33% of Total
         .      220ms     55:   r :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; new&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;Reader&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
      50ms      2.22s     56:   r.reset&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;make&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;([]&lt;/span&gt;byte, size&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;, rd&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
         .          .     57:   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; r
         .          .     58:&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æˆ‘ä»¬å¯ä»¥å†™ä¸ªæ± åŒ–å†…å­˜å‰åæ€§èƒ½å¯¹æ¯”ï¼Œæ€§èƒ½æå‡ 85.4% , &lt;a href=&#34;https://github.com/zonghaishang/dubbo-go-hessian2/blob/9b418c4e2700964f244e6b982855b4e89b45990d/string_test.go#L161&#34;&gt;benchmark ç”¨ä¾‹&lt;/a&gt; ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;BenchmarkNewDecoder-12  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1487685&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;803&lt;/span&gt; ns/op   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4528&lt;/span&gt; B/op   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;9&lt;/span&gt; allocs/op
BenchmarkNewDecoderOptimized-12 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10564024&lt;/span&gt;    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;117&lt;/span&gt; ns/op   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;128&lt;/span&gt; B/op    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt; allocs/op
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ¯æ¬¡ç¼–è§£ç æ—¶ï¼Œæ± åŒ– hessian çš„ decoder å¯¹è±¡ï¼Œæ–°å¢ NewCheapDecoderWithSkip å¹¶æ”¯æŒ reset å¤ç”¨ decoder ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;decodePool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hessian&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewCheapDecoderWithSkip&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åœ¨è§£ç æ—¶æŒ‰ç…§å¦‚ä¸‹æ–¹æ³•è°ƒç”¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;decoder&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;decodePool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hessian&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Decoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// fill decode data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;decoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Reset&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[:])&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;hessianPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Put&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;decoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;5-ä¼˜åŒ–é‡å¤è§£ç -service-å’Œ-methodname-å€¼&#34;&gt;5. ä¼˜åŒ–é‡å¤è§£ç  service å’Œ methodName å€¼&lt;/h4&gt;
&lt;p&gt;xprotocol åœ¨å®ç° xprotocol.Tracing è·å–æœåŠ¡åç§°å’Œæ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘è°ƒç”¨å¹¶è§£æ 2 æ¬¡ï¼Œè°ƒç”¨å¼€é”€æ¯”è¾ƒå¤§ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;10ms      1.91s    171:           serviceName :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; tracingCodec.GetServiceName&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
   .      2.17s    172:           methodName :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; tracingCodec.GetMethodName&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;request&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å› ä¸ºåœ¨ GetMetas é‡Œé¢å·²ç»è§£æè¿‡ä¸€æ¬¡äº†ï¼Œå¯ä»¥æŠŠè§£æè¿‡çš„ headers ä¼ è¿›å»ï¼Œå¦‚æœ headers æœ‰äº†å°±ä¸ç”¨å†å»è§£æäº†ï¼Œå¹¶ä¸”é‡æ„æ¥å£åç§°ä¸ºä¸€ä¸ªï¼Œè¿”å›å€¼ä¸ºäºŒå…ƒç»„ï¼Œæ¶ˆé™¤ä¸€æ¬¡è°ƒç”¨ã€‚&lt;/p&gt;
&lt;h4 id=&#34;6-ä¼˜åŒ–-streamid-ç±»å‹è½¬æ¢&#34;&gt;6. ä¼˜åŒ– streamID ç±»å‹è½¬æ¢&lt;/h4&gt;
&lt;p&gt;åœ¨ go ä¸­å°† byte æ•°ç»„å’Œ streamID è¿›è¡Œäº’è½¬çš„æ—¶å€™ï¼Œæ¯”è¾ƒè´¹æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç”Ÿäº§ä»£ç ä¸­ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ fmt.Sprintf å’Œ fmt.Printf å»åšç±»å‹è½¬æ¢å’Œæ‰“å°ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨ strconv å»è½¬æ¢ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;   .      430ms    147: reqIDStr :&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; fmt.Sprintf&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;%d&amp;#34;&lt;/span&gt;, reqID&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
60ms      4.10s    168: fmt.Printf&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;src=%s, len=%d, reqid:%v\n&amp;#34;&lt;/span&gt;, streamID, reqIDStrLen, reqIDStr&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;7-ä¼˜åŒ–æ˜‚è´µçš„ç³»ç»Ÿè°ƒç”¨&#34;&gt;7. ä¼˜åŒ–æ˜‚è´µçš„ç³»ç»Ÿè°ƒç”¨&lt;/h4&gt;
&lt;p&gt;mosn åœ¨è§£ç  dubbo çš„è¯·æ±‚æ—¶ï¼Œä¼šåœ¨ header ä¸­å¡ä¸€ä»½è¿œç¨‹ host çš„åœ°å€ï¼Œå¹¶ä¸”åœ¨ for å¾ªç¯ä¸­è·å– remote IPï¼Œç³»ç»Ÿè°ƒç”¨å¼€é”€æ¯”è¾ƒé«˜ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;50ms      920ms    136:        headers&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;strings.ToLower&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;protocol.MosnHeaderHostKey&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; conn.connection.RemoteAddr&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt;.String&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨è·å–è¿œç¨‹åœ°å€æ—¶ï¼Œå°½å¯èƒ½åœ¨ streamConnection ä¸­ cache è¿œç¨‹ IP å€¼ï¼Œä¸è¦æ¯æ¬¡éƒ½å»è°ƒç”¨ RemoteAddrã€‚&lt;/p&gt;
&lt;h4 id=&#34;8-ä¼˜åŒ–-slice-å’Œ-map-è§¦å‘æ‰©å®¹å’Œ-rehash&#34;&gt;8. ä¼˜åŒ– slice å’Œ map è§¦å‘æ‰©å®¹å’Œ rehash&lt;/h4&gt;
&lt;p&gt;åœ¨ mosn å¤„ç† dubbo è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®æ¥å£ã€ç‰ˆæœ¬å’Œåˆ†ç»„å»æ„å»º dataID ï¼Œç„¶ååŒ¹é… cluster , ä¼šåˆ›å»ºé»˜è®¤ slice å’Œ map å¯¹è±¡ï¼Œç»è¿‡æ€§èƒ½è¯Šæ–­ï¼Œå¯¼è‡´ä¸æ–­ allocate slice å’Œ grow map å®¹é‡æ¯”è¾ƒè´¹æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ slice å’Œ map æ—¶ï¼Œå°½å¯èƒ½é¢„ä¼°å®¹é‡å¤§å°ï¼Œä½¿ç”¨ make (type, capacity) å»æŒ‡å®šåˆå§‹å¤§å°ã€‚&lt;/p&gt;
&lt;h4 id=&#34;9-ä¼˜åŒ–-trace-æ—¥å¿—çº§åˆ«è¾“å‡º&#34;&gt;9. ä¼˜åŒ– trace æ—¥å¿—çº§åˆ«è¾“å‡º&lt;/h4&gt;
&lt;p&gt;mosn ä¸­ä¸å°‘ä»£ç åœ¨å¤„ç†é€»è¾‘æ—¶ï¼Œä¼šæ‰“å¾ˆå¤š trace çº§åˆ«çš„æ—¥å¿—ï¼Œå¹¶ä¸”ä¼šä¼ é€’ä¸å°‘å‚æ•°å€¼ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è°ƒç”¨ trace è¾“å‡ºå‰ï¼Œå°½é‡åˆ¤æ–­ä¸€ä¸‹æ—¥å¿—çº§åˆ«ï¼Œå¦‚æœæœ‰å¤šä¸ª trace è°ƒç”¨ï¼Œå°½å¯èƒ½æŠŠæ‰€æœ‰å­—ç¬¦ä¸²å†™åˆ° buf ä¸­ï¼Œç„¶åæŠŠ buf å†…å®¹å†™åˆ°æ—¥å¿—ä¸­ï¼Œå¹¶ä¸”å°½å¯èƒ½å°‘çš„è°ƒç”¨ trace æ—¥å¿—æ–¹æ³•ã€‚&lt;/p&gt;
&lt;h4 id=&#34;10-ä¼˜åŒ–-tracerlog-å’Œ-metrics&#34;&gt;10. ä¼˜åŒ– tracerã€log å’Œ metrics&lt;/h4&gt;
&lt;p&gt;åœ¨å¤§ä¿ƒæœŸé—´ï¼Œå¯¹æœºå™¨çš„æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç»è¿‡æ€§èƒ½è¯Šæ–­ï¼Œtracerã€mosn log å’Œ cloud metrics å†™æ—¥å¿—ï¼ˆ IO æ“ä½œï¼‰éå¸¸è€—è´¹æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡é…ç½®ä¸­å¿ƒä¸‹å‘é…ç½®æˆ–è€…å¢åŠ å¤§ä¿ƒå¼€å…³ï¼Œå…è®¸ API è°ƒç”¨è¿™äº› feature çš„å¼€å…³ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;/api/v1/downgrade/on
/api/v1/downgrade/off
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;11-ä¼˜åŒ–-route-header-è§£æ&#34;&gt;11. ä¼˜åŒ– route header è§£æ&lt;/h4&gt;
&lt;p&gt;MOSN ä¸­åœ¨åšè·¯ç”±å‰ï¼Œéœ€è¦åšå¤§é‡çš„ header çš„ map è®¿é—®ï¼Œæ¯”å¦‚ IDCã€antvip ç­‰é€»è¾‘åˆ¤æ–­ï¼Œå•†ä¸šç‰ˆæˆ–è€…å¼€æº mosn ä¸éœ€è¦è¿™äº›é€»è¾‘ï¼Œè¿™äº›ä¹Ÿä¼šå ç”¨ä¸€äº›å¼€é”€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœæ˜¯äº‘ä¸Šé€»è¾‘ï¼Œä¸»ç«™çš„é€»è¾‘éƒ½ä¸èµ°ã€‚&lt;/p&gt;
&lt;h4 id=&#34;12-ä¼˜åŒ–-featuregate-è°ƒç”¨&#34;&gt;12. ä¼˜åŒ– featuregate è°ƒç”¨&lt;/h4&gt;
&lt;p&gt;åœ¨ MOSN ä¸­å¤„ç†è¯·æ±‚æ—¶ï¼Œä¸ºäº†åŒºåˆ†ä¸»ç«™å’Œå•†ä¸šç‰ˆè·¯ç”±é€»è¾‘ï¼Œä¼šé€šè¿‡ featuregate åˆ¤æ–­é€»è¾‘èµ°å“ªéƒ¨åˆ†ã€‚é€šè¿‡ featuregate è°ƒç”¨å¼€é”€è¾ƒå¤§ï¼Œéœ€è¦é¢‘ç¹çš„åšç±»å‹è½¬æ¢å’Œå¤šå±‚ map å»è·å–ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŒ–æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä¸€ä¸ª bool å˜é‡è®°å½• featuregate å¯¹åº”å¼€å…³ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–è¿‡ï¼Œå°±ä¸»åŠ¨è°ƒç”¨ä¸€ä¸‹ featuregateã€‚&lt;/p&gt;
&lt;h3 id=&#34;æœªæ¥æ€§èƒ½ä¼˜åŒ–æ€è€ƒ&#34;&gt;æœªæ¥æ€§èƒ½ä¼˜åŒ–æ€è€ƒ&lt;/h3&gt;
&lt;p&gt;ç»è¿‡å‡ è½®æ€§èƒ½ä¼˜åŒ– ï¼Œç›®å‰çœ‹ç«ç„°å›¾ï¼Œå¡ç‚¹éƒ½åœ¨ connection çš„ read å’Œ write ï¼Œå¯ä»¥ä¼˜åŒ–çš„ç©ºé—´æ¯”è¾ƒå°äº†ã€‚ä½†æ˜¯å¯èƒ½ä»ä»¥ä¸‹åœºæ™¯ä¸­è·å¾—æ”¶ç›Šï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‡å°‘ connection çš„ read å’Œ write æ¬¡æ•° (syscall) ã€‚&lt;/li&gt;
&lt;li&gt;ä¼˜åŒ– IO çº¿ç¨‹æ¨¡å‹ï¼Œå‡å°‘æºç¨‹å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä½œä¸ºç»“æŸï¼Œç»™å‡ºäº†æœ€ç»ˆä¼˜åŒ–åçš„ç«ç„°å›¾ ï¼Œå¤§éƒ¨åˆ†å¡ç‚¹éƒ½åœ¨ç³»ç»Ÿè°ƒç”¨å’Œç½‘ç»œè¯»å†™ï¼Œè¯·å‚è€ƒå›¾ 1-4ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;007S8ZIlgy1gfm13ju486j31hc0kfdms.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å›¾ 1-4 ä¼˜åŒ–ç‰ˆæœ¬ MOSN + Dubbo ç«çº¿å›¾&lt;/p&gt;
&lt;h3 id=&#34;å…¶ä»–&#34;&gt;å…¶ä»–&lt;/h3&gt;
&lt;p&gt;pprof å·¥å…·å¼‚å¸¸å¼ºå¤§ï¼Œå¯ä»¥è¯Šæ–­ CPUã€memoryã€go åç¨‹ã€tracer å’Œæ­»é”ç­‰ï¼Œè¯¥å·¥å…·å¯ä»¥å‚è€ƒ &lt;a href=&#34;https://blog.golang.org/pprof&#34;&gt;godoc&lt;/a&gt;ï¼Œæ€§èƒ½ä¼˜åŒ–å‚è€ƒï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.golang.org/pprof&#34;&gt;https://blog.golang.org/pprof&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.cnblogs.com/Dr-wei/p/11742414.html&#34;&gt;https://www.cnblogs.com/Dr-wei/p/11742414.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;å…³äºä½œè€…&#34;&gt;å…³äºä½œè€…&lt;/h3&gt;
&lt;p&gt;å•†å®—æµ·ï¼ˆè¯£æï¼‰ï¼ŒGitHub ID zonghaishangï¼ŒApache Dubbo PMCï¼Œç›®å‰å°±èŒäºèš‚èšé›†å›¢é‡‘æœä¸­é—´ä»¶å›¢é˜Ÿï¼Œä¸»æ”» RPC å’Œ Service Mesh æ–¹å‘ã€‚ ã€Šæ·±å…¥ç†è§£ Apache Dubbo ä¸å®æˆ˜ã€‹ä¸€ä¹¦ä½œè€…ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - æ€»è§ˆ</title>
      <link>https://mosn.io/blog/code/mosn-overview/</link>
      <pubDate>Fri, 08 May 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-overview/</guid>
      <description>
        
        
        &lt;h2 id=&#34;èµ·å› &#34;&gt;èµ·å› &lt;/h2&gt;
&lt;p&gt;åœ¨2020å¹´ä¼Šå§‹ï¼ŒMOSN å›¢é˜Ÿåœ¨ç¤¾åŒºå‘èµ·äº† MOSN æºç è§£æç³»åˆ—æ´»åŠ¨ï¼Œæœ¬æ¬¡æ´»åŠ¨æ—¨åœ¨å¢å¼ºç¤¾åŒºå¯¹ MOSN çš„è®¤çŸ¥ï¼Œä¿ƒè¿›å¼€æºç¤¾åŒºçš„äº¤æµï¼Œæ˜¯å¤§å®¶å­¦ä¹ å’Œä½¿ç”¨ MOSNï¼Œä¸ MOSN çš„æ ¸å¿ƒå¼€å‘è€…ç›´æ¥äº¤æµçš„ä¸€ä¸ªè‰¯å¥½å¥‘æœºã€‚&lt;/p&gt;
&lt;p&gt;ç»è¿‡åå‡ ä½ç¤¾åŒºåŒå­¦çš„å‚ä¸ï¼Œç›®å‰åå››ç¯‡æ–‡ç« éƒ½å·²ç»å®Œæˆï¼Œæœ¬æ–‡å°†åšä¸€ä¸ªæ•´ä½“ä»‹ç»ï¼Œæ–¹ä¾¿å¤§å®¶æ›´å¥½çš„äº†è§£ MOSNã€‚æŸ¥çœ‹åŸæ–‡è§£æç³»åˆ—æ–‡ç« è¯·è®¿é—®ï¼š &lt;a href=&#34;https://mosn.io/blog/code/&#34;&gt;https://mosn.io/blog/code/&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¨¡å—èƒ½åŠ›&#34;&gt;æ¨¡å—èƒ½åŠ›&lt;/h2&gt;
&lt;p&gt;é¦–å…ˆæ˜¯ MOSN çš„ &lt;a href=&#34;../mosn-startup/&#34;&gt;å¯åŠ¨æµç¨‹&lt;/a&gt;ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥äº†è§£ MOSN çš„å¯åŠ¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é…ç½®è§£æï¼Œæ—¥å¿—åˆå§‹åŒ–ï¼ŒXds åˆå§‹åŒ–ï¼Œå„å­æ¨¡å—å¯åŠ¨ï¼ŒAdminApi åˆå§‹åŒ–ç­‰èƒ½åŠ›ï¼Œä¹Ÿä»‹ç»äº†æ™®é€šå¯åŠ¨å’Œçƒ­å‡çº§å¯åŠ¨çš„åŒºåˆ«ï¼Œå¯¹ MOSN çš„å¹³æ»‘å‡çº§èƒ½åŠ›æœ‰ä¸€ä¸ªåˆæ­¥çš„äº†è§£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-router/&#34;&gt;è·¯ç”±&lt;/a&gt; è¿™ä¸ªç« èŠ‚ï¼Œä½ å¯ä»¥äº†è§£è·¯ç”±çš„é…ç½®è§£æï¼Œè¿è¡Œæ–¹å¼å’ŒåŠ¨æ€è·¯ç”±ç­‰èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ &lt;a href=&#34;../mosn-tls/&#34;&gt;TLS&lt;/a&gt; ä½ å¯ä»¥äº†è§£ MOSN æ€æ ·é›†æˆ Go Runtime çš„ TLS èƒ½åŠ›ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæˆ‘ä»¬è¿›è¡Œäº†é‚£äº›èƒ½åŠ›çš„åŠ å¼ºï¼Œæ¯”å¦‚æ˜æ–‡å¯†æ–‡è‡ªåŠ¨è¯†åˆ«èƒ½åŠ›ï¼ŒSDS èƒ½åŠ›æ”¯æŒï¼Œå¯¹ TLS æ¡æ‰‹è¿›è¡Œè‡ªå®šä¹‰æ ¡éªŒçš„æ‰©å±•èƒ½åŠ›ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../../posts/multi-protocol-deep-dive/&#34;&gt;å¤šåè®®æœºåˆ¶&lt;/a&gt; æ˜¯ MOSN æ¯”è¾ƒé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œä½ å¯ä»¥äº†è§£å¤šåè®®æœºåˆ¶äº§ç”Ÿçš„èƒŒæ™¯ä¸å®è·µç—›ç‚¹ï¼Œä¸€äº›å¸¸è§çš„åè®®æ‰©å±•æ€è·¯åˆæ¢ï¼ŒSOFABolt åè®®æ¥å…¥å®è·µï¼Œä»¥åŠ MOSN å¤šåè®®æœºåˆ¶è®¾è®¡è§£è¯»ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªè‡ªå·±çš„åè®®äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-variable/&#34;&gt;å˜é‡æœºåˆ¶&lt;/a&gt; æ˜¯ MOSN çš„ä¸€ä¸ªæ ¸å¿ƒèƒ½åŠ›ï¼Œé€šè¿‡è¯¥æœºåˆ¶ï¼ŒMOSN å¯ä»¥æ–¹ä¾¿çš„è·å–å’Œè®¾ç½®ä¸€äº›è‡ªå®šä¹‰çš„å€¼ï¼Œæ¥æ»¡è¶³æ‰“å°æ—¥å¿—ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¯·æ±‚è‡ªå®šå˜é‡ç­‰èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-shm/&#34;&gt;å…±äº«å†…å­˜æ¨¡å‹&lt;/a&gt; è®²è§£äº† MOSN çš„å…±äº«å†…å­˜æ¡†æ¶ï¼ŒMOSN é€šè¿‡è¿™ä¸ªæ¡†æ¶å®ç°äº†å…±äº«å†…å­˜ metrics å®ç°ï¼Œç”¨äºå¹³æ»‘å‡çº§æ—¶ä¿è¯ metric æ•°æ®çš„å‡†ç¡®æ€§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æ”¯æŒ MOSN è·¨è¯­è¨€çš„æ‰©å±•æœºåˆ¶èƒ½åŠ›ï¼Œæˆ‘ä»¬å¼€å‘äº† &lt;a href=&#34;../mosn-plugin/&#34;&gt;pluginæœºåˆ¶&lt;/a&gt;ï¼Œé€šè¿‡ç‹¬ç«‹è¿›ç¨‹è¿›è¡ŒGRPCäº¤äº’ï¼Œè®©ç”¨æˆ·å¯ä»¥ç”¨ä»»ä½•è¯­è¨€æ¥å¼€å‘æ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-connection-pool/&#34;&gt;è¿æ¥æ± &lt;/a&gt; ä»‹ç»äº† MOSN é’ˆå¯¹è¿æ¥æ± çš„ç®¡ç†å’Œä½¿ç”¨ã€‚è¿æ¥æ± æ˜¯ä¸Šä¸‹æ¸¸ MOSN ä¹‹é—´è¿›è¡Œé•¿è¿æ¥å¤ç”¨ä»¥æé«˜è½¬å‘æ•ˆç‡ä¸é™ä½æ—¶å»¶çš„å…³é”®ï¼ŒMOSN è¿æ¥æ± æä¾›åŸºäº HTTP1, HTTP2, SOFARPC, XProtocol åè®®çš„è¿æ¥æ± ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-eventloop/&#34;&gt;åç¨‹æ¨¡å‹&lt;/a&gt; è®²è§£äº†MOSNçš„æ•´ä¸ªè½¬å‘æµç¨‹ï¼ŒåŒ…æ‹¬è¯»å†™IOæµç¨‹ï¼ŒproxyçŠ¶æ€æœºï¼Œåç¨‹æ± ç­‰æ ¸å¿ƒèƒ½åŠ›ï¼Œå¯ä»¥è®©è¯»è€…æ›´åŠ æ¸…æ™°çš„äº†è§£ MOSN çš„å¤„ç†æµç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;Go è¯­è¨€çš„ GC å¯¹ç¨‹åºçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ï¼Œé’ˆå¯¹äºæ­¤æˆ‘ä»¬å¼€å‘äº† &lt;a href=&#34;../mosn-buffer/&#34;&gt;å†…å­˜å¤ç”¨æœºåˆ¶&lt;/a&gt;ï¼Œå‡å°‘ GC æ¥æå‡ MOSN æ€§èƒ½ï¼Œæœ¬æ–‡åˆ†æäº† MOSN å¯¹å†…å­˜å¤ç”¨çš„è®¾è®¡å’Œç”¨æ³•ï¼Œå…¶åŸºäº sync.Pool ä¹‹ä¸Šå°è£…äº†ä¸€å±‚è‡ªå·±çš„æ³¨å†Œç®¡ç†é€»è¾‘ï¼Œå¢å¼ºäº†ç®¡ç†èƒ½åŠ›ã€æ˜“ç”¨æ€§å’Œå¤ç”¨æ€§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-log/&#34;&gt;logç³»ç»Ÿ&lt;/a&gt; ä»‹ç»äº† log æ—¥å¿—å’Œ metric ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œlog ä¹Ÿä½œä¸ºä¸€ä¸ªå•ç‹¬çš„åº“ï¼Œè¯»è€…å¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-xds/&#34;&gt;xds&lt;/a&gt; ä»‹ç»äº† MOSN å¯¹é½ xds èƒ½åŠ›çš„ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-http/&#34;&gt;HTTPèƒ½åŠ›&lt;/a&gt; ä»‹ç» MOSN å¯¹ HTTP çš„å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬é€‚é… fasthttpï¼Œå†…å­˜å¤ç”¨ï¼Œè¿æ¥æ± ç­‰èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../mosn-filters/&#34;&gt;filteræ‰©å±•æœºåˆ¶&lt;/a&gt; åˆ†æäº† filter æ‰©å±•æœºåˆ¶çš„å®ç°ï¼Œå¹¶ç®€è¿°äº†å®ç°è‡ªå·±çš„ filter éœ€è¦åšçš„ä¸œè¥¿ã€‚å¤§å®¶å¯ä»¥é€šè¿‡è¯¥æœºåˆ¶ï¼Œä½¿ç”¨ MOSN æ¥å¤„ç†è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœ€å&#34;&gt;æœ€å&lt;/h2&gt;
&lt;p&gt;æ„Ÿè°¢ç¤¾åŒºåŒå­¦çš„çƒ­æƒ…å‚ä¸ï¼ŒMOSN æºç è§£ææ´»åŠ¨åœ†æ»¡æ”¶å°¾ï¼Œä¹Ÿæ•¬è¯·å…³æ³¨æˆ‘ä»¬åç»­çš„å…¶ä»–æ´»åŠ¨ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æ”¯æŒä½¿ç”¨ SkyWalking è¿›è¡Œåˆ†å¸ƒå¼è¿½è¸ª</title>
      <link>https://mosn.io/blog/posts/skywalking-support/</link>
      <pubDate>Tue, 28 Apr 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/skywalking-support/</guid>
      <description>
        
        
        &lt;p&gt;ç›¸æ¯”ä¼ ç»Ÿçš„å·¨çŸ³ï¼ˆMonolithï¼‰åº”ç”¨ï¼Œå¾®æœåŠ¡çš„ä¸€ä¸ªä¸»è¦å˜åŒ–æ˜¯å°†åº”ç”¨ä¸­çš„ä¸åŒæ¨¡å—æ‹†åˆ†ä¸ºäº†ç‹¬ç«‹çš„è¿›ç¨‹ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼ŒåŸæ¥è¿›ç¨‹å†…çš„æ–¹æ³•è°ƒç”¨æˆä¸ºäº†è·¨è¿›ç¨‹çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚ç›¸å¯¹äºå•ä¸€è¿›ç¨‹å†…çš„æ–¹æ³•è°ƒç”¨è€Œè¨€ï¼Œè·¨è¿›ç¨‹è°ƒç”¨çš„è°ƒè¯•å’Œæ•…éšœåˆ†ææ˜¯éå¸¸å›°éš¾çš„ï¼Œéš¾ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ä»£ç è°ƒè¯•ç¨‹åºæˆ–è€…æ—¥å¿—æ‰“å°æ¥å¯¹åˆ†å¸ƒå¼çš„è°ƒç”¨è¿‡ç¨‹è¿›è¡ŒæŸ¥çœ‹å’Œåˆ†æã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;tracing.jpg&#34; alt=&#34;åˆ†å¸ƒå¼è¿½è¸ªç¤ºæ„å›¾&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚ä¸Šå›¾å³è¾¹æ‰€ç¤ºï¼Œå¾®æœåŠ¡æ¶æ„ä¸­ç³»ç»Ÿä¸­å„ä¸ªå¾®æœåŠ¡ä¹‹é—´å­˜åœ¨å¤æ‚çš„è°ƒç”¨å…³ç³»ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨å…¶ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ç»è¿‡äº†å¤šä¸ªå¾®æœåŠ¡è¿›ç¨‹ã€‚æˆ‘ä»¬å¦‚æœæƒ³è¦å¯¹è¯¥è¯·æ±‚çš„ç«¯åˆ°ç«¯è°ƒç”¨è¿‡ç¨‹è¿›è¡Œå®Œæ•´çš„åˆ†æï¼Œåˆ™å¿…é¡»å°†è¯¥è¯·æ±‚ç»è¿‡çš„æ‰€æœ‰è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯éƒ½æ”¶é›†èµ·æ¥å¹¶å…³è”åœ¨ä¸€èµ·ï¼Œè¿™å°±æ˜¯â€œåˆ†å¸ƒå¼è¿½è¸ªâ€ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸Šå…³äºåˆ†å¸ƒå¼è¿½è¸ªçš„ä»‹ç»å¼•ç”¨è‡ª &lt;a href=&#34;https://www.servicemesher.com/istio-handbook/practice/distributed-tracing.html&#34;&gt;Istio Handbook&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-ä¸­-tracing-çš„æ¶æ„&#34;&gt;MOSN ä¸­ tracing çš„æ¶æ„&lt;/h2&gt;
&lt;p&gt;MOSN çš„ tracing æ¡†æ¶ç”± Driverã€Tracer å’Œ Span ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚&lt;/p&gt;
&lt;p&gt;Driver æ˜¯ Tracer çš„å®¹å™¨ï¼Œç®¡ç†æ³¨å†Œçš„ Tracer å®ä¾‹ï¼ŒTracer æ˜¯ tracing çš„å…¥å£ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯åˆ›å»ºä¸€ä¸ª Spanï¼ŒSpan å­˜å‚¨å½“å‰è·¨åº¦çš„é“¾è·¯ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn-tracing.jpg&#34; alt=&#34;MOSN ä¸­çš„ tracing æ¶æ„&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç›®å‰ MOSN tracing æœ‰ &lt;a href=&#34;http://github.com/sofastack/sofa-tracer&#34;&gt;SOFATracer&lt;/a&gt; å’Œ SkyWalking ä¸¤ç§å®ç°ã€‚SOFATracer æ”¯æŒ http1 å’Œ xprotocol åè®®çš„é“¾è·¯è¿½è¸ªï¼Œå°† trace æ•°æ®å†™å…¥æœ¬åœ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚SkyWalking æ”¯æŒ http1 åè®®çš„é“¾è·¯è¿½è¸ªï¼Œä½¿ç”¨åŸç”Ÿçš„ Go è¯­è¨€æ¢é’ˆ &lt;a href=&#34;https://github.com/SkyAPM/go2sky&#34;&gt;go2sky&lt;/a&gt; å°† trace æ•°æ®é€šè¿‡ gRPC ä¸ŠæŠ¥åˆ° SkyWalking åç«¯æœåŠ¡ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¿«é€Ÿå¼€å§‹&#34;&gt;å¿«é€Ÿå¼€å§‹&lt;/h2&gt;
&lt;p&gt;ä¸‹é¢å°†ä½¿ç”¨ Docker å’Œ &lt;code&gt;docker-compose&lt;/code&gt; æ¥å¿«é€Ÿå¼€å§‹è¿è¡Œä¸€ä¸ªé›†æˆäº† SkyWalking çš„åˆ†å¸ƒå¼è¿½è¸ªç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä»£ç è¯·è§ &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/trace/skywalking/http&#34;&gt;MOSN GitHub&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å‡†å¤‡&#34;&gt;å‡†å¤‡&lt;/h3&gt;
&lt;p&gt;å®‰è£… docker å’Œ docker-composeã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/install/&#34;&gt;å®‰è£… docker&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/compose/install/&#34;&gt;å®‰è£… docker-compose&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;éœ€è¦ä¸€ä¸ªç¼–è¯‘å¥½çš„ MOSN ç¨‹åºï¼Œæ‚¨å¯ä»¥&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;ä¸‹è½½ MOSN æºç &lt;/a&gt;è‡ªè¡Œç¼–è¯‘ï¼Œæˆ–è€…ç›´æ¥ä¸‹è½½ &lt;a href=&#34;https://github.com/mosn/mosn/releases/tag/v0.12.0&#34;&gt;MOSN v0.12.0 å‘è¡Œç‰ˆ&lt;/a&gt;ä»¥è·å– MOSN çš„è¿è¡Œæ—¶äºŒè¿›åˆ¶æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢å°†ä»¥æºç ç¼–è¯‘çš„æ–¹å¼æ¼”ç¤º MOSN å¦‚ä½•ä¸ SkyWalking é›†æˆã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;projectpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt;/cmd/mosn/main
go build
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è·å–ç¤ºä¾‹ä»£ç ç›®å½•ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;targetpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;projectpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt;/examples/codes/trace/skywalking/http/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å°†ç¼–è¯‘å¥½çš„ç¨‹åºç§»åŠ¨åˆ°ç¤ºä¾‹ä»£ç ç›®å½•ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;mv main &lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;targetpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt;/
&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;targetpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;ç›®å½•ç»“æ„&#34;&gt;ç›®å½•ç»“æ„&lt;/h3&gt;
&lt;p&gt;ä¸‹é¢æ˜¯ SkyWalking çš„ç›®å½•ç»“æ„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;* skywalking
â””â”€â”€â”€ http
â”‚           main                           &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# ç¼–è¯‘å®Œæˆçš„ MOSN ç¨‹åº&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           server.go                      &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# æ¨¡æ‹Ÿçš„ Http Server&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           clint.go                       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# æ¨¡æ‹Ÿçš„ Http Client&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           config.json                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# MOSN é…ç½®&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;           skywalking-docker-compose.yaml &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# skywalking docker-compose&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;è¿è¡Œè¯´æ˜&#34;&gt;è¿è¡Œè¯´æ˜&lt;/h3&gt;
&lt;p&gt;å¯åŠ¨ SkyWalking oap &amp;amp; uiã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;docker-compose -f skywalking-docker-compose.yaml up -d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨ä¸€ä¸ª HTTP Serverã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go run server.go
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨ MOSNã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;./main start -c config.json
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨ä¸€ä¸ª HTTP Clientã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go run client.go
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ‰“å¼€ &lt;a href=&#34;http://127.0.0.1:8080/&#34;&gt;http://127.0.0.1:8080&lt;/a&gt; æŸ¥çœ‹ SkyWalking-UIï¼ŒSkyWalking Dashboard ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;skywalking-dashboard.png&#34; alt=&#34;SkyWalking Dashboard&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‰“å¼€ Dashboard åè¯·ç‚¹å‡»å³ä¸Šè§’çš„ &lt;code&gt;Auto&lt;/code&gt; æŒ‰é’®ä»¥ä½¿é¡µé¢è‡ªåŠ¨åˆ·æ–°ã€‚&lt;/p&gt;
&lt;h3 id=&#34;demo-è§†é¢‘&#34;&gt;Demo è§†é¢‘&lt;/h3&gt;
&lt;p&gt;ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¯¥ Demo çš„æ“ä½œè§†é¢‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.bilibili.com/video/BV17i4y1t7mZ/&#34;&gt;&lt;img src=&#34;demo.jpg&#34; alt=&#34;Demo&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ¸…ç†&#34;&gt;æ¸…ç†&lt;/h3&gt;
&lt;p&gt;è¦æƒ³é”€æ¯ SkyWalking åå°è¿è¡Œçš„ docker å®¹å™¨åªéœ€è¦ä¸‹é¢çš„å‘½ä»¤ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#204a87&#34;&gt;cd&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;projectpath&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}&lt;/span&gt;/examples/codes/trace/skywalking/http/
docker-compose -f skywalking-docker-compose.yaml down
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æœªæ¥è®¡åˆ’&#34;&gt;æœªæ¥è®¡åˆ’&lt;/h2&gt;
&lt;p&gt;åœ¨ä»Šå¹´äº”æœˆä»½ï¼ŒSkyWalking  8.0 ç‰ˆæœ¬ä¼šè¿›è¡Œä¸€æ¬¡å…¨é¢å‡çº§ï¼Œé‡‡ç”¨æ–°çš„æ¢é’ˆåè®®å’Œåˆ†æé€»è¾‘ï¼Œæ¢é’ˆå°†æ›´å…·äº’æ„ŸçŸ¥èƒ½åŠ›ï¼Œæ›´å¥½çš„åœ¨ Service Mesh ä¸‹ä½¿ç”¨æ¢é’ˆè¿›è¡Œç›‘æ§ã€‚åŒæ—¶ï¼ŒSkyWalking å°†å¼€æ”¾ä¹‹å‰ä»…å­˜åœ¨äºå†…æ ¸ä¸­çš„ metrics æŒ‡æ ‡åˆ†æä½“ç³»ã€‚Prmoetheusã€Spring Cloud Sleuthã€Zabbix ç­‰å¸¸ç”¨çš„ metrics ç›‘æ§æ–¹å¼ï¼Œéƒ½ä¼šè¢«ç»Ÿä¸€çš„æ¥å…¥è¿›æ¥ï¼Œè¿›è¡Œåˆ†æã€‚æ­¤å¤–ï¼Œ SkyWalking ä¸ MOSN ç¤¾åŒºå°†ç»§ç»­åˆä½œï¼šæ”¯æŒè¿½è¸ª Dubbo å’Œ &lt;a href=&#34;https://github.com/sofastack/sofa-rpc&#34;&gt;SOFARPC&lt;/a&gt;ï¼ŒåŒæ—¶é€‚é… sidecar æ¨¡å¼ä¸‹çš„é“¾è·¯è¿½è¸ªã€‚&lt;/p&gt;
&lt;h2 id=&#34;å…³äº-mosn&#34;&gt;å…³äº MOSN&lt;/h2&gt;
&lt;p&gt;MOSN æ˜¯ä¸€æ¬¾ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ç½‘ç»œä»£ç†è½¯ä»¶ï¼Œç”±èš‚èšé›†å›¢å¼€æºå¹¶ç»è¿‡å‡ åä¸‡å®¹å™¨çš„ç”Ÿäº§çº§éªŒè¯ã€‚ MOSN ä½œä¸ºäº‘åŸç”Ÿçš„ç½‘ç»œæ•°æ®å¹³é¢ï¼Œæ—¨åœ¨ä¸ºæœåŠ¡æä¾›å¤šåè®®ã€æ¨¡å—åŒ–ã€æ™ºèƒ½åŒ–ã€å®‰å…¨çš„ä»£ç†èƒ½åŠ›ã€‚ MOSN æ˜¯ Modular Open Smart Network çš„ç®€ç§°ã€‚ MOSN å¯ä»¥ä¸ä»»ä½•æ”¯æŒ xDS API çš„ Service Mesh é›†æˆï¼Œäº¦å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„å››ã€ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼ŒAPI Gatewayã€äº‘åŸç”Ÿ Ingress ç­‰ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GitHubï¼š&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;https://github.com/mosn/mosn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å®˜ç½‘ï¼š&lt;a href=&#34;https://mosn.io&#34;&gt;https://mosn.io&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å…³äº-skywalking&#34;&gt;å…³äº Skywalking&lt;/h2&gt;
&lt;p&gt;SkyWalking æ˜¯è§‚å¯Ÿæ€§åˆ†æå¹³å°å’Œåº”ç”¨æ€§èƒ½ç®¡ç†ç³»ç»Ÿã€‚æä¾›åˆ†å¸ƒå¼è¿½è¸ªã€æœåŠ¡ç½‘æ ¼é¥æµ‹åˆ†æã€åº¦é‡èšåˆå’Œå¯è§†åŒ–ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆã€‚æ”¯æŒ Javaã€.Net Coreã€PHPã€NodeJSã€Golangã€LUA è¯­è¨€æ¢é’ˆï¼Œæ”¯æŒ Envoy/MOSN + Istio æ„å»ºçš„ Service Meshã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GitHubï¼š&lt;a href=&#34;https://github.com/apache/skywalking&#34;&gt;https://github.com/apache/skywalking&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å®˜ç½‘ï¼š&lt;a href=&#34;https://skywalking.apache.org&#34;&gt;https://skywalking.apache.org&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…³äºæœ¬æ–‡ä¸­çš„ç¤ºä¾‹è¯·å‚è€ƒ &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/trace/skywalking/http&#34;&gt;MOSN GitHub&lt;/a&gt; å’Œ &lt;a href=&#34;https://mosn.iodocs/configuration/trace/&#34;&gt;MOSN å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - TLS</title>
      <link>https://mosn.io/blog/code/mosn-tls/</link>
      <pubDate>Sun, 26 Apr 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-tls/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡åŸºäºçš„å†…å®¹æ˜¯ MOSN v0.12.0ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ¦‚è¿°&#34;&gt;æ¦‚è¿°&lt;/h3&gt;
&lt;p&gt;MOSN æä¾›äº†åŸºäº TLS åŠ å¯†çš„å®‰å…¨é€šä¿¡çš„èƒ½åŠ›ï¼Œæœ¬æ–‡ä¸»è¦ä»ä¸‰ä¸ªæ–¹é¢ä»‹ç» MOSN çš„ TLS ç›¸å…³å®ç°ï¼ŒåŒ…æ‹¬ï¼šMOSN ä½œä¸ºæœåŠ¡ç«¯æä¾› TLS çš„èƒ½åŠ›ã€MOSN ä½œä¸ºå®¢æˆ·ç«¯æä¾› TLS çš„èƒ½åŠ›ï¼Œä»¥åŠ TLS æ¨¡å—çš„å®ç°ã€‚å…³äº TLS çš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒé…ç½®æ–‡ä»¶è¯´æ˜çš„æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æœåŠ¡ç«¯-listener&#34;&gt;æœåŠ¡ç«¯ (Listener)&lt;/h3&gt;
&lt;p&gt;MOSN ä½œä¸ºæœåŠ¡ç«¯çš„æ—¶å€™ï¼Œå°±æ˜¯æœ‰è¯·æ±‚å‘é€åˆ° MOSNï¼ŒåŸºäº MOSN çš„ Listener å¤„ç†è¯·æ±‚ã€‚Listener åšé…ç½®è§£æçš„æ—¶å€™ï¼Œå¦‚æœå­˜åœ¨ TLS ç›¸å…³çš„é…ç½®ï¼Œä¼šå°è¯•ç”Ÿæˆä¸€ä¸ª TLSManagerï¼Œåœ¨è¿æ¥å»ºç«‹çš„æ—¶å€™ï¼Œä¼šæ ¹æ® TLSManager è¿”å›çš„çŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦å»ºç«‹ TLS åŠ å¯†è¿æ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newActiveListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å…¶ä»–å‚æ•°çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;mgr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mtls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewTLSServerContextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mgr&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnAccept&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å…¶ä»–å‚æ•°çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// if ch is not nil, the conn has been initialized in func transferNewConn
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;arc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newActiveRawConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åˆ¤æ–­æ˜¯å¦éœ€è¦å»ºç«‹ TLS è¿æ¥ä¼šåŸºäº TLSManager çš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœ TLSManager æ˜¯å…³é—­ TLS çŠ¶æ€ï¼Œåˆ™ä¸€å®šä¸æ”¯æŒ TLS è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœ TLSManager æ˜¯å¼€å¯ TLS çŠ¶æ€ï¼Œè¿˜éœ€è¦é¢å¤–åˆ¤æ–­æ˜¯å¦æ”¯æŒ Inspector æ¨¡å¼ï¼Œå¦‚æœæ”¯æŒ Inspectorï¼Œåˆ™è¯´æ˜ MOSN çš„ Listener å¯ä»¥åŒæ—¶å¤„ç† TLS åŠ å¯†è¿æ¥å’Œæ˜æ–‡çš„éåŠ å¯†è¿æ¥ï¼›æ­¤æ—¶ MOSN ä¼šç­‰å¾…è¿æ¥ä¸Šæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯æ˜æ–‡è¿˜æ˜¯ TLSï¼Œä»è€Œå†³å®šä½¿ç”¨è¿æ¥çŠ¶æ€ã€‚å¦‚æœä¸æ”¯æŒ Inspector æ¨¡å¼ï¼Œé‚£ä¹ˆå°±åªæ”¯æŒ TLS è¿æ¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åˆ¤æ–­æ˜¯å¦å…¼å®¹ Inspector çš„é€»è¾‘å¦‚ä¸‹ã€‚MOSN ä¼šåœ¨å»ºç«‹ä¸Šæ‰§è¡Œ&lt;code&gt;Peek&lt;/code&gt;ï¼Œå°è¯•è·å–è¿æ¥ä¸Šç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚ï¼Œå¦‚æœæ˜¯ 0x16ï¼ˆæ¥è‡ª TLS æ¡æ‰‹çš„ Client Hello çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰ï¼Œåˆ™åˆ¤æ–­ä¸º TLS è¿æ¥ï¼Œå¦åˆ™åˆ¤æ–­ä¸ºæ˜æ–‡è¿æ¥ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mng&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverContextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TCPConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Enabled&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;inspector&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()),&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// inspector
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Peek&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// TLS handshake
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0x16&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()),&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Non TLS
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é™¤äº†æ™®é€šçš„ TLS ä»¥å¤–ï¼ŒMOSN è¿˜æ”¯æŒåŒå‘ TLSï¼Œå³ Server ç«¯è¦æ±‚ Client ç«¯ä¹Ÿæä¾›è¯ä¹¦ï¼Œä¹Ÿæ˜¯å¯ä»¥é…ç½®ä¸åŒçš„å…¼å®¹åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Client å¿…é¡»æä¾› TLS è¯ä¹¦ï¼Œå®ŒæˆåŒå‘ TLS åŠ å¯†ã€‚&lt;/li&gt;
&lt;li&gt;è¦æ±‚ Client æä¾› TLS è¯ä¹¦ï¼Œä½†æ˜¯å¦‚æœ Client æ²¡æœ‰æä¾›è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥å…¼å®¹æ‰§è¡Œæ™®é€šçš„ TLS åŠ å¯†é€»è¾‘å®ç°å¦‚ä¸‹ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;setServerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConfigHooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// no certificate should be set no server tls config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificates&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequireClientCert&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientAuth&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NoClientCert&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;VerifyClient&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientAuth&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequireAndVerifyClientCert&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientAuth&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;VerifyClientCertIfGiven&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;VerifyPeerCertificate&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServerHandshakeVerify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tlsConfig&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// build matches
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buildMatch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å®¢æˆ·ç«¯-cluster&#34;&gt;å®¢æˆ·ç«¯ (Cluster)&lt;/h3&gt;
&lt;p&gt;MOSN ä½œä¸ºå®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œå°±æ˜¯ MOSN åœ¨æŠŠè¯·æ±‚å‘åç«¯ï¼ˆUpstreamï¼‰è½¬å‘çš„æ—¶å€™ï¼ŒåŸºäº MOSN çš„ Cluster é…ç½®è½¬å‘è¯·æ±‚ã€‚åœ¨ Cluster é…ç½®è§£æçš„æ—¶å€™ï¼Œå¦‚æœå­˜åœ¨ TLS ç›¸å…³çš„é…ç½®ï¼Œä¼šå°è¯•ç”Ÿæˆä¸€ä¸ª TLSManagerã€‚åœ¨è½¬å‘è¯·æ±‚å‘åç«¯å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œä¼šåŸºäºä¸¤ä¸ªç»´åº¦åˆ¤æ–­æ˜¯å¦è¦å»ºç«‹ TLS è¿æ¥ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é¦–å…ˆåˆ¤æ–­å»ºç«‹è¿æ¥çš„ Host é…ç½®æ˜¯å¦å…è®¸å»ºç«‹ TLS è¿æ¥ï¼Œè¿™ä¸ªæ˜¯è€ƒè™‘åˆ°æœ‰çš„åœºæ™¯ç‰¹å®šçš„ Host ä¸å¸Œæœ›å»ºç«‹ TLS è¿æ¥æˆ–è€…ä¸æ”¯æŒ TLS è¿æ¥è¿›è¡Œçš„è®¾è®¡ã€‚é»˜è®¤é…ç½®æƒ…å†µä¸‹ï¼ŒHost é…ç½®éƒ½æ˜¯å…è®¸å»ºç«‹ TLS è¿æ¥çš„ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ Host å…è®¸å»ºç«‹ TLS çš„æƒ…å†µä¸‹ï¼Œä¼šæ ¹æ® TLSManager çš„çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦è¦å»ºç«‹ TLS è¿æ¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newSimpleCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterConfig&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;simpleCluster&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;mgr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mtls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewTLSClientContextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLS&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ—¥å¿—è®°å½•ï¼Œæ­¤æ—¶ Cluster è¿˜å¯ä»¥æ­£å¸¸åˆ›å»ºï¼Œç­‰åŒäºä¸æ”¯æŒ TLS
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mgr&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;simpleCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sh&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;simpleHost&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;CreateConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateConnectionData&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSContextManager&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sh&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SupportTLS&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
         &lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sh&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSMng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;clientConn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;network&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewClientConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sh&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConnectTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tlsMng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sh&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Address&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;tls-æ¨¡å—&#34;&gt;TLS æ¨¡å—&lt;/h3&gt;
&lt;p&gt;MOSN çš„ TLS èƒ½åŠ›ï¼Œéƒ½é€šè¿‡ TLSManager æä¾›ï¼ŒTLSManager åˆ†ä¸º ServerManager å’Œ ClientManagerï¼Œåˆ†åˆ«æœ‰å„è‡ªçš„é€»è¾‘ï¼Œå…¶æ ¸å¿ƒéƒ½æ˜¯é€šè¿‡ Conn æ–¹æ³•ï¼Œåˆ©ç”¨ Provider æä¾›&lt;code&gt;tls.Config&lt;/code&gt;ï¼Œå»ºç«‹ TLS è¿æ¥ã€‚&lt;/p&gt;
&lt;h4 id=&#34;provider&#34;&gt;provider&lt;/h4&gt;
&lt;p&gt;provider æ˜¯ MOSN çš„ TLS æ¨¡å—ä¸­æä¾› TLS è¿è¡Œæ—¶é…ç½®çš„æ¨¡å—ï¼Œæ”¯æŒé™æ€é…ç½®æ¨¡å¼&lt;code&gt;staticProvider&lt;/code&gt;å’ŒåŠ¨æ€ SDS æ¨¡å¼&lt;code&gt;sdsProvider&lt;/code&gt;ã€‚æ— è®ºæ˜¯å“ªç§æ¨¡å¼ï¼Œprovider ä¸­æœ€ç»ˆå­˜å‚¨çš„å¯¹è±¡éƒ½æ˜¯ MOSN å®šä¹‰çš„&lt;code&gt;tlsContext&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;MOSN åœ¨è¿›è¡Œé…ç½®è§£ææ—¶ï¼Œä¼šåˆ¤æ–­ä½¿ç”¨å“ªç§æ¨¡å¼ï¼Œç„¶ååŸºäºä¸åŒçš„æƒ…å†µè§£æå‡º &lt;code&gt;tlsContext&lt;/code&gt;ã€‚åŒæ—¶éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œé™æ€æ¨¡å¼åªæ˜¯åŒºåˆ«äºåŠ¨æ€ SDS æ¨¡å¼çš„ä¸€ç§æ¨¡å¼ï¼Œé€šè¿‡ TLS çš„æ‰©å±•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åšåˆ°é™æ€æ¨¡å¼ä¸‹ï¼Œè®©è¯ä¹¦åŠ¨æ€è·å–ï¼Œè¿™ä¸€ç‚¹åœ¨åæ–‡ä¸­ä¼šè¿›è¡Œä»‹ç»ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewProvider&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSProvider&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Status&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æœªå¼€å¯ TLS
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SdsConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åŠ¨æ€ SDS æ¨¡å¼
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getOrCreateProvider&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é™æ€é…ç½®æ¨¡å¼
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newTLSContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;secret&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;tlscontext&#34;&gt;tlsContext&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;tlsContext&lt;/code&gt;æ˜¯ MOSN ä¸­ TLS è¿è¡Œæ—¶çš„åŸºç¡€å•å…ƒï¼Œä¸»è¦åŠŸèƒ½æ˜¯è´Ÿè´£æä¾› MOSN è¿è¡Œæ—¶æ‰€éœ€è¦çš„&lt;code&gt;tls.Config&lt;/code&gt;ã€‚å…¶å®šä¹‰ä¸æ–¹æ³•å¦‚ä¸‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;serverName&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;ticket&lt;/span&gt;     &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;matches&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;     &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;     &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buildMatch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;setServerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConfigHooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;setClientConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConfigHooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;MatchedServerName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sn&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;MatchedALPN&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protos&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetTLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åŸºäº TLS çš„é…ç½®ï¼Œé€šè¿‡&lt;code&gt;newTLSContext&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;tlsContext&lt;/code&gt;ï¼Œéšååœ¨ TLSManager ä¸­é€šè¿‡&lt;code&gt;MatchedServerName&lt;/code&gt;å’Œ&lt;code&gt;MatchedALPN&lt;/code&gt;åˆ¤æ–­æ˜¯å¦è¦é€‰æ‹©è¯¥&lt;code&gt;tlsContext&lt;/code&gt;ï¼Œæœ€åé€šè¿‡&lt;code&gt;GetTLSConfig&lt;/code&gt;æä¾›&lt;code&gt;tls.Config&lt;/code&gt;å»ºç«‹ TLS è¿æ¥ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newTLSContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;secret&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;secretInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// extension config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;factory&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Type&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;factory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateConfigHooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ExtendVerify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// pool can be nil, if it is nil, TLS uses the host&amp;#39;s root CA set.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetX509Pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;secret&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Validation&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RootCAs&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientCAs&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// set tls context
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tlsContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;serverName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServerName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;ticket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;     &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Ticket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;cert&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetCertificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;secret&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;secret&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PrivateKey&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// needs copy template config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificates&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;setServerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;setClientConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tmpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hooks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;secretInfo&lt;/code&gt;åŒ…å«äº†å¯ä»¥è·å–å®Œæ•´çš„ TLS è¯ä¹¦ä¿¡æ¯çš„å†…å®¹ï¼Œå®Œæ•´çš„è¯ä¹¦ä¿¡æ¯åŒ…æ‹¬è¯ä¹¦ã€ç§é’¥ã€ä»¥åŠç­¾å‘è¯ä¹¦çš„ CA ä¿¡æ¯ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒsecretInfo å°±æ˜¯å®Œæ•´çš„ TLS è¯ä¹¦ä¿¡æ¯ï¼Œåœ¨æœ‰ tls æ‰©å±•çš„åœºæ™¯ï¼Œåˆ™æ˜¯åˆ©ç”¨&lt;code&gt;secretInfo&lt;/code&gt;é€šè¿‡æ‰©å±•å®ç°è¿›è¡Œè·å–ã€‚ä»£ç ä¸­é€šè¿‡&lt;code&gt;getFactory&lt;/code&gt;è·å–åˆ°çš„&lt;code&gt;hooks&lt;/code&gt;å°±æ˜¯æ‰©å±•å®ç°ï¼Œåœ¨æ²¡æœ‰æ‰©å±•çš„æ—¶å€™ï¼Œè¿”å›çš„å°±æ˜¯é»˜è®¤çš„&lt;code&gt;hooks&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åŠ¨æ€ SDS æ¨¡å¼ä¸‹ï¼Œå½“ MOSN æ”¶åˆ°æ¥è‡ª SDS æœåŠ¡ç«¯çš„ä¿¡æ¯ä»¥åï¼Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨&lt;code&gt;newTLSContext&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;tlsContext&lt;/code&gt;æä¾› TLS èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;h4 id=&#34;tls-æ‰©å±•&#34;&gt;TLS æ‰©å±•&lt;/h4&gt;
&lt;p&gt;è€ƒè™‘åˆ°ä¸€äº› TLS è¿è¡Œæ—¶çš„é…ç½®å®‰å…¨éœ€æ±‚ä»¥åŠè¯ä¹¦æ ¡éªŒéœ€æ±‚ï¼ŒMOSN å¯¹ TLS è¿è¡Œæ—¶é…ç½®æä¾›äº†ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œå¯ä»¥æŒ‰ç…§éœ€æ±‚æ‰©å±•ä¸¤ç§ç±»å‹ï¼Œå››ä¸ªåŠŸèƒ½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è§£æè¯ä¹¦å’Œç§é’¥çš„æ–¹å¼å¯æ‰©å±•ï¼Œé»˜è®¤æ˜¯è¯»å–è¯ä¹¦ / ç§é’¥çš„æ˜æ–‡å­—ç¬¦ä¸²æˆ–æ˜æ–‡æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;è§£æ CA è¯ä¹¦çš„æ–¹å¼å¯æ‰©å±•ï¼Œé»˜è®¤æ˜¯è¯»å– CA è¯ä¹¦çš„æ˜æ–‡å­—ç¬¦ä¸²æˆ–æ˜æ–‡æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;Server ç«¯æ¡æ‰‹æ ¡éªŒçš„æ–¹å¼å¯æ‰©å±•ï¼Œé»˜è®¤æ˜¯æ ‡å‡†çš„ TLS æ¡æ‰‹æ ¡éªŒæ–¹å¼&lt;/li&gt;
&lt;li&gt;Client ç«¯æ¡æ‰‹æ ¡éªŒçš„æ–¹å¼å¯æ‰©å±•ï¼Œé»˜è®¤æ˜¯æ ‡å‡†çš„ TLS æ¡æ‰‹æ ¡éªŒæ–¹å¼&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ConfigHooks is a  set of functions used to make a tls config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConfigHooks&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// GetCertificate returns the tls.Certificate by index.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// By default the index is the cert/key file path or cert/key pem string
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;GetCertificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;certIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;keyIndex&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// GetX509Pool returns the x509.CertPool, which is a set of certificates.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// By default the index is the ca certificate file path or certificate pem string
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;GetX509Pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;caIndex&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;x509&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CertPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ServerHandshakeVerify returns a function that used to set &amp;#34;VerifyPeerCertificate&amp;#34; defined in tls.Config.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If it is returns nil, the normal certificate verification will be used.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Notice that we set tls.Config.InsecureSkipVerify to make sure the &amp;#34;VerifyPeerCertificate&amp;#34; is called,
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// so the ServerHandshakeVerify should verify the trusted ca if necessary.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If the TLSConfig.RequireClientCert is false, the ServerHandshakeVerify will be ignored
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;ServerHandshakeVerify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawCerts&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[][]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verifiedChains&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[][]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;x509&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ClientHandshakeVerify returns a function that used to set &amp;#34;VerifyPeerCertificate&amp;#34; defined in tls.Config.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If it is returns nil, the normal certificate verification will be used.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Notice that we set tls.Config.InsecureSkipVerify to make sure the &amp;#34;VerifyPeerCertificate&amp;#34; is called,
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// so the ClientHandshakeVerify should verify the trusted ca if necessary.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// If TLSConfig.InsecureSkip is true, the ClientHandshakeVerify will be ignored.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;ClientHandshakeVerify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cfg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;tls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawCerts&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[][]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;verifiedChains&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[][]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;x509&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Certificate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - è·¯ç”±</title>
      <link>https://mosn.io/blog/code/mosn-router/</link>
      <pubDate>Sun, 26 Apr 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-router/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡åŸºäºçš„å†…å®¹æ˜¯ MOSN v0.12.0ã€‚&lt;/p&gt;
&lt;p&gt;MOSN çš„è·¯ç”±èƒ½åŠ›ç›®å‰ä»ç„¶å¤„äºä¸æ–­æ›´æ–°å®Œå–„çš„é˜¶æ®µï¼Œè¯¦ç»†çš„é…ç½®ä»‹ç»å¯ä»¥å‚è€ƒ MOSN é…ç½®æ–‡æ¡£ä¸­çš„è·¯ç”±éƒ¨åˆ†ã€‚æœ¬æ–‡å°†ä¸»è¦ä»ä¸‰ä¸ªæ–¹é¢æ¥ä»‹ç» MOSN çš„è·¯ç”±åŠŸèƒ½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é’ˆå¯¹è·¯ç”±æ¨¡å—çš„é…ç½®è§£æ&lt;/li&gt;
&lt;li&gt;è·¯ç”±æ¨¡å—æ˜¯å¦‚ä½•è¿è¡Œçš„&lt;/li&gt;
&lt;li&gt;åŠ¨æ€è·¯ç”±çš„å®ç°&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;é…ç½®è§£æé€»è¾‘&#34;&gt;é…ç½®è§£æé€»è¾‘&lt;/h3&gt;
&lt;p&gt;è·¯ç”±çš„é…ç½®è¦åœ¨ MOSN ä¸­ç”Ÿæ•ˆï¼ŒåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;proxy çš„é…ç½®ä¸­ï¼ŒæŒ‡å®šè·¯ç”±çš„åå­—&lt;code&gt;router_config_name&lt;/code&gt;ï¼Œè¯´æ˜ proxy éœ€è¦å¼•ç”¨å¯¹åº”åå­—çš„è·¯ç”±ã€‚&lt;/li&gt;
&lt;li&gt;è·¯ç”±çš„é…ç½®ï¼ŒåŒ…å«è·¯ç”±çš„åå­—ä»¥åŠå…¶ä»–è·¯ç”±é…ç½®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶ä¸­è·¯ç”±çš„é…ç½®å¯ä»¥é…ç½®åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡&lt;code&gt;connection_manager&lt;/code&gt;è¿›è¡Œé…ç½®ï¼Œè¿™ä¸ªæ–¹å¼æ˜¯å†å²é—ç•™é…ç½®ï¼Œä½œä¸ºå…¼å®¹æ€§ä¿ç•™çš„å†…å®¹ï¼Œä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼›å¦ä¸€ä¸ªæ˜¯é€šè¿‡&lt;code&gt;routers&lt;/code&gt;è¿›è¡Œé…ç½®ã€‚å¦‚æœä¸¤å¤„é…ç½®åŒ…å«åŒåçš„è·¯ç”±é…ç½®ï¼Œä¼šä»¥&lt;code&gt;routers&lt;/code&gt;ä¸­çš„é…ç½®ä¸ºå‡†ã€‚ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewMosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MOSNConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
     &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;     &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Servers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
         &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
             &lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseListenerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;],&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
             &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// deprecated: keep compatible for route config in listener&amp;#39;s connection_manager
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;             &lt;span style=&#34;color:#000&#34;&gt;deprecatedRouter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseRouterConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChains&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
             &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                 &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] compatible router: %v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
             &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;deprecatedRouter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                 &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddOrUpdateRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;deprecatedRouter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
             &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
         &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Add Router Config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;         &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Routers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
             &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                 &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddOrUpdateRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
     &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ ¹æ®ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è§£æé…ç½®æ—¶ï¼Œä¼šå…ˆè§£æ Listener ä¸­çš„è·¯ç”±é…ç½®ï¼ˆå·²åºŸå¼ƒå­—æ®µï¼Œå…¼å®¹é€»è¾‘ï¼‰ï¼Œéšåå•ç‹¬è§£æ Routers é…ç½®ã€‚é…ç½®è§£æå®Œæˆä»¥åï¼Œéƒ½æ˜¯é€šè¿‡&lt;code&gt;AddOrUpdateRouters&lt;/code&gt;ä½¿é…ç½®ç”Ÿæ•ˆï¼Œæ‰€ä»¥åè§£æçš„ Routers é…ç½®å¦‚æœä¸ Listener ä¸­çš„é…ç½®åŒåï¼Œåˆ™ä¼šé€šè¿‡ Update è¦†ç›–æ‰ Listener ä¸­çš„é…ç½®ã€‚ç”±æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸åŒçš„ Listenerã€ä¸åŒçš„ Proxyï¼Œå¦‚æœå¼•ç”¨äº†ç›¸åŒåå­—çš„è·¯ç”±ï¼Œåˆ™å¯¹åº”çš„æ˜¯åŒä¸€ä»½è·¯ç”±è§„åˆ™ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è·¯ç”±æ¨¡å—è¿è¡Œ&#34;&gt;è·¯ç”±æ¨¡å—è¿è¡Œ&lt;/h3&gt;
&lt;p&gt;å½“å‰çš„è·¯ç”±èƒ½åŠ›ï¼Œæ˜¯ä¸&lt;code&gt;proxy&lt;/code&gt;è¿›è¡Œç»‘å®šçš„ã€‚ä¸ºäº†è¯´æ˜è·¯ç”±çš„é€»è¾‘ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨&lt;code&gt;proxy&lt;/code&gt; æ¨¡å¼ä¸‹çš„ MOSNï¼Œæ”¶åˆ°ä¸€ä¸ªè¯·æ±‚åï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆåœ¨ MOSN çš„ Listener æ–°å»ºä¸€ä¸ªè¿æ¥çš„æ—¶å€™ï¼Œé€šè¿‡&lt;code&gt;OnNewConnection&lt;/code&gt;åˆ›å»º&lt;code&gt;NetworkFilters&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;proxy&lt;/code&gt;å°±æ˜¯å…¶ä¸­ä¸€ä¸ªï¼Œå› æ­¤ä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ª&lt;code&gt;proxy&lt;/code&gt;ã€‚åœ¨&lt;code&gt;proxy&lt;/code&gt;åˆ›å»ºçš„æ—¶å€™ä¼šåŸºäºé…ç½®è·å–å¯¹åº”çš„è·¯ç”±ä¿¡æ¯&lt;code&gt;routersWrapper&lt;/code&gt;ï¼Œæ‰€ä»¥åœ¨è¿æ¥åˆ›å»ºä»¥åï¼Œåœ¨æ­¤è¿æ¥ä¸Šçš„è¯·æ±‚ä¼šä½¿ç”¨å“ªä¸ªè·¯ç”±é…ç½®å°±å·²ç»å†³å®šäº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnNewConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;networkFiltersFactories&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateFilterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewProxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRoutersMangerInstance&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRouterWrapperByName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewProxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRoutersMangerInstance&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRouterWrapperByName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨è¿æ¥åˆ›å»ºä»¥åï¼Œå¼€å§‹å¤„ç†è¯·æ±‚ã€‚æ¯æ¬¡æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œç»è¿‡åè®®è§£æä»¥åï¼Œæœ€ç»ˆä¼šèµ°åˆ°&lt;code&gt;proxy&lt;/code&gt;ä¸­&lt;code&gt;downStream&lt;/code&gt;çš„&lt;code&gt;OnReceive&lt;/code&gt;æ–¹æ³•ã€‚åœ¨&lt;code&gt;OnReceive&lt;/code&gt;ä¸­ï¼Œç»è¿‡ä¸€ç³»åˆ—å¤„ç†ï¼Œå¯èƒ½ä¼šèµ°åˆ°è·¯ç”±åŒ¹é…é˜¶æ®µ&lt;code&gt;matchRoute&lt;/code&gt;ã€‚MOSN é€šè¿‡&lt;code&gt;routersWrapper&lt;/code&gt;è·å–åˆ°å½“å‰è¿è¡Œæ—¶çš„&lt;code&gt;routers&lt;/code&gt;ï¼Œéšåæ‰§è¡Œè·¯ç”±åŒ¹é…é€»è¾‘ï¼Œå®Œæˆè·¯ç”±åŒ¹é…ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;matchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetResponseFlag&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NoRouteFound&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendHijackReply&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterUnavailableCode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;åŠ¨æ€è·¯ç”±&#34;&gt;åŠ¨æ€è·¯ç”±&lt;/h3&gt;
&lt;p&gt;MOSN åœ¨è·¯ç”±æ¨¡å—ä¸­ï¼Œè®¾è®¡äº†åŠ¨æ€æ›´æ–°çš„æ¥å£ï¼Œå¯ä»¥è®© MOSN åœ¨è¿è¡Œæ—¶åŠ¨æ€æ›´æ–°è·¯ç”±çš„é…ç½®ã€‚ç»è¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° MOSN é…ç½®è§£ææ—¶ï¼Œä¹Ÿæ—¶é€šè¿‡åŠ¨æ€æ›´æ–°çš„æ¥å£è®©è·¯ç”±é…ç½®ç”Ÿæ•ˆçš„ã€‚é™¤äº†é…ç½®è§£æä»¥å¤–ï¼ŒMOSN é»˜è®¤å¯ä»¥é€šè¿‡ xDS å®Œæˆè·¯ç”±çš„åŠ¨æ€æ›´æ–°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ‰©å±•è°ƒç”¨åŠ¨æ€æ›´æ–°çš„æ¥å£å®ŒæˆåŠ¨æ€è·¯ç”±é…ç½®æ›´æ–°ã€‚&lt;/p&gt;
&lt;p&gt;è·¯ç”±åŠ¨æ€æ›´æ–°ä¸»è¦æä¾›äº†ä¸‰ä¸ªæ¥å£ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AddOrUpdateRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AddRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;domain&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;RemoveAllRoutes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;domain&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä½¿ç”¨&lt;code&gt;AddOrUpdateRouters&lt;/code&gt;ï¼Œä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„è·¯ç”±é…ç½®ï¼Œå¯¹è·¯ç”±è¿›è¡Œæ›´æ–°ã€‚&lt;code&gt;AddRoute&lt;/code&gt;å’Œ&lt;code&gt;RemoveAllRoutes&lt;/code&gt;æ˜¯åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œç”¨äºç‰¹å®šçš„è·¯ç”±é…ç½®è¿½åŠ  / åˆ é™¤è·¯ç”±åŒ¹é…è§„åˆ™ä½¿ç”¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;åŠ¨æ€è·¯ç”±æ›´æ–°è¿˜æ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ›´æ–°ä»¥åéœ€è¦åŠ¨æ€ç”Ÿæ•ˆã€‚ä»ä¹‹å‰çš„è·¯ç”±è¿è¡Œé€»è¾‘åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ MOSN åœ¨è¿æ¥å»ºç«‹çš„æ—¶å€™ï¼Œå°±é€šè¿‡&lt;code&gt;GetRouterWrapperByName&lt;/code&gt;å®Œæˆäº†è·¯ç”±é€‰æ‹©ï¼Œä¸ºäº†è®©è·¯ç”±é…ç½®æ›´æ–°å¯¹å­˜é‡è¿æ¥ä¹Ÿå¯ä»¥ç”Ÿæ•ˆï¼Œ&lt;code&gt;AddOrUpdateRouters&lt;/code&gt;çš„é€»è¾‘è¿›è¡Œäº†é’ˆå¯¹æ€§å¤„ç†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Go&#34; data-lang=&#34;Go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// çœç•¥äº†æ—¥å¿—éƒ¨åˆ†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AddOrUpdateRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ErrNilRouterConfig&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapperMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Load&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoutersWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ErrUnexpected&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersConfig&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapperMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoutersWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;       &lt;span style=&#34;color:#000&#34;&gt;routers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;routersConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// update admin stored config for admin api dump
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetRouter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersManagerImpl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetRouterWrapperByName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfigName&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterWrapper&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routersWrapperMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Load&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfigName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RoutersWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rw&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å½“ä¸€ä¸ªè·¯ç”±é…ç½®æ˜¯æ–°å¢çš„æ—¶å€™ï¼ŒMOSN ä¼šå¿½ç•¥æ‰&lt;code&gt;NewRouters&lt;/code&gt;çš„é”™è¯¯ï¼Œå³å…è®¸è·¯ç”±é…ç½®è§£æå¤±è´¥ï¼Œæ­¤æ—¶çš„ç›®çš„æ˜¯ä¸ºäº†è®©&lt;code&gt;GetRouterWrapperByName&lt;/code&gt;èƒ½è¿”å›ä¸€ä¸ª&lt;code&gt;RoutersWrapper&lt;/code&gt;ã€‚ä½†æ˜¯å¦‚æœæ˜¯è·¯ç”±é…ç½®æ›´æ–°ï¼Œåˆ™ä¸ä¼šå¿½ç•¥&lt;code&gt;NewRouters&lt;/code&gt;çš„é”™è¯¯ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„é…ç½®æ‰èƒ½å®Œæˆæ›´æ–°ã€‚
åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå­˜åœ¨è·¯ç”±é…ç½®æ›´æ–°ï¼Œæ›´æ–°çš„æ˜¯&lt;code&gt;RoutersWrapper&lt;/code&gt;ä¸­çš„&lt;code&gt;routers&lt;/code&gt;ï¼Œå­˜é‡è¿æ¥ä¸­çš„&lt;code&gt;RoutersWrapper&lt;/code&gt;ä¹Ÿå¯ä»¥è·å–åˆ°æœ€æ–°çš„&lt;code&gt;routers&lt;/code&gt;ï¼Œå®ç°è·¯ç”±è§„åˆ™çš„åŠ¨æ€ç”Ÿæ•ˆã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;router.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æ‰©å±•æœºåˆ¶è§£æ</title>
      <link>https://mosn.io/blog/posts/mosn-extensions/</link>
      <pubDate>Thu, 09 Apr 2020 21:00:00 +0800</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-extensions/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡æ ¹æ® SOFAChannel#14 ç›´æ’­åˆ†äº«æ•´ç†ï¼Œä¸»é¢˜ï¼šäº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN æ‰©å±•æœºåˆ¶è§£æã€‚&lt;/p&gt;
&lt;p&gt;å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ä»Šå¤©çš„è®²å¸ˆæ°¸é¹ï¼Œæ¥è‡ªèš‚èšé›†å›¢ï¼Œç›®å‰ä¸»è¦è´Ÿè´£ MOSN çš„å¼€å‘ï¼Œä¹Ÿæ˜¯ MOSN çš„Committerã€‚ä»Šå¤©æˆ‘ä¸ºå¤§å®¶åˆ†äº«çš„æ˜¯äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN çš„æ‰©å±•æœºåˆ¶ï¼Œå¸Œæœ›é€šè¿‡è¿™æ¬¡åˆ†äº«ä»¥åï¼Œèƒ½è®©å¤§å®¶äº†è§£ MOSN çš„å¯ç¼–ç¨‹æ‰©å±•èƒ½åŠ›ï¼Œå¯ä»¥åŸºäº MOSN çš„æ‰©å±•èƒ½åŠ›ï¼ŒæŒ‰ç…§è‡ªå·±å®é™…çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h3&gt;
&lt;p&gt;ä»Šå¤©æˆ‘ä»¬å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼Œå¯¹ MOSN çš„æ‰©å±•æœºåˆ¶è¿›è¡Œä»‹ç»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSN æ‰©å±•èƒ½åŠ›å’Œæ‰©å±•æœºåˆ¶çš„è¯¦ç»†ä»‹ç»ï¼›&lt;/li&gt;
&lt;li&gt;ç»“åˆç¤ºä¾‹å¯¹ MOSN çš„ Filter æ‰©å±•æœºåˆ¶ä¸æ’ä»¶æ‰©å±•æœºåˆ¶è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼›&lt;/li&gt;
&lt;li&gt;MOSN åç»­æ‰©å±•èƒ½åŠ›è§„åˆ’ä¸å±•æœ›ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¬¢è¿å¤§å®¶æœ‰å…´è¶£ä¸€èµ·å…±å»º MOSNã€‚åœ¨æœ¬æ¬¡æ¼”è®²ä¸­æ¶‰åŠåˆ°çš„ç¤ºä¾‹å°±åœ¨æˆ‘ä»¬çš„ Github çš„ &lt;code&gt;examples/codes/mosn-extensions&lt;/code&gt; ç›®å½•ä¸‹ï¼Œå¤§å®¶æœ‰å…´è¶£çš„ä¹Ÿå¯ä»¥ä¸‹è½½ä¸‹æ¥è¿è¡Œä¸€ä¸‹ï¼Œå…³äºè¿™äº›ç¤ºä¾‹æˆ‘ä»¬è¿˜åšäº†ä¸€äº›å°æ´»åŠ¨ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶å¯ä»¥è¸Šè·ƒå‚ä¸ã€‚&lt;/p&gt;
&lt;p&gt;MOSNï¼š&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;https://github.com/mosn/mosn&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;mosn-ç®€ä»‹&#34;&gt;MOSN ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;MOSN ä½œä¸ºäº‘åŸç”Ÿçš„ç½‘ç»œä»£ç†ï¼Œæ—¨åœ¨ä¸ºæœåŠ¡æä¾›å¤šåè®®ã€æ¨¡å—åŒ–ã€æ™ºèƒ½åŒ–ã€å®‰å…¨çš„ä»£ç†èƒ½åŠ›ã€‚åœ¨å®é™…ç”Ÿäº§ä½¿ç”¨ä¸­ï¼Œä¸åŒçš„å‚å•†ä¼šæœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œé€šç”¨çš„ç½‘ç»œä»£ç†èƒ½åŠ›é¢å¯¹å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ä¼šæ˜¾å¾—æœ‰äº›ä¸è¶³ï¼Œé€šå¸¸éƒ½éœ€è¦è¿›è¡ŒäºŒæ¬¡å¼€å‘ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚MOSN åœ¨æ ¸å¿ƒæ¡†æ¶ä¸­ï¼Œæä¾›äº†ä¸€ç³»åˆ—çš„æ‰©å±•æœºåˆ¶å’Œæ‰©å±•ç‚¹ï¼Œå°±æ˜¯ä¸ºäº†æ»¡è¶³éœ€è¦åŸºäºä¸šåŠ¡è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„åœºæ™¯ï¼ŒåŒæ—¶ MOSN æä¾›çš„éƒ¨åˆ†é€šç”¨é€»è¾‘ä¹Ÿæ˜¯åŸºäºæ‰©å±•æœºåˆ¶å’Œæ‰©å±•ç‚¹çš„å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268765-2c1afc84-0142-4217-b666-0cc9cbdf7e78.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚é€šè¿‡ MOSN â€œå†…ç½®å®ç°â€çš„é€æ˜åŠ«æŒçš„èƒ½åŠ›ï¼Œå°±æ˜¯é€šè¿‡ MOSN Filter æœºåˆ¶å®ç°ã€‚è€Œè¦å®ç°æ¶ˆæ¯çš„ä»£ç†ï¼Œåˆ™å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ‰©å±•å®ç°ã€‚åœ¨é€šç”¨ä»£ç†çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ Filter æœºåˆ¶å®ç°ä¸šåŠ¡çš„è®¤è¯é‰´æƒï¼Œä¹Ÿå¯ä»¥å®ç°å®šåˆ¶çš„è´Ÿè½½å‡è¡¡é€»è¾‘ï¼›é™¤äº†è½¬å‘æµç¨‹å¯ä»¥æ‰©å±•å®ç°ä»¥å¤–ï¼ŒMOSN è¿˜å¯ä»¥æ‰©å±•æ—¥å¿—çš„å®ç°ï¼Œç”¨äºå¯¹æ ‡å·²æœ‰çš„æ—¥å¿—ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æ‰©å±• XDS å®ç°å®šåˆ¶çš„é…ç½®æ›´æ–°ï¼›æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯è¿˜ä¼šæœ‰å¾ˆå¤šå…·ä½“çš„æ‰©å±•æƒ…å†µï¼Œå°±ä¸åœ¨æ­¤å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å…³æ³¨ MOSN ç¤¾åŒºæ­£åœ¨å»ºè®¾çš„æºä»£ç åˆ†æç³»åˆ—æ–‡ç« ä¸æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436269068-a0a77749-1a98-4bce-9e9b-323ea3bd14a5.png&#34; alt=&#34;å›¾ç‰‡ 1.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;MOSN ä½œä¸ºä¸€æ¬¾ç½‘ç»œä»£ç†ï¼Œåœ¨è½¬å‘é“¾è·¯ä¸Šçš„ç½‘ç»œå±‚ã€åè®®å±‚ã€è½¬å‘å±‚ï¼Œåœ¨éè½¬å‘é“¾è·¯ä¸Šçš„é…ç½®ã€æ—¥å¿—ã€Admin API ç­‰éƒ½æä¾›äº†æ‰©å±•èƒ½åŠ›ï¼Œå¯¹äºåè®®æ‰©å±•çš„éƒ¨åˆ†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ä¸ŠæœŸç›´æ’­è®²çš„ &lt;a href=&#34;https://www.sofastack.tech/blog/sofa-channel-13-retrospect/&#34;&gt;MOSNÂ å¤šåè®®æœºåˆ¶è§£æ&lt;/a&gt;ï¼Œæˆ‘ä»¬ä»Šå¤©å°†é‡ç‚¹ä»‹ç»ä¸€ä¸‹è½¬å‘å±‚çš„ Stream Filter æ‰©å±•æœºåˆ¶ä¸ MOSN çš„æ’ä»¶æœºåˆ¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;stream-filter-æœºåˆ¶&#34;&gt;Stream Filter æœºåˆ¶&lt;/h3&gt;
&lt;p&gt;åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œåœ¨è½¬å‘è¯·æ±‚ä¹‹å‰æˆ–è€…å›å†™å“åº”ä¹‹å‰ï¼Œéƒ½å¯èƒ½éœ€è¦å¯¹è¯·æ±‚/å“åº”åšä¸€äº›å¤„ç†ï¼Œå¦‚åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œè½¬å‘çš„è®¤è¯/é‰´æƒï¼Œæ˜¯å¦éœ€è¦é™æµï¼Œåˆæˆ–è€…éœ€è¦å¯¹è¯·æ±‚/å“åº”åšä¸€äº›å…·æœ‰ä¸šåŠ¡è¯­ä¹‰çš„è®°å½•ï¼Œéœ€è¦å¯¹åè®®è¿›è¡Œè½¬æ¢ç­‰ã€‚è¿™äº›åœºæ™¯éƒ½ä¸å…·ä½“çš„ä¸šåŠ¡é«˜åº¦è€¦åˆï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„éœ€è¦è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„æƒ…å†µã€‚MOSN çš„ Stream Filter æœºåˆ¶å°±æ˜¯ä¸ºäº†æ»¡è¶³è¿™æ ·çš„æ‰©å±•åœºæ™¯æ‰€è®¾è®¡çš„ï¼Œå®ƒä¹Ÿæˆä¸ºç›®å‰ MOSN æ‰©å±•ä¸­ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ‰©å±•ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268982-8881e2b5-d3a7-443e-ac1f-90735b32f4e9.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ç›®å‰çš„å†…ç½® MOSN å®ç°ä¸­ï¼ŒStream Filter æœºåˆ¶æš‚æ—¶ä¸å†…ç½®çš„ network filter: proxy æ˜¯ç»‘å®šçš„ï¼Œåé¢æˆ‘ä»¬ä¹Ÿè€ƒè™‘å°†è¿™éƒ¨åˆ†èƒ½åŠ›è¿›è¡ŒæŠ½è±¡ï¼Œè®©å…¶ä»– network filter ä¹Ÿå¯ä»¥å¤ç”¨è¿™éƒ¨åˆ†èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å…³äº Stream Filterï¼Œä»Šå¤©ä¼šä¸ºå¤§å®¶è®²è§£ä¸¤ä¸ªéƒ¨åˆ†çš„å†…å®¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸€ä¸ª Stream Filter åŒ…å«å“ªäº›éƒ¨åˆ†ä»¥åŠåœ¨ MOSN ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡ä¸€ä¸ª Demo æ¼”ç¤ºæ¥åŠ æ·±å¯¹ Stream Filter çš„å®ç°ä¸åº”ç”¨ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;ä¸€ä¸ªå®Œæ•´çš„-stream-filter&#34;&gt;ä¸€ä¸ªå®Œæ•´çš„ Stream Filter&lt;/h4&gt;
&lt;p&gt;ä¸€ä¸ªå®Œæ•´çš„ StreamFilterï¼ŒåŒ…å«ä¸‰ä¸ªéƒ¨åˆ†çš„å†…å®¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€ä¸ª StreamFilter å¯¹è±¡ï¼Œå­˜åœ¨äºæ¯ä¸€ä¸ªè¯·æ±‚/å“åº”å½“ä¸­ï¼Œåœ¨ MOSN æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™å‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬ç§°ä¸º ReceiverFilterï¼Œåœ¨ MOSN æ”¶åˆ°å“åº”æ—¶å‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬ç§°ä¸º SenderFilterã€‚ä¸€ä¸ª StreamFilter å¯ä»¥æ˜¯å…¶ä¸­ä»»æ„ä¸€ç§ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸¤ç§éƒ½æ˜¯ï¼›&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ª StreamFilterFactory å¯¹è±¡ï¼Œç”¨äº MOSN åœ¨æ¯æ¬¡æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œç”Ÿæˆ StreamFilter å¯¹è±¡ã€‚åœ¨ Listener é…ç½®è§£ææ—¶ï¼Œä¸€ä¸ª StreamFilter çš„é…ç½®ä¼šç”Ÿæˆä¸€ä¸ªå…¶å¯¹äºçš„ StreamFilterFactoryã€‚åŒä¸€ä¸ª StreamFilter åœ¨ä¸åŒçš„ Listener ä¸‹å¯èƒ½å¯¹åº”ä¸åŒçš„ StreamFilterFactoryï¼Œä½†æ˜¯ä¹Ÿæœ‰çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒStreamFilterFactory å¯èƒ½éœ€è¦å®ç°ä¸ºå•ä¾‹ï¼›&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ª CreateStreamFilterFactory æ–¹æ³•ï¼Œé…ç½®è§£ææ—¶ç”Ÿæˆ StreamFilterFactory å°±æ˜¯è°ƒç”¨å®ƒï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;1586436268990-060fa931-308c-4237-898f-463ce5a3228c.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;stream-filter-åœ¨-mosn-ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„&#34;&gt;Stream Filter åœ¨ MOSN ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„&lt;/h4&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹ Stream Filter åœ¨ MOSN ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436269017-a78ea077-adea-4e5c-bb19-48843553362d.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å½“ MOSN ç»è¿‡åè®®è§£æï¼Œæ”¶åˆ°ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª Streamã€‚æ­¤æ—¶æ”¶åˆ°è¯·æ±‚çš„ Listener ä¸­æ¯å­˜åœ¨ StreamFilterFactoryï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ª StreamFilter å¯¹è±¡ï¼Œéšåè¿›å…¥åˆ° proxy æµç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;è¿›å…¥ proxy æµç¨‹ä»¥åï¼Œå¦‚æœå­˜åœ¨ ReceiverFilterï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼ŒReceiverFilter åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼Œâ€œè·¯ç”±å‰â€å’Œâ€œè·¯ç”±åâ€ï¼Œåœ¨æ¯ä¸ª Filter å¤„ç†å®Œæˆä»¥åï¼Œä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ï¼Œå¦‚æœæ˜¯ Stop åˆ™ä¼šä¸­æ­¢åç»­å°šæœªæ‰§è¡Œçš„ ReceiverFilterï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿”å› Stop çŠ¶æ€çš„ Filter éƒ½ä¼šå›å†™ä¸€ä¸ªå“åº”ã€‚å¦‚æœæ˜¯ Continue åˆ™ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ª ReceiverFilterï¼Œç›´åˆ°æœ¬é˜¶æ®µçš„ ReceiverFilter éƒ½æ‰§è¡Œå®Œæˆæˆ–ä¸­æ­¢ï¼›è·¯ç”±å‰é˜¶æ®µçš„ ReceiverFIlter æ‰§è¡Œå®Œæˆåï¼Œå°±ä¼šæ‰§è¡Œè·¯ç”±åé˜¶æ®µï¼Œå…¶é€»è¾‘å’Œè·¯ç”±å‰ä¸€è‡´ã€‚å¦‚æœæ˜¯æ­£å¸¸è½¬å‘ï¼Œé‚£ä¹ˆéšå MOSN ä¼šæ”¶åˆ°ä¸€ä¸ªå“åº”æˆ–è€…å‘ç°å…¶ä»–å¼‚å¸¸ç›´æ¥å›å†™ä¸€ä¸ªå“åº”ï¼Œæ­¤æ—¶å°±ä¼šè¿›å…¥åˆ° SenderFilter çš„æµç¨‹ä¸­ï¼Œå®Œæˆ SenderFilter çš„å¤„ç†ã€‚SenderFilter å¤„ç†å®Œæˆä»¥åï¼ŒMOSN ä¼šå†™å“åº”ç»™ Clientï¼Œå¹¶ä¸”å®Œæˆæœ€åçš„æ”¶å°¾å·¥ä½œï¼Œæ”¶å°¾å·¥ä½œåŒ…æ‹¬ä¸€äº›æ•°æ®çš„å›æ”¶ã€æ—¥å¿—çš„è®°å½•ï¼Œä»¥åŠ StreamFilter çš„â€œé”€æ¯â€ï¼ˆè°ƒç”¨Â OnDestroyï¼‰ã€‚&lt;/p&gt;
&lt;h4 id=&#34;stream-filter-demo&#34;&gt;Stream Filter Demo&lt;/h4&gt;
&lt;p&gt;å¯¹ StreamFilter æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ä»¥åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ Demo ä»£ç æ¥çœ‹ä¸‹å¦‚ä½•å®ç°ä¸€ä¸ª StreamFilter å¹¶ä¸”è®©å®ƒåœ¨ MOSN ä¸­å‘æŒ¥ä½œç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268993-74f02195-c831-4c42-9736-d9eaf7b26cb7.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;æŒ‰ç…§åˆšæ‰æˆ‘ä»¬çš„ä»‹ç»ï¼Œä¸€ä¸ª Stream FIlter è¦åŒ…å«ä¸‰éƒ¨åˆ†ï¼šFilterã€Factoryã€CreateFactoryã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é¦–å…ˆæˆ‘ä»¬å®ç°ä¸€ä¸ª Filterï¼Œå…¶é€»è¾‘æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªé‰´æƒçš„ Filterï¼šåªæœ‰è¯·æ±‚çš„ Header ä¸­åŒ…å«æ‰€é…ç½®çš„ Key-Value æ—¶ï¼ŒMOSN æ‰ä¼šå¯¹è¯·æ±‚åšç»§ç»­è½¬å‘ï¼Œå¦åˆ™ç›´æ¥è¿”å› 403 é”™è¯¯ï¼›&lt;/li&gt;
&lt;li&gt;ç„¶åæˆ‘ä»¬å®ç°ä¸€ä¸ª Factoryï¼Œå®ƒè´Ÿè´£ç”Ÿæˆæˆ‘ä»¬å®ç°çš„ Filterï¼Œå¹¶ä¸”è¯´æ˜ FilterÂ åº”è¯¥å‘æŒ¥ä½œç”¨çš„é˜¶æ®µï¼ˆåœ¨è¯·æ±‚é˜¶æ®µã€è·¯ç”±åŒ¹é…ä¹‹å‰ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;æœ€åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç”Ÿæˆ DemoFactory çš„å‡½æ•° CreateDemoFactoryï¼Œå¹¶ä¸”é€šè¿‡ init å°†å…¶â€œæ³¨å†Œâ€ï¼Œæ³¨å†Œå®Œæˆä»¥åï¼ŒMOSN é…ç½®è§£æå°±å¯ä»¥è¯†åˆ«è¿™ä¸ª StreamFilterï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;1586436269034-bac1b72c-84cd-48c8-9e73-4867587ee28d.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å®Œæˆå®ç°ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å…·ä½“çš„é…ç½®æ¥å®ç°å¯¹åº”çš„åŠŸèƒ½äº†ã€‚åœ¨ç¤ºä¾‹çš„é…ç½®ä¸­ï¼Œé…ç½® StreamFilter ä¸ºæˆ‘ä»¬åˆšæ‰å®ç°çš„ Filterï¼Œåªè½¬å‘ Header ä¸­åŒ…å« user:admin çš„è¯·æ±‚ã€‚ç¤ºä¾‹é…ç½®ä¸­ç›‘å¬çš„ç«¯å£æ˜¯ 2046ï¼Œè½¬å‘çš„åç«¯ server ç«¯å£æ˜¯ 8080ã€‚åœ¨æ¼”ç¤ºä¹‹å‰ï¼Œæˆ‘å·²ç»å®Œæˆäº† 8080 server çš„å¯åŠ¨ï¼Œè¿™ä¸ª server ä¼šå¯¹æ”¶åˆ°çš„ä»»æ„è¯·æ±‚è¿”å› 200 ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ MOSN è½¬å‘æƒ…å†µã€‚Demo æ“ä½œå¯ä»¥åœ¨æ–‡æœ«ç›´æ’­çš„è§†é¢‘å›é¡¾ä¸­æŸ¥çœ‹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Stream Filter Demo:Â &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/simple_streamfilter&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/simple_streamfilter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Demo Readmeï¼š&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;mosn-plugin-æœºåˆ¶&#34;&gt;MOSN Plugin æœºåˆ¶&lt;/h3&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ MOSN çš„ Plugin æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;åˆšæ‰æˆ‘ä»¬å¯¹ Stream Filter æœ‰äº†ä¸€ä¸ªäº†è§£ï¼ŒMOSN ä¸­å…¶ä½™çš„æ‰©å±•å®ç°ä¹Ÿæ˜¯ç±»ä¼¼çš„æ–¹æ³•ï¼Œæ€è·¯å°±æ˜¯ç¼–ç å®ç° MOSN æ‰©å±•ç‚¹æ‰€éœ€è¦çš„æ¥å£ç„¶ååˆ©ç”¨ MOSN çš„æ¡†æ¶è¿è¡Œæ‰©å±•çš„å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268983-cccb6022-61e0-491c-8dd6-5d1c67a31d02.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿™é‡Œä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦çš„æ‰©å±•èƒ½åŠ›å·²ç»æœ‰ç°æˆå¯ç”¨çš„å®ç°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥åšç®€å•çš„æ”¹é€ å°±è®© MOSN å¯ä»¥è·å–å¯¹åº”çš„èƒ½åŠ›ï¼Œå“ªæ€•ç›®å‰å¯ç”¨çš„å®ç°ä¸æ˜¯ Go è¯­è¨€çš„å®ç°ï¼Œæ¯”å¦‚ç°æˆçš„é™æµèƒ½åŠ›çš„å®ç°ã€æ³¨å…¥èƒ½åŠ›çš„å®ç°ç­‰ï¼›åˆæˆ–è€…å¯¹äºæŸäº›ç‰¹å®šçš„èƒ½åŠ›ï¼Œå®ƒéœ€è¦æœ‰æ›´ä¸¥æ ¼çš„æ§åˆ¶ï¼Œæ›´é«˜çš„æ ‡å‡†ï¼Œæ¯”å¦‚å®‰å…¨ç›¸å…³çš„èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;ç±»ä¼¼è¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¼•å…¥äº† MOSN çš„ Plugin æœºåˆ¶ï¼Œå®ƒæ”¯æŒæˆ‘ä»¬å¯ä»¥å¯¹ MOSN éœ€è¦çš„èƒ½åŠ›è¿›è¡Œç‹¬ç«‹å¼€å‘æˆ–è€…æˆ‘ä»¬å¯¹ç°æœ‰çš„ç¨‹åºè¿›è¡Œé€‚å½“çš„æ”¹é€ ä»¥åï¼Œå°±å¯ä»¥å°†å®ƒä»¬å¼•å…¥åˆ° MOSN å½“ä¸­æ¥ã€‚&lt;/p&gt;
&lt;p&gt;MOSN çš„ Plugin æœºåˆ¶åŒ…å«äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œä¸€æ˜¯ MOSN è‡ªå®šä¹‰çš„ Plugin æ¡†æ¶ï¼Œå®ƒæ”¯æŒé€šè¿‡åœ¨ MOSN ä¸­å®ç° agent ä¸ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹è¿›è¡Œäº¤äº’æ¥å®Œæˆ MOSN æ‰©å±•èƒ½åŠ›çš„å®ç°ã€‚äºŒæ˜¯åŸºäº Golang çš„ Plugin æ¡†æ¶ï¼Œé€šè¿‡åŠ¨æ€åº“ï¼ˆSOï¼‰åŠ è½½çš„æ–¹å¼ï¼Œå®ç° MOSN çš„æ‰©å±•ã€‚å…¶ä¸­åŠ¨æ€åº“åŠ è½½çš„æ–¹å¼ç›®å‰è¿˜å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œè¿˜å¤„äº beta é˜¶æ®µã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å¤šè¿›ç¨‹ Plugin æ¡†æ¶ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å¤šè¿›ç¨‹-plugin-æ¡†æ¶&#34;&gt;å¤šè¿›ç¨‹ Plugin æ¡†æ¶&lt;/h4&gt;
&lt;p&gt;MOSN çš„ Plugin æ¡†æ¶æ˜¯ MOSN å°è£…çš„ä¸€ä¸ªå¯ä»¥è®© MOSN é€šè¿‡ gRPC å’Œç‹¬ç«‹è¿›ç¨‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œå®ƒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç‹¬ç«‹çš„è¿›ç¨‹é€šè¿‡ MOSN Plugin æ¡†æ¶ç®¡ç†ï¼Œä½œä¸º MOSN çš„å­è¿›ç¨‹ï¼›MOSN çš„ Plugin æ¡†æ¶å¯ä»¥ç®¡ç†å®ƒä»¬ï¼Œå¦‚å¯åŠ¨ã€å…³é—­ç­‰ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡åœ¨ MOSN ä¸­å®ç°çš„ agentï¼Œä½¿ç”¨ gRPC çš„æ–¹å¼å’Œå­è¿›ç¨‹è¿›è¡Œäº¤äº’ï¼ŒgRPC å¯ä»¥æ˜¯åŸºäº tcp çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºäº domain socket çš„ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;1586436268954-38e37509-fbf8-44f4-a0fe-0860401daae0.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;åŸºäºè¿™ä¸ªæ¡†æ¶ï¼Œæˆ‘ä»¬åªéœ€è¦å¼€å‘æˆ–è€…è¿›è¡Œä¸€äº›æ”¹é€ ï¼Œè®©ç¨‹åºæ»¡è¶³ MOSN æ¡†æ¶çš„è§„èŒƒï¼Œå°±å¯ä»¥ä½œä¸º MOSN å¤šè¿›ç¨‹æ’ä»¶çš„ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª gRPC çš„æœåŠ¡ï¼Œå¹¶ä¸”æ»¡è¶³ MOSN æ¡†æ¶ä¸‹çš„ proto å®šä¹‰ã€‚å½“ gRPC server å¯åŠ¨å®Œæˆä»¥åï¼Œå‘æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰è¾“å‡ºä¸€æ®µçº¦å®šçš„å­—ç¬¦ä¸²ï¼Œä½œä¸º MOSN å’Œå­è¿›ç¨‹ä¹‹é—´çš„æ¡æ‰‹åè®®ã€‚MOSN ä¸­çš„å¯¹åº” agent ä¼šé€šè¿‡æ¡æ‰‹åè®®å®Œæˆä¸å­è¿›ç¨‹ä¹‹é—´çš„è¿æ¥å»ºç«‹ã€‚æ¡æ‰‹åè®®çš„å­—ç¬¦ä¸²åŒ…å«5ä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µä¹‹é—´ç”¨&amp;quot;|&amp;ldquo;åˆ†å‰²ï¼Œå…¶ä¸­å¸¦$ç¬¦å·çš„æ˜¯æ ¹æ®å®é™…è¿›ç¨‹æƒ…å†µéœ€è¦å¡«å†™çš„å€¼ï¼Œå…¶ä½™çš„æ˜¯å½“å‰çº¦å®šçš„å›ºå®šå­—æ®µã€‚network æ”¯æŒ tcp/unixï¼Œä»£è¡¨é€šè¿‡ tcp æ–¹å¼è¿˜æ˜¯ unix domain socket çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œaddr è¡¨ç¤º gRPC server ç›‘å¬çš„åœ°å€ã€‚&lt;/p&gt;
&lt;p&gt;MOSN æä¾›äº† go è¯­è¨€çš„å­è¿›ç¨‹ server å°è£…ï¼Œåœ¨ go è¯­è¨€åœºæ™¯ä¸‹ï¼Œä½œä¸ºå­è¿›ç¨‹çš„ç¨‹åºåªéœ€è¦å®ç°ä¸€ä¸ª MOSN æ¡†æ¶ä¸‹çš„ plugin.Service æ¥å£ï¼Œå¹¶ä¸”é€šè¿‡ plugin.Serve æ–¹æ³•å¯åŠ¨å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡ Plugin æ¡†æ¶ï¼Œè®© MOSN åšåˆ°åœ¨æ‰©å±•åŠŸèƒ½å®ç°çš„æ—¶å€™ï¼Œæ”¯æŒéš”ç¦»æ€§ã€æ”¯æŒå¼‚æ„è¯­è¨€æ‰©å±•èƒ½åŠ›ã€æ”¯æŒæ¨¡å—åŒ–ï¼Œä»¥åŠå…·å¤‡è¿›ç¨‹ç®¡ç†çš„èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äº MOSN é€šè¿‡å¤šè¿›ç¨‹æ–¹å¼å®Œæˆæ‰©å±•ï¼Œä»Šå¤©å‡†å¤‡äº†ä¸¤ä¸ªç¤ºä¾‹å’Œå¤§å®¶è¿›è¡Œåˆ†äº«ã€‚ä¸€ä¸ªæ˜¯åŸºäº MOSN çš„ TLS æ‰©å±•ï¼Œæ¨¡æ‹Ÿäº†é€šè¿‡ä¸€ä¸ªå®‰å…¨ç­‰çº§æ¯”è¾ƒé«˜çš„è¯ä¹¦ç®¡ç†ç¨‹åºæ¥è·å– TLS é…ç½®è¯ä¹¦ã€ç§é’¥ç­‰æ•æ„Ÿä¿¡æ¯çš„èƒ½åŠ›ï¼›ç¬¬äºŒä¸ªæ˜¯å°†ä¹‹å‰æ¼”ç¤ºçš„ Stream Filter ä¿®æ”¹ä¸ºäº†â€œå­è¿›ç¨‹â€ï¼Œæ¨¡æ‹Ÿâ€œå¦‚ä½•å°†ç°æˆçš„èƒ½åŠ›â€å¼•å…¥ MOSNã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åŸºäº MOSN çš„ TLS æ‰©å±•ç¤ºä¾‹&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæ¥çœ‹ TLS çš„æ‰©å±•ï¼Œç¤ºä¾‹åŒ…å«ä¸¤éƒ¨åˆ†å†…å®¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œç”¨ Go è¯­è¨€å®ç°ï¼Œå®ç°äº†Â plugin.Service æ¥å£ï¼Œå¹¶é€šè¿‡ plugin.Serve æ–¹æ³•å¯åŠ¨ï¼›&lt;/li&gt;
&lt;li&gt;MOSN æ‰©å±•ç‚¹å®ç°äº¤äº’ agentã€‚åœ¨è¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€TLSæ‰©å±•ç‚¹çš„ç»†èŠ‚äº†ï¼Œåªå…³æ³¨äº¤äº’è¿‡ç¨‹ï¼šé€šè¿‡ Call æ–¹æ³•å‘é€ gRPC è¯·æ±‚ï¼Œè·å–å“åº”ï¼Œå®Œæˆç›¸å…³é€»è¾‘ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;1586436269094-79115a60-66ca-4318-9049-82079bae5979.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;load cert demo: &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/cert_loader&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/cert_loader&lt;/a&gt;
Demo Readmeï¼š&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ•ˆæœï¼Œé¦–å…ˆé…ç½®ä¾ç„¶æ˜¯ç›‘å¬ 2046 çš„ç«¯å£ï¼Œé…ç½®äº†æ‰©å±•çš„ TLS é…ç½®ï¼Œå°±éœ€è¦ HTTPS æ‰å¯ä»¥è®¿é—® MOSNã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Stream Filter ä½œä¸º agent ç¤ºä¾‹&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ Stream Filter ä½œä¸º agentï¼Œä¸å¤šè¿›ç¨‹ä¹‹é—´çš„ç¤ºä¾‹ï¼Œæ¨¡æ‹Ÿâ€œå¦‚ä½•å°†ç°æˆçš„èƒ½åŠ›â€å¼•å…¥ MOSNã€‚åœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬æŠŠä¹‹å‰çš„â€œé‰´æƒâ€è®¤ä¸ºæ˜¯ä¸€ä¸ªâ€œç°æˆçš„â€èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268973-4fe309cb-83dc-41d8-9bff-0887cf08d68a.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç‹¬ç«‹è¿›ç¨‹ä¸­å®ç°å’Œä¹‹å‰ä¸€æ ·çš„â€œé‰´æƒâ€èƒ½åŠ›ï¼Œå…¶é…ç½®æ¥è‡ªè¿›ç¨‹çš„å¯åŠ¨å‚æ•°ã€‚Stream Filter ä½œä¸º agent å®ç°ï¼Œå…¶ä¸­â€œæ ¡éªŒâ€é€»è¾‘ä¿®æ”¹ä¸ºå’Œå­è¿›ç¨‹äº¤äº’ï¼Œåœ¨ç”Ÿæˆ Factory æ—¶å®Œæˆå­è¿›ç¨‹çš„å¯åŠ¨å’Œé…ç½®è®¾ç½®ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªç¤ºä¾‹è¿è¡Œä»¥åå’Œä¹‹å‰ Stream Filter çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Stream Filter Plugin demo: &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/filter&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/filter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Demo Readmeï¼š&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;åŠ¨æ€åº“soæ‰©å±•æœºåˆ¶&#34;&gt;åŠ¨æ€åº“(SO)æ‰©å±•æœºåˆ¶&lt;/h4&gt;
&lt;p&gt;åœ¨ç›®å‰çš„å¤šè¿›ç¨‹æ¡†æ¶ä¸­ï¼Œè™½ç„¶æ‰©å±•èƒ½åŠ›å¯ä»¥é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„å­ç¨‹åºå®ç°ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦åœ¨ MOSN ä¸­å®ç°ä¸€ä¸ª agent ç”¨äºäº¤äº’ï¼Œä¾ç„¶éœ€è¦åœ¨MOSNä¸­ç¼–å†™ä¸€éƒ¨åˆ†ä»£ç ï¼›è€Œæˆ‘ä»¬å¸Œæœ›å¼•å…¥åŠ¨æ€åº“ï¼ˆSOï¼‰åŠ è½½çš„æœºåˆ¶ï¼Œå®ç°åœ¨ä¸é‡æ–°ç¼–è¯‘ MOSN çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡åŠ è½½ä¸åŒçš„ SOï¼Œåšåˆ°ä¸åŒçš„æ‰©å±•èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436268988-2b2d72f0-ce06-4678-ba14-ec1b73bb85a9.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸å­ç¨‹åºæ¨¡å¼ç›¸æ¯”ï¼ŒSO è™½ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ï¼Œä½†æ˜¯æœ€ç»ˆå¯åŠ¨çš„æ—¶å€™ï¼Œä¸ä¼šæœ‰é¢å¤–çš„å­è¿›ç¨‹å­˜åœ¨ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå¯ä»¥å’Œ MOSN å®Œå…¨ä¿æŒä¸€è‡´ï¼Œè€Œä¸”åŠ¨æ€åº“æœºåˆ¶è¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼šå®ƒå¯ä»¥è®©æ‰©å±•ä»£ç å’Œ MOSN å®Œå…¨è§£è€¦åˆã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œç›®å‰ä½¿ç”¨åŠ¨æ€åº“åŠ è½½çš„æ–¹å¼è¿˜å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œå› æ­¤ MOSN å¯¹äºè¿™ä¸ªèƒ½åŠ›ä¹Ÿè¿˜å¤„äº Beta é˜¶æ®µï¼Œå¹¶æ²¡æœ‰æŠ•å…¥å®é™…ä½¿ç”¨ï¼Œéœ€è¦å®Œå–„ã€‚ç›¸å…³çš„åŸå› åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éƒ¨åˆ† MOSN æ‰©å±•çš„å®ç°éœ€è¦ç”¨åˆ° MOSN ä¸­çš„ä¸€äº›å®šä¹‰ï¼Œå› æ­¤åœ¨åŠ¨æ€åº“å®ç°æ—¶ä¸èƒ½å®Œå…¨åšåˆ°è§£è€¦åˆã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒMOSN å°†ä¸€äº›åŸºç¡€åº“ï¼ˆå¦‚æ—¥å¿—ã€buffer ç­‰ï¼‰ï¼Œä¸€äº› API å®šä¹‰ä» MOSN çš„æ ¸å¿ƒä»“åº“ä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œè¿™æ ·æ‰©å±•å®ç°å’Œ MOSN æ ¸å¿ƒéƒ½å¼•ç”¨è¿™äº›â€œç‹¬ç«‹â€çš„åº“ï¼Œå‡å°‘æ‰©å±•å¯¹ MOSN æ ¸å¿ƒä»£ç çš„ä¾èµ–ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæŸä¸€ä¸ªæ‰©å±•ç‚¹è¦æ”¯æŒå®Œå…¨è§£è€¦åˆçš„åŠ¨æ€åº“æ‰©å±•ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ‰©å±•ç‚¹éƒ½éœ€è¦è¿›è¡Œæ”¯æŒåŠ¨æ€åº“åŠ è½½çš„æ”¹é€ ï¼ŒåŒ…æ‹¬é…ç½®æ¨¡å‹ä¸å®ç°ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSN åŠ¨æ€åº“åŠ è½½çš„æ–¹å¼ï¼Œå…¶å®æ˜¯åŸºäº Go è¯­è¨€çš„ plugin åŒ…å®ç°çš„ï¼Œå®ƒå¯ä»¥åŠ è½½ç”¨ Go è¯­è¨€ç¼–è¯‘çš„åŠ¨æ€åº“ã€‚ä½†æ˜¯å¯¹äºåŠ¨æ€åº“çš„ç¼–è¯‘ç¯å¢ƒå­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œç¼–è¯‘å®ƒæ—¶å¿…é¡»å’Œ MOSN ç¼–è¯‘æ—¶çš„ GOPATH ä¿æŒä¸€è‡´ï¼›åŒæ—¶å¼•ç”¨çš„ä»£ç è·¯å¾„éƒ½éœ€è¦ä¿æŒä¸€è‡´ï¼Œå¦‚æœå­˜åœ¨ vendor ç›®å½•ï¼Œé‚£ä¹ˆæ„å‘³ç€ç¼–è¯‘åŠ¨æ€åº“æ—¶çš„é¡¹ç›®è·¯å¾„ä¹Ÿå¾—å’Œ MOSN æ ¸å¿ƒä¿æŒä¸€è‡´ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ Docker ç¼–è¯‘ï¼Œåœ¨ç¼–è¯‘æ—¶ç»Ÿä¸€ GOPATHï¼Œå¼ºåˆ¶ä¿®æ”¹ä»£ç ç›®å½•ç»“æ„ï¼Œå±è”½æ‰ Vendor ç›®å½•å·®å¼‚çš„æ–¹å¼æ¥è§£å†³ï¼Œè¿™ç§æ–¹å¼ç›®å‰ä»ç„¶åœ¨éªŒè¯ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ç†è®ºä¸Š MOSN ç›®å‰æ‰€æœ‰çš„æ‰©å±•ç‚¹éƒ½å¯ä»¥ä½¿ç”¨ Go è¯­è¨€åŸç”Ÿæœºåˆ¶é€šè¿‡åŠ è½½ SO çš„æ–¹å¼æ¥å®ç°ï¼Œè€Œç›®å‰ MOSN æœ€é€‚åˆå®ç°è¿™ä¸ªèƒ½åŠ›çš„ä¸€ä¸ªæ‰©å±•ç‚¹å°±æ˜¯Â Stream Filterã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬åªéœ€è¦å®ç°ä¸€ä¸ªé€šç”¨çš„ã€å¯ä»¥åŠ è½½ SO çš„ Filterï¼Œç„¶ååœ¨å…·ä½“çš„ SO ä¸­å®ç°çœŸæ­£çš„ StreamFilter é€»è¾‘ï¼Œç”±äº StreamFilter å®ç°æ‰€éœ€è¦çš„æ¥å£å®šä¹‰éƒ½åœ¨ mosn.io/api ä¸­ï¼Œæ‰€ä»¥ SO å¯ä»¥åšåˆ°å’Œ MOSN æ ¸å¿ƒæ¡†æ¶è§£è€¦åˆã€‚&lt;/p&gt;
&lt;p&gt;å…³é”®ç‚¹å°±æ˜¯è¿™ä¸ªé€šç”¨ Filter çš„è®¾è®¡å’Œå®ç°ï¼Œæˆ‘ä»¬ä¹Ÿé€šè¿‡ Demo æ¥çœ‹ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é€šç”¨ Filter çš„è®¾è®¡å’Œå®ç°&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªé€šç”¨çš„ Filter å’Œæ™®é€šçš„ StreamFilter ä¸åŒï¼Œå®ƒåªåŒ…å«ä¸€ä¸ªè¦ç´ ï¼šCreateFactoryã€‚æ€è·¯æ˜¯é€šè¿‡é€šç”¨çš„ CreateFactoryï¼ŒåŠ è½½ SO ä¸­çš„ CreateFactory å¹¶æ‰§è¡Œï¼Œè®© SO ä¸­çš„ Factory å‘æŒ¥ä½œç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1586436269013-7a2935b1-37f5-45c2-9e96-f11f62ed8bee.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;é€šç”¨ CreateFactory åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é…ç½®è§£æï¼Œè§£æå‡ºä¸¤éƒ¨åˆ†å†…å®¹ï¼šä¸€æ˜¯éœ€è¦åŠ è½½çš„ SO è·¯å¾„ï¼ŒäºŒæ˜¯ SO ä¸­å¯¹åº” Filter æ‰€éœ€è¦çš„é…ç½®ï¼›&lt;/li&gt;
&lt;li&gt;SO è·¯å¾„å°±ä»£è¡¨äº† SO ä¸­ Filter çš„â€œæ³¨å†Œâ€ï¼Œä»¥åŠæœ¬æ¬¡ä¼šé€‰æ‹©è¿™ä¸ª Filterï¼›&lt;/li&gt;
&lt;li&gt;åŠ è½½ SOï¼ŒåŸºäºå…¶ä¸­çº¦å®šå¥½çš„å‡½æ•°åï¼Œè·å–çœŸæ­£çš„ CreateFactory å‡½æ•°ï¼›&lt;/li&gt;
&lt;li&gt;è°ƒç”¨çœŸæ­£çš„ CreateFactory å‡½æ•°ï¼Œå®ç° SO ä¸­ StreamFilter çš„åŠ è½½ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒSO ä¸­çš„ StreamFIlter ä¹Ÿå’Œæ™®é€šçš„ FIlter æœ‰äº›åŒºåˆ«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ç”Ÿæˆ StreamFilterChainFactory çš„å‡½æ•°å¿…é¡»æ˜¯å›ºå®šçš„åå­—ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä¸å†éœ€è¦ init â€œæ³¨å†Œâ€è¯¥å‡½æ•°ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Stream Filter SO Demo: &lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/so&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/mosn-extensions/plugin/so&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Demo Readmeï¼š&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/cn_readme/mosn-extensions&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Demo çš„æ•ˆæœã€‚æœ¬æ¬¡ Demo ä¸­çš„ Filter å®ç°ä¾ç„¶æ˜¯ä¹‹å‰çš„â€œé‰´æƒâ€ç¤ºä¾‹ã€‚ç»è¿‡éªŒè¯ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªæ€è·¯æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ç¦»ç”Ÿäº§å®è·µè¿˜éœ€è¦å®Œå–„æ›´å¤šçš„ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;h3 id=&#34;ä»£ç æ‰©å±•æ´»åŠ¨&#34;&gt;ä»£ç æ‰©å±•æ´»åŠ¨&lt;/h3&gt;
&lt;p&gt;ç»è¿‡è¿™äº›æ¼”ç¤ºï¼Œç›¸ä¿¡å¤§å®¶å¯¹ MOSN çš„æ‰©å±•èƒ½åŠ›ä¹Ÿæœ‰æ‰€äº†è§£äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥åšä¸€ä¸ªä»£ç æ‰©å±•æ´»åŠ¨ï¼Œå¸Œæœ›å¤§å®¶å¯ä»¥è¸Šè·ƒå‚ä¸ã€‚å®Œæˆæ´»åŠ¨ä»»åŠ¡ï¼Œæäº¤ç›¸å…³ä»£ç  PR åˆ° MOSN çš„ä»“åº“ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œ CodeReview å’ŒéªŒè¯ï¼Œç¬¬ä¸€ä¸ªéªŒè¯é€šè¿‡çš„ä»£ç å°†åˆå¹¶åˆ° MOSN çš„ example ä¸­ï¼Œå¹¶ä¸”å¯¹æäº¤çš„åŒå­¦é€ä¸Šä¸€ä»½å¥–åŠ±ï¼›å¯¹äºå‰3åæäº¤ã€åŒæ ·ç»“æœæ­£ç¡®å¹¶ä¸”æ˜¯åŸåˆ›çš„ï¼Œè™½ç„¶æˆ‘ä»¬ä¸èƒ½åˆå¹¶å¯¹åº”çš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå°†é€ä¸Šå¥–åŠ±ã€‚&lt;/p&gt;
&lt;p&gt;æ´»åŠ¨ä»»åŠ¡å…±æœ‰äº”ä¸ªï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¤šè¿›ç¨‹ Demo ä¸­è¯ä¹¦åŠ è½½çš„ç‹¬ç«‹è¿›ç¨‹ï¼Œä½¿ç”¨ python æˆ–è€… java å®ç°ä»¥åï¼Œdemo è¿è¡Œæ¼”ç¤ºæˆåŠŸã€‚ä»»æ„ä¸€ç§è¯­è¨€å°±ç®—å®Œæˆä¸€ä¸ªä»»åŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;examples/codes/mosn-extensions/plugin/cert_loader/python/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;examples/codes/mosn-extensions/plugin/cert_loader/java/&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;å¤šè¿›ç¨‹ Demo ä¸­ stream filter çš„ç‹¬ç«‹è¿›ç¨‹ï¼Œä½¿ç”¨ python æˆ–è€… java å®ç°ä»¥åï¼Œdemo è¿è¡Œæ¼”ç¤ºæˆåŠŸã€‚ä»»æ„ä¸€ç§è¯­è¨€å°±ç®—å®Œæˆä¸€ä¸ªä»»åŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;examples/codes/mosn-extensions/plugin/filter/python/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;examples/codes/mosn-extensions/plugin/filter/java/&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;SO åŠ¨æ€åŠ è½½ Demo ä¸­ï¼ŒSO é‡Œå®ç°çš„ Stream Filter ç»“åˆå¤šè¿›ç¨‹æ¡†æ¶ï¼ˆGO è¯­è¨€ï¼‰å®ç°ï¼ŒDemo è¿è¡Œæ¼”ç¤ºæˆåŠŸã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;examples/codes/mosn-extensions/plugin/so/subprocess/&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è·¨è¯­è¨€ç›¸å…³çš„å®ç°å¯ä»¥å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/plugin/across-languages/server/&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/plugin/across-languages/server/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;è§„åˆ’ä¸å±•æœ›&#34;&gt;è§„åˆ’ä¸å±•æœ›&lt;/h3&gt;
&lt;p&gt;æœ€åå‘å¤§å®¶ä»‹ç»ä¸€ä¸‹ MOSN åç»­æ‰©å±•èƒ½åŠ›çš„è§„åˆ’ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶æœ‰éœ€æ±‚çš„å¯ä»¥å‘æˆ‘ä»¬åé¦ˆï¼Œæœ‰å…´è¶£çš„ä¸€èµ·å‚ä¸åˆ° MOSN çš„å»ºè®¾ä¸­æ¥ã€‚é¦–å…ˆå°±æ˜¯è¦å®Œå–„ SO åŠ¨æ€åº“åŠ è½½æœºåˆ¶ï¼Œè®© MOSN æ”¯æŒ SO æ–¹å¼åŠ è½½æ‰©å±•ï¼›ç„¶åå°±æ˜¯é’ˆå¯¹ LUA çš„è„šæœ¬æ‰©å±•ä»¥åŠæ”¯æŒ WASM çš„æ‰©å±•èƒ½åŠ›ï¼›æœ€å MOSN è¿˜ä¼šå¢åŠ æ›´å¤šçš„æ‰©å±•ç‚¹ï¼Œä»¥æ»¡è¶³æ›´å¤šæ›´å¤æ‚çš„åœºæ™¯ã€‚éå¸¸æ¬¢è¿å¤§å®¶å‚ä¸åˆ° MOSN ç¤¾åŒºçš„å…±å»ºä¸­ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSNï¼š&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;https://github.com/mosn/mosn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;MOSN å®˜ç½‘ï¼š&lt;a href=&#34;https://mosn.io/&#34;&gt;https://mosn.io/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šå°±æ˜¯æœ¬æœŸåˆ†äº«çš„å…¨éƒ¨å†…å®¹ï¼Œå¦‚æœå¤§å®¶å¯¹ MOSN æœ‰é—®é¢˜ä»¥åŠå»ºè®®ï¼Œæ¬¢è¿åœ¨ç¾¤å†…ä¸æˆ‘ä»¬äº¤æµã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æœŸç›´æ’­è§†é¢‘å›é¡¾ä»¥åŠ PPT æŸ¥çœ‹åœ°å€è§ï¼š&lt;a href=&#34;https://tech.antfin.com/community/live/1152&#34;&gt;https://tech.antfin.com/community/live/1152&lt;/a&gt;ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç åˆ†æ - è¿æ¥æ± </title>
      <link>https://mosn.io/blog/code/mosn-connection-pool/</link>
      <pubDate>Tue, 07 Apr 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-connection-pool/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº &lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;MOSN v0.10.0&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿æ¥ç®¡ç†ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç» MOSN å®ç°è¿æ¥æ± çš„åŠŸèƒ½ï¼Œè¿æ¥æ± æ˜¯ä¸Šä¸‹æ¸¸ MOSN ä¹‹é—´è¿›è¡Œé•¿è¿æ¥å¤ç”¨ä»¥æé«˜è½¬å‘æ•ˆç‡ä¸é™ä½æ—¶å»¶çš„å…³é”®ï¼ŒMOSN è¿æ¥æ± æä¾›åŸºäº HTTP1, HTTP2, SOFARPC, XProtocol åè®®çš„è¿æ¥æ± ã€‚&lt;/p&gt;
&lt;p&gt;è€Œâ€œå¥åº·æ£€æŸ¥â€æ˜¯ä¸€ç§å®æ—¶æ£€æµ‹ä¸Šæ¸¸æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®æä¾›æœåŠ¡çš„æœºåˆ¶ï¼Œä¸€èˆ¬åˆ†ä¸ºâ€œä¸»åŠ¨å¥åº·æ£€æŸ¥â€å’Œâ€œè¢«åŠ¨å¥åº·æ£€æŸ¥â€ã€‚ä¸»åŠ¨å¥åº·æ£€æŸ¥ç”±å¥åº·æ£€æŸ¥æ¨¡å—ä¸»åŠ¨å‘èµ·ï¼Œé€šè¿‡å‘¨æœŸæ€§çš„å‘é€å¥åº·æ£€æŸ¥æ•°æ®åŒ…å¯¹æœåŠ¡å™¨è¿›è¡Œå¥åº·æ£€æŸ¥ï¼›è¢«åŠ¨å¥åº·æ£€æŸ¥åˆ™æ˜¯åœ¨è½¬å‘ä¸šåŠ¡æ•°æ®æŠ¥æ–‡æ—¶å‘ç°ä¸Šæ¸¸æœåŠ¡å™¨æ— æ³•æ­£ç¡®çš„æä¾›æœåŠ¡ï¼Œè€Œè¢«åŠ¨æ‘˜é™¤çš„æ‰‹æ®µã€‚&lt;/p&gt;
&lt;p&gt;MOSN å½“å‰åªæ”¯æŒä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼Œæ”¯æŒçš„åè®®åŒ…æ‹¬ SOFARPC ä»¥åŠ HTTP2ï¼Œå®ƒæ˜¯ Cluster çš„ä¸€ä¸ªæ¨¡å—ï¼Œå¯é€šè¿‡é…ç½®å†³å®šæ˜¯å¦å¼€å¯å¯¹ Cluster ä¸­çš„ Host è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œä»¥åŠé…ç½®å¥åº·æ£€æŸ¥æ—¶ä½¿ç”¨çš„å‚æ•°ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ŒMOSN å¯ä»¥åŠæ—¶æ‘˜é™¤ä¸å¥åº·çš„æœºå™¨ï¼Œä»è€Œä¸ºè¿æ¥ç®¡ç†æä¾›æœ‰æ•ˆçš„ &lt;code&gt;Upstream&lt;/code&gt;ï¼Œæé«˜å»ºè¿çš„æˆåŠŸç‡ã€‚åŒæ—¶åŸºäºå¥åº·æ£€æŸ¥æ¨¡å—è¿˜å¯ä»¥åšè¿æ¥çš„ä¿æ´»ï¼Œä»è€Œç»´æŒé•¿è¿æ¥ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-è¿æ¥ç®¡ç†&#34;&gt;MOSN è¿æ¥ç®¡ç†&lt;/h2&gt;
&lt;p&gt;HTTP/1.0 é»˜è®¤ä½¿ç”¨çŸ­è¿æ¥ï¼Œå³å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ¯è¿›è¡Œä¸€æ¬¡ HTTP æ“ä½œå»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œä»»åŠ¡ç»“æŸä¸­æ–­è¿æ¥ã€‚HTTP/1.1 èµ·é»˜è®¤ä½¿ç”¨é•¿è¿æ¥ç”¨ä»¥ä¿æŒè¿æ¥ç‰¹æ€§ã€‚ä½¿ç”¨é•¿è¿æ¥çš„ HTTP åè®®éœ€åœ¨å“åº”å¤´æ·»åŠ  &lt;code&gt;Connection:keep-alive&lt;/code&gt;ã€‚HTTP/1.0 è™½ç„¶èƒ½å¤Ÿç»´æŒé•¿è¿æ¥ï¼Œä½†æ˜¯å•æ¡è¿æ¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚/å“åº”ï¼Œæ„å‘³ç€å¦‚æœåŒæ—¶æ”¶åˆ°4ä¸ªè¯·æ±‚éœ€è¦å»ºç«‹4æ¡ TCP è¿æ¥ï¼Œè¿æ¥çš„æˆæœ¬ç›¸å¯¹æ¥è¯´æ¯”è¾ƒé«˜æ˜‚ï¼›HTTP/2 å¼•å…¥ Stream/Frame çš„æ¦‚å¿µï¼Œæ”¯æŒåˆ†å¸§å¤šè·¯å¤ç”¨èƒ½åŠ›ï¼Œåœ¨é€»è¾‘ä¸ŠåŒºåˆ†å‡ºæˆå¯¹çš„è¯·æ±‚ Stream å’Œå“åº” Streamï¼Œä»è€Œå•æ¡è¿æ¥å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚/å“åº”ï¼Œè§£å†³ HTTP/1.0 è¿æ¥æ•°ä¸å¹¶å‘æ•°æˆæ­£æ¯”çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;HTTP/1.1 ä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œä½¿ç”¨ç»å…¸çš„ Ping-Pong æ¨¡å¼ï¼šåœ¨è¯·æ±‚å‘é€ä¹‹åå¿…é¡»ç‹¬å å½“å‰è¿æ¥ç­‰å¾…æœåŠ¡å™¨ç«¯ç»™å‡ºè¿™ä¸ªè¯·æ±‚çš„åº”ç­”ç„¶åæ‰èƒ½é‡Šæ”¾è¿æ¥ã€‚å› æ­¤ HTTP/1.1 ä¸‹å¹¶å‘å¤šä¸ªè¯·æ±‚å°±å¿…é¡»é‡‡ç”¨å¤šè¿æ¥ï¼Œä¸ºäº†æå‡æ€§èƒ½é€šå¸¸ä½¿ç”¨é•¿è¿æ¥+è¿æ¥æ± çš„è®¾è®¡ã€‚MOSN é•¿è¿æ¥å¤šè·¯å¤ç”¨å¤„ç†æµç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSN ä» downstream æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ requestï¼Œä¾æ®æŠ¥æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ &lt;code&gt;GetRequestId&lt;/code&gt; è·å–åˆ°è¯·æ±‚åœ¨è¿™æ¡è¿æ¥ä¸Šçš„èº«ä»½æ ‡è¯†å¹¶ä¸”è®°å½•åˆ°å…³è”æ˜ å°„ä¸­å¾…ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;è¯·æ±‚ç»è¿‡ MOSN çš„è·¯ç”±ã€è´Ÿè½½å‡è¡¡å¤„ç†ï¼Œé€‰æ‹©ä¸€ä¸ª upstreamï¼ŒåŒæ—¶åœ¨è¿™æ¡è¿æ¥ä¸Šæ–°å»ºä¸€ä¸ªè¯·æ±‚æµï¼Œå¹¶è°ƒç”¨æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ &lt;code&gt;SetRequestId&lt;/code&gt; å°è£…æ–°çš„èº«ä»½æ ‡è¯†ï¼Œå¹¶è®°å½•åˆ°å…³è”æ˜ å°„ä¸­ä¸ downstream ä¿¡æ¯ç»„åˆï¼›&lt;/li&gt;
&lt;li&gt;MOSN ä» upstream æ¥æ”¶ä¸€ä¸ªå“åº” responseï¼Œä¾æ®æŠ¥æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ &lt;code&gt;GetRequestId&lt;/code&gt; è·å–åˆ°è¯·æ±‚åœ¨è¿™æ¡è¿æ¥ä¸Šçš„èº«ä»½æ ‡è¯†ã€‚æ­¤æ—¶å¯ä»¥ä»ä¸Šä¸‹æ¸¸å…³è”æ˜ å°„è¡¨ä¸­ï¼Œæ ¹æ® upstream ä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„ downstream ä¿¡æ¯ï¼›&lt;/li&gt;
&lt;li&gt;ä¾æ® downstream request çš„ä¿¡æ¯ï¼Œè°ƒç”¨æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ &lt;code&gt;SetRequestId&lt;/code&gt; è®¾ç½®å“åº”çš„ requestIdï¼Œå¹¶å›å¤ç»™ downstreamã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MOSN åœ¨ &lt;code&gt;Proxy&lt;/code&gt; ä¸‹æ¸¸ Request æ—¶ï¼Œä¼šæ ¹æ® &lt;code&gt;Upstream&lt;/code&gt; Host åœ°å€ä»¥åŠä¸ &lt;code&gt;Upstream&lt;/code&gt; Host çš„åº”ç”¨å±‚åè®®è·å–å¯¹åº”çš„é•¿è¿æ¥ï¼Œä¹‹ååœ¨é•¿è¿æ¥ä¸Šå°è£…å¯¹åº”åè®®çš„ Stream, å¹¶è½¬å‘æ•°æ®ï¼Œä»è€Œé¿å…æ¯æ¬¡ä¸ &lt;code&gt;Upstream&lt;/code&gt; æ–°å»ºè¿æ¥å¸¦æ¥çš„æ¡æ‰‹å¼€é”€ä»¥æé«˜è½¬å‘æ€§èƒ½ã€é™ä½æ—¶å»¶ã€‚åœ¨åˆ›å»º Stream çš„æ—¶å€™ï¼Œè¿æ¥æ± è¿˜æä¾›ç†”æ–­ä¿æŠ¤åŠŸèƒ½ï¼Œå°† Stream åˆ›å»ºçš„æ•°é‡çº¦æŸåœ¨ä¸€ä¸ªé˜ˆå€¼ä»¥ä¸‹ã€‚å½“å‰ MOSN æ”¯æŒçš„è¿æ¥æ± åŒ…æ‹¬ï¼šSOFARPCã€HTTP1ã€HTTP2ã€XProocol ç­‰åº”ç”¨å±‚åè®®çš„è¿æ¥æ± .&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MOSN çš„ &lt;code&gt;Proxy&lt;/code&gt; æ¨¡å—åœ¨ &lt;code&gt;Downstream&lt;/code&gt; æ”¶åˆ° Request çš„æ—¶å€™ï¼Œåœ¨ç»è¿‡è·¯ç”±ã€è´Ÿè½½å‡è¡¡ç­‰æ¨¡å—å¤„ç†è·å–åˆ° &lt;code&gt;Upstream&lt;/code&gt; Host ä»¥åŠå¯¹åº”çš„è½¬å‘åè®®æ—¶ï¼Œä¼šå» Cluster Manager è·å–è¿æ¥æ±  ï¼Œå¦‚æœè¿æ¥æ± ä¸å­˜åœ¨åˆ™åˆ›å»ºå¹¶åŠ å…¥ç¼“å­˜ï¼Œä¹‹ååœ¨é•¿è¿æ¥ä¸Šåˆ›å»º Streamï¼Œå¹¶å‘é€æ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºè¿æ¥æ± å·¥ä½œçš„ç¤ºæ„å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./proxy.png&#34; alt=&#34;MOSN çš„è¿æ¥æ± å·¥ä½œç¤ºæ„å›¾&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ¥å£æè¿°&#34;&gt;æ¥å£æè¿°&lt;/h3&gt;
&lt;p&gt;è¿æ¥æ± æ¥å£&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Protocol()&lt;/code&gt; ç”¨äºè¿”å›å½“å‰è¿æ¥æ± å¯¹åº”çš„åè®®ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NewStream()&lt;/code&gt; ç”¨äºåœ¨å½“å‰è¿æ¥æ± ä¸Šåˆ›å»º Streamï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Close()&lt;/code&gt; ç”¨äºå…³é—­é•¿è¿æ¥ä¸­çš„ TCP å¥—æ¥å­—ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;./connection-pool.png&#34; alt=&#34;è¿æ¥æ± æ¥å£&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿æ¥æ± äº‹ä»¶ç›‘å¬çš„æ¥å£&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;OnFailure&lt;/code&gt; ç”¨äºåˆ›å»º Stream å¤±è´¥æ—¶çš„å›è°ƒï¼Œç”¨äº reset stream ç›¸å…³å·¥ä½œï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OnReady&lt;/code&gt; æ˜¯è¿æ¥æ± å‡†å¤‡å°±ç»ªï¼ŒStream åˆ›å»ºæˆåŠŸæ—¶çš„å›è°ƒï¼Œç”¨äº Stream å‘é€æ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;./pool-event-listener.png&#34; alt=&#34;è¿æ¥æ± äº‹ä»¶ç›‘å¬çš„æ¥å£&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®ç»“æ„&#34;&gt;æ•°æ®ç»“æ„&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ConnNewPoolFactories&lt;/code&gt; ä¸ºä¸åŒåè®®åˆ›å»ºå¯¹åº”è¿æ¥æ± çš„å·¥å‚ç±»ï¼ŒHTTP1ã€SOFARPCã€ HTTP2ã€XProtocol ç­‰åè®®åˆ†åˆ«è°ƒç”¨æ³¨å†Œå‡½æ•° &lt;code&gt;RegisterNewPoolFactory&lt;/code&gt; ï¼Œæ³¨å†Œè‡ªå·±çš„åˆ›å»ºæ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;ç±» &lt;code&gt;clusterManager&lt;/code&gt; ä¸­çš„ &lt;code&gt;protocolConnPool&lt;/code&gt; ä¸ºå…¨å±€è¿æ¥æ± çš„å®ç°ï¼Œå…¶ç±»å‹ä¸ºäºŒçº§ &lt;code&gt;sync.Map&lt;/code&gt;ï¼Œå…¶ä¸­ç¬¬ä¸€çº§ Map çš„ key ä¸ºåè®®ç±»å‹ï¼Œç¬¬äºŒçº§ Map çš„ key ä¸º Host åœ°å€ï¼Œvalue ä¸º &lt;code&gt;ConnectionPool&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;ç±» &lt;code&gt;upstreamRequest&lt;/code&gt; ä¸­ç»´æŠ¤ &lt;code&gt;connPool&lt;/code&gt; æ˜¯ &lt;code&gt;connPool&lt;/code&gt; çš„ä½¿ç”¨è€…ï¼Œç”¨æ¥åˆ›å»ºè¿æ¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;è¿æ¥æ± ä½¿ç”¨&#34;&gt;è¿æ¥æ± ä½¿ç”¨&lt;/h3&gt;
&lt;h4 id=&#34;åˆå§‹åŒ–è¿æ¥æ± &#34;&gt;åˆå§‹åŒ–è¿æ¥æ± &lt;/h4&gt;
&lt;p&gt;&lt;code&gt;clusterManager&lt;/code&gt; åœ¨æŸ¥è¯¢æœ¬åœ°è¿æ¥æ± æ—¶ï¼Œå¦‚æœå¯¹åº”åè®®å’Œ Host çš„è¿æ¥æ± ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨å¯¹åº”åè®®çš„å·¥å‚æ–¹æ³•åˆ›å»ºè¿æ¥æ± ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å›è¿æ¥æ± ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./cluster-manager.png&#34; alt=&#34;åˆå§‹åŒ–è¿æ¥æ± &#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;è·å–è¿æ¥æ± &#34;&gt;è·å–è¿æ¥æ± &lt;/h4&gt;
&lt;p&gt;&lt;code&gt;downstream&lt;/code&gt; åœ¨æ”¶åˆ°ä¸‹æ¸¸çš„ request å¹¶å¾€ä¸Šæ¸¸è½¬å‘æ—¶ï¼Œä¼šæ ¹æ®åè®®å’ŒæŒ‘é€‰çš„ &lt;code&gt;upstream&lt;/code&gt; åœ°å€é€‰æ‹©è¿æ¥æ± å¹¶èµ‹å€¼ç»™ &lt;code&gt;upstream&lt;/code&gt; çš„ &lt;code&gt;connPool&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./receive-headers.png&#34; alt=&#34;è·å–è¿æ¥æ± &#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;ä½¿ç”¨è¿æ¥æ± &#34;&gt;ä½¿ç”¨è¿æ¥æ± &lt;/h4&gt;
&lt;p&gt;&lt;code&gt;upstreamRequest&lt;/code&gt; åœ¨å¾€ä¸Šæ¸¸è½¬å‘æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨ &lt;code&gt;connPool&lt;/code&gt; å¯¹åº”çš„ &lt;code&gt;Newstream&lt;/code&gt; æ–¹æ³•å°è£… stream å¹¶å‘é€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./append-headers.png&#34; alt=&#34;ä½¿ç”¨è¿æ¥æ± &#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;mosn-å¥åº·æ£€æŸ¥&#34;&gt;MOSN å¥åº·æ£€æŸ¥&lt;/h2&gt;
&lt;p&gt;MOSN çš„å¥åº·æ£€æŸ¥æ˜¯ä¸€ç§ä¸»åŠ¨å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œä»–æ˜¯ Cluster å†…åœ¨çš„ä¸€ä¸ªæ¨¡å—ã€‚å½“å‰æ”¯æŒçš„å¥åº·æ£€æŸ¥åŠŸèƒ½åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¥åº·æ£€æŸ¥æ”¯æŒå¯é…ç½®ï¼Œé…ç½®åŒ…æ‹¬å¥åº·æ£€æŸ¥ä½¿ç”¨çš„åè®®ã€å¥åº·æ£€æŸ¥æŠ¥æ–‡å‘é€é—´éš”ã€è¶…æ—¶æ—¶é—´ã€æ›´æ–°é˜ˆå€¼ç­‰ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›å¥åº·æ£€æŸ¥æ¥å£ï¼Œå…è®¸ä¸åŒå¥åº·æ£€æŸ¥åè®®çš„æ‰©å±•ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›åŸºäºå¥åº·æ£€æŸ¥ç»“æœçš„ callback æœºåˆ¶ï¼Œå…è®¸è‡ªå®šä¹‰å¯¹å¥åº·æ£€æŸ¥ç»“æœçš„å¤„ç†æ–¹å¼ï¼›&lt;/li&gt;
&lt;li&gt;åŸºäºå‘¨æœŸæ€§çš„å¥åº·æ£€æŸ¥ï¼Œå¯å®ç°å¿ƒè·³æœºåˆ¶ï¼Œç”¨äºé•¿è¿æ¥çš„ä¿æ´»ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚ä¸‹ä¸ºå½“å‰å¥åº·æ£€æŸ¥å·¥ä½œçš„ç¤ºæ„å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./health-check.png&#34; alt=&#34;å½“å‰å¥åº·æ£€æŸ¥å·¥ä½œçš„ç¤ºæ„å›¾&#34;&gt;&lt;/p&gt;
&lt;p&gt;Cluster çš„ &lt;code&gt;HealthChecker&lt;/code&gt; æ¨¡å—åœ¨å¼€å¯çš„æƒ…å†µä¸‹ï¼Œä¼šæ ¹æ®é…ç½®çš„åè®®åˆ›å»ºåŸºäº SOFARPCï¼Œ HTTP2 æˆ–è€…å…¶ä»–åè®®çš„å¥åº·æ£€æŸ¥ï¼›å¥åº·æ£€æŸ¥æ¨¡å—ä¼šä¸ Cluster ä¸­çš„æ‰€æœ‰ Host - åˆ›å»º &lt;code&gt;HealthCheckSession&lt;/code&gt;ï¼Œåœ¨ &lt;code&gt;Session&lt;/code&gt; ä¸Šå‘¨æœŸæ€§å‘é€å¥åº·æ£€æŸ¥æŠ¥æ–‡ï¼Œå¹¶å¼€å¯å®šæ—¶å™¨ï¼Œå¦‚æœ Response åœ¨è§„å®šæ—¶é—´å†…æœªè¾¾/åˆ°è¾¾åˆ™åˆ¤æ–­å¥åº·æ£€æŸ¥å¤±è´¥/æˆåŠŸï¼Œå¥åº·æ£€æŸ¥å¤±è´¥/æˆåŠŸæ¬¡æ•°åˆ°ä¸€å®šé˜ˆå€¼å Callback æ¨¡å—ä¼šæ›´æ–°æœºå™¨çš„å¥åº·çŠ¶æ€ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¥åº·æ£€æŸ¥é…ç½®&#34;&gt;å¥åº·æ£€æŸ¥é…ç½®&lt;/h3&gt;
&lt;p&gt;å¯¹ Cluster çš„å¥åº·æ£€æŸ¥æ”¯æŒçš„é…ç½®åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‘èµ·å¥åº·æ£€æŸ¥çš„åº”ç”¨å±‚åè®®ï¼Œå¦‚æœå­åè®®å­˜åœ¨ï¼Œè¿˜æ”¯æŒé…å­åè®®&lt;/li&gt;
&lt;li&gt;å¥åº·æ£€æŸ¥æŠ¥æ–‡çš„è¶…æ—¶æ—¶é—´&lt;/li&gt;
&lt;li&gt;å‘èµ·å¥åº·æ£€æŸ¥æŠ¥æ–‡çš„é—´éš”&lt;/li&gt;
&lt;li&gt;æ›´æ–° Host çŠ¶æ€çš„é˜ˆå€¼&lt;/li&gt;
&lt;li&gt;å¥åº·æ£€æŸ¥çš„è·¯å¾„å’Œå¯¹åº”çš„ Service ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;./health-check-config.png&#34; alt=&#34;å¥åº·æ£€æŸ¥é…ç½®&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ¥å£æè¿°-1&#34;&gt;æ¥å£æè¿°&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;HealthChecker&lt;/code&gt; æ¥å£ç”¨æ¥æ§åˆ¶å¯¹æ•´ä¸ª Cluster è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œå…¶ä¸­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Start/Stop å¼€å¯/å…³é—­ å¯¹ Cluster çš„å¥åº·æ£€æŸ¥ï¼Œä¼šå¼€å¯ Host çš„å¥åº·æ£€æŸ¥ Session;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AddHostCheckCompleteCb&lt;/code&gt; ç”¨æ¥è®¾ç½®å¯¹å¥åº·æ£€æŸ¥ç»“æœçš„å›è°ƒï¼Œå…³äº cb çš„å®šä¹‰åœ¨ä¸‹é¢ä¼šä»‹ç»;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OnClusterMemberUpdate&lt;/code&gt; æ˜¯åœ¨å¤–éƒ¨ Cluster çš„ Hosts å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¾‹å¦‚ä¸»æœºä¸Šä¸‹çº¿ç­‰ï¼Œæ¥æ›´æ–°å¥åº·æ£€æŸ¥çš„èŒƒå›´ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;./health-checker.png&#34; alt=&#34;æ¥å£æè¿°&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;HealthCheckCb&lt;/code&gt; æ˜¯åŸºäºå¥åº·æ£€æŸ¥ç»“æœå¯¹ Host çŠ¶æ€è¿›è¡Œæ›´æ–°çš„å›è°ƒå‡½æ•°ï¼Œå‘ç”Ÿåœ¨å¥åº·æ£€æŸ¥çš„ç»“æœå¯¹ Host çš„çŠ¶æ€äº§ç”Ÿå½±å“ä¹‹åï¼Œå¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåˆ™ä¼šå°† Host ç½®ä¸º Unhealtyï¼Œå¦åˆ™ç½®ä¸º Healthyã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./health-check-cb.png&#34; alt=&#34;å¥åº·æ£€æŸ¥&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;HealthCheckSession&lt;/code&gt; æ˜¯å¥åº·æ£€æŸ¥æ¨¡å—ä¸æ¯ä¸ª Host å»ºç«‹çš„ç”¨äºå¥åº·æ£€æŸ¥çš„ sessionï¼Œåœ¨è¿™ä¸ª session ä¸Šå¯ä»¥å‘é€å¥åº·æ£€æŸ¥æ•°æ®åŒ…å¹¶å¤„ç† responseã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Start/Stop å¼€å¯/åœæ­¢ å¯¹ Host çš„å¥åº·æ£€æŸ¥ï¼›&lt;/li&gt;
&lt;li&gt;SetUnhealthy ä¸ºå¥åº·æ£€æŸ¥å¤±è´¥è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä¹‹åå°† Host çš„çŠ¶æ€è®¾ç½®ä¸º Unhealthyã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;./health-check-session.png&#34; alt=&#34;å¥åº·æ£€æŸ¥&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®ç»“æ„-1&#34;&gt;æ•°æ®ç»“æ„&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Cluster ä¸­çš„ &lt;code&gt;healthChecker&lt;/code&gt; åœ¨ Cluster åˆ›å»ºçš„æ—¶å€™åŸºäºé…ç½®è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœé…ç½®æ”¯æŒå¥åº·æ£€æŸ¥ï¼Œåˆ™å¼€å¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;healthChecker&lt;/code&gt; æ˜¯å®ç° Cluster å¥åº·æ£€æŸ¥çš„ç±»ï¼Œå…¶ä¸­åŒ…å«å¯¹æ‰€æœ‰çš„ Host çš„è¿›è¡Œå¥åº·æ£€æŸ¥çš„ &lt;code&gt;healthCheckSessions&lt;/code&gt;ã€‚åœ¨å®ç°åŸºäºä¸åŒçš„åè®®çš„å¥åº·æ£€æŸ¥æ—¶ï¼Œä¼šç»§æ‰¿è¿™ä¸ªç±»ï¼Œå¹¶é‡å†™ä¸€äº›æ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;healthCheckSesion&lt;/code&gt; æ˜¯å¯¹ Host å¥åº·æ£€æŸ¥çš„ sessionï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªå®šæ—¶å™¨ï¼Œä»¥åŠå¯¹åº”çš„å¥åº·çŠ¶æ€æ›´æ–°é˜ˆå€¼ã€‚åœ¨å®ç°åŸºäºä¸åŒçš„åè®®çš„å¥åº·æ£€æŸ¥æ—¶ï¼Œä¼šç»§æ‰¿è¿™ä¸ªç±»ï¼Œå¹¶é‡å†™ä¸€äº›æ–¹æ³•ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;å·¥ä½œæµç¨‹&#34;&gt;å·¥ä½œæµç¨‹&lt;/h3&gt;
&lt;p&gt;ä¸‹å›¾æ˜¯å¥åº·æ£€æŸ¥çš„å·¥ä½œæ—¶åºå›¾ï¼ŒåŒ…æ‹¬ ä»Cluster åˆ›å»ºå¥åº·æ£€æŸ¥å™¨å¼€å§‹ï¼Œåˆ°å¯¹æ¯ä¸ª Host åˆ›å»ºå¥åº·æ£€æŸ¥çš„ Sessionï¼Œåˆ°å¯¹ Host å‘é€å¥åº·æ£€æŸ¥æ•°æ®åŒ…ï¼Œåˆ°å¤„ç† Host çš„å“åº”ï¼Œåˆ°æ›´æ–° Host çš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./health-check-process.png&#34; alt=&#34;å·¥ä½œæµç¨‹&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡æ ¹æ® MOSN çš„æºç åˆ†æ MOSN å¯¹è¿æ¥æ± çš„è®¾è®¡ä¸å®ç°ï¼Œå…¶åŸºäº &lt;code&gt;upstreamRequest&lt;/code&gt; å¾€ä¸Šæ¸¸è½¬å‘æ•°æ®è°ƒç”¨ &lt;code&gt;connPool&lt;/code&gt; å¯¹åº”çš„ &lt;code&gt;Newstream&lt;/code&gt; æ–¹æ³•å‘é€ Streamã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN å¤šåè®®æœºåˆ¶è§£æ</title>
      <link>https://mosn.io/blog/posts/multi-protocol-deep-dive/</link>
      <pubDate>Thu, 26 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/multi-protocol-deep-dive/</guid>
      <description>
        
        
        &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡æ ¹æ® SOFAChannel#13 ç›´æ’­åˆ†äº«æ•´ç†ï¼Œä¸»é¢˜ï¼šäº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å¤šåè®®æœºåˆ¶è§£æï¼Œ&lt;a href=&#34;https://tech.antfin.com/community/live/1131&#34;&gt;æŸ¥çœ‹è§†é¢‘å›é¡¾&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä½œè€…ï¼šæ— é’©ï¼Œç›®å‰ä¸»è¦ä»äº‹èš‚èšé›†å›¢ç½‘ç»œä»£ç†ç›¸å…³çš„ç ”å‘å·¥ä½œï¼Œä¹Ÿæ˜¯ MOSN çš„ Committerã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©æˆ‘è¦å’Œå¤§å®¶åˆ†äº«çš„æ˜¯ã€Šäº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å¤šåè®®æœºåˆ¶è§£æã€‹ï¼Œå¹¶ä»‹ç»å¯¹åº”çš„ç§æœ‰åè®®å¿«é€Ÿæ¥å…¥å®è·µæ¡ˆä¾‹ä»¥åŠå¯¹ MOSN å®ç°å¤šåè®®ä½æˆæœ¬æ¥å…¥çš„è®¾è®¡è¿›è¡Œè§£è¯»ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å°†æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œä»‹ç»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¤šåè®®æœºåˆ¶äº§ç”Ÿçš„èƒŒæ™¯ä¸å®è·µç—›ç‚¹ï¼›&lt;/li&gt;
&lt;li&gt;å¸¸è§çš„åè®®æ‰©å±•æ€è·¯åˆæ¢ï¼›&lt;/li&gt;
&lt;li&gt;SOFABolt åè®®æ¥å…¥å®è·µï¼›ï¼ˆé‡ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;MOSN å¤šåè®®æœºåˆ¶è®¾è®¡è§£è¯»ï¼›ï¼ˆé‡ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;åç»­è§„åˆ’åŠå±•æœ›ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶ä¸­ç¬¬ä¸‰ç‚¹ã€Œæ¥å…¥å®è·µã€æ˜¯ä»Šå¤©åˆ†äº«çš„é‡ç‚¹ï¼Œå¸Œæœ›èƒ½ç»™å¤§å®¶å°±ã€Œå¦‚ä½•åœ¨ MOSN ä¸­å¿«é€Ÿæ‰©å±•ç§æœ‰åè®®æ¥å…¥ã€æœ‰ä¸€ä¸ªå…·ä½“çš„æ„Ÿå—ã€‚å¦å¤–ã€ŒMOSN å¦‚ä½•å®ç°å¤šåè®®æ¡†æ¶ã€ä¹Ÿæ˜¯å¾ˆå¤šäººå…³å¿ƒå’Œé—®é¢˜ï¼Œæˆ‘ä»¬å°†æ‘˜é€‰å‡ ä¸ªæŠ€æœ¯åŠŸèƒ½ï¼Œå¯¹å…¶èƒŒåçš„è®¾è®¡æ€è€ƒè¿›è¡Œè§£è¯»ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-ç®€ä»‹&#34;&gt;MOSN ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;1585209248453-cbf84b1b-6765-4f05-bd8e-44300b995266.png&#34; alt=&#34;MOSN ç®€ä»‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å®šä½æ˜¯ä¸€ä¸ªå…¨æ ˆçš„ç½‘ç»œä»£ç†ï¼Œæ”¯æŒåŒ…æ‹¬ç½‘ç»œæ¥å…¥å±‚(Ingress)ã€API Gatewayã€Service Mesh ç­‰åœºæ™¯ï¼Œç›®å‰åœ¨èš‚èšé›†å›¢å†…éƒ¨çš„æ ¸å¿ƒä¸šåŠ¡é›†ç¾¤å·²ç»å®ç°å…¨é¢è½åœ°ï¼Œå¹¶ç»å—äº† 2019 å¹´åŒåä¸€å¤§ä¿ƒçš„è€ƒéªŒã€‚ä»Šå¤©è¦å‘å¤§å®¶ä»‹ç»çš„æ˜¯äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€çš„å¤šåè®®æ‰©å±•æœºåˆ¶ï¼Œç›®å‰å·²ç»æ”¯æŒäº†åŒ…æ‹¬ SOFABoltã€Dubboã€TARS ç­‰å¤šä¸ªåè®®çš„å¿«é€Ÿæ¥å…¥ã€‚&lt;/p&gt;
&lt;p&gt;MOSNï¼š&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;https://github.com/mosn/mosn&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤šåè®®æœºåˆ¶äº§ç”Ÿçš„èƒŒæ™¯ä¸å®è·µç—›ç‚¹&#34;&gt;å¤šåè®®æœºåˆ¶äº§ç”Ÿçš„èƒŒæ™¯ä¸å®è·µç—›ç‚¹&lt;/h2&gt;
&lt;p&gt;é¦–å…ˆä»‹ç»ä¸€ä¸‹å¤šåè®®æœºåˆ¶äº§ç”Ÿçš„èƒŒæ™¯ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248463-b8b38ab0-09ed-4225-8d60-5bad3c2a372b.png&#34; alt=&#34;å¤šåè®®æœºåˆ¶&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‰é¢æåˆ°ï¼Œèš‚èšé›†å›¢ 2019 å¹´åŒåä¸€æ ¸å¿ƒé“¾è·¯ç™¾åˆ†ä¹‹ç™¾ Mesh åŒ–ï¼Œæ˜¯ä¸šç•Œå½“æ—¶å·²çŸ¥çš„æœ€å¤§è§„æ¨¡çš„ Service Mesh è½åœ°ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ•¢è¿™ä¹ˆåšï¼Ÿå› ä¸ºæˆ‘ä»¬å…·å¤‡èƒ½å¤Ÿè®©æ¶æ„å¹³æ»‘è¿ç§»çš„æ–¹æ¡ˆã€‚&amp;ldquo;å…¼å®¹æ€§&amp;quot;æ˜¯ä»»ä½•æ¶æ„æ¼”è¿›å‡çº§éƒ½å¿…ç„¶è¦é¢å¯¹çš„ä¸€ä¸ªé—®é¢˜ï¼Œè¿™åœ¨æ—©å·²å®è·µå¾®æœåŠ¡åŒ–æ¶æ„çš„èš‚èšé›†å›¢å†…éƒ¨åŒæ ·å¦‚æ­¤ã€‚ä¸ºäº†å®ç°æ¶æ„çš„å¹³æ»‘è¿ç§»ï¼Œéœ€è¦è®©æ–°è€èŠ‚ç‚¹çš„å¤–åœ¨è¡Œä¸ºå°½å¯èƒ½çš„è¡¨ç°ä¸€è‡´ï¼Œä»è€Œè®©ä¾èµ–æ–¹æ— æ„ŸçŸ¥ï¼Œè¿™å…¶ä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯ä¿æŒåè®®å…¼å®¹æ€§ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Service Mesh æ¶æ„ä¸‹ï¼Œå…¼å®¹ç°æœ‰å¾®æœåŠ¡ä½“ç³»ä¸­çš„é€šä¿¡åè®®â€”â€”ä¹Ÿå°±æ˜¯è¯´éœ€è¦åœ¨ MOSN å†…å®ç°å¯¹ç›®å‰èš‚èšé›†å›¢å†…éƒ¨é€šä¿¡åè®®çš„æ‰©å±•æ”¯æŒã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248513-3bf90371-3d7c-4a0f-a98a-db4538bb2271.png&#34; alt=&#34;åè®®æ‰©å±•æ”¯æŒ&#34;&gt;&lt;/p&gt;
&lt;p&gt;åŸºäº MOSN æœ¬èº«çš„æ‰©å±•æœºåˆ¶ï¼Œæˆ‘ä»¬å®Œæˆäº†æœ€åˆç‰ˆæœ¬çš„åè®®æ‰©å±•æ¥å…¥ã€‚ä½†æ˜¯åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç›¸æ¯”ç¼–è§£ç ï¼Œåè®®è‡ªèº«çš„å¤„ç†ä»¥åŠä¸æ¡†æ¶é›†æˆæ‰æ˜¯å…¶ä¸­æœ€å›°éš¾çš„ç¯èŠ‚ï¼Œéœ€è¦ç†è§£å¹¶å®ç°åŒ…æ‹¬è¯·æ±‚ç”Ÿå‘½å‘¨æœŸã€å¤šè·¯å¤ç”¨å¤„ç†ã€é“¾æ¥æ± ç­‰ç­‰æœºåˆ¶ï¼›&lt;/li&gt;
&lt;li&gt;ç¤¾åŒºä¸»æµçš„ xDS è·¯ç”±é…ç½®æ˜¯é¢å‘ HTTP åè®®çš„ï¼Œæ— æ³•ç›´æ¥æ”¯æŒç§æœ‰åè®®ï¼Œå­˜åœ¨é€‚é…æˆæœ¬ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åŸºäºè¿™äº›å®è·µç—›ç‚¹ï¼Œæˆ‘ä»¬è®¾è®¡äº† MOSN å¤šåè®®æ¡†æ¶ï¼Œå¸Œæœ›å¯ä»¥é™ä½ç§æœ‰åè®®çš„æ¥å…¥æˆæœ¬ï¼ŒåŠ å¿«æ™®åŠ ServiceMesh æ¶æ„çš„è½åœ°æ¨è¿›ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¸¸è§çš„åè®®æ‰©å±•æ€è·¯åˆæ¢&#34;&gt;å¸¸è§çš„åè®®æ‰©å±•æ€è·¯åˆæ¢&lt;/h2&gt;
&lt;p&gt;å‰é¢ä»‹ç»äº†èƒŒæ™¯ï¼Œé‚£ä¹ˆå…·ä½“åè®®æ‰©å±•æ¡†æ¶è¦æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸šç•Œçš„æ€è·¯ä¸åšæ³•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åè®®æ‰©å±•æ¡†æ¶---envoy&#34;&gt;åè®®æ‰©å±•æ¡†æ¶ - Envoy&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248576-01797bba-8a94-4960-be17-1c87c725a75a.png&#34; alt=&#34;Envoy çš„åè®®æ‰©å±•&#34;&gt;
æ³¨ï¼šå›¾ç‰‡æ¥è‡ª Envoy åˆ†äº«èµ„æ–™&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªè¦ä»‹ç»çš„æ˜¯ç›®å‰å‘å±•åŠ¿å¤´å¼ºåŠ²çš„ Envoyã€‚ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒEnvoy æ”¯æŒå››å±‚çš„è¯»å†™è¿‡æ»¤å™¨æ‰©å±•ã€åŸºäº HTTP çš„ä¸ƒå±‚è¯»å†™è¿‡æ»¤å™¨æ‰©å±•ä»¥åŠå¯¹åº”çš„ Router/Upstream å®ç°ã€‚å¦‚æœæƒ³è¦åŸºäº Envoy çš„æ‰©å±•æ¡†æ¶å®ç° L7 åè®®æ¥å…¥ï¼Œç›®å‰çš„æ™®éåšæ³•æ˜¯åŸºäº L4 filter å°è£…ç›¸åº”çš„ L7 codecï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šå†å®ç°å¯¹åº”çš„åè®®è·¯ç”±ç­‰èƒ½åŠ›ï¼Œæ— æ³•å¤ç”¨ HTTP L7 çš„æ‰©å±•æ¡†æ¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åè®®æ‰©å±•æ¡†æ¶---nginx&#34;&gt;åè®®æ‰©å±•æ¡†æ¶ - Nginx&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248600-c47725ed-7d47-4c07-ad1b-f2e2ba4ea2c6.png&#34; alt=&#34;Nginx çš„åè®®æ‰©å±•&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªåˆ™æ˜¯è€ç‰Œçš„åå‘ä»£ç†è½¯ä»¶ Nginxï¼Œå…¶æ ¸å¿ƒæ¨¡å—æ˜¯åŸºäº Epoll/Kqueue ç­‰ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ä¹‹ä¸Šçš„ç¦»æ•£äº‹ä»¶æ¡†æ¶ï¼ŒåŸºäºäº‹ä»¶æ¡†æ¶ä¹‹ä¸Šæ„å»ºäº† Mailã€Http ç­‰åè®®æ¨¡å—ã€‚ä¸ Envoy ç±»ä¼¼ï¼Œå¦‚æœè¦åŸºäº Nginx æ‰©å±•ç§æœ‰åè®®ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦è‡ªè¡Œå¯¹æ¥äº‹ä»¶æ¡†æ¶ï¼Œå¹¶å®Œæ•´å®ç°åŒ…æ‹¬ç¼–è§£ç ã€åè®®å¤„ç†ç­‰èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åè®®æ‰©å±•æ¡†æ¶---mosn&#34;&gt;åè®®æ‰©å±•æ¡†æ¶ - MOSN&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248645-5d6eac2f-962e-4c3c-92f1-814d18db47cd.png&#34; alt=&#34;MOSN çš„åè®®æ‰©å±•æ¡†æ¶&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€åå›è¿‡å¤´æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ MOSN æ˜¯æ€ä¹ˆåšçš„ã€‚å®é™…ä¸Šï¼ŒMOSN çš„åº•å±‚æœºåˆ¶ä¸ Envoyã€Nginx å¹¶æ²¡æœ‰æ ¸å¿ƒå·®å¼‚ï¼ŒåŒæ ·æ”¯æŒåŸºäº I/O å¤šè·¯å¤ç”¨çš„ L4 è¯»å†™è¿‡æ»¤å™¨æ‰©å±•ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šå†å°è£… L7 çš„å¤„ç†ã€‚ä½†æ˜¯ä¸å‰ä¸¤è€…ä¸åŒçš„æ˜¯ï¼ŒMOSN é’ˆå¯¹å…¸å‹çš„å¾®æœåŠ¡é€šä¿¡åœºæ™¯ï¼ŒæŠ½è±¡å‡ºäº†ä¸€å¥—é€‚ç”¨äºåŸºäºå¤šè·¯å¤ç”¨ RPC åè®®çš„æ‰©å±•æ¡†æ¶ï¼Œå±è”½äº† MOSN å†…éƒ¨å¤æ‚çš„åè®®å¤„ç†åŠæ¡†æ¶æµç¨‹ï¼Œå¼€å‘è€…åªéœ€è¦å…³æ³¨åè®®æœ¬èº«ï¼Œå¹¶å®ç°å¯¹åº”çš„æ¡†æ¶æ¥å£èƒ½åŠ›å³å¯å®ç°å¿«é€Ÿæ¥å…¥æ‰©å±•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;ä¸‰ç§æ¡†æ¶æˆæœ¬å¯¹æ¯”&#34;&gt;ä¸‰ç§æ¡†æ¶æˆæœ¬å¯¹æ¯”&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248614-5807d3b3-fb18-4a15-83ef-e05bb162f222.png&#34; alt=&#34;ä¸‰ç§æ¡†æ¶æˆæœ¬å¯¹æ¯”&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€åå¯¹æ¯”ä¸€ä¸‹ï¼Œå…¸å‹å¾®æœåŠ¡é€šä¿¡æ¡†æ¶åè®®æ¥å…¥çš„æˆæœ¬ï¼Œç”±äº MOSN é’ˆå¯¹æ­¤ç±»åœºæ™¯è¿›è¡Œäº†æ¡†æ¶å±‚é¢çš„å°è£…æ”¯æŒï¼Œå› æ­¤å¯ä»¥èŠ‚çœå¼€å‘è€…å¤§é‡çš„ç ”å‘æˆæœ¬ã€‚&lt;/p&gt;
&lt;h2 id=&#34;sofabolt-åè®®æ¥å…¥å®è·µ&#34;&gt;SOFABolt åè®®æ¥å…¥å®è·µ&lt;/h2&gt;
&lt;p&gt;åˆæ­¥äº†è§£å¤šåè®®æ¡†æ¶çš„è®¾è®¡æ€è·¯ä¹‹åï¼Œè®©æˆ‘ä»¬ä»¥ SOFABolt åè®®ä¸ºä¾‹æ¥å®é™…ä½“éªŒä¸€ä¸‹åè®®æ¥å…¥çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;sofabolt-ç®€ä»‹&#34;&gt;SOFABolt ç®€ä»‹&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248663-0e25c95b-d711-4de2-9a42-f71d05b360df.png&#34; alt=&#34;SOFABolt ç®€ä»‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œå…ˆå¯¹ SOFABolt è¿›è¡Œä¸€ä¸ªç®€å•ä»‹ç»ï¼ŒSOFABolt æ˜¯ä¸€ä¸ªå¼€æºçš„è½»é‡ã€æ˜“ç”¨ã€é«˜æ€§èƒ½ã€æ˜“æ‰©å±•çš„  RPC é€šä¿¡æ¡†æ¶ï¼Œå¹¿æ³›åº”ç”¨äºèš‚èšé›†å›¢å†…éƒ¨ã€‚&lt;/p&gt;
&lt;p&gt;SOFABoltï¼š&lt;a href=&#34;https://github.com/sofastack/sofa-bolt&#34;&gt;https://github.com/sofastack/sofa-bolt&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åŸºäº MOSN çš„å¤šåè®®æ¡†æ¶ï¼Œå®é™…ç¼–å†™äº† 7 ä¸ªä»£ç æ–‡ä»¶ï¼Œä¸€å…± 925 è¡Œä»£ç (åŒ…æ‹¬ liscenceã€comment åœ¨å†…)å°±å®Œæˆäº†æ¥å…¥ã€‚å¦‚æœå¯¹äºåè®®æœ¬èº«è¾ƒä¸ºç†Ÿæ‚‰ï¼Œä¸”å…·å¤‡ä¸€å®šçš„ MOSN/Golang å¼€å‘ç»éªŒï¼Œç”šè‡³å¯ä»¥åœ¨ä¸€å¤©å†…å°±å®Œæˆæ•´ä¸ªåè®®çš„æ‰©å±•ï¼Œå¯ä»¥è¯´æ¥å…¥æˆæœ¬æ˜¯éå¸¸ä¹‹ä½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248669-1138c7d3-fc69-446c-99a9-65932aebca99.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Github:
&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/pkg/protocol/xprotocol/bolt&#34;&gt;https://github.com/mosn/mosn/tree/master/pkg/protocol/xprotocol/bolt&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢è®©æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œä¸€æ­¥ä¸€æ­¥äº†è§£æ¥å…¥è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;step1ç¡®è®¤åè®®æ ¼å¼&#34;&gt;Step1ï¼šç¡®è®¤åè®®æ ¼å¼&lt;/h3&gt;
&lt;p&gt;ç¬¬ä¸€æ­¥ï¼Œéœ€è¦ç¡®è®¤è¦æ¥å…¥çš„åè®®æ ¼å¼ã€‚ä¸ºä»€ä¹ˆé¦–å…ˆè¦åšè¿™ä¸ªï¼Œå› ä¸ºåè®®æ ¼å¼æ˜¯ä¸€ä¸ªåè®®æœ€åŸºæœ¬çš„éƒ¨åˆ†ï¼Œæœ‰ä»¥ä¸‹ä¸¤ä¸ªå±‚é¢çš„è€ƒè™‘ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä»»ä½•åè®®ç‰¹æ€§ä»¥åŠåè®®åŠŸèƒ½éƒ½èƒ½åœ¨ä¸Šé¢å¾—åˆ°ä¸€äº›ä½“ç°ï¼Œä¾‹å¦‚æœ‰æ—  requestId/streamId å°±ç›´æ¥å…³è”åˆ°åè®®æ˜¯å¦æ”¯æŒè¿æ¥å¤šè·¯å¤ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;åè®®æ ¼å¼ä¸æŠ¥æ–‡æ¨¡å‹ç›´æ¥ç›¸å…³ï¼Œä¸¤è€…å¯ä»¥æ„æˆé€»è¾‘ä¸Šçš„æ˜ å°„å…³ç³»ï¼›è€Œè¿™ä¸ªæ˜ å°„å…³ç³»ä¹Ÿå°±æ˜¯æ‰€è°“çš„ç¼–è§£ç é€»è¾‘ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;1585209248674-536ba7de-4f23-4797-a3db-cc085ec8a620.png&#34; alt=&#34;ç¡®è®¤åè®®æ ¼å¼&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä»¥ SOFABolt ä¸ºä¾‹ï¼Œå…¶ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯åè®® magicï¼Œå¯ä»¥ç”¨äºæ ¡éªŒå½“å‰æŠ¥æ–‡æ˜¯å¦å±äº SOFABolt åè®®ï¼Œå¹¶å¯ä»¥ç”¨äºåè®®è‡ªåŠ¨è¯†åˆ«åŒ¹é…çš„åœºæ™¯ï¼›ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯ typeï¼Œç”¨äºæ ‡è¯†å½“å‰æŠ¥æ–‡çš„ä¼ è¾“ç±»å‹ï¼Œå¯ä»¥æ˜¯ Request / RequestOneway / Response ä¸­çš„ä¸€ç§ï¼›ç¬¬ä¸‰ä¸ªå­—èŠ‚åˆ™æ˜¯å½“å‰æŠ¥æ–‡çš„ä¸šåŠ¡ç±»å‹ï¼Œå¯ä»¥æ˜¯å¿ƒè·³å¸§ï¼ŒRPC è¯·æ±‚/å“åº”ç­‰ç±»å‹ã€‚åé¢çš„å­—æ®µå°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œå¯ä»¥å‘ç°ï¼Œ**ç†è§£äº†åè®®æ ¼å¼æœ¬èº«ï¼Œå…¶å®å¯¹äºåè®®çš„ç‰¹æ€§æ”¯æŒå’Œæ¨¡å‹ç¼–è§£ç å°±ç†è§£äº†ä¸€å¤§åŠï¼Œ**å› æ­¤ç¬¬ä¸€æ­¥åè®®æ ¼å¼çš„ç¡®è®¤äº†è§£æ˜¯é‡ä¸­ä¹‹é‡ï¼Œæ˜¯åç»­ä¸€åˆ‡å·¥ä½œå¼€å±•çš„å‰æã€‚&lt;/p&gt;
&lt;h3 id=&#34;step2ç¡®è®¤æŠ¥æ–‡æ¨¡å‹&#34;&gt;Step2ï¼šç¡®è®¤æŠ¥æ–‡æ¨¡å‹&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248773-66c3234b-f805-4735-9e70-acf8abef294b.png&#34; alt=&#34;ç¡®è®¤æŠ¥æ–‡æ¨¡å‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;é¡ºåº”ç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥çš„ä¸»è¦å·¥ä½œæ˜¯ç¡®è®¤æŠ¥æ–‡ç¼–ç¨‹æ¨¡å‹ã€‚ä¸€èˆ¬åœ°ï¼Œåœ¨ç¬¬ä¸€æ­¥å®Œæˆä¹‹åï¼Œåº”å½“å¯ä»¥å¾ˆé¡ºåˆ©çš„æ„å»ºå‡ºç›¸åº”çš„æŠ¥æ–‡æ¨¡å‹ï¼ŒSOFABolt ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¨¡å‹å­—æ®µè®¾è®¡åŸºæœ¬ä¸åè®®æ ¼å¼ä¸­çš„ header / payload ä¸¤éƒ¨åˆ†ç›¸å¯¹åº”ã€‚æœ‰äº†ç¼–ç¨‹æ¨¡å‹ä¹‹åï¼Œå°±å¯ä»¥ç»§ç»­è¿›è¡Œä¸‹ä¸€æ­¥â€”â€”åŸºäºæ¨¡å‹å®ç°å¯¹åº”çš„æ¡†æ¶æ‰©å±•äº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;step3æ¥å£å®ç°---åè®®&#34;&gt;Step3ï¼šæ¥å£å®ç° - åè®®&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248724-28eaa458-a928-4f19-bf16-96895808a5b8.png&#34; alt=&#34;æ¥å£å®ç°-åè®®&#34;&gt;&lt;/p&gt;
&lt;p&gt;åè®®æ‰©å±•ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åè®®å±‚é¢çš„æ‰©å±•ï¼Œæè¿°çš„æ˜¯åè®®è‡ªèº«çš„è¡Œä¸ºï¼ˆåŒºåˆ«äºæŠ¥æ–‡è‡ªèº«ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰å¤šåè®®æ¡†æ¶æä¾›çš„æ¥å£åŒ…æ‹¬ä»¥ä¸‹äº”ä¸ªï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Nameï¼šåè®®åç§°ï¼Œéœ€è¦å…·å¤‡å”¯ä¸€æ€§ï¼›&lt;/li&gt;
&lt;li&gt;Encoderï¼šç¼–ç å™¨ï¼Œç”¨äºå®ç°ä»æŠ¥æ–‡æ¨¡å‹åˆ°åè®®ä¼ è¾“å­—èŠ‚æµçš„æ˜ å°„è½¬æ¢ï¼›&lt;/li&gt;
&lt;li&gt;Decoderï¼šè§£ç å™¨ï¼Œç”¨äºå®ç°ä»åè®®ä¼ è¾“å­—èŠ‚æµåˆ°æŠ¥æ–‡æ¨¡å‹çš„æ˜ å°„è½¬æ¢ï¼›&lt;/li&gt;
&lt;li&gt;Heartbeaterï¼šå¿ƒè·³å¤„ç†ï¼Œç”¨äºå®ç°å¿ƒè·³ä¿æ´»æŠ¥æ–‡çš„æ„é€ ï¼ŒåŒ…æ‹¬æ¢æµ‹å‘èµ·ä¸å›å¤ä¸¤ä¸ªåœºæ™¯ï¼›&lt;/li&gt;
&lt;li&gt;Hijackerï¼šé”™è¯¯åŠ«æŒï¼Œç”¨äºåœ¨ç‰¹å®šé”™è¯¯åœºæ™¯ä¸‹é”™è¯¯æŠ¥æ–‡çš„æ„é€ ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;step4æ¥å£å®ç°---æŠ¥æ–‡&#34;&gt;Step4ï¼šæ¥å£å®ç° - æŠ¥æ–‡&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248793-9cb8efd3-c12e-4da1-91f9-0901bcf36e16.png&#34; alt=&#34;æ¥å£å®ç°-æŠ¥æ–‡&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‰é¢ä»‹ç»äº†åè®®æ‰©å±•ï¼Œæ¥ä¸‹é‡Œåˆ™æ˜¯æŠ¥æ–‡æ‰©å±•ï¼Œè¿™é‡Œå…³æ³¨çš„æ˜¯å•ä¸ªè¯·æ±‚æŠ¥æ–‡éœ€è¦å®ç°çš„è¡Œä¸ºã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰æ¡†æ¶æŠ½è±¡çš„æ¥å£åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Basicï¼šéœ€è¦æä¾› GetStreamTypeã€GetHeaderã€GetBody å‡ ä¸ªåŸºç¡€æ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº”ä¼ è¾“ç±»å‹ã€å¤´éƒ¨ä¿¡æ¯ã€è½½è·ä¿¡æ¯ï¼›&lt;/li&gt;
&lt;li&gt;Multiplexingï¼šå¤šè·¯å¤ç”¨èƒ½åŠ›ï¼Œéœ€è¦å®ç° GetRequestId åŠ SetRequestIdï¼›&lt;/li&gt;
&lt;li&gt;HeartbeatPredicateï¼šç”¨äºåˆ¤æ–­å½“å‰æŠ¥æ–‡æ˜¯å¦ä¸ºå¿ƒè·³å¸§ï¼›&lt;/li&gt;
&lt;li&gt;GoAwayPredicateï¼šç”¨äºåˆ¤æ–­å½“å‰æŠ¥æ–‡æ˜¯å¦ä¸ºä¼˜é›…é€€å‡ºå¸§ï¼›&lt;/li&gt;
&lt;li&gt;ServiceAwareï¼šç”¨äºä»æŠ¥æ–‡ä¸­è·å– serviceã€method ç­‰æœåŠ¡ä¿¡æ¯ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;ä¸¾ä¸ªä¾‹å­&#34;&gt;ä¸¾ä¸ªä¾‹å­&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248756-4c3fce60-436b-4153-9372-b39fe80fc975.png&#34; alt=&#34;æ¡ˆä¾‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¥è®©å¤§å®¶å¯¹&lt;strong&gt;æ¡†æ¶å¦‚ä½•åŸºäºæ¥å£å°è£…å¤„ç†æµç¨‹&lt;/strong&gt;æœ‰ä¸€ä¸ªä½“æ„Ÿï¼šæœåŠ¡ç«¯å¿ƒè·³å¤„ç†åœºæ™¯ã€‚å½“æ¡†æ¶æ”¶åˆ°ä¸€ä¸ªæŠ¥æ–‡ä¹‹åï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ ¹æ®æŠ¥æ–‡æ‰©å±•ä¸­çš„ GetStreamType æ¥ç¡®å®šå½“å‰æŠ¥æ–‡æ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ã€‚å¦‚æœæ˜¯è¯·æ±‚åˆ™ç»§ç»­ 2ï¼›&lt;/li&gt;
&lt;li&gt;æ ¹æ®æŠ¥æ–‡æ‰©å±•ä¸­çš„ HeartbeatPredicate æ¥åˆ¤æ–­å½“å‰æŠ¥æ–‡æ˜¯å¦ä¸ºå¿ƒè·³åŒ…ï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­ 3ï¼›&lt;/li&gt;
&lt;li&gt;å½“å‰æŠ¥æ–‡æ˜¯å¿ƒè·³æ¢æµ‹(request + heartbeat)ï¼Œéœ€è¦å›å¤å¿ƒè·³å“åº”ï¼Œæ­¤æ—¶æ ¹æ®åè®®æ‰©å±•ä¸­çš„ Heartbeater.Reply æ–¹æ³•æ„é€ å¯¹åº”çš„å¿ƒè·³å“åº”æŠ¥æ–‡ï¼›&lt;/li&gt;
&lt;li&gt;å†æ ¹æ®åè®®æ‰©å±•çš„ Encoder å®ç°ï¼Œå°†å¿ƒè·³å“åº”æŠ¥æ–‡è½¬æ¢ä¸ºä¼ è¾“å­—èŠ‚æµï¼›&lt;/li&gt;
&lt;li&gt;æœ€åè°ƒç”¨ MOSN ç½‘ç»œå±‚æ¥å£ï¼Œå°†ä¼ è¾“å­—èŠ‚æµå›å¤ç»™å‘èµ·å¿ƒè·³æ¢æµ‹çš„å®¢æˆ·ç«¯ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“åè®®æ‰©å±•ä¸æŠ¥æ–‡æ‰©å±•éƒ½å®ç°ä¹‹åï¼ŒMOSN åè®®æ‰©å±•æ¥å…¥ä¹Ÿå°±å®Œæˆäº†ï¼Œæ¡†æ¶å¯ä»¥ä¾æ®åè®®æ‰©å±•çš„å®ç°æ¥å®Œæˆåè®®çš„å¤„ç†ï¼Œè®©æˆ‘ä»¬å®é™…æ¼”ç¤ºä¸€ä¸‹ SOFABolt æ¥å…¥çš„ exampleã€‚&lt;/p&gt;
&lt;p&gt;Demo åœ°å€ï¼š&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/codes/sofarpc-with-xprotocol-sample&#34;&gt;https://github.com/mosn/mosn/tree/master/examples/codes/sofarpc-with-xprotocol-sample&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;mosn-å¤šåè®®æœºåˆ¶è®¾è®¡è§£è¯»&#34;&gt;MOSN å¤šåè®®æœºåˆ¶è®¾è®¡è§£è¯»&lt;/h2&gt;
&lt;p&gt;é€šè¿‡ SOFABolt åè®®æ¥å…¥çš„å®è·µè¿‡ç¨‹ï¼Œå¤§å®¶å¯¹å¦‚ä½•åŸºäº MOSN æ¥åšåè®®æ‰©å±•åº”è¯¥æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤çŸ¥ã€‚é‚£ä¹ˆ MOSN å¤šåè®®æœºåˆ¶ç©¶ç«Ÿå°è£…äº†å“ªäº›é€»è¾‘ï¼ŒèƒŒååˆæ˜¯å¦‚ä½•æ€è€ƒè®¾è®¡çš„ï¼Ÿæ¥ä¸‹æ¥å°†ä¼šæŒ‘é€‰å‡ ä¸ªå…¸å‹æŠ€æœ¯æ¡ˆä¾‹ä¸ºå¤§å®¶è¿›è¡Œè§£è¯»ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åè®®æ‰©å±•æ¡†æ¶&#34;&gt;åè®®æ‰©å±•æ¡†æ¶&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;åè®®æ‰©å±•æ¡†æ¶ -  ç¼–è§£ç &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585227625966-1b00d83d-fff1-40f1-b6b1-3bda19db0afb.png&#34; alt=&#34;åè®®æ‰©å±•æ¡†æ¶-ç¼–è§£ç &#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€å…ˆä»‹ç»çš„æ˜¯ç¼–è§£ç æœºåˆ¶ï¼Œè¿™ä¸ªåœ¨å‰é¢ SOFABolt æ¥å…¥å®è·µä¸­å·²ç»ç®€å•ä»‹ç»è¿‡ï¼ŒMOSN å®šä¹‰äº†ç¼–ç å™¨åŠè§£ç å™¨æ¥å£æ¥å±è”½ä¸åŒåè®®çš„ç¼–è§£ç ç»†èŠ‚ã€‚åè®®æ¥å…¥æ—¶åªéœ€è¦å®ç°ç¼–è§£ç æ¥å£ï¼Œè€Œä¸ç”¨å…³å¿ƒç›¸åº”çš„æ¥å£è°ƒç”¨ä¸Šä¸‹æ–‡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åè®®æ‰©å±•æ¡†æ¶ - å¤šè·¯å¤ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248762-c83706cd-b413-468c-80b1-151de9ae8f3c.png&#34; alt=&#34;åè®®æ‰©å±•çœ‹æ¡†æ¶-å¤šè·¯å¤ç”¨&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥æ˜¯å¤šè·¯å¤ç”¨æœºåˆ¶çš„è§£è¯»ï¼Œè¿™ä¹Ÿæ˜¯æµç¨‹ä¸­ç›¸å¯¹ä¸å¤ªå¥½ç†è§£çš„ä¸€éƒ¨åˆ†ã€‚é¦–å…ˆæ˜ç¡®ä¸€ä¸‹é“¾æ¥å¤šè·¯å¤ç”¨çš„å®šä¹‰ï¼šå…è®¸åœ¨å•æ¡é“¾æ¥ä¸Šï¼Œå¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚/å“åº”ã€‚é‚£ä¹ˆæ”¯æŒå¤šè·¯å¤ç”¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ä»¥ HTTP åè®®æ¼”è¿›ä¸ºä¾‹ï¼ŒHTTP/1 è™½ç„¶å¯ä»¥ç»´æŒé•¿è¿æ¥ï¼Œä½†æ˜¯å•æ¡é“¾æ¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚/ç›¸åº”ï¼Œè¿™æ„å‘³ç€å¦‚æœåŒæ—¶æ”¶åˆ°äº† 4 ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆéœ€è¦å»ºç«‹å››æ¡ TCP é“¾æ¥ï¼Œè€Œå»ºé“¾çš„æˆæœ¬ç›¸å¯¹æ¥è¯´æ¯”è¾ƒé«˜æ˜‚ï¼›HTTP/2 å¼•å…¥äº† stream/frame çš„æ¦‚å¿µï¼Œæ”¯æŒäº†åˆ†å¸§å¤šè·¯å¤ç”¨èƒ½åŠ›ï¼Œåœ¨é€»è¾‘ä¸Šå¯ä»¥åŒºåˆ†å‡ºæˆå¯¹çš„è¯·æ±‚ stream å’Œå“åº” streamï¼Œä»è€Œå¯ä»¥åœ¨å•æ¡é“¾æ¥ä¸Šå¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚/å“åº”ï¼Œè§£å†³äº† HTTP/1 é“¾æ¥æ•°ä¸å¹¶å‘æ•°æˆæ­£æ¯”çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ç±»ä¼¼çš„ï¼Œå…¸å‹çš„å¾®æœåŠ¡æ¡†æ¶é€šä¿¡åè®®ï¼Œå¦‚ Dubboã€SOFABolt ç­‰ä¸€èˆ¬ä¹Ÿéƒ½å®ç°äº†é“¾æ¥å¤šè·¯å¤ç”¨èƒ½åŠ›ï¼Œå› æ­¤ MOSN å°è£…äº†ç›¸åº”çš„å¤šè·¯å¤ç”¨å¤„ç†æµç¨‹ï¼Œæ¥ç®€åŒ–åè®®æ¥å…¥çš„æˆæœ¬ã€‚è®©æˆ‘ä»¬è·Ÿéšä¸€ä¸ªè¯·æ±‚ä»£ç†çš„è¿‡ç¨‹ï¼Œæ¥è¿›ä¸€æ­¥äº†è§£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248791-900751cb-c096-48d4-a5d5-d8247ef9d725.png&#34; alt=&#34;ä¸Šä¸‹æ¸¸å…³è”æ˜ å°„&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MOSN ä» downstream(conn=2) æ¥æ”¶äº†ä¸€ä¸ªè¯·æ±‚ requestï¼Œä¾æ®æŠ¥æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ GetRequestId è·å–åˆ°è¯·æ±‚åœ¨è¿™æ¡è¿æ¥ä¸Šçš„èº«ä»½æ ‡è¯†(requestId=1)ï¼Œå¹¶è®°å½•åˆ°å…³è”æ˜ å°„ä¸­å¾…ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;è¯·æ±‚ç»è¿‡ MOSN çš„è·¯ç”±ã€è´Ÿè½½å‡è¡¡å¤„ç†ï¼Œé€‰æ‹©äº†ä¸€ä¸ª upstream(conn=5)ï¼ŒåŒæ—¶åœ¨è¿™æ¡é“¾æ¥ä¸Šæ–°å»ºäº†ä¸€ä¸ªè¯·æ±‚æµ(requestId=30)ï¼Œå¹¶è°ƒç”¨æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ SetRequestId å°è£…æ–°çš„èº«ä»½æ ‡è¯†ï¼Œå¹¶è®°å½•åˆ°å…³è”æ˜ å°„ä¸­ä¸ downstream ä¿¡æ¯ç»„åˆï¼›&lt;/li&gt;
&lt;li&gt;MOSN ä» upstream(conn=5) æ¥æ”¶äº†ä¸€ä¸ªå“åº” responseï¼Œä¾æ®æŠ¥æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ GetRequestId è·å–åˆ°è¯·æ±‚åœ¨è¿™æ¡è¿æ¥ä¸Šçš„èº«ä»½æ ‡è¯†(requestId=30)ã€‚æ­¤æ—¶å¯ä»¥ä»ä¸Šä¸‹æ¸¸å…³è”æ˜ å°„è¡¨ä¸­ï¼Œæ ¹æ® upstream ä¿¡æ¯(connId=5, requestId=30) æ‰¾åˆ°å¯¹åº”çš„ downstream ä¿¡æ¯(connId=2, requestId=1)ï¼›&lt;/li&gt;
&lt;li&gt;ä¾æ® downstream request çš„ä¿¡æ¯ï¼Œè°ƒç”¨æ–‡æ‰©å±•å¤šè·¯å¤ç”¨æ¥å£ SetRequestId è®¾ç½®å“åº”çš„ requestIdï¼Œå¹¶å›å¤ç»™ downstreamï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¡†æ¶æµç¨‹ä¾èµ–çš„æŠ¥æ–‡æ‰©å±• Multiplexing æ¥å£æä¾›çš„èƒ½åŠ›ï¼Œå®ç°äº†ä¸Šä¸‹æ¸¸è¯·æ±‚çš„å¤šè·¯å¤ç”¨å…³è”å¤„ç†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæ¡†æ¶è¿˜å°è£…äº†å¾ˆå¤šç»†èŠ‚çš„å¤„ç†ï¼Œä¾‹å¦‚ä¸Šä¸‹æ¸¸å¤ç”¨å†…å­˜å—åˆå¹¶å¤„ç†ç­‰ç­‰ï¼Œæ­¤å¤„é™äºç¯‡å¹…ä¸å†å±•å¼€ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæºç è¿›è¡Œé˜…è¯»ã€‚&lt;/p&gt;
&lt;h3 id=&#34;ç»Ÿä¸€è·¯ç”±æ¡†æ¶&#34;&gt;ç»Ÿä¸€è·¯ç”±æ¡†æ¶&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248786-ff9c157a-5ff9-444b-8b0f-2da90ddb8392.png&#34; alt=&#34;ç»Ÿä¸€è·¯ç”±æ¡†æ¶&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥è¦åˆ†æçš„æ˜¯ã€Œç»Ÿä¸€è·¯ç”±æ¡†æ¶ã€çš„è®¾è®¡ï¼Œæ­¤æ–¹æ¡ˆä¸»è¦è§£å†³çš„æ˜¯é HTTP åè®®çš„è·¯ç”±é€‚é…é—®é¢˜ã€‚æˆ‘ä»¬é€‰å–äº†ä»¥ä¸‹ä¸‰ç‚¹è¿›è¡Œå…·ä½“åˆ†æï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡åŸºäºå±æ€§åŒ¹é…(attribute-based)çš„æ¨¡å¼ï¼Œä¸å…·ä½“åè®®å­—æ®µè§£è€¦ï¼›&lt;/li&gt;
&lt;li&gt;å¼•å…¥å±‚çº§è·¯ç”±çš„æ¦‚å¿µï¼Œè§£å†³å±æ€§æ‰å¹³åŒ–åå¸¦æ¥çš„çº¿æ€§åŒ¹é…æ€§èƒ½é—®é¢˜ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡å˜é‡æœºåˆ¶æ‡’åŠ è½½çš„ç‰¹å®šï¼ŒæŒ‰éœ€å®ç°æ·±/æµ…è§£åŒ…ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç»Ÿä¸€è·¯ç”±æ¡†æ¶ â€“ åŸºäºå±æ€§åŒ¹é…&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248809-fe944cba-e8df-4497-8eff-c8d47131c918.png&#34; alt=&#34;ç»Ÿä¸€è·¯ç”±æ¡†æ¶-åŸºäºå±æ€§åŒ¹é…&#34;&gt;&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å…¸å‹çš„ RDS é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„ domainsã€path ç­‰å­—æ®µï¼Œå¯¹åº”çš„æ˜¯ HTTP åè®®é‡Œçš„åŸŸåã€è·¯å¾„æ¦‚å¿µï¼Œè¿™å°±æ„å‘³ç€å…¶åŒ¹é…æ¡ä»¶åªæœ‰ HTTP åè®®æ‰æœ‰å­—æ®µèƒ½å¤Ÿæ»¡è¶³ï¼Œé…ç½®ç»“æ„è®¾è®¡æ˜¯ä¸ HTTP åè®®å¼ºç›¸å…³çš„ã€‚è¿™å°±å¯¼è‡´äº†å¦‚æœæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªç§æœ‰åè®®ï¼Œæ— æ³•å¤ç”¨ RDS çš„é…ç½®æ¥åšè·¯ç”±ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆå¦‚ä½•è§£å†³é…ç½®æ¨¡å‹ä¸åè®®å­—æ®µå¼ºè€¦åˆå‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯æŠŠåŒ¹é…å­—æ®µæ‹†åˆ†ä¸ºæ‰å¹³å±æ€§çš„é”®å€¼å¯¹(key-value pair)ï¼ŒåŒ¹é…ç­–ç•¥åŸºäºé”®å€¼å¯¹æ¥å¤„ç†ï¼Œä»è€Œè§£é™¤äº†åŒ¹é…æ¨¡å‹ä¸åè®®å­—æ®µçš„å¼ºè€¦åˆï¼Œä¾‹å¦‚å¯ä»¥é…ç½® &lt;code&gt;key: $http_host&lt;/code&gt;ï¼Œä¹Ÿå¯ä»¥é…ç½® &lt;code&gt;key:$dubbo_service&lt;/code&gt;ï¼Œè¿™åœ¨é…ç½®æ¨¡å‹å±‚é¢éƒ½æ˜¯åˆæ³•çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿™å¹¶ä¸æ˜¯è¯´åŒ¹é…å°±æœ‰å…·ä½“åè®®æ— å…³äº†ï¼Œè¿™ä¸ªå…³è”ä»ç„¶æ˜¯å­˜åœ¨çš„ï¼Œåªæ˜¯ä»å¼ºè€¦åˆè½¬æ¢ä¸ºäº†éšå¼å…³è”ï¼Œä¾‹å¦‚é…ç½® &lt;code&gt;key: $http_host&lt;/code&gt;ï¼Œä»ç»“æ„æ¥è¯´å…¶ä¸ HTTP åè®®å¹¶æ— è€¦åˆï¼Œä½†æ˜¯å€¼å˜é‡ä»ç„¶ä¼šé€šè¿‡ HTTP åè®®å­—æ®µæ¥è¿›è¡Œæ±‚å€¼ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç»Ÿä¸€è·¯ç”±æ¡†æ¶ -  å±‚çº§è·¯ç”±&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248832-20483dc3-e959-4cf4-aecd-cbe5ba37b4fb.png&#34; alt=&#34;ç»Ÿä¸€è·¯ç”±æ¡†æ¶ -  å±‚çº§è·¯ç”±&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨å¼•å…¥ã€ŒåŸºäºå±æ€§çš„åŒ¹é…ã€ä¹‹åï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ç”±äºå±æ€§æœ¬èº«çš„æ‰å¹³åŒ–ï¼Œå…¶å†…åœ¨å¹¶ä¸åŒ…å«å±‚çº§å…³ç³»ã€‚å¦‚æœæ²¡æœ‰å±‚çº§å…³ç³»ï¼Œä¼šå¯¼è‡´åŒ¹é…æ—¶éœ€è¦éå†æ‰€æœ‰å¯èƒ½çš„æƒ…å†µç»„åˆï¼Œå¤§é‡æ¡ä»¶çš„åœºæ™¯ä¸‹åŒ¹é…æ€§èƒ½è¿‘ä¼¼äºçº¿æ€§çš„ O(n)ï¼Œè¿™æ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äº HTTP åè®®ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¹ æƒ¯ä¸ä»¥ä¸‹çš„åŒ¹é…æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŒ¹é… Host(:authority) ï¼›&lt;/li&gt;
&lt;li&gt;åŒ¹é… Path ï¼›&lt;/li&gt;
&lt;li&gt;åŒ¹é… headers/args/cookies ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™å…¶å®æ„æˆäº†ä¸€ä¸ªå±‚çº§å…³ç³»ï¼Œæ¯ä¸€å±‚å°±åƒæ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œé€šè¿‡å±‚çº§çš„ç´¢å¼•å…³ç³»ï¼Œåœ¨å¤§é‡åŒ¹é…æ¡ä»¶çš„æƒ…å†µä¸‹ä»ç„¶å¯ä»¥è·å¾—ä¸€ä¸ªå¯æ¥å—çš„è€—æ—¶æˆæœ¬ã€‚ä½†æ˜¯å¯¹äºå±æ€§(attribute)ï¼Œå¤šä¸ªå±æ€§ä¹‹é—´å¹¶æ²¡æœ‰å¤©ç„¶çš„å±‚çº§å…³ç³»(ç›¸æ¯”äº hostã€path è¿™ç§å­—æ®µ)ï¼Œè¿™ä¾èµ–äºå±æ€§èƒŒåæ‰€éšå¼å…³è”çš„å­—æ®µï¼Œä¾‹å¦‚å¯¹äº Dubbo åè®®ï¼Œæˆ‘ä»¬å¸Œæœ›çš„é¡ºåºå¯èƒ½æ˜¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŒ¹é… &lt;code&gt;$dubbo_service&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;åŒ¹é… &lt;code&gt;$dubbo_group&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;åŒ¹é… &lt;code&gt;$dubbo_version&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;åŒ¹é… &lt;code&gt;$dubbo_attachments_xx&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› æ­¤åœ¨é…ç½®æ¨¡å‹ä¸Šï¼Œæˆ‘ä»¬å¼•å…¥äº†å¯¹åº”çš„ç´¢å¼•å±‚çº§æ¦‚å¿µï¼Œç”¨äºé€‚é…ä¸åŒåè®®çš„ç»“æ„åŒ–å±‚çº§è·¯ç”±ï¼Œè§£å†³æ‰å¹³å±æ€§çš„çº¿æ€§åŒ¹é…æ€§èƒ½é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç»Ÿä¸€è·¯ç”±æ¡†æ¶ - æµ…è§£åŒ…ä¼˜åŒ–&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;1585209248848-77a91fc3-ab6c-4eb8-a62b-3496668d66c3.png&#34; alt=&#34;ç»Ÿä¸€è·¯ç”±æ¡†æ¶ - æµ…è§£åŒ…ä¼˜åŒ–&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œä»‹ç»ä¸€ä¸‹æµ…è§£åŒ…ä¼˜åŒ–çš„æœºåˆ¶ã€‚åˆ©ç”¨ MOSN å˜é‡æ‡’åŠ è½½çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŠ¥æ–‡è§£ææ—¶ï¼Œå…ˆä¸å»è§£ææˆæœ¬è¾ƒé«˜çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ dubbo åè®®çš„ attachmentsã€‚é‚£ä¹ˆåœ¨ä»£ç†è¯·æ±‚çš„å®é™…è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä½¿ç”¨åˆ° attachments é‡Œçš„ä¿¡æ¯æ—¶ï¼Œå°±ä¼šé€šè¿‡å˜é‡çš„ getter æ±‚å€¼é€»è¾‘æ¥è¿›è¡ŒçœŸæ­£çš„è§£åŒ…æ“ä½œã€‚ä¾é æ­¤ç‰¹æ€§ï¼Œå¯ä»¥å¤§å¹…ä¼˜åŒ–åœ¨ä¸éœ€è¦æ·±è§£åŒ…çš„åœºæ™¯ä¸‹ dubbo åè®®ä»£ç†è½¬å‘çš„æ€§èƒ½è¡¨ç°ï¼Œå®ç°æŒ‰éœ€è§£åŒ…ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è§£è¯»æ€»ç»“&#34;&gt;è§£è¯»æ€»ç»“&lt;/h3&gt;
&lt;p&gt;æœ€åï¼Œå¯¹è®¾è®¡éƒ¨åˆ†çš„å‡ ä¸ªæŠ€æœ¯æ¡ˆä¾‹ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œæ•´ä½“çš„æ€è·¯ä»ç„¶æ˜¯å¯¹å¤„ç†æµç¨‹è¿›è¡ŒæŠ½è±¡å°è£…ï¼Œå¹¶å‰¥ç¦»å¯æ‰©å±•ç‚¹ï¼Œä»è€Œé™ä½ç”¨æˆ·çš„æ¥å…¥æˆæœ¬ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨åè®®æ‰©å±•æ”¯æŒæ–¹é¢ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°è£…ç¼–è§£ç æµç¨‹ï¼ŒæŠ½è±¡ç¼–è§£ç èƒ½åŠ›æ¥å£ä½œä¸ºåè®®æ‰©å±•ç‚¹&lt;/li&gt;
&lt;li&gt;å°è£…åè®®å¤„ç†æµç¨‹ï¼ŒæŠ½è±¡å¤šè·¯å¤ç”¨ã€å¿ƒè·³ä¿æ´»ã€ä¼˜é›…é€€å‡ºç­‰èƒ½åŠ›æ¥å£ä½œä¸ºåè®®æ‰©å±•ç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨è·¯ç”±æ¡†æ¶æ–¹é¢ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡æ”¹ä¸ºåŸºäºå±æ€§åŒ¹é…çš„æœºåˆ¶ï¼Œä¸å…·ä½“åè®®å­—æ®µè§£è€¦ï¼Œæ”¯æŒå¤šåè®®é€‚é…ï¼›&lt;/li&gt;
&lt;li&gt;å¼•å…¥å±‚çº§è·¯ç”±æœºåˆ¶ï¼Œè§£å†³å±æ€§æ‰å¹³åŒ–çš„åŒ¹é…æ€§èƒ½é—®é¢˜ï¼›&lt;/li&gt;
&lt;li&gt;åˆ©ç”¨å˜é‡æœºåˆ¶æ‡’åŠ è½½ç‰¹æ€§ï¼ŒæŒ‰éœ€å®ç°æ·±/æµ…è§£åŒ…ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;åç»­è§„åˆ’åŠå±•æœ›&#34;&gt;åç»­è§„åˆ’åŠå±•æœ›&lt;/h2&gt;
&lt;h3 id=&#34;æ›´å¤šæµæ¨¡å¼æ”¯æŒæ›´å¤šåè®®æ¥å…¥&#34;&gt;æ›´å¤šæµæ¨¡å¼æ”¯æŒã€æ›´å¤šåè®®æ¥å…¥&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248869-cc2b0d96-1e9c-4e77-8047-d2022dd3dac0.png&#34; alt=&#34;æ›´å¤šæµæ¨¡å¼æ”¯æŒã€æ›´å¤šåè®®æ¥å…¥&#34;&gt;&lt;/p&gt;
&lt;p&gt;å½“å‰ MOSN å¤šåè®®æœºåˆ¶ï¼Œå·²ç»å¯ä»¥æ¯”è¾ƒå¥½çš„æ”¯æŒåƒ Dubboã€SOFABolt è¿™æ ·åŸºäºå¤šè·¯å¤ç”¨æµæ¨¡å‹çš„å¾®æœåŠ¡åè®®ï¼Œåç»­ä¼šç»§ç»­æ‰©å±•æ”¯æŒçš„ç±»å‹åŠåè®®ï¼Œä¾‹å¦‚ç»å…¸çš„ PING-PONG åè®®ã€Streaming æµå¼åè®®ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ä¸€èµ·å‚ä¸ç¤¾åŒºå»ºè®¾ï¼Œè´¡çŒ®ä½ çš„ PRã€‚&lt;/p&gt;
&lt;h3 id=&#34;ç¤¾åŒºæ ‡å‡†æ–¹æ¡ˆæ¨è¿›&#34;&gt;ç¤¾åŒºæ ‡å‡†æ–¹æ¡ˆæ¨è¿›&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;1585209248892-b736ba21-4a23-4f8b-9ba0-7623f7125e72.png&#34; alt=&#34;ç¤¾åŒºæ ‡å‡†æ–¹æ¡ˆæ¨è¿›&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ° Istio ç¤¾åŒºå…¶å®ä¹Ÿæœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œå¸Œæœ›è®¾è®¡ä¸€å¥—åè®®æ— å…³çš„è·¯ç”±æœºåˆ¶â€”â€”&amp;ldquo;Istio Meta Routing API&amp;rdquo;ã€‚å…¶æ ¸å¿ƒæ€è·¯ä¸ MOSN çš„å¤šåè®®è·¯ç”±æ¡†æ¶åŸºæœ¬ä¸€è‡´ï¼Œå³é€šè¿‡åŸºäºå±æ€§çš„è·¯ç”±æ¥æ›¿ä»£åŸºäºåè®®å­—æ®µçš„è·¯ç”±ã€‚ç›®å‰è¯¥è‰æ¡ˆè¿˜å¤„äºä¸€ä¸ªæ¯”è¾ƒåˆçº§çš„é˜¶æ®µï¼Œå¯¹äºåŒ¹é…æ€§èƒ½ã€å­—æ®µæ‰©å±•æ–¹é¢è¿˜æ²¡æœ‰æ¯”è¾ƒå®Œå–„çš„è®¾è®¡è¯´æ˜ï¼Œåç»­ MOSN å›¢é˜Ÿä¼šç§¯æå‚ä¸ç¤¾åŒºæ–¹æ¡ˆçš„è®¨è®ºï¼Œè¿›ä¸€æ­¥æ¨åŠ¨ç¤¾åŒºæ ‡å‡†æ–¹æ¡ˆçš„è½åœ°ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸Šå°±æ˜¯æœ¬æœŸåˆ†äº«çš„å…¨éƒ¨å†…å®¹ï¼Œå¦‚æœå¤§å®¶å¯¹ MOSN æœ‰é—®é¢˜ä»¥åŠå»ºè®®ï¼Œæ¬¢è¿åŠ å…¥ &lt;a href=&#34;https://mosn.io/docs/community/&#34;&gt;MOSN ç¤¾åŒº&lt;/a&gt;ä¸æˆ‘ä»¬äº¤æµã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - HTTP ç³»èƒ½åŠ›</title>
      <link>https://mosn.io/blog/code/mosn-http/</link>
      <pubDate>Sat, 07 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-http/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„ç›®çš„æ˜¯åˆ†æ MOSN æºç ä¸­çš„ HTTP ç³»èƒ½åŠ›ï¼Œå†…å®¹åŸºäº MOSN 0.9.0&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚è¿°&#34;&gt;æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;HTTP æ˜¯äº’è”ç½‘ç•Œæœ€å¸¸ç”¨çš„ä¸€ç§åè®®ä¹‹ä¸€ï¼ŒMOSN ä¹Ÿæä¾›äº†å¯¹å…¶å¼ºå¤§çš„æ”¯æŒã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-http-æŠ¥æ–‡ç»„æˆ&#34;&gt;MOSN HTTP æŠ¥æ–‡ç»„æˆ&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;message.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯&lt;a href=&#34;https://book.douban.com/subject/25863515/&#34;&gt;å›¾è§£ HTTP&lt;/a&gt; ä¸­å…³äº HTTP æŠ¥æ–‡æŠ¥æ–‡çš„ä»‹ç»ã€‚MOSN å¯¹äº HTTP æŠ¥æ–‡çš„å¤„ç†å¹¶æ²¡æœ‰ä½¿ç”¨go å®˜ç½‘ &lt;code&gt;net/http&lt;/code&gt;ä¸­çš„ç»“æ„ä¹Ÿæ²¡æœ‰ç‹¬ç«‹è®¾è®¡ä¸€å¥—ç›¸å…³ç»“æ„ è€Œæ˜¯å¤ç”¨äº†ä¸šç•Œå¼€æºçš„&lt;a href=&#34;https://github.com/valyala/fasthttp&#34;&gt;fasthttp&lt;/a&gt; çš„ç»“æ„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;str&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;BaseStream&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;               &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint64&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;readDisableCount&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int32&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;              &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¯·æ±‚æŠ¥æ–‡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fasthttp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å“åº”æŠ¥æ–‡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fasthttp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamReceiveListener&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;mosn-http-å¤„ç†æµç¨‹&#34;&gt;MOSN HTTP å¤„ç†æµç¨‹&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;flow.png&#34; alt=&#34;æµç¨‹å›¾&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯HTTPè¯·æ±‚åœ¨MOSNä¸­çš„æµåŠ¨è¿‡ç¨‹ï¼Œä¸‹é¢å°†å…·ä½“è®²è§£ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æµç¨‹æ³¨å†Œ&#34;&gt;æµç¨‹æ³¨å†Œ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;str&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Register&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HTTP1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨ &lt;code&gt;pkg/stream/http&lt;/code&gt; åŒ…åŠ è½½è¿‡ç¨‹ä¸­å°†åŒ…å« HTTP å¯¹äºMOSNä¸Šä¸‹æ¸¸è¿æ¥çš„å¤„ç†é€»è¾‘çš„ç»“æ„ä½“å€¼æ³¨å†Œåˆ°ç»Ÿä¸€çš„streamå¤„ç†å·¥å‚ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ•è·è¯·æ±‚&#34;&gt;æ•è·è¯·æ±‚&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;flow1.png&#34; alt=&#34;æ•è·è¯·æ±‚&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç”±ä¸Šå›¾å¯çŸ¥ï¼ŒMOSNæ•æ‰åˆ°ä¸€ä¸ªè¯·æ±‚ä¹‹åä¼šå¼€å¯ä¸€ä¸ªgoroutineè¯»å–è¿æ¥ä¸­çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯
&lt;code&gt;serverStreamConnection.serve&lt;/code&gt; å‡½æ•°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serve&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1. pre alloc stream-level ctx with bufferCtx
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é€šè¿‡sync.Pool å®ç°å®ç°å†…å­˜å¤ç”¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;httpBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverRequest&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 2. blocking read using fasthttp.Request.Read
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReadLimitBody&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;br&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultMaxRequestBodySize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 3. &amp;#39;Expect: 100-continue&amp;#39; request handling.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// See http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html for details.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MayContinue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Send &amp;#39;HTTP/1.1 100 Continue&amp;#39; response.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewIoBufferBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;strResponseContinue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;

				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// read request body
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContinueReadBody&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;br&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultMaxRequestBodySize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// remove &amp;#39;Expect&amp;#39; header, so it would not be sent to the upstream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Del&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;Expect&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¯»å–é”™è¯¯çš„å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// &amp;#34;read timeout with nothing read&amp;#34; is the error of returned by fasthttp v1.2.0
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// if connection closed with nothing read.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errConnClose&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EOF&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;read timeout with nothing read&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// write error response
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewIoBufferBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;strErrorResponse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;

				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// close connection with flush
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FlushWrite&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LocalClose&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ•°æ®è¯»å–ç»“æŸ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GenerateID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStream&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 4. request processing
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;       &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;      &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyStreamID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverResponse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;responseDoneChan&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnhttp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Span&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IsEnabled&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Tracer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HTTP1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä¸Šä¸‹æ–‡ ä¸­æ³¨å…¥é“¾å¼è¿½è¸ªä¿¡æ¯
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InjectTrace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[stream] [http] new stream detect, requestId = %v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConnListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LoadInt32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readDisableCount&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 5. wait for proxy done
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;responseDoneChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connClosed&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç”±ä»¥ä¸Šä»£ç å¯ä»¥å¾—çŸ¥ï¼Œå› ä¸ºä¸èƒ½åˆ¤æ–­è¿æ¥æ˜¯é•¿è¿æ¥è¿˜æ˜¯çŸ­è¿æ¥ï¼Œæ‰€ä»¥MOSNè°ƒç”¨æ–¹ä¸ä¸»åŠ¨å…³é—­è¿æ¥ï¼ŒMOSNä¹Ÿä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œé™¤éå‡ºç°é”™è¯¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è½¬å‘è¯·æ±‚&#34;&gt;è½¬å‘è¯·æ±‚&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;flow2.png&#34; alt=&#34;è½¬å‘è¯·æ±‚&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç”±ä¸Šå›¾å¯çŸ¥ï¼ŒMOSNåœ¨æ•è·è¯·æ±‚ä¹‹åï¼Œå¼€å¯ä¸€ä¸ªgoroutine åˆ›å»ºå¯¹upstreamçš„è¿æ¥ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªè¿æ¥å’Œupstreamè¿›è¡Œæ•°æ®äº¤äº’ï¼Œä¸æ­¤åŒæ—¶å¼€å¯å¦å¤–ä¸€ä¸ªgoroutineå¯¹è¿™ä¸ªè¿æ¥è¿›è¡Œç›‘æ§ç”¨æ¥å¤„ç†è¿æ¥è¿”å›æ•°æ®ã€‚å…¶ä¸»è¦å¤„ç†é€»è¾‘åœ¨downStream.receiveä¸­ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Println&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;yu&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init phase
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter before route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// match route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MatchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;matchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter after route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilterAfterRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive header
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Count&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive trailer
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream oneway
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Oneway&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;oneway&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cleanStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstreamCleaned has set, return types.End
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// no oneway, skip types.Retry
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// retry request
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Retry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Count&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;doRetry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// wait for upstreamRequest or reset
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;waitNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] OnReceive send downstream response %+v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream filter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runAppendFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// maybe direct response
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;fakeUpstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fakeUpstreamRequest&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive header
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// send downstream response
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive triler
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetLogLevel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DEBUG&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] enter phase %d, proxyId = %d  &amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// process end
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] unexpected phase: %d&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] unexpected phase cycle time&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†è½¬å‘é€»è¾‘çš„æ ¸å¿ƒå‡½æ•°è§„å®šåœ¨å¤„ç†çš„å„ä¸ªé˜¶æ®µéœ€è¦åšçš„äº‹æƒ…ã€‚æ¯”å¦‚åœ¨&lt;code&gt;case types.UpRecvHeader&lt;/code&gt;çš„æ—¶å€™è¿›è¡Œè¿æ¥åˆ›å»ºä»¥åŠå¯¹ä¸‹æ¸¸æ•°æ®çš„åˆæ­¥è¯»å–ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å…¶ä»–&#34;&gt;å…¶ä»–&lt;/h2&gt;
&lt;h3 id=&#34;è¿æ¥å¤ç”¨&#34;&gt;è¿æ¥å¤ç”¨&lt;/h3&gt;
&lt;p&gt;åœ¨MOSNå¤„ç† HTTP è¯·æ±‚çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œé’ˆå¯¹å¯èƒ½é¢‘ç¹ä½¿ç”¨çš„è¿æ¥ï¼ŒMOSNå®ç°äº†ä¸€å¥—å¤ç”¨æœºåˆ¶ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;MaxConn&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Host&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;statReport&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;clientMux&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mutex&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// available clients
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;totalClientCount&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint64&lt;/span&gt;          &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// total clients
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getAvailableClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PoolFailureReason&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clientMux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clientMux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// no available client
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// max conns is 0 means no limit
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;maxConns&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ResourceManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connections&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Max&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;maxConns&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;totalClientCount&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;maxConns&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;ac&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reason&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newActiveClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ac&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reason&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;totalClientCount&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ac&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reason&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HostStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestPendingOverflow&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestPendingOverflow&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Overflow&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;--&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;availableClients&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç”±ä¸Šè¿°ä»£ç å¯çŸ¥ï¼ŒMOSN ç»´æŠ¤äº†ä¸€ä¸ªæœ‰æ•ˆé•¿è¿æ¥çš„æ ˆï¼Œå½“æ ˆä¸­è¿˜æœ‰æœ‰æ•ˆè¿æ¥åˆ™ä»æ ˆé¡¶å–å‡ºæœ‰æ•ˆçš„é•¿è¿æ¥ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªtcpé•¿è¿æ¥ã€‚MOSNé€šè¿‡è¿™ç§æ–¹å¼ç»´æŠ¤äº†è¿æ¥æ± æ¥å®ç°é«˜æ•ˆçš„è¿æ¥å¤ç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å†…å­˜å¤ç”¨&#34;&gt;å†…å­˜å¤ç”¨&lt;/h3&gt;
&lt;p&gt;HTTP çš„å¤„ç†è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹çš„ç”³è¯·ç©ºé—´æ¥è§£æ HTTP æŠ¥æ–‡ï¼Œä¸ºäº†å‡å°‘é¢‘ç¹çš„å†…å­˜ç”³è¯·ï¼Œå¸¸è§„çš„åšæ³•æ˜¯å†…å­˜å¤ç”¨ï¼ŒMOSNä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶åŸºäºsync.pool è®¾è®¡äº†å†…å­˜å¤ç”¨æ¨¡å—ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;httpBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;httpBuffers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Find&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ins&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;).(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;httpBuffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ç®€å•çš„åˆ†æäº†MOSNä¸­å¯¹äºHTTPè¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­ä¼˜åŒ–æ–¹å¼ä¸»è¦å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;tcp é»åŒ…ï¼šä½¿ç”¨fasthttp çš„requestå’Œresponseæ¥è§£ææŠ¥æ–‡ã€‚&lt;/li&gt;
&lt;li&gt;å®ç°è¿æ¥å¤ç”¨ï¼šè¿æ¥æ± ã€‚&lt;/li&gt;
&lt;li&gt;å®ç°å†…å­˜å¤ç”¨ï¼šsync.poolã€‚&lt;/li&gt;
&lt;/ol&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - log ç³»ç»Ÿ</title>
      <link>https://mosn.io/blog/code/mosn-log/</link>
      <pubDate>Tue, 03 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-log/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„ç›®çš„æ˜¯åˆ†æ MOSN æºç ä¸­çš„&lt;code&gt;Logç³»ç»Ÿ&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.10.0ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚è¿°&#34;&gt;æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;MOSN æ—¥å¿—ç³»ç»Ÿåˆ†ä¸º&lt;code&gt;æ—¥å¿—&lt;/code&gt;å’Œ&lt;code&gt;Metric&lt;/code&gt;ä¸¤å¤§éƒ¨åˆ†ï¼Œå…¶ä¸­&lt;code&gt;æ—¥å¿—&lt;/code&gt;ä¸»è¦åŒ…æ‹¬&lt;code&gt;errorlog&lt;/code&gt;å’Œ&lt;code&gt;accesslog&lt;/code&gt;ï¼Œ&lt;code&gt;Metrics&lt;/code&gt;ä¸»è¦åŒ…æ‹¬&lt;code&gt;consoleæ•°æ®&lt;/code&gt;å’Œ&lt;code&gt;prometheusæ•°æ®&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ—¥å¿—&#34;&gt;æ—¥å¿—&lt;/h2&gt;
&lt;h3 id=&#34;errorlog&#34;&gt;errorlog&lt;/h3&gt;
&lt;p&gt;errorlog ä¸»è¦æ˜¯ç”¨æ¥è®°å½•&lt;code&gt;MOSN&lt;/code&gt;è¿è¡Œæ—¶å€™çš„æ—¥å¿—ä¿¡æ¯ï¼Œ&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/config/v2/server.go#L28&#34;&gt;é…ç½®ç»“æ„&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ServerConfig&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;DefaultLogPath&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;`json:&amp;#34;default_log_path,omitempty&amp;#34;`&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;DefaultLogLevel&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;`json:&amp;#34;default_log_level,omitempty&amp;#34;`&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;GlobalLogRoller&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;`json:&amp;#34;global_log_roller,omitempty&amp;#34;`&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åˆå§‹åŒ– errorlog åŒ…æ‹¬ä¸¤ä¸ªå¯¹è±¡&lt;code&gt;StartLogger&lt;/code&gt;å’Œ&lt;code&gt;DefaultLogger&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;StartLogger ä¸»è¦ç”¨æ¥è®°å½• mosn å¯åŠ¨çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ—¥å¿—çº§åˆ«æ˜¯ INFO&lt;/li&gt;
&lt;li&gt;DefaultLogger ä¸»è¦æ˜¯ç”¨æ¥è®°å½•&lt;code&gt;MOSN&lt;/code&gt;å¯åŠ¨ä¹‹åçš„è¿è¡Œæ—¥å¿—ä¿¡æ¯ï¼Œé»˜è®¤å’Œ StartLogger ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¦†ç›–&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/log/logger_manager.go#L37&#34;&gt;ä»£ç å¦‚ä¸‹ï¼š&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// use console as start logger
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetOrCreateDefaultErrorLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;INFO&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é»˜è®¤INFO
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// default as start before Init
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// default proxy logger for test, override after config parsed
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultContextLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;CreateDefaultContextLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;INFO&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;InitDefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;level&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Level&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥è¦†ç›–é»˜è®¤é…ç½®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetOrCreateDefaultErrorLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;level&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;accesslog&#34;&gt;accesslog&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;accesslog&lt;/code&gt; ä¸»è¦ç”¨æ¥è®°å½•ä¸Šä¸‹æ¸¸è¯·æ±‚çš„æ•°æ®ä¿¡æ¯ï¼Œ&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/config/v2/server.go#L76&#34;&gt;é…ç½®ç»“æ„&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AccessLog&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Path&lt;/span&gt;   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;`json:&amp;#34;log_path,omitempty&amp;#34;`&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Format&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;`json:&amp;#34;log_format,omitempty&amp;#34;`&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸‹é¢ &lt;code&gt;servers&lt;/code&gt;-&amp;gt;&lt;code&gt;listener&lt;/code&gt;-&amp;gt;&lt;code&gt;access_logs&lt;/code&gt;ï¼Œå…·ä½“é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;servers&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;mosn_server_name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;mosn_server_1&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
			&lt;span style=&#34;color:#a40000&#34;&gt;......&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;listeners&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;ingress_sofa&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
					&lt;span style=&#34;color:#a40000&#34;&gt;......&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;./logs/ingress.log&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_level&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;DEBUG&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;access_logs&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
						&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
							&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;./logs/access_ingress.log&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
							&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_format&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;%start_time% %request_received_duration% %response_received_duration% %bytes_sent% %bytes_received% %protocol% %response_code% %duration% %response_flag% %response_code% %upstream_local_address% %downstream_local_address% %downstream_remote_address% %upstream_host%&amp;#34;&lt;/span&gt;
						&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
					&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;accesslog å®ç°å¦‚ä¸‹&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/log/accesslog.go#L105&#34;&gt;æ¥å£&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;AccessLog&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Log write the access info.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;Log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reqHeaders&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;respHeaders&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;RequestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è°ƒç”¨ Log è®°å½•æ—¥å¿—çš„æ—¶å€™ï¼Œé€šè¿‡ä½¿ç”¨ &lt;a href=&#34;https://mosn.ioblog/code/mosn-variable&#34;&gt;å˜é‡æœºåˆ¶&lt;/a&gt; æ¥å¡«å……&lt;code&gt;log_format&lt;/code&gt;é‡Œé¢çš„å˜é‡ï¼Œç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨ ctx é‡Œé¢ã€‚ç”¨äºä¿å­˜å˜é‡ä¿¡æ¯çš„ &lt;code&gt;entries&lt;/code&gt; é€šè¿‡ &lt;code&gt;NewAccessLog&lt;/code&gt; åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨ &lt;code&gt;parseFormat&lt;/code&gt; æ–¹æ³•æ¥åˆå§‹åŒ–çš„ï¼Œ&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/log/accesslog.go#L79&#34;&gt;å‚è€ƒç›¸å…³ä»£ç &lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;log-çš„å…·ä½“å®ç°&#34;&gt;log çš„å…·ä½“å®ç°&lt;/h3&gt;
&lt;p&gt;log çš„å…·ä½“å®ç°å·²ç»åˆ†ç¦»åˆ°äº† &lt;a href=&#34;https://github.com/mosn/pkg/tree/1e4184714e744895968339725cc2dc34f5116dcb/log&#34;&gt;mosn/pkg/log&lt;/a&gt; ä¸‹é¢ï¼Œ&lt;code&gt;errorlog&lt;/code&gt; å’Œ &lt;code&gt;accesslog&lt;/code&gt; çš„å…·ä½“å®ç°éƒ½æ˜¯é€šè¿‡ &lt;a href=&#34;https://github.com/mosn/pkg/blob/1e4184714e744895968339725cc2dc34f5116dcb/log/logger.go#L122&#34;&gt;log.GetOrCreateLogger&lt;/a&gt; æ¥åˆå§‹åŒ–çš„ã€‚å½“ &lt;code&gt;roller&lt;/code&gt; ä¸ºç©ºçš„æ—¶å€™ä½¿ç”¨é»˜è®¤çš„ &lt;code&gt;defaultRoller&lt;/code&gt;ï¼Œé»˜è®¤æ¯å¤©è½®è½¬ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;defaultRoller&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Roller&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MaxTime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultRotateTime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;defaultRotateTime&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;60&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;60&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;start&#34;&gt;start&lt;/h4&gt;
&lt;p&gt;æ ¹æ®ä¸åŒçš„è¾“å‡ºæ–¹å¼ï¼Œåˆå§‹åŒ–ä¸åŒçš„ &lt;code&gt;io.Writer&lt;/code&gt; å¯¹è±¡ï¼Œ &lt;a href=&#34;https://github.com/mosn/pkg/blob/1e4184714e744895968339725cc2dc34f5116dcb/log/logger.go#L146&#34;&gt;è¯¦æƒ…&lt;/a&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;type&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;io.Writer&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;&amp;ldquo;&amp;rdquo;, &amp;ldquo;stderr&amp;rdquo;, &amp;ldquo;/dev/stderr&amp;rdquo;&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;os.Stderr&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;&amp;ldquo;stdout&amp;rdquo;, &amp;ldquo;/dev/stdout&amp;rdquo;&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;os.Stdout&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;&amp;ldquo;syslog&amp;rdquo;&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;&lt;a href=&#34;https://github.com/hashicorp/go-syslog&#34;&gt;gsyslog&lt;/a&gt;æœ¬åœ°å¯¹è±¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;å…¶ä»–&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;&lt;a href=&#34;https://github.com/hashicorp/go-syslog&#34;&gt;gsyslog&lt;/a&gt;è¿œç¨‹å¯¹è±¡&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;åˆ›å»ºå¥½ log å¯¹è±¡ä¹‹åï¼Œé€šè¿‡ &lt;code&gt;loggers&lt;/code&gt; ä¿å­˜èµ·æ¥ï¼Œé¿å…åˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼Œ&lt;code&gt;loggers&lt;/code&gt; æ˜¯ä¸€ä¸ª &lt;a href=&#34;https://blog.csdn.net/ChamPly/article/details/77622328&#34;&gt;sync.Map&lt;/a&gt;å¯¹è±¡ï¼Œæ˜¯ &lt;code&gt;golang1.9&lt;/code&gt; ä¹‹ååŠ å…¥çš„ä¸€ä¸ªæ–°çš„çº¿ç¨‹å®‰å…¨çš„ &lt;code&gt;map&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;start&lt;/code&gt; å¯åŠ¨ä¹‹åä¼š åˆ›å»ºä¸€ä¸ªä¸€ç›´å¾ªç¯è¯»å–çš„åç¨‹ &lt;code&gt;handler&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;handler&#34;&gt;handler&lt;/h3&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/pkg/blob/1e4184714e744895968339725cc2dc34f5116dcb/log/logger.go#L198&#34;&gt;ç›¸å…³ä»£ç &lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ›å»ºäº†ä¸€ä¸ª 500 å¤§å°çš„ &lt;code&gt;chan&lt;/code&gt; &lt;code&gt;writeBufferChan&lt;/code&gt;ï¼Œå¹¶ä¸”åœ¨ &lt;code&gt;handler&lt;/code&gt; é‡Œé¢å¤„ç†éœ€è¦è®°å½•çš„æ—¥å¿—ã€é‡å‘½åçš„äº‹ä»¶ã€å…³é—­çš„äº‹ä»¶ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;lg&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Logger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;          &lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;roller&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;          &lt;span style=&#34;color:#000&#34;&gt;roller&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;writeBufferChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;500&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;reopenChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;      &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}),&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;closeChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;       &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}),&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// writer and create will be setted in start()
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reopenChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;closeChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;writeBufferChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;......&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;runtime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Gosched&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;reopenchanhttpsgithubcommosnpkgblob1e4184714e744895968339725cc2dc34f5116dcblogloggergol260&#34;&gt;&lt;a href=&#34;https://github.com/mosn/pkg/blob/1e4184714e744895968339725cc2dc34f5116dcb/log/logger.go#L260&#34;&gt;reopenChan&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;é€šè¿‡é‡å‘½åæ–‡ä»¶ä¹‹åï¼Œé‡æ–°è°ƒç”¨ &lt;code&gt;start&lt;/code&gt; æ–¹æ³•åˆ›å»ºæ–°æ–‡ä»¶ï¼Œä¸»è¦ä½¿ç”¨åœ¨æ–‡ä»¶è½®è½¬çš„æ—¶å€™ã€‚&lt;code&gt;os.Stdout&lt;/code&gt; &lt;code&gt;os.Stderr&lt;/code&gt; ä¸æ”¯æŒæ“ä½œï¼Œä¼šæŠ¥é”™ã€‚&lt;/p&gt;
&lt;h4 id=&#34;closechan&#34;&gt;closeChan&lt;/h4&gt;
&lt;p&gt;æŠŠå½“å‰ &lt;code&gt;writeBufferChan&lt;/code&gt; éœ€è¦å†™å…¥çš„æ•°æ®å†™å…¥åˆ°å¯¹è±¡ä¸­ï¼Œç„¶åé€€å‡ºå½“å‰åç¨‹ã€‚&lt;/p&gt;
&lt;h4 id=&#34;writebufferchan&#34;&gt;writeBufferChan&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;writeBufferChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Bytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PutIoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;break&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WriteTo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PutIoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å½“æ”¶åˆ°ç¬¬ä¸€æ¬¡å†™æ•°æ®çš„æ—¶å€™ä¸æ˜¯ç«‹åˆ»å†™å…¥æ•°æ®åˆ° &lt;code&gt;log&lt;/code&gt; å¯¹è±¡ï¼Œè€Œæ˜¯åœ¨ç­‰å¾… 20 æ¬¡è¯»å–ä¿¡æ¯ï¼Œä¸€èµ·å†™å…¥åˆ°å¯¹ &lt;code&gt;log&lt;/code&gt; è±¡ä¸­ï¼Œåœ¨å¤§é‡å†™æ—¥å¿—çš„æ—¶å€™ä¸ä¼šå¯¼è‡´è°ƒç”¨å¤ªé¢‘ç¹ã€‚å¦‚é¢‘ç¹å†™å…¥æ–‡ä»¶ã€é¢‘ç¹è°ƒç”¨å†™æ—¥å¿—æ¥å£ï¼Œç›¸åï¼Œè¿™ä¼šå¢åŠ å†…å­˜åˆ†é…ï¼Œæœ€å¥½çš„å…¶å®æ˜¯ä½¿ç”¨ &lt;code&gt;writev&lt;/code&gt;ï¼Œä½†æ˜¯ &lt;code&gt;go runtime&lt;/code&gt; çš„ &lt;code&gt;io&lt;/code&gt; åº“æ²¡æœ‰è¿™ä¸ªå®ç°ã€‚å¯ä»¥é‡‡ç”¨ &lt;a href=&#34;https://mosn.io/blog/code/mosn-plugin/&#34;&gt;plugin æœºåˆ¶&lt;/a&gt; æ¥æ¥ç®¡æ—¥å¿—çš„æ‰“å°ï¼Œå‡å°‘ &lt;code&gt;io&lt;/code&gt; å¡é¡¿å¯¹ &lt;code&gt;go runtime&lt;/code&gt; çš„è°ƒåº¦å½±å“&lt;/p&gt;
&lt;p&gt;*&lt;em&gt;å½“ä¸€æ¬¡å¾ªç¯å¤„ç†å®Œä¹‹åï¼Œä¼šè°ƒç”¨ &lt;code&gt;runtime.Gosched()&lt;/code&gt; ä¸»åŠ¨è®©å‡ºå½“å‰åç¨‹çš„ &lt;code&gt;cpu&lt;/code&gt; èµ„æº&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;metrics&#34;&gt;Metrics&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Metrics&lt;/code&gt; æ˜¯ä¸€ç§è§„èŒƒçš„åº¦é‡ï¼Œåˆ†ä¸ºå¦‚ä¸‹ç±»å‹ï¼Œæ‘˜æŠ„è‡³ &lt;a href=&#34;https://prometheus.io/docs/concepts/metric_types/&#34;&gt;METRIC TYPES&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Gauges: ä»£è¡¨å¯ä»¥ä»»æ„ä¸Šä¸‹æ³¢åŠ¨çš„å•ä¸ªæ•°å€¼ï¼Œé€šå¸¸ç”¨æ¥è¡¨ç¤ºæµ‹é‡å€¼ã€‚æ¯”å¦‚å†…å­˜ï¼Œcpuï¼Œç£ç›˜ç­‰ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;Counters: ç´¯è®¡åº¦é‡ï¼Œä»£è¡¨å•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œåªæœ‰åœ¨é‡å¯æˆ–è€…é‡ç½®çš„æ—¶å€™æ•°é‡ä¸º 0ï¼Œå…¶ä»–æ—¶å€™ä¸€èˆ¬ä¸ä½¿ç”¨å‡å°‘ã€‚å¯ä»¥ç”¨æ¥è¡¨ç¤ºè¯·æ±‚çš„æ•°é‡ã€‚&lt;/li&gt;
&lt;li&gt;Histograms: ç›´æ–¹å›¾ï¼Œå¯¹è§‚å¯Ÿå€¼(é€šå¸¸æ˜¯è¯·æ±‚æŒç»­æ—¶é—´æˆ–è¿”å›å¤§å°ä¹‹ç±»çš„æ•°æ®)è¿›è¡Œé‡‡æ ·ï¼Œå¹¶å°†å…¶è®¡æ•°æ”¾åˆ°å¯¹åº”çš„é…ç½®æ¡¶ä¸­ï¼Œä¹Ÿæä¾›æ‰€æœ‰è§‚æµ‹å€¼æ€»å’Œä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;Summary: ç±»ä¼¼äºç›´æ–¹å›¾ï¼Œæ‘˜è¦é‡‡æ ·çš„è§‚æµ‹ç»“æœï¼Œå¯ä»¥è®¡ç®—æ»‘åŠ¨æ—¶é—´çª—å£å†…çš„å¯é…ç½®åˆ†ä½æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸»è¦ä»£ç åœ¨ &lt;code&gt;pkg/metrics&lt;/code&gt; ä¸‹é¢åŒ…æ‹¬ &lt;code&gt;pkg/metrics/sink&lt;/code&gt; å’Œ &lt;code&gt;pkg/metrics/shm&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;sink&#34;&gt;sink&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;pkg/metrics/sink&lt;/code&gt; åŒ…å« &lt;code&gt;console&lt;/code&gt; å’Œ &lt;code&gt;prometheus&lt;/code&gt;ï¼Œä¸¤è€…éƒ½å®ç°äº† &lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/types/metrics.go#L58&#34;&gt;types.MetricsSink&lt;/a&gt; æ¥å£ã€‚&lt;code&gt;prometheus&lt;/code&gt; æ˜¯é€šè¿‡å·¥å‚æ–¹æ³• &lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/metrics/sink/prometheus/prometheus.go#L57&#34;&gt;æ³¨å†Œ&lt;/a&gt; è¿›å»ä½¿ç”¨çš„ï¼›&lt;code&gt;console&lt;/code&gt; æ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨ &lt;code&gt;console.NewConsoleSink()&lt;/code&gt; æ¥ä½¿ç”¨çš„ã€‚&lt;/p&gt;
&lt;h4 id=&#34;prometheus&#34;&gt;prometheus&lt;/h4&gt;
&lt;p&gt;ä¸»è¦æ˜¯é€šè¿‡ &lt;code&gt;prometheus&lt;/code&gt; çš„ &lt;code&gt;metrics&lt;/code&gt; ç»Ÿè®¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œé…ç½®æ–‡ä»¶ç¤ºä¾‹:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metrics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#a40000&#34;&gt;......&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;sinks&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;prometheus&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;port&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;34903&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;å…¶ä¸­ &lt;code&gt;type&lt;/code&gt; ç›®å‰åªæ”¯æŒ &lt;code&gt;prometheus&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡ &lt;a href=&#34;https://github.com/prometheus/client_golang&#34;&gt;prometheus åº“&lt;/a&gt; æä¾›çš„ http èƒ½åŠ›ï¼Œä½¿ç”¨é…ç½®ä¿¡æ¯å¯åŠ¨ä¸€ä¸ª http æœåŠ¡ï¼ŒæŠŠ &lt;code&gt;Metrics&lt;/code&gt; ä¿¡æ¯é€šè¿‡ &lt;code&gt;http://host:port/metrics&lt;/code&gt; çš„æ–¹å¼ä¾›&lt;code&gt;prometheus&lt;/code&gt;æ”¶é›†æˆ–å±•ç¤ºã€‚&lt;/p&gt;
&lt;h4 id=&#34;console&#34;&gt;console&lt;/h4&gt;
&lt;p&gt;ä¸»è¦ç”¨äº &lt;code&gt;admin api&lt;/code&gt; çš„ &lt;code&gt;/api/v1/stats&lt;/code&gt; &lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/admin/server/server.go#L45&#34;&gt;å±•ç¤º&lt;/a&gt;ã€‚æ‰€ä»¥å¿…é¡»é…ç½® &lt;code&gt;admin&lt;/code&gt; ç›¸å…³ä¿¡æ¯ï¼Œç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;socket_address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;0.0.0.0&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;port_value&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;34901&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœä¸é…ç½®ä¼šæ‰“å° &lt;code&gt;no admin config, no admin api served&lt;/code&gt; å‘Šè­¦ä¿¡æ¯ï¼Œ&lt;a href=&#34;https://github.com/mosn/mosn/blob/07cd4afe4d76619fdfbdff858239885f9a358bb2/pkg/admin/server/server.go#L59&#34;&gt;å‚è€ƒ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;admin api&lt;/code&gt; ä¸­è¿˜åŒ…æ‹¬å¦‚ä¸‹æ¥å£&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/api/v1/config_dump&lt;/li&gt;
&lt;li&gt;/api/v1/stats&lt;/li&gt;
&lt;li&gt;/api/v1/update_loglevel&lt;/li&gt;
&lt;li&gt;/api/v1/enable_log&lt;/li&gt;
&lt;li&gt;/api/v1/disbale_log&lt;/li&gt;
&lt;li&gt;/api/v1/states&lt;/li&gt;
&lt;li&gt;/api/v1/plugin&lt;/li&gt;
&lt;li&gt;/&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶ä¸­ &lt;code&gt;update_loglevel&lt;/code&gt; ç”¨äºæ›´æ–° &lt;code&gt;errorlog&lt;/code&gt; æ—¥å¿—çš„è¾“å‡ºçº§åˆ«ï¼Œ&lt;code&gt;enable_log&lt;/code&gt; å’Œ &lt;code&gt;disbale_log&lt;/code&gt; ç”¨äºå¯ç”¨/ç¦ç”¨ &lt;code&gt;errorlog&lt;/code&gt; çš„è¾“å‡º&lt;/p&gt;
&lt;h3 id=&#34;shm&#34;&gt;shm&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;pkg/metrics/shm&lt;/code&gt; ä¸»è¦æ˜¯é€šè¿‡ &lt;code&gt;mmap&lt;/code&gt; å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„è¿›å†…å­˜ï¼Œè®©å¤šä¸ªè¿›ç¨‹å…±ç”¨ï¼Œå¯ä»¥è®© &lt;code&gt;MOSN&lt;/code&gt; åœ¨çƒ­å‡çº§çš„è¿‡ç¨‹ä¸­ &lt;code&gt;metrics&lt;/code&gt; æ•°æ®ä¸ä¼šå‡ºç° &lt;code&gt;&amp;quot;æ–­å´–&amp;quot;&lt;/code&gt;ï¼Œå…³äº &lt;code&gt;shm&lt;/code&gt; çš„åˆ†æå†…å®¹å¯ä»¥å‚è€ƒ &lt;a href=&#34;https://mosn.ioblog/code/mosn-shm/&#34;&gt;å…±äº«å†…å­˜æ¨¡å‹&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä¸é¼“åŠ±åœ¨ Go é‡Œé¢ä½¿ç”¨å…±äº«å†…å­˜ï¼Œé™¤éä½ æœ‰æ˜ç¡®çš„ä½¿ç”¨åœºæ™¯&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;é€šè¿‡åˆ†æ &lt;code&gt;MOSN&lt;/code&gt; æºç çš„ &lt;code&gt;logç³»ç»Ÿ&lt;/code&gt; æ¨¡å—ï¼Œä¸å•å•æ˜¯äº†è§£äº†æ—¥å¿—éƒ¨åˆ†ï¼Œä»é…ç½®ã€å¯åŠ¨æµç¨‹ï¼Œåˆ°ä¸Šä¸‹æ¸¸è¯·æ±‚éƒ½æœ‰æ‰€æ¶‰åŠã€‚å­¦ä¹ äº†å¾ˆå¤šï¼Œå¸Œæœ› &lt;code&gt;MOSN&lt;/code&gt; è¶Šæ¥è¶Šå¼ºå¤§ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/mosn/tree/v0.10.0&#34;&gt;MOSN æºç  v0.10.0&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/pkg/tree/1e4184714e744895968339725cc2dc34f5116dcb&#34;&gt;pkg æºç &lt;/a&gt; commit 1e41847&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: ç›´æ’­é¢„å‘Šï¼šMOSN çš„å¤šåè®®æœºåˆ¶è§£æ</title>
      <link>https://mosn.io/blog/news/mosn-channel-1/</link>
      <pubDate>Tue, 03 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/news/mosn-channel-1/</guid>
      <description>
        
        
        &lt;p&gt;ä½œä¸ºäº‘åŸç”Ÿç½‘ç»œä»£ç†ï¼ŒService Mesh æ˜¯ MOSN çš„é‡è¦åº”ç”¨åœºæ™¯ã€‚éšç€ Service Mesh æ¦‚å¿µçš„æ—¥ç›Šæ¨å¹¿ï¼Œå¤§å®¶å¯¹è¿™å¥—ä½“ç³»éƒ½å·²ç»ä¸å†é™Œç”Ÿï¼Œæœ‰äº†è¾ƒä¸ºæ·±å…¥çš„è®¤çŸ¥ã€‚ä½†æ˜¯ä¸ç†è®ºä¼ æ’­ç›¸å¯¹åº”çš„æ˜¯ï¼Œç”Ÿäº§çº§åˆ«çš„å¤§è§„æ¨¡è½åœ°å®è·µæ¡ˆä¾‹å´å¹¶ä¸å¤šè§ã€‚è¿™å…¶ä¸­æœ‰å¤šæ–¹é¢çš„åŸå› ï¼ŒåŒ…æ‹¬ç¤¾åŒºæ–¹æ¡ˆé¥±å—è¯Ÿç—…çš„â€œå¤§è§„æ¨¡åœºæ™¯æ€§èƒ½é—®é¢˜â€ã€â€œé…å¥—çš„è¿ç»´ç›‘æ§åŸºç¡€è®¾æ–½æ¼”è¿›é€Ÿåº¦è·Ÿä¸ä¸Šâ€ã€â€œå­˜é‡æœåŠ¡åŒ–ä½“ç³»çš„å…¼å®¹æ–¹æ¡ˆâ€ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;ç°å®åœºæ™¯ä¸­ï¼Œå¤§éƒ¨åˆ†ä¸­å›½å‚å•†éƒ½æœ‰ä¸€å¥—è‡ªç ” RPC çš„æœåŠ¡åŒ–ä½“ç³»ï¼Œå±äºã€Œå­˜é‡æœåŠ¡åŒ–ä½“ç³»çš„å…¼å®¹æ–¹æ¡ˆã€ä¸­çš„åè®®é€‚é…é—®é¢˜ã€‚ä¸ºæ­¤ï¼ŒMOSN è®¾è®¡äº†ä¸€å¥—å¤šåè®®æ¡†æ¶ï¼Œç”¨äºé™ä½è‡ªç ”ä½“ç³»çš„åè®®é€‚é…åŠæ¥å…¥æˆæœ¬ï¼ŒåŠ é€Ÿ Service Mesh çš„è½åœ°æ™®åŠã€‚æœ¬æ¬¡æ¼”è®²å°†å‘å¤§å®¶ä»‹ç» MOSN å®ç°å¤šåè®®ä½æˆæœ¬æ¥å…¥çš„è®¾è®¡æ€è·¯ï¼Œä»¥åŠç›¸åº”çš„å¿«é€Ÿæ¥å…¥å®è·µæ¡ˆä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;è®²å¸ˆï¼šæ— é’©ï¼ˆ&lt;a href=&#34;https://github.com/neverhook&#34;&gt;@neverhook&lt;/a&gt;ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gw.alipayobjects.com/mdn/rms_91f3e6/afts/img/A*CfJuT7aNWgoAAAAAAAAAAABkARQnAQ&#34; alt=&#34;æ— é’©&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æœ¬æœŸå¤§çº²&#34;&gt;æœ¬æœŸå¤§çº²&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€ä¸ªè¯·æ±‚çš„ MOSN ä¹‹æ—…&lt;/li&gt;
&lt;li&gt;å¦‚ä½•åœ¨ MOSN ä¸­æ¥å…¥æ–°çš„åè®®&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/sofastack/sofa-bolt&#34;&gt;SOFABolt&lt;/a&gt; åè®®æ¥å…¥å®è·µ&lt;/li&gt;
&lt;li&gt;æœªæ¥å‘å±•ï¼šç»Ÿä¸€è·¯ç”±æ¡†æ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç›´æ’­æŠ¥åï¼šhttps://tech.antfin.com/community/live/1131&lt;/p&gt;
&lt;p&gt;æ‰«æ&lt;a href=&#34;community/&#34;&gt;ç¤¾åŒº&lt;/a&gt;é¡µé¢çš„äºŒç»´ç åŠ å…¥é’‰é’‰ç¾¤å‚ä¸äº’åŠ¨ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - å¯åŠ¨æµç¨‹</title>
      <link>https://mosn.io/blog/code/mosn-startup/</link>
      <pubDate>Wed, 26 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-startup/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„ç›®çš„æ˜¯åˆ†æ MOSN çš„å¯åŠ¨æµç¨‹ã€‚åŸºäº mosn ç‰ˆæœ¬ v0.4.0ï¼Œcommit ä¸º: dc35c8fc95435a47e6393db1c79dd9f60f7eb898&lt;/p&gt;
&lt;h2 id=&#34;mosn-ç®€ä»‹&#34;&gt;MOSN ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;MOSN æ˜¯ä¸€æ¬¾ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ç½‘ç»œä»£ç†è½¯ä»¶ï¼Œä½œä¸ºäº‘åŸç”Ÿçš„ç½‘ç»œæ•°æ®å¹³é¢ï¼Œæ—¨åœ¨ä¸ºæœåŠ¡æä¾›å¤šåè®®ï¼Œæ¨¡å—åŒ–ï¼Œæ™ºèƒ½åŒ–ï¼Œå®‰å…¨çš„ä»£ç†èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;MOSN åœ¨åŸºäº Kubernetes çš„ service mesh ä¸­é€šå¸¸æ‰®æ¼”æ•°æ®å¹³é¢çš„è§’è‰²ï¼Œå®ƒä½œä¸º sidecar æ³¨å…¥åˆ°é›†ç¾¤çš„ Pod ä¸­ï¼Œæ¥ç®¡åœ¨ Pod ä¹‹é—´çš„ç½‘ç»œè¿æ¥ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-å¯åŠ¨æµç¨‹&#34;&gt;MOSN å¯åŠ¨æµç¨‹&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆæ‰¾åˆ°ç¨‹åºçš„å…¥å£ï¼Œå¾ˆå¤š go çš„é¡¹ç›®éƒ½å°† ç¨‹åºå…¥å£å†™åœ¨ &lt;code&gt;cmd&lt;/code&gt; æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åå…·ä½“çš„å®ç°å†™åœ¨ &lt;code&gt;pkg&lt;/code&gt; ä¸­ã€‚MOSN é¡¹ç›®ä¹Ÿæ­£å¥½å¦‚æ­¤ã€‚åœ¨ &lt;code&gt;cmd/mosn/main/mosn.go&lt;/code&gt;
ä¸­æœ‰æˆ‘ä»¬è¦çš„ &lt;code&gt;main&lt;/code&gt; å‡½æ•°ï¼Œæä¾›äº† &lt;code&gt;start&lt;/code&gt;, &lt;code&gt;stop&lt;/code&gt; å’Œ &lt;code&gt;reload&lt;/code&gt; å‘½ä»¤ã€‚å…¶ä¸­ &lt;code&gt;stop&lt;/code&gt; å’Œ &lt;code&gt;reload&lt;/code&gt; è¿˜æœªåšå®ç°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//commands
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Commands&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cli&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Command&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmdStart&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmdStop&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmdReload&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨ &lt;code&gt;cmd/mosn/main/control.go&lt;/code&gt; ä¸­ï¼Œæœ‰ã€€&lt;code&gt;mosn start&lt;/code&gt; æ‰§è¡Œçš„ä»£ç éƒ¨åˆ†ã€‚&lt;code&gt;mosn start&lt;/code&gt; å½“å‰æœ‰5ä¸ªå‚æ•°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;config, c&lt;/code&gt;: æä¾›é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œé»˜è®¤å€¼æ˜¯ &lt;code&gt;configs/mosn_config.json&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service-cluster, s&lt;/code&gt;: xdsclient çš„åˆå§‹åŒ–å‚æ•°ï¼šæœåŠ¡é›†ç¾¤åç§°ï¼Œè¿™é‡Œçš„é›†ç¾¤æ˜¯ MOSN è¿æ¥åˆ°çš„ä¸€ç»„é€»è¾‘ä¸Šç›¸ä¼¼çš„ä¸Šæ¸¸ä¸»æœº&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service-node, n&lt;/code&gt;: xdsclient çš„åˆå§‹åŒ–å‚æ•°ï¼šæœåŠ¡é›†ç¾¤ä¸­çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service-meta, sm&lt;/code&gt;: xdsclient çš„åˆå§‹åŒ–å‚æ•°ï¼šå…ƒæ•°æ®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;feature-gates, f&lt;/code&gt;: feature-gates æ˜¯ MOSN çš„ç‰¹æ€§å¼€å…³ï¼Œå½“å‰æœ‰ä¸‰ä¸ªç‰¹æ€§ï¼š &lt;code&gt;XdsMtlsEnable&lt;/code&gt;, &lt;code&gt;PayLoadLimitEnable&lt;/code&gt; å’Œ &lt;code&gt;MultiTenantMode&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ€ç»ˆå¯ä»¥åœ¨ &lt;code&gt;pkg/mosn/starter.go&lt;/code&gt; ä¸­æ‰¾åˆ°å¯åŠ¨æ–¹æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Start mosn project
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// step1. NewMosn
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// step2. Start Mosn
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MOSNConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//log.StartLogger.Infof(&amp;#34;[mosn] [start] start by config : %+v&amp;#34;, c)
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewMosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;wg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Wait&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨æ–¹æ³•å¾ˆç®€å•ï¼Œ&lt;code&gt;Mosn := NewMosn(c)&lt;/code&gt; å®ä¾‹åŒ–äº†ä¸€ä¸ª &lt;code&gt;Mosn&lt;/code&gt; å®ä¾‹ã€‚&lt;code&gt;Mosn.Start()&lt;/code&gt; å¼€å§‹è¿è¡Œã€‚ ä¸‹é¢ä¸»è¦å°± &lt;code&gt;NewMosn(c)&lt;/code&gt; å’Œ &lt;code&gt;Start()&lt;/code&gt; æ–¹æ³•åšåˆ†æã€‚&lt;/p&gt;
&lt;h3 id=&#34;mosn-çš„åˆå§‹åŒ–&#34;&gt;MOSN çš„åˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;åœ¨è¿›å…¥åˆ°å…·ä½“åˆå§‹åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ MOSN çš„ç»“æ„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt;        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;clustermanager&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterManager&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;routerManager&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterManager&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;         &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MOSNConfig&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;adminServer&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;admin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;xdsClient&lt;/span&gt;      &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;xds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;wg&lt;/span&gt;             &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitGroup&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// for smooth upgrade. reconfigure
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listener&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt;      &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;servers&lt;/code&gt; æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ&lt;code&gt;server.Server&lt;/code&gt; æ˜¯æ¥å£ç±»å‹ã€‚ä½†æ˜¯ç›®å‰çš„ä»£ç é€»è¾‘ä¸­åªä¼šæœ‰ä¸€ä¸ª serverã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;clustermanager&lt;/code&gt; é¡¾åæ€ä¹‰å°±æ˜¯é›†ç¾¤ç®¡ç†å™¨ã€‚ &lt;code&gt;types.ClusterManager&lt;/code&gt; ä¹Ÿæ˜¯æ¥å£ç±»å‹ã€‚è¿™é‡Œçš„ &lt;code&gt;cluster&lt;/code&gt; æŒ‡å¾—æ˜¯ MOSN è¿æ¥åˆ°çš„ä¸€ç»„é€»è¾‘ä¸Šç›¸ä¼¼çš„ä¸Šæ¸¸ä¸»æœºã€‚MOSN é€šè¿‡æœåŠ¡å‘ç°æ¥å‘ç°é›†ç¾¤ä¸­çš„æˆå‘˜ï¼Œå¹¶é€šè¿‡ä¸»åŠ¨è¿è¡ŒçŠ¶å†µæ£€æŸ¥æ¥ç¡®å®šé›†ç¾¤æˆå‘˜çš„å¥åº·çŠ¶å†µã€‚MOSN å¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤æˆå‘˜ç”±è´Ÿè½½å‡è¡¡ç­–ç•¥ç¡®å®šã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;routerManager&lt;/code&gt; æ˜¯è·¯ç”±ç®¡ç†å™¨ï¼ŒMOSN æ ¹æ®è·¯ç”±è§„åˆ™æ¥å¯¹è¯·æ±‚è¿›è¡Œä»£ç†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;adminServer&lt;/code&gt; æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ http è¯·æ±‚è·å– MOSN çš„é…ç½®ã€çŠ¶æ€ç­‰ç­‰&lt;/p&gt;
&lt;p&gt;&lt;code&gt;xdsClient&lt;/code&gt; æ˜¯ xds åè®®çš„å®¢æˆ·ç«¯ã€‚å…³äº xds, Envoy é€šè¿‡æŸ¥è¯¢æ–‡ä»¶æˆ–ç®¡ç†æœåŠ¡å™¨æ¥åŠ¨æ€å‘ç°èµ„æºã€‚æ¦‚æ‹¬åœ°è®²ï¼Œå¯¹åº”çš„å‘ç°æœåŠ¡åŠå…¶ç›¸åº”çš„ API è¢«ç§°ä½œ xDSã€‚mosn ä¹Ÿä½¿ç”¨ xDSï¼Œè¿™æ ·å°±å¯ä»¥å…¼å®¹ istioã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;inheritListeners&lt;/code&gt; å’Œ &lt;code&gt;reconfigure&lt;/code&gt; éƒ½æ˜¯ä¸ºäº†å®ç° MOSN çš„å¹³æ»‘å‡çº§å’Œé‡å¯ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä¹Ÿè¦æ³¨æ„åˆ° &lt;code&gt;inheritListeners&lt;/code&gt; å’Œ &lt;code&gt;reconfigure&lt;/code&gt; å‚æ•°ï¼ŒMOSN åœ¨å¯åŠ¨æ—¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;æµç¨‹ï¼šè¿™ç§æƒ…å†µä¸‹æ˜¯ MOSN ä½œä¸º sidecar ç¬¬ä¸€æ¬¡åœ¨ Pod ä¸­å¯åŠ¨ï¼Œä¸éœ€è¦è€ƒè™‘é•¿è¿æ¥è½¬ç§»ç­‰æƒ…å†µã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;æµç¨‹ï¼šåœ¨ MOSN å·²ç»ä½œä¸º sidecar è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ­¤æ—¶è¦åš MOSN çš„å‡çº§/é‡å¯ï¼Œåˆ™å¿…é¡»è¦è€ƒè™‘å½“å‰ MOSN ä¸Šå·²æœ‰çš„é•¿è¿æ¥ï¼Œå¦‚æœç›´æ¥æ–­å¼€è¿æ¥é‡å¯ï¼Œè‚¯å®šä¼šå¯¹ä¸šåŠ¡æœ‰å½±å“ã€‚æ‰€ä»¥ MOSN åœ¨å‡çº§/é‡å¯æ—¶ï¼Œä¼šè¿›è¡Œæ¯”è¾ƒå¤æ‚çš„é•¿è¿æ¥è½¬ç§»çš„å·¥ä½œã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨äº†è§£ä»¥ä¸Šå†…å®¹çš„å‰æä¸‹ï¼Œç°åœ¨æˆ‘ä»¬å¼€å§‹å…·ä½“åˆ†æã€‚&lt;/p&gt;
&lt;p&gt;NewMosnå‡½æ•°åœ¨63è¡Œå·¦å³ï¼Œä¸€ä¸Šæ¥å°±å¼€å§‹åˆå§‹åŒ–å„ç§é…ç½®ã€‚æ¯”å¦‚æ—¥å¿—ï¼Œè¿›ç¨‹idè·¯å¾„ï¼Œunix socket è·¯å¾„ï¼Œtraceçš„å¼€å…³ï¼ˆSOFATracerï¼‰ä»¥åŠæ—¥å¿—æ’ä»¶ç­‰ç­‰ã€‚è¿™é‡Œçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å…·ä½“åˆ†ææ¯ä¸ªæ–¹æ³•äº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;initializeDefaultPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetConfigPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;initializePidFile&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pid&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;initializeTracing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Tracing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;initializePlugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LogBase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸‹é¢å¤§æ¦‚åœ¨ 70 è¡Œå·¦å³ï¼Œä¸»è¦å¼€å§‹åšlistenerçš„è½¬ç§»ã€‚&lt;/p&gt;
&lt;p&gt;æ³¨æ„ï¼šä¸ºäº†è´´å‡ºæ¥çš„ä»£ç å¯ä»¥ç®€å•ï¼Œæˆ‘åˆ é™¤äº†ä¸€äº›é”™è¯¯å¤„ç†å’Œæ—¥å¿—çš„è¯­å¥ã€‚å¹¶åœ¨ä»£ç ä¸­æ·»åŠ äº†æ³¨é‡Šå¸®åŠ©ç†è§£&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//get inherit fds
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetInheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// set Mosn Active_Reconfiguring
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetMosnState&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Active_Reconfiguring&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// parse MOSNConfig again
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Load&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetConfigPath&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// start init services
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartService&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] start service failed: %v,  exit&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™æ®µä»£ç çš„ç¬¬ä¸€è¡Œè°ƒç”¨äº† &lt;code&gt;GetInheritListeners()&lt;/code&gt; æ¥è·å–è¦ç»§æ‰¿è¿‡æ¥çš„ç›‘å¬å™¨ã€‚ &lt;code&gt;reconfigure&lt;/code&gt; è¿™ä¸ªè¿”å›å€¼æ˜¯æ–°æ—§ MOSN åœ¨ &lt;code&gt;listen.sock&lt;/code&gt; ä¸Šçš„è¿æ¥ï¼Œå¦‚æœä¸ºç©ºä»£è¡¨äº† MOSN ä¸º&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œåä¹‹ä¸º&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ã€‚ä¸‹é¢å¼€å§‹åˆ†æ &lt;code&gt;GetInheritListeners()&lt;/code&gt;ã€‚åœ¨ &lt;code&gt;GetInheritListeners()&lt;/code&gt; ä¸­è°ƒç”¨äº† &lt;code&gt;isReconfigure()&lt;/code&gt; æ–¹æ³•ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;isReconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unixConn&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;unixConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DialTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;unix&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReconfigureDomainSocket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unixConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unixConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UnixConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Read&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œé€šè¿‡è¿æ¥ unix socket &lt;code&gt;reconfig.sock&lt;/code&gt;ï¼Œåˆ¤æ–­èƒ½å¦è¯»å–åˆ°æ•°æ®ã€‚æ—§ MOSN ä¼šç›‘å¬ &lt;code&gt;reconfig.sock&lt;/code&gt;ï¼Œåœ¨æœ‰è¿æ¥è¿›æ¥æ—¶å‘é€æ•°æ®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listen&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;unix&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReconfigureDomainSocket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;ul&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UnixListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ul&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AcceptUnix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœèƒ½è¯»åˆ°ï¼Œè¯´æ˜å·²ç»æœ‰ä¸€ä¸ªæ—§çš„ MOSN å¯åŠ¨å¹¶ç›‘å¬äº† &lt;code&gt;reconfig.sock&lt;/code&gt;ï¼Œé‚£ä¹ˆæœ¬æ¬¡å¯åŠ¨å°±æ˜¯&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;äº†ã€‚åŒæ—¶å‘ &lt;code&gt;reconfig.sock&lt;/code&gt; å‘èµ·è¿æ¥ï¼Œä¼šä½¿å¾—æ—§çš„ MOSN å°è¯•å‘ &lt;code&gt;listen.sock&lt;/code&gt; å‘é€è¦è½¬ç§»çš„ listener æ•°ç»„ã€‚è¿™ä¸ªé€»è¾‘åœ¨ä¸Šé¢çš„ &lt;code&gt;reconfigure(false)&lt;/code&gt; æ–¹æ³•ä¸­è°ƒç”¨ &lt;code&gt;sendInheritListeners()&lt;/code&gt; å®ç°ã€‚ä¸ºäº†ä¿è¯æ—§çš„ MOSN å¯ä»¥è¿ä¸Šæ–°çš„ MOSNï¼Œè¿™é‡Œè¿˜é‡è¯•äº†10æ¬¡ï¼Œå¹¶ä¸”æ¯æ¬¡ç­‰å¾…1sã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–° MOSN åœ¨æ¥ä¸‹æ¥ 10s å†…å¯ä»¥ç›‘å¬ &lt;code&gt;listen.sock&lt;/code&gt; å³å¯ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// retry 10 time
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;unixConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DialTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;unix&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransferListenDomainSocket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;break&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sleep&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åŒæ—¶ï¼Œè¯¥è¿æ¥åœ¨æ—§ MOSN ä¸­ä¿æŒ10åˆ†é’Ÿåï¼Œæˆ–è€…è¯»åˆ°äº†ä»£è¡¨è¦é€€å‡ºçš„æ•°æ®ï¼Œæ—§ MOSN å°±ä¼šè‡ªåŠ¨é€€å‡ºã€‚å¦‚æœæ˜¯ç¡®å®šäº†æ˜¯å‡çº§æˆ–é‡å¯ï¼Œé‚£ä¹ˆ &lt;code&gt;GetInheritListeners()&lt;/code&gt; è¿˜ä¼šç»§ç»­æ‰§è¡Œä»¥ä¸‹çš„ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// unlink ç³»ç»Ÿè°ƒç”¨æ¯”è¾ƒç‰¹æ®Šã€‚å…³äºå®ƒçš„æè¿°ä¸­æœ‰ä¸€ç‚¹ï¼šå¦‚æœè¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª unix socketï¼Œå®ƒä¼šè¢«ç§»é™¤ï¼Œä½†æ˜¯æ‰“å¼€å®ƒçš„è¿›ç¨‹å¯ä»¥ç»§ç»­ä½¿ç”¨å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´æ–°æ—§ mosn éƒ½ä¼šåœ¨è¿™ä¸ªåœ°å€ç›‘å¬ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;syscall&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlink&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransferListenDomainSocket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç›‘å¬
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listen&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;unix&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransferListenDomainSocket&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;ul&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UnixListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;ul&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetDeadline&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Add&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ul&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AcceptUnix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;oob&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1024&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oobn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReadMsgUnix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oob&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;scms&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseSocketControlMessage&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;oob&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;oobn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;scms&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[server] expected 1 SocketControlMessage; got scms = %#v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;scms&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è§£æä»å¦ä¸€ä¸ªè¿›ç¨‹ä¼ æ¥çš„socketæ§åˆ¶æ¶ˆæ¯ï¼šæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•´å‹æ•°ç»„
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gotFds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseUnixRights&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;scms&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gotFds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™ä¸ªå¾ªç¯ä¸­å°†æ–‡ä»¶æè¿°ç¬¦è½¬æ¢æˆäº†listener
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gotFds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;fd&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;uintptr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gotFds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;file&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewFile&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;file&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;fileListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FileListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;file&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fileListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TCPListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;not a tcp listener&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢çš„ä»£ç ä¸­æ–°çš„ MOSN ç›‘å¬äº† &lt;code&gt;listen.sock&lt;/code&gt;ï¼Œè¿™æ ·å°±èƒ½è·å–åˆ°æ—§ MOSN çš„æ‰€æœ‰ listenerã€‚å½“ç„¶ï¼Œå¦‚æœæœ¬æ¬¡å¯åŠ¨æ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œé‚£ä¹ˆè·å–çš„ &lt;code&gt;inheritListeners&lt;/code&gt; å°±æ˜¯ nilã€‚ç„¶åæ ¹æ®æœ¬æ¬¡å¯åŠ¨æ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;è¿˜æ˜¯&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæ˜¯æ™®é€šå¯åŠ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨ &lt;code&gt;StartService&lt;/code&gt;ã€‚éœ€è¦æ³¨æ„åœ¨åé¢çš„æ‰§è¡Œæµç¨‹ä¸­ï¼Œè¿˜ä¼šå†ä¸€æ¬¡è°ƒç”¨ &lt;code&gt;StartService&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ï¼Œè®¾ç½®å½“å‰çŠ¶æ€ä¸º &lt;code&gt;Active_Reconfiguring&lt;/code&gt;ï¼Œç„¶åé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ³¨æ„åœ¨æ­¤æ—¶å¹¶æ²¡æœ‰è°ƒç”¨ &lt;code&gt;StartService&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› ä¸ºåé¢è¿˜ä¼šæœ‰&lt;code&gt;StartService&lt;/code&gt;çš„è°ƒç”¨ï¼Œå› æ­¤ &lt;code&gt;StartService&lt;/code&gt; çš„é€»è¾‘åœ¨åé¢åˆ†æï¼Œä»¥ä¾¿ç†è§£åœ¨ä¸åŒåœ°æ–¹è°ƒç”¨çš„é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;88 è¡Œçš„ &lt;code&gt;initializeMetrics(c.Metrics)&lt;/code&gt; åˆå§‹åŒ–äº†ç›‘æ§æŒ‡æ ‡ï¼Œä½¿ç”¨äº† &lt;code&gt;go-metrics&lt;/code&gt;ã€‚è¿™é‡Œä¸åšåˆ†æã€‚&lt;/p&gt;
&lt;p&gt;90 è¡Œå¼€å§‹æ˜¯ Mosn å®ä¾‹çš„åˆå§‹åŒ–ã€‚å®ƒä¼ å…¥äº†ä¸Šé¢çš„ &lt;code&gt;inheritListeners&lt;/code&gt; å’Œ &lt;code&gt;reconfigure&lt;/code&gt; å˜é‡ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;           &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;wg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;               &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitGroup&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;      &lt;span style=&#34;color:#000&#34;&gt;reconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;123 è¡Œå¼€å§‹æ˜¯ &lt;code&gt;clustermanager&lt;/code&gt; çš„åˆå§‹åŒ–ï¼Œå®ƒä¼šæ ¹æ®æ˜¯å¦æ˜¯ Xds æ¨¡å¼æ¥é€‰æ‹©ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚å¦‚æœæ˜¯ Xds, åˆ™å…ˆç”¨ç©ºé…ç½®åˆå§‹åŒ–ï¼Œé›†ç¾¤ä¿¡æ¯ä¼šåœ¨ä¹‹åé€šè¿‡ Xds æ¥è·å–ï¼Œå¦åˆ™çš„è¯å°±ç”¨é…ç½®æ–‡ä»¶æ¥åˆå§‹åŒ–ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//cluster manager filter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cmf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterManagerFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// parse cluster all in one
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clusterMap&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseClusterConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// create cluster manager
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mode&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Xds&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clustermanager&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewClusterManagerSingleton&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clustermanager&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewClusterManagerSingleton&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clusterMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;136 è¡Œæ˜¯è·¯ç”±ç®¡ç†å™¨çš„åˆå§‹åŒ–&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// initialize the routerManager
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerManager&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;router&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewRouterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;138 è¡Œå¼€å§‹å°±æ˜¯å¯¹é…ç½®ä¸­çš„ servers è¿›è¡Œè§£æï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢çš„ä¸€å¤„åˆ¤æ–­å¾—çŸ¥ï¼Œå½“å‰ MOSN åªä¼šæœ‰ä¸€ä¸ª serverï¼Œè¿™é‡Œçš„ for å¾ªç¯åº”è¯¥æ˜¯ä¸ºäº†ä¹‹ååŠŸèƒ½æ‰©å±•å‡†å¤‡çš„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;srvNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Servers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srvNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] no server found&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srvNum&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] multiple server not supported yet, got %d&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srvNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;for å¾ªç¯çš„ä»£ç ï¼Œå…·ä½“æ‰§è¡Œçš„é€»è¾‘æˆ‘ç”¨æ³¨é‡Šå†™åœ¨äº†ä»£ç ä¸Šã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Servers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//1. server config prepare
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//server config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseServerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// new server config
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init default log
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitDefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mode&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Xds&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// xds æ¨¡å¼ä¸‹ï¼Œserver çš„é…ç½®æ˜¯åœ¨ä¸Šé¢åˆ›å»ºçš„
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewServer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clustermanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™é‡Œçš„serveré…ç½®æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–çš„ï¼Œ å¯ä»¥çœ‹ configs ä¸‹é…ç½®æ–‡ä»¶æ¥å¸®åŠ©ç†è§£
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//initialize server instance
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewServer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clustermanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//add listener
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] no listener found&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// parse ListenerConfigï¼Œ è¿™é‡Œé¢ä¼šè§£æ listeners çš„é…ç½®ï¼Œå¹¶ä¸”å’Œ inheritListeners ä¸­çš„ listener æ¯”å¯¹ï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªè¿æ¥(ç«¯å£å·ç›¸åŒï¼Œipé…ç½®ç›¸åŒ)ï¼Œå°±ç»§æ‰¿è¿‡æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseListenerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;],&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;inheritListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// parse routers from connection_manager filter and add it the routerManager
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseRouterConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChains&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouterConfigName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddOrUpdateRouters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;routerConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterChainFactory&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Note: as we use fasthttp and net/http2.0, the IO we created in mosn should be disabled
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// network filters
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UseOriginalDst&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// network and stream filters
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetNetworkFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChains&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;sfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

			&lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sfcf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Fatalf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[mosn] [NewMosn] AddListener error:%s&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢å°±æ˜¯ MOSN åˆå§‹åŒ–çš„åˆ†æã€‚ä¸»è¦åšäº†ä¸‹åˆ—çš„å·¥ä½œï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åˆå§‹åŒ–é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œæ—¥å¿—ï¼Œè¿›ç¨‹idè·¯å¾„ï¼Œunix socket è·¯å¾„ï¼Œtraceçš„å¼€å…³ï¼ˆSOFATracerï¼‰ä»¥åŠæ—¥å¿—æ’ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡ &lt;code&gt;server.GetInheritListeners()&lt;/code&gt; æ¥åˆ¤æ–­å¯åŠ¨æ¨¡å¼ï¼ˆ&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;æˆ–&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ï¼‰ï¼Œå¹¶åœ¨&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;çš„æƒ…å†µä¸‹ç»§æ‰¿æ—§ MOSN çš„ç›‘å¬å™¨æ–‡ä»¶æè¿°ç¬¦ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ï¼Œåˆ™è®¾ç½® Mosn çŠ¶æ€ä¸º &lt;code&gt;Active_Reconfiguring&lt;/code&gt;;å¦‚æœæ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œåˆ™ç›´æ¥è°ƒç”¨ &lt;code&gt;StartService()&lt;/code&gt;ï¼Œå…³äº &lt;code&gt;StartService&lt;/code&gt; ä¼šåœ¨ä¹‹ååˆ†æã€‚&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–æŒ‡æ ‡æœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;æ ¹æ®æ˜¯å¦æ˜¯ Xds æ¨¡å¼åˆå§‹åŒ–é…ç½®ã€‚
&lt;ul&gt;
&lt;li&gt;xds æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ nil æ¥åˆå§‹åŒ– clustermanager, é Xds æ¨¡å¼ä¸‹(ä¹Ÿå°±æ˜¯File, Mixæ¨¡å¼) ï¼Œä»é…ç½®æ–‡ä»¶ä¸­åˆå§‹åŒ– clustermanager&lt;/li&gt;
&lt;li&gt;xds æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨é»˜è®¤é…ç½®æ¥å®ä¾‹åŒ– routerManager, é Xds æ¨¡å¼ä¸‹ï¼Œåˆå§‹åŒ– routerManagerï¼Œå¹¶ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–è·¯ç”±é…ç½®æ›´æ–°&lt;/li&gt;
&lt;li&gt;xds æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨é»˜è®¤é…ç½®æ¥å®ä¾‹åŒ– serverï¼Œé Xds æ¨¡å¼ä¸‹ï¼Œè¿˜è¦ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– listener å¹¶æ·»åŠ ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™é‡Œä¹Ÿç”¨æ—¶åºå›¾æ¥å±•ç¤º&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;çš„åˆå§‹åŒ–æµç¨‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;hot-upgrade-reload-newmosn.svg&#34; alt=&#34;hot-upgrade-reload newmosn&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœæ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œåˆ™6,7,8,9,10,11,12æ˜¯æ²¡æœ‰çš„ï¼Œå¹¶ä¸”åœ¨ç¬¬5æ­¥åä¼šè°ƒç”¨&lt;code&gt;StartService&lt;/code&gt;ã€‚ä¸ºäº†ä¾¿äºå¯¹æ¯”ï¼Œè¿™é‡Œä»ç„¶ç”¨æ—¶åºå›¾æ¥å±•ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;normal-newmosn.svg&#34; alt=&#34;normal newmosn&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;mosn-çš„å¯åŠ¨&#34;&gt;MOSN çš„å¯åŠ¨&lt;/h3&gt;
&lt;p&gt;MOSN å¯åŠ¨é€»è¾‘å®ç°åœ¨ Mosn çš„ &lt;code&gt;Start()&lt;/code&gt; æ–¹æ³•ä¸­ï¼Œä»£ç å¦‚ä¸‹&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;wg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Add&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Start XDS if configured
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;xdsClient&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;xds&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;xdsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// start mosn feature
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;featuregate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartInit&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// TODO: remove it
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//parse service registry info
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;configmanager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ParseServiceRegistry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServiceRegistry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// beforestart starts transfer connection and non-proxy listeners
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;beforeStart&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// start mosn server
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æˆ‘ä»¬ä»ä»£ç ä¸­å¯ä»¥çŸ¥é“ï¼Œ&lt;code&gt;Start()&lt;/code&gt; æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹çš„å·¥ä½œï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å¯åŠ¨ xdsClient, xdsClient è´Ÿè´£ä» pilot å‘¨æœŸåœ°æ‹‰å– listeners/clusters/clusterloadassignment é…ç½®ã€‚è¿™ä¸ªç‰¹æ€§ä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡ crd æ¥åŠ¨æ€çš„æ”¹å˜ service mesh ä¸­çš„ç­–ç•¥ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¼€å§‹æ‰§è¡Œæ‰€æœ‰æ³¨å†Œåœ¨ featuregateä¸­ feature çš„åˆå§‹åŒ–å‡½æ•°ã€‚åœ¨ &lt;code&gt;pkg/featuregate/mosn_features.go&lt;/code&gt; æ–‡ä»¶ä¸­çš„ &lt;code&gt;init()&lt;/code&gt; æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ° &lt;code&gt;XdsMtlsEnable&lt;/code&gt;ã€&lt;code&gt;PayLoadLimitEnabl	e&lt;/code&gt; å’Œ &lt;code&gt;MultiTenantMode&lt;/code&gt; çš„æ³¨å†Œã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è§£ææœåŠ¡æ³¨å†Œä¿¡æ¯&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MOSN å¯åŠ¨å‰çš„å‡†å¤‡å·¥ä½œã€‚è¯¦ç»†è§£æè§ä¸‹é¢çš„å°ç« èŠ‚ 2.2.1&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ­£å¼å¯åŠ¨ MOSN çš„æœåŠ¡ã€‚è¯¦ç»†è§£æè§ä¸‹é¢çš„å°ç« èŠ‚ 2.2.2&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;beforestart-mosn-å¯åŠ¨å‰çš„æœ€åä¸€æ­¥&#34;&gt;beforeStart(): MOSN å¯åŠ¨å‰çš„æœ€åä¸€æ­¥&lt;/h4&gt;
&lt;p&gt;beforeStart ä¸­ä¸»è¦åšäº†ä»¥ä¸‹çš„å‡ ä¸ªå·¥ä½œï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ„é€  adminServerï¼Œå°† admin server åŠ å…¥åˆ°å…¨å±€çš„ services ä¸­&lt;/li&gt;
&lt;li&gt;æ ¹æ® MOSN çš„çŠ¶æ€æ˜¯å¦æ˜¯ &lt;code&gt;Active_Reconfiguring&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;ï¼Œè°ƒç”¨ &lt;code&gt;store.&lt;/code&gt;StartService(m.inheritListeners)ï¼Œç»§æ‰¿ listener ç›´æ¥å¯åŠ¨ã€‚é€šçŸ¥æ—§ MOSN é€€å‡ºï¼Œå¹¶ä»æ—§ MOSN ä¸­è½¬ç§»é•¿è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œ&lt;code&gt;store.StartService(nil)&lt;/code&gt; ä¼šå…ˆç›‘å¬ listeneråœ¨å¯åŠ¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;å…³é—­é—ç•™çš„ listenerï¼Œä¹Ÿå°±æ˜¯åœ¨ç¬¬ 2 æ­¥ä¸­æ²¡æœ‰ä½¿ç”¨çš„ lisenter&lt;/li&gt;
&lt;li&gt;å¼€å¯ dump config&lt;/li&gt;
&lt;li&gt;ç›‘å¬ reconfig.sockï¼Œè¿™æ ·å°±å¯ä»¥æ¥æ”¶ä¸‹ä¸€æ¬¡çš„å¹³æ»‘å‡çº§æˆ–é‡å¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸‹ &lt;code&gt;store.StartService&lt;/code&gt; çš„è°ƒç”¨é€»è¾‘ï¼Œå› ä¸ºåœ¨å‰æ–‡æåˆ°ï¼Œåˆå§‹åŒ– MOSN çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;ï¼Œåˆ™ä¼šè°ƒç”¨ä¸€æ¬¡ &lt;code&gt;store.StartService&lt;/code&gt;ã€‚è€Œ&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;åˆ™ä¸ä¼šè°ƒç”¨ã€‚è€Œåé¢æ— è®ºä½•ç§æƒ…å†µéƒ½ä¼šè°ƒç”¨&lt;code&gt;store.StartService&lt;/code&gt;ï¼Œæ˜¯å¦å¤šæ­¤ä¸€ä¸¾å‘¢ï¼Ÿé€šè¿‡æ³¨é‡Šå¯ä»¥å‘ç°ï¼Œå‰é¢æ˜¯ &lt;code&gt;start init services&lt;/code&gt;ï¼Œåé¢æ˜¯ &lt;code&gt;start other services&lt;/code&gt;ï¼ŒåŒæ—¶ &lt;code&gt;service&lt;/code&gt; çš„ç»“æ„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;start&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;http&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Server&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;exit&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œæƒ³è¡¨è¾¾çš„é€»è¾‘åº”è¯¥æ˜¯ï¼Œå¦‚æœæ˜¯æ™®é€šå¯åŠ¨ï¼Œé‚£ä¹ˆæœ‰ä¸€äº›å…·æœ‰ init å˜é‡çš„æœåŠ¡éœ€è¦æå‰å¯åŠ¨ã€‚åœ¨ &lt;code&gt;StartService&lt;/code&gt; ä¸­ä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸ªæƒ³æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½†æ˜¯åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æˆ‘åªæ‰¾åˆ°äº†ä¸‰å¤„ serviceï¼Œæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ã€‚è¿™é‡Œå¯èƒ½æ˜¯ä¸ºäº†ä¹‹åçš„åŠŸèƒ½æ‰©å±•ä½¿ç”¨çš„ã€‚ä¸‰å¤„ service å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;store.AddService(s, &amp;ldquo;pprof&amp;rdquo;, nil, nil)&lt;/li&gt;
&lt;li&gt;store.AddService(srv, &amp;ldquo;Mosn Admin Server&amp;rdquo;, nil, nil)&lt;/li&gt;
&lt;li&gt;store.AddService(srv, &amp;ldquo;prometheus&amp;rdquo;, nil, nil)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› ä¸º&lt;code&gt;æ™®é€šå¯åŠ¨&lt;/code&gt;æ—¶åªæœ‰&lt;code&gt;store.StartService(nil)&lt;/code&gt;ï¼Œ å› æ­¤æˆ‘ä»¬è¿™é‡Œæ¥ç€åˆ†æåœ¨&lt;code&gt;çƒ­å‡çº§/é‡å¯&lt;/code&gt;æ—¶çš„é•¿è¿æ¥è½¬ç§»é€»è¾‘ã€‚åœ¨åˆå§‹åŒ– MOSN éƒ¨åˆ†ï¼Œæ–°çš„ MOSN å®ä¾‹å·²ç»ç»§æ‰¿è¿‡æ¥ listener äº†ï¼Œä¸ºäº†å®ç°å¹³æ»‘çš„å‡çº§æˆ–é‡å¯ï¼Œè¿˜éœ€è¦æŠŠæ—§ MOSN ä¸Šçš„è¿æ¥ä¹Ÿè½¬ç§»è¿‡æ¥ã€‚åœ¨ 2.1 å°ç« èŠ‚ä¸­è¯´åˆ°ï¼Œ&lt;code&gt;GetInheritListeners()&lt;/code&gt; æ–¹æ³•é€šè¿‡ç›‘å¬ &lt;code&gt;listen.sock&lt;/code&gt;ï¼Œç»§æ‰¿äº†æ—§ MOSN ä¸­çš„ listenerã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡ç»§æ‰¿è¿‡æ¥çš„ listener åœ¨æ–° MOSN ä¸­å¯åŠ¨æœåŠ¡ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// start other services
if err := store.StartService(m.inheritListeners); err != nil {
	log.StartLogger.Fatalf(&amp;quot;[mosn] [NewMosn] start service failed: %v,  exit&amp;quot;, err)
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;åŒæ—¶æ–° MOSN å®ä¾‹æ‹¥æœ‰äº†ä¸€ä¸ªå«åš reconfigureï¼ˆä¸è¦è¢«åå­—è¯¯å¯¼äº†ï¼Œå®ƒæ˜¯æ–°æ—§ MOSN åœ¨ listen.sock ä¸Šçš„è¿æ¥ï¼‰ çš„è¿æ¥ã€‚è¯¥è¿æ¥ä¼šåœ¨æ—§ MOSN ä¸­ä¿æŒ10åˆ†é’Ÿæˆ–è€…è¯»åˆ°äº†ä»£è¡¨è¦é€€å‡ºçš„æ•°æ®ã€‚åœ¨ beforeStart ä¸­ï¼Œå°±æ˜¯ä½¿ç”¨äº† reconfigure æ¥åœ¨æ–° MOSN å³å°†å¯åŠ¨ä¹‹é™…ï¼Œé€šçŸ¥æ—§çš„ MOSN é€€å‡ºã€‚å¯ä»¥çœ‹ &lt;code&gt;pkg/mosn/starter.go&lt;/code&gt; çš„ 202 è¡Œå·¦å³ã€‚ä¸‹é¢ä¸€å°æ®µä»£ç ä¸­ï¼Œå‘ reconfigure è¿æ¥å†™å…¥äº†ä¸€ä¸ª 0 æ¥é€šçŸ¥æ—§ Mosn é€€å‡ºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// notify old mosn to transfer connection
if _, err := m.reconfigure.Write([]byte{0}); err != nil {
	log.StartLogger.Fatalf(&amp;quot;[mosn] [NewMosn] graceful failed, exit&amp;quot;)
}

m.reconfigure.Close()
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ—§çš„ MOSN åœ¨è¯»åˆ°ä¸Šé¢çš„ 0 åï¼Œä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åœæ­¢æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯å…³é—­æ•°æ®å¹³é¢&lt;/li&gt;
&lt;li&gt;ç­‰å¾…3sï¼Œè¿™æ˜¯ä¸ºäº†æ–°çš„ MOSN å¯åŠ¨&lt;/li&gt;
&lt;li&gt;åœæ­¢ acceptï¼Œè¿™æ—¶å€™å°±ä¸ä¼šæœ‰æ–°çš„è¿æ¥åˆ°æ—§çš„ MOSN ä¸Šäº†&lt;/li&gt;
&lt;li&gt;ç­‰å¾…å·²æœ‰è¿æ¥å®Œæˆé€»è¾‘ã€‚é»˜è®¤æ˜¯ 30s&lt;/li&gt;
&lt;li&gt;é€€å‡º&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä»£ç åœ¨ &lt;code&gt;pkg/server/reconfigure.go&lt;/code&gt; çš„ 87 è¡Œå·¦å³ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Wait new mosn parse configuration
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;notify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetReadDeadline&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Add&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Minute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;notify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Read&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[:])&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alertf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ErrorKeyReconfigure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;new mosn start failed&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// stop other services
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StopService&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Wait for new mosn start
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sleep&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Stop accepting requests
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StopAccept&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Wait for all connections to be finished
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitConnectionsDone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GracefulTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Infof&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[server] [reconfigure] process %d gracefully shutdown&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Getpid&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;

&lt;span style=&#34;color:#000&#34;&gt;keeper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ExecuteShutdownCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Stop the old server, all the connections have been closed and the new one is running
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Exit&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å†å›æ¥çœ‹é•¿è¿æ¥çš„è½¬ç§»ã€‚æ–° MOSN åœ¨é€šçŸ¥ä¹‹åï¼Œä¼šç«‹å³å¯åŠ¨ TransferServerï¼Œä¹Ÿå°±æ˜¯è½¬ç§»é•¿è¿æ¥çš„æœåŠ¡ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// transfer old mosn connections
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;network&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransferServer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Handler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ—§ MOSN ä¼šé€šè¿‡ &lt;code&gt;conn.sock&lt;/code&gt; æ¥å‘é€é•¿è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ç»™æ–° MOSNã€‚å…·ä½“è°ƒç”¨çš„æ–¹æ³•æ˜¯&lt;code&gt;pkg/network/transfer.go&lt;/code&gt;ä¸­çš„&lt;code&gt;transferRead&lt;/code&gt; å’Œ &lt;code&gt;transferWrite&lt;/code&gt; æ–¹æ³•ã€‚å…³äºé•¿è¿æ¥è½¬ç§»çš„ç»†èŠ‚éå¸¸å¤æ‚ï¼ŒMOSN å®˜ç½‘ä¸Šæä¾›äº†è¯¦ç»†çš„æ–‡æ¡£ï¼Œå¾ˆå€¼å¾—å­¦ä¹ ï¼š&lt;a href=&#34;https://mosn.io/docs/concept/smooth-upgrade/&#34;&gt;MOSN å¹³æ»‘å‡çº§åŸç†è§£æ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬ç”¨æ—¶åºå›¾æ¥å±•ç¤ºä¸€ä¸‹é•¿è¿æ¥çš„è½¬ç§»è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;transfer-conn.svg&#34; alt=&#34;conn transfer&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;start-mosn-æ­£å¼å¯åŠ¨&#34;&gt;Start(): MOSN æ­£å¼å¯åŠ¨&lt;/h4&gt;
&lt;p&gt;ç»è¿‡ä¸Šé¢å¤æ‚çš„å¯åŠ¨è¿‡ç¨‹ï¼ŒMOSN æ­£å¼å¯åŠ¨å°±å¾ˆç®€å•äº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;m&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;servers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯¹äºå½“å‰æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ª serverï¼Œè¿™ä¸ª server æ˜¯åœ¨ NewMosn ä¸­åˆå§‹åŒ–çš„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;serverName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServerName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}),&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;handler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;NewHandler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cmFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clMng&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Start æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// TODO: handle main thread panic @wugou
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;srv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;åŸºæœ¬æœ¯è¯­å‚è€ƒ&#34;&gt;åŸºæœ¬æœ¯è¯­å‚è€ƒ&lt;/h2&gt;
&lt;p&gt;ä¸‹é¢åŸºæœ¬æœ¯è¯­çš„è§£é‡Šæ¥è‡ªäºè¿™ç¯‡æ–‡ç« ï¼š&lt;a href=&#34;https://jimmysong.io/istio-handbook/data-plane/envoy-terminology.html&#34;&gt;Envoy ä¸­çš„åŸºæœ¬æœ¯è¯­&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Hostï¼šèƒ½å¤Ÿè¿›è¡Œç½‘ç»œé€šä¿¡çš„å®ä½“ï¼ˆåœ¨æ‰‹æœºæˆ–æœåŠ¡å™¨ç­‰ä¸Šçš„åº”ç”¨ç¨‹åºï¼‰ã€‚åœ¨ Envoy ä¸­ä¸»æœºæ˜¯æŒ‡é€»è¾‘ç½‘ç»œåº”ç”¨ç¨‹åºã€‚åªè¦æ¯å°ä¸»æœºéƒ½å¯ä»¥ç‹¬ç«‹å¯»å€ï¼Œä¸€å—ç‰©ç†ç¡¬ä»¶ä¸Šå°±è¿è¡Œå¤šä¸ªä¸»æœºã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Downstreamï¼šä¸‹æ¸¸ï¼ˆdownstreamï¼‰ä¸»æœºè¿æ¥åˆ° Envoyï¼Œå‘é€è¯·æ±‚å¹¶æˆ–è·å¾—å“åº”ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Upstreamï¼šä¸Šæ¸¸ï¼ˆupstreamï¼‰ä¸»æœºè·å–æ¥è‡ª Envoy çš„é“¾æ¥è¯·æ±‚å’Œå“åº”ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Cluster: é›†ç¾¤ï¼ˆclusterï¼‰æ˜¯ Envoy è¿æ¥åˆ°çš„ä¸€ç»„é€»è¾‘ä¸Šç›¸ä¼¼çš„ä¸Šæ¸¸ä¸»æœºã€‚Envoy é€šè¿‡æœåŠ¡å‘ç°å‘ç°é›†ç¾¤ä¸­çš„æˆå‘˜ã€‚Envoy å¯ä»¥é€šè¿‡ä¸»åŠ¨è¿è¡ŒçŠ¶å†µæ£€æŸ¥æ¥ç¡®å®šé›†ç¾¤æˆå‘˜çš„å¥åº·çŠ¶å†µã€‚Envoy å¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤æˆå‘˜ç”±è´Ÿè½½å‡è¡¡ç­–ç•¥ç¡®å®šã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Meshï¼šä¸€ç»„äº’ç›¸åè°ƒä»¥æä¾›ä¸€è‡´ç½‘ç»œæ‹“æ‰‘çš„ä¸»æœºã€‚Envoy mesh æ˜¯æŒ‡ä¸€ç»„ Envoy ä»£ç†ï¼Œå®ƒä»¬æ„æˆäº†ç”±å¤šç§ä¸åŒæœåŠ¡å’Œåº”ç”¨ç¨‹åºå¹³å°ç»„æˆçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¶ˆæ¯ä¼ é€’åŸºç¡€ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è¿è¡Œæ—¶é…ç½®ï¼šä¸ Envoy ä¸€èµ·éƒ¨ç½²çš„å¸¦å¤–å®æ—¶é…ç½®ç³»ç»Ÿã€‚å¯ä»¥åœ¨æ— éœ€é‡å¯ Envoy æˆ– æ›´æ”¹ Envoy ä¸»é…ç½®çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ›´æ”¹è®¾ç½®æ¥å½±å“æ“ä½œã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Listener: ç›‘å¬å™¨ï¼ˆlistenerï¼‰æ˜¯å¯ä»¥ç”±ä¸‹æ¸¸å®¢æˆ·ç«¯è¿æ¥çš„å‘½åç½‘ç»œä½ç½®ï¼ˆä¾‹å¦‚ï¼Œç«¯å£ã€unixåŸŸå¥—æ¥å­—ç­‰ï¼‰ã€‚Envoy å…¬å¼€ä¸€ä¸ªæˆ–å¤šä¸ªä¸‹æ¸¸ä¸»æœºè¿æ¥çš„ä¾¦å¬å™¨ã€‚ä¸€èˆ¬æ˜¯æ¯å°ä¸»æœºè¿è¡Œä¸€ä¸ª Envoyï¼Œä½¿ç”¨å•è¿›ç¨‹è¿è¡Œï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¯åŠ¨ä»»æ„æ•°é‡çš„ Listenerï¼ˆç›‘å¬å™¨ï¼‰ï¼Œç›®å‰åªç›‘å¬ TCPï¼Œæ¯ä¸ªç›‘å¬å™¨éƒ½ç‹¬ç«‹é…ç½®ä¸€å®šæ•°é‡çš„ï¼ˆL3/L4ï¼‰ç½‘ç»œè¿‡æ»¤å™¨ã€‚Listenter ä¹Ÿå¯ä»¥é€šè¿‡ Listener Discovery Serviceï¼ˆLDSï¼‰åŠ¨æ€è·å–ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Listener filterï¼šListener ä½¿ç”¨ listener filterï¼ˆç›‘å¬å™¨è¿‡æ»¤å™¨ï¼‰æ¥æ“ä½œé“¾æ¥çš„å…ƒæ•°æ®ã€‚å®ƒçš„ä½œç”¨æ˜¯åœ¨ä¸æ›´æ”¹ Envoy çš„æ ¸å¿ƒåŠŸèƒ½çš„æƒ…å†µä¸‹æ·»åŠ æ›´å¤šçš„é›†æˆåŠŸèƒ½ã€‚Listener filter çš„ API ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºè¿™äº›è¿‡æ»¤å™¨æœ€ç»ˆæ˜¯åœ¨æ–°æ¥å—çš„å¥—æ¥å­—ä¸Šè¿è¡Œã€‚åœ¨é“¾ä¸­å¯ä»¥äº’ç›¸è¡”æ¥ä»¥æ”¯æŒæ›´å¤æ‚çš„åœºæ™¯ï¼Œä¾‹å¦‚è°ƒç”¨é€Ÿç‡é™åˆ¶ã€‚Envoy å·²ç»åŒ…å«äº†å¤šä¸ªç›‘å¬å™¨è¿‡æ»¤å™¨ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Http Route Tableï¼šHTTP çš„è·¯ç”±è§„åˆ™ï¼Œä¾‹å¦‚è¯·æ±‚çš„åŸŸåï¼ŒPath ç¬¦åˆä»€ä¹ˆè§„åˆ™ï¼Œè½¬å‘ç»™å“ªä¸ª Clusterã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Health checkingï¼šå¥åº·æ£€æŸ¥ä¼šä¸SDSæœåŠ¡å‘ç°é…åˆä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå³ä½¿ä½¿ç”¨å…¶ä»–æœåŠ¡å‘ç°æ–¹å¼ï¼Œä¹Ÿæœ‰ç›¸åº”éœ€è¦è¿›è¡Œä¸»åŠ¨å¥åº·æ£€æŸ¥çš„æƒ…å†µã€‚è¯¦è§ health checkingã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://jimmysong.io/istio-handbook/data-plane/envoy-terminology.html&#34;&gt;Envoy ä¸­çš„åŸºæœ¬æœ¯è¯­&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://skyao.io/post/201804-servicemesh-architecture-introspection/&#34;&gt;Service Mesh æ¶æ„åæ€ï¼šæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢çš„ç•Œçº¿è¯¥å¦‚ä½•åˆ’å®šï¼Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.cnblogs.com/163yun/p/8962278.html&#34;&gt;æ·±å…¥è§£è¯» Service Mesh èƒŒåçš„æŠ€æœ¯ç»†èŠ‚&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.servicemesher.com/blog/back-to-microservices-with-istio-p1/&#34;&gt;ä½¿ç”¨ Istio æ‰“é€ å¾®æœåŠ¡ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.servicemesher.com/blog/microservice-with-service-mesh-at-ant-financial/&#34;&gt;èš‚èšé›†å›¢ Service Mesh æ–°å‹ç½‘ç»œä»£ç†çš„æ€è€ƒä¸å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://mosn.io/docs/concept/smooth-upgrade/&#34;&gt;MOSN å¹³æ»‘å‡çº§åŸç†è§£æ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - åç¨‹æ¨¡å‹</title>
      <link>https://mosn.io/blog/code/mosn-eventloop/</link>
      <pubDate>Tue, 25 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-eventloop/</guid>
      <description>
        
        
        &lt;h2 id=&#34;åŸºæœ¬æ¦‚å¿µ&#34;&gt;åŸºæœ¬æ¦‚å¿µ&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;concept.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;MOSN ä¸­çš„æ¦‚å¿µæ¯”è¾ƒå¤šï¼Œä»¥&lt;code&gt;sofarpc-sample&lt;/code&gt;ä¸‹é¢çš„&lt;code&gt;config.json&lt;/code&gt;ä¸ºä¾‹ï¼Œç»“åˆä¸Šå›¾ä¾æ¬¡çœ‹ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Downstreamï¼šè°ƒç”¨ç«¯çš„æ•°æ®æµå‘ç»Ÿç§°ã€‚&lt;/li&gt;
&lt;li&gt;Upstreamï¼šæœåŠ¡ç«¯çš„æ•°æ®æµå‘ç»Ÿç§°ã€‚&lt;/li&gt;
&lt;li&gt;clientListenerï¼šç”¨äºæ¥æ”¶è°ƒç”¨ç«¯ï¼ˆä¸šåŠ¡è¿›ç¨‹ï¼‰è¯·æ±‚æ•°æ®çš„ç›‘å¬ç«¯å£ã€‚&lt;/li&gt;
&lt;li&gt;serverListenerï¼šä½œä¸ºæœåŠ¡ç«¯æµé‡ä»£ç†ï¼Œç”¨äºæ¥æ”¶è°ƒç”¨ç«¯çš„è¯·æ±‚&lt;/li&gt;
&lt;li&gt;clientClusterï¼šæœåŠ¡æä¾›è€…çš„åœ°å€åˆ—è¡¨ï¼Œå®é™…åº”ç”¨ä¸­è¿™å—æ•°æ®åº”è¯¥æ¥è‡ªäºæ³¨å†Œä¸­å¿ƒã€‚&lt;/li&gt;
&lt;li&gt;serverClusterï¼šçœŸæ­£æä¾›æœåŠ¡çš„ä¸šåŠ¡è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªMOSNå¯ä»¥ä»£ç†å¤šä¸ªæœåŠ¡ç«¯è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;æµç¨‹æ¦‚è¿°&#34;&gt;æµç¨‹æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;eventloop.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯å®˜æ–¹æä¾›çš„ä¸€å¼ æµç¨‹å›¾ï¼Œå·²ç»å¾ˆæ¸…æ™°äº†ï¼Œè¿™é‡Œç®€è¦è¯´æ˜ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MOSN æ— è®ºæ˜¯æ”¶åˆ°è°ƒç”¨ç«¯ï¼ˆDownstreamï¼‰å‘æ¥çš„è¯·æ±‚è¿˜æ˜¯æœåŠ¡ç«¯ï¼ˆUpstreamï¼‰å‘æ¥çš„å“åº”ï¼Œéƒ½éœ€è¦é€šè¿‡ç½‘ç»œå±‚ï¼Œç„¶åæ ¹æ®æŒ‡å®šåè®®è§£ç requestè·Ÿresponseï¼Œæœ€åäº¤ç»™streamå±‚å¤„ç†ï¼ˆå½“ç„¶è¿™ä¸­é—´ä¼šæœ‰å„å¼å„æ ·çš„è¿‡æ»¤å™¨é“¾å¯ä»¥è¿›è¡Œæ‰©å±•ï¼Œåé¢è·Ÿç€æºç ä¼šè¯´ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ç”±äº MOSN å¤¹åœ¨è°ƒç”¨ç«¯è·ŸæœåŠ¡ç«¯ä¸­é—´ï¼Œåˆ†åˆ«è·Ÿè°ƒç”¨ç«¯ã€æœåŠ¡ç«¯éƒ½ä¼šå»ºç«‹è¿æ¥ï¼Œå› æ­¤åœ¨streamå±‚é‡‡ç”¨çš„æ˜¯&lt;code&gt;åŒæ­¥é˜»å¡&lt;/code&gt;çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨ç«¯çš„è¯·æ±‚è½¬å‘å‡ºå»ä»¥åå¯¹åº”çš„åç¨‹å°±ä¼šæŒ‚èµ·ï¼Œåœ¨æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„å“åº”ä»¥åå†å”¤é†’è¯¥ç­‰å¾…åç¨‹ï¼Œè€Œå…³è”è¯·æ±‚è·Ÿå“åº”çš„å…³é”®å°±æ˜¯ requestIDã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ˜ç™½äº†å¤§è‡´æµç¨‹ä»¥åï¼Œä¸‹é¢å°±é€šè¿‡æºç æ¥åˆ†æä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æºç åˆ†æ&#34;&gt;æºç åˆ†æ&lt;/h2&gt;
&lt;p&gt;ä¸ºäº†ä¾¿äºç†è§£ï¼Œè¿™é‡Œä»ä¸‹å¾€ä¸Šçœ‹ï¼Œä¹Ÿå°±æ˜¯å…ˆä»ç½‘ç»œå±‚æ¥æ”¶æ•°æ®çš„é€»è¾‘å¼€å§‹ï¼Œä¸€æ­¥ä¸€æ­¥æ¥åˆ†æ MOSN æ˜¯æ€ä¹ˆåšç¼–è§£ç ï¼Œæ€ä¹ˆè½¬å‘è¯·æ±‚ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å‘èµ·è¯·æ±‚&#34;&gt;å‘èµ·è¯·æ±‚&lt;/h3&gt;
&lt;p&gt;MOSN å¯¹äºç½‘ç»œå±‚çš„æ“ä½œï¼Œæ— è®ºæ˜¯è°ƒç”¨ç«¯è¿˜æ˜¯æœåŠ¡ç«¯ï¼Œéƒ½å°è£…åœ¨&lt;code&gt;eventloop.go&lt;/code&gt;æ–‡ä»¶ä¸­ï¼Œæ¯å½“è¿æ¥å»ºç«‹ä»¥åï¼ŒMOSN éƒ½ä¼šå¼€å¯ä¸¤ä¸ªåç¨‹åˆ†åˆ«å¤„ç†è¯¥è¿æ¥ä¸Šçš„è¯»å†™æ“ä½œï¼Œåˆ†åˆ«å¯¹åº”&lt;code&gt;startReadLoop&lt;/code&gt;è·Ÿ&lt;code&gt;startWriteLoop&lt;/code&gt;ä¸¤ä¸ªæ–¹æ³•ã€‚&lt;/p&gt;
&lt;p&gt;å½“è°ƒç”¨ç«¯ï¼ˆä¸šåŠ¡è¿›ç¨‹ï¼‰å‘èµ·è¯·æ±‚æ—¶ï¼Œæ ¹æ®&lt;code&gt;clientListener&lt;/code&gt;æŒ‡å®šçš„åœ°å€è·Ÿ MOSN å»ºç«‹è¿æ¥ï¼Œç„¶åå‘èµ·è°ƒç”¨ã€‚MOSN åœ¨å»ºç«‹è¿æ¥ä»¥åï¼Œä¼šç­‰å¾…è¯·æ±‚æ•°æ®çš„åˆ°è¾¾ï¼Œè¿™éƒ¨åˆ†é€»è¾‘å°±åœ¨&lt;code&gt;startReadLoop &lt;/code&gt;ä¸­ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;startReadLoop&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;transferTime&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Time&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœç•¥éƒ¨åˆ†é€»è¾‘...
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;internalStopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readEnabledChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readEnabled&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//readEnabled é»˜è®¤ä¸ºtrue
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœŸæ­£çš„è¯»å–æ•°æ®é€»è¾‘åœ¨è¿™é‡Œ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;doRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¯»å–å¤±è´¥è¿›è¡Œå¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readEnabledChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;After&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;100&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Millisecond&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;):&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€»è¾‘æ¯”è¾ƒç›´è§‚ï¼Œå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ä¸æ–­çš„è¯»å–è¯¥è¿æ¥ä¸Šé¢çš„æ•°æ®ã€‚
ä¸‹é¢çœ‹ä¸€ä¸‹å…³é”®çš„&lt;code&gt;doRead()&lt;/code&gt;æ–¹æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;doRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¸ºè¯¥è¿æ¥åˆ›å»ºä¸€ä¸ªbufferæ¥ä¿å­˜è¯»å…¥çš„æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readBuffer&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readBuffer&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetIoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultBufferReadCapacity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bytesRead&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int64&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä»è¿æ¥ä¸­è¯»å–æ•°æ®ï¼Œè¿”å›å®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°ï¼ŒrawConnectionå¯¹åº”çš„å°±æ˜¯åŸå§‹è¿æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;bytesRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ReadOnce&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	      &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é”™è¯¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ²¡æœ‰è¯»å–åˆ°æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰æŠ¥é”™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bytesRead&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EOF&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿›è¡Œè¯»å–å­—èŠ‚å‡½æ•°çš„å›è°ƒï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ç»Ÿè®¡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cb&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bytesReadCallbacks&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;cb&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;uint64&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bytesRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é€šçŸ¥ä¸Šå±‚è¯»å–åˆ°äº†æ–°çš„æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢çš„&lt;code&gt;ReadOnce &lt;/code&gt;æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å•ç‹¬åˆ—å‡ºæ¥äº†ï¼Œå…¶å®å°±æ˜¯åœ¨è¯¥è¿æ¥ä¸Šè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´è¿›è¡Œè¯»å–ï¼Œå¹¶æŠŠè¯»å–åˆ°çš„æ•°æ®æ”¾å…¥bufferä¸­ï¼Œç»“åˆæœ€å¤–å±‚çš„æ­»å¾ªç¯ï¼Œä¸éš¾ç†è§£è¿™ä¸ªä¸æ–­å°è¯•è¯»å–æ•°æ®çš„æ¨¡å‹ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢é‡ç‚¹çœ‹ä¸€ä¸‹å›è°ƒæ–¹æ³•&lt;code&gt;onRead() &lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;onRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¸å†å¯è¯»ï¼Œè¿™é‡Œå¯èƒ½è·Ÿçƒ­å‡çº§æœ‰å…³ï¼Ÿ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readEnabled&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ²¡æœ‰éœ€è¦å¤„ç†çš„æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//filterManagerè¿‡æ»¤å™¨ç®¡ç†è€…ï¼ŒæŠŠè¯»å–åˆ°çš„æ•°æ®äº¤ç»™è¿‡æ»¤å™¨é“¾è·¯è¿›è¡Œå¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¸Šè¿°OnReadæ–¹æ³•å®ç°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onContinueReading&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;onContinueReading&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeReadFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeReadFilter&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ç½‘ç»œå±‚è¯»å–åˆ°æ•°æ®ä»¥åï¼Œé€šè¿‡filterManageræŠŠæ•°æ®äº¤ç»™æ•´ä¸ªè¿‡æ»¤å™¨é“¾è·¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é’ˆå¯¹è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„è¿‡æ»¤å™¨å›è°ƒå…¶åˆå§‹åŒ–æ–¹æ³•OnNewConnection
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;initialized&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;initialized&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;status&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnNewConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;status&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å–å‡ºè¯¥è¿æ¥ä¸­åˆšæ‰è¯»å–åˆ°çš„æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetReadBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é€šçŸ¥è¿‡æ»¤å™¨è¿›è¡Œå¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;status&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;uf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;status&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨&lt;code&gt;sofarpc-sample&lt;/code&gt;ä¸­ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨å¯¹åº”çš„å®ç°å°±åœ¨&lt;code&gt;proxy.go&lt;/code&gt;æ–‡ä»¶ä¸­ï¼Œä¸€èµ·æ¥çœ‹ä¸‹å…·ä½“å®ç°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterStatus&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é’ˆå¯¹ä½¿ç”¨çš„åè®®ç±»å‹åˆå§‹åŒ–serverStreamConn
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RawConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mtls&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TLSConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConnectionState&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NegotiatedProtocol&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SelectStreamFactoryProtocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Bytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EAGAIN&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FAILED&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] Protocol Auto error magic :%v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Bytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()[:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Close&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NoFlush&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnReadErrClose&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] Protoctol Auto: %v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConn&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateServerStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æŠŠæ•°æ®åˆ†å‘åˆ°å¯¹åº”åè®®çš„çš„è§£ç å™¨ï¼Œåœ¨è¿™é‡Œå½“ç„¶å°±æ˜¯sofaåè®®è§£æå™¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Dispatch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ç»“åˆä¸Šé¢è¿‡æ»¤å™¨é“¾è·¯çš„è°ƒç”¨é€»è¾‘çœ‹ï¼Œè¿”å›Stopè¡¨ç¤ºå¤„ç†å®Œæˆï¼Œä¸ä¼šå†ç»§ç»­è°ƒç”¨å‰©ä½™çš„è¿‡æ»¤å™¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç”±äºæˆ‘ä»¬æ˜¯ä»¥&lt;code&gt;sofarcp-sample&lt;/code&gt;ä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œæ‰€ä»¥ä¸Šè¿°çš„&lt;code&gt;Dispatch()&lt;/code&gt;æ–¹æ³•è‡ªç„¶è½åœ¨äº†&lt;code&gt;pkg/stream/sofarpc/stream.go&lt;/code&gt;æ–‡ä»¶ä¸­ï¼Œä¸€èµ·æ¥çœ‹ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Dispatch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1. pre alloc stream-level ctx with bufferCtx
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 2. decode process
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é’ˆå¯¹è¯»å–åˆ°çš„æ•°æ®ï¼ŒæŒ‰ç…§åè®®ç±»å‹è¿›è¡Œè§£ç 
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;codecEngine&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Decode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// No enough data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å¦‚æœæ²¡æœ‰æŠ¥é”™ä¸”æ²¡æœ‰è§£ææˆåŠŸï¼Œé‚£å°±è¯´æ˜å½“å‰æ”¶åˆ°çš„æ•°æ®ä¸å¤Ÿè§£ç ï¼Œæ¨å‡ºå¾ªç¯ï¼Œç­‰å¾…æ›´å¤šæ•°æ®åˆ°æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;break&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é”™è¯¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Do handle staff. Error would also be passed to this function.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è§£ç æˆåŠŸä»¥åï¼Œå¼€å§‹å¤„ç†è¯¥è¯·æ±‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ³¨æ„ä¸èƒ½å¹¶è¡Œå¯¹æ•°æ®è¿›è¡Œè§£ç ï¼Œä¸ç„¶æ•°æ®éƒ½ä¹±äº†ï¼Œè§£ç ä¹‹åå¯ä»¥å¼•å…¥å¤šçº¿ç¨‹æé«˜ååé‡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleCommand&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;break&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šè¿°è§£ç è¿‡ç¨‹çš„å…·ä½“å®ç°å°±ä¸å•ç‹¬åˆ—å‡ºæ¥äº†ï¼Œæ ¹æ®åè®®è§„èŒƒå¤„ç†å­—èŠ‚å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢é‡ç‚¹çœ‹ä¸€ä¸‹è§£ç æˆåŠŸåçš„åç»­å¤„ç†ï¼Œç»§ç»­&lt;code&gt;handleCommand&lt;/code&gt;æ–¹æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;handleCommand&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;model&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;model&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ç±»å‹æ ¡éªŒ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;model&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;model&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ErrNotSofarpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ ¹æ®æ•°æ®ç±»å‹åˆ›å»ºå¯¹åº”çš„stream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å¤„ç†è¯¥streamçš„åç»­å·¥ä½œ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;timeoutInt&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strconv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Itoa&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;timeoutInt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// timeout, ms
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Set&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderGlobalTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è½¬å‘æ•°æ®çš„é€»è¾‘å°è£…åœ¨è¿™é‡Œ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œæ˜¯åŒºåˆ†è¯·æ±‚è·Ÿå“åº”çš„å…³é”®éƒ¨åˆ†ï¼Œå…³ç³»åˆ°æ•°æ®æµå‘
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;processStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CommandType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;REQUEST&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;REQUEST_ONEWAY&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Span&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IsEnabled&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// try build trace span
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Tracer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRPC&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;tracer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¯·æ±‚å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onNewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RESPONSE&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å“åº”å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onStreamRecv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šè¿°streamçš„å¤„ç†é€»è¾‘ï¼Œæ˜¯æˆ‘è®¤ä¸ºæ•´ä¸ªæ•°æ®æµå¤„ç†ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œé¦–å…ˆè¿™é‡Œå‡ºç°äº†åˆ†æ­§ï¼Œæ ¹æ®å½“å‰çš„æ•°æ®æ˜¯requestè¿˜æ˜¯responseè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œé¡ºç€æˆ‘ä»¬çš„æ€è·¯ï¼Œç°åœ¨è¿˜åœ¨è¯·æ±‚è½¬å‘é˜¶æ®µï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¯·æ±‚å¤„ç†ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;onNewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ¯ä¸ªè¯·æ±‚æ–°å»ºä¸€ä¸ªstream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofaBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¿å­˜requestIDï¼Œåé¢è¦ç”¨æ¥å…³è”è¯·æ±‚åŠå“åº”
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyStreamID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextSubProtocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ProtocolCode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InjectTrace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ•°æ®æµå‘
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;direction&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ServerStream&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ ¹æ®è¯·æ±‚ç±»å‹è¿›è¡Œå¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CommandType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;REQUEST_ONEWAY&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConnectionEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¸ºè¯¥streamåˆ›å»ºä¸€ä¸ªç”¨äºå¤„ç†æ”¶åˆ°å“åº”ä»¥åçš„å¯¹è±¡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;serverStreamConnectionEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//receiverçš„å…·ä½“å®ç°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewStreamDetect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamReceiveListener&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å†æ¬¡æ˜¯ä¸€ä¸ªæ–°çš„stream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newActiveStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyStreamFilterChainFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ff&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ffs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ff&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Load&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().([]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterChainFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ffs&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateFilterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;asMux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;element&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeSteams&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PushBack&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;asMux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœŸæ­£receiverçš„åˆ›å»ºè¿‡ç¨‹
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newActiveStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IsEnabled&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyActiveSpan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyTraceSpanKey&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;trace&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SpanKey&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TraceId&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TraceId&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;SpanId&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SpanId&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()})&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä»å¯¹è±¡æ± ä¸­é€‰ä¸€ä¸ª
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;proxyBuffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;proxyBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxyBuffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ID&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;currProxyID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxyBuffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetStartTime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetDownstreamLocalAddress&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LocalAddr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetDownstreamRemoteAddress&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;readCallbacks&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RemoteAddr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reuseBuffer&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;notify&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœç•¥éƒ¨åˆ†æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reflect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ValueOf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;).&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IsNil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;oneway&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;responseSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ•´ä¸ªstreamçš„æ„å»ºè¿‡ç¨‹ä»£ç å¤šä¸”å¤æ‚ï¼Œä½†å…¶å®æ€»çš„æ¥è¯´å°±æ˜¯é’ˆå¯¹æ¯ä¸ªè¯·æ±‚åˆ›å»ºäº†ä¸¤ä¸ªstreamå¯¹è±¡ï¼Œä¸€ä¸ªç”¨äºå°è£…è¯·æ±‚é€»è¾‘ï¼Œä¸€ä¸ªç”¨äºå°è£…æ”¶åˆ°å“åº”ä»¥åçš„å¤„ç†é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥éœ€è¦å›åˆ°&lt;code&gt;handleCommand&lt;/code&gt;æ–¹æ³•ï¼Œå½“streamåˆ›å»ºå¥½ä¹‹åï¼Œä¼šç›´æ¥è°ƒç”¨å…¶receiverçš„&lt;code&gt;OnReceive&lt;/code&gt;æ–¹æ³•ï¼Œç”±äºç°åœ¨è¿˜æ˜¯å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥å¯¹åº”çš„æ˜¯&lt;code&gt;downstream.go&lt;/code&gt;ä¸­çš„å®ç°ï¼š&lt;/p&gt;
&lt;p&gt;æ³¨æ„ï¼šæ¯ä¸ªè¯·æ±‚æ•°æ®éƒ½åˆ†ä¸ºäº†headerï¼Œbodyï¼Œtrailersä¸‰éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//head body trailer
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Drain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ID&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æŠŠç»™ä»»åŠ¡ä¸¢ç»™åç¨‹æ± è¿›è¡Œå¤„ç†å³å¯
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ScheduleAuto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;recover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ID&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;delete&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}()&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä¸€æ—¦è¯¥åç¨‹è¢«CPUè°ƒåº¦åˆ°ä»¥åï¼Œå°±å¼€å§‹ç»§ç»­æ‰§è¡Œå‘é€è¯·æ±‚çš„é€»è¾‘ï¼š
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cleanNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœŸæ­£çš„å¤„ç†é€»è¾‘åœ¨è¿™é‡Œ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MatchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Retry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;receive&lt;/code&gt;æ–¹æ³•çš„é€»è¾‘æˆ‘è§‰å¾—å¾ˆæœ‰æ„æ€ï¼Œæ€»ä½“æ¥è¯´åœ¨è¯·æ±‚è½¬å‘é˜¶æ®µï¼Œä¾æ¬¡éœ€è¦ç»è¿‡&lt;code&gt;DownFilter&lt;/code&gt; -&amp;gt; &lt;code&gt;MatchRoute&lt;/code&gt; -&amp;gt; &lt;code&gt;DownFilterAfterRoute&lt;/code&gt; -&amp;gt; &lt;code&gt;DownRecvHeader &lt;/code&gt; -&amp;gt; &lt;code&gt;DownRecvData&lt;/code&gt; -&amp;gt; &lt;code&gt;DownRecvTrailer&lt;/code&gt;  -&amp;gt; &lt;code&gt;WaitNofity&lt;/code&gt;è¿™ä¹ˆå‡ ä¸ªé˜¶æ®µï¼Œä»å­—é¢æ„æ€å¯ä»¥çŸ¥é“&lt;code&gt;MatchRoute&lt;/code&gt;å°±æ˜¯æ„å»ºè·¯ç”±ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è½¬å‘ç»™å“ªä¸ªæœåŠ¡ï¼Œè€Œ&lt;code&gt;WaitNofity&lt;/code&gt;åˆ™æ˜¯è½¬å‘æˆåŠŸä»¥åï¼Œç­‰å¾…è¢«å“åº”æ•°æ®å”¤é†’ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢å°±ä¾æ¬¡æ¥çœ‹ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init phase
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter before route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æœ‰é”™è¯¯å°±é€€å‡º
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// match route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MatchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ç”ŸæˆæœåŠ¡æä¾›è€…çš„åœ°å€åˆ—è¡¨ä»¥åŠè·¯ç”±è§„åˆ™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;matchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter after route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilterAfterRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive header
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œå¼€å§‹ä¾æ¬¡å‘é€æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Count&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;

			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive trailer
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œé˜»å¡ç­‰å¾…è¿”å›åŠç»“æœ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;waitNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;çœŸæ­£çš„å‘é€æ•°æ®é€»è¾‘æ˜¯åœ¨&lt;code&gt;receiveHeaders&lt;/code&gt;ã€&lt;code&gt;receiveData &lt;/code&gt;ã€&lt;code&gt;receiveTrailers &lt;/code&gt;è¿™ä¸‰ä¸ªæ–¹æ³•é‡Œï¼Œå½“ç„¶æ¯æ¬¡è¯·æ±‚ä¸ä¸€å®šéƒ½éœ€è¦æœ‰è¿™ä¸‰éƒ¨åˆ†çš„æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥&lt;code&gt;receiveHeaders&lt;/code&gt;æ–¹æ³•ä¸ºä¾‹æ¥è¿›è¡Œè¯´æ˜ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRecvDone&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœç•¥éƒ¨åˆ†é€»è¾‘ã€‚ã€‚ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œçš„çš„clusterNameå°±å¯¹åº”ä¸Šé¢çš„&amp;#34;clientCluster&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;clusterName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouteRule&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;snapshot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetRouteEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouteRule&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//åˆå§‹åŒ–è¿æ¥æ± 
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;initializeUpstreamConnectionPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é”™è¯¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;parseProxyTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;getUpstreamProtocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;retryState&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newRetryState&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouteRule&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Policy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RetryPolicy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ„å»ºå¯¹åº”çš„upstreamè¯·æ±‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;proxyBuffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;proxyBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxyBuffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proxy&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prot&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;route&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RouteRule&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FinalizeRequestHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œå‘é€æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;appendHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œå¼€å¯è¶…æ—¶è®¡æ—¶å™¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onUpstreamRequestSent&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;appendHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processDone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendComplete&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;oneway&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseDecoder&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamReceiveListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PoolEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;subProtocol&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getSubProtocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä»è¿æ¥æ± ä¸­è·å–è¿æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClients&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Load&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;subProtocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnFailure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConnectionFailure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LoadUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;state&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Connected&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnFailure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConnectionFailure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ResourceManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Requests&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CanCreate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnFailure&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Overflow&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HostStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestPendingOverflow&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestPendingOverflow&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddUint64&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;totalStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HostStats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestTotal&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stats&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpstreamRequestTotal&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Inc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;streamEncoder&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// oneway
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseDecoder&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;streamEncoder&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œä¼šæŠŠstreamIdå¯¹åº”çš„streamä¿å­˜èµ·æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;streamEncoder&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseDecoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;streamEncoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å‘é€æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnReady&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamEncoder&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;respReceiver&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamReceiveListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// oneway
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;respReceiver&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;wrapper&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clientStreamReceiverWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;streamReceiver&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;respReceiver&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;streamSender&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;wrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;wrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;streamSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;streamSender&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamReceiveListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofaBuffersByContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddUint64&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;currStreamID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyStreamID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;direction&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ClientStream&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//onewayçš„è¯·æ±‚ä¸éœ€è¦å¤„ç†ç»“æœ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiver&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æŒ‰ç…§idæ”¾è¿›map
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streams&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReady&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sender&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestSender&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sender&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddEventListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;startTime&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendComplete&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;dataSent&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;trailerSent&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å‘é€æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestSender&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AppendHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;convertHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnUpstreamHostSelected&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetUpstreamLocalAddress&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddressString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;

&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AppendHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;ã€&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;direction&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ClientStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ServerStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CommandType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RESPONSE&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;REQUEST&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;REQUEST_ONEWAY&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æœåŠ¡ç«¯å‘ç»™è°ƒç”¨ç«¯çš„æ•°æ®
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buildHijackResp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetRequestID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Del&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderGlobalTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ç¼–ç 
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;codecEngine&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Encode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//...
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œç›¸å½“äºæ˜¯ä¸Šé¢çš„ç¼–ç åªç¼–ç çš„å¤´éƒ¨ï¼Œå¦‚æœæœ‰bodyé‚£å°±ä¸€èµ·å‘é€ï¼Ÿ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;dataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;dataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;dataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é”™è¯¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç½‘ç»œå±‚çš„writeï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//åŒæ ·ç»è¿‡è¿‡æ»¤å™¨
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;fs&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnWrite&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fs&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stop&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UseNetpollMode&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;useWriteLoop&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;writeBufferChan&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;writeDirectly&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buffers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//netpollæ¨¡å¼å†™
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨å¯¹åº”çš„&lt;code&gt;eventloop.go&lt;/code&gt;ä¸­çš„&lt;code&gt;startWriteLoop&lt;/code&gt;æ–¹æ³•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;startWriteLoop&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;internalStopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;transferChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;needTransfer&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;writeBufferChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;appendBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetWriteDeadline&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Add&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultConnWriteTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;doWrite&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é”™è¯¯å¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯·æ±‚æ•°æ®å‘å‡ºå»ä»¥åå½“å‰åç¨‹å°±é˜»å¡äº†ï¼Œçœ‹ä¸‹&lt;code&gt;waitNotify&lt;/code&gt;æ–¹æ³•çš„å®ç°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;waitNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ID&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ErrExit&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é˜»å¡ç­‰å¾…
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;notify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç»è¿‡ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œè¯·æ±‚è¢«æˆåŠŸè½¬å‘å‡ºå»ï¼Œå¹¶ä¸”å¯¹åº”çš„streamåœ¨é˜»å¡ç­‰å¾…å“åº”ã€‚&lt;/p&gt;
&lt;h3 id=&#34;ç»“æœå“åº”&#34;&gt;ç»“æœå“åº”&lt;/h3&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å†å›å¤´çœ‹çœ‹æ”¶åˆ°å“åº”æ—¶å€™çš„å¤„ç†è¿‡ç¨‹ï¼Œç”±äºç½‘ç»œå±‚çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»å‰é¢å‡ºç°åˆ†æ­§çš„åœ°æ–¹å¼€å§‹çœ‹ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;processStream&lt;/code&gt;æ–¹æ³•ï¼Œå½“æ”¶åˆ°çš„æ•°æ®ç±»å‹æ˜¯&lt;code&gt;RESPONSE&lt;/code&gt;æ—¶ï¼Œå®ƒä¼šè°ƒç”¨&lt;code&gt;onStreamRecv&lt;/code&gt;ï¼Œä¸€èµ·æ¥çœ‹ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;onStreamRecv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sofarpc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SofaRpcCmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;requestID&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é€šè¿‡requestIDæ‰¾åˆ°å¯¹åº”çš„é˜»å¡çš„stream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streams&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87&#34;&gt;delete&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streams&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;requestID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransmitBufferPoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯¥streamåŒæ ·ä¼šèµ°åˆ°&lt;code&gt;handleCommand&lt;/code&gt;æ–¹æ³•ä¸­çš„&lt;code&gt;OnReceive&lt;/code&gt;ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;w&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clientStreamReceiverWrapper&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;w&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DestroyStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;w&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamReceiver&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processDone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;setupRetry&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;code&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MappingHeaderStatusCode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetResponseCode&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;code&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetResponseReceivedDuration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Now&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;headers&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Drain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailers&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å”¤é†’downstream
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠæ ¹æ®requestIDåŒ¹é…åˆ°çš„streamå”¤é†’ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹å”¤é†’ä»¥åçš„å¤„ç†é€»è¾‘ï¼Œ
è¿™é‡Œéœ€è¦å›åˆ°å‰é¢é˜»å¡çš„&lt;code&gt;receive&lt;/code&gt;æ–¹æ³•ä¸­ï¼Œå”¤é†’ä»¥åä¼šä»ä¹‹å‰é˜»å¡çš„åœ°æ–¹å¼€å§‹ç»§ç»­æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//ä»è¿™é‡Œé†’æ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;waitNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runAppendFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;fakeUpstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fakeUpstreamRequest&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//åŒæ ·æ˜¯åœ¨è¿™é‡Œè¿”å›å“åº”ç»“æœ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
				&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;processError&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
				&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] unexpected phase cycle time&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šé¢çš„receiveXXXæ–¹æ³•ä¼šæŠŠå“åº”æ•°æ®è½¬å‘ç»™ä¸šåŠ¡è¿›ç¨‹ï¼Œä¹‹å‰åˆ†æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åç¨‹æ± &#34;&gt;åç¨‹æ± &lt;/h2&gt;
&lt;p&gt;å‰é¢åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æåˆ°äº†ä¼šæŠŠè¯·æ±‚ä»»åŠ¡äº¤ç»™ä¸€ä¸ªåç¨‹æ± å»å¤„ç†ï¼Œè¿™é‡Œå°±ç®€å•çœ‹ä¸€ä¸‹ MOSN ä¸­åç¨‹æ± çš„å®ç°åŸç†ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;workerPool&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;work&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;sem&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewWorkerPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;WorkerPool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;workerPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;work&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()),&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;sem&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åˆå§‹åŒ–è¿‡ç¨‹å¾ˆç®€å•ï¼Œåç¨‹æ± çš„é»˜è®¤å¤§å°ä¸º&lt;code&gt;poolSize := runtime.NumCPU() * 256&lt;/code&gt;ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è°ƒåº¦æ–¹æ³•çš„å®ç°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;workerPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ScheduleAuto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;work&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;work&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sem&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}{}:&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;go&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;spawnWorker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å¦‚æœæœ‰å¤šä½™çš„ä»»åŠ¡ï¼Œåˆ™ä¼šä¸´æ—¶åˆ›å»ºåç¨‹æ‰§è¡Œ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//é¢å¤–åˆ›å»ºå‡ºæ¥çš„åç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡ä»¥åä¼šè‡ªåŠ¨é€€å‡º
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handler&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;recoverHandler&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}))&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;go&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//çœç•¥deferæ–¹æ³•...
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;handler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;workerPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;spawnWorker&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;recover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Errorf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[syncpool] panic %v\n%s&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;debug&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Stack&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()))&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ•´ä¸ªå‡½æ•°é€€å‡ºæ—¶ï¼Œåç¨‹æ•°é‡å‡1ï¼Œåé¢å¯ä»¥å†åˆ›å»ºå‡ºæ¥
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è¿™é‡Œæ­£å¸¸æƒ…å†µä¸‹ä¸‹é¢çš„æ­»å¾ªç¯æ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´åŸºç¡€åç¨‹ä¸€æ—¦åˆ›å»ºå°±ä¸ä¼šè¢«å›æ”¶
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sem&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ‰§è¡Œä»»åŠ¡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//å¦‚æœè¿˜æœ‰ä»»åŠ¡ç­‰å¾…æ‰§è¡Œï¼Œåˆ™å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Œå¦åˆ™ç­‰å¾…
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;task&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;work&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;MOSN å¯¹äºæ•°æ®çš„å¤„ç†åŠè½¬å‘è¿™å—éå¸¸å¤æ‚ï¼Œä¸»è¦æ˜¯æ¦‚å¿µå¾ˆå¤šï¼Œå°¤å…¶æ˜¯streaméƒ¨åˆ†ï¼Œå¯¹è±¡ä¹‹é—´äº’ç›¸å¼•ç”¨ï¼Œé”™ç»¼å¤æ‚ï¼Œè€ƒè™‘åˆ°ç¯‡å¹…åŸå› ï¼Œæœ¬æ–‡åªè¯´æ˜äº†æµç¨‹ï¼Œå…¶ä»–æ¯”å¦‚è·¯ç”±ç­–ç•¥çš„ç»†èŠ‚ç­‰éœ€è¦é€šè¿‡å…¶ä»–æ–‡ç« è¿›è¡Œåˆ†æã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: UDPA æœ€æ–°è¿›å±•æ·±åº¦ä»‹ç»</title>
      <link>https://mosn.io/blog/posts/udpa-follow-up/</link>
      <pubDate>Mon, 24 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/udpa-follow-up/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;åœ¨2019å¹´5æœˆï¼ŒCNCF ç­¹å»ºé€šç”¨æ•°æ®å¹³é¢APIå·¥ä½œç»„ï¼ˆUniversal Data Plane API Working Group / UDPA-WG)ï¼Œä»¥åˆ¶å®šæ•°æ®å¹³é¢çš„æ ‡å‡†APIã€‚&lt;/p&gt;
&lt;p&gt;å½“æ—¶æˆ‘å†™äº†ä¸€ä¸ªåšå®¢æ–‡ç«  &lt;a href=&#34;https://skyao.io/post/201905-cncf-udpa-wg/&#34;&gt;â€œCNCFæ­£åœ¨ç­¹å»ºé€šç”¨æ•°æ®å¹³é¢APIå·¥ä½œç»„ï¼Œä»¥åˆ¶å®šæ•°æ®å¹³é¢çš„æ ‡å‡†APIâ€&lt;/a&gt; å¯¹æ­¤è¿›è¡Œäº†ä»‹ç»ã€‚å½“æ—¶ UDPA è¿˜å¤„äºéå¸¸æ—©æœŸçš„ç­¹å¤‡é˜¶æ®µï¼Œä¿¡æ¯éå¸¸çš„å°‘ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨9ä¸ªæœˆè¿‡å»äº†ï¼Œæˆ‘æœ€è¿‘æ”¶é›†å¹¶æ•´ç†äº†ä¸€ä¸‹ UDPA ç›®å‰çš„æƒ…å†µå’Œä¿¡æ¯ï¼Œç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹ UDPA ç›®å‰æœ€æ–°çš„è¿›å±•ï¼ˆæˆªæ­¢2020å¹´2æœˆ24æ—¥ï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;udpaä»‹ç»&#34;&gt;UDPAä»‹ç»&lt;/h2&gt;
&lt;p&gt;é¦–å…ˆå¿«é€Ÿä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯ UDPAï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;UDPA ï¼šâ€œUniversal Data Plane APIâ€çš„ç¼©å†™ï¼Œ â€œé€šç”¨æ•°æ®å¹³é¢APIâ€ã€‚&lt;/li&gt;
&lt;li&gt;UDPA-WGï¼šâ€Universal Data Plane API Working Groupâ€çš„ç¼©å†™ï¼Œè¿™æ˜¯CNCFä¸‹çš„ä¸€ä¸ªå·¥ä½œç»„ï¼Œè´Ÿè´£åˆ¶å®š UDPAã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;UDPAçš„ç›®æ ‡ï¼Œæ´å¼•è‡ª &lt;a href=&#34;https://github.com/cncf/udpa&#34;&gt;https://github.com/cncf/udpa&lt;/a&gt; çš„æè¿°ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;é€šç”¨æ•°æ®å¹³é¢APIå·¥ä½œç»„ï¼ˆUDPA-WGï¼‰çš„ç›®æ ‡æ˜¯å¬é›†å¯¹æ•°æ®å¹³é¢ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨çš„é€šç”¨æ§åˆ¶å’Œé…ç½®APIæ„Ÿå…´è¶£çš„ä¸šç•Œäººå£«ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;UDPAçš„æ„¿æ™¯ï¼ŒåŒæ ·æ´å¼•ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;é€šç”¨æ•°æ®å¹³é¢APIï¼ˆUDPAï¼‰çš„æ„¿æ™¯åœ¨ &lt;a href=&#34;https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a&#34;&gt;https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a&lt;/a&gt; ä¸­é˜æ˜ã€‚ æˆ‘ä»¬å°†å¯»æ±‚ä¸€ç»„APIï¼Œå®ƒä»¬ä¸ºL4/L7æ•°æ®å¹³é¢é…ç½®æä¾›äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œç±»ä¼¼äºSDNä¸­L2/L3/L4çš„OpenFlowæ‰€æ‰®æ¼”çš„è§’è‰²ã€‚&lt;/p&gt;
&lt;p&gt;è¿™äº›APIå°†åœ¨proto3ä¸­è§„èŒƒå®šä¹‰ï¼Œå¹¶é€šè¿‡å®šä¹‰è‰¯å¥½çš„ ç¨³å®šAPIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ï¼Œä»ç°æœ‰çš„Envoy xDS APIé€æ­¥æ¼”è¿›ã€‚ APIå°†æ¶µç›–æœåŠ¡å‘ç°ï¼Œè´Ÿè½½å‡è¡¡åˆ†é…ï¼Œè·¯ç”±å‘ç°ï¼Œç›‘å¬å™¨é…ç½®ï¼Œå®‰å…¨å‘ç°ï¼Œè´Ÿè½½æŠ¥å‘Šï¼Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥å§”æ‰˜ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å°†å¯¹APIè¿›è¡Œæ”¹è¿›å’Œæˆå‹ï¼Œä»¥æ”¯æŒå®¢æˆ·ç«¯ lookaside è´Ÿè½½å‡è¡¡ï¼ˆä¾‹å¦‚gRPC-LBï¼‰ï¼ŒEnvoyä¹‹å¤–çš„æ•°æ®å¹³é¢ä»£ç†ï¼Œç¡¬ä»¶LBï¼Œç§»åŠ¨å®¢æˆ·ç«¯ä»¥åŠå…¶ä»–èŒƒå›´ã€‚ æˆ‘ä»¬å°†åŠªåŠ›å°½å¯èƒ½ä¸ä¾›åº”å•†å’Œå®ç°æ— å…³ï¼ŒåŒæ—¶åšæŒæ”¯æŒå·²æŠ•å…¥ç”Ÿäº§çš„UDPAçš„é¡¹ç›®ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒEnvoyå’ŒgRPC-LBï¼‰ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¯¹ UDPA æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªé€”å¾„è¿›ä¸€æ­¥æ·±å…¥äº†è§£ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cncf/udpa&#34;&gt;UDPA @ GitHub&lt;/a&gt;ï¼šUDPA åœ¨ github ä¸Šçš„é¡¹ç›®ï¼ŒUDPA API å®šä¹‰çš„ä»£ç éƒ½åœ¨è¿™é‡Œ&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://lists.cncf.io/g/udpa-wg&#34;&gt;Universal Data Plane API Working Group (UDPA-WG)&lt;/a&gt;ï¼šCNCF çš„ UDPA å·¥ä½œç»„ï¼Œå¯ä»¥é€šè¿‡åŠ å…¥å·¥ä½œç»„çš„æ–¹å¼äº†è§£æ›´å¤šä¿¡æ¯&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;udpaå’Œxdsçš„å…³ç³»&#34;&gt;UDPAå’ŒxDSçš„å…³ç³»&lt;/h2&gt;
&lt;p&gt;åœ¨å±•å¼€ UDPA çš„ç»†èŠ‚ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆè§£é‡Šæ¸…æ¥š UDPA å’Œ xDS çš„å…³ç³»ï¼Œå› ä¸ºè¿™å¯¹ç†è§£ UDPA ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨2019å¹´11æœˆçš„ EnvoyCon ä¸Šï¼ŒEnvoy çš„ å¼€å‘è€…ï¼Œä¹Ÿæ˜¯ç›®å‰ UDPA æœ€ä¸»è¦çš„è´Ÿè´£äººä¹‹ä¸€ï¼Œæ¥è‡ª Google çš„ &lt;a href=&#34;https://github.com/htuch&#34;&gt;Harvey Tuch&lt;/a&gt;ï¼Œæœ‰ä¸€ä¸ªæ¼”è®²éå¸¸è¯¦ç»†è€Œæ¸…æ™°çš„è§£ç­”äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ¼”è®²çš„æ ‡é¢˜æ˜¯ï¼š&lt;a href=&#34;https://envoycon2019.sched.com/event/UxwL/the-universal-dataplane-api-udpa-envoys-next-generation-apis-harvey-tuch-google&#34;&gt;â€œThe Universal Dataplane API (UDPA): Envoyâ€™s Next Generation APIsâ€&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¤‡æ³¨ï¼šè¿™é‡Œæˆ‘ç›´æ¥æ´å¼•è¿™ä»½æ¼”è®²çš„éƒ¨åˆ†å†…å®¹ï¼Œä»¥ä¸‹ä¸¤å¼ å›¾ç‰‡å‡å‡ºè‡ª [è¿™ä»½æ¼”è®²çš„PPT](&lt;a href=&#34;https://static.sched.com/hosted_files/envoycon2019/ac/EnvoyCon&#34;&gt;https://static.sched.com/hosted_files/envoycon2019/ac/EnvoyCon&lt;/a&gt; UDPA 2019.pdf) ã€‚é¸£è°¢ Harveyã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸‹å›¾å±•ç¤ºäº†è¿‘å¹´æ¥ xDS åè®®çš„æ¼”è¿›å†ç¨‹å’Œæœªæ¥è§„åˆ’ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;xds-evolution.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2017å¹´ï¼ŒxDS v2 å¼•å…¥ proto3 å’Œ gRPCï¼ŒåŒå¹´ Istio é¡¹ç›®å¯åŠ¨&lt;/li&gt;
&lt;li&gt;2018å’Œ2019å¹´ï¼ŒxDS v2 APIç»§ç»­å‘å±•ï¼Œé™†ç»­å¼•å…¥äº†æ–°çš„APIå®šä¹‰ï¼Œå¦‚ HDS / LRS / SDS ç­‰ï¼Œå°¤å…¶æ˜¯ä¸ºäº†æ”¹è¿› Pilot ä¸‹å‘æ€§èƒ½ï¼Œå¼€å§‹å¼•å…¥å¢é‡æ¨é€æœºåˆ¶&lt;/li&gt;
&lt;li&gt;xDS v3 API åŸè®¡åˆ’äº2019å¹´å¹´åº•æ¨å‡ºï¼Œä½†ç›®å‰çœ‹æŠ€æœ¯æ¨è¿Ÿï¼Œç›®å‰ v3 è¿˜æ˜¯ alpha1 çŠ¶æ€ï¼Œé¢„è®¡åœ¨å³å°†å‘å¸ƒçš„ Istio 1.5 ä¸­ä¼šæœ‰æ›´å¤šçš„ v3 API å¼•å…¥ã€‚åŒæ—¶ v3 API ä¹Ÿå¼•å…¥äº† UDPA çš„éƒ¨åˆ†å†…å®¹ï¼Œä½†æ˜¯ç”±äº UDPA ç›®å‰è¿›å±•ç¼“æ…¢ï¼Œå¯¹ xDS çš„å½±å“å¹¶ä¸å¤§ï¼Œä¸»è¦è¿˜æ˜¯ xDS è‡ªèº«çš„å‘å±•ï¼Œæ¯”å¦‚å¯¹APIå’ŒæŠ€æœ¯å€ºåŠ¡çš„æ¸…ç†&lt;/li&gt;
&lt;li&gt;ä½†åœ¨2020å¹´ï¼Œé¢„è®¡ UDPA ä¼šæœ‰å¾ˆå¤§çš„è¿›å±•ï¼Œå°¤å…¶æ˜¯ä¸‹é¢æˆ‘ä»¬å°†ä¼šå±•å¼€çš„ UDPA-TP å’Œ UDPA-DM çš„è®¾è®¡å¼€å§‹æ­£å¼åˆ¶å®šä¸º API ä¹‹åã€‚è€Œ xDS v4 é¢„è®¡å°†åŸºäº UDPA ï¼Œå› æ­¤ xDS v4 å¯èƒ½ä¼šè¿æ¥æ¯”è¾ƒå¤§çš„å˜åŠ¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç®€å•æ€»ç»“è¯´ï¼š&lt;strong&gt;xDS å°†é€æ¸å‘ UDPA é æ‹¢ï¼Œæœªæ¥å°†åŸºäº UDPA&lt;/strong&gt; ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢çš„å›¾ç‰‡åˆ™å±•ç¤ºäº† Envoy åœ¨ xDS ç‰ˆæœ¬æ”¯æŒä¸Šçš„æ—¶é—´çº¿ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;envoy-version-support-timeline.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç›®å‰çœ‹è¿™ä¸ªè®¡åˆ’åœ¨æ‰§è¡Œæ—¶ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹å»¶è¯¯ï¼ŒåŸè®¡åˆ’äº2019å¹´å¹´åº•æ¨å‡ºçš„ v3 çš„ stable ç‰ˆæœ¬å®é™…ä¸Šæ˜¯åœ¨1æœˆä¸­å®šç¨¿çš„ã€‚ï¼ˆå¤‡æ³¨ï¼šå…·ä½“å¯å‚è€ƒ Envoy PR &lt;a href=&#34;https://github.com/envoyproxy/envoy/pull/9694&#34;&gt;api: freeze v3 API&lt;/a&gt; ï¼‰ã€‚ç„¶åç›®å‰æ­£åœ¨å¹¿æ³›ä½¿ç”¨çš„ v2 API å°†è¢«æ ‡è®°ä¸º depreatedã€‚è€Œä¸”åœ¨2020å¹´åº•ï¼Œv3 API é¢„è®¡è¢« v4 API å–ä»£ï¼ˆæ³¨æ„v4 API å°†ä¼šæ˜¯åŸºäº UDPAï¼‰ï¼Œè€Œç›®å‰æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ v2 API å°†è®¡åˆ’åœ¨2020å¹´åº•ç§»é™¤ï¼Œä¸å†æ”¯æŒï¼&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾ä¹Ÿå±•ç¤ºäº†æœªæ¥ xDS åè®®çš„å¤§ç‰ˆæœ¬æ¼”è¿›å’Œæ›´æ›¿çš„æ–¹å¼ï¼Œæ€»çš„æ¥è¯´è§„å¾‹æ˜¯è¿™æ ·ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸€å¹´ä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼š2019 v2 -ã€‹ 2020 v3 -ã€‹2021 v4 -ã€‹2022 v5&lt;/li&gt;
&lt;li&gt;æ¯ä¸ªå¤§ç‰ˆæœ¬éƒ½è¦ç»å† alpha -ã€‹ stable -ã€‹deprecated -ã€‹removed å››ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µå†æ—¶ä¸€å¹´&lt;/li&gt;
&lt;li&gt;ç¨³å®šå Envoy ä¼šåŒæ—¶å­˜åœ¨ä¸‰ä¸ªAPIå¤§ç‰ˆæœ¬ï¼šæ­£åœ¨ä½¿ç”¨çš„ç¨³å®šç‰ˆæœ¬ï¼Œå·²ç»å¼ƒç”¨çš„ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œå‡†å¤‡å¼€å‘çš„æ–°çš„ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼ˆä½†åªä¼šæ˜¯Alphaï¼‰&lt;/li&gt;
&lt;li&gt;å‘å¸ƒä¸€ä¸ªæ–°çš„ stable çš„å¤§ç‰ˆæœ¬ï¼Œå°±ä¸€å®šä¼š deprecated ä¸Šä¸€ä¸ªç¨³å®šçš„å¤§ç‰ˆæœ¬ï¼ŒåŒæ—¶ remove æ›´å‰ä¸€ä¸ªå·²ç» deprecated çš„å¤§ç‰ˆæœ¬&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ‰€è°“ â€œé•¿æ±Ÿåæµªæ¨å‰æµªï¼Œå‰æµªæ­»åœ¨æ²™æ»©ä¸Šâ€ï¼Œåˆæˆ–è€…è¯´ï¼Œâ€œæ±Ÿå±±ä»£æœ‰æ–°ç‰ˆå‡ºï¼Œå„é¢†é£éªš12ä¸ªæœˆâ€ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¤‡æ³¨ï¼šEnvoy å…·ä½“çš„ç¨³å®šAPIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ï¼Œå¯ä»¥å‚è§ Envoy çš„è®¾è®¡æ–‡æ¡£ &lt;a href=&#34;https://docs.google.com/document/d/1xeVvJ6KjFBkNjVspPbY_PwEDHC7XPi0J5p1SqUXcCl8/&#34;&gt;â€œStable Envoy API versioningâ€&lt;/a&gt; ï¼Œä¸è¿‡è¿™ä¸ªæ–‡æ¡£é•¿çš„æœ‰ç‚¹è¿‡åˆ†ï¼Œå«Œé•¿çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹è¿™ä¸ªæ–‡æ¡£çš„ç¼©å‡ç‰ˆæœ¬ &lt;a href=&#34;https://github.com/envoyproxy/envoy/blob/master/api/API_VERSIONING.md&#34;&gt;API versioning guidelines&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;udpa-apiè¿›å±•&#34;&gt;UDPA APIè¿›å±•&lt;/h2&gt;
&lt;p&gt;è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ UDPA ç›®å‰çš„æœ€æ–°è¿›å±•ã€‚&lt;/p&gt;
&lt;p&gt;ä» &lt;a href=&#34;https://github.com/cncf/udpa&#34;&gt;https://github.com/cncf/udpa&lt;/a&gt; ï¼Œå¯ä»¥çœ‹åˆ°ç›®å‰ UDPA ä¸­å·²ç»å®šä¹‰å¥½çš„éƒ¨åˆ† API å†…å®¹ï¼š&lt;/p&gt;
&lt;h3 id=&#34;ç±»å‹å®šä¹‰&#34;&gt;ç±»å‹å®šä¹‰&lt;/h3&gt;
&lt;p&gt;ç›®å‰åªå®šä¹‰äº†ä¸€ä¸ªç±»å‹ TypedStructã€‚&lt;/p&gt;
&lt;p&gt;TypedStructåŒ…å«ä»»æ„ JSON åºåˆ—åŒ–åçš„ protocol buffer æ¶ˆæ¯ï¼Œä»¥åŠä¸€ä¸ªæè¿°åºåˆ—åŒ–æ¶ˆæ¯ç±»å‹çš„URLã€‚ è¿™ä¸ google.protobuf.Any éå¸¸ç›¸ä¼¼ï¼Œå®ƒä½¿ç”¨ google.protobuf.Struct ä½œä¸ºå€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ protocol buffer äºŒè¿›åˆ¶ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-protobuf&#34; data-lang=&#34;protobuf&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;message&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;TypedStruct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç”¨äºå”¯ä¸€æ ‡è¯†åºåˆ—åŒ– protocol buffer æ¶ˆæ¯çš„ç±»å‹çš„URL
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è¿™ä¸ google.protobuf.Any ä¸­æè¿°çš„è¯­ä¹‰å’Œæ ¼å¼ç›¸åŒï¼š
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/any.proto
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;type_url&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä¸Šè¿°æŒ‡å®šç±»å‹çš„JSONè¡¨ç¤ºå½¢å¼ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;google.protobuf.Struct&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;TypedStruct å®šä¹‰çš„èƒŒæ™¯æ˜¯ï¼šå¦‚ä½•åœ¨ protocol buffer çš„é™æ€ç±»å‹æŠ¥æ–‡ä¸­åµŒå…¥ä¸€ä¸ªä¸é€æ˜çš„é…ç½®ï¼Ÿè¿™æ˜¯ä¸€ä¸ªæ™®ééœ€æ±‚ï¼Œæ¶‰åŠ &lt;code&gt;google.protobuf.Any&lt;/code&gt; å’Œ &lt;code&gt;google.protobuf.Struct&lt;/code&gt; çš„å·®åˆ«å’Œæƒè¡¡ä½¿ç”¨ã€‚å…·ä½“å†…å®¹è¯·è§æˆ‘ä¹‹å‰ç¿»è¯‘çš„åšå®¢æ–‡ç«  â€œ[&lt;a href=&#34;https://skyao.io/post/201909-dynamic-extensibility-and-protocol-buffers/&#34;&gt;è¯‘] åŠ¨æ€å¯æ‰©å±•æ€§å’ŒProtocol Buffer&lt;/a&gt;â€ï¼Œå¯¹æ­¤åšäº†éå¸¸å¥½çš„ä»‹ç»å’Œåˆ†æè®¨è®ºã€‚&lt;/p&gt;
&lt;p&gt;TypedStruct å¯ä»¥è¯´æ˜¯åˆ°ç›®å‰ä¸ºæ­¢å¯¹æ­¤éœ€æ±‚çš„æœ€ä½³å®è·µï¼Œç®—æ˜¯ä¸ºè¿™ä¸€è¯é¢˜æ­£å¼ç”»ä¸Šäº†å¥å·ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®å®šä¹‰&#34;&gt;æ•°æ®å®šä¹‰&lt;/h3&gt;
&lt;p&gt;æ•°æ®å®šä¹‰ä¹Ÿåªå®šä¹‰äº†ä¸€ä¸ªæ•°æ® OrcaLoadReportã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ ORCA æ˜¯ Open Request Cost Aggregation çš„ç¼©å†™ï¼ŒOrcaLoadReport ç”¨äºæäº¤è¯·æ±‚å¼€é”€æ±‡æ€»çš„è´Ÿè½½æŠ¥å‘Šã€‚&lt;/p&gt;
&lt;p&gt;ORCAçš„ç®€çŸ­ä»‹ç»ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚ä»Šï¼Œåœ¨Envoyä¸­ï¼Œå¯ä»¥é€šè¿‡è€ƒè™‘åç«¯è´Ÿè½½ï¼ˆä¾‹å¦‚CPUï¼‰çš„æœ¬åœ°æˆ–å…¨å±€çŸ¥è¯†æ¥åšå‡ºç®€å•çš„è´Ÿè½½å‡è¡¡å†³ç­–ã€‚æ›´å¤æ‚çš„è´Ÿè½½å‡è¡¡å†³ç­–å¯èƒ½éœ€è¦å€ŸåŠ©ç‰¹å®šäºåº”ç”¨çš„çŸ¥è¯†ï¼Œä¾‹å¦‚é˜Ÿåˆ—æ·±åº¦ï¼Œæˆ–ç»„åˆå¤šä¸ªæŒ‡æ ‡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™å¯¹äºå¯èƒ½åœ¨å¤šä¸ªç»´åº¦ä¸Šå—åˆ°èµ„æºé™åˆ¶çš„æœåŠ¡ï¼ˆä¾‹å¦‚ï¼ŒCPUå’Œå†…å­˜éƒ½å¯èƒ½æˆä¸ºç“¶é¢ˆï¼Œå–å†³äºæ‰€åº”ç”¨çš„è´Ÿè½½å’Œæ‰§è¡Œç¯å¢ƒï¼Œæ— æ³•ç¡®å®šæ˜¯å“ªä¸ªå…ˆè§¦åŠç“¶é¢ˆï¼‰ï¼Œä»¥åŠè¿™äº›ç»´åº¦ä¸åœ¨é¢„å®šç±»åˆ«ä¸­çš„ä½ç½®æ—¶å¾ˆæœ‰ç”¨ï¼ˆä¾‹å¦‚ï¼Œèµ„æºå¯èƒ½æ˜¯â€œæ± ä¸­çš„å¯ç”¨çº¿ç¨‹æ•°â€ï¼Œç£ç›˜IOPSç­‰ï¼‰ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ‰å…³ Orca çš„æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·è§è®¾è®¡æ–‡æ¡£ &lt;a href=&#34;https://docs.google.com/document/d/1NSnK3346BkBo1JUU3I9I5NYYnaJZQPt8_Z_XCBCI3uA/&#34;&gt;Open Request Cost Aggregation (ORCA)&lt;/a&gt; ã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰ Envoy æ­£åœ¨å®ç°å¯¹ ORCA çš„æ”¯æŒï¼Œç„¶åè¿™ä¸ªç‰¹æ€§è¢«ä½œä¸º UPDA æ ‡å‡†çš„ä¸€éƒ¨åˆ†ç›´æ¥åœ¨ UDPA API ä¸­å®šä¹‰ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹ä¸º OrcaLoadReport å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°åŒ…å«æœ‰CPU/å†…å­˜çš„åˆ©ç”¨ç‡å’ŒRPSä¿¡æ¯ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-protobuf&#34; data-lang=&#34;protobuf&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;message&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OrcaLoadReport&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// CPUåˆ©ç”¨ç‡è¡¨ç¤ºä¸ºå¯ç”¨CPUèµ„æºçš„ä¸€éƒ¨åˆ†ã€‚ åº”è¯¥æ¥è‡ªæœ€æ–°çš„æ ·æœ¬æˆ–æµ‹é‡ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cpu_utilization&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;validate.rules&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gte&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;validate.rules&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lte&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å†…å­˜åˆ©ç”¨ç‡è¡¨ç¤ºä¸ºå¯ç”¨å†…å­˜èµ„æºçš„ä¸€éƒ¨åˆ†ã€‚ åº”è¯¥æ¥è‡ªæœ€æ–°çš„æ ·æœ¬æˆ–æµ‹é‡ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mem_utilization&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;validate.rules&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;gte&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;validate.rules&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;double&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lte&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç«¯ç‚¹å·²æœåŠ¡çš„æ€»RPSã€‚ åº”è¯¥æ¶µç›–ç«¯ç‚¹è´Ÿè´£çš„æ‰€æœ‰æœåŠ¡ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint64&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rps&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æœåŠ¡å®šä¹‰&#34;&gt;æœåŠ¡å®šä¹‰&lt;/h3&gt;
&lt;p&gt;æœåŠ¡å®šä¹‰ä¾ç„¶ä¹Ÿåªå®šä¹‰äº†ä¸€ä¸ªæœåŠ¡ OpenRcaServiceã€‚&lt;/p&gt;
&lt;p&gt;OpenRcaServiceæ˜¯ä¸€ä¸ªå¸¦å¤–ï¼ˆOut-of-band/OOBï¼‰è´Ÿè½½æŠ¥å‘ŠæœåŠ¡ï¼Œå®ƒä¸åœ¨è¯·æ±‚è·¯å¾„ä¸Šã€‚OpenRcaServiceå®šæœŸä»¥è¶³å¤Ÿçš„é¢‘ç‡å¯¹æŠ¥å‘Šè¿›è¡Œé‡‡æ ·ï¼Œä»¥æä¾›ä¸è¯·æ±‚çš„å…³è”ã€‚ OOBæŠ¥å‘Šå¼¥è¡¥äº†å¸¦å†…ï¼ˆin-bandï¼‰æŠ¥å‘Šçš„å±€é™æ€§ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-protobuf&#34; data-lang=&#34;protobuf&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OpenRcaService&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;rpc&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;StreamCoreMetrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OrcaLoadReportRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;returns&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;udpa.data.orca.v1.OrcaLoadReport&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;æ³¨è§£å®šä¹‰&#34;&gt;æ³¨è§£å®šä¹‰&lt;/h3&gt;
&lt;p&gt;UDPAç›®å‰å®šä¹‰äº†å››ä¸ªæ³¨è§£ï¼ˆAnnotationï¼‰ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MigrateAnnotationï¼š ç”¨äºæ ‡è®°åœ¨å‰åç‰ˆæœ¬ä¸­çš„å’Œè¿ç§»ç›¸å…³çš„APIå˜æ›´ï¼ŒåŒ…æ‹¬ rename / oneof_promotion / move_to_package ç­‰å¤šç§è¯­ä¹‰ã€‚&lt;/li&gt;
&lt;li&gt;SensitiveAnnotationï¼šå°†æŸä¸ªå­—æ®µæ ‡è®°ä¸ºâ€œæ•æ„Ÿâ€å­—æ®µï¼Œä¾‹å¦‚ä¸ªäººèº«ä»½ä¿¡æ¯ï¼Œå¯†ç æˆ–ç§é’¥&lt;/li&gt;
&lt;li&gt;StatusAnnotationï¼šæ ‡è®°çŠ¶æ€ï¼Œæ¯”å¦‚å°†æŸä¸ªæ–‡ä»¶æ ‡è®°ä¸ºâ€œwork_in_progress/è¿›è¡Œä¸­â€&lt;/li&gt;
&lt;li&gt;VersioningAnnotationï¼šç”¨äºè®°å½•ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚é€šè¿‡ previous_message_type è¡¨ç¤ºå½“å‰messageåœ¨ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­çš„ç±»å‹&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿˜æœ‰ä¸€ä¸ª ProtodocAnnotation åœ¨æå‡ºè®¾è®¡åï¼Œå­˜åœ¨åˆ†æ­§ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰æ­£å¼åŠ å…¥ UDPAã€‚è¿™ä¸ªæ³¨è§£çš„ç›®çš„æ˜¯æ ‡è®°å½“å‰å°šæœªå®ç°çš„UDPAæ¶ˆæ¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;udpa-apiæ€»ç»“&#34;&gt;UDPA APIæ€»ç»“&lt;/h3&gt;
&lt;p&gt;ä»ä¸Šé¢åˆ—å‡ºçš„UDPA APIåˆ—è¡¨å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰ UDPA ä¸­æ­£å¼æ¨å‡ºçš„API å†…å®¹éå¸¸çš„å°‘ï¼Œä¹Ÿå°±ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸€ä¸ªTypedStructç±»å‹å®šä¹‰&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªOpenRcaServiceæœåŠ¡å®šä¹‰å’Œé…å¥—çš„OracLoadReportæ•°æ®å®šä¹‰&lt;/li&gt;
&lt;li&gt;4ä¸ªæ³¨è§£&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è€ƒè™‘åˆ°UDPAæ¨å‡ºçš„æ—¶é—´æ˜¯ 2019å¹´5æœˆä»½ï¼Œè¿„ä»Šæœ‰9ä¸ªæœˆçš„æ—¶é—´ï¼Œè¿™ä¸ªè¿›å±•æœ‰äº›å‡ºä¹æ„æ–™ã€‚&lt;/p&gt;
&lt;p&gt;ç¿»äº†ä¸€é &lt;a href=&#34;https://github.com/cncf/udpa&#34;&gt;https://github.com/cncf/udpa&lt;/a&gt; ä¸Šçš„å†…å®¹ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ commit å’Œ PR ï¼Œå‘ç°æ´»è·ƒçš„å¼€å‘è€…ä¸»è¦æ˜¯ä¸¤ä½åŒå­¦ï¼šGoogle çš„ htuch å’Œ Tetrateå…¬å¸çš„ Lizanã€‚ç„¶å cncf/UDPA é¡¹ç›®çš„ star æ•°é‡ä¹Ÿéå¸¸ä½ï¼Œæ‰ 55 ä¸ª starï¼Œå¯ä»¥è®¤ä¸ºç¤¾åŒºåŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆäººå…³æ³¨ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œç¨åå½“æˆ‘çœ‹åˆ° UDPA çš„è®¾è®¡æ–‡æ¡£æ—¶ï¼Œæ‰å‘ç°åŸæ¥ UDPA çš„ç²¾åéƒ½åœ¨è®¾è®¡ä¸­ï¼Œåªæ˜¯è¿›åº¦åŸå› è¿˜æœªèƒ½æ­£å¼å‡ºæˆå‹çš„APIã€‚&lt;/p&gt;
&lt;h2 id=&#34;udpaè®¾è®¡&#34;&gt;UDPAè®¾è®¡&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ UDPA çš„è®¾è®¡ï¼Œä¸»è¦çš„è®¾è®¡æ–‡æ¡£æœ‰ä¸¤ä»½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1eubmNM2Kynzf7Rpms4nncvTSL6NnANTrpHNWzeIBoZw/&#34;&gt;UDPA-TP strawman&lt;/a&gt;: UDPAè®¾è®¡ä¹‹ä¼ è¾“åè®®(TransPort)ï¼Œæ˜¯ç”¨äºUDPAçš„ä¸‹ä¸€ä»£ä¼ è¾“åè®®&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1orxTIL9FXtgmyl5TtPRBqGjgp1ekL7oOKDd95wxeCRY/&#34;&gt;UDPA-DM: L7 routing strawman&lt;/a&gt;: UDPAè®¾è®¡ä¹‹æ•°æ®æ¨¡å‹(Data Model)ï¼Œæ˜¯å¯¹é€šè¿‡ UDPA-TP ä¼ è¾“çš„èµ„æºå®šä¹‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;UDPAå¯¹æ­¤çš„è§£é‡Šæ˜¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Envoy v2 xDS API å½“å‰æ­£åœ¨è½¬å‘é€šç”¨æ•°æ®å¹³é¢APIï¼ˆUniversal Dataplane API/UDPAï¼‰ã€‚é‡ç‚¹æ˜¯ä¼ è¾“åè®®ä¸æ•°æ®æ¨¡å‹çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å…³äºä¼ è¾“åè®®ä¸æ•°æ®æ¨¡å‹çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯â€œé›†è£…ç®±è¿è¾“æœºåˆ¶â€ï¼ˆç±»æ¯” UDPA-TP ï¼‰å’Œ â€œé›†è£…ç®±ä¸­æ ‡å‡†è§„æ ¼â€ï¼ˆç±»æ¯” UDPA-DMï¼‰ã€‚åœ¨ UDPA çš„è®¾è®¡ä¸­ï¼Œæ•°æ®æ¨¡å‹çš„å®šä¹‰å’Œä¼ è¾“åè®®çš„å®ç°æ˜¯åˆ†ç¦»çš„ï¼Œè¿™æ„å‘³ç€åªè¦è®¾è®¡ä¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œå°±å¯ä»¥é‡ç”¨ä¸€å¥—ç»Ÿä¸€çš„ä¼ è¾“åè®®ã€‚å› æ­¤ï¼ŒUDPA çš„å¯æ‰©å±•æ€§å°±å˜å¾—éå¸¸å¼ºå¤§ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹æ­¤ï¼Œæˆ‘ä¸ªäººæœ‰äº›æƒŠå–œï¼Œå› ä¸ºå»å¹´å¹´åº•æˆ‘å’Œå½¦æ—åŒå­¦åœ¨å•†è®¨é€šè¿‡ MCP/xDS/UDPA åè®®èåˆæ³¨å†Œä¸­å¿ƒå’Œæ§åˆ¶å¹³é¢æ—¶ï¼Œå°±å‘ç°è¿™ä¸‰è€…çš„å·¥ä½œæœºåˆ¶éå¸¸ç±»ä¼¼ã€‚è€ƒè™‘åˆ°åç»­å¯èƒ½ä¼šæœ‰å„ç§ä¸åŒçš„èµ„æºéœ€è¦å®šä¹‰å¹¶åœ¨è¿™ä¸ªå·¥ä½œæœºåˆ¶ä¸Šåšèµ„æºåŒæ­¥å’Œåˆ†å‘ï¼Œå½“æ—¶æœ‰è¿‡ç±»ä¼¼çš„æƒ³æ³•ï¼Œå¸Œæœ›èƒ½æŠŠåº•å±‚è¿™å¥—èµ„æºåŒæ­¥æœºåˆ¶æ ‡å‡†åŒ–ï¼Œä»¥ä¾¿é‡ç”¨ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mcp-xds.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç›®å‰çœ‹æ¥ï¼ŒUDPA-TP å·²ç»åœ¨æœè¿™ä¸ªç›®æ ‡è¿ˆå‡ºäº†åšå®çš„æ­¥ä¼ã€‚å½“ç„¶å¦‚æœèƒ½å†å¾€å‰è¿ˆè¿›ä¸€æ­¥å°±æ›´å¥½äº†ï¼šè¿™ä¸ªåº•å±‚èµ„æºåŒæ­¥çš„å·¥ä½œæœºåˆ¶ï¼Œæ²¡æœ‰å¿…è¦é™åˆ¶åœ¨ UDPA çš„èŒƒç•´ï¼Œå®Œå…¨å¯ä»¥å˜æˆä¸€ä¸ªç”¨é€”æ›´åŠ å¹¿æ³›çš„é€šç”¨æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ UDPA-TP å’Œ UDPA-DM çš„è®¾è®¡ï¼Œä»¥ä¸‹å†…å®¹æ¥è‡ª UDPA çš„ä¸¤ä»½è®¾è®¡æ–‡æ¡£ä»¥åŠä¸ªäººçš„è§£è¯»ã€‚&lt;/p&gt;
&lt;h3 id=&#34;udpa-tpè®¾è®¡&#34;&gt;UDPA-TPè®¾è®¡&lt;/h3&gt;
&lt;p&gt;UDPA-TPçš„è®¾è®¡æ–‡æ¡£ï¼Œåœ¨å¼€å§‹éƒ¨åˆ†åˆ—å‡ºäº† UDPA-TP çš„å…³é”®è®¾è®¡åŠ¨æœºï¼Œå…·ä½“åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨ä¿ç•™ Core v2 xDS ä¸­å­˜åœ¨çš„æ¦‚å¿µæ€§pub-subæ¨¡å‹çš„åŒæ—¶ï¼Œè¿˜æ”¯æŒé«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚LRS/HDSã€‚&lt;/li&gt;
&lt;li&gt;æ”¯æŒEnvoy Mobileå’Œå…¶ä»–DPLBå®¢æˆ·ç«¯çš„å¤§è§„æ¨¡æ‰©å±•&lt;/li&gt;
&lt;li&gt;ç®€å•çš„å®¢æˆ·ç«¯å’Œç®€å•çš„ç®¡ç†æœåŠ¡å™¨å®ç°ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿å¢é‡æ›´æ–°èµ„æºé«˜æ•ˆè€Œç®€å•ã€‚ï¼ˆå¤‡æ³¨ï¼šå¢é‡æ›´æ–°æ˜¯ç›®å‰ Istio/Envoy æ­£åœ¨åŠªåŠ›å®ç°çš„é‡ç‚¹ç‰¹æ€§ï¼‰&lt;/li&gt;
&lt;li&gt;æ”¯æŒèµ„æºè”é‚¦ã€‚ï¼ˆå¤‡æ³¨ï¼šå’Œæˆ‘ä¹‹å‰æ„æƒ³çš„é€šè¿‡MCPåè®®èšåˆå¤šä¸ªæ³¨å†Œä¸­å¿ƒ/é…ç½®ä¸­å¿ƒçš„æ€è·¯ä¸€è‡´ï¼Œå½“ç°å®ä¸­å­˜åœ¨å¤šä¸ªèµ„æºçš„æ¥æºæ—¶ï¼Œå°±å¿…é¡»æä¾›æœºåˆ¶æ¥èšåˆè¿™äº›èµ„æºå¹¶æä¾›ä¸€ä¸ªå…¨å±€çš„è§†å›¾ï¼‰&lt;/li&gt;
&lt;li&gt;ä½¿APIèµ„æºçš„å­èµ„æºå˜å¾—ç®€å•ä¸”å®ç°æˆæœ¬ä½ï¼Œå¹¶ä¸”ä½¿å…¶å¯ä»¥å¢é‡æ›´æ–°å’Œå¯è”åˆ&lt;/li&gt;
&lt;li&gt;ç»´æŠ¤å¯¹ä¸€è‡´æ€§æ¨¡å‹çš„æ”¯æŒ&lt;/li&gt;
&lt;li&gt;æ¶ˆé™¤v2 xDSå¥‡æ€ªä¹‹å¤„ï¼š
&lt;ul&gt;
&lt;li&gt;ACK/NACKä¸è®¢é˜…æ¶ˆæ¯çš„åˆå¹¶ã€‚åœ¨v2 xDSä¸­ï¼ŒDiscoveryRequestæ—¢æ˜¯è®¢é˜…è¯·æ±‚ï¼Œåˆæ˜¯å¯¹å…ˆå‰æ¶ˆæ¯çš„æ½œåœ¨ç¡®è®¤ã€‚è¿™å¯¼è‡´äº†ä¸€äº›å¤æ‚çš„å®ç°å’Œè°ƒè¯•ä½“éªŒã€‚ï¼ˆå¤‡æ³¨ï¼šè¿™ä¼šé€ æˆ UDPA äº¤äº’æ¨¡å¼å’ŒxDSçš„ä¸åŒï¼‰&lt;/li&gt;
&lt;li&gt;CDS/LDSæ˜¯ä¸EDS/RDSä¸åŒçš„APIå±‚ã€‚åœ¨v2 xDSä¸­ï¼ŒEDS/RDSæ˜¯å‡†å¢é‡çš„ï¼Œè€ŒCDS/LDSæ˜¯æœ€æ–°çŠ¶æ€ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ä»æ¦‚å¿µä¸Šè®²ï¼Œåœ¨Envoy v2 xDS API åŸºç¡€ä¸Šå°èŒƒå›´å˜æ›´ã€‚æˆ‘ä»¬ä¸å¸Œæœ›å¯¹UDPAç®¡ç†æœåŠ¡å™¨å®ç°è€…é€ æˆé‡å¤§çš„æ¦‚å¿µå’Œå®ç°å¼€é”€ã€‚ï¼ˆå¤‡æ³¨ï¼šä¸ªäººç†è§£ï¼Œè¿™åº”è¯¥æ˜¯ç›®å‰ UDPA æ²¡æœ‰å¤§å¼ æ——é¼“çš„åˆ¶å®šå„ç§APIçš„åŸå› ï¼ŒUDPA å’Œ xDSï¼ŒåŒ…æ‹¬å’Œ xDS çš„å®é™…å®ç°è€… Envoy çš„å…³ç³»è¿‡äºç´§å¯†ï¼Œå› æ­¤éœ€è¦è€ƒè™‘ä» xDS åˆ° UDPA çš„è¿‡æ¸¡ï¼Œä¸èƒ½ç®€å•çš„æ¨å‡ºä¸€å¥—å…¨æ–°çš„APIï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯ UDPA çš„æœ¯è¯­ï¼Œå¯¹äºåé¢ç†è§£ UDPA éå¸¸æœ‰å¸®åŠ©ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DPLBï¼šdata plane load balancerçš„ç¼©å†™ã€‚æ¶µç›–è¯¸å¦‚ä»£ç†ï¼ˆä¾‹å¦‚Envoyï¼‰æˆ–å®¢æˆ·ç«¯RPCåº“ï¼ˆä¾‹å¦‚gRPCå’ŒEnvoy Mobileï¼‰çš„ç”¨ä¾‹ã€‚ DPLBæ˜¯UDPAå®¢æˆ·ç«¯ã€‚ä»–ä»¬è´Ÿè´£å¯åŠ¨åˆ°ç®¡ç†æœåŠ¡å™¨çš„UDPAæµã€‚ï¼ˆå¤‡æ³¨ï¼šæ³¨æ„ï¼ŒDPLBä¸ä»…ä»…åŒ…å«ä»¥Envoyä¸ºä»£è¡¨çš„service mesh sidecarï¼Œä¹ŸåŒ…æ‹¬äº†ä»¥SDKå½¢å¼å­˜åœ¨çš„ç±»åº“å¦‚ gRPCï¼Œè€Œ gRPC ç›®å‰å·²ç»åœ¨å®ç° å¯¹ xDS æ¥å£çš„æ”¯æŒï¼‰&lt;/li&gt;
&lt;li&gt;Management server/ç®¡ç†æœåŠ¡å™¨ï¼šèƒ½å¤Ÿæä¾›UDPAæœåŠ¡çš„å®ä½“ã€‚ç®¡ç†æœåŠ¡å™¨å¯ä»¥ä»…æ˜¯UDPAæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯UDPAå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼ˆåœ¨è”é‚¦çš„æƒ…å†µä¸‹ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;UDPAï¼šé€šç”¨æ•°æ®å¹³é¢APIï¼Œå…¶ä¸­åŒ…æ‹¬æ•°æ®æ¨¡å‹ï¼ˆUDPA-DMï¼‰å’Œä¼ è¾“åè®®ï¼ˆUDPA-TPï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;UDPA-TPï¼šUDPA APIçš„åŸºå‡†ä¼ è¾“åè®®ã€‚&lt;/li&gt;
&lt;li&gt;UDPA-DMï¼šUDPA APIçš„æ•°æ®æ¨¡å‹ã€‚&lt;/li&gt;
&lt;li&gt;UaaSï¼šUDPA-as-a-serviceï¼Œäº‘æ‰˜ç®¡çš„UDPAç®¡ç†æœåŠ¡ã€‚ï¼ˆå¤‡æ³¨ï¼šGoogleåœ¨ GCP ä¸Šæä¾›çš„ Google Traffic Director å’Œ AWS æä¾›çš„ App Meshï¼Œå¯ä»¥è§†ä¸ºå°±æ˜¯ UaaS é›å½¢ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç„¶åæ˜¯å’Œè”é‚¦ç›¸å…³çš„æœ¯è¯­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Federation/è”é‚¦ï¼šå¤šä¸ªUDPAç®¡ç†æœåŠ¡å™¨çš„äº’æ“ä½œä»¥ç”ŸæˆUDPAé…ç½®èµ„æºã€‚&lt;/li&gt;
&lt;li&gt;Direct federation/ç›´æ¥è”é‚¦ï¼šå½“DPLBç›´æ¥è¿æ¥åˆ°å¤šä¸ªUDPAç®¡ç†æœåŠ¡å™¨å¹¶èƒ½å¤Ÿä»è¿™äº›æµä¸­åˆæˆå…¶é…ç½®èµ„æºæ—¶ã€‚&lt;/li&gt;
&lt;li&gt;Indirect federation/é—´æ¥è”é‚¦ï¼šå½“DPLBä¸€æ¬¡æœ€å¤šè¿æ¥ä¸€ä¸ªUDPAç®¡ç†æœåŠ¡å™¨ï¼ˆå¯¹äºæŸäº›ç»™å®šçš„èµ„æºç±»å‹ï¼‰ï¼Œå¹¶ä¸”UDPAç®¡ç†æœåŠ¡å™¨æ‰§è¡Œæ‰€æœ‰ä¸è”é‚¦æœ‰å…³çš„å·¥ä½œæ—¶ã€‚&lt;/li&gt;
&lt;li&gt;Advanced DPLB/é«˜çº§DPLBï¼šæ”¯æŒç›´æ¥è”é‚¦çš„DPLBï¼ˆéœ€è¦UDPA-Fed-TPï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;Simple DPLB/ç®€å•DPLBï¼šä¸æ”¯æŒç›´æ¥è”é‚¦çš„DPLBï¼Œå³ä»…åŸºçº¿UDPA-TPã€‚&lt;/li&gt;
&lt;li&gt;UDPA-Fed-DMï¼šUDPA-DMçš„è¶…é›†ï¼Œå…·æœ‰ç”¨äºè”é‚¦çš„å…¶ä»–èµ„æºç±»å‹ã€‚&lt;/li&gt;
&lt;li&gt;UDPA-Fed-TPï¼šæ”¯æŒè”é‚¦çš„UDPA-TPçš„è¶…é›†ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹å›¾å¯ä»¥å¸®åŠ©ç†è§£è¿™äº›æœ¯è¯­ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;udpa-tp-endpoint.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;(å¤‡æ³¨ï¼šå›¾ä¸­å¯èƒ½æœ‰è¯¯ï¼Œsimple UDPA management server å’Œ Advanced UDPA management server ä¹‹é—´åº”è¯¥æ˜¯ â€œUDPA-TPâ€, è€Œä¸åº”è¯¥æ˜¯ â€œUDPA-Fed-TPâ€ã€‚)&lt;/p&gt;
&lt;p&gt;UDPA-TP ä¼ è¾“åè®®æä¾›äº†åœ¨ç®¡ç†æœåŠ¡å™¨å’Œ DPLB å®¢æˆ·ç«¯ä¹‹é—´ä¼ è¾“å‘½åå’Œç‰ˆæœ¬åŒ–èµ„æºçš„æ–¹æ³•ã€‚æˆ‘ä»¬ç§°è¿™äº›å®ä½“ä¸º UDPA-TP ç«¯ç‚¹ã€‚ UDPA-TP ç«¯ç‚¹å¯ä»¥æ˜¯å®¢æˆ·ç«¯å’Œç®¡ç†æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸¤ä¸ªç®¡ç†æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨è”é‚¦é…ç½®æ—¶ï¼‰ã€‚ ä¸Šå›¾è¯´æ˜äº†ä½¿ç”¨ UDPA åœ¨ UDPA-TP ç«¯ç‚¹ä¹‹é—´ä¼ é€èµ„æºçš„å„ç§æ–¹å¼ã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ï¼ŒUDPAç®¡ç†æœåŠ¡å™¨åˆ†ä¸ºä¸¤ç§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç®€å•(simple)ï¼šå®é™…ä¸Šåªæ˜¯å¯¹ä¸é€æ˜èµ„æºçš„ç¼“å­˜ï¼ˆå‡ ä¹ä¸äº†è§£UDPA-DMï¼‰ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä»ä¸Šæ¸¸é«˜çº§UDPAç®¡ç†æœåŠ¡å™¨è·å–èµ„æºï¼Œå¹¶åˆ†å‘èµ„æºç»™ DPLBï¼Œè‡ªèº«ä¸äº§ç”Ÿèµ„æºã€‚&lt;/li&gt;
&lt;li&gt;é«˜çº§(advanced)ï¼šå¯¹ UDPA-DM æœ‰æ„ŸçŸ¥ï¼Œé€šå¸¸æ˜¯ç”¨æ¥è·å–ä¿¡æ¯å¹¶è½¬æ¢ä¸ºæ ‡å‡†åŒ–çš„èµ„æºï¼ˆå…¸å‹å¦‚ Istio ä¸­çš„ Pilotï¼‰ã€‚å¯ä»¥ç›´æ¥åˆ†å‘èµ„æºç»™åˆ° DPLBï¼Œä¹Ÿå¯ä»¥å‘é€èµ„æºç»™ç®€å•UDPAç®¡ç†æœåŠ¡å™¨ï¼Œç„¶åç”±ç®€å•UDPAç®¡ç†æœåŠ¡å™¨å†åˆ†å‘ç»™ DPLBã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è€Œå¯¹åº”çš„ DPLB å®¢æˆ·ç«¯ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç®€å•(simple)ï¼šå¯¹äºä»»ä½•é…ç½®æºï¼Œç®€å•çš„DPLBåœ¨ä»»ä½•æ—¶é—´ç‚¹æœ€å¤šåªèƒ½ä¸ä¸€å°ç®¡ç†æœåŠ¡å™¨è¿›è¡Œå¯¹è¯ã€‚&lt;/li&gt;
&lt;li&gt;é«˜çº§(advanced)ï¼šå°†å®ç°å¯¹ UDPA-Fed-TP çš„æ”¯æŒï¼Œå¹¶èƒ½å¤Ÿç›´æ¥ä½œä¸ºè”é‚¦ç«¯ç‚¹å‚ä¸ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç®€å• DPLB è™½ç„¶åªèƒ½è¿æ¥ä¸€å°ç®¡ç†æœåŠ¡å™¨ï¼Œä½†æ˜¯ä¹Ÿæ˜¯å¯ä»¥å®ç°è”é‚¦çš„ï¼šç®€å• DPLB è¿æ¥çš„ç®¡ç†æœåŠ¡å™¨å¯ä»¥å®ç°è”é‚¦ï¼Œç„¶åä¸º DPLB å®ç°äº†é—´æ¥è”é‚¦ã€‚ ï¼ˆå¤‡æ³¨ï¼šä¸Šå›¾ä¸­çš„ç®€å• DPLBå°±æ˜¯ä¾‹å­ï¼Œä¸¤ä¸ª Advanced UDPA management server ä¹‹é—´åšäº†è”é‚¦ï¼‰&lt;/p&gt;
&lt;h3 id=&#34;udpa-tpè®¾è®¡è§£è¯»&#34;&gt;UDPA-TPè®¾è®¡è§£è¯»&lt;/h3&gt;
&lt;p&gt;åœ¨è§£è¯» UDPA-TP çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ Istio ç»å…¸çš„ç»„ä»¶å’Œæ¶æ„å›¾ï¼Œä¸‹é¢åˆ†åˆ«æ˜¯ Istio 1.0 å’Œ Istio 1.1 çš„æ¶æ„å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;istio-components.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;è€ƒè™‘åˆ° Mixer å’Œ Citadel ä¸¤ä¸ªç»„ä»¶å’Œ UDPA çš„å…³ç³»ç›¸æ¯”æ²¡é‚£ä¹ˆå¤§ï¼Œ æˆ‘ä»¬é‡ç‚¹çœ‹ Proxy / Pilot / Galleyï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Proxyåœ¨ Istio ä¸­å°±æ˜¯ Envoy ï¼ˆæˆ‘ä»¬çš„MOSNæ­£åœ¨åŠªåŠ›æˆä¸ºå€™é€‰æ–¹æ¡ˆï¼‰ ï¼Œç›´æ¥å¯¹ç­‰ UDPA ä¸­çš„ DPLB çš„æ¦‚å¿µã€‚ä½†æ˜¯Istio ä¸­çš„ Proxyï¼ŒåŠŸèƒ½ä¸Šåªå’Œä¸Šå›¾ä¸­çš„ Simple DPLB å¯¹é½ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒUDPA-TP è®¾è®¡ä¸­å¢åŠ äº†ä¸€ä¸ªèƒ½å¤Ÿè¿æ¥å¤šä¸ª UDPA management serverè¿›è¡Œè”é‚¦çš„ Advanced DPLBã€‚&lt;/li&gt;
&lt;li&gt;Pilot å’Œ Galleyï¼Œä»å’Œ DPLB çš„è¿æ¥å…³ç³»çœ‹ï¼Œåˆ†åˆ«å¯¹åº”ç€UDPA-TP è®¾è®¡ä¸­çš„ Simple UDPA management server å’Œ Advanced UDPA management serverã€‚ä½†ä»å®é™…å®ç°çš„åŠŸèƒ½çœ‹ï¼Œç›®å‰Pilotçš„èŒè´£è¿œè¿œè¶…è¿‡äº† Simple UDPA management server çš„è®¾è®¡ï¼Œè€Œ Galley çš„åŠŸèƒ½åˆ™è¿œè¿œå°‘äº Advanced UDPA management serverã€‚å¦‚æœæœªæ¥ Istio çš„æ¶æ„å’Œç»„ä»¶è¦å‘ UDPA çš„è®¾è®¡é æ‹¢ï¼Œåˆ™æ˜¾ç„¶ Pilot å’Œ Galley çš„èŒè´£è¦å‘ç”Ÿå·¨å¤§è°ƒæ•´ã€‚&lt;/li&gt;
&lt;li&gt;æœ€å¤§çš„å·®å¼‚è¿˜æ˜¯åœ¨äº UDPA-TP ä¸­å¼•å…¥äº†è”é‚¦çš„æ¦‚å¿µï¼Œè€Œä¸”åŒæ—¶æ”¯æŒåœ¨ DPLB å’Œ Advanced UDPA management server ä¸Šåšè”é‚¦ã€‚å°¤å…¶æ˜¯ DPLB è¦å®ç°è”é‚¦åŠŸèƒ½ï¼Œåˆ™å¿…ç„¶ä¼šè®© DPLB çš„åŠŸèƒ½å¤§ä¸ºå¢åŠ ï¼Œç›¸åº”çš„ DPLB å’Œ UDPA management server çš„é€šè®¯åè®® ï¼ˆç›®å‰æ˜¯xDSï¼‰ä¹Ÿå°†ä¸ºè”é‚¦çš„å®ç°å¢åŠ å¤§é‡å†…å®¹ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯¹ç…§ UDPA-TP çš„è®¾è®¡ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://skyao.io/post/202002-udpa-follow-up/images/udpa-tp-endpoint.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;UDPA-TPçš„è®¾è®¡ç›®å‰åº”è¯¥è¿˜æ²¡æœ‰å¯¹åº”çš„å…·ä½“çš„å®ç°äº§å“ï¼Œè€Œä¸”æˆ‘ä¹Ÿè¿˜æ²¡æœ‰æ‰¾åˆ° UDPA-Fed-TP çš„è¯¦ç»†çš„APIè®¾è®¡ã€‚èµ„æ–™æ¥æºå¤ªå°‘ï¼Œæ‰€ä»¥åªèƒ½ç®€å•çš„åšä¸€äº›ä¸ªäººçš„åˆæ­¥è§£è¯»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;é¦–å…ˆï¼ŒSimple UDPA management server çš„å¼•å…¥æ˜¯ä¸€å¤§äº®ç‚¹ï¼ŒåŠŸèƒ½è¶³å¤Ÿç®€å•è€Œä¸”ä¸“æ³¨ï¼Œèšç„¦åœ¨å°†æ•°æ®ï¼ˆåœ¨UDPAä¸­ä½“ç°ä¸ºèµ„æºï¼‰åˆ†å‘ç»™ DPLB ï¼ˆå¦‚å¤§å®¶ç†Ÿæ‚‰çš„æ•°æ®å¹³é¢ï¼‰ã€‚æ¯«æ— ç–‘é—®ï¼ŒSimple UDPA management server çš„é‡ç‚¹å¿…ç„¶ä¼šåœ¨è¯¸å¦‚ å®¹é‡ / æ€§èƒ½ / ä¸‹å‘æ•ˆç‡ / ç¨³å®šæ€§ ç­‰å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼Œå¼¥è¡¥ç›®å‰ Istio è®¾è®¡ä¸­ Pilot ä¸‹å‘æ€§èƒ½èµ¢å¼±çš„çŸ­æ¿ã€‚ä»è¿™ä¸ªè§’åº¦è¯´ï¼Œæˆ‘å€¾å‘äºå°† Simple UDPA management server ç†è§£ä¸ºä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œä»‹äº DPLB å’Œ Pilot ä¹‹é—´ã€‚&lt;/p&gt;
&lt;p&gt;å°ç»“ï¼š&lt;strong&gt;è§£å†³å®¹é‡å’Œæ€§èƒ½é—®é¢˜&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å…¶æ¬¡ï¼ŒAdvanced UDPA management server å¼•å…¥äº†è”é‚¦çš„æ¦‚å¿µï¼Œ ä¸Šé¢çš„å›¾ç‰‡æ˜¾ç¤ºæ˜¯ä¸ºäº†åœ¨ä¸¤ä¸ªä¸åŒçš„äº‘ä¾›åº”å•†ï¼ˆCloud Provider X å’Œ Cloud Provider Yï¼‰å’Œæœ¬åœ°ï¼ˆOn-premiseï¼‰ä¹‹é—´è¿›è¡Œè”é‚¦ï¼Œè¿™æ˜¯å…¸å‹çš„æ··åˆäº‘çš„åœºæ™¯ã€‚è€Œæˆ‘çš„ç†è§£æ˜¯ï¼Œè”é‚¦ä¸ä»…ä»…ç”¨äºå¤šäº‘ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¤šæ•°æ®æ¥æºï¼Œæ¯”å¦‚æ‰“é€šå¤šä¸ªä¸åŒçš„æ³¨å†Œä¸­å¿ƒï¼Œè§£å†³å¼‚æ„äº’é€šé—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å°ç»“ï¼š&lt;strong&gt;è§£å†³å¤šæ•°æ®æ¥æºçš„å…¨å±€èšåˆé—®é¢˜&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç„¶åï¼Œæ¯”è¾ƒè´¹è§£çš„æ˜¯å¼•å…¥äº† Advanced DPLB çš„æ¦‚å¿µï¼Œè€Œä¸”ä»å›¾ä¸Šçœ‹ï¼Œä½¿ç”¨åœºæ™¯è¿˜éå¸¸å¤æ‚ï¼š1. ç¬¬ä¸€ä¸ªDPLBæ˜¯é—´æ¥è”é‚¦çš„å…¸å‹åœºæ™¯ï¼Œè¿˜æ¯”è¾ƒç®€å• 2. ç¬¬äºŒä¸ª DPLBé™¤äº†ä»¥åŒæ ·çš„æ–¹å¼åšäº†é—´æ¥è”é‚¦ï¼Œè¿˜ç›´æ¥é€šè¿‡ UDPA-Fed-TP åè®®å’Œ On-Premise çš„ Advanced UDPA management server è¿æ¥ï¼Œå®ç°äº†ç›´æ¥è”é‚¦ 3. ç¬¬ä¸‰ä¸ª DPLB åˆ™æ›´å¤æ‚ï¼Œåšäº†ä¸‰ä¸ªmanagement serverçš„è”é‚¦ ã€‚&lt;/p&gt;
&lt;p&gt;å°ç»“ï¼š&lt;strong&gt;å¤æ‚çš„åœºæ™¯å¿…ç„¶å¸¦æ¥å¤æ‚çš„æœºåˆ¶ï¼ŒèƒŒåæ¨åŠ¨åŠ›å¾…æŸ¥&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯¹äº UDPA-TP çš„è®¾è®¡ï¼Œæˆ‘ä¸ªäººæœ‰äº›ä¸å¤ªç†è§£ï¼Œä¸»è¦æ˜¯å¯¹äºè”é‚¦çš„ä½¿ç”¨åœºæ™¯ä¸Šï¼Œæˆ‘çš„ç–‘è™‘åœ¨äºï¼šçœŸçš„æœ‰è¿™ä¹ˆå¤æ‚çš„åœºæ™¯å—ï¼Ÿå°¤å…¶æ˜¯å°†è”é‚¦çš„åŠŸèƒ½å¼•å…¥åˆ° DPLBï¼Œè¿™å¿…ç„¶ä¼šä½¿å¾— xDS/UDPA åè®®ä¸å¾—ä¸ä¸ºæ­¤æä¾›è”é‚¦ API æ”¯æŒï¼Œè€Œ Envoy/MOSN ç­‰çš„å®ç°éš¾åº¦ä¹Ÿè¦å¤§ä¸ºæå‡ã€‚å› æ­¤ï¼Œé™¤éæœ‰ç‰¹åˆ«å¼ºçƒˆçš„éœ€æ±‚å’Œåœºæ™¯æ¨åŠ¨ï¼Œå¦åˆ™æœ€å¥½èƒ½åœ¨å¤æ‚åº¦å’ŒåŠŸèƒ½æ€§ä¹‹é—´åšå¥½å¹³è¡¡ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä¸ªäººæ›´å€¾å‘äºç±»ä¼¼ä¸‹é¢çš„è®¾è®¡ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;udpa-tp-simplized.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç»´æŒ DPLB å’Œ Simple UDPA management server çš„ç®€å•æ€§&lt;/li&gt;
&lt;li&gt;DPLB åªå¯¹æ¥ Simple UDPA management serverï¼Œåè®®å›ºå®šä¸º UDPA-TPï¼Œè”é‚¦å¯¹DPLBé€æ˜ï¼ˆåªå®ç°é—´æ¥è”é‚¦ï¼‰&lt;/li&gt;
&lt;li&gt;Simple UDPA management server é‡ç‚¹åœ¨äºå®¹é‡å’Œæ€§èƒ½çš„æå‡ï¼ŒåŒ…æ‹¬ç›®å‰æ­£åœ¨è¿›è¡Œä¸­çš„æ”¯æŒå„ç§èµ„æºçš„å¢é‡æ›´æ–°ã€‚&lt;/li&gt;
&lt;li&gt;Advanced UDPA management server è´Ÿè´£å®Œæˆè”é‚¦ï¼ŒåŒ…æ‹¬å’Œå…¶ä»–ç¯å¢ƒçš„Advanced UDPA management serveråšè”é‚¦ï¼Œä»¥åŠä»æœ¬åœ°çš„å…¶ä»–æ³¨å†Œä¸­å¿ƒèšåˆæ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ€»ä¹‹ï¼Œæˆ‘ä¸ªäººæ›´å€¾å‘äºè®© DPLB å’Œ Simple UDPA management server ä¿æŒç®€å•å’Œé«˜æ€§èƒ½ï¼Œè€Œå°†å¤æ‚åŠŸèƒ½äº¤ç»™ Advanced UDPA management server ã€‚åç»­æˆ‘ä¼šé‡ç‚¹å…³æ³¨ UDPA åœ¨è”é‚¦åŠŸèƒ½çš„å®ç°ï¼Œå¦‚æœ‰æ–°è¿›å±•å°½é‡åŠæ—¶æ’°æ–‡åˆ†äº«ã€‚&lt;/p&gt;
&lt;h3 id=&#34;udpaçš„èµ„æºå®šä¹‰å’Œè®¾è®¡&#34;&gt;UDPAçš„èµ„æºå®šä¹‰å’Œè®¾è®¡&lt;/h3&gt;
&lt;p&gt;åœ¨ UDPA-TP çš„è®¾è®¡ä¸­ï¼Œæ ¹æ®èµ„æºçš„æ¥æºï¼Œèµ„æºè¢«åˆ’åˆ†ä¸ºä¸¤ç±»ç±»å‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Configuration Resources/é…ç½®èµ„æºï¼šæ§åˆ¶å¹³é¢ç”Ÿæˆï¼Œç”±ç®¡ç†æœåŠ¡å™¨åˆ†å‘åˆ° DPLBã€‚å¹³å¸¸å¤§å®¶ç†Ÿæ‚‰çš„ï¼Œé€šè¿‡xDSåè®®ä¼ è¾“çš„ Listener / Route / Cluster / Endpoint ç­‰èµ„æºå°±å±äºè¿™ç§ç±»å‹ã€‚&lt;/li&gt;
&lt;li&gt;Client Resources/å®¢æˆ·èµ„æºï¼šDPLBç”Ÿæˆï¼Œå‡†å¤‡äº¤ç»™æ§åˆ¶å¹³é¢ä½¿ç”¨ã€‚å‰é¢ UDPA ä¸­å®šä¹‰çš„ OracLoadReport å°±æ˜¯å…¸å‹ä¾‹å­ï¼Œè¿™æ˜¯æœ€è¿‘æ‰æœ‰çš„æ–°ç‰¹æ€§ï¼Œç”± DPLB æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒçŠ¶æ€ï¼Œæ±‡æŠ¥ç»™åˆ°æ§åˆ¶å¹³é¢ï¼Œä»¥ä¾¿æ§åˆ¶å¹³é¢åœ¨å†³ç­–æ—¶å¯ä»¥æœ‰å¤šå®Œå–„çš„å‚è€ƒä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;èµ„æºåœ¨å®šä¹‰æ—¶ï¼Œå°†æœ‰ä¸‰ä¸ªé‡è¦å±æ€§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åç§°/Nameï¼šå¯¹äºç»™å®šç±»å‹æ˜¯å”¯ä¸€çš„ï¼Œè€Œä¸”èµ„æºåç§°æ˜¯ç»“æ„åŒ–çš„ï¼Œå…¶è·¯å¾„å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š&lt;code&gt;/&lt;/code&gt; ï¼Œä¾‹å¦‚ &lt;code&gt;com.acme.foo/service-a&lt;/code&gt; ã€‚æ³¨æ„ namespace çš„å¼•å…¥ï¼Œæ˜¯åé¢çš„èµ„æºè”é‚¦å’Œæ‰€æœ‰æƒå§”æ´¾çš„åŸºç¡€ã€‚&lt;/li&gt;
&lt;li&gt;ç±»å‹/Typeï¼šèµ„æºç±»å‹ç”± Type URL æä¾›çš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºã€‚&lt;/li&gt;
&lt;li&gt;ç‰ˆæœ¬/Versionï¼šå¯¹äºç»™å®šçš„å‘½åèµ„æºï¼Œå®ƒå¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‚¹å…·æœ‰ä¸åŒçš„ç‰ˆæœ¬ã€‚åœ¨èµ„æºå®šä¹‰ä¸­å¸¦ä¸Šç‰ˆæœ¬ä¹‹åï¼Œæ£€æµ‹èµ„æºæ˜¯å¦æœ‰æ›´æ–°å°±éå¸¸æ–¹ä¾¿äº†ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯èµ„æºå®šä¹‰çš„å®ä¾‹ï¼ˆåªæ˜¯ç¤ºæ„ï¼Œæš‚æ—¶è¿˜æ²¡æ­£å¼æˆä¸º UDPA APIçš„å†…å®¹ï¼‰ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-protobuf&#34; data-lang=&#34;protobuf&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;message&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Resource&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// èµ„æºçš„åç§°ï¼Œä»¥åŒºåˆ«äºå…¶ä»–åŒç±»å‹çš„èµ„æºã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// éµå¾ªåå‘DNSæ ¼å¼ï¼Œä¾‹å¦‚ com.acme.foo/listener-a
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// èµ„æºçº§åˆ«ç‰ˆæœ¬
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;version&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// èµ„æºæœ‰æ•ˆè´Ÿè½½ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é€šè¿‡ Any çš„ type URL æŒ‡å®šèµ„æºç±»å‹
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;google.protobuf.Any&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// èµ„æºçš„TTLã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ­¤æ—¶é—´æ®µåï¼Œèµ„æºå°†åœ¨DPLBä¸Šå¤±æ•ˆã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å½“ç®¡ç†æœåŠ¡å™¨çš„è¿æ¥ä¸¢å¤±æ—¶ï¼Œå°†æ”¯æŒèµ„æºçš„ä¼˜é›…é™çº§ï¼Œä¾‹å¦‚ç«¯ç‚¹åˆ†é…ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä½¿ç”¨æ–°çš„TTLæ¥æ”¶åˆ°ç›¸åŒçš„èµ„æº name/version/type å°†ä¸ä¼šå¯¼è‡´é™¤äº†åˆ·æ–°TTLä¹‹å¤–çš„ä»»ä½•çŠ¶æ€æ›´æ”¹ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æŒ‰éœ€èµ„æºå¯èƒ½è¢«å…è®¸è¿‡æœŸï¼Œå¹¶ä¸”å¯èƒ½åœ¨TTLè¿‡æœŸæ—¶è¢«é‡æ–°è·å–ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// TTLåˆ·æ–°æ¶ˆæ¯ä¸­çš„resourceå­—æ®µå¯èƒ½ä¸ºç©ºï¼Œname/version/typeç”¨äºæ ‡è¯†è¦åˆ·æ–°çš„èµ„æºã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;google.protobuf.Duration&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ttl&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt; &lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// èµ„æºçš„å‡ºå¤„ï¼ˆæ‰€æœ‰æƒï¼Œæ¥æºå’Œå®Œæ•´æ€§ï¼‰ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;Provenance&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;origin_info&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;UDPA-TP è®¾è®¡ä¸­çš„å…¶ä»–å†…å®¹ï¼Œå¦‚å®‰å…¨ / é”™è¯¯å¤„ç† / ä¼ è¾“ / ç”¨æˆ·æ•…äº‹ ç­‰ï¼Œå°±ä¸ä¸€ä¸€å±•å¼€äº†ï¼Œè¿™äº›è®¾è®¡ç›®å‰çœ‹ç¦»æ­£å¼æˆä¸º API è¿˜æœ‰ç‚¹è¿œã€‚å¦‚æœ‰å…´è¶£å¯ä»¥ç›´æ¥ç¿»é˜… UDPA-TP çš„è®¾è®¡æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;h3 id=&#34;udpa-dmè®¾è®¡&#34;&gt;UDPA-DMè®¾è®¡&lt;/h3&gt;
&lt;p&gt;UDPA è®¾è®¡çš„ä¸€ä¸ªæ ¸å¿ƒå†…å®¹å°±æ˜¯å°†ä¼ è¾“ï¼ˆTransPortï¼‰ä¸æ•°æ®æ¨¡å‹ï¼ˆDate Modelï¼‰çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå‰é¢ä»‹ç»äº† UDPA-TP çš„è®¾è®¡ï¼Œå¯ä»¥è¯´ç›®å‰è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå¹¶æœªå®Œå…¨å®šå‹ã€‚&lt;/p&gt;
&lt;p&gt;è€Œ UDPA-DM çš„è®¾è®¡ï¼Œæ„Ÿè§‰è¿›åº¦ä¸Šæ¯” UDPA-TP è¿˜è¦æ›´æ—©æœŸï¼Œè¿™å¤šå°‘æœ‰ç‚¹å‡ºä¹æ„æ–™ï¼šåŸä»¥ä¸º UDPA ä¼šåŸºäº xDS ç°æœ‰çš„æˆç†Ÿ API å®šä¹‰ï¼Œå¿«é€Ÿæ¨å‡ºä¸€å¥—è¦†ç›–å¸¸è§é€šç”¨åŠŸèƒ½çš„ API ï¼Œç”šè‡³ç›´æ¥æŠŠ xDS ä¸­çš„éƒ¨åˆ†å†…å®¹æ¸…ç†å¹²å‡€ä¹‹åæ¬è¿‡æ¥ã€‚ä½†äº‹å®æ˜¯ï¼šç›®å‰ UDPA-DM ä¸­å·²ç»å®šä¹‰çš„ API å†…å®¹éå¸¸å°‘ï¼Œä»…æœ‰ L7 Routing ï¼Œè€Œä¸”è¿˜åœ¨è®¾è®¡ä¸­ï¼Œå…¶ä»–å¤§å®¶ç†Ÿæ‚‰çš„ Listener / Cluster / Endpoint / Security / RatingLimit ç­‰APIéƒ½è¿˜æ²¡æœ‰çœ‹åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;è€Œ UDPA-DM çš„è®¾è®¡å’Œå®ç°æ–¹å¼ï¼Œä¹Ÿå› ä¸ºèµ„æ–™è¾ƒå°‘è€Œæœ‰äº›ä¸å¤Ÿæ˜æœ—ã€‚åœ¨ UDPA-DM çš„è®¾è®¡æ–‡æ¡£çš„å¼€å¤´ï¼Œæœ‰å¦‚ä¸‹ä¸€æ®µæè¿°ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;As a starting point, we recognize that the UDPA-DM is not required to be as expressive as any given DPLB clientâ€™s full set of capabilities, instead it should be possible to translate from UDPA-DM to various DPLB native configuration formats. We envisage UDPA-DM as a lingua franca that captures a large amount of useful functionality that a DPLB may provide, making it possible to build common control planes and ecosystems around UDPA capable DPLBs.&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬è®¤è¯†åˆ° UDPA-DM ä¸éœ€è¦åƒä»»ä½•å·²æœ‰çš„ DPLB å®¢æˆ·ç«¯é‚£æ ·ï¼Œå…¨éƒ¨èƒ½åŠ›éƒ½å…·å¤‡è¡¨ç°åŠ›ï¼Œè€Œæ˜¯åº”è¯¥å¯ä»¥ä» UDPA-DM è½¬æ¢ä¸ºå„ç§ DPLB åŸç”Ÿé…ç½®æ ¼å¼ã€‚æˆ‘ä»¬å°† UDPA-DM è®¾æƒ³ä¸ºä¸€ç§é€šç”¨è¯­è¨€ï¼Œå®ƒå…·å¤‡å¤§é‡ DPLB åº”è¯¥æä¾›çš„æœ‰ç”¨çš„åŠŸèƒ½ï¼Œä»è€Œæœ‰å¯èƒ½åœ¨æ”¯æŒ UDPA çš„ DPLB å‘¨å›´æ„å»ºé€šç”¨çš„æ§åˆ¶å¹³é¢å’Œç”Ÿæ€ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;The UDPA-DM will be a living standard. We anticipate that it will initially cover some obvious common capabilities shared by DPLBs, while leaving other behaviors to proxy specific API fields. Over time, we expect that the UDPA-DM will evolves via a &lt;a href=&#34;https://docs.google.com/document/d/1xeVvJ6KjFBkNjVspPbY_PwEDHC7XPi0J5p1SqUXcCl8/edit&#34;&gt;stable API versioning policy&lt;/a&gt; to accommodate functionalities as we negotiate a common representation.&lt;/p&gt;
&lt;p&gt;UDPA-DM å°†æˆä¸ºäº‹å®æ ‡å‡†ã€‚æˆ‘ä»¬æœŸæœ›å®ƒæœ€åˆå°†æ¶µç›– DPLB å…±æœ‰çš„ä¸€äº›æ˜¾è€Œæ˜“è§çš„é€šç”¨åŠŸèƒ½ï¼ŒåŒæ—¶å°†å…¶ä»–è¡Œä¸ºç•™ç»™ä»£ç†ç‰¹å®šçš„APIå­—æ®µã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬æœŸæœ› UDPA-DM å°†é€šè¿‡ç¨³å®šçš„APIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥æ¥å‘å±•ï¼Œä»¥å®¹çº³å„ç§åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬å°†åå•†é€šç”¨çš„è¡¨ç¤ºå½¢å¼ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¯¹è¿™ä¸¤æ®µæ–‡å­—æè¿°çš„ç†è§£ï¼Œæˆ‘æ˜¯æœ‰ä¸€äº›å›°æƒ‘çš„ï¼Œä¸»è¦åœ¨æ¸…æ¥šè§£ UDPA-DM çš„å®šä¹‰å’Œå…·ä½“çš„ DPLB åŸç”Ÿå®ç°ï¼ˆå…¸å‹å¦‚ Envoy çš„ xDSï¼‰ä¹‹é—´çš„å…³ç³»ã€‚ä¸‹é¢è¿™å¼ å›¾æ˜¯æˆ‘ç”»çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;udpa-dm-design.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å·¦è¾¹çš„å›¾æ˜¯è½¬æ¢æ–¹æ¡ˆï¼šæŒ‰ç…§ç¬¬ä¸€æ®µæ–‡å­—çš„æè¿°ï¼ŒUDPA-DM æ˜¯åšé€šç”¨å®šä¹‰ï¼Œç„¶åè½¬æ¢ï¼ˆTranslateï¼‰ä¸ºå„ç§ DPLB çš„åŸç”Ÿé…ç½®æ ¼å¼ã€‚è¿™æ„å‘³ç€ UDPA-DM API å’Œå®é™…çš„ DPLB åŸç”Ÿé…ç½®æ ¼å¼å¯èƒ½ä¼šæœ‰éå¸¸å¤§çš„ä¸åŒï¼Œç”šè‡³æœ‰å¯èƒ½æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„æ ¼å¼å®šä¹‰ã€‚è¿™ä¸ªå…³ç³»æœ‰ç‚¹ç±»ä¼¼ Istio API å’Œ xDS API çš„å…³ç³»ï¼Œä¹Ÿç±»ä¼¼äº SMI ï¼ˆå¾®è½¯æ¨å‡ºçš„ Service Mesh Interfaceï¼‰å’Œ xDS çš„å…³ç³»ã€‚&lt;/li&gt;
&lt;li&gt;å³è¾¹çš„å›¾æ˜¯å­é›†æ–¹æ¡ˆï¼šæŒ‰ç…§ç¬¬äºŒæ®µæ–‡å­—çš„æè¿°ï¼ŒUDPA-DM æ˜¯åšé€šç”¨å®šä¹‰ï¼Œä½†æ˜¯ä¸ä¼šåšè½¬æ¢ï¼Œå…¶ä»– DPLB ä¼šç›´æ¥å¤ç”¨è¿™äº› UDPA-DM çš„ API å®šä¹‰ï¼Œç„¶åè¡¥å……è‡ªèº«ç‰¹æœ‰çš„ API å®šä¹‰ã€‚ è¿™æ · UDPA-DM ä¼šä»¥é€šç”¨å­é›†çš„å½¢å¼å‡ºç°ï¼Œé€æ¸æ‰©å¤§èŒƒå›´ï¼Œç„¶åå…¶ä»– API ä¼šé€æ¸å°†è‡ªèº«çš„ API ä¸­å’Œ UDPA-DM é‡å çš„éƒ¨åˆ†æ›¿æ¢ä¸º UDPA-DM APIï¼Œåªä¿ç•™è‡ªèº«ç‰¹æœ‰çš„æ‰©å±•APIã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰é¢è°ˆåˆ° xDS çš„æ¼”è¿›è·¯çº¿ï¼Œ v3 / v4 ä¼šé€æ¸å‘ UDPA é æ‹¢ï¼Œå°¤å…¶ v4 ä¼šåŸºäº UDPA æ¥ã€‚ç›®å‰ç”±äº UDPA API è¿œæœªæˆå‹ï¼Œè€Œ xDS v3 ä¸­å¯¹ UDPA API çš„ä½¿ç”¨éå¸¸å°‘ï¼ˆåŸºæœ¬åªç”¨åˆ°äº† annotation å®šä¹‰ï¼‰ï¼Œå› æ­¤ç›®å‰åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ¡ˆå°šä¸æ˜æœ—ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯ UDPA-DM è®¾è®¡æ–‡æ¡£ä¸­æè¿°çš„ UDPA-DM çš„å…³é”®è®¾è®¡ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æè¿°L7è·¯ç”±å±‚ï¼Œè¯¥å±‚æè¿°ä¸»è¦ L7 DPLB ä¹‹é—´çš„å¸¸è§è¡Œä¸ºï¼ŒåŒ…æ‹¬ Envoyï¼ŒHAproxyï¼ŒNginxï¼ŒGoogle Cloud Platform URL mapping å’Œ Linkerdã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºä»£ç†/LBçš„ç‰¹æœ‰æ‰©å±•æä¾›çµæ´»æ€§ï¼Œç”¨äºä¸é€‚åˆé€šç”¨æŠ½è±¡çš„è¡Œä¸ºã€‚ å³ é€ƒç”Ÿèˆ±å£ï¼ˆescape hatchï¼‰ï¼ˆå¤‡æ³¨ï¼šç±»ä¼¼SQL æ–¹è¨€ï¼‰&lt;/li&gt;
&lt;li&gt;æä¾›L7è·¯ç”±è¡¨çš„å¯ä¼¸ç¼©æ€§å’Œæœ‰æ•ˆçš„å¯¹æ•°è¯„ä¼°ï¼ˆlogarithmic evaluationï¼‰ã€‚ ä¾‹å¦‚ï¼ŒEnvoy v2 xDSæ˜¯ä¸¥æ ¼çº¿æ€§è¯„ä¼°çš„è·¯ç”±è¡¨ï¼Œå…·æœ‰æ˜æ˜¾çš„æ‰©å±•é™åˆ¶ã€‚ å¯¹äºå¯ä»¥æ”¯æŒ UDPA-TP è¿™ä¸ªç‰¹æ€§çš„DPLBï¼Œåº”è¯¥å¯ä»¥æŒ‰éœ€è·å–è·¯ç”±è¡¨æ®µã€‚&lt;/li&gt;
&lt;li&gt;åœ¨v2 Envoy xDS APIä¸­æ”¯æŒçº¿æ€§åŒ¹é…è·¯ç”±è¡¨çš„æ—§æœ‰ç”¨æˆ·ã€‚&lt;/li&gt;
&lt;li&gt;åˆ é™¤å¤šxDSæ ·å¼APIçš„éœ€æ±‚ï¼Œä¾‹å¦‚ RDSï¼ŒVHDSå’ŒSRDSã€‚&lt;/li&gt;
&lt;li&gt;èµ„æºçš„å¯ç»„åˆæ€§ï¼› åº”è¯¥æœ‰å¯èƒ½æ”¯æŒUDPAè”é‚¦ç”¨ä¾‹ï¼Œå¸¦æœ‰è¯¸å¦‚è™šæ‹Ÿä¸»æœºè¿™ç§è¢«ç‹¬ç«‹ç®¡ç†çš„èµ„æºç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹é¢é‡ç‚¹çœ‹ L7 Routing çš„è®¾è®¡ã€‚&lt;/p&gt;
&lt;h3 id=&#34;routing-api-è®¾è®¡&#34;&gt;Routing API è®¾è®¡&lt;/h3&gt;
&lt;p&gt;Routing API ä¸­æœ‰ä¸‰ä¸ªæœ¯è¯­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡/Serviceï¼šæè¿°åç«¯æœåŠ¡çš„ä¸é€æ˜å­—ç¬¦ä¸²ï¼ˆæˆ–åœ¨Envoyçš„æœ¯è¯­ä¸­ï¼Œä¸ºé›†ç¾¤/Clusterï¼‰ã€‚ å½“å‰æ–‡æ¡£æœªæä¾›æœ‰å…³æœåŠ¡è¡¨ç¤ºçš„ä»»ä½•è¿›ä¸€æ­¥è¯¦ç»†è¯´æ˜ï¼Œè¿™ç•™å¾…ä»¥åçš„å·¥ä½œã€‚&lt;/li&gt;
&lt;li&gt;è·¯ç”±è¡¨/Route tableï¼šä¸€ç»„åŒ¹é…æ¡ä»¶ï¼Œç”¨äºHTTPè¯·æ±‚å’Œç›¸å…³æ“ä½œã€‚ æ“ä½œå¯ä»¥åŒ…æ‹¬é‡å®šå‘æˆ–è½¬å‘åˆ°ç‰¹å®šæœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;L7è·¯ç”±/L7 routingï¼šæ ¹æ®è·¯ç”±è¡¨è¯„ä¼°ç»™å®šçš„HTTPè¯·æ±‚ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨ UDPA-DM çš„ Routing API è®¾è®¡ä¸­ï¼Œé’ˆå¯¹è¯·æ±‚åŒ¹é…çš„æ–¹å¼ï¼Œç›¸æ¯” xDS åšäº†é‡å¤§çš„æ”¹åŠ¨ï¼Œä¸»è¦ä½“ç°åœ¨é™¤äº†çº¿æ€§åŒ¹é…ä¹‹å¤–ï¼Œè¿˜æ”¯æŒåˆ†å±‚åŒ¹é…ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹çº¿æ€§åŒ¹é…å’Œåˆ†å±‚åŒ¹é…è¿™ä¸¤ç§è·¯ç”±æ—¶éœ€è¦ç”¨åˆ°çš„è¯·æ±‚åŒ¹é…æ–¹å¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;çº¿æ€§ï¼ˆLinearï¼‰ï¼šå…¶ä¸­è·¯ç”±è¡¨ç±»ä¼¼äº&lt;code&gt;[([Match], Action)]&lt;/code&gt; ç±»å‹ã€‚ åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œè·¯ç”±è¡¨æ˜¯ åŒ¹é… criteria-action æ¡ä»¶çš„æœ‰åºåˆ—è¡¨ã€‚ æ¯ä¸ªåŒ¹é…çš„ criteria æ˜¯åŒ¹é… criteria çš„é€»è¾‘â€ä¸â€ï¼Œä¾‹å¦‚
&lt;ul&gt;
&lt;li&gt;If :authority == foo.com AND path == / AND x-foo == bar THEN route to X&lt;/li&gt;
&lt;li&gt;If :authority == bar.com AND x-baz == wh00t THEN route to Y&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;åˆ†å±‚(Hierarchical)ï¼šå…¶ä¸­è·¯ç”±è¡¨ç±»ä¼¼äºæ ‘ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å…·æœ‰&lt;code&gt;(MatchCriteria, [(Value, Action)])&lt;/code&gt; ç±»å‹ã€‚ é€šè¿‡è¿™ç§ç»“æ„ï¼Œä»»ä½•ç»™å®šçš„èŠ‚ç‚¹éƒ½ä¼šåªè¯„ä¼°å•ä¸ªåŒ¹é…æ¡ä»¶ï¼Œä¾‹å¦‚&lt;code&gt;:authority&lt;/code&gt; çš„å€¼ã€‚åˆ†å±‚åŒ¹é…èƒ½æä¾›ç›¸å¯¹é«˜æ•ˆçš„å®ç°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç›®å‰ xDS v2 APIä½¿ç”¨çš„æ˜¯çº¿æ€§åŒ¹é…æ–¹å¼ï¼Œè€Œ UDPA-DM çš„ Routing API ä¼šå¼•å…¥åˆ†å±‚åŒ¹é…ï¼Œå½¢æˆçº¿æ€§-åˆ†å±‚çš„æ··åˆåŒ¹é…æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upda-hybird-model.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;è®¾è®¡æ–‡æ¡£å¯¹è¿™ä¸ªæ··åˆåŒ¹é…æ¨¡å‹æœ‰å¦‚ä¸‹è¯´æ˜ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The model does not map directly to any given DPLB today but borrows from some Envoy concepts and should have an efficient realization. It may be possible to use HAproxy ACLs to model this topology.&lt;/p&gt;
&lt;p&gt;ç›®å‰è¯¥æ¨¡å‹å¹¶æ²¡æœ‰ç›´æ¥æ˜ å°„åˆ°ä»»ä½•ç»™å®šçš„DPLBï¼Œè€Œæ˜¯å€Ÿé‰´äº†Envoyçš„ä¸€äº›æ¦‚å¿µï¼Œè¿™ä¸ªæ¨¡å‹åº”è¯¥ä¼šæœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å®ç°ã€‚å¯èƒ½ä¼šä½¿ç”¨HAproxy ACLå¯¹è¿™ç§æ‹“æ‰‘è¿›è¡Œå»ºæ¨¡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç”±äºç›®å‰ Routing API å¹¶æ²¡æœ‰å®Œæˆè®¾è®¡ï¼Œä¹Ÿæ²¡æœ‰æ­£å¼æˆä¸º UDPA çš„APIï¼Œè€Œåœ¨æœ€æ–°åˆšå®šç¨¿çš„ xDS v3 åè®®ä¸­ï¼ŒRoutesDiscoveryService å’Œ ScopedRoutesDiscoveryService ä¹Ÿéƒ½æ²¡æœ‰å¼•å…¥è¿™ä¸ªæ–°çš„æ¨¡å‹ï¼Œå› æ­¤é¢„æœŸè¿™ä¸ªæ¨¡å‹å°†åœ¨2020å¹´ç»§ç»­å®Œæˆè®¾è®¡å’Œå®šç¨¿ï¼Œå¯èƒ½åœ¨å¹´åº•çš„ xDS v4 ä¸­ä¼šæœ‰æ‰€ä½“ç°ã€‚ç„¶åï¼ŒUDPA-DM å’Œ xDS ä¹‹é—´åˆ°åº•ä¼šæ˜¯è½¬æ¢æ¨¡å‹ï¼Œè¿˜æ˜¯å­é›†æ¨¡å‹ï¼Œå±Šæ—¶å°±æ¸…æ¥šäº†ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äº Routing API å°šæœªè®¾è®¡å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œä¸è¯¦ç»†å±•å¼€ Routing API çš„å®šä¹‰äº†ã€‚Routing API çš„ç›¸å…³èµ„æ–™å¦‚ä¸‹ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ï¼ˆç„¶è€Œå·²ç»å¾ˆé•¿æ—¶é—´æ²¡æœ‰æ–°çš„è¿›å±•äº†ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Issue è®¨è®º [&lt;a href=&#34;https://github.com/cncf/udpa/pull/4&#34;&gt;WiP] L7 routing straw man&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åœ¨ PR ä¸­æäº¤çš„ Routing API å®šä¹‰æ–‡ä»¶ &lt;a href=&#34;https://github.com/cncf/udpa/pull/4/files#diff-40a6d8a368e77b5a9046c367cb47182b&#34;&gt;udpa/config/v1alpha/routing.proto&lt;/a&gt;ï¼šå¯ä»¥è‡ªè¡Œå’ŒxDS v3 çš„API åšä¸€ä¸ªæ¯”è¾ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;UDPA ç›®å‰è¿˜å¤„äºæ—©æœŸè®¾è®¡é˜¶æ®µï¼Œå…³é”®çš„ UDPA-TP å’Œ UDPA-DM çš„è®¾è®¡æœ‰æ¨å‡ºè‰ç¨¿ä½†æ˜¯è¿œæœªå®Œæˆï¼Œå†…å®¹ä¹Ÿå’Œæˆ‘ä»¬æœŸæœ›çš„ä¸€ä¸ªå®Œæ•´çš„é€šç”¨æ•°æ®å¹³é¢APIæœ‰å¾ˆé•¿çš„è·ç¦»ã€‚&lt;/p&gt;
&lt;p&gt;è€Œä¸”é¡¹ç›®è¿›å±•å¹¶ä¸ç†æƒ³ï¼Œæ„Ÿè§‰é‡è§†ç¨‹åº¦å’ŒäººåŠ›æŠ•å…¥éƒ½æœ‰é™ã€‚&lt;/p&gt;
&lt;h2 id=&#34;é™„è¨€&#34;&gt;é™„è¨€&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å› ä¸ºæƒ³äº†è§£ä¸€ä¸‹ UDPA çš„è¿›å±•ï¼Œæ‰€ä»¥åšäº† UDPA çš„è°ƒç ”å’Œå­¦ä¹ ï¼Œæ¯”è¾ƒé—æ†¾çš„æ˜¯ UDPA çš„èµ„æ–™éå¸¸åŒ®ä¹ï¼Œé™¤äº†æˆ‘æœ¬æ–‡åˆ—å‡ºæ¥çš„å‡ ä¸ªå®˜æ–¹ç½‘ç«™å’Œè®¾è®¡æ–‡æ¡£ä¹‹å¤–ï¼ŒåŸºæœ¬å°±åªæœ‰ Harvey çš„æ¼”è®²ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒç ”å®Œæˆä¹‹åå‘ç° UDPA çš„è¿›å±•ä¸å¦‚äººæ„ï¼Œå°¤å…¶æ˜¯æœ€è¿‘çš„å·¥ä½œå‡ ä¹åœæ»ï¼Œå…³é”®çš„ UDPA-TP å’Œ UDPA-DM çš„è®¾è®¡æœªèƒ½å®Œç¨¿ï¼ŒxDS v3 ä¸­ä¹Ÿåªå¼•ç”¨äº†æå°‘çš„ UDPA API å®šä¹‰ã€‚è¿™ç¯‡æ€»ç»“æ–‡ç« å·®ç‚¹å› æ­¤éš¾äº§ï¼Œå› ä¸ºæœªçŸ¥/å¾…å®š/æœªå®Œæˆçš„å†…å®¹å¤ªå¤šï¼Œè€Œä¸”ç”±äºç¼ºä¹èµ„æ–™è¾“å…¥ï¼Œå¾ˆå¤šä¿¡æ¯ä¹Ÿåªæ˜¯æˆ‘ä¸ªäººçš„ç†è§£å’Œæƒ³æ³•ï¼ŒæŒ‰è¯´è¿™ä¸æ˜¯ä¸€ä¸ªä¸¥è°¨çš„æ·±åº¦ä»‹ç»æ–‡ç« åº”æœ‰çš„æ€åº¦ã€‚&lt;/p&gt;
&lt;p&gt;ä½†è€ƒè™‘åˆ°ç›®å‰ UDPA çš„èµ„æ–™å®åœ¨æ˜¯å¤ªå°‘ï¼Œæœ¬ç€â€œæœ‰æ¯”æ²¡æœ‰å¥½â€çš„æƒ³æ³•ï¼Œæˆ‘ç¡¬ç€å¤´çš®å®Œæˆäº†è¿™ç¯‡æ–‡ç« ã€‚åç»­å¦‚æœæœ‰æ–°çš„è¾“å…¥ï¼Œæˆ‘ä¼šåŠæ—¶å®Œå–„æˆ–è€…ä¿®è®¢æœ¬æ–‡ï¼Œä¹Ÿæ¬¢è¿å¯¹ UDPA æœ‰å…´è¶£å’Œäº†è§£çš„åŒå­¦è”ç³»æˆ‘è®¨è®ºå’ŒæŒ‡å¯¼ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cncf/udpa&#34;&gt;https://github.com/cncf/udpa&lt;/a&gt; ï¼šUDPAåœ¨ github çš„é¡¹ç›®ï¼ŒAPI å®šä¹‰æ¥è‡ªè¿™é‡Œ&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1y-H-pQ2mmhBPX_U9pP3mMMUbEpZskxBdEbwd5KlivY4/edit#heading=h.fdi15bvpmxen&#34;&gt;Universal Data Plane API Working Group (UDPA-WG)&lt;/a&gt;: UDPAè®¾è®¡æ–‡æ¡£ï¼Œä½†æ˜¯å†…å®¹å¾ˆå°‘&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://lists.cncf.io/g/udpa-wg&#34;&gt;Universal Data Plane API Working Group (UDPA-WG)&lt;/a&gt;ï¼šCNCF ä¸‹çš„ UDPA å·¥ä½œç»„ï¼ŒåŠ å…¥ä¹‹åèƒ½çœ‹åˆ°ä¸€äº›èµ„æ–™&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1eubmNM2Kynzf7Rpms4nncvTSL6NnANTrpHNWzeIBoZw/&#34;&gt;UDPA-TP strawman&lt;/a&gt;: UDPA-TPçš„è®¾è®¡æ–‡æ¡£&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1orxTIL9FXtgmyl5TtPRBqGjgp1ekL7oOKDd95wxeCRY/&#34;&gt;UDPA-DM: L7 routing strawman&lt;/a&gt;: UDPA-DMçš„è®¾è®¡æ–‡æ¡£&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1xeVvJ6KjFBkNjVspPbY_PwEDHC7XPi0J5p1SqUXcCl8/&#34;&gt;Stable Envoy API versioning&lt;/a&gt; ï¼šEnvoy å®˜æ–¹æ–‡æ¡£ï¼Œè®²è¿° Envoy çš„ç¨³å®šAPIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.servicemesher.com/blog/cncf-udpa-wg/&#34;&gt;CNCFæ­£åœ¨ç­¹å»ºé€šç”¨æ•°æ®å¹³é¢APIå·¥ä½œç»„ï¼Œä»¥åˆ¶å®šæ•°æ®å¹³é¢çš„æ ‡å‡†API&lt;/a&gt;ï¼šæˆ‘å»å¹´å†™çš„ UDPA ä»‹ç»æ–‡ç« &lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://envoycon2019.sched.com/event/UxwL/the-universal-dataplane-api-udpa-envoys-next-generation-apis-harvey-tuch-google&#34;&gt;The Universal Dataplane API (UDPA): Envoyâ€™s Next Generation APIs&lt;/a&gt;ï¼šHarvey Tuch çš„æ¼”è®²ï¼Œå¸®åŠ©ç†è§£ xDS å’Œ UDPA çš„å…³ç³»&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - å…±äº«å†…å­˜æ¨¡å‹</title>
      <link>https://mosn.io/blog/code/mosn-shm/</link>
      <pubDate>Sun, 23 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-shm/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡è®°å½•äº†å¯¹ MOSN çš„æºç ç ”ç©¶ - MOSN çš„å…±äº«å†…å­˜æ¨¡å‹ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.9.0ï¼Œcommit id &lt;a href=&#34;https://github.com/mosn/mosn/tree/b2a239f5&#34;&gt;b2a239f5&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœºåˆ¶&#34;&gt;æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;MOSN ç”¨å…±äº«å†…å­˜æ¥å­˜å‚¨ metrics ä¿¡æ¯ã€‚MOSN ç”¨ mmap å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œåœ¨å†…å­˜æ•°ç»„ä¹‹ä¸Šå°è£…äº†ä¸€å±‚å…³äº metrics çš„å­˜å–é€»è¾‘ï¼Œå®ç°äº† &lt;a href=&#34;https://github.com/rcrowley/go-metrics&#34;&gt;go-metrics&lt;/a&gt;
åŒ…çš„å…³äº metrics çš„æ¥å£ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ç»„è£…å‡ºäº†ä¸€ç§åŸºäºå…±äº«å†…å­˜çš„ metrics å®ç°ä¾› MOSN ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åˆ›å»ºå…±äº«å†…å­˜mmap&#34;&gt;åˆ›å»ºå…±äº«å†…å­˜ï¼šMmap&lt;/h2&gt;
&lt;p&gt;æ“ä½œå…±äº«å†…å­˜çš„æ–¹æ³•ä¸»è¦åœ¨ &lt;code&gt;pkg/shm/shm.go&lt;/code&gt; æ–‡ä»¶ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSpan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewShmSpan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Free&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSpan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Clear&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;syscall&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Munmap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;origin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Clear&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Remove&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;path&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;éƒ½æ˜¯å›´ç»•ç€ &lt;code&gt;ShmSpan&lt;/code&gt; ç»“æ„ä½“çš„å‡ ä¸ªæ“ä½œæ–¹æ³•ã€‚å†æ¥çœ‹ &lt;code&gt;ShmSpan&lt;/code&gt; ç»“æ„ä½“ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ShmSpan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;origin&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// mmap è¿”å›çš„æ•°ç»„
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// span å, åˆ›å»ºæ—¶æŒ‡å®š
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt;   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uintptr&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä¿å­˜ mmap å†…å­˜æ®µçš„é¦–æŒ‡é’ˆ
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;offset&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// span å·²ç»ä½¿ç”¨çš„å­—èŠ‚é•¿åº¦
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// span å¤§å°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Alloc&lt;/code&gt; æ–¹æ³•æŒ‰ç…§ç»™å®šçš„ &lt;code&gt;name&lt;/code&gt; å‚æ•°ï¼Œåœ¨é…ç½®æ–‡ä»¶çš„ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œ &lt;code&gt;sync.Mmap&lt;/code&gt;ï¼Œå…¶æ–‡ä»¶å°ºå¯¸å³ &lt;code&gt;size&lt;/code&gt; å‚æ•°å¤§å°ã€‚Mmap è¿‡åï¼Œå°†ä¿¡æ¯ä¿å­˜åœ¨ ShmSpanç»“æ„å†…è¿”å›ã€‚&lt;/p&gt;
&lt;p&gt;ä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼š&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/shm/shm.go#L28&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/shm/shm.go#L28&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ç”±æ­¤çœ‹å‡ºï¼Œä¸€ä¸ª ShmSpan å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå…±äº«å†…å­˜å—ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬å°†ä¼šåˆ†æå…±äº«å†…å­˜å—åœ¨ MOSN é‡Œçš„ä½¿ç”¨åœºæ™¯ï¼šmetricsã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ“ä½œå…±äº«å†…å­˜é…ç½®&#34;&gt;æ“ä½œå…±äº«å†…å­˜ï¼šé…ç½®&lt;/h2&gt;
&lt;p&gt;åœ¨åˆ†æå¦‚ä½•é€šè¿‡å…±äº«å†…å­˜å­˜å– metrics ä¹‹å‰ï¼Œé¦–å…ˆçœ‹è¿™ç›¸å…³çš„åŠŸèƒ½æ˜¯å¦‚ä½•é…ç½®çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;initializeMetrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MetricsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init shm zone
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmZone&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSize&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;shm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitDefaultMetricsZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetMosnState&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Active_Reconfiguring&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»è¿™é‡Œçœ‹å‡ºï¼Œé€šè¿‡è¯»å–é…ç½®æ–‡ä»¶çš„ &lt;code&gt;ShmZone&lt;/code&gt; å’Œ &lt;code&gt;ShmSize&lt;/code&gt; æ¥åˆå§‹åŒ–å…±äº«å†…å­˜ï¼Œå³é…ç½®æ–‡ä»¶çš„ä»¥ä¸‹ä¸¤ä¸ªå­—æ®µæ˜¯æ§åˆ¶ç€å…±äº«å†…å­˜çš„æ–‡ä»¶åå’Œå¤§å°çš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#a40000&#34;&gt;...&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;metrics&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#a40000&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;shm_zone&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;æ–‡ä»¶å&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;shm_size&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;å…±äº«å†…å­˜æ–‡ä»¶å¤§å°&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
  &lt;span style=&#34;color:#a40000&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æ“ä½œå…±äº«å†…å­˜metrics&#34;&gt;æ“ä½œå…±äº«å†…å­˜ï¼šmetrics&lt;/h2&gt;
&lt;p&gt;metrics ç›¸å…³çš„é€»è¾‘åœ¨ &lt;code&gt;pkg/metrics&lt;/code&gt; åŒ…ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šæ–‡è¯´çš„ ShmSpan æ˜¯ä¿å­˜å…±äº«å†…å­˜ä¿¡æ¯çš„ç»“æ„ä½“ï¼Œè€Œè¦ç†è§£ MOSN metrics å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨ï¼Œè¿˜è¦å…ˆç†è§£ MOSN å°è£…çš„å‡ ä¸ªç»“æ„ä½“ï¼š&lt;code&gt;zone&lt;/code&gt;ã€&lt;code&gt;hashSet&lt;/code&gt; å’Œ &lt;code&gt;hashEntry&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;shm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSpan&lt;/span&gt;

	
	&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;   &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// mutex + ref = 64bit, so atomic ops has no problem
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slots&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;metricsEntry&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Prevents false sharing on widespread platforms with
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 128 mod (cache line size) = 0 .
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;pad&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;128&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;unsafe&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sizeof&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;metricsEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;128&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™å‡ ä¸ªç»“æ„ä½“ä¸ &lt;code&gt;ShmSpan&lt;/code&gt; çš„å…³ç³»å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./shm.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ShmSpan&lt;/code&gt; æ˜¯å…±äº«å†…å­˜å—ï¼Œè€Œ &lt;code&gt;zone&lt;/code&gt;ã€&lt;code&gt;hashSet&lt;/code&gt; å’Œ &lt;code&gt;hashEntry&lt;/code&gt; å¯¹ &lt;code&gt;ShmSpan&lt;/code&gt; è¿›è¡Œäº†åˆ’åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;hashSet&lt;/code&gt; å°è£…å‡ºäº† metrics name æ˜ å°„åˆ° metrics value çš„å“ˆå¸Œè¡¨&lt;/li&gt;
&lt;li&gt;&lt;code&gt;hashEntry&lt;/code&gt; æ˜¯å“ˆå¸Œè¡¨çš„å€¼ï¼Œä¹Ÿæ˜¯ metrics å€¼çš„ä¿å­˜çš„å…±äº«å†…å­˜ç©ºé—´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;zone&lt;/code&gt; å¯¹ &lt;code&gt;ShmSpan&lt;/code&gt; è¿›è¡Œäº†åˆ’åˆ†ï¼Œåˆ’åˆ†å‡ºäº†ä¸€ä¸ª &lt;code&gt;int32&lt;/code&gt; å€¼ä½œä¸ºäº’æ–¥é”ï¼›ä¸€ä¸ª &lt;code&gt;int32&lt;/code&gt; å€¼ä½œä¸º &lt;code&gt;zone&lt;/code&gt; çš„å¼•ç”¨è®¡æ•°ï¼›ä¹Ÿåˆ’åˆ†å‡ºäº†ä¸€ç‰‡ç©ºé—´ä¿å­˜ &lt;code&gt;hashSet&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šæ­¥éª¤åšå¥½åï¼Œåˆ›å»ºä¸€ä¸ª metrics å°±å¯ä»¥é€šè¿‡åˆ›å»ºå¯¹åº”çš„å“ˆå¸Œ key valueï¼Œæ‹¿åˆ°å¯¹åº”çš„å…±äº«å†…å­˜åœ°å€ï¼Œå­˜å– metrics ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;å®ç°å°ç»†èŠ‚&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;hashEntry å†…éƒ¨æœ‰ä¸€ä¸ª &lt;code&gt;pad&lt;/code&gt; å­—æ®µï¼Œå…¶ä½œç”¨æ˜¯ä¿æŒ hashEntry ç»“æ„ä½“å¤§å°æ˜¯ 128 çš„å€æ•°ï¼Œé¿å… false sharing&lt;/li&gt;
&lt;li&gt;ç»“æ„ä½“å†…çš„å­—æ®µé¡ºåºå’Œå¤§å°æ˜¯è°ƒæ•´è¿‡çš„ï¼Œæ¯”å¦‚ &lt;code&gt;hashEntry.value&lt;/code&gt;ã€&lt;code&gt;zone.set&lt;/code&gt;ï¼Œç›®çš„æ˜¯æ»¡è¶³åŸå­æ“ä½œçš„å†…å­˜å¯¹é½&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸‹é¢æ˜¯æºç æ­¥éª¤ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œè·Ÿè¸ªè°ƒè¯•ï¼š&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;1) åˆ›å»º zoneï¼š&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L81&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L81&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newSharedMetrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;alignedSize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;align&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pageSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ç”³è¯· ShmSpan
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;shm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;alignedSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1. mutex and ref
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä» span é‡Œå– 4 ä¸ªå­—èŠ‚åšäº’æ–¥é”
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä» span é‡Œå– 4 ä¸ªå­—èŠ‚åšå¼•ç”¨è®¡æ•°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;unsafe&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pointer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)),&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;unsafe&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pointer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)),&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 2. hashSet
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åˆ’åˆ†å“ˆå¸Œè¡¨è¿‡ç¨‹
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// assuming that 100 entries with 50 slots, so the ratio of occupied memory is
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// entries:slots  = 100 x 128 : 50 x 4 = 64 : 1
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// so assuming slots memory size is N, total allocated memory size is M, then we have:
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// M - 1024 &amp;lt; 65N + 28 &amp;lt;= M
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¡ç®— slot çš„æ•°é‡å’Œå†…å­˜å ç”¨å¤§å°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;alignedSize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;28&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;65&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slotsSize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¡ç®— entry æ•°é‡å’Œå†…å­˜å ç”¨å¤§å°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;entryNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;entrySize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsSize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;64&lt;/span&gt;
	
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å“ˆå¸Œè¡¨å†…å­˜å¤§å° = entry å†…å­˜å ç”¨ + 20 å­—èŠ‚ + slot å†…å­˜å ç”¨å¤§å°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;hashSegSize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entrySize&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsSize&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;hashSegment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;span&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSegSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// if zones&amp;#39;s ref &amp;gt; 0, no need to initialize hashset&amp;#39;s value
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åˆå§‹åŒ–å“ˆå¸Œè¡¨ç»“æ„
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newHashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSegment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hashSegSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entryNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LoadUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// add ref
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œå¯ä»¥å¤§è‡´è¯´ä¸€ä¸‹å“ˆå¸Œè¡¨åˆå§‹åŒ–çš„ç®—æ³•ï¼šé¦–å…ˆ &lt;code&gt;alignedSize&lt;/code&gt; è¡¨ç¤º 4k å¯¹é½åçš„ &lt;code&gt;ShmSpan&lt;/code&gt; å¤§å°ï¼Œå‰ 8 ä¸ªå­—èŠ‚è¢«åˆ†é…ä¸ºäº’æ–¥é”å’Œå¼•ç”¨è®¡æ•°ï¼Œ
å¦å¤– 20 ä¸ªå­—èŠ‚è¢«åˆ†é…ä¸ºå“ˆå¸Œè¡¨çš„ &lt;code&gt;meta&lt;/code&gt; ç»“æ„ä½“ï¼Œ&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L54&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L54&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slots&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;


&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cap&lt;/span&gt;       &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;freeIndex&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;bytesNum&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ‰€ä»¥çœŸæ­£èƒ½è¢«åˆ†é…ä¸ºå“ˆå¸Œè¡¨ä¿¡æ¯å‚¨å­˜çš„ç©ºé—´ = æ€»ç©ºé—´ - 8 å­—èŠ‚ - 20 å­—èŠ‚ã€‚é‚£èƒ½åˆ†é…å¤šå°‘ä¸ªå“ˆå¸Œè¡¨ä¿¡æ¯å‘¢ï¼Ÿè¦çœ‹çœ‹ MOSN çš„å“ˆå¸Œè¡¨ç»„ç»‡å½¢å¼ï¼š&lt;code&gt;entry&lt;/code&gt; æœ€å¼€å§‹é¦–å°¾ç›¸è¿ï¼Œåé¢ä¼šè¢«ç»„ç»‡æˆä¸€ä¸ªä¸€ä¸ªçš„ slot é“¾è¡¨ä¾›å“ˆå¸Œç¢°æ’æ—¶éå†æŸ¥è¯¢ã€‚
æ‰€ä»¥ slot å’Œ entry çš„æ¯”ä¾‹æ§åˆ¶ç€å“ˆå¸Œè¡¨æŸ¥æ‰¾çš„æ€§èƒ½ï¼šentry æ¯” slot ä½œä¸ºæ¯”ä¾‹çš„è¯ï¼Œæ¯”ä¾‹&lt;strong&gt;è¶Šé«˜&lt;/strong&gt;æ„å‘³ç€æ›´å®¹æ˜“ç¢°æ’ï¼Œé“¾è¡¨è¶Šé•¿ï¼ŒæŸ¥æ‰¾æ€§èƒ½ä¸‹é™ï¼›ç›¸åæ¯”ä¾‹&lt;strong&gt;è¶Šä½&lt;/strong&gt;é“¾è¡¨è¶ŠçŸ­ï¼ŒæŸ¥æ‰¾æ€§èƒ½è¶Šé«˜ï¼Œä½†æ˜¯æœ‰è¶Šå¤š slot é—²ç½®ï¼Œç©ºé—´ä¼šæµªè´¹ã€‚&lt;/p&gt;
&lt;p&gt;ä»æ³¨é‡Šçœ‹ï¼ŒMOSN å°†æ¯”ä¾‹å†™æ­»ä¸º &lt;code&gt;2ï¼š1&lt;/code&gt;ã€‚å‡è®¾ &lt;code&gt;100 ä¸ª entry + 50 ä¸ª slot&lt;/code&gt;ï¼Œå…¶å†…å­˜æ¯”ç­‰äº &lt;code&gt;100 * 128ï¼ˆentry å†…å­˜å ç”¨ï¼‰ï¼š50 * 4&lt;/code&gt; = &lt;code&gt;64ï¼š1&lt;/code&gt;ï¼Œå³ä¸€ä»½ &lt;code&gt;2ï¼š1&lt;/code&gt; çš„ entry+slot éœ€è¦ç”¨åˆ°&lt;code&gt;ï¼ˆ64 + 1ï¼‰* 4&lt;/code&gt; ä¸ªå­—èŠ‚ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œå¦‚æœæŒ‰ç…§ 2ï¼š1 æ¥åˆ†é…çš„è¯ï¼Œä¸€å…±å¯ä»¥åˆ†é…çš„ä»½æ•° = &lt;code&gt;å“ˆå¸Œè¡¨ä¿¡æ¯å‚¨å­˜ç©ºé—´ / æ¯ä¸€ä»½ç©ºé—´å ç”¨ = (æ€»ç©ºé—´ - 8 - 20) / (64 + 1) * 4&lt;/code&gt; ä»½ã€‚ç”±æ­¤å°±å¯ä»¥ç®—å‡º entry å’Œ slot å¯ä»¥åˆ†é…å¤šå°‘ä»½äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;2) åˆ›å»ºæŒ‡æ ‡ï¼š&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewShmCounterFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;gometrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Counter&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;gometrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Counter&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultZone&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L166&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L166&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;create&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L135&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L135&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1. search existed slots and entries
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¡ç®— hash å€¼ä½œä¸º slot index
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hash&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// name convert if length exceeded
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;maxNameLength&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// if name is longer than max length, use hash_string as leading character
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// and the remaining maxNameLength - len(hash_string) bytes follows
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;hStr&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strconv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Itoa&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;h&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hStr&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hStr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;maxNameLength&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:]&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;nameBytes&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æŸ¥æ‰¾é“¾è¡¨æ‰¾åˆ°å¯¹åº”çš„ entry
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashEntry&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slots&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sentinel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;equalName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;nameBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

		&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 2. create new entry
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å¦‚æœæ‰¾ä¸åˆ°, åˆ›å»ºæ–°çš„ entry
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cap&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;false&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// åˆ›å»ºæ–°çš„ entry ä» hashset çš„ meta ä¿¡æ¯é‡Œæ‹¿ next free index
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;newIndex&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;freeIndex&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;newIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;assignName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;nameBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ‰€ä»¥æ˜¯é“¾è¡¨å¤´,ä¿å­˜ index åˆ° slot
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slots&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newIndex&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å¦åˆ™ä¿å­˜åœ¨ä¸Šä¸€ä¸ª entry çš„ next å­—æ®µå†…
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newIndex&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¾ç½® next free index
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;meta&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;freeIndex&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è®¾ç½®é˜Ÿå°¾
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;next&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sentinel&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;&lt;strong&gt;3) ç”¨ Entry ä¿å­˜ metrics å€¼&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewShmCounterFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;gometrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Counter&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;gometrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Counter&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultZone&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;defaultZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;alloc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ShmCounter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;unsafe&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pointer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œentry çš„ &lt;code&gt;value&lt;/code&gt; æ˜¯çœŸæ­£è¢«ç”¨ä½œè®°å½• metrics å€¼çš„åœ°æ–¹ï¼Œå®ƒæ˜¯ä¸€ä¸ª 64 ä½çš„ç©ºé—´ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜ä¿å­˜-metrics&#34;&gt;ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜ä¿å­˜ metrics&lt;/h2&gt;
&lt;p&gt;çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè¾›è‹¦å°è£…å…±äº«å†…å­˜æ¥ä¿å­˜ metrics å€¼ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å †ç©ºé—´æ¥åšå‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å…¶å®åœ¨æºç é‡Œä¹Ÿæœ‰ç­”æ¡ˆï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;initializeMetrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MetricsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init shm zone
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmZone&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSize&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;shm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitDefaultMetricsZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ShmSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetMosnState&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;store&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Active_Reconfiguring&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L58&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L58&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;createMetricsZone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clear&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clear&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;shm&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Clear&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœ &lt;code&gt;clear&lt;/code&gt; ä¸ºçœŸï¼Œå…±äº«å†…å­˜å°±ä¼šè¢«æ¸…é™¤ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¸ºå‡å‘¢ï¼Ÿå½“ &lt;code&gt;store.GetMosnState()&lt;/code&gt; æ–¹æ³•è¿”å› &lt;code&gt;store.Active_Reconfigureing&lt;/code&gt; çš„æ—¶å€™ã€‚å³ï¼Œå½“ MOSN reconfig é‡å¯çš„æ—¶å€™ï¼Œ
å·²ç»ä¿å­˜çš„ metrics æ˜¯ä¼šè¢«ä¿ç•™çš„ã€‚&lt;/p&gt;
&lt;p&gt;è€Œä¸”ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L124&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L124&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newSharedMetrics&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newHashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSegment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hashSegSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entryNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;LoadUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ref&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L78&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L78&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newHashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;segment&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uintptr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bytesNum&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slotsNum&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;set&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;hashSet&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å½“ &lt;code&gt;zone.ref&lt;/code&gt; å¼•ç”¨è®¡æ•°ä¸ä¸º 0 çš„æ—¶å€™ï¼Œå“ˆå¸Œè¡¨é‡Œé¢çš„ä¿¡æ¯ä¹Ÿæ˜¯ä¼šè¢«ä¿ç•™çš„ã€‚&lt;/p&gt;
&lt;p&gt;å†æ¥çœ‹ &lt;code&gt;zone.mutex&lt;/code&gt; äº’æ–¥é”çš„ä½¿ç”¨ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L136&#34;&gt;https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L136&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;zone&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;times&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 5ms spin interval, 5 times burst
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;atomic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CompareAndSwapUint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;z&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pid&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ˜¯é€šè¿‡è®¾ç½®è¿›ç¨‹ ID æ¥è·å–é”çš„ï¼Œç”±æ­¤èƒ½çœ‹å‡º MOSN çš„ç”¨æ„ï¼š&lt;strong&gt;è¿™ä¸ªä»¥æ–‡ä»¶ä½œä¸º mmap çš„å…±äº«å†…å­˜æ˜¯å¯ä»¥è¢«å¤šä¸ª MOSN è¿›ç¨‹å…±ç”¨çš„&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚ MOSN æ”¯æŒè·¨å®¹å™¨çƒ­é‡å¯çš„åœºæ™¯ï¼ŒåŸºäºå†…å­˜å…±äº«çš„ metrics å¯ä»¥ä¿è¯çƒ­é‡å¯è¿‡ç¨‹ä¸­ä¸å‡ºç°æŒ‡æ ‡æŠ–åŠ¨è€Œé€ æˆç›‘æ§å¼‚å¸¸ã€‚
è€Œä¸”è¿™ä¸ªæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§æ–‡ä»¶æ ¼å¼ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥è¢«æŒä¹…åŒ–ä¿å­˜å’Œæå–åˆ†æä½¿ç”¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;å½“ä½ ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œå¯ä»¥å…³é—­å†…å­˜å…±äº« metrics çš„é…ç½®å³å¯ï¼ŒMOSN ä¼š fallback åˆ° go-metrics çš„å®ç°ï¼Œè¯¥å®ç°å°±æ˜¯é€šè¿‡å †åˆ†é…å†…å­˜ä¿å­˜ metrics ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡é€šè¿‡åˆ†æ MOSN æºç ï¼Œç®€è¿°äº† MOSN çš„å…±äº«å†…å­˜æ¨¡å‹ï¼Œåˆ†æäº† MOSN åˆ›å»ºå…±äº«å†…å­˜ã€é…ç½® metrics å’Œ metrics å¯¹å…±äº«å†…å­˜å—çš„ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œ&lt;strong&gt;ä¸é¼“åŠ±åœ¨ Go é‡Œé¢ä½¿ç”¨å…±äº«å†…å­˜ï¼Œé™¤éä½ æœ‰æ˜ç¡®çš„ä½¿ç”¨åœºæ™¯&lt;/strong&gt;ï¼Œä¾‹å¦‚ MOSN çƒ­å‡çº§åœºæ™¯ä¸‹çš„ metrics å…±äº«ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;MOSN æºç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - å˜é‡æœºåˆ¶</title>
      <link>https://mosn.io/blog/code/mosn-variable/</link>
      <pubDate>Sun, 16 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-variable/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„ç›®çš„æ˜¯åˆ†æ MOSN æºç ä¸­çš„&lt;code&gt;å˜é‡æœºåˆ¶&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä»€ä¹ˆæ˜¯å˜é‡æœºåˆ¶&#34;&gt;ä»€ä¹ˆæ˜¯å˜é‡æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå•å…ƒæµ‹è¯•æ¥ç†è§£&lt;code&gt;ä»€ä¹ˆæ˜¯å˜é‡æœºåˆ¶&lt;/code&gt;ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog_test.go#L69&#34;&gt;è¿™é‡Œ&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// DefaultAccessLogFormat provides a pre-defined format
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;DefaultAccessLogFormat&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;%start_time% %request_received_duration% %response_received_duration% %bytes_sent%&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34; &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;%bytes_received% %protocol% %response_code% %duration% %response_flag% %response_code% %upstream_local_address%&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34; &amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;%downstream_local_address% %downstream_remote_address% %upstream_host%&amp;#34;&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;TestAccessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;t&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;testing&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;T&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;registerTestVarDefs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultAccessLogFormat&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;logName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/tmp/mosn_bench/benchmark_access.log&amp;#34;&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Remove&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;accessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewAccessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prepareLocalIpv6Ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;accessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ‰§è¡Œè¿™ä¸ªå•å…ƒæµ‹è¯•ï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go &lt;span style=&#34;color:#204a87&#34;&gt;test&lt;/span&gt; mosn.io/mosn/pkg/log -run ^TestAccessLog$
ok      mosn.io/mosn/pkg/log    2.867s
cat /tmp/mosn_bench/benchmark_access.log
2020/02/16 21:26:26.078 2.543Âµs 2.000004307s &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2048&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2048&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; 24.471Âµs &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; 127.0.0.1:23456 &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;2001:db8::68&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;:12200 127.0.0.1:53242 -
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯·ç•™æ„ &lt;code&gt;accessLog.Log&lt;/code&gt; æ‰“å°å‡ºæ¥çš„æ—¥å¿—ï¼Œå¯ä»¥å‘ç° &lt;code&gt;DefaultAccessLogFormat&lt;/code&gt; ä¸­çš„å˜é‡, éƒ½è¢«æ›¿æ¢æˆäº†å®é™…çš„å€¼ã€‚æ¯”å¦‚ï¼š&lt;code&gt;%start_time%&lt;/code&gt; è¢«æ›¿æ¢æˆ &lt;code&gt;2020/02/16 21:26:26.078&lt;/code&gt;, &lt;code&gt;%request_received_duration%&lt;/code&gt; è¢«æ›¿æ¢æˆ &lt;code&gt;2.543Âµs&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;å˜é‡æœºåˆ¶&lt;/code&gt;å…è®¸ç”¨æˆ·åœ¨é…ç½®ä¸­ä½¿ç”¨é¢„å®šä¹‰çš„å˜é‡ï¼Œè€Œéç¡®å®šå€¼ï¼›å˜é‡å°†åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­è¢«æ›¿æ¢æˆå…¶å¯¹åº”çš„å®é™…å€¼ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å˜é‡æœºåˆ¶çš„åŸç†&#34;&gt;å˜é‡æœºåˆ¶çš„åŸç†&lt;/h2&gt;
&lt;div align=&#34;center&#34;&gt;
    &lt;img src=&#34;variable.png&#34;/&gt;
&lt;/div&gt;
&lt;br/&gt;
&lt;p&gt;è¯·ç•™æ„ä¸Šé¢çš„&lt;code&gt;å˜é‡æœºåˆ¶åŸç†å›¾&lt;/code&gt;ï¼Œå®ƒåˆ†ä¸º 3 éƒ¨åˆ†ï¼›æœ€ä¸Šè¾¹çš„æ˜¯&lt;code&gt;Variable ç¼“å­˜&lt;/code&gt;ï¼Œå·¦è¾¹è™šçº¿æ¡†çš„æ˜¯&lt;code&gt;åˆå§‹åŒ–é˜¶æ®µ&lt;/code&gt;ï¼Œè€Œå³è¾¹è™šçº¿æ˜¯&lt;code&gt;å¯¹å˜é‡çš„ä½¿ç”¨&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;variable-ç¼“å­˜&#34;&gt;Variable ç¼“å­˜&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;Variable ç¼“å­˜&lt;/code&gt; æ˜¯ä¸€ç»„ Variable çš„ key-value å¯¹ï¼Œkey æ˜¯å˜é‡çš„åå­—ï¼Œvalue æ˜¯ &lt;code&gt;Variable æ¥å£&lt;/code&gt;ï¼›ä»¥ map çš„å½¢å¼å­˜åœ¨äºå†…å­˜ä¸­ã€‚Variable æ¥å£å«æœ‰&lt;code&gt;å˜é‡çš„åå­—&lt;/code&gt;ï¼Œ&lt;code&gt;å˜é‡å€¼çš„è·å–æ–¹å¼&lt;/code&gt;, &lt;code&gt;å˜é‡å€¼çš„è®¾ç½®æ–¹å¼&lt;/code&gt; ç­‰å±æ€§ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åˆå§‹åŒ–é˜¶æ®µ&#34;&gt;åˆå§‹åŒ–é˜¶æ®µ&lt;/h3&gt;
&lt;p&gt;åœ¨åˆå§‹åŒ–é˜¶æ®µä¸­ï¼Œé¦–å…ˆå®šä¹‰å¥½å„å˜é‡çš„ &lt;code&gt;Variable&lt;/code&gt;ï¼ˆé¢„å®šä¹‰å˜é‡ï¼‰ï¼›ç„¶åæ³¨å†Œåˆ° &lt;code&gt;Variable ç¼“å­˜ä¸­&lt;/code&gt;ã€‚å¦å¤–ï¼Œè¿˜éœ€åˆå§‹åŒ– &lt;code&gt;mosn ctx&lt;/code&gt;ï¼Œ&lt;code&gt;mosn ctx&lt;/code&gt; æ˜¯ä¸€ä¸ª &lt;code&gt;context.Context&lt;/code&gt;ï¼Œé‡Œé¢å«æœ‰å˜é‡å®é™…å€¼çš„ç›¸å…³ä¿¡æ¯ï¼›åœ¨åç»­è·å–å˜é‡çš„å®é™…å€¼æ—¶ä¼šç”¨åˆ°å®ƒã€‚&lt;/p&gt;
&lt;h3 id=&#34;å¯¹å˜é‡çš„ä½¿ç”¨&#34;&gt;å¯¹å˜é‡çš„ä½¿ç”¨&lt;/h3&gt;
&lt;p&gt;åœ¨è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®&lt;code&gt;å˜é‡å&lt;/code&gt;å»ç¼“å­˜ä¸­è·å–ç›¸åº”çš„ &lt;code&gt;Variable&lt;/code&gt;ã€‚ç„¶åè°ƒç”¨ Variable çš„ &lt;code&gt;Getter&lt;/code&gt; æ–¹æ³•ï¼Œå¾—åˆ°&lt;code&gt;å˜é‡çš„è·å–æ–¹å¼ getter&lt;/code&gt;ã€‚æœ€åè°ƒç”¨ &lt;code&gt;getter&lt;/code&gt; å‡½æ•°ï¼Œ&lt;code&gt;getter&lt;/code&gt; å‡½æ•°ä¼šæ ¹æ® &lt;code&gt;mosn ctx&lt;/code&gt; ç”Ÿæˆå˜é‡çš„å®é™…å€¼ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œ&lt;code&gt;å˜é‡æœºåˆ¶&lt;/code&gt; ç”¨åˆ°äº† &lt;code&gt;ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼&lt;/code&gt;ã€‚&lt;code&gt;ç”Ÿäº§è€…&lt;/code&gt; è´Ÿè´£å®šä¹‰å˜é‡å¯¹åº”çš„ &lt;code&gt;Variable&lt;/code&gt;ï¼Œå¹¶æ³¨å†Œåˆ° &lt;code&gt;Variable ç¼“å­˜&lt;/code&gt;ä¸­ã€‚è€Œè¿™äº› &lt;code&gt;Variable&lt;/code&gt; ä¼šåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­è¢«æ¶ˆè´¹ï¼Œç”Ÿæˆå˜é‡çš„å®é™…å€¼ã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£å®Œå˜é‡æœºåˆ¶çš„åŸç†åï¼Œæˆ‘ä»¬ç»§ç»­å›´ç»•&lt;a href=&#34;#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%98%E9%87%8F%E6%9C%BA%E5%88%B6&#34;&gt;ä»€ä¹ˆæ˜¯å˜é‡æœºåˆ¶&lt;/a&gt;ä¸­çš„å•å…ƒæµ‹è¯•ï¼Œæ·±å…¥æ¢è®¨å®ƒèƒŒåçš„å®ç°é€»è¾‘ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ³¨å†Œå˜é‡&#34;&gt;æ³¨å†Œå˜é‡&lt;/h2&gt;
&lt;p&gt;è¯¥å•å…ƒæµ‹è¯•é€šè¿‡å‡½æ•° &lt;code&gt;registerTestVarDefs&lt;/code&gt; è¿›è¡Œå˜é‡çš„æ³¨å†Œï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog_test.go#L509&#34;&gt;è¿™é‡Œ&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;builtinVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewBasicVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;varStartTime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;startTimeGetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewBasicVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;varRequestReceivedDuration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receivedDurationGetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewBasicVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reqHeaderPrefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;requestHeaderMapGetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewBasicVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;respHeaderPrefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;responseHeaderMapGetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;registerTestVarDefs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// register built-in variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;builtinVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RegisterVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;builtinVariables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// register prefix variables, like header_xxx/arg_xxx/cookie_xxx
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RegisterPrefixVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;é€šè¿‡ &lt;code&gt;variable.NewBasicVariable&lt;/code&gt; åˆå§‹åŒ–å„ç§ &lt;code&gt;variable.Variable&lt;/code&gt; çš„å®šä¹‰ï¼Œå†åˆ©ç”¨ &lt;code&gt;variable.RegisterVariable&lt;/code&gt; æˆ– &lt;code&gt;RegisterPrefixVariable&lt;/code&gt; å‡½æ•°è¿›è¡Œæ³¨å†Œ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥å£ &lt;code&gt;variable.Variable&lt;/code&gt; çš„å®šä¹‰å¦‚ä¸‹, å®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/variable/types.go#L43&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// variable name
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// variable data, which is useful for getter/setter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// variable flags
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Flags&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// value getter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Getter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetterFunc&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// value setter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;Setter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;SetterFunc&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Name: è·å–å˜é‡å&lt;/li&gt;
&lt;li&gt;Data: è·å–å˜é‡çš„å®é™…å€¼&lt;/li&gt;
&lt;li&gt;Flags: æ˜¯å¦éœ€è¦ç¼“å­˜çš„æ ‡å¿—&lt;/li&gt;
&lt;li&gt;Getter: è·å–å˜é‡å€¼çš„å‡½æ•°&lt;/li&gt;
&lt;li&gt;Setter: è®¾ç½®å˜é‡å€¼çš„å‡½æ•°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å†æ¥çœ‹å‡½æ•° &lt;code&gt;variable.RegisterVariable&lt;/code&gt;, å®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/variable/factory.go#L75&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// global scope
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;              &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RWMutex&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;variables&lt;/span&gt;        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// all built-in variable definitions
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;indexedVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;       &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// indexed variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;RegisterVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check conflict
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;errVariableDuplicated&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// register
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check index
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;indexedVariables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;SetIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;

        &lt;span style=&#34;color:#000&#34;&gt;indexedVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;indexedVariables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;å®šä¹‰å…¨å±€å˜é‡ &lt;code&gt;variables&lt;/code&gt; å’Œ &lt;code&gt;indexedVariables&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ç”±äºä½¿ç”¨äº†å…¨å±€å˜é‡ï¼Œä¸ºäº†é˜²æ­¢ç«æ€æ¡ä»¶ï¼Œä½¿ç”¨äº†äº’æ–¥é”&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥å˜é‡æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ï¼›å¦åˆ™ï¼Œå˜é‡æ­£å¸¸æ³¨å†Œåˆ°ç¼“å­˜ &lt;code&gt;variables&lt;/code&gt; ä¸­&lt;/li&gt;
&lt;li&gt;å°† &lt;code&gt;variables&lt;/code&gt; è½¬åŒ–æˆ &lt;code&gt;Indexer&lt;/code&gt;, è®¾ç½® indexï¼Œå¹¶æ³¨å†Œåˆ°ç¼“å­˜ &lt;code&gt;indexedVariables&lt;/code&gt; ä¸­&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;RegisterPrefixVariable å‡½æ•°çš„åŠŸèƒ½å’Œ RegisterVariable å¤§åŒå°å¼‚ï¼ŒRegisterVariable æ ¹æ®å˜é‡åæ³¨å†Œï¼Œè€Œ RegisterPrefixVariable é€šè¿‡å˜é‡åçš„å‰ç¼€æ³¨å†Œã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å˜é‡æ³¨å†Œå¤§è‡´çš„è¿‡ç¨‹æ˜¯ï¼šåœ¨ä»£ç åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå®ä¾‹åŒ–æ‰€æœ‰å®šä¹‰å¥½çš„å˜é‡ï¼ˆä¸»è¦å«æœ‰&lt;code&gt;å˜é‡å&lt;/code&gt;ï¼Œ&lt;code&gt;å˜é‡çš„è·å–æ–¹å¼ getter&lt;/code&gt;ï¼‰ï¼Œå¹¶é€šè¿‡å‡½æ•° &lt;code&gt;RegisterVariable&lt;/code&gt; æˆ– &lt;code&gt;RegisterPrefixVariable&lt;/code&gt; æ³¨å†Œåˆ°ç¼“å­˜ï¼ˆå…¨å±€å˜é‡ï¼‰ä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&#34;è·å–å˜é‡&#34;&gt;è·å–å˜é‡&lt;/h2&gt;
&lt;p&gt;è·å–å˜é‡çš„åŸæ¥åˆ™éœ€è¦åˆ†æå‡½æ•° &lt;code&gt;NewAccessLog&lt;/code&gt;ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog.go#L79&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewAccessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AccessLog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;parseFormat&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;accesslog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;logger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#000&#34;&gt;lg&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;è§£æå­—ç¬¦ä¸² &lt;code&gt;format&lt;/code&gt;, åˆ›å»ºæƒ³è¦çš„å˜é‡ï¼Œè®°å½•åˆ°å˜é‡æ¡ç›® &lt;code&gt;entries&lt;/code&gt; é‡Œ&lt;/li&gt;
&lt;li&gt;å°†å˜é‡æ¡ç›® &lt;code&gt;entries&lt;/code&gt; èµ‹ç»™ç»“æ„ä½“ &lt;code&gt;accesslog&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å†æ¥åˆ†æè§£æ &lt;code&gt;format&lt;/code&gt; çš„å‡½æ•° &lt;code&gt;parseFormat&lt;/code&gt;, å®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog.go#L129&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;parseFormat&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;%&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check previous character, &amp;#39;\&amp;#39; means it is escaped
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;\\&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;continue&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// parse entry
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;varDef&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// empty variable definition: %%
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ErrEmptyVarDef&lt;/span&gt;
                    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// var def ends, add variable
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#000&#34;&gt;varEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AddVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
                    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
                    &lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;varEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ignore empty text
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// var def begin, add text
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;                        &lt;span style=&#34;color:#000&#34;&gt;textEntry&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
                        &lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;text&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;textEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
                    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;lastMark&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pos&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;æ ¹æ®æ ‡è¯†ç¬¦ &lt;code&gt;%&lt;/code&gt; æˆªå–å˜é‡å&lt;/li&gt;
&lt;li&gt;åˆ©ç”¨å‡½æ•° &lt;code&gt;variable.AddVariable&lt;/code&gt; æ£€æŸ¥è¯¥å˜é‡åæ˜¯å¦å·²ç»æ³¨å†Œè¿‡äº†ï¼Œå¹¶è¿”å›å¯¹åº”çš„å˜é‡&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰å˜é‡è®°å½•åˆ°åˆ‡ç‰‡ entries ä¸­ï¼Œä¸€å¹¶è¿”å›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥ä¸‹æ¥åˆ†æå‡½æ•° &lt;code&gt;variable.AddVariable&lt;/code&gt;ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/variable/factory.go#L47&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;AddVariable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mux&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// find built-in variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check prefix variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strings&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HasPrefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;errUndefinedVariable&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;å¦‚æœèƒ½åœ¨æ³¨å†Œäº†å˜é‡çš„ç¼“å­˜ &lt;code&gt;variables&lt;/code&gt; æ‰¾åˆ° name å¯¹åº”çš„å˜é‡ï¼Œåˆ™ç›´æ¥è¿”å›å˜é‡&lt;/li&gt;
&lt;li&gt;å¦‚æœèƒ½åœ¨æ³¨å†Œäº†å˜é‡çš„ç¼“å­˜ &lt;code&gt;prefixVariables&lt;/code&gt; æ‰¾åˆ°å˜é‡åå‰ç¼€æ˜¯ name çš„å˜é‡ï¼Œåˆ™è¿”å›å˜é‡&lt;/li&gt;
&lt;li&gt;æ²¡æœ‰æ‰¾åˆ°æƒ³è¦çš„å˜é‡ï¼Œåˆ™è¿”å›é”™è¯¯ï¼Œæ”¹é”™è¯¯å¯ä»¥åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™è¢«å‘ç°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è·å–å˜é‡å¤§è‡´çš„æµç¨‹æ˜¯ï¼š&lt;code&gt;format&lt;/code&gt; è§£æä¸­è§£æå‡ºå˜é‡åï¼Œç„¶åå»æ³¨å†Œäº†å˜é‡çš„ç¼“å­˜ &lt;code&gt;variables&lt;/code&gt; æˆ– &lt;code&gt;prefixVariables&lt;/code&gt; ä¸­è·å–ç›¸åº”çš„å˜é‡ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å˜é‡ç”Ÿæ•ˆ&#34;&gt;å˜é‡ç”Ÿæ•ˆ&lt;/h2&gt;
&lt;p&gt;æœ¬å°èŠ‚å°†ä¼šåˆ†ææ–¹æ³• &lt;code&gt;accessLog.Log&lt;/code&gt; çš„é€»è¾‘ï¼Œä»è€Œäº†è§£å˜é‡ç”Ÿæ•ˆçš„è¿‡ç¨‹ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog.go#L105&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;accesslog&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;reqHeaders&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;respHeaders&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HeaderMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;requestInfo&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// return directly
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Disable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetIoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AccessLogLen&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;entries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;idx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WriteString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;l&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Print&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ä¸€äº›æ—¥å¿—çš„å¤„ç†é€»è¾‘&lt;/li&gt;
&lt;li&gt;éå†å˜é‡æ¡ç›® &lt;code&gt;entries&lt;/code&gt;ï¼Œæ‰§è¡Œ &lt;code&gt;l.entries[idx].log&lt;/code&gt;ï¼Œè·å–å˜é‡å¯¹åº”çš„å®é™…å€¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å†æ¥åˆ†ææ–¹æ³• &lt;code&gt;l.entries[idx].log&lt;/code&gt;, å®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog.go#L65&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;le&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;logEntry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;le&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;text&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WriteString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;le&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;text&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetVariableValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;le&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WriteString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ValueNotFound&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WriteString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ä¸»è¦æ˜¯åˆ©ç”¨å‡½æ•° &lt;code&gt;variable.GetVariableValue&lt;/code&gt; è·å–å˜é‡çš„å®é™…å€¼&lt;/li&gt;
&lt;li&gt;å°†è·å–åˆ°çš„å®é™…å€¼å†™åˆ° &lt;code&gt;buf&lt;/code&gt; é‡Œ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥ç€åˆ†æå‡½æ•° &lt;code&gt;variable.GetVariableValue&lt;/code&gt;ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/variable/api.go#L28&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetVariableValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1. find built-in variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1.1 check indexed value
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getFlushedVariableValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;indexer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 1.2 use variable.Getter() to get value
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Getter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;errGetterNotFound&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Data&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// 2. find prefix variables
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefixVariables&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strings&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;HasPrefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;prefix&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Getter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;errGetterNotFound&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;getter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;errUndefinedVariable&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;æ ¹æ®å˜é‡åï¼Œé‡æ–°ä»ç¼“å­˜ &lt;code&gt;variables&lt;/code&gt; ä¸­è·å–ç›¸åº”çš„å˜é‡ &lt;code&gt;variable&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;è°ƒç”¨å˜é‡çš„ &lt;code&gt;Getter&lt;/code&gt; æ–¹æ³•ï¼Œè·å–å‡½æ•° &lt;code&gt;getter(GetterFunc)&lt;/code&gt;ï¼Œä¸€ä¸ªè·å–å˜é‡å®é™…å€¼çš„æ–¹æ³•&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œ getter å‡½æ•°ï¼Œå¾—åˆ°å˜é‡çš„å®é™…å€¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥ä¸‹æ¥åˆ†æç±»å‹æ˜¯ &lt;code&gt;GetterFunc&lt;/code&gt; çš„å‡½æ•°ï¼Œä»¥ &lt;code&gt;startTimeGetter&lt;/code&gt; ä¸ºä¾‹ï¼Œå®Œæ•´ä»£ç æ¸…å‚è€ƒ&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog_test.go#L523&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// StartTimeGetter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// get request&amp;#39;s arriving time
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;startTimeGetter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;variable&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IndexedValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;requestInfoKey&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;).(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RequestInfo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;info&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StartTime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Format&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;2006/01/02 15:04:05.000&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;è°ƒç”¨ &lt;code&gt;ctx.Value&lt;/code&gt;, æ ¹æ® &lt;code&gt;requestInfoKey&lt;/code&gt; ä» &lt;code&gt;ctx&lt;/code&gt; ä¸­è·å–ç›¸åº”çš„å¯¹è±¡&lt;/li&gt;
&lt;li&gt;è¯¥å¯¹è±¡å·²ç»äº‹å…ˆåœ¨&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae144136039508dda6d0c5d03c1f732cb107/pkg/log/accesslog_test.go#L64&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼Œé€šè¿‡ &lt;code&gt;ctx&lt;/code&gt; çš„ &lt;code&gt;WithValue&lt;/code&gt; è®¾ç½®åˆ°äº† &lt;code&gt;ctx&lt;/code&gt; é‡Œ&lt;/li&gt;
&lt;li&gt;è½¬åŒ–æˆæ¥å£ &lt;code&gt;api.RequestInfo&lt;/code&gt;ï¼Œæ”¹æ¥å£æœ‰è·å– &lt;code&gt;StartTime&lt;/code&gt; çš„èƒ½åŠ›&lt;/li&gt;
&lt;li&gt;è·å– &lt;code&gt;StartTime&lt;/code&gt; å¹¶æ ¼å¼åŒ–&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å˜é‡ç”Ÿæ•ˆå¤§è‡´çš„æµç¨‹æ˜¯ï¼šéå†å·²è·å–çš„å˜é‡æ¡ç›® &lt;code&gt;entries&lt;/code&gt;, æ ¹æ®å˜é‡åè·å–ç¼“å­˜ä¸­çš„å˜é‡ï¼Œè°ƒç”¨å˜é‡ä¸­çš„ &lt;code&gt;getter&lt;/code&gt; æ–¹æ³•, è·å–ç›¸åº”çš„å˜é‡å€¼ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;å˜é‡æœºåˆ¶&lt;/code&gt; çš„å®ç°æ˜¯æ¯”è¾ƒé¢å‘å¯¹è±¡çš„ï¼Œé¦–å…ˆå®šä¹‰äº†ç»“æ„ä½“ &lt;code&gt;Variable&lt;/code&gt;, ä¸»è¦è®°å½•äº†å˜é‡åå’Œè·å–å¯¹åº”å˜é‡å€¼çš„å®ç°&lt;code&gt;GetterFunc&lt;/code&gt;ï¼›&lt;code&gt;GetterFunc&lt;/code&gt; å®šä¹‰å¥½äº†è·å–å˜é‡å€¼çš„å‡½æ•°å®šä¹‰ï¼Œæ¯ä¸ªå˜é‡éƒ½å¾—å®ç°è‡ªå·±çš„ &lt;code&gt;getter&lt;/code&gt;ï¼ˆ&lt;code&gt;é¢å‘æ¥å£ç¼–ç¨‹&lt;/code&gt;ï¼‰ã€‚ ç„¶ååœ¨ä»£ç åˆå§‹åŒ–çš„æ—¶å€™æŠŠæ‰€æœ‰å˜é‡éƒ½å®ä¾‹åŒ–ï¼Œå¹¶æ³¨å†Œåˆ°ä½œä¸ºç¼“å­˜çš„å…¨å±€å˜é‡ &lt;code&gt;variables&lt;/code&gt; ä¸­ ï¼ˆ&lt;code&gt;è¡¨é©±åŠ¨æ³•&lt;/code&gt;ï¼‰; æœ€åï¼Œæ›´åŠ å˜é‡åå»ç¼“å­˜ &lt;code&gt;variables&lt;/code&gt; è·å–ç›¸åº”çš„å®ç°ï¼Œè·å–å˜é‡çš„å®é™…å€¼ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–ï¼Œå¾ˆå¥½åœ°åˆ©ç”¨äº† &lt;code&gt;golang&lt;/code&gt; ç‰¹æœ‰çš„ &lt;code&gt;context&lt;/code&gt; è´¯ç©¿äº†æ•´ä¸ªæµç¨‹ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - å†…å­˜å¤ç”¨æœºåˆ¶</title>
      <link>https://mosn.io/blog/code/mosn-buffer/</link>
      <pubDate>Sat, 15 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-buffer/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.9.0ï¼Œcommit id 1609ae14ã€‚&lt;/p&gt;
&lt;p&gt;MOSN åœ¨å†…å­˜ç®¡ç†å¤ç”¨æ–¹é¢æœ‰ &lt;code&gt;å†…å­˜å¯¹è±¡æ³¨å†Œ/ç®¡ç†&lt;/code&gt; å’Œ &lt;code&gt;ByteBuffer/IOBuffer å¤ç”¨&lt;/code&gt; ä¸¤éƒ¨åˆ†å†…å®¹ã€‚MOSN æœ€æ–°çš„ master åˆ†æ”¯ç”¨äº† mod ç®¡ç†ä¾èµ–ï¼Œ
å‘ç°åä¸€éƒ¨åˆ†ä¹Ÿè¿ç§»åˆ°äº† vendor ç›®å½•ä¸‹ï¼Œå¯å•ç‹¬ä½¿ç”¨ã€‚ä¸‹é¢å°±åˆ†è¿™ä¸¤éƒ¨åˆ†æ¥è®²è¿° MOSN çš„å†…å­˜å¤ç”¨æœºåˆ¶ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœºåˆ¶&#34;&gt;æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;ç®€è¿°ä¸€ä¸‹ä¸¤éƒ¨åˆ†å†…å®¹çš„æœºåˆ¶ï¼Œå…·ä½“å®ç°åŸç†ä¼šåœ¨åé¢å¸¦ä¸Šæºç è§£æã€‚&lt;/p&gt;
&lt;h3 id=&#34;1-å†…å­˜å¯¹è±¡æ³¨å†Œç®¡ç†&#34;&gt;1. å†…å­˜å¯¹è±¡æ³¨å†Œ/ç®¡ç†&lt;/h3&gt;
&lt;p&gt;MOSN åœ¨ go &lt;code&gt;sync&lt;/code&gt; åŒ…å¤–ï¼Œå¯¹ &lt;code&gt;sync.Pool&lt;/code&gt; å¯¹è±¡è¿›è¡Œäº†è¿›ä¸€æ­¥å°è£…ï¼Œå¢åŠ äº†ç®¡ç†å’Œæ˜“ç”¨æ€§ã€‚&lt;/p&gt;
&lt;p&gt;MOSN çš„ buffer åŒ…æä¾›äº†æ³¨å†Œå‡½æ•°å’Œç»Ÿä¸€çš„æ¥å£ã€‚å°†å®ç°äº†æ¥å£çš„ä¸åŒç±»å‹çš„ buffer å¯¹è±¡æ³¨å†Œåˆ° buffer åŒ…ï¼Œ
åœ¨ç”¨åˆ°çš„æ—¶å€™é€šè¿‡ buffer åŒ…å¯¼å‡ºçš„æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å’Œç®¡ç†ï¼Œå¢å¼ºäº†å†…å­˜å¯¹è±¡çš„ç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;è€Œæ˜“ç”¨æ€§æ–¹é¢ï¼ŒMOSN å°è£…äº† &lt;code&gt;bufferValue&lt;/code&gt; å¯¹è±¡ï¼Œç®¡ç†ä¸Šé¢åˆå§‹åŒ–å‡ºæ¥çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°† bufferValue å¯¹è±¡ä¹Ÿè¿›è¡Œäº†æ± åŒ–ç®¡ç†ã€‚åœ¨è¿™ä¹‹ä¸Šï¼Œå°è£…å‡ºæ–¹æ³•
&lt;code&gt;NewBufferPoolContext&lt;/code&gt; å’Œ &lt;code&gt;PoolContext&lt;/code&gt;ï¼Œä½¿å†…éƒ¨æ ¹æ® context ä¼ å€¼çš„åœºæ™¯æ›´åŠ æ˜“ç”¨ã€‚MOSN é‡Œé¢åœ¨ä¸åŒåç¨‹åä½œï¼ˆæ¯”å¦‚è¿æ¥è¢«åç¨‹1 accept åï¼Œ
äº¤ç”± worker åç¨‹2 è¿›è¡Œ IOï¼‰çš„è¿‡ç¨‹ï¼Œä¼šå°†å¿…è¦å‚æ•°ä½¿ç”¨å†…éƒ¨å®ç°çš„ &lt;code&gt;context with value&lt;/code&gt; æœºåˆ¶è¿›è¡Œä¼ é€’ï¼Œ
å…¶ä¸­ buffer ä¼ é€’çš„æ–¹æ³•å°±æ˜¯é€šè¿‡ä¸Šè¿°å°è£…çš„æ–¹æ³•è¿›è¡Œä¼ é€’çš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;2-bytebufferiobuffer-å¤ç”¨&#34;&gt;2. ByteBuffer/IOBuffer å¤ç”¨&lt;/h3&gt;
&lt;p&gt;ä¸ºäº†æé«˜ byte æ•°ç»„çš„å¤ç”¨ç‡ï¼ŒMOSN å°è£…å‡ºäº†å¯¹é½64å­—èŠ‚çš„ byte buffer pool ç®¡ç†ï¼Œä»¥åŠåœ¨å…¶ä¹‹ä¸Šçš„ IO buffer pool ç®¡ç†åŒ…ï¼Œå†…éƒ¨éœ€è¦ç”¨åˆ°çš„æ—¶å€™å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰è¿™éƒ¨åˆ†ä»£ç æ˜¯æ”¾åœ¨ pkg ä¸‹çš„ï¼Œåœ¨æœ€æ–°çš„ master è¿ç§»åˆ°äº† vendor ä¸‹ï¼Œä¸ä¾èµ– pkg åŒ…ä¸‹ä»»ä½•çš„å…¶ä»–åŒ…ã€‚è¿™ç§æƒ…å†µä¸‹å¦‚æœå¼€å‘è€…è‡ªå·±
çš„é¡¹ç›®æœ‰è¿™éƒ¨åˆ†éœ€æ±‚ï¼Œå…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ MOSN å†™å¥½çš„åŒ…ï¼Œä¸ç”¨é‡å¤é€ è½®å­ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æºç è§£æ&#34;&gt;æºç è§£æ&lt;/h2&gt;
&lt;h3 id=&#34;1-å†…å­˜å¯¹è±¡æ³¨å†Œç®¡ç†-1&#34;&gt;1. å†…å­˜å¯¹è±¡æ³¨å†Œ/ç®¡ç†&lt;/h3&gt;
&lt;h4 id=&#34;æ³¨å†Œç®¡ç†&#34;&gt;æ³¨å†Œç®¡ç†&lt;/h4&gt;
&lt;p&gt;è¿™æ˜¯ bufferPool ç›¸å…³çš„ç®€å•ç±»å›¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./class.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;MOSN å®šä¹‰äº† &lt;code&gt;bufferPoolCtx&lt;/code&gt; æ¥å£ï¼Œä½¿ç”¨ buffer åŒ…éœ€è¦å°†å®ç°äº†è¿™ä¸ªæ¥å£çš„å¯¹è±¡ï¼Œæ¯”å¦‚å›¾ä¸­çš„ ABufferCtxã€BBufferCtxï¼Œé€šè¿‡ &lt;code&gt;RegisterBuffer&lt;/code&gt; æ–¹æ³•æ³¨å†Œåˆ° buffer åŒ…ã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ &lt;code&gt;Index()&lt;/code&gt; æ–¹æ³•è¿”å›æ³¨å†Œæ—¶å†™å…¥çš„ index å€¼ï¼›&lt;code&gt;New()&lt;/code&gt; æ–¹æ³•æ˜¯ç”¨æ¥åˆå§‹åŒ–å¾…ç¼“å­˜å¯¹è±¡çš„ï¼›è€Œ &lt;code&gt;Reest()&lt;/code&gt; æ–¹æ³•æ˜¯å°†å†…å­˜å¯¹è±¡æ”¾å› pool å‰çš„é‡ç½®é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L70&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L70&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;RegisterBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;BufferPoolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;bPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;setIndex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ³¨å†Œè¿‡ç¨‹å¤§è‡´æ˜¯å°†ä¼ å…¥çš„å¯¹è±¡ä¿å­˜åœ¨å…¨å±€å˜é‡ bPool ä¸­ï¼Œå¹¶ç»™å®ƒåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€æ ‡è®°ã€‚&lt;/p&gt;
&lt;p&gt;æ³¨å†Œåçš„ç»“æ„å›¾å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;./struct.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;bPool å…¨å±€å˜é‡ä¿å­˜ç€å·²æ³¨å†Œçš„ ctx, åœ¨éœ€è¦è·å–å¯¹è±¡æ—¶æ‰¾åˆ°å¯¹åº”çš„ poolï¼Œè°ƒç”¨ ctx.New()ï¼Œæˆ– sync.Pool.Get()ï¼›
åœ¨éœ€è¦ give å¯¹è±¡æ—¶ï¼Œå…ˆè°ƒç”¨ ctx.Reset() æ–¹æ³•å¯¹å¤ç”¨å¯¹è±¡è¿›è¡Œé‡ç½®ï¼Œç„¶åè°ƒç”¨ sync.Pool.Put()ï¼Œè‡³æ­¤å®ç°äº†å¯¹ sync.Pool çš„å°è£…ç®¡ç†å’Œæ‰©å±•ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L91&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L91&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Take returns a buffer from buffer pool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Give returns a buffer to buffer pool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Reset&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Put&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;æ˜“ç”¨æ€§&#34;&gt;æ˜“ç”¨æ€§&lt;/h4&gt;
&lt;p&gt;ç„¶åæ˜¯ç»“æ„å›¾å³è¾¹çš„ valuePool éƒ¨åˆ†ã€‚&lt;code&gt;valuePool&lt;/code&gt; æ˜¯ &lt;code&gt;bufferValue&lt;/code&gt; å¯¹è±¡çš„ sync.Poolã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ valuePool çš„ç»“æ„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L105&#34;&gt;http://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L105&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// bufferValue is buffer pool&amp;#39;s Value
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;maxBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;transmit&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;maxBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å…¶ä¸­ &lt;code&gt;value/transmit&lt;/code&gt; åŸŸç”¨æ¥ä¿å­˜ä»æ³¨å†Œè¡¨åˆå§‹åŒ–å‡ºæ¥çš„å†…å­˜å¯¹è±¡çš„æŒ‡é’ˆï¼ˆtransmit åŸŸä¿å­˜ç€ä»å…¶ä»– context å¤åˆ¶è¿‡æ¥çš„å†…å­˜å¯¹è±¡ï¼‰ã€‚
å…¨å±€å˜é‡ &lt;code&gt;vPool&lt;/code&gt; ä¿å­˜äº† bufferValue çš„ sync.Poolï¼Œå³ bufferValue æœ¬èº«ä¹Ÿæ˜¯å¯ä»¥å¤ç”¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸€ä¸ª transmit åŸŸå’Œå¤åˆ¶åŠŸèƒ½å‘¢ï¼Ÿå¯ä»¥ä»ä½¿ç”¨åˆ°çš„åœ°æ–¹çœ‹åˆ°ï¼Œåœ¨æ¥æ”¶åˆ° upstream response çš„æ—¶å€™ï¼Œå› ä¸ºè¿˜æ²¡è§£æ streamï¼Œ
goroutine è¿˜ä¸èƒ½çŸ¥é“å¯¹åº”çš„ downstream request å’Œå…¶ context çš„ bufferValueï¼Œè¿™æ—¶éœ€è¦åˆ†é…ä¸€ä¸ª bufferValue  ä¿å­˜è§£æ stream çš„ä¿¡æ¯ï¼Œ
ç­‰èƒ½å¤Ÿå…³è”ä¸Šçš„æ—¶å€™å†æ‹·è´åˆ° transmit åŸŸï¼Œç­‰é‡Šæ”¾çš„æ—¶å€™ç»Ÿä¸€é‡Šæ”¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/stream/http2/stream.go#L652&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/stream/http2/stream.go#L652&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clientStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;handleFrame&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;mbuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TransmitBufferPoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å›åˆ°æ˜“ç”¨æ€§çš„ä»‹ç»ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œé€šè¿‡ &lt;code&gt;NewBufferPoolContext&lt;/code&gt; æ–¹æ³•æ–°å»ºä¸€ä¸ª bufferValueï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L112&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L112&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// NewBufferPoolContext returns a context with bufferValue
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewBufferPoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyBufferPoolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newBufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;


&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// newBufferValue returns bufferValue
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newBufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä» vPool é‡Œ get å¤ç”¨çš„ bufferValue
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;vPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;new&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è·å–å†…å­˜å¯¹è±¡æ—¶ï¼Œè°ƒç”¨ &lt;code&gt;PoolContext&lt;/code&gt; æ–¹æ³•è·å– bufferValue å¯¹è±¡ï¼Œä¼ å…¥æ³¨å†Œè¡¨å¯¹è±¡è°ƒç”¨å…¶ &lt;code&gt;Find&lt;/code&gt; æ–¹æ³•ï¼ŒFind æ–¹æ³•ä¼šæ ¹æ®æ³¨å†Œè¡¨å¯¹è±¡è·å–å¯¹åº”çš„ poolï¼Œå¹¶ä¸”åˆå§‹åŒ–ä¸€ä¸ªå†…å­˜å¯¹è±¡æ”¾åœ¨ value åŸŸé‡Œã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L182&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L182&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;PoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;val&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyBufferPoolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;val&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;val&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newBufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L138&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L138&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Find&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;BufferPoolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;x&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87&#34;&gt;panic&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;buffer should call buffer.RegisterBuffer()&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Take returns buffer from buffer pools
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;BufferPoolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;poolCtx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è·å–å…¨å±€å”¯ä¸€æ ‡è®°
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è°ƒç”¨æ³¨å†Œè¡¨è·å–å¯¹è±¡
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ”¾å…¥ value
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½¿ç”¨å®Œæ¯•ï¼Œåªéœ€è°ƒç”¨ bufferValue çš„ &lt;code&gt;Give&lt;/code&gt; æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†å…¶ä¸‹ç®¡ç†çš„å†…å­˜å¯¹è±¡éƒ½å½’è¿˜åˆ°å¯¹åº”çš„ Pool å»ï¼Œå¹¶ä¸”å°†è‡ªå·±å½’è¿˜åˆ° vPoolã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L158&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/buffer/buffer.go#L158&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Give returns buffer to buffer pools
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// first index is 1
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å½’è¿˜ value &amp;amp; transmit
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;index&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;bPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;transmit&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;bPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;value&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nullBufferValue&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;transmit&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nullBufferValue&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Give bufferValue to Pool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å½’è¿˜è‡ªå·±
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;vPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Put&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;ä½¿ç”¨åœºæ™¯&#34;&gt;ä½¿ç”¨åœºæ™¯&lt;/h4&gt;
&lt;p&gt;ä¸Šè¿°çš„æ–¹æ³•ä¼šåœ¨å“ªé‡Œç”¨åˆ°å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;MOSN çš„è¯·æ±‚å¤„ç†æ˜¯äº¤ç»™ä¸åŒçš„ goroutine æ¥è¿›è¡Œçš„ï¼Œè€Œè¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚ hostã€headerã€body ç­‰ä¿¡æ¯é€šè¿‡ context æ¥åœ¨ä¸åŒçš„åç¨‹ä¹‹é—´ä¼ é€’ã€‚
è€Œå†…å­˜å¤ç”¨ bufferValue ä¸ context è¿›è¡Œç»‘å®šï¼Œæ„å‘³ç€åœ¨è¯·æ±‚å¤„ç†æœŸé—´ä¸åŒçš„åç¨‹éƒ½å¯ä»¥é€šè¿‡ context è·å–åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
æ‰€ä»¥ï¼ŒbufferValue åœ¨è¯·æ±‚ accept æ—¶ç”³è¯·ï¼Œåœ¨è¯·æ±‚å¤„ç†ç»“æŸæ—¶é‡Šæ”¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/stream/http/stream.go#L338&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/stream/http/stream.go#L338&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newServerStreamConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;api&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init first context
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Next æ–¹æ³•ä¼šè°ƒç”¨ä¸Šæ–‡çš„ NewBufferPoolContext æ–¹æ³•
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;ssc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;contextManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Next&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½¿ç”¨å®Œæ¯•ï¼Œæ¸…ç† downstream æ—¶æ¸…ç† bufferValueï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/pkg/proxy/downstream.go#L1325&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/pkg/proxy/downstream.go#L1325&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;giveStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Give buffers to bufferPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mbuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PoolContext&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å°ç»“ï¼šMOSN çš„ buffer åŒ…ä¿å­˜äº†å¾…å¤ç”¨çš„å†…å­˜å¯¹è±¡çš„æ³¨å†Œè¡¨ï¼ˆbPoolå¯¹è±¡ï¼‰ï¼Œç”¨æ¥å¯¹å¾…å¤ç”¨å¯¹è±¡çš„åˆå§‹åŒ–å’Œç®¡ç†ï¼›å¦å¤–ï¼ŒMOSN å®šä¹‰äº†ç»Ÿä¸€ç®¡ç†å¾…ç¼“å­˜å¯¹è±¡çš„ç»“æ„ï¼šbufferValueï¼Œç»Ÿä¸€ä¿å­˜é€šè¿‡æ³¨å†Œè¡¨åˆå§‹åŒ–å‡ºæ¥çš„å¯¹è±¡ã€‚&lt;/p&gt;
&lt;h3 id=&#34;2-bytebuferiobuffer-å¤ç”¨&#34;&gt;2. ByteBufer/IOBuffer å¤ç”¨&lt;/h3&gt;
&lt;h4 id=&#34;bytebuffer&#34;&gt;ByteBuffer&lt;/h4&gt;
&lt;p&gt;å…ˆæ¥çœ‹ç›¸å…³çš„ç»“æ„ä½“ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// byteBufferPool is []byte pools
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;minSize&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;maxSize&lt;/span&gt;  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferSlot&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bufferSlot&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;defaultSize&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Pool&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¯ä¸ª slot å¯¹åº”ä¸€ç§å°ºå¯¸çš„ byteBuffer çš„ poolï¼Œä»¥åŠ &lt;code&gt;defaultSize&lt;/code&gt; åŸŸä¿å­˜ç€å°ºå¯¸ã€‚&lt;code&gt;byteBufferPool&lt;/code&gt; å¯¹è±¡çš„ &lt;code&gt;pool&lt;/code&gt; åŸŸä¿å­˜ç€å¤šä¸ª slotã€‚&lt;/p&gt;
&lt;p&gt;å†æ¥çœ‹æ“ä½œæ–¹æ³• &lt;code&gt;GetBytes&lt;/code&gt; &lt;code&gt;PutBytes&lt;/code&gt;ï¼Œå…·ä½“é€»è¾‘ä¸»è¦æ˜¯æ“ä½œ &lt;code&gt;take&lt;/code&gt; å’Œ &lt;code&gt;give&lt;/code&gt; æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åé¢ä¼šåˆ†æã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L28&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L28&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L145&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L145&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// global bbPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bbPool&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// GetBytes returns *[]byte from byteBufferPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;bbPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// PutBytes Put *[]byte to byteBufferPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;PutBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;bbPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;give&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸ºäº†æé«˜å¤ç”¨ç‡ï¼Œå½“ç”³è¯·ä¸€ä¸ªé 64 å­—èŠ‚å¯¹é½å°ºå¯¸çš„ byte buffer æ—¶ï¼ˆå¦‚ 200ï¼‰ï¼ŒMOSN å®é™…ä¸Šä¼šä» slot 2ï¼Œå³ defaultSize = 256 çš„ slot è¿”å›å¯¹è±¡ï¼Œå¹¶è¿”å›åˆ‡ç‰‡ len = 200 çš„ byte åˆ‡ç‰‡ã€‚&lt;/p&gt;
&lt;p&gt;åˆå§‹åŒ–æ—¶ï¼Œå°† 64ã€128ã€256&amp;hellip; ä»¥æ­¤ç±»æ¨çš„å°ºå¯¸çš„ byte slot åˆå§‹åŒ–åˆ° byteBufferPool çš„ pool åŸŸå†…ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L49&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L49&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// newByteBufferPool returns byteBufferPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newByteBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;minSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;maxSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;maxShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;maxShift&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;slab&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;bufferSlot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// é€šè¿‡å·¦ç§»ç®—å‡º defaultSize = 64/128/256...ç­‰ç­‰
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;			&lt;span style=&#34;color:#000&#34;&gt;defaultSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä¾æ¬¡append
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slab&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½¿ç”¨æ—¶ï¼Œæ ¹æ®å°ºå¯¸ç®—å‡ºå¯¹åº”çš„ slotï¼Œä»å¯¹åº”çš„ slot è¿”å›è¯¥å°ºå¯¸çš„ byte æ•°ç»„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L65&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L65&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// æ¯”å¦‚è¦è·å– 200 size çš„ buffer
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;maxSize&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errSlot&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;shift&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;minSize&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// size - 199
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ä½: 1100 0111,ç»è¿‡ 8 æ¬¡å³ç§»ä¼š&amp;lt;=0
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;--&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;shift&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// slot = 8 - 6 = 2, è¯¥ slot çš„ defaultSize = 256
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;shift&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;minShift&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L87&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L87&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// take returns *[]byte from byteBufferPool
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;byteBufferPool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;take&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errSlot&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// slot = 2, 
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Get&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// å¦‚æœ slot get æ–¹æ³•æ²¡æœ‰è¿”å›, new ä¸€ä¸ª
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newBytes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;slot&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;].&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;defaultSize&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// è°ƒæ•´åˆ‡ç‰‡é•¿åº¦ä¸ºè¯·æ±‚çš„ size
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;b&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;byte æ•°ç»„ä½¿ç”¨å®Œæ¯•æ—¶ï¼Œå¯¹åº”çš„å°±æ˜¯å°† byte æ•°ç»„æ”¾å›å¯¹åº”çš„ slot é‡Œï¼Œè¿™é‡Œæ¯”è¾ƒå¥½ç†è§£ï¼Œå„ä½å¯ä»¥è‡ªè¡Œçœ‹æºç ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L106&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/bytebuffer_pool.go#L106&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸¤å¤„ä½¿ç”¨åˆ‡ç‰‡æŒ‡é’ˆï¼Œä¸»è¦è€ƒè™‘æ“ä½œ sync.Pool çš„ &lt;code&gt;Get&lt;/code&gt;ã€&lt;code&gt;Put&lt;/code&gt; æ–¹æ³•æ—¶é¿å…å‚æ•°æ‹·è´é—®é¢˜ã€‚&lt;/p&gt;
&lt;h4 id=&#34;iobuffer&#34;&gt;IOBuffer&lt;/h4&gt;
&lt;p&gt;IOBuffer åŠ IO buffer pool å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œä¸»è¦æ˜¯å®šä¹‰äº†ä¸ IO ç›¸å…³çš„æ¥å£ï¼Œç„¶åå®ç°æ–¹æ³•æ˜¯åŸºäºä¸Šæ–‡ byte buffer çš„ä½¿ç”¨æ–¹æ³•çš„å°è£…ï¼Œå³ read æ˜¯ä» byte buffer é‡Œè¯»å–ã€write æ˜¯å°†æ•°æ® copy è¿› byte bufferã€‚
æœ‰äº†ä¸Šæ–‡çš„åŸºç¡€ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥æ ¹æ®æºç å»çœ‹å…·ä½“çš„å®ç°ï¼Œå¹¶ä¸éš¾ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/types.go#L34&#34;&gt;https://github.com/mosn/mosn/blob/1609ae1441/vendor/mosn.io/pkg/buffer/types.go#L34&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;IO ç›¸å…³çš„æ¥å£ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Read&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;ReadOnce&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Reader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int64&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;Write&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;WriteString&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;WriteTo&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;w&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;io&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Writer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int64&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡æ ¹æ® MOSN çš„æºç åˆ†æäº† MOSN å¯¹å†…å­˜å¤ç”¨çš„è®¾è®¡å’Œç”¨æ³•ï¼Œå…¶åŸºäº sync.Pool ä¹‹ä¸Šå°è£…äº†ä¸€å±‚è‡ªå·±çš„æ³¨å†Œç®¡ç†é€»è¾‘ï¼Œå¢å¼ºäº†ç®¡ç†èƒ½åŠ›ã€æ˜“ç”¨æ€§å’Œå¤ç”¨æ€§ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;MOSN æºç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - Plugin æœºåˆ¶</title>
      <link>https://mosn.io/blog/code/mosn-plugin/</link>
      <pubDate>Fri, 14 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-plugin/</guid>
      <description>
        
        
        &lt;h2 id=&#34;æ¦‚è¿°&#34;&gt;æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;Plugin æœºåˆ¶æ˜¯ MOSN æä¾›çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥è®© MOSN å’Œä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹è¿›è¡Œäº¤äº’ï¼Œè¿™ä¸ªè¿›ç¨‹å¯ä»¥ç”¨ä»»ä½•è¯­è¨€å¼€å‘ï¼Œåªè¦æ»¡è¶³ gRPC çš„ proto å®šä¹‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;plugin.png&#34; alt=&#34;plugin&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆæˆ‘ä»¬æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼Œè·Ÿæˆ‘ä»¬é‡åˆ°çš„ä¸€äº›ä¸šåŠ¡åœºæ™¯æœ‰å…³ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯”å¦‚ log æ‰“å°ï¼Œåœ¨ io å¡é¡¿çš„æ—¶å€™ä¼šå½±å“ Go Runtime çš„è°ƒåº¦ï¼Œå¯¼è‡´è¯·æ±‚å»¶è¿Ÿã€‚æˆ‘ä»¬éœ€è¦æŠŠ log ç‹¬ç«‹æˆè¿›ç¨‹åšéš”ç¦»ã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬ä¼šæœ‰ä¸€äº›å¼‚æ„è¯­è¨€çš„æ‰©å±•ï¼Œæ¯”å¦‚ streamfilter çš„å®é™…é€»è¾‘æ˜¯ä¸€ä¸ª Java è¯­è¨€å®ç°çš„ã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬éœ€è¦å¿«é€Ÿæ›´æ–°ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œä½†ä¸èƒ½é¢‘ç¹çš„å»æ›´æ–° MOSN çš„ä»£ç ã€‚&lt;/li&gt;
&lt;li&gt;ä½œä¸ºç±»ä¼¼ Supervisor çš„ç®¡ç†å·¥å…·ï¼Œç®¡ç†ä¸€äº›å…¶ä»–è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ€»ç»“ä¸‹æ¥å°±æ˜¯éš”ç¦»æ€§ï¼Œæ”¯æŒå¼‚æ„è¯­è¨€æ‰©å±•ï¼Œæ¨¡å—åŒ–ï¼Œè¿›ç¨‹ç®¡ç†ç­‰åœºæ™¯ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥çœ‹çœ‹è¿˜æœ‰å“ªäº›åœºæ™¯å¯ä»¥ç”¨åˆ°ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä½¿ç”¨æ–¹æ³•&#34;&gt;ä½¿ç”¨æ–¹æ³•&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;examples/codes/plugin/pluginfilter/&lt;/code&gt;æä¾›äº†ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼Œé€šè¿‡ streamfilter æŠŠæ•°æ®ä¼ é€’ç»™ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹å¤„ç†å¹¶åé¦ˆã€‚&lt;br&gt;
æˆ‘ä»¬è¿™å„¿ç®€å•çœ‹ä¸‹&lt;code&gt;pkg/plugin/example/&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;h4 id=&#34;client&#34;&gt;client&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;	&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Register&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;plugin-server&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Println&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;Body&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;),&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Second&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;é€šè¿‡ &lt;code&gt;plugin.Register&lt;/code&gt;æ³¨å†Œä¸€ä¸ª pluginï¼Œname éœ€è¦å’Œç¼–è¯‘çš„äºŒè¿›åˆ¶åå­—ä¸€æ ·ï¼Œç„¶åå‡½æ•°ä¼šå»å¯åŠ¨è¿™ä¸ªç¨‹åºï¼Œè¿™ä¸ªç¨‹åºå°±æ˜¯ä¸‹é¢çš„ server ä»£ç ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨ &lt;code&gt;client.Call&lt;/code&gt; å‘é€è¯·æ±‚ç»™ server è¿›ç¨‹ï¼Œç„¶åæ”¶åˆ°å“åº”å¹¶å¤„ç†ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;server&#34;&gt;server&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetBody&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;hello&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;request body error&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;new&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Body&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;world&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Status&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;main&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Serve&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;é¦–å…ˆå®ç° &lt;code&gt;plugin.Service&lt;/code&gt;æ¥å£ï¼Œ&lt;code&gt;Call&lt;/code&gt; å‡½æ•°å°†æ¥æ”¶ client çš„è¯·æ±‚ï¼Œå¤„ç†ä¹‹åè¿”å›å“åº”ã€‚&lt;/li&gt;
&lt;li&gt;mainå‡½æ•°æ‰§è¡Œ&lt;code&gt;plugin.Serve&lt;/code&gt;ï¼Œè¿è¡ŒæœåŠ¡ç›‘å¬ client çš„è¯·æ±‚ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;è¿è¡Œ&#34;&gt;è¿è¡Œ&lt;/h4&gt;
&lt;p&gt;æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ go build -o plugin-client client/plugin.go
$ go build -o plugin-server server/plugin.go
$ ./plugin-client  2&amp;gt; /tmp/1
success! response body: world
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;åˆå§‹åŒ–&#34;&gt;åˆå§‹åŒ–&lt;/h2&gt;
&lt;p&gt;MOSN çš„ plugin åº•å±‚ä½¿ç”¨äº†&lt;code&gt;github.com/hashicorp/go-plugin&lt;/code&gt;åº“ï¼Œè¯¥åº“æ˜¯ HashiCorp å…¬å¸æä¾›çš„ä¸€ä¸ªæˆç†Ÿçš„æ‰©å±•ç³»ç»Ÿï¼Œå¯ä»¥æ–¹ä¾¿çš„æ‰©å±•è‡ªå·±çš„æ’ä»¶æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆçœ‹ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;	&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;plugin&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_base&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;/home/admin/mosn/logs/&amp;#34;&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;log_base&lt;/code&gt; plugin ä¼ é€’ç»™æ‰©å±•è¿›ç¨‹çš„æ—¥å¿—ç›®å½•&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨çœ‹ä¸€ä¸‹ proto å®šä¹‰ï¼ŒRequest å’Œ Resonse å®šä¹‰äº†å‡ ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å¯ä»¥é€‰æ‹©ä½¿ç”¨ï¼Œæ¯”å¦‚æ‰“å° log å°±éœ€è¦ä½¿ç”¨ Request çš„ boy å­—æ®µã€‚Call æ–¹æ³•å°±æ˜¯æˆ‘ä»¬éœ€è¦å®ç°çš„ï¼Œæ¥è¿›è¡Œè¯·æ±‚çš„å‘é€å’Œå¤„ç†å¤„ç†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-proto&#34; data-lang=&#34;proto&#34;&gt;&lt;span style=&#34;color:#000&#34;&gt;syntax&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;message&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailer&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bytes&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;body&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;message&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;header&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;trailer&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bytes&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;body&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int32&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;status&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Plugin&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;rpc&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;returns&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a40000&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Client&lt;/code&gt;ç®¡ç† client çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œç”¨æˆ·ä½¿ç”¨è¯¥ç»“æ„ä½“å‘é€è¯·æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Client is a plugin client, It&amp;#39;s primarily used to call request.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;pclient&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;   &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;     &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;fullName&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;service&lt;/span&gt;  &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;enable&lt;/span&gt;   &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;on&lt;/span&gt;       &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mutex&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Config&lt;/code&gt;åˆå§‹åŒ– Client çš„æ—¶å€™ä½¿ç”¨ï¼Œ&lt;code&gt;MaxProcs&lt;/code&gt;è¡¨ç¤ºç‹¬ç«‹è¿›ç¨‹çš„ GOMAXPROCS é…ç½®ï¼Œ&lt;code&gt;Args&lt;/code&gt;è¡¨ç¤ºç‹¬ç«‹è¿›ç¨‹çš„å¯åŠ¨å‚æ•°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;MaxProcs&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Args&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;å¯åŠ¨&#34;&gt;å¯åŠ¨&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Register&lt;/code&gt;ç”¨äº client ç«¯æ³¨å†Œ  pluginï¼Œå‚æ•°&lt;code&gt;name&lt;/code&gt;è¡¨ç¤º server çš„äºŒè¿›åˆ¶åå­—ï¼Œæ–‡ä»¶è·¯å¾„åŒäº client çš„äºŒè¿›åˆ¶è·¯å¾„ã€‚è¿”å›çš„ Client ç”¨äºç®¡ç†æ•´ä¸ª agent-client çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Register called by plugin client and start up the plugin main process.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Register&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;pluginLock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Lock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pluginLock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Unlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pluginFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;newClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;pluginFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;

	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;newClient&lt;/code&gt;ç”Ÿæˆ Clientï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯&lt;code&gt;Check&lt;/code&gt;æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨ serverã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é¦–å…ˆæŠŠ&lt;code&gt;GOMAXPROCS&lt;/code&gt;å’Œæ—¥å¿—è·¯å¾„é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ç»™serverè¿›ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;plugin.NewClient&lt;/code&gt;å¼€å¯ plugin æ¡†æ¶ä¹‹åï¼Œ &lt;code&gt;pclient.Client()&lt;/code&gt;å¯åŠ¨ server å­è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rpcClient.Dispense(&amp;quot;MOSN_SERVICE&amp;quot;)&lt;/code&gt; è¿”å›çœŸæ­£çš„å®ä¾‹ clientã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;client çš„æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹å°±å®Œæˆäº†ï¼Œä¸»è¦å°±æ˜¯å¯åŠ¨äº† server å­è¿›ç¨‹ï¼Œç„¶ååˆå§‹åŒ–äº† client GRPC çš„å®ä¾‹ï¼Œç”¨äºè¯·æ±‚å‘é€å’Œæ¥æ”¶ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Check&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;exec&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Command&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;fullName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Args&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;procs&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MaxProcs&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MaxProcs&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;procs&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MaxProcs&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Env&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Env&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sprintf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;MOSN_PROCS=%d&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;procs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Env&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Env&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;fmt&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Sprintf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;MOSN_LOGBASE=%s&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pluginLogBase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;pclient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClientConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;HandshakeConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Handshake&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;Plugins&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;         &lt;span style=&#34;color:#000&#34;&gt;PluginMap&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;Cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;             &lt;span style=&#34;color:#000&#34;&gt;cmd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;AllowedProtocols&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Protocol&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ProtocolGRPC&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;rpcClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;pclient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;raw&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rpcClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Dispense&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;MOSN_SERVICE&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;
 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¥ä¸‹æ¥æ˜¯ serverï¼Œserver ç«¯çš„ä»£ç ä¹Ÿå¯ä»¥ç”¨å…¶ä»–è¯­è¨€å®ç°ï¼Œåªè¦æ»¡è¶³ä¸€å®šçš„è§„èŒƒï¼Œä¸‹é¢çœ‹çœ‹ Go çš„å®ç°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é¦–å…ˆæ‰§è¡Œ&lt;code&gt;checkParentAlive()&lt;/code&gt;ä¸»è¦æ˜¯æ£€æŸ¥çˆ¶è¿›ç¨‹(ä¹Ÿå°±æ˜¯ client )æ˜¯å¦é€€å‡ºï¼Œå¦‚æœé€€å‡ºäº†ï¼Œè‡ªå·±ä¹Ÿéœ€è¦é€€å‡ºã€‚&lt;/li&gt;
&lt;li&gt;ç„¶åè¯»å–ç¯å¢ƒå˜é‡ï¼Œæ¥è®¾ç½®&lt;code&gt;GOMAXPROCS&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;æœ€åè°ƒç”¨&lt;code&gt;plugin.Serve&lt;/code&gt;å¯åŠ¨ GRPC Server æœåŠ¡æ¥æ”¶å¤„ç†è¯·æ±‚ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Serve is a function used to serve a plugin. This should be ran on the plugin&amp;#39;s main process.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Serve&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;checkParentAlive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;os&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Getenv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;MOSN_PROCS&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;procs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;strconv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Atoi&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;runtime&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GOMAXPROCS&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;procs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

	&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Serve&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ServeConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;HandshakeConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Handshake&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;Plugins&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;MOSN_SERVICE&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Impl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;service&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
		&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;GRPCServer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;plugin&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultGRPCServer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;})&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;server æœ€ä¸»è¦çš„å°±æ˜¯å®ç°&lt;code&gt;Service&lt;/code&gt;æ¥å£ï¼Œç”¨äºå¤„ç†è¯·æ±‚ï¼Œä¹‹å‰çš„ exmple å°±æœ‰ä¸€ä¸ªç®€å•çš„å®ç°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Service is a service that Implemented by plugin main process
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Service&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æ‰§è¡Œ&#34;&gt;æ‰§è¡Œ&lt;/h2&gt;
&lt;p&gt;client åªéœ€è¦æ‰§è¡Œ&lt;code&gt;Call&lt;/code&gt;å‡½æ•°å°±å¯ä»¥å‘é€å’Œæ¥æ”¶è¯·æ±‚ï¼Œå®ç°ä¼šå…ˆé€šè¿‡&lt;code&gt;Check()&lt;/code&gt;æ¥æ£€æŸ¥ server æ˜¯å¦å¥åº·ï¼Œå¦‚æœä¸å¥åº·ä¼šå…ˆå¯åŠ¨ serverï¼Œç„¶åè°ƒç”¨çœŸæ­£çš„å®ç°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Call invokes the function synchronously.
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Duration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Check&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;();&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;service&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é¦–å…ˆè®¾ç½® timeout è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œç„¶ååœ¨è°ƒç”¨ GRPC çš„æ¥å£å‘é€è¯·æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Duration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cancel&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CancelFunc&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cancel&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithTimeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Background&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;timeout&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cancel&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Background&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;PluginClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨ server ç«¯ä¼šç›´æ¥æ‰§è¡Œæˆ‘ä»¬å®ç°çš„ Call æ¥å£ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;server&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;req&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Request&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;proto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Response&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Impl&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Call&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;req&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;ç®¡ç†&#34;&gt;ç®¡ç†&lt;/h2&gt;
&lt;p&gt;MOSN æä¾›äº† HTTP æ¥å£æ¥æŸ¥çœ‹ plugin çš„è¿è¡ŒçŠ¶æ€ï¼Œä»¥åŠå¼€å¯å…³é—­ Pluginã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;Usage:
/plugin?status&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;all
/plugin?status&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pluginname
/plugin?enable&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pluginname
/plugin?disable&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;pluginname
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨ disable ä¹‹åï¼Œserver å°±ä¼šè¢«å…³é—­ï¼Œå¹¶ä¸”ä¸ä¼šå†å¯åŠ¨ï¼Œä¸»è¦ä¸ºäº†é˜²æ­¢ server æœ‰é—®é¢˜çš„æ—¶å€™å¯ä»¥å…³é—­æ‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;å¯„æ‰˜äºå¼€æºç¤¾åŒºï¼Œæˆ‘ä»¬æ–¹ä¾¿çš„æ­å»ºäº†è‡ªå·±çš„æ‰©å±•æœºåˆ¶ï¼ŒMOSN ä¹ŸæŠŠè‡ªå·±çš„æƒ³æ³•åé¦ˆç»™ç¤¾åŒºï¼Œå…±åŒè¿›æ­¥ã€‚&lt;/p&gt;
&lt;p&gt;æ‹¥æŠ±å¼€æºï¼Œåå“ºå¼€æºã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - XDS</title>
      <link>https://mosn.io/blog/code/mosn-xds/</link>
      <pubDate>Thu, 13 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-xds/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.9.0ã€‚&lt;/p&gt;
&lt;p&gt;XDSç”¨æ¥ä¸pilot-discoveryé€šè®¯åšæœåŠ¡å‘ç°åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;XDSæ˜¯ä¸€ç±»å‘ç°æœåŠ¡çš„æ€»ç§°ï¼ŒåŒ…å«LDSï¼Œ RDSï¼Œ CDSï¼Œ EDSä»¥åŠSDSã€‚&lt;/p&gt;
&lt;p&gt;MOSNé€šè¿‡XDS APIå¯ä»¥åŠ¨æ€è·å–Listenerï¼ˆç›‘å¬å™¨ï¼‰ï¼ŒRouteï¼ˆè·¯ç”±ï¼‰ï¼Œ Clusterï¼ˆé›†ç¾¤ï¼‰ï¼Œ Endpointï¼ˆé›†ç¾¤æˆå‘˜ï¼‰ä»¥åŠSecretï¼ˆè¯ä¹¦ï¼‰é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;XDSçš„åŸºæœ¬æµç¨‹ï¼šPilot-Discoveryçš„Model -&amp;gt; XDS.pb -&amp;gt; GRPC -&amp;gt; XDS.pb -&amp;gt; MOSNçš„Model ï¼ˆGRPCåŒ…æ‹¬åºåˆ—åŒ–å’Œç½‘ç»œä¼ è¾“ï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;é…ç½®æ–‡ä»¶è§£æ&#34;&gt;é…ç½®æ–‡ä»¶&amp;amp;è§£æ&lt;/h2&gt;
&lt;p&gt;if len(DynamicResources) &amp;gt; 0 &amp;amp;&amp;amp; len(StaticResources) &amp;gt; 0 è¿›å…¥XDSæ¨¡å¼ã€‚&lt;/p&gt;
&lt;p&gt;XDSæ¨¡å¼ä¸‹çš„MOSNé…ç½®æ–‡ä»¶mosn_config.json:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;dynamic_resources&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;lds_config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;ads&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;cds_config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;ads&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;ads_config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;api_type&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;GRPC&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;cluster_names&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;xxx&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;],&lt;/span&gt;
      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;grpc_services&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
          &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;envoy_grpc&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;cluster_name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;xds-grpc&amp;#34;&lt;/span&gt;
          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt;
  &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;static_resources&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;clusters&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;xds-grpc&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;STRICT_DNS&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;lb_policy&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;RANDOM&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;hosts&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;socket_address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;istio-pilot.istio-system.svc.boss.twl&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;port_value&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;15010&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;],&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;http2_protocol_options&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è§£æé…ç½®æ–‡ä»¶æ„å»ºXDSConfigï¼ˆXDSå®¢æˆ·ç«¯çš„é…ç½®ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;æ„å»ºadsClientï¼ˆXDSå®¢æˆ·ç«¯ï¼‰ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MOSNConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Infof&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;xds client start&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è§£æé…ç½®æ–‡ä»¶
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;dynamicResources&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;staticResources&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;UnmarshalResources&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Warnf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;fail to unmarshal xds resources, skip xds: %v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;fail to unmarshal xds resources&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ„å»ºxdsConfig
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;xdsConfig&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;XDSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;xdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;dynamicResources&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;staticResources&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Warnf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;fail to init xds config, skip xds: %v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errors&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;New&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;fail to init xds config&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ„å»ºadsCLient
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;stopChan&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;sendControlChan&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;recvControlChan&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;AdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;         &lt;span style=&#34;color:#000&#34;&gt;xdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;StreamClientMutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sync&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RWMutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;      &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;MosnConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;SendControlChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#000&#34;&gt;sendControlChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;RecvControlChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#000&#34;&gt;recvControlChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;StopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;          &lt;span style=&#34;color:#000&#34;&gt;stopChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;åˆå§‹åŒ–å’Œå¯åŠ¨xdsè¿æ¥&#34;&gt;åˆå§‹åŒ–å’Œå¯åŠ¨xdsè¿æ¥&lt;/h2&gt;
&lt;p&gt;adsClient.start()&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ„å»ºgrpcåŒå‘æµè¿æ¥ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStreamClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è®¤è¯å’Œå¼€å¯xdsä¼ è¾“ï¼Œå¹¶ä¸”è®¾ç½®å®šæ—¶é‡ä¼ 
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//æ¥å—ä¸‹å‘æ•°æ®ï¼Œå¹¶æ ¹æ®ç±»å‹é€‰æ‹©ä¸åŒçš„handlerå¤„ç†
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;		&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å‡½æ•°ç»†èŠ‚ï¼š
&lt;a href=&#34;https://github.com/mosn/mosn/blob/master/pkg/xds/v2/adssubscriber.go&#34;&gt;https://github.com/mosn/mosn/blob/master/pkg/xds/v2/adssubscriber.go&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;xdsæ¶ˆæ¯å¤„ç†å’Œå‘é€&#34;&gt;XDSæ¶ˆæ¯å¤„ç†å’Œå‘é€&lt;/h2&gt;
&lt;p&gt;å››ç§ç±»å‹å¤„ç†å™¨æ³¨å†Œã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyClusterLoadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyClusterLoadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyRouteConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyRouteConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¥å—æ•°æ®ç±»å‹ï¼Œå°†XDSç±»å‹è½¬æ¢æˆMOSNæ•°æ®ç±»å‹ï¼Œå¹¶ä¸”åŠ å…¥å¯¹åº”çš„managerã€‚&lt;/p&gt;
&lt;p&gt;ä»¥HandlerListenerä¸ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DiscoveryResponse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Tracef&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;get lds resp,handle it&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è§£æè¿”å›æ¶ˆæ¯ï¼Œç”Ÿæˆenvoy_listener
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleListenersResp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Infof&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;get %d listeners from LDS&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;len&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;))&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//è½¬æ¢envoy_listenerä¸ºmosn_listenerï¼Œå¹¶ä¸”åŠ å…¥ListenerAdapter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;	&lt;span style=&#34;color:#000&#34;&gt;conv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConvertAddOrUpdateListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reqRoutes&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Warnf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;send thread request rds fail!auto retry next period&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å‡½æ•°ç»†èŠ‚ï¼š
&lt;a href=&#34;https://github.com/mosn/mosn/blob/master/pkg/xds/v2/default_handler.go&#34;&gt;https://github.com/mosn/mosn/blob/master/pkg/xds/v2/default_handler.go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¯·æ±‚ä¸å¤„ç†æµç¨‹ç®€å•æ‰€ç¤ºï¼Œä¹Ÿå¯æ¥å—pilot-discoveryçš„æ¨é€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;switch(type):
  case: cluster:
    æ¥æ”¶clusterè¿”å›ï¼Œæ ¹æ®clusterNameè¯·æ±‚Endpoints
  case: endpoint:
    æ¥æ”¶Endpointsï¼Œè¯·æ±‚Listener
  case: listener
    æ¥å—Listenerï¼Œè¯·æ±‚Routes
  case: router
    æ¥å—Routes
       
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;xdsç±»å‹è½¬æ¢&#34;&gt;XDSç±»å‹è½¬æ¢&lt;/h2&gt;
&lt;p&gt;XDS.pdæ•°æ®ç»“æ„ç±»å‹åœ¨ï¼š
&lt;a href=&#34;https://github.com/envoyproxy/go-control-plane&#34;&gt;https://github.com/envoyproxy/go-control-plane&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ”¶åˆ°æ•°æ®å¹¶ååºåˆ—åŒ–ä¸ºXDSçš„Modelä¹‹åï¼Œè¿›è¡Œç»“æ„ä½“è½¬æ¢ã€‚&lt;/p&gt;
&lt;p&gt;ç±»å‹è½¬æ¢ä»£ç å¦‚ä¸‹ï¼š
&lt;a href=&#34;https://github.com/mosn/mosn/blob/master/pkg/xds/conv/convertxds.go&#34;&gt;https://github.com/mosn/mosn/blob/master/pkg/xds/conv/convertxds.go&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ - filteræ‰©å±•æœºåˆ¶</title>
      <link>https://mosn.io/blog/code/mosn-filters/</link>
      <pubDate>Sun, 09 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-filters/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.9.0ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœºåˆ¶&#34;&gt;æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;ä½¿ç”¨è¿‡æ»¤å™¨æ¨¡å¼æ¥å®ç°æ‰©å±•æ˜¯å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼ŒMOSN ä¹Ÿæ˜¯ä½¿ç”¨äº†è¿™ç§æ–¹å¼æ¥æ„å»ºå¯æ‰©å±•æ€§ã€‚&lt;/p&gt;
&lt;p&gt;MOSN æŠŠè¿‡æ»¤å™¨ç›¸å…³çš„ä»£ç æ”¾åœ¨äº† &lt;code&gt;pkg/filter&lt;/code&gt; ç›®å½•ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;âœ  mosn git:&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;2c6f58c5&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; âœ— ll pkg/filter
total &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt;
drwxr-xr-x   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;8&lt;/span&gt; mac  staff   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;256&lt;/span&gt; Feb  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; 08:52 .
drwxr-xr-x  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;30&lt;/span&gt; mac  staff   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;960&lt;/span&gt; Feb  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; 08:52 ..
drwxr-xr-x   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt; mac  staff    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;96&lt;/span&gt; Aug &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;28&lt;/span&gt; 22:37 accept
-rw-r--r--   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; mac  staff  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2556&lt;/span&gt; Feb  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; 08:52 factory.go
-rw-r--r--   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; mac  staff  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2813&lt;/span&gt; Feb  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; 08:52 factory_test.go
drwxr-xr-x   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;6&lt;/span&gt; mac  staff   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;192&lt;/span&gt; Aug &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;28&lt;/span&gt; 22:37 network
drwxr-xr-x   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;7&lt;/span&gt; mac  staff   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;224&lt;/span&gt; Aug &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;28&lt;/span&gt; 22:37 stream
-rw-r--r--   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; mac  staff  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1248&lt;/span&gt; Feb  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt; 08:52 types.go
âœ  mosn git:&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;2c6f58c5&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; âœ—
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åŒ…æ‹¬ &lt;code&gt;accept&lt;/code&gt; è¿‡ç¨‹çš„ filterï¼Œ&lt;code&gt;network&lt;/code&gt; å¤„ç†è¿‡ç¨‹çš„ filterï¼Œä»¥åŠ &lt;code&gt;stream&lt;/code&gt; å¤„ç†çš„ filterã€‚å…¶ä¸­ accept filters ç›®å‰æš‚ä¸æä¾›æ‰©å±•ï¼ˆåŠ è½½ã€è¿è¡Œå†™æ­»åœ¨ä»£ç é‡Œé¢ï¼Œå¦‚è¦æ‰©å±•éœ€è¦ä¿®æ”¹æºç ï¼‰ï¼Œ
steramã€network filters æ˜¯å¯ä»¥é€šè¿‡å®šä¹‰æ–°åŒ…åœ¨ &lt;code&gt;pkg/filter&lt;/code&gt; ç›®å½•ä¸‹å®ç°æ‰©å±•ã€‚&lt;/p&gt;
&lt;p&gt;æ¯ä¸€ä¸ª filter åŒ…éƒ½ä¼šæœ‰ä¸€ä¸ª init å‡½æ•°ï¼Œæ‹¿ &lt;code&gt;pkg/filter/network/proxy&lt;/code&gt; åŒ…ä¸ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;...

 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; the specific language governing permissions and
 * limitations under the License.
 */

package proxy

import &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;
    ...
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;

func init&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;{&lt;/span&gt;
	filter.RegisterNetwork&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;v2.DEFAULT_NETWORK_FILTER, CreateProxyFactory&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;}&lt;/span&gt;

...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åŒ…è¢«è¿è¡Œæ—¶ä¼šå°† filter æ³¨å†Œåˆ° filter factory é‡Œï¼Œåœ¨å¿…è¦æ—¶å€™ï¼Œæ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼ˆå¦‚ä¾‹å­é‡Œçš„ &lt;code&gt;CreateProxyFactory&lt;/code&gt;ï¼‰å°±ä¼šè¢«è°ƒç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åŠ è½½--è¿è¡Œ-filters&#34;&gt;åŠ è½½ &amp;amp; è¿è¡Œ filters&lt;/h2&gt;
&lt;p&gt;ä¸‹é¢æ¥è¯¦ç»†çœ‹çœ‹ filters è¢«åŠ è½½å’Œè¿è¡Œçš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åŠ è½½&#34;&gt;åŠ è½½&lt;/h3&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ï¼Œinit å‡½æ•°æ³¨å†Œçš„å›è°ƒå‡½æ•°æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºè¢«è°ƒç”¨çš„ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/filter/factory.go#L57&#34;&gt;mosn.io/mosn/pkg/filter/factory.go L57:&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// CreateNetworkFilterChainFactory creates a StreamFilterChainFactory according to filterType
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;CreateNetworkFilterChainFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterType&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;map&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;interface&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{})&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;creatorNetworkFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;â†“&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/config/parser.go#L372&#34;&gt;mosn.io/mosn/pkg/config/parser.go L372:&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// GetNetworkFilters returns a network filter factory by filter.Type
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;GetNetworkFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;factories&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt;
	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Filters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color:#000&#34;&gt;factory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateNetworkFilterChainFactory&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Type&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯è§ï¼ŒMOSN åœ¨è°ƒç”¨ &lt;code&gt;config.GetNetworkFilters&lt;/code&gt; ä¼šæ ¹æ®&lt;code&gt;é…ç½®ä¿¡æ¯&lt;/code&gt;ä¸­ &lt;code&gt;filter.Type&lt;/code&gt; ä½œä¸ºåå­—ï¼Œåœ¨å·²æ³¨å†Œçš„ filters ä¸­æ‰¾åˆ°éœ€è¦åŠ è½½çš„ filterï¼Œå¹¶è¿”å› networkFilterChainFactoryã€‚
å¯ä»¥çœ‹åˆ°ï¼Œ &lt;code&gt;filter.Type&lt;/code&gt; å…¶å®å°±æ˜¯ init å‡½æ•°è°ƒç”¨æ—¶ï¼ŒåŒ…è°ƒç”¨ &lt;code&gt;filter.RegisterNetwork&lt;/code&gt; å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼šfilter åã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆï¼Œé…ç½®ä¿¡æ¯åˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ¥æº1ï¼š &lt;strong&gt;é…ç½®æ–‡ä»¶&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç”¨æˆ·å¯ä»¥é€šè¿‡å®šä¹‰ MOSN çš„ config.jsonï¼ŒMOSN å¯åŠ¨æ—¶ä¼šæ ¹æ® listener æŒ‡å®šçš„ filter æ•°ç»„è¿›è¡Œ filters çš„åˆå§‹åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/mosn/starter.go#L173&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/mosn/starter.go#L173&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;NewMosn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MOSNConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Mosn&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
  
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt;
  	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterChainFactory&lt;/span&gt;
  
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// Note: as we use fasthttp and net/http2.0, the IO we created in mosn should be disabled
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// network filters
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;  	&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UseOriginalDst&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
  	    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// network and stream filters
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetNetworkFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChains&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;])&lt;/span&gt;
  		&lt;span style=&#34;color:#000&#34;&gt;sfcf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;lc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¥æº2ï¼š&lt;strong&gt;XDS ä¿¡æ¯è§£æ&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;MOSN é‡Œçš„ XDS client ä¼šå°† XDS resources è§£ææˆ MOSN çš„ configï¼Œå½“ downstream client è¿æ¥è¿›æ¥çš„æ—¶å€™æ ¹æ® config è¿›è¡Œç»„è£…éœ€è¦ç”¨åˆ°çš„ filtersã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/xds/conv/update.go#L71&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/xds/conv/update.go#L71&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// ConvertAddOrUpdateListeners converts listener configuration, used to  add or update listeners
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConvertAddOrUpdateListeners&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listeners&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;streamFilters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilterChainFactory&lt;/span&gt;
		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;networkFilters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NetworkFilterChainFactory&lt;/span&gt;

		&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mosnListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UseOriginalDst&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
			&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filterChain&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterChains&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;nf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetNetworkFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color:#000&#34;&gt;networkFilters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;networkFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nf&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color:#000&#34;&gt;streamFilters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;mosnListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ‰€ä»¥ï¼Œfilters çš„é…ç½®ä¸»è¦æ˜¯æ¥æºäºé…ç½®æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è¿è¡Œ&#34;&gt;è¿è¡Œ&lt;/h3&gt;
&lt;p&gt;filters çš„é…ç½®æ˜¯åœ¨ listener ä¹‹ä¸‹çš„ï¼Œé…ç½®è§£æä¼šå°†æ¯ä¸ª listener é…ç½®å£°æ˜è¦ç”¨åˆ°çš„ filters åˆå§‹åŒ–åˆ° listener å®ä¾‹é‡Œï¼Œåœ¨è¿æ¥ accept ä»¥åŠå¤„ç†è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ä¸Šæ–‡çš„å‡½æ•°åˆå§‹åŒ– filters å¹¶è°ƒç”¨ã€‚&lt;/p&gt;
&lt;p&gt;MOSN ä¼šå°†è¿æ¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ”¾åœ¨ context å†…ä¼ ç»™ filterï¼Œå¹¶å°† stream ä¼ ç»™ filterã€‚ä¸‹é¢æ˜¯ä»£ç æµç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;(1) è¿æ¥ acceptï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L394&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L394&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnAccept&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;useOriginalDst&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oriRemoteAddr&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Addr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000&#34;&gt;arc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContinueFilterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;(2) å°†è¿æ¥ä¸Šä¸‹æ–‡æ”¾å…¥ contextï¼Œå¹¶ç”¨ä»¥åˆ›å»º filter chainï¼Œå¹¶åˆå§‹åŒ– filter managerï¼Œæ‰§è¡Œ filters çš„ &lt;code&gt;OnNewConnection&lt;/code&gt; å‡½æ•°ã€‚
filter manager æ˜¯ filters çš„ä»£ç†ï¼Œå¤–éƒ¨ä¼šåœ¨ä¸åŒé˜¶æ®µè°ƒç”¨ filter manager çš„ä¸åŒå‡½æ•°ï¼Œfilter manager ç®¡ç† filters çš„æ‰§è¡Œé€»è¾‘ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L394&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L394&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnAccept&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;rawc&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;useOriginalDst&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;bool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oriRemoteAddr&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;net&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Addr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
   
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Background&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(),&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyListenerPort&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listenPort&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyListenerType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Config&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Type&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyListenerName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;listener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;())&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyNetworkFilterChainFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;networkFiltersFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyStreamFilterChainFactories&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;streamFiltersFactoriesStore&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyAccessLogs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;accessLogs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rawf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
       &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyConnectionFd&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;rawf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
       &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyAcceptChan&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ch&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
       &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextKeyAcceptBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;buf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oriRemoteAddr&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
       &lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;mosnctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WithValue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ContextOriRemoteAddr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;oriRemoteAddr&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;â†“&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L454&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/server/handler.go#L454&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;activeListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnNewConnection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//Register Proxy&amp;#39;s Filter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;conn&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;FilterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;networkFiltersFactories&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;nfcf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;CreateFilterChain&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;al&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handler&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitializeReadFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;(3) æ‰§è¡Œ filter çš„ &lt;code&gt;OnData&lt;/code&gt; æ–¹æ³•&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/network/connection.go#L428&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/network/connection.go#L428&lt;/a&gt; -&amp;gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/network/connection.go#L484&#34;&gt;https://github.com/mosn/mosn/blob/0.9.0/pkg/network/connection.go#L484&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;doRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;onRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;

&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;connection&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;onRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;c&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;filterManager&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;OnRead&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è‡³æ­¤ï¼Œfilter å°±å®ç°äº†å¯¹è¿æ¥çš„å¹²é¢„ï¼Œfilter å°±åƒä¸­é—´ä»¶ï¼Œå¯ä»¥è¿”å› &lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/types/network.go#L148&#34;&gt;type.Continue&lt;/a&gt; æ§åˆ¶è¿æ¥ç»§ç»­è¿›è¡Œï¼Œ
ä¹Ÿå¯ä»¥è¿”å› &lt;a href=&#34;https://github.com/mosn/mosn/blob/0.9.0/pkg/types/network.go#L149&#34;&gt;type.Stop&lt;/a&gt; åœæ­¢è¿æ¥ç»§ç»­å¤„ç†ã€‚å³å¯ä»¥å¯¹è¿æ¥å†…å®¹è¿›è¡Œå¹²é¢„ï¼Œæ¯”å¦‚åœ¨ static response çš„åœºæ™¯ï¼Œ
è¿”å›æ—¢å®šçš„ response å†…å®¹ï¼›ä¹Ÿå¯ä»¥å¯¹è¿æ¥å¤„ç†æµç¨‹è¿›è¡Œå¹²é¢„ï¼Œæ¯”å¦‚åœ¨ fault injection çš„åœºæ™¯ï¼Œå¢åŠ è¿æ¥å»¶æ—¶ï¼Œç­‰ç­‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mosn-å®ç°äº†çš„-filters&#34;&gt;MOSN å®ç°äº†çš„ filters&lt;/h2&gt;
&lt;p&gt;æ ¹æ®æ–‡ä»¶ç›®å½•æˆ‘ä»¬å¯ä»¥çœ‹å‡º MOSN ç›®å‰å®ç°äº†å“ªäº› filterï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;
âœ  mosn git:(2c6f58c5) âœ— ll pkg/filter/network
total 0
drwxr-xr-x   7 mac  staff  224 Aug 28 22:37 .
drwxr-xr-x   8 mac  staff  256 Feb  9 15:49 ..
drwxr-xr-x  3 mac  staff   96 Feb  8 10:35 connectionmanager // è¿æ¥ç®¡ç†
drwxr-xr-x  4 mac  staff  128 Feb  5 08:52 faultinject // é”™è¯¯æ³¨å…¥ç›¸å…³
drwxr-xr-x  3 mac  staff   96 Feb  9 12:37 proxy // ä»£ç†é€»è¾‘, è¿™ä¸ª filter ç›®å‰æ˜¯ MONS é‡Œçš„é€»è¾‘ä¸€éƒ¨åˆ†, è´Ÿè´£å°† stream å‘é€åˆ° serverStream, å¼€å¯æµé‡çš„ä»£ç†
drwxr-xr-x  6 mac  staff  192 Feb  5 08:52 tcpproxy // tcp ä»£ç†é€»è¾‘

âœ  mosn git:(2c6f58c5) âœ— ll pkg/filter/stream
total 0
drwxr-xr-x   7 mac  staff  224 Aug 28 22:37 .
drwxr-xr-x   8 mac  staff  256 Feb  9 15:49 ..
drwxr-xr-x  11 mac  staff  352 Feb  5 08:52 commonrule // stream filter é€»è¾‘å…¬å…±éƒ¨åˆ†, rule engine ç­‰ç­‰
drwxr-xr-x   6 mac  staff  192 Feb  5 08:52 faultinject // é”™è¯¯æ³¨å…¥ç›¸å…³
drwxr-xr-x   3 mac  staff   96 Aug 28 22:37 healthcheck // upstream å¥åº·æ£€æŸ¥ç›¸å…³
drwxr-xr-x   3 mac  staff   96 Feb  5 08:52 mixer // mixer é€»è¾‘ç›¸å…³
drwxr-xr-x   4 mac  staff  128 Feb  5 08:52 payloadlimit // é™æµç›¸å…³
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å…·ä½“æ¯ä¸ª filter çš„é€»è¾‘éƒ½å¯ä»¥æ ¹æ®ä¸‹è¿°çš„ filter ç»“æ„ï¼Œè¿›è¡Œä»£ç è·Ÿè¯»å’Œè°ƒè¯•ï¼Œåˆ†åˆ«ç†è§£æ¯ä¸ª filter çš„ä½œç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;filter-åŒ…å«çš„å†…å®¹--å¦‚ä½•æ‰©å±•-mosn-filters&#34;&gt;filter åŒ…å«çš„å†…å®¹ &amp;amp; å¦‚ä½•æ‰©å±• MOSN filters&lt;/h2&gt;
&lt;p&gt;ä¸€ä¸ª filter åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;init å‡½æ•°ï¼Œregister åˆ›å»º filter manager çš„å›è°ƒå‡½æ•°&lt;/li&gt;
&lt;li&gt;å›è°ƒå‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªå®ç°äº† &lt;code&gt;types.NetworkFilterChainFactory&lt;/code&gt; æ¥å£çš„ struct&lt;/li&gt;
&lt;li&gt;è¯¥ struct çš„ &lt;code&gt;CreateFilterChain&lt;/code&gt; æ–¹æ³•åˆ›å»ºå…·ä½“é€»è¾‘çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨ &lt;code&gt;callback&lt;/code&gt; å‚æ•°çš„ &lt;code&gt;addReadFilter&lt;/code&gt; | &lt;code&gt;addWriteFilter&lt;/code&gt; å‡½æ•°ï¼Œè¿›è¡Œ filter æ³¨å…¥åˆ° filter manager&lt;/li&gt;
&lt;li&gt;å…·ä½“çš„ä¸šåŠ¡é€»è¾‘&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç”±æ­¤å¯è§ï¼Œé€šè¿‡ filter æœºåˆ¶æ‰©å±• MOSNï¼Œæˆ‘ä»¬åªéœ€å®ç°ä¸Šè¿° 4 æ ·ä¸œè¥¿ï¼Œä¸ MOSN ä¸€åŒç¼–è¯‘ã€‚å†é€šè¿‡é€‚å½“çš„ config å†…å®¹é…ç½®ï¼Œæˆ–è€…ä¸ XDS server åä½œå¹¶ç”Ÿæˆå«æœ‰ä½ æ‰©å±•çš„ filter ååŠé…ç½®
ï¼ˆè¿™éƒ¨åˆ†éœ€è¦ä¿®æ”¹ MOSN æºç ï¼ŒMOSN ä¸ XDS server äº¤äº’å¹¶ç”Ÿæˆ configï¼Œé€‰ç”¨å“ªäº› filter ç›®å‰æ˜¯å†™æ­»åœ¨ä»£ç é‡Œçš„ï¼‰ï¼ŒMOSN å°±ä¼šåœ¨é€‚å½“æ—¶å€™åŠ è½½å¹¶è¿è¡Œä½ çš„ filterï¼Œå¯¹ä»£ç†æµé‡è¿›è¡Œå¹²é¢„ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡é€šè¿‡åˆ†æ MOSN æºç ï¼Œç®€è¿°äº† MOSN çš„filteræ‰©å±•æœºåˆ¶ï¼Œå¹¶ç®€è¿°äº†å®ç°è‡ªå·±çš„ filter éœ€è¦åšçš„ä¸œè¥¿ã€‚å¤§å®¶å¯ä»¥é€šè¿‡è¯¥æœºåˆ¶ï¼Œä½¿ç”¨ MONS è½»æ¾ cover è‡ªå·±å…·ä½“çš„ä½¿ç”¨åœºæ™¯ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mosn/mosn&#34;&gt;MOSN æºç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç æµ…æ</title>
      <link>https://mosn.io/blog/posts/mosn-source-code-brief/</link>
      <pubDate>Sun, 02 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/mosn-source-code-brief/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;MOSNæ˜¯åŸºäºGoå¼€å‘çš„sidecarï¼Œç”¨äºservice meshä¸­çš„æ•°æ®é¢ä»£ç†ï¼Œå»ºè®®å…ˆçœ‹ä¸‹&lt;a href=&#34;http://qiankunli.github.io/2020/01/14/self_cultivation_of_sidecar.html&#34;&gt;ä¸€ä¸ªsidecarçš„è‡ªæˆ‘ä¿®å…»&lt;/a&gt; å¯¹sidecar çš„åŸºæœ¬æ¦‚å¿µã€åŸç†æœ‰æ‰€äº†è§£ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ‰‹æ„Ÿ&#34;&gt;æ‰‹æ„Ÿ&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mosn/mosn/tree/master/examples/cn_readme/http-sample&#34;&gt;ä½¿ç”¨ MOSN ä½œä¸º HTTP ä»£ç†&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡è®¾ç½® log level ä¸ºdebugï¼Œä»£ç ä¸­åŠ æ›´å¤šæ—¥å¿—æ¥è¾…åŠ©åˆ†æä»£ç ã€‚&lt;strong&gt;æœ¬æ–‡ä¸»è¦ä»¥http-example ä¸ºä¾‹æ¥åˆ†æ&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åŸºæœ¬ä½¿ç”¨&#34;&gt;åŸºæœ¬ä½¿ç”¨&lt;/h3&gt;
&lt;p&gt;&lt;a href=&#34;https://juejin.im/post/5c62344f6fb9a049c232e821&#34;&gt;MOSNæºç è§£æâ€”é…ç½®è¯¦è§£&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;mosn
    examples
        codes
            http-example
                // mosn start -c config.json å³å¯å¯åŠ¨mosn
                config.json
                // golang å®ç°çš„ä¸€ä¸ªç®€å•çš„http serverï¼Œç›´æ¥go run server.go å³å¯å¯åŠ¨
                server.go     
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;mosn_http_example.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;http://localhost:8080&lt;/code&gt; å’Œ &lt;code&gt;http://localhost:2345&lt;/code&gt; éƒ½å¯ä»¥æ‹¿åˆ°æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn_http_example_diff.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;é…ç½®ç†è§£&#34;&gt;é…ç½®ç†è§£&lt;/h3&gt;
&lt;p&gt;å¯¹åº”config.json çš„å†…å®¹å¦‚ä¸‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;servers&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;default_log_path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;listeners&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;serverListener&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;127.0.0.1:2046&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;bind_port&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;filter_chains&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
                        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
                    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; 
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;clientListener&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;127.0.0.1:2045&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;bind_port&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;log_path&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; 
                    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;filter_chains&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;
                        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
                    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;]&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;],&lt;/span&gt; 
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;cluster_manager&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{},&lt;/span&gt; 
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å•æ‹å‡ºæ¥ admin éƒ¨åˆ†ï¼Œ MOSN ç›‘å¬34901 ç«¯å£ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;quot;admin&amp;quot;: {
  &amp;quot;address&amp;quot;: {
    &amp;quot;socket_address&amp;quot;: {
      &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
      &amp;quot;port_value&amp;quot;: 34901
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è®¿é—®&lt;code&gt;http://localhost:34901/&lt;/code&gt;çš„è¿”å›ç»“æœã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;support apis:
/api/v1/update_loglevel
/api/v1/enable_log
/api/v1/disbale_log
/api/v1/states
/api/v1/config_dump
/api/v1/stats
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;ä»£ç ç»“æ„&#34;&gt;ä»£ç ç»“æ„&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;mosn_package.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‡ ä¹æ‰€æœ‰çš„ interface å®šä¹‰åœ¨ &lt;code&gt;pkg/types&lt;/code&gt; ä¸­ï¼ŒMOSN åŸºäºå››å±‚æ¶æ„å®ç°ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œæ¯ä¸€ä¸ª layer åœ¨ types ä¸­æœ‰ä¸€ä¸ª go æ–‡ä»¶ï¼Œåœ¨&lt;code&gt;pkg&lt;/code&gt; ä¸‹æœ‰ä¸€ä¸ªä¸“é—¨çš„æ–‡ä»¶å¤¹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åˆ†å±‚æ¶æ„&#34;&gt;åˆ†å±‚æ¶æ„&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;mosn_layer_process.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸€èˆ¬çš„æœåŠ¡ç«¯ç¼–ç¨‹ï¼ŒäºŒçº§åˆ¶æ•°æ®ç»è¿‡åè®®è§£æä¸ºåè®®å¯¹åº”çš„modelï¼ˆæ¯”å¦‚HttpServletRequestï¼‰ è¿›è€Œäº¤ç»™ä¸Šå±‚ä¸šåŠ¡æ–¹å¤„ç†ï¼Œå¯¹äº MOSNï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åè®®ä¸Šæ•°æ®ç»Ÿä¸€åˆ’åˆ†ä¸º &lt;code&gt;header/data/Trailers&lt;/code&gt; ä¸‰ä¸ªéƒ¨åˆ†ï¼Œè½¬å‘ä¹Ÿæ˜¯ä»¥è¿™ä¸‰ä¸ªå­éƒ¨åˆ†ä¸ºåŸºæœ¬å•ä½ã€‚&lt;/li&gt;
&lt;li&gt;å€Ÿé‰´äº†http2 çš„stream çš„ç†å¿µï¼ˆæ‰€ä»¥Stream interface ä¸Šæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯&lt;code&gt;ID()&lt;/code&gt;ï¼‰ï¼ŒStream å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå­Connectionï¼ŒStream ä¹‹é—´å¯ä»¥å¹¶è¡Œè¯·æ±‚å’Œå“åº”ï¼Œé€šè¿‡StreamIdå…³è”ï¼Œç”¨æ¥å®ç°åœ¨ä¸€ä¸ªConnection ä¹‹ä¸Šçš„â€œå¤šè·¯å¤ç”¨â€ã€‚PSï¼šä¸ºäº†è¿æ¥æ•°é‡ä¸è¯·æ±‚æ•°é‡è§£è€¦ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä»£ç çš„ç»„ç»‡ï¼ˆ&lt;code&gt;pkg/stream&lt;/code&gt;ï¼Œ&lt;code&gt;pkg/protocol&lt;/code&gt;ï¼Œ&lt;code&gt;pkg/proxy&lt;/code&gt;ï¼‰  è·Ÿä¸Šè¿°æ¶æ„æ˜¯ä¸€è‡´çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn_layer.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;pkg/types/connection.go&lt;/code&gt; Connection.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;pkg/types/stream.go&lt;/code&gt; StreamConnection is a connection runs multiple streams.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;pkg/types/stream.go&lt;/code&gt; Stream is a generic protocol stream&lt;/li&gt;
&lt;li&gt;ä¸€å †listener å’Œfilter æ¯”è¾ƒå¥½ç†è§£ï¼šMethod in listener will be called on event occur, but not effect the control flow.Filters are called on event occurs, it also returns a status to effect control flow. Currently 2 states are used: Continue to let it go, Stop to stop the control flow.&lt;/li&gt;
&lt;li&gt;protocol å’Œ stream ä¸¤ä¸ªlayer å› å’Œåè®®æœ‰å…³ï¼Œä¸åŒåè®®ä¹‹é—´å®ç°å·®å¼‚å¾ˆå¤§ï¼Œå±‚æ¬¡ä¸æ˜¯å¾ˆæ¸…æ™°ã€‚&lt;/li&gt;
&lt;li&gt;è·¨å±‚æ¬¡è°ƒç”¨/æ•°æ®ä¼ è¾“é€šè¿‡è·¨å±‚æ¬¡struct çš„â€œç»„åˆâ€æ¥å®ç°ã€‚ä¹Ÿæœ‰ä¸€äº›ç‰¹åˆ«çš„ï¼Œæ¯”å¦‚http net/io å’Œ stream åˆ†åˆ«å¯åŠ¨goroutine read/write loopï¼Œé€šè¿‡å…±äº«æ•°æ®æ¥å˜ç›¸çš„å®ç°è·¨å±‚è°ƒç”¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;a href=&#34;https://mosn.iodocs/concept/core-concept/&#34;&gt;MOSNçš„æ ¸å¿ƒæ¦‚å¿µè§£æ&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn_io_process.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MOSN åœ¨ IO å±‚è¯»å–æ•°æ®ï¼Œé€šè¿‡ read filter å°†æ•°æ®å‘é€åˆ° Protocol å±‚è¿›è¡Œ Decodeã€‚&lt;/li&gt;
&lt;li&gt;Decode å‡ºæ¥çš„æ•°æ®ï¼Œæ ¹æ®ä¸åŒçš„åè®®ï¼Œ&lt;strong&gt;å›è°ƒåˆ° stream å±‚&lt;/strong&gt;ï¼Œè¿›è¡Œ stream çš„åˆ›å»ºå’Œå°è£…ã€‚&lt;/li&gt;
&lt;li&gt;stream åˆ›å»ºå®Œæ¯•åï¼Œä¼šå›è°ƒåˆ° Proxy å±‚åšè·¯ç”±å’Œè½¬å‘ï¼ŒProxy å±‚ä¼šå…³è”ä¸Šä¸‹æ¸¸ï¼ˆupstream,downstreamï¼‰é—´çš„è½¬å‘å…³ç³»ã€‚&lt;/li&gt;
&lt;li&gt;Proxy æŒ‘é€‰åˆ°åç«¯åï¼Œä¼šæ ¹æ®åç«¯ä½¿ç”¨çš„åè®®ï¼Œå°†æ•°æ®å‘é€åˆ°å¯¹åº”åè®®çš„ Protocol å±‚ï¼Œå¯¹æ•°æ®é‡æ–°åš Encodeã€‚&lt;/li&gt;
&lt;li&gt;Encode åçš„æ•°æ®ä¼šç»è¿‡ write filter å¹¶æœ€ç»ˆä½¿ç”¨ IO çš„ write å‘é€å‡ºå»ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä¸€ä¸ªè¯·æ±‚å¯èƒ½ä¼šè§¦å‘å¤šæ¬¡è¯»å–æ“ä½œï¼Œå› æ­¤å•ä¸ªè¯·æ±‚å¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨æ’ä»¶çš„onData å‡½æ•°ã€‚&lt;/p&gt;
&lt;h2 id=&#34;è¿æ¥ç®¡ç†&#34;&gt;è¿æ¥ç®¡ç†&lt;/h2&gt;
&lt;p&gt;è¯¥å›¾ä¸»è¦è¯´çš„è¿æ¥ç®¡ç†éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn_object.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸åŒé¢œè‰²è¡¨ç¤ºæ‰€å¤„çš„ package ä¸åŒã€‚&lt;/li&gt;
&lt;li&gt;å› ä¸ºMOSNä¸»è¦æ˜¯çš„ç”¨é€”æ˜¯â€œä»£ç†â€ï¼Œ æ‰€ä»¥ç¬”è€…ä¸€å¼€å§‹ä¸€ç›´åœ¨æ‰¾ä»£ç†å¦‚ä½•å®ç°ï¼Œä½†å…¶å®å‘¢ï¼ŒMOSN é¦–å…ˆæ˜¯ä¸€ä¸ªtcp serverï¼Œåƒtomcatä¸€æ ·ï¼ŒMOSN ä¸»è¦åˆ†ä¸ºè¿æ¥ç®¡ç†å’Œä¸šåŠ¡å¤„ç†ä¸¤ä¸ªéƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡å¤„ç†çš„å…¥å£å°±æ˜¯filterManagerï¼Œ ä¸»è¦ç”±&lt;code&gt;filterManager.onRead&lt;/code&gt; å’Œ &lt;code&gt;filterManager.onWrite&lt;/code&gt; æ¥å®ç°ã€‚filterManager èšåˆReadFilter é“¾å’ŒWriterFilteré“¾ï¼Œæ„æˆå¯¹æ•°æ®çš„å¤„ç†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;mosn_start.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Envoy å¯¹åº”é€»è¾‘ &lt;a href=&#34;https://sq.163yun.com/blog/article/213361303062011904&#34;&gt;æ·±å…¥è§£è¯»Service Meshçš„æ•°æ®é¢Envoy&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;envoy_new_connection.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ•°æ®å¤„ç†&#34;&gt;æ•°æ®å¤„ç†&lt;/h2&gt;
&lt;p&gt;ä¸€äº›ç»†èŠ‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://skyao.io/post/201809-xprotocol-common-address-solution/&#34;&gt;SOFAMeshä¸­çš„å¤šåè®®é€šç”¨è§£å†³æ–¹æ¡ˆx-protocolä»‹ç»ç³»åˆ—(1)-DNSé€šç”¨å¯»å€æ–¹æ¡ˆ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;iptablesåœ¨åŠ«æŒæµé‡æ—¶ï¼Œé™¤äº†å°†è¯·æ±‚è½¬å‘åˆ°localhostçš„Sidecarå¤„å¤–ï¼Œè¿˜é¢å¤–çš„åœ¨è¯·æ±‚æŠ¥æ–‡çš„TCP options ä¸­å°† ClusterIP ä¿å­˜ä¸º original destã€‚åœ¨ Sidecar ï¼ˆIstioé»˜è®¤æ˜¯Envoyï¼‰ä¸­ï¼Œä»è¯·æ±‚æŠ¥æ–‡ TCP options çš„ original dest å¤„è·å– ClusterIPã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://skyao.io/post/201809-xprotocol-rapid-decode-forward/&#34;&gt;SOFAMeshä¸­çš„å¤šåè®®é€šç”¨è§£å†³æ–¹æ¡ˆx-protocolä»‹ç»ç³»åˆ—(2)-å¿«é€Ÿè§£ç è½¬å‘&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è½¬å‘è¯·æ±‚æ—¶ï¼Œç”±äºæ¶‰åŠåˆ°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯·æ±‚å‘é€ç»™å¤šä¸ªæœåŠ¡å™¨ç«¯å®ä¾‹ã€‚å› æ­¤ï¼Œæœ‰ä¸€ä¸ªéå¸¸æ˜ç¡®çš„è¦æ±‚ï¼šå°±æ˜¯å¿…é¡»ä»¥å•ä¸ªè¯·æ±‚ä¸ºå•ä½è¿›è¡Œè½¬å‘ã€‚å³å•ä¸ªè¯·æ±‚å¿…é¡»å®Œæ•´çš„è½¬å‘ç»™æŸå°æœåŠ¡å™¨ç«¯å®ä¾‹ï¼Œè´Ÿè½½å‡è¡¡éœ€è¦ä»¥è¯·æ±‚ä¸ºå•ä½ï¼Œä¸èƒ½å°†ä¸€ä¸ªè¯·æ±‚çš„å¤šä¸ªæŠ¥æ–‡åŒ…åˆ†åˆ«è½¬å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨ç«¯å®ä¾‹ã€‚æ‰€ä»¥ï¼Œæ‹†åŒ…æ˜¯è¯·æ±‚è½¬å‘çš„å¿…å¤‡åŸºç¡€ã€‚&lt;/li&gt;
&lt;li&gt;å¤šè·¯å¤ç”¨çš„å…³é”®å‚æ•°ï¼šRequestIdã€‚RequestIdç”¨æ¥å…³è”requestå’Œå¯¹åº”çš„responseï¼Œè¯·æ±‚æŠ¥æ–‡ä¸­æºå¸¦ä¸€ä¸ªå”¯ä¸€çš„idå€¼ï¼Œåº”ç­”æŠ¥æ–‡ä¸­åŸå€¼è¿”å›ï¼Œä»¥ä¾¿åœ¨å¤„ç†responseæ—¶å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„requestã€‚å½“ç„¶åœ¨ä¸åŒåè®®ä¸­ï¼Œè¿™ä¸ªå‚æ•°çš„åå­—å¯èƒ½ä¸åŒï¼ˆå¦‚streamidç­‰ï¼‰ã€‚ä¸¥æ ¼è¯´ï¼ŒRequestIdå¯¹äºè¯·æ±‚è½¬å‘æ˜¯å¯é€‰çš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šé€šè®¯åè®®ä¸æä¾›æ”¯æŒï¼Œæ¯”å¦‚ç»å…¸çš„HTTP1.1å°±æ²¡æœ‰æ”¯æŒã€‚ä½†æ˜¯å¦‚æœæœ‰è¿™ä¸ªå‚æ•°ï¼Œåˆ™å¯ä»¥å®ç°å¤šè·¯å¤ç”¨ï¼Œä»è€Œå¯ä»¥å¤§å¹…åº¦æé«˜TCPè¿æ¥çš„ä½¿ç”¨æ•ˆç‡ï¼Œé¿å…å‡ºç°å¤§é‡è¿æ¥ã€‚ç¨å¾®æ–°ä¸€ç‚¹çš„é€šè®¯åè®®ï¼ŒåŸºæœ¬éƒ½ä¼šåŸç”Ÿæ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼Œæ¯”å¦‚SOFARPCï¼ŒDubboï¼ŒHSFï¼Œè¿˜æœ‰HTTP/2å°±ç›´æ¥å…§å»ºäº†å¤šè·¯å¤ç”¨çš„æ”¯æŒã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥æ€»ç»“åˆ°ï¼Œå¯¹äºSidecarï¼Œè¦æ­£ç¡®è½¬å‘è¯·æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¿…é¡»è·å–åˆ°destinationä¿¡æ¯ï¼Œå¾—åˆ°è½¬å‘çš„ç›®çš„åœ°ï¼Œæ‰èƒ½è¿›è¡ŒæœåŠ¡å‘ç°ç±»çš„å¯»å€ã€‚&lt;/li&gt;
&lt;li&gt;å¿…é¡»è¦èƒ½å¤Ÿæ­£ç¡®çš„æ‹†åŒ…ï¼Œç„¶åä»¥è¯·æ±‚ä¸ºå•ä½è¿›è¡Œè½¬å‘ï¼Œè¿™æ˜¯è´Ÿè½½å‡è¡¡çš„åŸºç¡€ã€‚&lt;/li&gt;
&lt;li&gt;å¯é€‰çš„RequestIdï¼Œè¿™æ˜¯å¼€å¯å¤šè·¯å¤ç”¨çš„åŸºç¡€ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;a href=&#34;https://sq.163yun.com/blog/article/213361303062011904&#34;&gt;æ·±å…¥è§£è¯»Service Meshçš„æ•°æ®é¢Envoy&lt;/a&gt;ä¸‹æ–‡ä»¥Envoy å®ç°åšä¸€ä¸‹ç±»æ¯”ç”¨æ¥è¾…åŠ©ç†è§£MOSN ç›¸å…³ä»£ç çš„ç†å¿µï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;envoy_on_data.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºæ¯ä¸€ä¸ªFilterï¼Œéƒ½è°ƒç”¨onDataå‡½æ•°ï¼Œå’±ä»¬ä¸Šé¢è§£æè¿‡ï¼Œå…¶ä¸­HTTPå¯¹åº”çš„ReadFilteræ˜¯ConnectionManagerImplï¼Œå› è€Œè°ƒç”¨&lt;code&gt;ConnectionManagerImpl::onData&lt;/code&gt;å‡½æ•°ã€‚ConnectionManager æ˜¯åè®®æ’ä»¶çš„å¤„ç†å…¥å£ï¼Œ&lt;strong&gt;åŒæ—¶ä¹Ÿè´Ÿè´£å¯¹æ•´ä¸ªå¤„ç†è¿‡ç¨‹çš„æµç¨‹ç¼–æ’&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;envoy_data_parse.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®ä¸Šä¼ &#34;&gt;æ•°æ®â€œä¸Šä¼ â€&lt;/h3&gt;
&lt;p&gt;ä¸€æ¬¡http1åè®®è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn_http_read.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç»¿è‰²éƒ¨åˆ†è¡¨ç¤ºå¦èµ·ä¸€ä¸ªåç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è½¬å‘æµç¨‹&#34;&gt;è½¬å‘æµç¨‹&lt;/h3&gt;
&lt;p&gt;Downstream stream, as a controller to handle downstream and upstream proxy flow &lt;code&gt;downStream.OnReceive&lt;/code&gt; é€»è¾‘ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OnReceive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;IoBuffer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;pool&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ScheduleAuto&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;cleanNotify&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MatchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] redo match route %+v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Retry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] retry %+v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Proxy&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Debugf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[proxy] [downstream] directResponse %+v&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;downStream.receive&lt;/code&gt; ä¼šæ ¹æ®å½“å‰æ‰€å¤„çš„phase è¿›è¡Œå¯¹åº”çš„å¤„ç†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downStream&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receive&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Context&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;id&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;uint32&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;switch&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// init phase
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;InitPhase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter before route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// match route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;MatchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;matchRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream filter after route
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownFilterAfterRoute&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runReceiveFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive header
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamReqTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream receive trailer
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DownRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// downstream oneway
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Oneway&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Retry&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;WaitNofity&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream filter
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpFilter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;runAppendFilters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// maybe direct response
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive header
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvHeader&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// send downstream response
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveHeaders&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespDataBuf&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive data
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveData&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;downstreamRespTrailers&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// upstream receive triler
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;UpRecvTrailer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;//check not null
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;            &lt;span style=&#34;color:#000&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;upstreamRequest&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveTrailers&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;phase&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;++&lt;/span&gt;
        &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;// process end
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;types&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;End&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;pkg/types/proxy.go&lt;/code&gt; æœ‰phase çš„å®šä¹‰ã€‚&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;phase&lt;/th&gt;
&lt;th&gt;å¯¹åº”æ–¹æ³•&lt;/th&gt;
&lt;th&gt;æ‰§è¡Œé€»è¾‘ï¼ˆéƒ¨åˆ†ï¼‰&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;InitPhase&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DownFilter&lt;/td&gt;
&lt;td&gt;runReceiveFilters&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;MatchRoute&lt;/td&gt;
&lt;td&gt;matchRoute&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DownFilterAfterRoute&lt;/td&gt;
&lt;td&gt;runReceiveFilters&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DownRecvHeader&lt;/td&gt;
&lt;td&gt;receiveHeaders&lt;/td&gt;
&lt;td&gt;==&amp;gt; upstreamRequest.appendHeaders&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DownRecvData&lt;/td&gt;
&lt;td&gt;receiveData&lt;/td&gt;
&lt;td&gt;==&amp;gt; upstreamRequest.appendData&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DownRecvTrailer&lt;/td&gt;
&lt;td&gt;receiveTrailers&lt;/td&gt;
&lt;td&gt;==&amp;gt; upstreamRequest.appendTrailers()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Oneway/Retry/WaitNofity&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;UpFilter&lt;/td&gt;
&lt;td&gt;runAppendFilters&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;UpRecvHeader&lt;/td&gt;
&lt;td&gt;upstreamRequest.receiveHeaders&lt;/td&gt;
&lt;td&gt;==&amp;gt; downStream.onUpstreamData&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;UpRecvData&lt;/td&gt;
&lt;td&gt;upstreamRequest.receiveData&lt;/td&gt;
&lt;td&gt;==&amp;gt; downStream.onUpstreamData&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;UpRecvTrailer&lt;/td&gt;
&lt;td&gt;upstreamRequest.receiveTrailers&lt;/td&gt;
&lt;td&gt;==&amp;gt; downStream.onUpstreamTrailers&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;End&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ä¸Šè¿°æµç¨‹æ‰åƒæ˜¯ä¸€ä¸ª proxy å±‚çš„æ´»å„¿ï¼Œè¯·æ±‚è½¬å‘åˆ° upstreamï¼Œä»upstream æ‹¿åˆ°å“åº”ï¼Œ å†è½¬å›ç»™downStreamã€‚&lt;/p&gt;
&lt;h2 id=&#34;ä¸control-plan-çš„äº¤äº’&#34;&gt;ä¸control plan çš„äº¤äº’&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;pkg/xds/v2/adssubscriber.go&lt;/code&gt; å¯åŠ¨å‘é€çº¿ç¨‹å’Œæ¥æ”¶çº¿ç¨‹&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;Start&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetStreamClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;sendThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;utils&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GoWithRecover&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;receiveThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;},&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å®šæ—¶å‘é€è¯·æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sendThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;refreshDelay&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;AdsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RefreshDelay&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;t1&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;NewTimer&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;refreshDelay&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;t1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;C&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reqClusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;nil&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DefaultLogger&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Infof&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;[xds] [ads client] send thread request cds fail!auto retry next period&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
                &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;reconnect&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;t1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Reset&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;refreshDelay&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¥æ”¶å“åº”ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;receiveThread&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;select&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;default&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClientMutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RLock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClient&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;StreamClientMutex&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;RUnlock&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;sc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Recv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;typeURL&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TypeUrl&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;HandleTypeURL&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;typeURL&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;adsClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¤„ç†é€»è¾‘æ˜¯äº‹å…ˆæ³¨å†Œå¥½çš„å‡½æ•°ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleTypeURL&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;url&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DiscoveryResponse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;typeURLHandleFuncs&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;url&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;];&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ok&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;init&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyListener&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyClusterLoadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyClusterLoadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;RegisterTypeURLHandleFunc&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;EnvoyRouteConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyRouteConfiguration&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»¥cluster ä¿¡æ¯ä¸ºä¾‹ HandleEnvoyClusterã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;HandleEnvoyCluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ADSClient&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;DiscoveryResponse&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;clusters&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;client&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;handleClustersResp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;resp&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;conv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ConvertUpdateClusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusters&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#000&#34;&gt;clusterNames&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;make&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;([]&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;string&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clusters&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetType&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Cluster_EDS&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;clusterNames&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterNames&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;cluster&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¼šè§¦å‘ClusterManager æ›´æ–°clusterã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConvertUpdateEndpoints&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;loadAssignments&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;[]&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;envoy_api_v2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterLoadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;error&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;loadAssignment&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;loadAssignments&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#000&#34;&gt;clusterName&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;loadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;ClusterName&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;_&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;endpoints&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;range&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;loadAssignment&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;Endpoints&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;hosts&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ConvertEndpointsConfig&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;endpoints&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;clusterMngAdapter&lt;/span&gt; &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;clusterAdapter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetClusterMngAdapterInstance&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;()&lt;/span&gt;
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#000&#34;&gt;clusterAdapter&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;GetClusterMngAdapterInstance&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;TriggerClusterHostUpdate&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;clusterName&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;hosts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;);&lt;/span&gt; 
            &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;...&lt;/span&gt;
            
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;errGlobal&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;å­¦åˆ°çš„&#34;&gt;å­¦åˆ°çš„&lt;/h2&gt;
&lt;p&gt;ä¸è¦ç¡¬çœ‹ä»£ç ï¼Œå°¤å…¶å¯¹äºå¤šåç¨‹ç¨‹åºã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ‰“å°æ—¥å¿—ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;debug.printStack&lt;/code&gt; æ¥æŸ¥çœ‹æŸä¸€ä¸ªæ–¹æ³•ä¹‹å‰çš„è°ƒç”¨æ ˆã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;fmt.Printf(&amp;quot;==&amp;gt; %T\n&amp;quot;,xx)&lt;/code&gt;  å¦‚æœä¸€ä¸ªinterface æœ‰å¤šä¸ªâ€œå®ç°ç±»â€ å¯ä»¥é€šè¿‡&lt;code&gt;%T&lt;/code&gt; æŸ¥çœ‹struct çš„ç±»å‹ã€‚&lt;/li&gt;
&lt;/ol&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN ç¤¾åŒºæˆç«‹</title>
      <link>https://mosn.io/blog/news/announcing-mosn-communtiy/</link>
      <pubDate>Sat, 28 Dec 2019 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/news/announcing-mosn-communtiy/</guid>
      <description>
        
        
        &lt;p&gt;&lt;img src=&#34;meetup-hangzhou-mosn.png&#34; alt=&#34;MOSNç¤¾åŒºæˆç«‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;2019 å¹´ 12 æœˆ 28 æ—¥ï¼Œæ­å·ï¼Œåœ¨ç¬¬ 9 å±Š Service Mesh Meetup ä¸Šï¼ŒMOSN å¼€æºè´Ÿè´£äººè‚–æ¶µï¼ˆæ¶µç•…ï¼‰å®£å¸ƒï¼ŒMOSN ä» SOFAStack ç¤¾åŒºä¸­è¿ç§»å‡ºæ¥ï¼Œæˆç«‹ç‹¬ç«‹çš„ Github ç»„ç»‡ &lt;a href=&#34;https://github.com/mosn&#34;&gt;https://github.com/mosn&lt;/a&gt;ï¼Œå¹¶ä½œä¸ºç‹¬ç«‹é¡¹ç›®è¿è¥ï¼Œå¹¶å¼€å¯ MOSN å¼€æºç¤¾åŒºã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;mosn-roadmap.png&#34; alt=&#34;MOSN roadmap&#34;&gt;&lt;/p&gt;
&lt;p&gt;åŒæ—¶å…¬å¸ƒäº† MOSN çš„ Roadmapï¼Œå¼€å¯æ–°çš„åŸŸå &lt;a href=&#34;https://mosn.io&#34;&gt;mosn.io&lt;/a&gt;ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: Nginx vs Envoy vs MOSN å¹³æ»‘å‡çº§åŸç†è§£æ</title>
      <link>https://mosn.io/blog/posts/nginx-envoy-mosn-hot-upgrade/</link>
      <pubDate>Sat, 28 Dec 2019 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/posts/nginx-envoy-mosn-hot-upgrade/</guid>
      <description>
        
        
        &lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡æ˜¯å¯¹ Nginxã€Envoy åŠ MOSN çš„å¹³æ»‘å‡çº§åŸç†åŒºåˆ«çš„åˆ†æï¼Œé€‚åˆå¯¹ Nginx å®ç°åŸç†æ¯”è¾ƒæ„Ÿå…´è¶£çš„åŒå­¦é˜…è¯»ï¼Œéœ€è¦å…·å¤‡ä¸€å®šçš„ç½‘ç»œç¼–ç¨‹çŸ¥è¯†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¹³æ»‘å‡çº§çš„æœ¬è´¨å°±æ˜¯ listener fd çš„è¿ç§»&lt;/strong&gt;ï¼Œè™½ç„¶ Nginxã€Envoyã€MOSN éƒ½æä¾›äº†å¹³æ»‘å‡çº§æ”¯æŒï¼Œä½†æ˜¯é‰´äºå®ƒä»¬è¿›ç¨‹æ¨¡å‹çš„å·®å¼‚ï¼Œåæ˜ åœ¨å®ç°ä¸Šè¿˜æ˜¯æœ‰äº›åŒºåˆ«çš„ã€‚è¿™é‡Œæ¥æ¢è®¨ä¸‹å®ƒä»¬å…¶ä¸­çš„åŒºåˆ«ï¼Œå¹¶ç€é‡ä»‹ç» Nginx çš„å®ç°ã€‚&lt;/p&gt;
&lt;h2 id=&#34;nginx&#34;&gt;Nginx&lt;/h2&gt;
&lt;p&gt;ç›¸ä¿¡æœ‰å¾ˆå¤šäººè®¤ä¸º Nginx çš„ reload æ“ä½œå°±èƒ½å®Œæˆå¹³æ»‘å‡çº§ï¼Œå…¶å®è¿™æ˜¯ä¸ªå…¸å‹çš„ç†è§£é”™è¯¯ã€‚å®é™…ä¸Š reload æ“ä½œä»…ä»…æ˜¯å¹³æ»‘é‡å¯ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„å‡çº§æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶è¿è¡Œçš„ä¾ç„¶æ˜¯è€çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;Nginx è‡ªèº«ä¹Ÿå¹¶æ²¡æœ‰æä¾›å¹³æ»‘å‡çº§çš„å‘½ä»¤é€‰é¡¹ï¼Œå…¶åªèƒ½é æ‰‹åŠ¨è§¦å‘ä¿¡å·æ¥å®Œæˆã€‚å…·ä½“æ­£ç¡®çš„æ“ä½œæ­¥éª¤å¯ä»¥å‚è€ƒè¿™é‡Œï¼š&lt;a href=&#34;http://nginx.org/en/docs/control.html#upgrade&#34;&gt;Upgrading Executable on the Fly&lt;/a&gt;ï¼Œè¿™é‡Œåªåˆ†æä¸‹å…¶å®ç°åŸç†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nginx çš„å¹³æ»‘å‡çº§æ˜¯é€šè¿‡ &lt;code&gt;fork&lt;/code&gt; + &lt;code&gt;execve&lt;/code&gt; è¿™ç§ç»å…¸çš„å¤„ç†æ–¹å¼æ¥å®ç°çš„&lt;/strong&gt;ã€‚å‡†å¤‡å‡çº§æ—¶ï¼ŒOld Master è¿›ç¨‹æ”¶åˆ°ä¿¡å·ç„¶å &lt;code&gt;fork&lt;/code&gt; å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ³¨æ„æ­¤æ—¶è¿™ä¸ªå­è¿›ç¨‹è¿è¡Œçš„ä¾ç„¶æ˜¯è€çš„é•œåƒæ–‡ä»¶ã€‚ç´§æ¥ç€è¿™ä¸ªå­è¿›ç¨‹ä¼šé€šè¿‡ &lt;code&gt;execve&lt;/code&gt; è°ƒç”¨æ‰§è¡Œæ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶æ¥æ›¿æ¢æ‰è‡ªå·±ï¼Œæˆä¸º New Masterã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šNew Master å¯åŠ¨æ—¶æŒ‰ç†è¯´ä¼šæ‰§è¡Œ &lt;code&gt;bind&lt;/code&gt; + &lt;code&gt;listen&lt;/code&gt; ç­‰æ“ä½œæ¥åˆå§‹åŒ–ç›‘å¬ï¼Œè€Œè¿™æ—¶å€™ Old Master è¿˜æ²¡æœ‰é€€å‡ºï¼Œç«¯å£æœªé‡Šæ”¾ï¼Œæ‰§è¡Œ &lt;code&gt;execve&lt;/code&gt; æ—¶ç†è®ºä¸Šåº”è¯¥ä¼šæŠ¥ï¼š&lt;code&gt;Address already in use&lt;/code&gt; é”™è¯¯ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™é‡Œå´æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;å› ä¸º Nginx åœ¨ &lt;code&gt;execve&lt;/code&gt; çš„æ—¶å€™å‹æ ¹å°±æ²¡æœ‰é‡æ–° &lt;code&gt;bind&lt;/code&gt; + &lt;code&gt;listen&lt;/code&gt;ï¼Œè€Œæ˜¯ç›´æ¥æŠŠ listener fd æ·»åŠ åˆ° &lt;code&gt;epoll&lt;/code&gt; çš„äº‹ä»¶è¡¨ã€‚å› ä¸ºè¿™ä¸ª New Master æœ¬æ¥å°±æ˜¯ä» Old Master ç»§æ‰¿è€Œæ¥ï¼Œè‡ªç„¶å°±ç»§æ‰¿äº† Old Master çš„ listener fdï¼Œä½†æ˜¯è¿™é‡Œä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼šè¯¥æ€ä¹ˆé€šçŸ¥ New Master å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç¯å¢ƒå˜é‡&lt;/strong&gt;ã€‚&lt;code&gt;execve&lt;/code&gt; åœ¨æ‰§è¡Œçš„æ—¶å€™å¯ä»¥ä¼ å…¥ç¯å¢ƒå˜é‡ã€‚å®é™…ä¸Š Old Master åœ¨ &lt;code&gt;fork&lt;/code&gt; ä¹‹å‰ä¼šå°†æ‰€æœ‰ listener fd æ·»åŠ åˆ° &lt;code&gt;NGINX&lt;/code&gt; ç¯å¢ƒå˜é‡ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-nginx&#34; data-lang=&#34;nginx&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ngx_pid_t&lt;/span&gt;
&lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_exec_new_binary(ngx_cycle_t&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*cycle,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;char&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*const&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*argv)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;ctx.path&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;argv[0]&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ctx.name&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;new&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;binary&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;process&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ctx.argv&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;argv&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;env&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_set_environment(cycle,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;amp;n)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;env[n++]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;var&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;env[n]&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NULL&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;ctx.envp&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(char&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*const&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*)&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;env&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ccf&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ngx_core_conf_t&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*)&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_get_conf(cycle-&amp;gt;conf_ctx,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_core_module)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ngx_rename_file(ccf-&amp;gt;pid.data,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ccf-&amp;gt;oldpid.data)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_FILE_ERROR)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
       &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#4e9a06&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_INVALID_PID&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;pid&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_execute(cycle,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;amp;ctx)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;pid&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Nginx åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè§£æ &lt;code&gt;NGINX&lt;/code&gt; ç¯å¢ƒå˜é‡ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-nginx&#34; data-lang=&#34;nginx&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_int_t&lt;/span&gt;
&lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_add_inherited_sockets(ngx_cycle_t&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*cycle)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;inherited&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(u_char&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*)&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;getenv(NGINX_VAR)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(inherited&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NULL)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_OK&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ngx_array_init(&amp;amp;cycle-&amp;gt;listening,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;cycle-&amp;gt;pool,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;,&lt;/span&gt;
                       &lt;span style=&#34;color:#4e9a06&#34;&gt;sizeof(ngx_listening_t))&lt;/span&gt;
        &lt;span style=&#34;color:#4e9a06&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_OK)&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_ERROR&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(p&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;inherited,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;*p&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;p++)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(*p&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*p&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;&amp;#39;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;s&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_atoi(v,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;v)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#4e9a06&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ls&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_array_push(&amp;amp;cycle-&amp;gt;listening)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ls&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NULL)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_ERROR&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ngx_memzero(ls,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;sizeof(ngx_listening_t))&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ls-&amp;gt;fd&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ngx_socket_t)&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;s&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_inherited&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_set_inherited_sockets(cycle)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸€æ—¦æ£€æµ‹åˆ°æ˜¯ç»§æ‰¿è€Œæ¥çš„ socketï¼Œé‚£å°±è¯´æ˜å·²ç»æ‰“å¼€äº†ï¼Œä¸ä¼šå†ç»§ç»­ &lt;code&gt;bind&lt;/code&gt; + &lt;code&gt;listen&lt;/code&gt; äº†ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-nginx&#34; data-lang=&#34;nginx&#34;&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ngx_int_t&lt;/span&gt;
&lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_open_listening_sockets(ngx_cycle_t&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*cycle)&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color:#4e9a06&#34;&gt;/*&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;TODO:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;configurable&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;number&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*/&lt;/span&gt;

    &lt;span style=&#34;color:#4e9a06&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(tries&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;5&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;tries&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;tries--)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;failed&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;

        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;/*&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;each&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;listening&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;socket&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*/&lt;/span&gt;

        &lt;span style=&#34;color:#4e9a06&#34;&gt;ls&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;cycle-&amp;gt;listening.elts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(i&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;cycle-&amp;gt;listening.nelts&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;i++)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#4e9a06&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(ls[i].inherited)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;

                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;/*&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;TODO:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;close&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;on&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;exit&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*/&lt;/span&gt;
                &lt;span style=&#34;color:#4e9a06&#34;&gt;/*&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;TODO:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;nonblocking&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*/&lt;/span&gt;
                &lt;span style=&#34;color:#4e9a06&#34;&gt;/*&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;TODO:&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;deferred&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;accept&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;*/&lt;/span&gt;

                &lt;span style=&#34;color:#4e9a06&#34;&gt;continue&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;

            &lt;span style=&#34;color:#4e9a06&#34;&gt;ngx_log_debug2(NGX_LOG_DEBUG_CORE,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;log,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;,&lt;/span&gt;
                           &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;bind()&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;%V&lt;/span&gt; &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;#%d &amp;#34;, &amp;amp;ls[i].addr_text, s);
&lt;/span&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;&lt;/span&gt;
            &lt;span style=&#34;color:#4e9a06&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(bind(s,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ls[i].sockaddr,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;ls[i].socklen)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;-1)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
                &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;...&lt;/span&gt;
            &lt;span style=&#34;color:#a40000&#34;&gt;}&lt;/span&gt;
            &lt;span style=&#34;color:#4e9a06&#34;&gt;...&lt;/span&gt;
        &lt;span style=&#34;color:#a40000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color:#a40000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#4e9a06&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;(failed)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;ngx_log_error(NGX_LOG_EMERG,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;log,&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;still&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;could&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;bind()&amp;#34;)&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_ERROR&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;NGX_OK&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;envoy&#34;&gt;Envoy&lt;/h2&gt;
&lt;p&gt;Envoy ä½¿ç”¨çš„æ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå…¶å±€é™å°±æ˜¯æ— æ³•é€šè¿‡ç¯å¢ƒå˜é‡æ¥ä¼ é€’ listener fdã€‚å› æ­¤ Envoy é‡‡ç”¨çš„æ˜¯ UDSï¼ˆunix domain socketsï¼‰æ–¹æ¡ˆã€‚å½“ New Envoy å¯åŠ¨å®Œæˆåï¼Œä¼šé€šè¿‡ UDS å‘ Old Envoy è¯·æ±‚ listener fd å‰¯æœ¬ï¼Œæ‹¿åˆ° listener fd ä¹‹åå¼€å§‹æ¥ç®¡æ–°æ¥çš„è¿æ¥ï¼Œå¹¶é€šçŸ¥ Old Envoy ç»ˆæ­¢è¿è¡Œã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;file descriptor æ˜¯å¯ä»¥é€šè¿‡ &lt;code&gt;sendmsg/recvmsg&lt;/code&gt; æ¥ä¼ é€’çš„ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;mosn&#34;&gt;MOSN&lt;/h2&gt;
&lt;p&gt;MOSN çš„æ–¹æ¡ˆå’Œ Envoy ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ UDS æ¥ä¼ é€’ listener fdã€‚ä½†æ˜¯å…¶æ¯” Envoy æ›´å‰å®³çš„åœ°æ–¹åœ¨äºå®ƒå¯ä»¥æŠŠè€çš„è¿æ¥ä» Old MOSN ä¸Šè¿ç§»åˆ° New MOSN ä¸Šã€‚&lt;strong&gt;ä¹Ÿå°±æ˜¯è¯´æŠŠä¸€ä¸ªè¿æ¥ä»è¿›ç¨‹ A è¿ç§»åˆ°è¿›ç¨‹ Bï¼Œè€Œä¿æŒè¿æ¥ä¸æ–­&lt;/strong&gt;ï¼ï¼ï¼å‰ä¸å‰å®³ï¼Ÿå¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯å®ç°èµ·æ¥å´æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œæ¯”å¦‚æ•°æ®å·²ç»è¢«æ‹·è´åˆ°äº†åº”ç”¨å±‚ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¤„ç†ï¼Œæ€ä¹ˆåŠï¼Ÿè¿™é‡Œé¢æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦å¤„ç†ã€‚å®ƒå­æ‰€ä»¥èƒ½åšåˆ°è¿™ç§å±‚é¢ï¼Œé çš„ä¹Ÿæ˜¯å†…æ ¸çš„ &lt;code&gt;sendmsg/recvmsg&lt;/code&gt; æŠ€æœ¯ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;SCM_RIGHTS - Send or receive a set of open file descriptors from another process. The data portion contains an integer array of the file descriptors. The passed file descriptors behave as though they have been created with dup(2). &lt;a href=&#34;http://linux.die.net/man/7/unix&#34;&gt;http://linux.die.net/man/7/unix&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ª Go å®ç°çš„å° Demo: &lt;a href=&#34;https://zhuanlan.zhihu.com/p/97340154&#34;&gt;tcpé“¾æ¥è¿ç§»&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¯¹æ¯”&#34;&gt;å¯¹æ¯”&lt;/h2&gt;
&lt;p&gt;Nginx çš„å®ç°æ˜¯å…¼å®¹æ€§æœ€å¼ºçš„ï¼Œå› ä¸º Envoy å’Œ MOSN éƒ½ä¾èµ– &lt;code&gt;sendmsg/recvmsg&lt;/code&gt; ç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦å†…æ ¸ 3.5+ æ”¯æŒã€‚MOSN çš„éš¾åº¦æœ€é«˜ï¼Œç®—å¾—ä¸Šæ˜¯çœŸæ­£çš„æ— æŸå‡çº§ï¼Œè€Œ Nginx å’Œ Envoy å¯¹äºè€çš„è¿æ¥ï¼Œä»…ä»…æ˜¯å®ç° graceful shutdownï¼Œä¸¥æ ¼æ¥è¯´æ˜¯æœ‰æŸçš„ã€‚è¿™å¯¹äº HTTP(é€šè¿‡ &lt;code&gt;Connection: close&lt;/code&gt;) å’Œ gRPC(GoAway Frame) åè®®æ”¯æŒå¾ˆå‹å¥½ï¼Œä½†æ˜¯é‡åˆ°è‡ªå®šä¹‰çš„ TCP åè®®å°±æŠ“çäº†ã€‚å¦‚æœé‡åˆ°å®¢æˆ·ç«¯æ²¡æœ‰å¤„ç† &lt;code&gt;close&lt;/code&gt; å¼‚å¸¸ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿ socket fd æ³„éœ²é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä½œè€… ms2008ï¼Œè½¬è½½è‡ª&lt;a href=&#34;https://ms2008.github.io/2019/12/28/hot-upgrade/&#34;&gt;Nginx vs Envoy vs Mosn å¹³æ»‘å‡çº§åŸç†è§£æ&lt;/a&gt;ã€‚&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Blog: MOSN æºç è§£æ -  reconfig æœºåˆ¶</title>
      <link>https://mosn.io/blog/code/mosn-reconfig-mechanism/</link>
      <pubDate>Sun, 24 Nov 2019 00:00:00 +0000</pubDate>
      
      <guid>https://mosn.io/blog/code/mosn-reconfig-mechanism/</guid>
      <description>
        
        
        &lt;p&gt;æœ¬æ–‡è®°å½•äº†å¯¹ MOSN çš„æºç ç ”ç©¶ï¼Œç ”ç©¶ MOSN æ˜¯å¦‚ä½•åšåˆ°å¹³æ»‘é‡å¯çš„ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡çš„å†…å®¹åŸºäº MOSN v0.8.1ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆå°†è¢«é‡å¯çš„ MOSN è¿›ç¨‹ç§°ä¸º &lt;code&gt;æ—§ MOSN&lt;/code&gt;ï¼Œå°†é‡å¯å¹¶æ¥ç®¡æµé‡çš„è¿›ç¨‹æˆä¸º &lt;code&gt;æ–° MOSN&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æœºåˆ¶&#34;&gt;æœºåˆ¶&lt;/h2&gt;
&lt;p&gt;MOSN æ²¡æœ‰ä½¿ç”¨é‡æ–°è¯»å– config æ–‡ä»¶çš„æ–¹æ³•æ¥å®ç° reconfigï¼Œè€Œæ˜¯é€šè¿‡ &lt;code&gt;unix socket&lt;/code&gt; ä½œä¸ºè¿›ç¨‹é—´é€šä¿¡ï¼Œå¹¶å°†æ—§è¿›ç¨‹çš„ç›‘å¬ fd é€šè¿‡ socket ä¼ è¿‡å»ï¼Œæ–° MOSN æ¥ç®¡ fd å¹¶ä¸”é‡æ–°è¯»å– configï¼Œæ—§ MOSN è¿›è¡Œ gracefully shutdownï¼Œä»¥è¾¾åˆ° reconfig å’Œå¹³æ»‘é‡å¯çš„åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ—§-mosn&#34;&gt;æ—§ MOSN&lt;/h2&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆä»ä¸€ä¸ªå¯åŠ¨ç€çš„ MOSN è¿›ç¨‹çœ‹èµ·ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è¢«é‡å¯çš„ã€‚&lt;/p&gt;
&lt;p&gt;MOSN çš„ reconfig é€»è¾‘åœ¨ &lt;code&gt;server&lt;/code&gt; åŒ…çš„ &lt;code&gt;reconfigure.go&lt;/code&gt; å†…ã€‚&lt;/p&gt;
&lt;p&gt;MOSN è¿›ç¨‹å¯åŠ¨åï¼Œä¼šåˆ›å»ºä¸€ä¸ªå« &lt;code&gt;reconfig.sock&lt;/code&gt; çš„ unix socketï¼Œåˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œå¼€å§‹ç›‘å¬å¹¶å¾€é‡Œé¢å†™å…¥ä¸€ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œè¿™æ—¶ä¼šå‡ºç°å†™é˜»å¡ã€‚ä¸€æ—¦æœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä» reconfig.sock è¯»å–åˆ°è¿™ä¸€ä¸ªå­—èŠ‚ï¼Œæ—§ MOSN ä¾¿å¼€å§‹ &lt;code&gt;reconfig é€»è¾‘&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;reconfig-é€»è¾‘&#34;&gt;reconfig é€»è¾‘:&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å½“å†™é˜»å¡ç»“æŸï¼Œåç¨‹ä¼šå°è¯•é“¾æ¥å¦ä¸€ä¸ª unix socket ï¼š&lt;code&gt;listen.sock&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä¸€æ—¦é“¾æ¥ä¸Šï¼Œè´Ÿè´£ reconfig çš„åç¨‹ä¼šå°†å·²ç»å­˜åœ¨çš„ fd ä» &lt;code&gt;listen.sock&lt;/code&gt; å‘é€ï¼Œå‘é€æ˜¯é€šè¿‡ &lt;code&gt;out-of-band&lt;/code&gt; æ•°æ®è¿›è¡Œçš„ã€‚ å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ª &lt;code&gt;listen.sock&lt;/code&gt; æ˜¯æ–°çš„ MOSN è¿›ç¨‹åˆ›å»ºçš„ï¼Œç”¨æ¥æ¥æ”¶æ­£åœ¨æœåŠ¡çš„ fdï¼Œæ¥ç®¡å¹¶ç”¨ä»¥ç»§ç»­æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œçš„ &lt;code&gt;å·²ç»å­˜åœ¨çš„ fd&lt;/code&gt; åŒ…æ‹¬ä¸¤ç§:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;server listener fd&lt;/code&gt;ï¼Œ è´Ÿè´£ç›‘å¬ä¸šåŠ¡çš„ tcp è¿æ¥ï¼Œå¯¹åº” &lt;code&gt;config.json&lt;/code&gt; é‡Œçš„ &lt;code&gt;servers&lt;/code&gt; æ•°ç»„é‡Œçš„ &lt;code&gt;listeners&lt;/code&gt; æ•°ç»„é‡Œçš„ ip +ç«¯å£&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service listener fd&lt;/code&gt;ï¼Œæ§åˆ¶ç›¸å…³çš„ç«¯å£ï¼Œæ¯”å¦‚ pprofã€prometheus metrics exportã€admin ç«¯å£&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å‘é€å®Œfdä¹‹åï¼Œæ—§ MOSN ä¼šæ¥æ”¶ listen.sock çš„æ•°æ®ï¼ˆç”±æ–° mosn å†™å…¥çš„æ•°æ®ï¼Œä»£è¡¨ fd å·²æ¥ç®¡å®Œæ¯•ï¼‰ï¼Œå¹¶è¿›å…¥ gracefully shutdown çŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„é“¾æ¥ï¼Œç­‰å·²æœ‰è¯·æ±‚å¤„ç†å®Œå†å…³é—­&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ—§ MOSN æœ‰30ç§’æ—¶é—´å¤„ç†å®Œç°å­˜è¯·æ±‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;30ç§’åï¼Œæ—§ mosn å…³é—­ï¼Œé“¾æ¥ç”±æ–° mosn æ¥ç®¡&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ–°-mosn&#34;&gt;æ–° MOSN&lt;/h2&gt;
&lt;p&gt;æ¥ä¸‹æ¥æ˜¯æ–° MOSN çš„å¯åŠ¨ã€‚æœ‰ä¸¤ä¸ªé—®é¢˜:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æ–° MOSN æ˜¯å¦‚ä½•å°†æ—§ MOSN çš„fdæ®ä¸ºå·±æœ‰ï¼Œå¹¶ä¸”æ¥å—æ•°æ®çš„å‘¢ï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ–° MOSN é€šè¿‡ &lt;code&gt;net.FileListener&lt;/code&gt; æ–¹æ³•å¯¹æ¥å—åˆ°çš„ fd è¿›è¡Œå¤„ç†ï¼Œè¯¥å‡½æ•°ä¼šè¿”å› fd çš„ä¸€ä¸ª network listener å‰¯æœ¬ï¼Œæ”¹å‰¯æœ¬å¯ä»¥ç”¨æ¥æ¥æ”¶æ•°æ®ï¼Œæ–° MOSN å°±æ˜¯é€šè¿‡è¿™ä¸ªæ“ä½œæ¥ä»æ—§ MOSN åš fd çš„æ¥ç®¡&lt;/li&gt;
&lt;li&gt;æ–° MOSN ä¼šé‡æ–°è§£æä¸€é config.json è¿›è¡Œè§£æï¼Œè€Œåœ¨ä¸Šä¸€éƒ¨å¤„ç†è¿‡çš„ network listener å‰¯æœ¬ä¹Ÿèƒ½æŸ¥æ‰¾åˆ°å¯¹åº”çš„åœ°å€å’Œç«¯å£ã€‚é€šè¿‡æ¯”å¯¹ä¸¤è€…ç›¸åŒä¹‹å¤„ï¼Œå°±èƒ½åœ¨åˆ›å»ºæ–°çš„ server listener å’Œ service listener æ—¶ï¼Œæ¥ç®¡æ—§ MOSN çš„ fdï¼Œç”¨æ¥åˆå§‹åŒ–æ–°çš„ listenerã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ–° MOSN æ¥æ”¶åˆ° fd ä¿¡æ¯åï¼Œä¼šåšäº›ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¥ç®¡ server listener fd&lt;/li&gt;
&lt;li&gt;æ¥ç®¡ service listener fd&lt;/li&gt;
&lt;li&gt;ç»™ listen.sock å‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œé€šçŸ¥æ—§ MOSNï¼šå¯ä»¥å…³é—­äº†&lt;/li&gt;
&lt;li&gt;è‡³æ­¤ï¼ŒMOSN reconfig ç»“æŸ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;åç»­ç–‘é—®&#34;&gt;åç»­ç–‘é—®&lt;/h2&gt;
&lt;p&gt;æ–° MOSN é€šè¿‡ &lt;code&gt;net.FileListener&lt;/code&gt; æ–¹æ³•å¤„ç†å®Œ fd å¹¶åˆå§‹åŒ–äº† listenerï¼Œç”±äºå¤„ç†åçš„ fd æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æ¥äº†ä¸€ä¸ªè¿æ¥ï¼Œé‚£è¿™ä¸ªè¿æ¥æ˜¯ä¼šè¢«æ—§ MOSN å¤„ç†åˆ°ï¼Œè¿˜æ˜¯æ–° MOSNï¼Œè¿˜æ˜¯ä¸¤è€…éƒ½ä¼šé€šçŸ¥åˆ°å‘¢? å…³äºè¿™æ–¹é¢ï¼Œå¯ä»¥åšä¸€ä¸ªå®éªŒéªŒè¯ä¸€ä¸‹ã€‚&lt;/p&gt;

      </description>
    </item>
    
  </channel>
</rss>
